-- ============================================
-- TABELA DE PRECIFICAÇÃO
-- Sistema de Gestão Empresarial
-- ============================================

-- Criar tabela de precificação
CREATE TABLE IF NOT EXISTS precificacao (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- Informações básicas
    nome VARCHAR(255) NOT NULL,
    categoria VARCHAR(50) NOT NULL CHECK (categoria IN ('desenvolvimento', 'design', 'marketing', 'consultoria', 'suporte', 'outro')),
    tipo VARCHAR(50) NOT NULL CHECK (tipo IN ('hora', 'projeto', 'valor', 'custo')),
    
    -- Valores de precificação
    preco_base DECIMAL(10, 2) NOT NULL DEFAULT 0,
    preco_minimo DECIMAL(10, 2),
    preco_maximo DECIMAL(10, 2),
    margem DECIMAL(5, 2) NOT NULL DEFAULT 50.00, -- Margem em porcentagem
    
    -- Campos adicionais baseados no tipo
    valor_extra DECIMAL(10, 2), -- Para custos indiretos quando tipo = 'custo'
    
    -- Descrições
    descricao TEXT,
    observacoes TEXT,
    
    -- Status
    ativo BOOLEAN DEFAULT true,
    
    -- Timestamps
    created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Criar índice para busca rápida
CREATE INDEX IF NOT EXISTS idx_precificacao_categoria ON precificacao(categoria);
CREATE INDEX IF NOT EXISTS idx_precificacao_tipo ON precificacao(tipo);
CREATE INDEX IF NOT EXISTS idx_precificacao_ativo ON precificacao(ativo);
CREATE INDEX IF NOT EXISTS idx_precificacao_nome ON precificacao USING gin(to_tsvector('portuguese', nome));

-- Função para atualizar updated_at automaticamente
CREATE OR REPLACE FUNCTION update_precificacao_updated_at()
RETURNS TRIGGER AS $$
BEGIN
    NEW.updated_at = NOW();
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Trigger para atualizar updated_at
CREATE TRIGGER trigger_update_precificacao_updated_at
    BEFORE UPDATE ON precificacao
    FOR EACH ROW
    EXECUTE FUNCTION update_precificacao_updated_at();

-- ============================================
-- DADOS INICIAIS (OPCIONAL)
-- ============================================

-- Inserir alguns serviços de exemplo
INSERT INTO precificacao (nome, categoria, tipo, preco_base, preco_minimo, preco_maximo, margem, descricao, ativo) VALUES
    ('Desenvolvimento de Site Institucional', 'desenvolvimento', 'projeto', 5000.00, 3000.00, 15000.00, 60.00, 'Desenvolvimento completo de site responsivo com até 5 páginas', true),
    ('Desenvolvimento de E-commerce', 'desenvolvimento', 'projeto', 15000.00, 8000.00, 50000.00, 70.00, 'Loja virtual completa com painel administrativo', true),
    ('Consultoria em Marketing Digital', 'consultoria', 'hora', 150.00, 100.00, 300.00, 50.00, 'Consultoria estratégica em marketing digital', true),
    ('Gestão de Redes Sociais', 'marketing', 'projeto', 2000.00, 1000.00, 5000.00, 55.00, 'Gestão completa de redes sociais (mensal)', true),
    ('Criação de Identidade Visual', 'design', 'projeto', 3000.00, 1500.00, 8000.00, 65.00, 'Logo, cores, tipografia e manual de marca', true),
    ('Suporte Técnico', 'suporte', 'hora', 80.00, 50.00, 150.00, 40.00, 'Suporte técnico e manutenção', true)
ON CONFLICT DO NOTHING;

-- ============================================
-- QUERIES ÚTEIS
-- ============================================

-- Buscar todos os serviços ativos
-- SELECT * FROM precificacao WHERE ativo = true ORDER BY nome;

-- Buscar serviços por categoria
-- SELECT * FROM precificacao WHERE categoria = 'desenvolvimento' AND ativo = true;

-- Buscar serviços por tipo de precificação
-- SELECT * FROM precificacao WHERE tipo = 'hora' AND ativo = true;

-- Calcular preço final com margem
-- SELECT 
--     nome,
--     preco_base,
--     margem,
--     preco_base * (1 + margem / 100) as preco_final
-- FROM precificacao
-- WHERE ativo = true;

-- Buscar serviços com preço entre valores
-- SELECT * FROM precificacao 
-- WHERE preco_base BETWEEN 1000 AND 5000 
-- AND ativo = true
-- ORDER BY preco_base;

-- Estatísticas de precificação
-- SELECT 
--     categoria,
--     COUNT(*) as total_servicos,
--     AVG(preco_base) as preco_medio,
--     MIN(preco_base) as preco_minimo,
--     MAX(preco_base) as preco_maximo,
--     AVG(margem) as margem_media
-- FROM precificacao
-- WHERE ativo = true
-- GROUP BY categoria
-- ORDER BY categoria;

-- ============================================
-- COMENTÁRIOS SOBRE A ESTRUTURA
-- ============================================

-- CATEGORIAS:
-- - desenvolvimento: Serviços de desenvolvimento de software/sites
-- - design: Serviços de design gráfico/visual
-- - marketing: Serviços de marketing digital
-- - consultoria: Serviços de consultoria
-- - suporte: Serviços de suporte técnico
-- - outro: Outros tipos de serviços

-- TIPOS DE PRECIFICAÇÃO:
-- - hora: Precificação por hora trabalhada
-- - projeto: Precificação por projeto completo (valor fixo)
-- - valor: Precificação baseada no valor agregado ao cliente
-- - custo: Precificação baseada em custos + margem

-- MARGEM:
-- - Representa a margem de lucro em porcentagem
-- - Recomendado: 50-100% para serviços
-- - Para tipo 'custo', a margem é aplicada sobre o custo total

-- ============================================
-- PERMISSÕES (Ajuste conforme necessário)
-- ============================================

-- Habilitar RLS (Row Level Security) se necessário
-- ALTER TABLE precificacao ENABLE ROW LEVEL SECURITY;

-- Criar política para permitir leitura pública (ajuste conforme sua necessidade)
-- CREATE POLICY "Permitir leitura de precificação" ON precificacao
--     FOR SELECT
--     USING (true);

-- Criar política para permitir inserção/atualização apenas para usuários autenticados
-- CREATE POLICY "Permitir escrita de precificação" ON precificacao
--     FOR ALL
--     USING (auth.role() = 'authenticated');

