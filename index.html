<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Sistema de Gest√£o Empresarial</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #FF6600;
            --secondary: #1a1a1a;
            --tertiary: #2d2d2d;
            --text: #FFFFFF;
            --text-gray: #AFAFAF;
            --success: #10b981;
            --warning: #fbbf24;
            --danger: #ef4444;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: #000000;
            color: var(--text);
            min-height: 100vh;
        }

        /* Login Page */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-box {
            background: var(--secondary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
        }

        .login-title {
            text-align: center;
            color: var(--primary);
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .login-subtitle {
            text-align: center;
            color: var(--text-gray);
            margin-bottom: 32px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            color: var(--text-gray);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            background: var(--tertiary);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px 16px;
            color: var(--text);
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .btn {
            width: 100%;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: rgba(255, 102, 0, 0.8);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* Dashboard */
        .dashboard-container {
            display: none;
            min-height: 100vh;
        }

        .dashboard-container.active {
            display: block;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 260px;
            height: 100vh;
            background: var(--secondary);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 24px;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
        }

        .sidebar-overlay.active {
            display: block;
        }

        .menu-toggle {
            display: none;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            margin-right: 16px;
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            width: 100%;
        }

        .logo-image {
            max-width: 100%;
            max-height: 120px;
            width: auto;
            height: auto;
            object-fit: contain;
            display: block;
        }

        .logo-text {
            color: var(--primary);
            font-size: 24px;
            font-weight: 700;
        }

        .sidebar-logo:has(.logo-image) .logo-text {
            font-size: 20px;
        }

        /* Quando s√≥ tem logo (sem texto), centralizar */
        .sidebar-logo:has(.logo-image:not([style*="display: none"])):has(.logo-text[style*="display: none"]) {
            justify-content: center;
        }

        .login-logo-container {
            text-align: center;
            margin-bottom: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        .login-logo {
            max-width: 280px;
            max-height: 160px;
            width: auto;
            height: auto;
            object-fit: contain;
            margin-bottom: 16px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: var(--text-gray);
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
        }

        .menu-item.active {
            background: rgba(255, 102, 0, 0.2);
            color: var(--primary);
            border: 1px solid rgba(255, 102, 0, 0.3);
        }

        .main-content {
            margin-left: 260px;
            padding: 24px;
        }

        .header {
            background: var(--secondary);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 16px 24px;
            margin: -24px -24px 24px -24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .header-title {
            font-size: 20px;
            font-weight: 600;
        }

        .header-user {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .user-info {
            text-align: right;
        }

        .user-name {
            font-size: 14px;
            font-weight: 500;
        }

        .user-email {
            font-size: 12px;
            color: var(--text-gray);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .btn-logout {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text);
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-logout:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Cards */
        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .page-subtitle {
            color: var(--text-gray);
            margin-bottom: 24px;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        .card {
            background: var(--secondary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 24px;
            transition: all 0.3s;
        }

        .card:hover {
            border-color: rgba(255, 102, 0, 0.5);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 14px;
            color: var(--text-gray);
            margin-bottom: 8px;
        }

        .card-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text);
        }

        .card-icon {
            width: 48px;
            height: 48px;
            background: rgba(255, 102, 0, 0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 24px;
        }

        .card-footer {
            font-size: 12px;
            color: var(--text-gray);
        }

        .section-card {
            background: var(--secondary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-gray);
        }

        /* Table */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            color: var(--text-gray);
            font-weight: 600;
            font-size: 14px;
        }

        td {
            color: var(--text);
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-ativo {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .badge-inativo {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .badge-planejamento {
            background: rgba(147, 197, 253, 0.2);
            color: #60a5fa;
        }

        .badge-em-andamento {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .badge-pausado {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .badge-concluido {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .badge-cancelado {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        /* Badges de Status de Or√ßamento */
        .badge-rascunho {
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
        }

        .badge-enviado {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .badge-aprovado {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .badge-rejeitado {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .badge-expirado {
            background: rgba(107, 114, 128, 0.2);
            color: #6b7280;
        }

        /* Badges de Prioridade */
        .badge-prioridade-baixa {
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
        }

        .badge-prioridade-media {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .badge-prioridade-alta {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .badge-prioridade-urgente {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        /* Kanban Board */
        .kanban-board {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            padding: 16px 0;
            min-height: 500px;
        }

        .kanban-column {
            min-width: 280px;
            max-width: 280px;
            background: var(--tertiary);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 300px);
        }

        .kanban-column-header {
            padding: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .kanban-column-header h3 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }

        .kanban-count {
            background: var(--primary);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .kanban-column-body {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .kanban-card {
            background: var(--secondary);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: grab;
            transition: all 0.2s;
            user-select: none;
        }

        .kanban-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border-color: var(--primary);
        }

        .kanban-card.dragging {
            opacity: 0.5;
            cursor: grabbing;
            transform: rotate(5deg);
        }

        .kanban-column-body.drag-over {
            background: rgba(255, 102, 0, 0.1);
            border: 2px dashed var(--primary);
        }

        .kanban-card-title {
            font-weight: 600;
            font-size: 14px;
            color: var(--text);
            margin-bottom: 8px;
        }

        .kanban-card-client {
            font-size: 12px;
            color: var(--text-gray);
            margin-bottom: 8px;
        }

        .kanban-card-info {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-gray);
            margin-bottom: 8px;
        }

        .kanban-card-value {
            font-weight: 600;
            color: var(--primary);
            font-size: 13px;
        }

        .kanban-card-actions {
            margin-top: 8px;
            display: flex;
            gap: 8px;
        }

        .kanban-card-actions button {
            flex: 1;
            padding: 6px;
            font-size: 11px;
        }

        @media (max-width: 768px) {
            .kanban-board {
                flex-direction: column;
            }
            .kanban-column {
                min-width: 100%;
                max-width: 100%;
            }
        }

        /* Timeline/Gantt */
        .timeline-container {
            position: relative;
            padding: 20px 0;
        }

        .timeline-header {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            padding: 0 20px;
        }

        .timeline-month {
            flex: 1;
            text-align: center;
            font-weight: 600;
            color: var(--text);
            padding: 8px;
            background: var(--secondary);
            border-radius: 6px;
        }

        .timeline-project {
            margin: 12px 0;
            padding: 12px;
            background: var(--secondary);
            border-radius: 8px;
            border-left: 4px solid var(--primary);
            position: relative;
        }

        .timeline-project-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .timeline-project-title {
            font-weight: 600;
            color: var(--text);
            font-size: 14px;
        }

        .timeline-project-client {
            font-size: 12px;
            color: var(--text-gray);
        }

        .timeline-project-bar {
            height: 8px;
            background: var(--primary);
            border-radius: 4px;
            margin-top: 8px;
            position: relative;
        }

        .timeline-project-dates {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-gray);
            margin-top: 4px;
        }

        .timeline-legend {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
            padding: 12px;
            background: var(--secondary);
            border-radius: 8px;
        }

        .timeline-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .timeline-legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        /* Checklist de Tarefas */
        .tarefas-container {
            background: var(--tertiary);
            border-radius: 8px;
            padding: 16px;
            max-height: 400px;
            overflow-y: auto;
        }

        .tarefa-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            background: var(--secondary);
            border-radius: 6px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }

        .tarefa-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .tarefa-item.concluida {
            opacity: 0.6;
        }

        .tarefa-checkbox {
            width: 20px;
            height: 20px;
            margin-top: 2px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .tarefa-content {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tarefa-descricao {
            flex: 1;
            color: var(--text);
            font-size: 14px;
            word-break: break-word;
        }

        .tarefa-item.concluida .tarefa-descricao {
            text-decoration: line-through;
            color: var(--text-gray);
        }

        .tarefa-actions {
            display: flex;
            gap: 4px;
        }

        .tarefa-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .tarefa-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .tarefa-btn-edit {
            border-color: var(--primary);
            color: var(--primary);
        }

        .tarefa-btn-delete {
            border-color: var(--danger);
            color: var(--danger);
        }

        .tarefa-empty {
            text-align: center;
            padding: 40px;
            color: var(--text-gray);
            font-style: italic;
        }

        .tarefa-form {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .tarefa-form input {
            flex: 1;
            padding: 8px 12px;
            background: var(--secondary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: var(--text);
            font-size: 14px;
        }

        .tarefa-form input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .tarefa-form .btn {
            padding: 8px 16px;
            font-size: 12px;
        }

        /* Arquivos e Documentos */
        .arquivos-container {
            background: var(--tertiary);
            border-radius: 8px;
            padding: 16px;
            max-height: 400px;
            overflow-y: auto;
        }

        .arquivo-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--secondary);
            border-radius: 6px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }

        .arquivo-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .arquivo-icon {
            font-size: 24px;
            width: 40px;
            text-align: center;
        }

        .arquivo-info {
            flex: 1;
            min-width: 0;
        }

        .arquivo-nome {
            color: var(--text);
            font-size: 14px;
            font-weight: 500;
            word-break: break-word;
            margin-bottom: 4px;
        }

        .arquivo-meta {
            display: flex;
            gap: 12px;
            font-size: 11px;
            color: var(--text-gray);
        }

        .arquivo-descricao {
            font-size: 12px;
            color: var(--text-gray);
            margin-top: 4px;
            font-style: italic;
        }

        .arquivo-actions {
            display: flex;
            gap: 4px;
        }

        .arquivo-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text);
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .arquivo-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .arquivo-btn-download {
            border-color: var(--primary);
            color: var(--primary);
        }

        .arquivo-btn-delete {
            border-color: var(--danger);
            color: var(--danger);
        }

        .arquivo-btn-view {
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Modal de visualiza√ß√£o de imagem */
        .image-viewer-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
        }

        .image-viewer-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }

        .image-viewer-content img {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
            border-radius: 8px;
        }

        .image-viewer-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .image-viewer-close:hover {
            background: var(--danger);
            transform: scale(1.1);
        }

        /* Notifica√ß√µes de Prazos */
        .notification-badge {
            background: var(--danger);
            color: white;
            border-radius: 12px;
            padding: 4px 12px;
            font-size: 12px;
            font-weight: 600;
            min-width: 24px;
            text-align: center;
        }

        .menu-badge {
            background: var(--danger);
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: 600;
            margin-left: auto;
        }

        .notification-card {
            background: var(--secondary);
            border-left: 4px solid;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .notification-card:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(4px);
        }

        .notification-card.atrasado {
            border-left-color: var(--danger);
        }

        .notification-card.proximo {
            border-left-color: var(--warning);
        }

        .notification-card.sem-data {
            border-left-color: var(--text-gray);
        }

        .notification-card.urgente {
            border-left-color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .notification-title {
            font-weight: 600;
            color: var(--text);
            font-size: 14px;
        }

        .notification-status {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .notification-status.atrasado {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .notification-status.proximo {
            background: rgba(251, 191, 36, 0.2);
            color: var(--warning);
        }

        .notification-status.sem-data {
            background: rgba(156, 163, 175, 0.2);
            color: var(--text-gray);
        }

        .notification-status.urgente {
            background: rgba(239, 68, 68, 0.3);
            color: var(--danger);
            font-weight: 700;
        }

        .notification-info {
            display: flex;
            gap: 16px;
            font-size: 12px;
            color: var(--text-gray);
            margin-top: 8px;
        }

        .notification-days {
            font-weight: 600;
            color: var(--text);
        }

        .notification-days.atrasado {
            color: var(--danger);
        }

        .notification-days.proximo {
            color: var(--warning);
        }

        .notification-days.urgente {
            color: var(--danger);
        }

        .arquivo-empty {
            text-align: center;
            padding: 40px;
            color: var(--text-gray);
            font-style: italic;
        }

        .upload-form {
            background: var(--secondary);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .upload-form input[type="file"] {
            display: none;
        }

        .upload-form-label {
            display: block;
            padding: 12px;
            background: var(--tertiary);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text);
        }

        .upload-form-label:hover {
            border-color: var(--primary);
            background: rgba(255, 102, 0, 0.1);
        }

        .upload-form-label.has-file {
            border-color: var(--primary);
            background: rgba(255, 102, 0, 0.1);
        }

        .upload-file-name {
            margin-top: 8px;
            font-size: 12px;
            color: var(--primary);
            word-break: break-word;
        }

        .upload-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        /* Tags */
        .tag-badge {
            background: rgba(255, 102, 0, 0.2);
            color: var(--primary);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        .btn-action {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 8px;
            transition: all 0.3s;
        }

        .btn-action:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-action.edit {
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-action.delete {
            border-color: var(--danger);
            color: var(--danger);
        }

        .search-bar {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            align-items: center;
        }

        .search-input {
            flex: 1;
            background: var(--tertiary);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px 16px;
            color: var(--text);
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--secondary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 32px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            margin: 20px;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .btn-close {
            background: transparent;
            border: none;
            color: var(--text-gray);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-close:hover {
            color: var(--text);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 16px;
            }

            .menu-toggle {
                display: block;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
                max-height: 95vh;
            }

            .header {
                padding: 12px 16px;
            }

            .header-title {
                font-size: 18px;
            }

            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            table {
                min-width: 600px;
            }

            /* Tabela de itens do or√ßamento - vers√£o mobile */
            #orcamentoItensTable {
                display: block;
                width: 100%;
            }

            #orcamentoItensTable thead {
                display: none;
            }

            #orcamentoItensTable tbody,
            #orcamentoItensTable tr,
            #orcamentoItensTable td {
                display: block;
                width: 100%;
            }

            #orcamentoItensTable tr {
                margin-bottom: 16px;
                background: var(--tertiary);
                border-radius: 8px;
                padding: 12px;
                border: 1px solid rgba(255, 255, 255, 0.1);
            }

            #orcamentoItensTable td {
                padding: 8px 0;
                text-align: left !important;
                border: none;
            }

            #orcamentoItensTable td:before {
                content: attr(data-label);
                font-weight: 600;
                color: var(--primary);
                display: block;
                margin-bottom: 4px;
                font-size: 12px;
            }

            #orcamentoItensTable tfoot tr {
                background: transparent;
                border: none;
                padding: 0;
            }

            #orcamentoItensTable tfoot td {
                padding: 8px 0;
            }

            .modal-actions {
                flex-direction: column;
            }

            .modal-actions .btn {
                width: 100%;
            }

            .details-grid {
                grid-template-columns: 1fr;
            }

            .cards-grid {
                grid-template-columns: 1fr;
            }
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-top: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .servico-item {
            margin-bottom: 12px;
        }

        .servico-main {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .servico-submenu {
            margin-left: 26px;
            margin-top: 8px;
            padding-left: 16px;
            border-left: 2px solid rgba(255, 102, 0, 0.3);
            display: none;
        }

        .servico-submenu.active {
            display: block;
        }

        .servico-submenu .checkbox-item {
            margin-bottom: 8px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        .btn-secondary {
            background: var(--tertiary);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Detalhes Cliente */
        .details-section {
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .details-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .details-section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 16px;
        }

        .details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        @media (max-width: 768px) {
            .details-grid {
                grid-template-columns: 1fr;
            }
        }

        .details-item {
            margin-bottom: 12px;
        }

        .details-label {
            font-size: 12px;
            color: var(--text-gray);
            margin-bottom: 4px;
            font-weight: 500;
        }

        .details-value {
            font-size: 14px;
            color: var(--text);
            word-break: break-word;
        }

        .details-value.empty {
            color: var(--text-gray);
            font-style: italic;
        }

        .servicos-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .servico-badge {
            background: rgba(255, 102, 0, 0.2);
            color: var(--primary);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
            border: 1px solid var(--danger);
        }

        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.8);
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 102, 0, 0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .menu-toggle {
                display: block;
            }

            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 16px;
            }

            .header {
                padding: 12px 16px;
                margin: -16px -16px 16px -16px;
            }

            .header-title {
                font-size: 18px;
            }

            .user-info {
                display: none;
            }

            .user-avatar {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }

            .btn-logout {
                padding: 6px 12px;
                font-size: 12px;
            }

            .page-title {
                font-size: 24px;
            }

            .page-subtitle {
                font-size: 14px;
            }

            .cards-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .card {
                padding: 16px;
            }

            .card-value {
                font-size: 20px;
            }

            .section-card {
                padding: 16px;
            }

            .section-title {
                font-size: 18px;
            }

            .search-bar {
                flex-direction: column;
                gap: 12px;
            }

            .search-input {
                width: 100%;
            }

            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            table {
                min-width: 600px;
                font-size: 14px;
            }

            th, td {
                padding: 8px;
                font-size: 12px;
            }

            .btn-action {
                padding: 4px 8px;
                font-size: 11px;
                margin-right: 4px;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
                max-height: 95vh;
                margin: 10px;
            }

            .modal-title {
                font-size: 20px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .details-grid {
                grid-template-columns: 1fr;
            }

            .details-section {
                margin-bottom: 20px;
                padding-bottom: 20px;
            }

            .details-section-title {
                font-size: 16px;
            }

            .modal-actions {
                flex-direction: column-reverse;
                gap: 8px;
            }

            .modal-actions .btn {
                width: 100%;
            }

            .servicos-list {
                gap: 6px;
            }

            .servico-badge, .tag-badge {
                font-size: 11px;
                padding: 3px 10px;
            }

            .login-box {
                padding: 24px;
            }

            .login-title {
                font-size: 28px;
            }

            .login-logo {
                max-width: 100px;
                max-height: 100px;
            }

            .logo-image {
                max-width: 32px;
                max-height: 32px;
            }

            .sidebar-logo:has(.logo-image) .logo-text {
                font-size: 18px;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 12px;
            }

            .header {
                padding: 10px 12px;
                margin: -12px -12px 12px -12px;
            }

            .page-title {
                font-size: 20px;
            }

            .card {
                padding: 12px;
            }

            .card-value {
                font-size: 18px;
            }

            .section-card {
                padding: 12px;
            }

            .modal-content {
                padding: 16px;
            }

            .form-input, .btn {
                font-size: 14px;
            }

            .login-box {
                padding: 20px;
            }

            .login-title {
                font-size: 24px;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <div class="login-logo-container">
                <img id="loginLogo" class="login-logo" src="" alt="Logo" style="display: none;">
            </div>
            <h1 class="login-title" id="loginTitle">Sistema de Gest√£o</h1>
            <p class="login-subtitle">Fa√ßa login para continuar</p>
            
            <div id="errorMessage" class="error-message"></div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label" for="nome">Nome</label>
                    <input 
                        type="text" 
                        id="nome" 
                        class="form-input" 
                        placeholder=""
                        autocomplete="off"
                    >
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="password">Senha</label>
                    <input 
                        type="password" 
                        id="password" 
                        class="form-input" 
                        placeholder=""
                        autocomplete="off"
                    >
                </div>
                
                <button type="submit" class="btn btn-primary" id="loginBtn">
                    <span>Entrar</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboardPage" class="dashboard-container">
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
        <div class="sidebar" id="sidebar">
            <div class="sidebar-logo">
                <img id="sidebarLogo" class="logo-image" src="" alt="Logo" style="display: none;">
                <span class="logo-text" id="sidebarLogoText">Gest√£o</span>
            </div>
            <a href="#" class="menu-item active" data-page="dashboard" onclick="closeSidebarMobile()">
                <span>üìä</span>
                <span>Dashboard</span>
            </a>
            <a href="#" class="menu-item" data-page="clientes" onclick="closeSidebarMobile()">
                <span>üë•</span>
                <span>Clientes</span>
            </a>
            <a href="#" class="menu-item" data-page="orcamentos" onclick="closeSidebarMobile()">
                <span>üìÑ</span>
                <span>Or√ßamentos</span>
            </a>
        <a href="#" class="menu-item" data-page="projetos" onclick="closeSidebarMobile()">
            <span>üìÅ</span>
            <span>Projetos</span>
        </a>
            <a href="#" class="menu-item" data-page="financeiro" onclick="closeSidebarMobile()">
                <span>üí∞</span>
                <span>Financeiro</span>
            </a>
            <a href="#" class="menu-item" data-page="plataformas" onclick="closeSidebarMobile()">
                <span>üîë</span>
                <span>Plataformas</span>
            </a>
        </div>

        <div class="main-content">
            <div class="header">
                <div style="display: flex; align-items: center;">
                    <button class="menu-toggle" onclick="toggleSidebar()">‚ò∞</button>
                    <h2 class="header-title">Dashboard</h2>
                </div>
                <div class="header-user">
                    <div class="user-info">
                        <div class="user-name" id="userName">Usu√°rio</div>
                        <div class="user-email" id="userEmail">email@exemplo.com</div>
                    </div>
                    <div class="user-avatar" id="userAvatar">U</div>
                    <button class="btn btn-logout" onclick="logout()">Sair</button>
                </div>
            </div>

            <!-- Dashboard Content -->
            <div id="dashboardContent" class="page-content">
                <h1 class="page-title">Dashboard</h1>
                <p class="page-subtitle">Vis√£o geral do seu neg√≥cio</p>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Faturamento do M√™s</div>
                                <div class="card-value" id="faturamentoMes">R$ 0,00</div>
                            </div>
                            <div class="card-icon">üí∞</div>
                        </div>
                        <div class="card-footer">vs m√™s anterior</div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Projetos Ativos</div>
                                <div class="card-value" id="projetosAtivos">0</div>
                            </div>
                            <div class="card-icon">üìÅ</div>
                        </div>
                        <div class="card-footer">Em andamento</div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Pagamentos Pendentes</div>
                                <div class="card-value" id="pagamentosPendentes">R$ 0,00</div>
                            </div>
                            <div class="card-icon">‚è∞</div>
                        </div>
                        <div class="card-footer">A receber</div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Pagamentos Vencidos</div>
                                <div class="card-value" id="pagamentosVencidos" style="color: var(--danger);">R$ 0,00</div>
                            </div>
                            <div class="card-icon">‚ö†Ô∏è</div>
                        </div>
                        <div class="card-footer">Atrasados</div>
                    </div>
                </div>

                <div class="section-card">
                    <h2 class="section-title">Pr√≥ximos Vencimentos (7 dias)</h2>
                    <div class="empty-state">Nenhum vencimento pr√≥ximo</div>
                </div>

                <div class="section-card">
                    <h2 class="section-title">Or√ßamentos Aguardando</h2>
                    <div class="empty-state">Nenhum or√ßamento aguardando aprova√ß√£o</div>
                </div>

                <div class="section-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h2 class="section-title">‚ö†Ô∏è Projetos que Precisam de Aten√ß√£o</h2>
                        <span id="notificacoesCount" class="notification-badge" style="display: none;">0</span>
                    </div>
                    <div id="notificacoesProjetos">
                        <div class="empty-state">Carregando notifica√ß√µes...</div>
                    </div>
                </div>
            </div>

            <!-- Other Pages Content (hidden by default) -->
            <div id="clientesContent" class="page-content" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <div>
                        <h1 class="page-title">Clientes</h1>
                        <p class="page-subtitle">Gerencie seus clientes</p>
                    </div>
                    <button class="btn btn-primary" onclick="openClienteModal()">+ Novo Cliente</button>
                </div>

                <div class="section-card">
                    <div class="search-bar">
                        <input 
                            type="text" 
                            id="clienteSearch" 
                            class="search-input" 
                            placeholder="Buscar por nome, empresa ou email..."
                            onkeyup="filterClientes()"
                        >
                        <select id="clienteStatusFilter" class="form-input" style="width: 200px;" onchange="filterClientes()">
                            <option value="">Todos os status</option>
                            <option value="ativo">Ativo</option>
                            <option value="inativo">Inativo</option>
                        </select>
                    </div>

                    <div class="table-container">
                        <div id="clientesLoading" class="loading active">
                            <div class="spinner"></div>
                            <p>Carregando clientes...</p>
                        </div>
                        <table id="clientesTable" style="display: none;">
                            <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Empresa</th>
                            <th>Email</th>
                            <th>Telefone</th>
                            <th>Cidade/Estado</th>
                            <th>Status</th>
                            <th>A√ß√µes</th>
                        </tr>
                            </thead>
                            <tbody id="clientesTableBody">
                            </tbody>
                        </table>
                        <div id="clientesEmpty" class="empty-state" style="display: none;">
                            Nenhum cliente encontrado
                        </div>
                    </div>
                </div>
            </div>

            <div id="projetosContent" class="page-content" style="display: none;">
                <div style="margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1 class="page-title">Projetos</h1>
                        <p class="page-subtitle">Gerencie seus projetos</p>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button id="viewTableBtn" class="btn" onclick="toggleProjetoView('table')" style="background: var(--primary); border-color: var(--primary);">
                            üìã Tabela
                        </button>
                        <button id="viewKanbanBtn" class="btn" onclick="toggleProjetoView('kanban')" style="background: var(--tertiary); border-color: var(--tertiary);">
                            üìä Kanban
                        </button>
                        <button id="viewTimelineBtn" class="btn" onclick="toggleProjetoView('timeline')" style="background: var(--tertiary); border-color: var(--tertiary);">
                            üìÖ Timeline
                        </button>
                    </div>
                </div>

                <div class="section-card">
                    <div class="search-bar">
                        <input 
                            type="text" 
                            id="projetoSearch" 
                            class="search-input" 
                            placeholder="Buscar por nome do projeto ou cliente..."
                            onkeyup="filterProjetos()"
                        >
                        <select id="projetoStatusFilter" class="form-input" style="width: 200px;" onchange="filterProjetos()">
                            <option value="">Todos os status</option>
                            <option value="planejamento">Planejamento</option>
                            <option value="em_andamento">Em Andamento</option>
                            <option value="pausado">Pausado</option>
                            <option value="concluido">Conclu√≠do</option>
                            <option value="cancelado">Cancelado</option>
                        </select>
                        <button type="button" class="btn btn-secondary" id="filterAlertasBtn" onclick="toggleFilterAlertas()" style="white-space: nowrap;">
                            ‚ö†Ô∏è Ver Alertas
                        </button>
                    </div>

                    <!-- Visualiza√ß√£o Tabela -->
                    <div id="projetosTableView" class="table-container">
                        <div id="projetosLoading" class="loading active">
                            <div class="spinner"></div>
                            <p>Carregando projetos...</p>
                        </div>
                        <table id="projetosTable" style="display: none;">
                            <thead>
                                <tr>
                                    <th>Nome do Projeto</th>
                                    <th>Cliente</th>
                                    <th>Data In√≠cio</th>
                                    <th>Data Prevista</th>
                                    <th>Valor</th>
                                    <th>Status</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="projetosTableBody">
                            </tbody>
                        </table>
                        <div id="projetosEmpty" class="empty-state" style="display: none;">
                            Nenhum projeto encontrado
                        </div>
                    </div>

                    <!-- Visualiza√ß√£o Kanban -->
                    <div id="projetosKanbanView" style="display: none;">
                        <div id="kanbanBoard" class="kanban-board">
                            <div class="kanban-column" data-status="planejamento">
                                <div class="kanban-column-header">
                                    <h3>üìã Planejamento</h3>
                                    <span class="kanban-count" id="count-planejamento">0</span>
                                </div>
                                <div class="kanban-column-body" 
                                     id="kanban-planejamento"
                                     data-status="planejamento"
                                     ondragover="handleDragOver(event)"
                                     ondrop="handleDrop(event)"
                                     ondragleave="handleDragLeave(event)">
                                    <!-- Cards ser√£o inseridos aqui -->
                                </div>
                            </div>
                            <div class="kanban-column" data-status="em_andamento">
                                <div class="kanban-column-header">
                                    <h3>üöÄ Em Andamento</h3>
                                    <span class="kanban-count" id="count-em_andamento">0</span>
                                </div>
                                <div class="kanban-column-body" 
                                     id="kanban-em_andamento"
                                     data-status="em_andamento"
                                     ondragover="handleDragOver(event)"
                                     ondrop="handleDrop(event)"
                                     ondragleave="handleDragLeave(event)">
                                    <!-- Cards ser√£o inseridos aqui -->
                                </div>
                            </div>
                            <div class="kanban-column" data-status="pausado">
                                <div class="kanban-column-header">
                                    <h3>‚è∏Ô∏è Pausado</h3>
                                    <span class="kanban-count" id="count-pausado">0</span>
                                </div>
                                <div class="kanban-column-body" 
                                     id="kanban-pausado"
                                     data-status="pausado"
                                     ondragover="handleDragOver(event)"
                                     ondrop="handleDrop(event)"
                                     ondragleave="handleDragLeave(event)">
                                    <!-- Cards ser√£o inseridos aqui -->
                                </div>
                            </div>
                            <div class="kanban-column" data-status="concluido">
                                <div class="kanban-column-header">
                                    <h3>‚úÖ Conclu√≠do</h3>
                                    <span class="kanban-count" id="count-concluido">0</span>
                                </div>
                                <div class="kanban-column-body" 
                                     id="kanban-concluido"
                                     data-status="concluido"
                                     ondragover="handleDragOver(event)"
                                     ondrop="handleDrop(event)"
                                     ondragleave="handleDragLeave(event)">
                                    <!-- Cards ser√£o inseridos aqui -->
                                </div>
                            </div>
                            <div class="kanban-column" data-status="cancelado">
                                <div class="kanban-column-header">
                                    <h3>‚ùå Cancelado</h3>
                                    <span class="kanban-count" id="count-cancelado">0</span>
                                </div>
                                <div class="kanban-column-body" 
                                     id="kanban-cancelado"
                                     data-status="cancelado"
                                     ondragover="handleDragOver(event)"
                                     ondrop="handleDrop(event)"
                                     ondragleave="handleDragLeave(event)">
                                    <!-- Cards ser√£o inseridos aqui -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Visualiza√ß√£o Timeline/Gantt -->
                    <div id="projetosTimelineView" style="display: none;">
                        <div id="timelineContainer" style="background: var(--tertiary); border-radius: 8px; padding: 20px; overflow-x: auto;">
                            <div id="timelineContent" style="min-width: 100%; position: relative;">
                                <!-- Timeline ser√° renderizada aqui -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="orcamentosContent" class="page-content" style="display: none;">
                <div style="margin-bottom: 24px;">
                    <h1 class="page-title">Or√ßamentos</h1>
                    <p class="page-subtitle">Gerencie seus or√ßamentos</p>
                </div>

                <div class="section-card">
                    <div class="search-bar">
                        <input 
                            type="text" 
                            id="orcamentoSearch" 
                            class="search-input" 
                            placeholder="Buscar por n√∫mero, cliente ou descri√ß√£o..."
                            onkeyup="filterOrcamentos()"
                        >
                        <select id="orcamentoStatusFilter" class="form-input" style="width: 200px;" onchange="filterOrcamentos()">
                            <option value="">Todos os status</option>
                            <option value="rascunho">Rascunho</option>
                            <option value="enviado">Enviado</option>
                            <option value="aprovado">Aprovado</option>
                            <option value="rejeitado">Rejeitado</option>
                            <option value="expirado">Expirado</option>
                        </select>
                    </div>

                    <div class="table-container">
                        <div id="orcamentosLoading" class="loading active">
                            <div class="spinner"></div>
                            <p>Carregando or√ßamentos...</p>
                        </div>
                        <table id="orcamentosTable" style="display: none;">
                            <thead>
                                <tr>
                                    <th>N√∫mero</th>
                                    <th>Cliente</th>
                                    <th>Data</th>
                                    <th>Valor</th>
                                    <th>Validade</th>
                                    <th>Status</th>
                                    <th>A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="orcamentosTableBody">
                            </tbody>
                        </table>
                        <div id="orcamentosEmpty" class="empty-state" style="display: none;">
                            Nenhum or√ßamento encontrado
                        </div>
                    </div>
                </div>
            </div>

            <div id="financeiroContent" class="page-content" style="display: none;">
                <h1 class="page-title">Financeiro</h1>
                <p class="page-subtitle">Controle financeiro</p>
                <div class="section-card">
                    <div class="empty-state">Funcionalidade em desenvolvimento</div>
                </div>
            </div>

            <div id="plataformasContent" class="page-content" style="display: none;">
                <h1 class="page-title">Plataformas</h1>
                <p class="page-subtitle">Controle de plataformas e senhas</p>
                <div class="section-card">
                    <div class="empty-state">Funcionalidade em desenvolvimento</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Cliente -->
    <div id="clienteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="clienteModalTitle">Novo Cliente</h2>
                <button class="btn-close" onclick="closeClienteModal()">&times;</button>
            </div>
            <form id="clienteForm">
                <input type="hidden" id="clienteId">
                
                <div class="form-group">
                    <label class="form-label">Nome *</label>
                    <input type="text" id="clienteNome" class="form-input" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Empresa</label>
                        <input type="text" id="clienteEmpresa" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email *</label>
                        <input type="email" id="clienteEmail" class="form-input" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Telefone</label>
                        <input type="text" id="clienteTelefone" class="form-input" placeholder="(00) 00000-0000">
                    </div>
                    <div class="form-group">
                        <label class="form-label">WhatsApp</label>
                        <input type="text" id="clienteWhatsapp" class="form-input" placeholder="(00) 00000-0000">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">CPF/CNPJ</label>
                        <input type="text" id="clienteCpfCnpj" class="form-input" placeholder="000.000.000-00 ou 00.000.000/0000-00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Segmento</label>
                        <input type="text" id="clienteSegmento" class="form-input" placeholder="Ex: Distribuidor, Varejo, Servi√ßos">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Endere√ßo Completo</label>
                    <input type="text" id="clienteEndereco" class="form-input" placeholder="Rua, n√∫mero, complemento">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Cidade</label>
                        <input type="text" id="clienteCidade" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Estado</label>
                        <select id="clienteEstado" class="form-input">
                            <option value="">Selecione</option>
                            <option value="AC">Acre</option>
                            <option value="AL">Alagoas</option>
                            <option value="AP">Amap√°</option>
                            <option value="AM">Amazonas</option>
                            <option value="BA">Bahia</option>
                            <option value="CE">Cear√°</option>
                            <option value="DF">Distrito Federal</option>
                            <option value="ES">Esp√≠rito Santo</option>
                            <option value="GO">Goi√°s</option>
                            <option value="MA">Maranh√£o</option>
                            <option value="MT">Mato Grosso</option>
                            <option value="MS">Mato Grosso do Sul</option>
                            <option value="MG">Minas Gerais</option>
                            <option value="PA">Par√°</option>
                            <option value="PB">Para√≠ba</option>
                            <option value="PR">Paran√°</option>
                            <option value="PE">Pernambuco</option>
                            <option value="PI">Piau√≠</option>
                            <option value="RJ">Rio de Janeiro</option>
                            <option value="RN">Rio Grande do Norte</option>
                            <option value="RS">Rio Grande do Sul</option>
                            <option value="RO">Rond√¥nia</option>
                            <option value="RR">Roraima</option>
                            <option value="SC">Santa Catarina</option>
                            <option value="SP">S√£o Paulo</option>
                            <option value="SE">Sergipe</option>
                            <option value="TO">Tocantins</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">CEP</label>
                        <input type="text" id="clienteCep" class="form-input" placeholder="00000-000">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Data de Cadastro</label>
                        <input type="date" id="clienteDataCadastro" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Origem do Cliente</label>
                        <select id="clienteOrigem" class="form-input">
                            <option value="">Selecione</option>
                            <option value="indicacao">Indica√ß√£o</option>
                            <option value="google">Google</option>
                            <option value="facebook">Facebook</option>
                            <option value="instagram">Instagram</option>
                            <option value="linkedin">LinkedIn</option>
                            <option value="site">Site pr√≥prio</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select id="clienteStatus" class="form-input">
                            <option value="ativo">Ativo</option>
                            <option value="inativo">Inativo</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Observa√ß√µes</label>
                    <textarea id="clienteObservacoes" class="form-input" rows="4" style="resize: vertical;"></textarea>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeClienteModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Detalhes Cliente -->
    <div id="clienteDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">Detalhes do Cliente</h2>
                <button class="btn-close" onclick="closeClienteDetailsModal()">&times;</button>
            </div>
            <div id="clienteDetailsContent" style="color: var(--text);">
                <!-- Conte√∫do ser√° preenchido dinamicamente -->
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeClienteDetailsModal()">Fechar</button>
                <button type="button" class="btn btn-primary" id="editFromDetailsBtn" onclick="">Editar</button>
                <button type="button" class="btn btn-danger" id="deleteFromDetailsBtn" onclick="">Excluir</button>
            </div>
        </div>
    </div>

    <!-- Modal Projeto -->
    <div id="projetoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="projetoModalTitle">Novo Projeto</h2>
                <button class="btn-close" onclick="closeProjetoModal()">&times;</button>
            </div>
            <form id="projetoForm">
                <input type="hidden" id="projetoId">
                
                <div class="form-group">
                    <label class="form-label">Nome do Projeto *</label>
                    <input type="text" id="projetoNome" class="form-input" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Cliente *</label>
                        <select id="projetoClienteId" class="form-input" required>
                            <option value="">Selecione um cliente</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status *</label>
                        <select id="projetoStatus" class="form-input" required>
                            <option value="planejamento">Planejamento</option>
                            <option value="em_andamento">Em Andamento</option>
                            <option value="pausado">Pausado</option>
                            <option value="concluido">Conclu√≠do</option>
                            <option value="cancelado">Cancelado</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Prioridade</label>
                        <select id="projetoPrioridade" class="form-input">
                            <option value="">Selecione a prioridade</option>
                            <option value="baixa">Baixa</option>
                            <option value="media">M√©dia</option>
                            <option value="alta">Alta</option>
                            <option value="urgente">Urgente</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Respons√°vel</label>
                        <select id="projetoResponsavelId" class="form-input">
                            <option value="">Selecione um respons√°vel</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Data de In√≠cio</label>
                        <input type="date" id="projetoDataInicio" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Data Prevista de Conclus√£o</label>
                        <input type="date" id="projetoDataPrevista" class="form-input">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Data de Conclus√£o</label>
                        <input type="date" id="projetoDataConclusao" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Valor do Projeto (R$)</label>
                        <input type="number" id="projetoValor" class="form-input" step="0.01" min="0" placeholder="0.00">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Tags/Categorias</label>
                    <input type="text" id="projetoTags" class="form-input" placeholder="Ex: urgente, site, e-commerce (separadas por v√≠rgula)">
                    <small style="color: var(--text-gray); font-size: 12px; margin-top: 4px; display: block;">Separe as tags por v√≠rgula</small>
                </div>

                <div class="form-group">
                    <label class="form-label">Descri√ß√£o</label>
                    <textarea id="projetoDescricao" class="form-input" rows="4" style="resize: vertical;" placeholder="Descreva o projeto..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Observa√ß√µes</label>
                    <textarea id="projetoObservacoes" class="form-input" rows="3" style="resize: vertical;" placeholder="Observa√ß√µes adicionais..."></textarea>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeProjetoModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Detalhes Projeto -->
    <div id="projetoDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">Detalhes do Projeto</h2>
                <button class="btn-close" onclick="closeProjetoDetailsModal()">&times;</button>
            </div>
            <div id="projetoDetailsContent" style="color: var(--text);">
                <!-- Conte√∫do ser√° preenchido dinamicamente -->
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeProjetoDetailsModal()">Fechar</button>
                <button type="button" class="btn btn-primary" id="editProjetoFromDetailsBtn" onclick="">Editar</button>
                <button type="button" class="btn btn-danger" id="deleteProjetoFromDetailsBtn" onclick="">Excluir</button>
            </div>
        </div>
    </div>

    <!-- Modal Or√ßamento -->
    <div id="orcamentoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="orcamentoModalTitle">Novo Or√ßamento</h2>
                <button class="btn-close" onclick="closeOrcamentoModal()">&times;</button>
            </div>
            <form id="orcamentoForm">
                <input type="hidden" id="orcamentoId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">N√∫mero do Or√ßamento</label>
                        <input type="text" id="orcamentoNumero" class="form-input" placeholder="Gerado automaticamente" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cliente *</label>
                        <select id="orcamentoClienteId" class="form-input" required>
                            <option value="">Selecione um cliente</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Data do Or√ßamento *</label>
                        <input type="date" id="orcamentoData" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Validade (dias) *</label>
                        <input type="number" id="orcamentoValidade" class="form-input" min="1" value="30" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" style="margin-bottom: 12px; display: block;">Servi√ßos a serem Oferecidos</label>
                    <div class="checkbox-group" id="orcamentoServicosContainer" style="background: var(--tertiary); padding: 16px; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1); max-height: 400px; overflow-y: auto;">
                        <!-- Automa√ß√£o -->
                        <div class="servico-item">
                            <div class="servico-main">
                                <input type="checkbox" id="orcamentoServicoAutomacao" value="automacao" onchange="toggleSubmenu('orcamento', 'automacao')">
                                <label for="orcamentoServicoAutomacao" style="font-weight: 600;">Automa√ß√£o</label>
                            </div>
                            <div class="servico-submenu" id="orcamentoSubmenuAutomacao">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoAutomacaoWhatsapp" value="automacao_whatsapp" onchange="adicionarServicoAoOrcamento('automacao_whatsapp', 'Automa√ß√£o - WhatsApp')">
                                    <label for="orcamentoAutomacaoWhatsapp">WhatsApp</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoAutomacaoFacebook" value="automacao_facebook" onchange="adicionarServicoAoOrcamento('automacao_facebook', 'Automa√ß√£o - Facebook')">
                                    <label for="orcamentoAutomacaoFacebook">Facebook</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoAutomacaoInstagram" value="automacao_instagram" onchange="adicionarServicoAoOrcamento('automacao_instagram', 'Automa√ß√£o - Instagram')">
                                    <label for="orcamentoAutomacaoInstagram">Instagram</label>
                                </div>
                            </div>
                        </div>

                        <!-- Site -->
                        <div class="servico-item">
                            <div class="servico-main">
                                <input type="checkbox" id="orcamentoServicoSite" value="site" onchange="toggleSubmenu('orcamento', 'site')">
                                <label for="orcamentoServicoSite" style="font-weight: 600;">Site</label>
                            </div>
                            <div class="servico-submenu" id="orcamentoSubmenuSite">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoSiteCriacao" value="site_criacao" onchange="adicionarServicoAoOrcamento('site_criacao', 'Site - Cria√ß√£o')">
                                    <label for="orcamentoSiteCriacao">Cria√ß√£o</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoSitePersonalizacao" value="site_personalizacao" onchange="adicionarServicoAoOrcamento('site_personalizacao', 'Site - Personaliza√ß√£o')">
                                    <label for="orcamentoSitePersonalizacao">Personaliza√ß√£o</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoSitePaginaCaptura" value="site_pagina_captura" onchange="adicionarServicoAoOrcamento('site_pagina_captura', 'Site - P√°gina de Captura')">
                                    <label for="orcamentoSitePaginaCaptura">P√°gina de Captura</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoSiteEcommerce" value="site_ecommerce" onchange="adicionarServicoAoOrcamento('site_ecommerce', 'Site - E-commerce')">
                                    <label for="orcamentoSiteEcommerce">E-commerce</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoSiteLandingPage" value="site_landing_page" onchange="adicionarServicoAoOrcamento('site_landing_page', 'Site - Landing Page')">
                                    <label for="orcamentoSiteLandingPage">Landing Page</label>
                                </div>
                            </div>
                        </div>

                        <!-- Tr√°fego -->
                        <div class="servico-item">
                            <div class="servico-main">
                                <input type="checkbox" id="orcamentoServicoTrafego" value="trafego" onchange="toggleSubmenu('orcamento', 'trafego')">
                                <label for="orcamentoServicoTrafego" style="font-weight: 600;">Tr√°fego</label>
                            </div>
                            <div class="servico-submenu" id="orcamentoSubmenuTrafego">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoTrafegoMetaAds" value="trafego_meta_ads" onchange="adicionarServicoAoOrcamento('trafego_meta_ads', 'Tr√°fego - Configura√ß√£o Meta Ads')">
                                    <label for="orcamentoTrafegoMetaAds">Configura√ß√£o Meta Ads</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoTrafegoGoogleAds" value="trafego_google_ads" onchange="adicionarServicoAoOrcamento('trafego_google_ads', 'Tr√°fego - Configura√ß√£o Google Ads')">
                                    <label for="orcamentoTrafegoGoogleAds">Configura√ß√£o Google Ads</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoTrafegoBM" value="trafego_bm" onchange="adicionarServicoAoOrcamento('trafego_bm', 'Tr√°fego - Configura√ß√£o BM')">
                                    <label for="orcamentoTrafegoBM">Configura√ß√£o BM (Business Manager)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoTrafegoCriacaoCampanha" value="trafego_criacao_campanha" onchange="adicionarServicoAoOrcamento('trafego_criacao_campanha', 'Tr√°fego - Cria√ß√£o de Campanha')">
                                    <label for="orcamentoTrafegoCriacaoCampanha">Cria√ß√£o de Campanha</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoTrafegoOtimizacao" value="trafego_otimizacao" onchange="adicionarServicoAoOrcamento('trafego_otimizacao', 'Tr√°fego - Otimiza√ß√£o de Campanhas')">
                                    <label for="orcamentoTrafegoOtimizacao">Otimiza√ß√£o de Campanhas</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoTrafegoRemarketing" value="trafego_remarketing" onchange="adicionarServicoAoOrcamento('trafego_remarketing', 'Tr√°fego - Remarketing')">
                                    <label for="orcamentoTrafegoRemarketing">Remarketing</label>
                                </div>
                            </div>
                        </div>

                        <!-- Design -->
                        <div class="servico-item">
                            <div class="servico-main">
                                <input type="checkbox" id="orcamentoServicoDesign" value="design" onchange="toggleSubmenu('orcamento', 'design')">
                                <label for="orcamentoServicoDesign" style="font-weight: 600;">Design</label>
                            </div>
                            <div class="servico-submenu" id="orcamentoSubmenuDesign">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoDesignCriacaoPost" value="design_criacao_post" onchange="adicionarServicoAoOrcamento('design_criacao_post', 'Design - Cria√ß√£o de Post')">
                                    <label for="orcamentoDesignCriacaoPost">Cria√ß√£o de Post</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoDesignCriacaoStories" value="design_criacao_stories" onchange="adicionarServicoAoOrcamento('design_criacao_stories', 'Design - Cria√ß√£o de Stories')">
                                    <label for="orcamentoDesignCriacaoStories">Cria√ß√£o de Stories</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoDesignCriacaoFotosIA" value="design_criacao_fotos_ia" onchange="adicionarServicoAoOrcamento('design_criacao_fotos_ia', 'Design - Cria√ß√£o de Fotos com IA')">
                                    <label for="orcamentoDesignCriacaoFotosIA">Cria√ß√£o de Fotos com IA</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoDesignIdentidadeVisual" value="design_identidade_visual" onchange="adicionarServicoAoOrcamento('design_identidade_visual', 'Design - Identidade Visual')">
                                    <label for="orcamentoDesignIdentidadeVisual">Identidade Visual</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoDesignLogo" value="design_logo" onchange="adicionarServicoAoOrcamento('design_logo', 'Design - Cria√ß√£o de Logo')">
                                    <label for="orcamentoDesignLogo">Cria√ß√£o de Logo</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoDesignBanner" value="design_banner" onchange="adicionarServicoAoOrcamento('design_banner', 'Design - Banners e Materiais')">
                                    <label for="orcamentoDesignBanner">Banners e Materiais</label>
                                </div>
                            </div>
                        </div>

                        <!-- Redes Sociais -->
                        <div class="servico-item">
                            <div class="servico-main">
                                <input type="checkbox" id="orcamentoServicoRedesSociais" value="redes_sociais" onchange="toggleSubmenu('orcamento', 'redes_sociais')">
                                <label for="orcamentoServicoRedesSociais" style="font-weight: 600;">Redes Sociais</label>
                            </div>
                            <div class="servico-submenu" id="orcamentoSubmenuRedesSociais">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoRedesGestao" value="redes_gestao" onchange="adicionarServicoAoOrcamento('redes_gestao', 'Redes Sociais - Gest√£o')">
                                    <label for="orcamentoRedesGestao">Gest√£o de Redes Sociais</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoRedesCriacao" value="redes_criacao" onchange="adicionarServicoAoOrcamento('redes_criacao', 'Redes Sociais - Cria√ß√£o')">
                                    <label for="orcamentoRedesCriacao">Cria√ß√£o de Redes Sociais</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoRedesPlanejamento" value="redes_planejamento" onchange="adicionarServicoAoOrcamento('redes_planejamento', 'Redes Sociais - Planejamento')">
                                    <label for="orcamentoRedesPlanejamento">Planejamento de Conte√∫do</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoRedesModeracao" value="redes_moderacao" onchange="adicionarServicoAoOrcamento('redes_moderacao', 'Redes Sociais - Modera√ß√£o')">
                                    <label for="orcamentoRedesModeracao">Modera√ß√£o de Coment√°rios</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoRedesAnalise" value="redes_analise" onchange="adicionarServicoAoOrcamento('redes_analise', 'Redes Sociais - An√°lise')">
                                    <label for="orcamentoRedesAnalise">An√°lise de M√©tricas</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <small style="color: var(--text-gray); font-size: 12px; margin-top: 8px; display: block;">Selecione os servi√ßos que ser√£o oferecidos neste or√ßamento. Ao marcar um servi√ßo, ele ser√° adicionado automaticamente aos itens do or√ßamento.</small>
                </div>

                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <label class="form-label">Itens do Or√ßamento *</label>
                        <button type="button" class="btn btn-secondary" onclick="adicionarItemOrcamento()" style="padding: 6px 12px; font-size: 12px;">+ Adicionar Item Manual</button>
                    </div>
                    <div style="overflow-x: auto;">
                        <table id="orcamentoItensTable" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: var(--tertiary);">
                                    <th style="padding: 8px; text-align: left; font-size: 12px; color: var(--text-gray);">Descri√ß√£o</th>
                                    <th style="padding: 8px; text-align: center; font-size: 12px; color: var(--text-gray); width: 80px;">Qtd</th>
                                    <th style="padding: 8px; text-align: right; font-size: 12px; color: var(--text-gray); width: 100px;">Valor Unit.</th>
                                    <th style="padding: 8px; text-align: right; font-size: 12px; color: var(--text-gray); width: 80px;">Desc. %</th>
                                    <th style="padding: 8px; text-align: right; font-size: 12px; color: var(--text-gray); width: 120px;">Subtotal</th>
                                    <th style="padding: 8px; text-align: center; font-size: 12px; color: var(--text-gray); width: 50px;">A√ß√µes</th>
                                </tr>
                            </thead>
                            <tbody id="orcamentoItensBody">
                                <tr>
                                    <td colspan="6" style="padding: 20px; text-align: center; color: var(--text-gray); font-style: italic;">
                                        Nenhum item adicionado. Clique em "Adicionar Item" para come√ßar.
                                    </td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="4" style="padding: 8px; text-align: right; font-weight: 600;">Subtotal:</td>
                                    <td id="orcamentoSubtotal" style="padding: 8px; text-align: right; font-weight: 600;">R$ 0,00</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td colspan="4" style="padding: 8px; text-align: right;">
                                        <input type="number" id="orcamentoDescontoGeral" class="form-input" step="0.01" min="0" placeholder="0.00" style="width: 100px; display: inline-block; margin-left: 8px;" onchange="calcularTotalOrcamento()">
                                        <label style="display: inline-block; margin-left: 4px;">Desconto Geral (R$):</label>
                                    </td>
                                    <td id="orcamentoDescontoGeralValor" style="padding: 8px; text-align: right; color: var(--danger);">R$ 0,00</td>
                                    <td></td>
                                </tr>
                                <tr style="border-top: 2px solid var(--primary);">
                                    <td colspan="4" style="padding: 8px; text-align: right; font-weight: 700; font-size: 16px;">Total:</td>
                                    <td id="orcamentoValorTotal" style="padding: 8px; text-align: right; font-weight: 700; font-size: 16px; color: var(--primary);">R$ 0,00</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <input type="hidden" id="orcamentoValor" value="0">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Status *</label>
                        <select id="orcamentoStatus" class="form-input" required>
                            <option value="rascunho">Rascunho</option>
                            <option value="enviado">Enviado</option>
                            <option value="aprovado">Aprovado</option>
                            <option value="rejeitado">Rejeitado</option>
                            <option value="expirado">Expirado</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Condi√ß√µes de Pagamento</label>
                    <textarea id="orcamentoCondicoesPagamento" class="form-input" rows="3" style="resize: vertical;" placeholder="Ex: Pagamento √† vista com 5% de desconto, ou parcelado em at√© 3x sem juros..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Forma de Pagamento</label>
                    <div class="checkbox-group" style="background: var(--tertiary); padding: 12px; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1);">
                        <div class="checkbox-item">
                            <input type="checkbox" id="formaPagamentoCartao" value="Cart√£o de Cr√©dito e D√©bito" onchange="atualizarFormaPagamento()">
                            <label for="formaPagamentoCartao">Cart√£o de Cr√©dito e D√©bito</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="formaPagamentoPix" value="PIX" onchange="atualizarFormaPagamento()">
                            <label for="formaPagamentoPix">PIX</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="formaPagamentoDinheiro" value="Dinheiro" onchange="atualizarFormaPagamento()">
                            <label for="formaPagamentoDinheiro">Dinheiro</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="formaPagamentoBoleto" value="Boleto" onchange="atualizarFormaPagamento()">
                            <label for="formaPagamentoBoleto">Boleto</label>
                        </div>
                    </div>
                    <input type="hidden" id="orcamentoFormaPagamento" value="">
                </div>

                <div class="form-group">
                    <label class="form-label">Prazo de Entrega</label>
                    <input type="text" id="orcamentoPrazoEntrega" class="form-input" placeholder="Ex: 30 dias corridos ap√≥s aprova√ß√£o...">
                </div>

                <div class="form-group">
                    <label class="form-label">Observa√ß√µes</label>
                    <textarea id="orcamentoObservacoes" class="form-input" rows="3" style="resize: vertical;" placeholder="Observa√ß√µes adicionais..."></textarea>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeOrcamentoModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Detalhes Or√ßamento -->
    <div id="orcamentoDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">Detalhes do Or√ßamento</h2>
                <button class="btn-close" onclick="closeOrcamentoDetailsModal()">&times;</button>
            </div>
            <div id="orcamentoDetailsContent" style="color: var(--text);">
                <!-- Conte√∫do ser√° preenchido dinamicamente -->
            </div>
            <div class="modal-actions">
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button type="button" class="btn btn-secondary" onclick="closeOrcamentoDetailsModal()">Fechar</button>
                    <button type="button" class="btn btn-primary" id="downloadPDFBtn" style="background: var(--danger); border-color: var(--danger);">üìÑ Baixar PDF</button>
                    <button type="button" class="btn btn-primary" id="gerarLinkPublicoBtn" style="background: var(--primary); border-color: var(--primary);">üîó Gerar Link P√∫blico</button>
                    <button type="button" class="btn btn-primary" id="copiarLinkBtn" style="background: var(--tertiary); border-color: var(--tertiary); display: none;">üìã Copiar Link</button>
                    <button type="button" class="btn btn-primary" id="enviarWhatsAppBtn" style="background: #25D366; border-color: #25D366; display: none;">üí¨ Enviar por WhatsApp</button>
                    <button type="button" class="btn btn-primary" id="aprovarOrcamentoBtn" style="background: var(--success); border-color: var(--success); display: none;">‚úì Aprovar</button>
                    <button type="button" class="btn btn-primary" id="recusarOrcamentoBtn" style="background: var(--danger); border-color: var(--danger); display: none;">‚úó Recusar</button>
                    <button type="button" class="btn btn-primary" id="criarProjetoBtn" style="background: var(--primary); border-color: var(--primary); display: none;">üìÅ Criar Projeto</button>
                    <button type="button" class="btn btn-primary" id="editOrcamentoFromDetailsBtn" onclick="">Editar</button>
                    <button type="button" class="btn btn-danger" id="deleteOrcamentoFromDetailsBtn" onclick="">Excluir</button>
                </div>
            </div>
            <!-- √Årea para exibir link p√∫blico -->
            <div id="linkPublicoContainer" style="display: none; margin-top: 16px; padding: 16px; background: var(--tertiary); border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <label style="font-weight: 600; color: var(--text);">Link P√∫blico:</label>
                    <span id="linkStatusBadge" class="badge badge-aprovado" style="font-size: 11px;">Ativo</span>
                </div>
                <input type="text" id="linkPublicoInput" readonly style="width: 100%; padding: 8px; background: var(--secondary); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 4px; color: var(--text); font-size: 12px; margin-bottom: 8px;">
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button type="button" class="btn btn-secondary" onclick="copiarLinkPublico()" style="padding: 6px 12px; font-size: 12px;">üìã Copiar Link</button>
                    <button type="button" class="btn btn-primary" onclick="enviarLinkPorWhatsApp()" style="padding: 6px 12px; font-size: 12px; background: #25D366; border-color: #25D366;">üí¨ Enviar por WhatsApp</button>
                    <button type="button" class="btn btn-secondary" onclick="desativarLinkPublico()" style="padding: 6px 12px; font-size: 12px; background: var(--danger); border-color: var(--danger);">üö´ Desativar Link</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- jsPDF para gera√ß√£o de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <script>
        // Configura√ß√£o do Supabase
        const SUPABASE_URL = 'https://zhzhpctsndrcedukivhk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpoemhwY3RzbmRyY2VkdWtpdmhrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5OTA2NjMsImV4cCI6MjA3ODU2NjY2M30.POJaM5AK2RPvczhIAPEjA7bvLxQxnN9rJC4f_oR5bC8';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
            auth: {
                persistSession: false,
                autoRefreshToken: false
            }
        });

        // Verificar se usu√°rio est√° logado (localStorage)
        function checkAuth() {
            const loggedIn = localStorage.getItem('loggedIn');
            if (loggedIn === 'true') {
                showDashboard();
                loadDashboardData();
            } else {
                showLogin();
            }
        }

        // Fun√ß√µes auxiliares globais
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('pt-BR');
            } catch {
                return dateStr;
            }
        }

        function formatCurrency(value) {
            if (!value && value !== 0) return 'R$ 0,00';
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        // Mostrar p√°gina de login
        function showLogin() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('dashboardPage').classList.remove('active');
        }

        // Mostrar dashboard
        function showDashboard() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('dashboardPage').classList.add('active');
            
            // Informa√ß√µes do usu√°rio do localStorage
            const nome = localStorage.getItem('userName') || 'Usu√°rio';
            const email = localStorage.getItem('userEmail') || '';
            
            document.getElementById('userName').textContent = nome;
            document.getElementById('userEmail').textContent = email;
            document.getElementById('userAvatar').textContent = nome.charAt(0).toUpperCase();
        }

        // Login - Buscar na tabela usuarios
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const nome = document.getElementById('nome').value.trim();
            const senha = document.getElementById('password').value;
            const errorMessage = document.getElementById('errorMessage');
            const loginBtn = document.getElementById('loginBtn');
            
            if (!nome || !senha) {
                errorMessage.textContent = 'Preencha nome e senha';
                errorMessage.classList.add('show');
                return;
            }
            
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<span>Entrando...</span>';
            errorMessage.classList.remove('show');
            
            try {
                // Buscar na tabela usuarios (aceita mai√∫sculas/min√∫sculas)
                const { data, error } = await supabase
                    .from('usuarios')
                    .select('*')
                    .ilike('nome', nome)  // Case insensitive
                    .eq('senha', senha)
                    .eq('ativo', true)
                    .maybeSingle();
                
                if (error) {
                    console.error('Erro ao buscar usu√°rio:', error);
                    // Se for erro 404 ou 406, a tabela n√£o existe ou n√£o tem acesso
                    if (error.code === 'PGRST116' || error.message?.includes('permission denied')) {
                        throw new Error('Tabela usuarios n√£o configurada. Execute o SQL no Supabase.');
                    }
                    throw new Error('Erro ao conectar com o banco de dados');
                }
                
                if (!data) {
                    throw new Error('Nome ou senha incorretos');
                }
                
                // Login v√°lido
                localStorage.setItem('loggedIn', 'true');
                localStorage.setItem('userName', data.nome);
                localStorage.setItem('userEmail', data.email || '');
                localStorage.setItem('userPerfil', data.perfil || '');
                
                showDashboard();
                loadDashboardData();
            } catch (error) {
                errorMessage.textContent = error.message || 'Nome ou senha incorretos';
                errorMessage.classList.add('show');
            } finally {
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<span>Entrar</span>';
            }
        });

        // Logout
        function logout() {
            if (confirm('Deseja realmente sair?')) {
                localStorage.removeItem('loggedIn');
                showLogin();
            }
        }

        // Carregar dados do dashboard
        async function loadDashboardData() {
            try {
                // Buscar pagamentos
                let pagamentos = [];
                try {
                    const { data, error } = await supabase
                        .from('pagamentos')
                        .select('*')
                        .eq('tipo', 'receber');
                    
                    if (!error && data) {
                        pagamentos = data;
                    }
                } catch (e) {
                    // Tabela n√£o existe ou erro, continuar
                }

                // Calcular totais
                const hoje = new Date();
                const mesAtual = hoje.getMonth();
                const anoAtual = hoje.getFullYear();
                
                let faturamentoMes = 0;
                let pagamentosPendentes = 0;
                let pagamentosVencidos = 0;

                if (pagamentos && pagamentos.length > 0) {
                    pagamentos.forEach(p => {
                        const dataVenc = new Date(p.data_vencimento);
                        const valor = parseFloat(p.valor) || 0;
                        
                        if (p.status === 'pago' && dataVenc.getMonth() === mesAtual && dataVenc.getFullYear() === anoAtual) {
                            faturamentoMes += valor;
                        }
                        
                        if (p.status === 'pendente') {
                            pagamentosPendentes += valor;
                        }
                        
                        if (p.status === 'atrasado') {
                            pagamentosVencidos += valor;
                        }
                    });
                }

                // Buscar projetos
                let projetos = [];
                try {
                    const { data, error } = await supabase
                        .from('projetos')
                        .select('*')
                        .eq('status', 'em_andamento');
                    
                    if (!error && data) {
                        projetos = data;
                    }
                } catch (e) {
                    // Tabela n√£o existe ou erro, continuar
                }

                // Atualizar UI
                document.getElementById('faturamentoMes').textContent = formatCurrency(faturamentoMes);
                document.getElementById('projetosAtivos').textContent = projetos?.length || 0;
                document.getElementById('pagamentosPendentes').textContent = formatCurrency(pagamentosPendentes);
                document.getElementById('pagamentosVencidos').textContent = formatCurrency(pagamentosVencidos);

                // Carregar notifica√ß√µes de prazos
                await loadNotificacoesPrazos();
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
            }
        }

        // ========== NOTIFICA√á√ïES DE PRAZOS ==========
        
        // Calcular dias at√© o prazo ou dias de atraso
        function calcularDiasPrazo(dataPrevista) {
            if (!dataPrevista) return null;
            
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            
            const prazo = new Date(dataPrevista);
            prazo.setHours(0, 0, 0, 0);
            
            const diffTime = prazo - hoje;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            return diffDays;
        }

        // Classificar projeto por prazo
        function classificarProjetoPorPrazo(projeto) {
            // Projetos com prioridade urgente sempre aparecem
            if (projeto.prioridade === 'urgente') {
                if (!projeto.data_prevista) {
                    return { tipo: 'urgente', dias: null, label: 'Prioridade Urgente' };
                }
                const dias = calcularDiasPrazo(projeto.data_prevista);
                if (dias < 0) {
                    return { tipo: 'atrasado', dias: Math.abs(dias), label: `‚ö†Ô∏è URGENTE - Data de entrega venceu h√° ${Math.abs(dias)} dia(s)` };
                } else if (dias === 0) {
                    return { tipo: 'urgente', dias: 0, label: '‚ö†Ô∏è URGENTE - Data de entrega vence hoje!' };
                } else {
                    return { tipo: 'urgente', dias: dias, label: `‚ö†Ô∏è URGENTE - Data de entrega vence em ${dias} dia(s)` };
                }
            }

            // Projetos sem data definida
            if (!projeto.data_prevista) {
                return { tipo: 'sem-data', dias: null, label: 'Sem data de entrega definida' };
            }

            const dias = calcularDiasPrazo(projeto.data_prevista);
            
            if (dias < 0) {
                return { tipo: 'atrasado', dias: Math.abs(dias), label: `Data de entrega venceu h√° ${Math.abs(dias)} dia(s)` };
            } else if (dias === 0) {
                return { tipo: 'proximo', dias: 0, label: 'Data de entrega vence hoje!' };
            } else if (dias <= 3) {
                return { tipo: 'proximo', dias: dias, label: `Data de entrega vence em ${dias} dia(s)` };
            } else if (dias <= 7) {
                return { tipo: 'proximo', dias: dias, label: `Data de entrega vence em ${dias} dias` };
            }
            
            return null; // N√£o precisa de notifica√ß√£o
        }

        // Carregar notifica√ß√µes de prazos
        async function loadNotificacoesPrazos() {
            try {
                // Buscar projetos de forma mais simples e segura
                let projetos = [];

                // Primeiro, buscar projetos sem rela√ß√£o (mais simples)
                const { data: projetosData, error: projetosError } = await supabase
                    .from('projetos')
                    .select('*')
                    .neq('status', 'concluido')
                    .neq('status', 'cancelado');

                if (projetosError) {
                    console.error('Erro ao buscar projetos:', projetosError);
                    throw projetosError;
                }

                projetos = projetosData || [];

                // Buscar clientes separadamente se houver projetos
                if (projetos.length > 0) {
                    const clienteIds = [...new Set(projetos.map(p => p.cliente_id).filter(Boolean))];
                    if (clienteIds.length > 0) {
                        const { data: clientes, error: clientesError } = await supabase
                            .from('clientes')
                            .select('id, nome, empresa')
                            .in('id', clienteIds);
                        
                        if (!clientesError && clientes) {
                            const clientesMap = {};
                            clientes.forEach(c => {
                                clientesMap[c.id] = c;
                            });
                            
                            projetos = projetos.map(p => ({
                                ...p,
                                cliente: clientesMap[p.cliente_id] || null
                            }));
                        }
                    }
                }

                const projetosComAlerta = [];

                projetos.forEach(projeto => {
                    try {
                        const classificacao = classificarProjetoPorPrazo(projeto);
                        if (classificacao) {
                            projetosComAlerta.push({
                                ...projeto,
                                alerta: classificacao
                            });
                        }
                    } catch (e) {
                        console.warn('Erro ao classificar projeto:', projeto.id, e);
                    }
                });

                // Ordenar: urgentes primeiro, depois atrasados, depois pr√≥ximos, depois sem data
                projetosComAlerta.sort((a, b) => {
                    const ordem = { 'urgente': 0, 'atrasado': 1, 'proximo': 2, 'sem-data': 3 };
                    return (ordem[a.alerta.tipo] || 99) - (ordem[b.alerta.tipo] || 99);
                });

                // Renderizar notifica√ß√µes
                renderNotificacoes(projetosComAlerta);
            } catch (error) {
                // Expandir objeto de erro para ver todos os detalhes
                console.error('=== ERRO AO CARREGAR NOTIFICA√á√ïES ===');
                console.error('Erro completo:', JSON.stringify(error, null, 2));
                console.error('Mensagem:', error?.message);
                console.error('C√≥digo:', error?.code);
                console.error('Detalhes:', error?.details);
                console.error('Hint:', error?.hint);
                console.error('Stack:', error?.stack);
                console.error('Objeto completo:', error);
                
                const container = document.getElementById('notificacoesProjetos');
                if (container) {
                    let errorMsg = 'Erro ao carregar notifica√ß√µes';
                    if (error?.message) {
                        errorMsg += ': ' + error.message;
                    } else if (error?.details) {
                        errorMsg += ': ' + error.details;
                    } else if (error?.hint) {
                        errorMsg += ': ' + error.hint;
                    } else {
                        errorMsg += '. Verifique o console para mais detalhes.';
                    }
                    container.innerHTML = '<div class="empty-state">' + errorMsg + '</div>';
                }
            }
        }

        // Renderizar notifica√ß√µes
        function renderNotificacoes(projetos) {
            const container = document.getElementById('notificacoesProjetos');
            const countBadge = document.getElementById('notificacoesCount');

            if (!container) return;

            if (!projetos || projetos.length === 0) {
                container.innerHTML = '<div class="empty-state">‚úÖ Nenhum projeto precisa de aten√ß√£o no momento</div>';
                if (countBadge) countBadge.style.display = 'none';
                return;
            }

            if (countBadge) {
                countBadge.textContent = projetos.length;
                countBadge.style.display = 'inline-block';
            }

            let html = '';
            projetos.forEach(projeto => {
                const cliente = projeto.cliente || {};
                const clienteNome = cliente.nome || cliente.empresa || 'Cliente n√£o encontrado';
                const alerta = projeto.alerta;

                html += `
                    <div class="notification-card ${alerta.tipo}" onclick="viewProjetoDetails('${projeto.id}')">
                        <div class="notification-header">
                            <div class="notification-title">${projeto.nome || 'Sem nome'}</div>
                            <span class="notification-status ${alerta.tipo}">${alerta.label}</span>
                        </div>
                        <div style="font-size: 12px; color: var(--text-gray); margin-bottom: 8px;">
                            üë§ ${clienteNome}
                        </div>
                        <div class="notification-info">
                            <span>üìÖ Prazo: ${projeto.data_prevista ? formatDate(projeto.data_prevista) : 'N√£o definido'}</span>
                            <span>üìä Status: ${projeto.status === 'em_andamento' ? 'Em Andamento' : 
                                          projeto.status === 'planejamento' ? 'Planejamento' :
                                          projeto.status === 'pausado' ? 'Pausado' : projeto.status}</span>
                        </div>
                        ${alerta.dias !== null ? `
                            <div class="notification-days ${alerta.tipo}" style="margin-top: 8px; font-size: 13px;">
                                ${alerta.tipo === 'atrasado' ? '‚ö†Ô∏è' : '‚è∞'} ${alerta.label}
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Formatar moeda
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        // Mapeamento de t√≠tulos das p√°ginas
        const pageTitles = {
            'dashboard': 'Dashboard',
            'clientes': 'Clientes',
            'projetos': 'Projetos',
            'orcamentos': 'Or√ßamentos',
            'financeiro': 'Financeiro',
            'plataformas': 'Plataformas'
        };

        // Navega√ß√£o do menu
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                
                // Remover active de todos
                document.querySelectorAll('.menu-item').forEach(m => m.classList.remove('active'));
                // Adicionar active no clicado
                item.classList.add('active');
                
                // Esconder todos os conte√∫dos
                document.querySelectorAll('.page-content').forEach(c => c.style.display = 'none');
                
                // Mostrar conte√∫do correspondente
                const page = item.dataset.page;
                const contentId = page + 'Content';
                const content = document.getElementById(contentId);
                
                // Atualizar t√≠tulo do header
                const headerTitle = document.querySelector('.header-title');
                if (headerTitle && pageTitles[page]) {
                    headerTitle.textContent = pageTitles[page];
                }
                
                if (content) {
                    content.style.display = 'block';
                    
                    // Carregar dados quando abrir a p√°gina
                    if (page === 'clientes') {
                        loadClientes();
                    } else if (page === 'projetos') {
                        loadProjetos();
                    } else if (page === 'orcamentos') {
                        loadOrcamentos();
                    } else if (page === 'dashboard') {
                        loadDashboardData(); // Recarregar dashboard (inclui notifica√ß√µes)
                    }
                }
                
                // Atualizar t√≠tulo do header
                const titles = {
                    dashboard: 'Dashboard',
                    clientes: 'Clientes',
                    projetos: 'Projetos',
                    orcamentos: 'Or√ßamentos',
                    financeiro: 'Financeiro',
                    plataformas: 'Plataformas'
                };
                document.querySelector('.header-title').textContent = titles[page] || 'Dashboard';
            });
        });

        // ========== CRUD CLIENTES ==========
        let allClientes = [];
        let filteredClientes = [];

        // Carregar clientes do Supabase
        async function loadClientes() {
            const loading = document.getElementById('clientesLoading');
            const table = document.getElementById('clientesTable');
            const empty = document.getElementById('clientesEmpty');
            
            loading.classList.add('active');
            table.style.display = 'none';
            empty.style.display = 'none';

            try {
                // Buscar usu√°rio logado (simulado - usar ID do localStorage se tiver)
                const { data, error } = await supabase
                    .from('clientes')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                allClientes = data || [];
                filteredClientes = [...allClientes];
                renderClientes();
            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
                allClientes = [];
                filteredClientes = [];
                renderClientes();
            } finally {
                loading.classList.remove('active');
            }
        }

        // Renderizar tabela de clientes
        function renderClientes() {
            const tbody = document.getElementById('clientesTableBody');
            const table = document.getElementById('clientesTable');
            const empty = document.getElementById('clientesEmpty');

            if (filteredClientes.length === 0) {
                table.style.display = 'none';
                empty.style.display = 'block';
                return;
            }

            table.style.display = 'table';
            empty.style.display = 'none';

            tbody.innerHTML = filteredClientes.map(cliente => {
                const cidadeEstado = [cliente.cidade, cliente.estado].filter(Boolean).join('/') || '-';
                
                return `
                    <tr>
                        <td>${cliente.nome || ''}</td>
                        <td>${cliente.empresa || '-'}</td>
                        <td>${cliente.email || ''}</td>
                        <td>${cliente.telefone || cliente.whatsapp || '-'}</td>
                        <td>${cidadeEstado}</td>
                        <td>
                            <span class="badge ${cliente.status === 'ativo' ? 'badge-ativo' : 'badge-inativo'}">
                                ${cliente.status === 'ativo' ? 'Ativo' : 'Inativo'}
                            </span>
                        </td>
                        <td>
                            <button class="btn-action" onclick="viewClienteDetails('${cliente.id}')" style="border-color: var(--primary); color: var(--primary); margin-right: 8px;">Ver Detalhes</button>
                            <button class="btn-action" onclick="criarOrcamentoParaCliente('${cliente.id}')" style="border-color: var(--success); color: var(--success);">üìÑ Novo Or√ßamento</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Filtrar clientes
        function filterClientes() {
            const search = document.getElementById('clienteSearch').value.toLowerCase();
            const statusFilter = document.getElementById('clienteStatusFilter').value;

            filteredClientes = allClientes.filter(cliente => {
                const matchSearch = !search || 
                    (cliente.nome && cliente.nome.toLowerCase().includes(search)) ||
                    (cliente.empresa && cliente.empresa.toLowerCase().includes(search)) ||
                    (cliente.email && cliente.email.toLowerCase().includes(search));
                
                const matchStatus = !statusFilter || cliente.status === statusFilter;
                
                return matchSearch && matchStatus;
            });

            renderClientes();
        }

        // Toggle submenu de servi√ßos
        function toggleSubmenu(servico) {
            // Mapear nomes para IDs corretos
            const idMap = {
                'automacao': { main: 'servicoAutomacao', sub: 'submenuAutomacao' },
                'site': { main: 'servicoSite', sub: 'submenuSite' },
                'trafego': { main: 'servicoTrafego', sub: 'submenuTrafego' },
                'design': { main: 'servicoDesign', sub: 'submenuDesign' },
                'redes_sociais': { main: 'servicoRedesSociais', sub: 'submenuRedesSociais' }
            };
            
            const ids = idMap[servico];
            if (!ids) return;
            
            const checkbox = document.getElementById(ids.main);
            const submenu = document.getElementById(ids.sub);
            
            if (checkbox && submenu) {
                if (checkbox.checked) {
                    submenu.classList.add('active');
                } else {
                    submenu.classList.remove('active');
                    // Desmarcar todos os subitens
                    submenu.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                }
            }
        }

        // Abrir modal de cliente (novo)
        function openClienteModal() {
            document.getElementById('clienteModalTitle').textContent = 'Novo Cliente';
            document.getElementById('clienteForm').reset();
            document.getElementById('clienteId').value = '';
            
            // Preencher data de cadastro com hoje
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('clienteDataCadastro').value = hoje;
            
            // Limpar checkboxes principais
            ['servicoAutomacao', 'servicoSite', 'servicoDesign', 'servicoTrafego', 'servicoRedesSociais'].forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.checked = false;
                    // Fechar submenu
                    const servico = id.replace('servico', '').toLowerCase();
                    const submenu = document.getElementById(`submenu${servico.charAt(0).toUpperCase() + servico.slice(1)}`);
                    if (submenu) {
                        submenu.classList.remove('active');
                    }
                }
            });
            
            // Limpar todos os subitens
            document.querySelectorAll('.servico-submenu input[type="checkbox"]').forEach(cb => cb.checked = false);
            
            document.getElementById('clienteModal').classList.add('active');
        }

        // Fechar modal
        function closeClienteModal() {
            document.getElementById('clienteModal').classList.remove('active');
        }

        // Editar cliente
        async function editCliente(id) {
            const cliente = allClientes.find(c => c.id === id);
            if (!cliente) return;

            document.getElementById('clienteModalTitle').textContent = 'Editar Cliente';
            document.getElementById('clienteId').value = cliente.id;
            document.getElementById('clienteNome').value = cliente.nome || '';
            document.getElementById('clienteEmpresa').value = cliente.empresa || '';
            document.getElementById('clienteEmail').value = cliente.email || '';
            document.getElementById('clienteTelefone').value = cliente.telefone || '';
            document.getElementById('clienteWhatsapp').value = cliente.whatsapp || '';
            document.getElementById('clienteCpfCnpj').value = cliente.cpf_cnpj || '';
            document.getElementById('clienteSegmento').value = cliente.segmento || '';
            document.getElementById('clienteEndereco').value = cliente.endereco || '';
            document.getElementById('clienteCidade').value = cliente.cidade || '';
            document.getElementById('clienteEstado').value = cliente.estado || '';
            document.getElementById('clienteCep').value = cliente.cep || '';
            document.getElementById('clienteDataCadastro').value = cliente.data_cadastro ? cliente.data_cadastro.split('T')[0] : '';
            document.getElementById('clienteOrigem').value = cliente.origem || '';
            document.getElementById('clienteStatus').value = cliente.status || 'ativo';
            document.getElementById('clienteObservacoes').value = cliente.observacoes || '';

            document.getElementById('clienteModal').classList.add('active');
        }

        // Salvar cliente (criar ou atualizar)
        document.getElementById('clienteForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('clienteId').value;

            const clienteData = {
                nome: document.getElementById('clienteNome').value.trim(),
                empresa: document.getElementById('clienteEmpresa').value.trim() || null,
                email: document.getElementById('clienteEmail').value.trim(),
                telefone: document.getElementById('clienteTelefone').value.trim() || null,
                whatsapp: document.getElementById('clienteWhatsapp').value.trim() || null,
                cpf_cnpj: document.getElementById('clienteCpfCnpj').value.trim() || null,
                segmento: document.getElementById('clienteSegmento').value.trim() || null,
                endereco: document.getElementById('clienteEndereco').value.trim() || null,
                cidade: document.getElementById('clienteCidade').value.trim() || null,
                estado: document.getElementById('clienteEstado').value || null,
                cep: document.getElementById('clienteCep').value.trim() || null,
                data_cadastro: document.getElementById('clienteDataCadastro').value || null,
                origem: document.getElementById('clienteOrigem').value || null,
                status: document.getElementById('clienteStatus').value,
                observacoes: document.getElementById('clienteObservacoes').value.trim() || null
            };

            try {
                if (id) {
                    // Atualizar
                    const { error } = await supabase
                        .from('clientes')
                        .update(clienteData)
                        .eq('id', id);

                    if (error) throw error;
                    alert('Cliente atualizado com sucesso!');
                } else {
                    // Criar - sem user_id (removido foreign key constraint)
                    const { error } = await supabase
                        .from('clientes')
                        .insert([clienteData]);

                    if (error) throw error;
                    alert('Cliente criado com sucesso!');
                }

                closeClienteModal();
                loadClientes();
            } catch (error) {
                console.error('Erro ao salvar cliente:', error);
                alert('Erro ao salvar cliente: ' + (error.message || 'Erro desconhecido'));
            }
        });

        // Excluir cliente
        async function deleteCliente(id) {
            if (!confirm('Tem certeza que deseja excluir este cliente?')) return;

            try {
                const { error } = await supabase
                    .from('clientes')
                    .delete()
                    .eq('id', id);

                if (error) throw error;
                alert('Cliente exclu√≠do com sucesso!');
                loadClientes();
            } catch (error) {
                console.error('Erro ao excluir cliente:', error);
                alert('Erro ao excluir cliente: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // Ver detalhes do cliente
        function viewClienteDetails(id) {
            const cliente = allClientes.find(c => c.id === id);
            if (!cliente) {
                alert('Cliente n√£o encontrado');
                return;
            }

            const content = document.getElementById('clienteDetailsContent');
            const editBtn = document.getElementById('editFromDetailsBtn');
            const deleteBtn = document.getElementById('deleteFromDetailsBtn');
            
            // Configurar bot√£o de editar
            editBtn.onclick = () => {
                closeClienteDetailsModal();
                editCliente(id);
            };

            // Configurar bot√£o de excluir com confirma√ß√£o
            deleteBtn.onclick = async () => {
                if (!confirm('Tem certeza que deseja excluir este cliente? Esta a√ß√£o n√£o pode ser desfeita.')) {
                    return;
                }

                try {
                    const { error } = await supabase
                        .from('clientes')
                        .delete()
                        .eq('id', id);

                    if (error) throw error;
                    
                    alert('Cliente exclu√≠do com sucesso!');
                    closeClienteDetailsModal();
                    loadClientes();
                } catch (error) {
                    console.error('Erro ao excluir cliente:', error);
                    alert('Erro ao excluir cliente: ' + (error.message || 'Erro desconhecido'));
                }
            };

            // Formatar servi√ßos
            const servicos = cliente.servicos_contratados || [];
            const servicosHtml = servicos.length > 0
                ? servicos.map(s => {
                    // Formatar nome do servi√ßo
                    const nomeFormatado = s
                        .replace(/_/g, ' ')
                        .split(' ')
                        .map(p => p.charAt(0).toUpperCase() + p.slice(1))
                        .join(' ');
                    return `<span class="servico-badge">${nomeFormatado}</span>`;
                }).join('')
                : '<span class="details-value empty">Nenhum servi√ßo contratado</span>';

            // Formatar origem
            const origemMap = {
                'indicacao': 'Indica√ß√£o',
                'google': 'Google',
                'facebook': 'Facebook',
                'instagram': 'Instagram',
                'linkedin': 'LinkedIn',
                'site': 'Site pr√≥prio',
                'outro': 'Outro'
            };
            const origemFormatada = origemMap[cliente.origem] || cliente.origem || '-';

            // Formatar data
            const formatDate = (dateStr) => {
                if (!dateStr) return '-';
                try {
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('pt-BR');
                } catch {
                    return dateStr;
                }
            };

            // Helper para exibir valor ou "-"
            const displayValue = (value) => value || '<span class="empty">-</span>';

            content.innerHTML = `
                <div class="details-section">
                    <div class="details-section-title">Informa√ß√µes B√°sicas</div>
                    <div class="details-grid">
                        <div class="details-item">
                            <div class="details-label">Nome</div>
                            <div class="details-value">${cliente.nome || '-'}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Empresa</div>
                            <div class="details-value">${displayValue(cliente.empresa)}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Email</div>
                            <div class="details-value">${cliente.email || '-'}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Status</div>
                            <div class="details-value">
                                <span class="badge ${cliente.status === 'ativo' ? 'badge-ativo' : 'badge-inativo'}">
                                    ${cliente.status === 'ativo' ? 'Ativo' : 'Inativo'}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="details-section">
                    <div class="details-section-title">Contato</div>
                    <div class="details-grid">
                        <div class="details-item">
                            <div class="details-label">Telefone</div>
                            <div class="details-value">${displayValue(cliente.telefone)}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">WhatsApp</div>
                            <div class="details-value">${displayValue(cliente.whatsapp)}</div>
                        </div>
                    </div>
                </div>

                <div class="details-section">
                    <div class="details-section-title">Documentos e Segmento</div>
                    <div class="details-grid">
                        <div class="details-item">
                            <div class="details-label">CPF/CNPJ</div>
                            <div class="details-value">${displayValue(cliente.cpf_cnpj)}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Segmento</div>
                            <div class="details-value">${displayValue(cliente.segmento)}</div>
                        </div>
                    </div>
                </div>

                <div class="details-section">
                    <div class="details-section-title">Endere√ßo</div>
                    <div class="details-grid">
                        <div class="details-item" style="grid-column: 1 / -1;">
                            <div class="details-label">Endere√ßo Completo</div>
                            <div class="details-value">${displayValue(cliente.endereco)}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Cidade</div>
                            <div class="details-value">${displayValue(cliente.cidade)}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Estado</div>
                            <div class="details-value">${displayValue(cliente.estado)}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">CEP</div>
                            <div class="details-value">${displayValue(cliente.cep)}</div>
                        </div>
                    </div>
                </div>

                <div class="details-section">
                    <div class="details-section-title">Servi√ßos Contratados</div>
                    <div class="servicos-list">
                        ${servicosHtml}
                    </div>
                </div>

                <div class="details-section">
                    <div class="details-section-title">Informa√ß√µes Adicionais</div>
                    <div class="details-grid">
                        <div class="details-item">
                            <div class="details-label">Data de Cadastro</div>
                            <div class="details-value">${formatDate(cliente.data_cadastro)}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Origem do Cliente</div>
                            <div class="details-value">${origemFormatada}</div>
                        </div>
                    </div>
                    <div class="details-item" style="margin-top: 12px;">
                        <div class="details-label">Observa√ß√µes</div>
                        <div class="details-value" style="white-space: pre-wrap;">${displayValue(cliente.observacoes)}</div>
                    </div>
                </div>
            `;

            document.getElementById('clienteDetailsModal').classList.add('active');
        }

        // Fechar modal de detalhes
        function closeClienteDetailsModal() {
            document.getElementById('clienteDetailsModal').classList.remove('active');
        }

        // ========== CRUD PROJETOS ==========
        let allProjetos = [];
        let filteredProjetos = [];

        // Carregar projetos do Supabase
        async function loadProjetos() {
            const loading = document.getElementById('projetosLoading');
            const table = document.getElementById('projetosTable');
            const empty = document.getElementById('projetosEmpty');
            
            loading.classList.add('active');
            table.style.display = 'none';
            empty.style.display = 'none';

            try {
                // Buscar projetos
                const { data: projetosData, error: projetosError } = await supabase
                    .from('projetos')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (projetosError) throw projetosError;

                // Buscar clientes
                let clientesMap = {};
                try {
                    const { data: clientesData, error: clientesError } = await supabase
                        .from('clientes')
                        .select('id, nome, empresa');

                    if (!clientesError && clientesData) {
                        clientesData.forEach(cliente => {
                            clientesMap[cliente.id] = cliente;
                        });
                    }
                } catch (e) {
                    console.warn('Erro ao carregar clientes para projetos:', e);
                }

                // Buscar usu√°rios (respons√°veis)
                let usuariosMap = {};
                try {
                    const { data: usuariosData, error: usuariosError } = await supabase
                        .from('usuarios')
                        .select('id, nome');

                    if (!usuariosError && usuariosData) {
                        usuariosData.forEach(usuario => {
                            usuariosMap[usuario.id] = usuario;
                        });
                    }
                } catch (e) {
                    console.warn('Erro ao carregar usu√°rios para projetos:', e);
                }

                // Combinar dados
                allProjetos = (projetosData || []).map(projeto => ({
                    ...projeto,
                    cliente: clientesMap[projeto.cliente_id] || null,
                    responsavel: usuariosMap[projeto.responsavel_id] || null
                }));

                filteredProjetos = [...allProjetos];
                renderProjetos();
            } catch (error) {
                console.error('Erro ao carregar projetos:', error);
                allProjetos = [];
                filteredProjetos = [];
                renderProjetos();
            } finally {
                loading.classList.remove('active');
            }
        }

        // Vari√°vel para controlar a visualiza√ß√£o atual
        let projetoViewMode = 'table'; // 'table' ou 'kanban'

        // Alternar entre visualiza√ß√£o de tabela, kanban e timeline
        function toggleProjetoView(mode) {
            projetoViewMode = mode;
            const tableView = document.getElementById('projetosTableView');
            const kanbanView = document.getElementById('projetosKanbanView');
            const timelineView = document.getElementById('projetosTimelineView');
            const tableBtn = document.getElementById('viewTableBtn');
            const kanbanBtn = document.getElementById('viewKanbanBtn');
            const timelineBtn = document.getElementById('viewTimelineBtn');

            // Resetar todos os bot√µes
            tableBtn.style.background = 'var(--tertiary)';
            tableBtn.style.borderColor = 'var(--tertiary)';
            kanbanBtn.style.background = 'var(--tertiary)';
            kanbanBtn.style.borderColor = 'var(--tertiary)';
            timelineBtn.style.background = 'var(--tertiary)';
            timelineBtn.style.borderColor = 'var(--tertiary)';

            // Ocultar todas as visualiza√ß√µes
            tableView.style.display = 'none';
            kanbanView.style.display = 'none';
            timelineView.style.display = 'none';

            // Mostrar a visualiza√ß√£o selecionada
            if (mode === 'table') {
                tableView.style.display = 'block';
                tableBtn.style.background = 'var(--primary)';
                tableBtn.style.borderColor = 'var(--primary)';
            } else if (mode === 'kanban') {
                kanbanView.style.display = 'block';
                kanbanBtn.style.background = 'var(--primary)';
                kanbanBtn.style.borderColor = 'var(--primary)';
            } else if (mode === 'timeline') {
                timelineView.style.display = 'block';
                timelineBtn.style.background = 'var(--primary)';
                timelineBtn.style.borderColor = 'var(--primary)';
            }

            renderProjetos();
        }

        // ========== DRAG AND DROP NO KANBAN ==========
        let draggedCard = null;
        let isDragging = false;

        function handleDragStart(e) {
            // Verificar se o clique foi em um bot√£o (n√£o arrastar)
            if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                e.preventDefault();
                return false;
            }
            
            draggedCard = e.target.closest('.kanban-card');
            if (!draggedCard) return;
            
            isDragging = false;
            draggedCard.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', draggedCard.outerHTML);
            
            // Adicionar um pequeno delay para diferenciar drag de click
            setTimeout(() => {
                isDragging = true;
            }, 100);
        }

        function handleDragEnd(e) {
            if (draggedCard) {
                draggedCard.classList.remove('dragging');
            }
            // Remover classe drag-over de todas as colunas
            document.querySelectorAll('.kanban-column-body').forEach(col => {
                col.classList.remove('drag-over');
            });
            isDragging = false;
            draggedCard = null;
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            e.currentTarget.classList.add('drag-over');
            return false;
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        async function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');

            // Verificar se draggedCard existe e √© v√°lido
            if (!draggedCard || !draggedCard.getAttribute) {
                draggedCard = null;
                return false;
            }

            const newStatus = e.currentTarget.getAttribute('data-status');
            const projetoId = draggedCard.getAttribute('data-projeto-id');
            const oldStatus = draggedCard.getAttribute('data-projeto-status');

            // Validar dados
            if (!projetoId || !newStatus) {
                draggedCard = null;
                return false;
            }

            // Se o status n√£o mudou, n√£o fazer nada
            if (newStatus === oldStatus) {
                draggedCard = null;
                return false;
            }

            // Salvar refer√™ncia do card antes de atualizar
            const cardToMove = draggedCard;
            const cardId = projetoId;

            // Atualizar status no banco de dados
            try {
                const { error } = await supabase
                    .from('projetos')
                    .update({ status: newStatus })
                    .eq('id', cardId);

                if (error) throw error;

                // Atualizar o projeto no array primeiro
                const projeto = allProjetos.find(p => p.id === cardId);
                if (projeto) {
                    projeto.status = newStatus;
                }

                // Re-renderizar para atualizar tudo (move o card e atualiza contadores)
                renderProjetosKanban();

            } catch (error) {
                console.error('Erro ao atualizar status do projeto:', error);
                alert('Erro ao atualizar status: ' + (error.message || 'Erro desconhecido'));
                // Recarregar projetos em caso de erro
                await loadProjetos();
            }

            draggedCard = null;
            isDragging = false;
            return false;
        }

        // Renderizar projetos no Kanban
        function renderProjetosKanban() {
            const statusColumns = ['planejamento', 'em_andamento', 'pausado', 'concluido', 'cancelado'];
            const statusMap = {
                'planejamento': { label: 'Planejamento', emoji: 'üìã' },
                'em_andamento': { label: 'Em Andamento', emoji: 'üöÄ' },
                'pausado': { label: 'Pausado', emoji: '‚è∏Ô∏è' },
                'concluido': { label: 'Conclu√≠do', emoji: '‚úÖ' },
                'cancelado': { label: 'Cancelado', emoji: '‚ùå' }
            };

            statusColumns.forEach(status => {
                const columnBody = document.getElementById(`kanban-${status}`);
                const countEl = document.getElementById(`count-${status}`);
                
                if (!columnBody || !countEl) return;

                // Filtrar projetos por status
                const projetosStatus = filteredProjetos.filter(p => p.status === status);
                countEl.textContent = projetosStatus.length;

                if (projetosStatus.length === 0) {
                    columnBody.innerHTML = '<div style="text-align: center; color: var(--text-gray); font-style: italic; padding: 20px;">Nenhum projeto</div>';
                    return;
                }

                columnBody.innerHTML = projetosStatus.map(projeto => {
                    const cliente = projeto.cliente || {};
                    const clienteNome = cliente.nome || cliente.empresa || 'Cliente n√£o encontrado';
                    
                    const formatDate = (dateStr) => {
                        if (!dateStr) return '-';
                        try {
                            const date = new Date(dateStr);
                            return date.toLocaleDateString('pt-BR');
                        } catch {
                            return dateStr;
                        }
                    };

                    const formatCurrency = (value) => {
                        if (!value) return 'R$ 0,00';
                        return new Intl.NumberFormat('pt-BR', {
                            style: 'currency',
                            currency: 'BRL'
                        }).format(value);
                    };

                    return `
                        <div class="kanban-card" 
                             draggable="true" 
                             data-projeto-id="${projeto.id}"
                             data-projeto-status="${projeto.status}"
                             ondragstart="handleDragStart(event)"
                             ondragend="handleDragEnd(event)"
                             onclick="if (!isDragging) viewProjetoDetails('${projeto.id}')">
                            <div class="kanban-card-title">${projeto.nome || 'Sem nome'}</div>
                            <div class="kanban-card-client">üë§ ${clienteNome}</div>
                            <div class="kanban-card-info">
                                <span>üìÖ ${formatDate(projeto.data_inicio)}</span>
                                <span>üìÜ ${formatDate(projeto.data_prevista)}</span>
                            </div>
                            <div class="kanban-card-value">${formatCurrency(projeto.valor)}</div>
                            <div class="kanban-card-actions">
                                <button class="btn btn-primary" onclick="event.stopPropagation(); viewProjetoDetails('${projeto.id}')" style="font-size: 11px; padding: 6px;">
                                    Ver Detalhes
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            });
        }

        // Renderizar projetos na Timeline
        function renderProjetosTimeline() {
            const timelineContent = document.getElementById('timelineContent');
            if (!timelineContent) return;

            if (filteredProjetos.length === 0) {
                timelineContent.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-gray);">Nenhum projeto encontrado</div>';
                return;
            }

            const formatDate = (dateStr) => {
                if (!dateStr) return '-';
                try {
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('pt-BR');
                } catch {
                    return dateStr;
                }
            };

            const formatCurrency = (value) => {
                if (!value) return 'R$ 0,00';
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(value);
            };

            // Agrupar projetos por m√™s
            const projetosPorMes = {};
            filteredProjetos.forEach(projeto => {
                if (!projeto.data_inicio) return;
                const date = new Date(projeto.data_inicio);
                const mesAno = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                const mesNome = date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                
                if (!projetosPorMes[mesAno]) {
                    projetosPorMes[mesAno] = {
                        nome: mesNome.charAt(0).toUpperCase() + mesNome.slice(1),
                        projetos: []
                    };
                }
                projetosPorMes[mesAno].projetos.push(projeto);
            });

            // Ordenar meses
            const mesesOrdenados = Object.keys(projetosPorMes).sort();

            let html = '<div class="timeline-legend">';
            html += '<div class="timeline-legend-item"><span class="timeline-legend-color" style="background: var(--primary);"></span><span>Em Andamento</span></div>';
            html += '<div class="timeline-legend-item"><span class="timeline-legend-color" style="background: rgba(156, 163, 175, 0.5);"></span><span>Planejamento</span></div>';
            html += '<div class="timeline-legend-item"><span class="timeline-legend-color" style="background: rgba(16, 185, 129, 0.5);"></span><span>Conclu√≠do</span></div>';
            html += '<div class="timeline-legend-item"><span class="timeline-legend-color" style="background: rgba(239, 68, 68, 0.5);"></span><span>Pausado/Cancelado</span></div>';
            html += '</div>';

            mesesOrdenados.forEach(mesAno => {
                const mes = projetosPorMes[mesAno];
                html += `<div style="margin-bottom: 24px;">`;
                html += `<h3 style="color: var(--text); margin-bottom: 16px; font-size: 16px;">${mes.nome}</h3>`;
                
                mes.projetos.forEach(projeto => {
                    const cliente = projeto.cliente || {};
                    const clienteNome = cliente.nome || cliente.empresa || 'Cliente n√£o encontrado';
                    
                    // Determinar cor baseada no status
                    let corBarra = 'var(--primary)';
                    if (projeto.status === 'planejamento') corBarra = 'rgba(156, 163, 175, 0.5)';
                    else if (projeto.status === 'concluido') corBarra = 'rgba(16, 185, 129, 0.5)';
                    else if (projeto.status === 'pausado' || projeto.status === 'cancelado') corBarra = 'rgba(239, 68, 68, 0.5)';

                    html += `
                        <div class="timeline-project" onclick="viewProjetoDetails('${projeto.id}')" style="cursor: pointer;">
                            <div class="timeline-project-header">
                                <div>
                                    <div class="timeline-project-title">${projeto.nome || 'Sem nome'}</div>
                                    <div class="timeline-project-client">üë§ ${clienteNome}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: 600; color: var(--primary);">${formatCurrency(projeto.valor)}</div>
                                    <span class="badge badge-${projeto.status || 'planejamento'}" style="font-size: 10px; padding: 2px 8px;">
                                        ${projeto.status === 'em_andamento' ? 'Em Andamento' : 
                                          projeto.status === 'concluido' ? 'Conclu√≠do' :
                                          projeto.status === 'pausado' ? 'Pausado' :
                                          projeto.status === 'cancelado' ? 'Cancelado' : 'Planejamento'}
                                    </span>
                                </div>
                            </div>
                            <div class="timeline-project-bar" style="background: ${corBarra};"></div>
                            <div class="timeline-project-dates">
                                <span>üìÖ In√≠cio: ${formatDate(projeto.data_inicio)}</span>
                                <span>üìÜ Prevista: ${formatDate(projeto.data_prevista)}</span>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            });

            timelineContent.innerHTML = html;
        }

        // Renderizar tabela de projetos
        function renderProjetos() {
            // Verificar qual visualiza√ß√£o est√° ativa
            if (projetoViewMode === 'kanban') {
                renderProjetosKanban();
                return;
            }
            
            if (projetoViewMode === 'timeline') {
                renderProjetosTimeline();
                return;
            }

            const tbody = document.getElementById('projetosTableBody');
            const table = document.getElementById('projetosTable');
            const empty = document.getElementById('projetosEmpty');

            if (filteredProjetos.length === 0) {
                table.style.display = 'none';
                empty.style.display = 'block';
                return;
            }

            table.style.display = 'table';
            empty.style.display = 'none';

            tbody.innerHTML = filteredProjetos.map(projeto => {
                const cliente = projeto.cliente || {};
                const clienteNome = cliente.nome || cliente.empresa || 'Cliente n√£o encontrado';
                
                const formatDate = (dateStr) => {
                    if (!dateStr) return '-';
                    try {
                        const date = new Date(dateStr);
                        return date.toLocaleDateString('pt-BR');
                    } catch {
                        return dateStr;
                    }
                };

                const formatCurrency = (value) => {
                    if (!value) return 'R$ 0,00';
                    return new Intl.NumberFormat('pt-BR', {
                        style: 'currency',
                        currency: 'BRL'
                    }).format(value);
                };

                const statusMap = {
                    'planejamento': { label: 'Planejamento', class: 'badge-planejamento' },
                    'em_andamento': { label: 'Em Andamento', class: 'badge-em-andamento' },
                    'pausado': { label: 'Pausado', class: 'badge-pausado' },
                    'concluido': { label: 'Conclu√≠do', class: 'badge-concluido' },
                    'cancelado': { label: 'Cancelado', class: 'badge-cancelado' }
                };

                const status = statusMap[projeto.status] || { label: projeto.status, class: 'badge-planejamento' };

                return `
                    <tr>
                        <td>${projeto.nome || ''}</td>
                        <td>${clienteNome}</td>
                        <td>${formatDate(projeto.data_inicio)}</td>
                        <td>${formatDate(projeto.data_prevista)}</td>
                        <td>${formatCurrency(projeto.valor)}</td>
                        <td>
                            <span class="badge ${status.class}">
                                ${status.label}
                            </span>
                        </td>
                        <td>
                            <button class="btn-action" onclick="viewProjetoDetails('${projeto.id}')" style="border-color: var(--primary); color: var(--primary);">Ver Detalhes</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Vari√°vel para controlar filtro de alertas
        let filterAlertasAtivo = false;

        // Toggle filtro de alertas
        function toggleFilterAlertas() {
            filterAlertasAtivo = !filterAlertasAtivo;
            const btn = document.getElementById('filterAlertasBtn');
            if (btn) {
                if (filterAlertasAtivo) {
                    btn.textContent = '‚úÖ Ver Todos';
                    btn.style.background = 'var(--primary)';
                } else {
                    btn.textContent = '‚ö†Ô∏è Ver Alertas';
                    btn.style.background = 'var(--tertiary)';
                }
            }
            filterProjetos();
        }

        // Filtrar projetos
        function filterProjetos() {
            const search = document.getElementById('projetoSearch').value.toLowerCase();
            const statusFilter = document.getElementById('projetoStatusFilter').value;

            filteredProjetos = allProjetos.filter(projeto => {
                const cliente = projeto.cliente || {};
                const clienteNome = (cliente.nome || cliente.empresa || '').toLowerCase();
                
                const matchSearch = !search || 
                    (projeto.nome && projeto.nome.toLowerCase().includes(search)) ||
                    clienteNome.includes(search);
                
                const matchStatus = !statusFilter || projeto.status === statusFilter;
                
                // Filtro de alertas
                let matchAlertas = true;
                if (filterAlertasAtivo) {
                    const classificacao = classificarProjetoPorPrazo(projeto);
                    matchAlertas = classificacao !== null;
                }
                
                return matchSearch && matchStatus && matchAlertas;
            });

            renderProjetos();
        }

        // Carregar clientes no select
        async function loadClientesForSelect() {
            try {
                const { data, error } = await supabase
                    .from('clientes')
                    .select('id, nome, empresa')
                    .eq('status', 'ativo')
                    .order('nome', { ascending: true });

                if (error) throw error;

                const select = document.getElementById('projetoClienteId');
                select.innerHTML = '<option value="">Selecione um cliente</option>';
                
                (data || []).forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.id;
                    option.textContent = cliente.empresa ? `${cliente.nome} - ${cliente.empresa}` : cliente.nome;
                    select.appendChild(option);
                });

                // Remover listeners antigos e adicionar novo listener para carregar servi√ßos quando cliente for selecionado
                const newSelect = select.cloneNode(true);
                select.parentNode.replaceChild(newSelect, select);
                document.getElementById('projetoClienteId').addEventListener('change', async (e) => {
                    const clienteId = e.target.value;
                    if (clienteId) {
                        await loadServicosCliente(clienteId, 'projeto');
                    } else {
                        clearServicosContainer('projeto');
                    }
                });
            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
            }
        }

        // Carregar usu√°rios no select de respons√°vel
        async function loadUsuariosForSelect() {
            try {
                const { data, error } = await supabase
                    .from('usuarios')
                    .select('id, nome')
                    .eq('ativo', true)
                    .order('nome', { ascending: true });

                if (error) throw error;

                const select = document.getElementById('projetoResponsavelId');
                const currentValue = select.value; // Preservar valor atual
                select.innerHTML = '<option value="">Selecione um respons√°vel</option>';
                
                (data || []).forEach(usuario => {
                    const option = document.createElement('option');
                    option.value = usuario.id;
                    option.textContent = usuario.nome;
                    select.appendChild(option);
                });
                
                // Restaurar valor se existir
                if (currentValue) {
                    select.value = currentValue;
                }
            } catch (error) {
                console.error('Erro ao carregar usu√°rios:', error);
                // Se n√£o conseguir carregar, apenas limpa o select
                const select = document.getElementById('projetoResponsavelId');
                select.innerHTML = '<option value="">Erro ao carregar usu√°rios</option>';
            }
        }

        // Abrir modal de projeto (novo)
        async function openProjetoModal() {
            document.getElementById('projetoModalTitle').textContent = 'Novo Projeto';
            document.getElementById('projetoForm').reset();
            document.getElementById('projetoId').value = '';
            
            // Preencher data de in√≠cio com hoje
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('projetoDataInicio').value = hoje;
            
            // Carregar clientes e usu√°rios nos selects
            await Promise.all([
                loadClientesForSelect(),
                loadUsuariosForSelect()
            ]);
            
            document.getElementById('projetoModal').classList.add('active');
        }

        // Fechar modal
        function closeProjetoModal() {
            document.getElementById('projetoModal').classList.remove('active');
        }

        // Editar projeto
        async function editProjeto(id) {
            const projeto = allProjetos.find(p => p.id === id);
            if (!projeto) return;

            document.getElementById('projetoModalTitle').textContent = 'Editar Projeto';
            document.getElementById('projetoId').value = projeto.id;
            document.getElementById('projetoNome').value = projeto.nome || '';
            document.getElementById('projetoStatus').value = projeto.status || 'planejamento';
            document.getElementById('projetoPrioridade').value = projeto.prioridade || '';
            document.getElementById('projetoDataInicio').value = projeto.data_inicio ? projeto.data_inicio.split('T')[0] : '';
            document.getElementById('projetoDataPrevista').value = projeto.data_prevista ? projeto.data_prevista.split('T')[0] : '';
            document.getElementById('projetoDataConclusao').value = projeto.data_conclusao ? projeto.data_conclusao.split('T')[0] : '';
            document.getElementById('projetoValor').value = projeto.valor || '';
            document.getElementById('projetoDescricao').value = projeto.descricao || '';
            document.getElementById('projetoObservacoes').value = projeto.observacoes || '';
            
            // Tags - converter array para string separada por v√≠rgula
            if (projeto.tags && Array.isArray(projeto.tags)) {
                document.getElementById('projetoTags').value = projeto.tags.join(', ');
            } else if (typeof projeto.tags === 'string') {
                document.getElementById('projetoTags').value = projeto.tags;
            } else {
                document.getElementById('projetoTags').value = '';
            }

            // Carregar clientes e usu√°rios, depois selecionar valores
            await Promise.all([
                loadClientesForSelect(),
                loadUsuariosForSelect()
            ]);
            
            const clienteId = projeto.cliente_id || '';
            document.getElementById('projetoClienteId').value = clienteId;
            document.getElementById('projetoResponsavelId').value = projeto.responsavel_id || '';

            document.getElementById('projetoModal').classList.add('active');
        }

        // Salvar projeto (criar ou atualizar)
        document.getElementById('projetoForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('projetoId').value;

            // Construir objeto apenas com campos preenchidos
            const projetoData = {
                nome: document.getElementById('projetoNome').value.trim(),
                cliente_id: document.getElementById('projetoClienteId').value,
                status: document.getElementById('projetoStatus').value
            };

            // Adicionar campos opcionais apenas se preenchidos
            const prioridade = document.getElementById('projetoPrioridade').value;
            if (prioridade) projetoData.prioridade = prioridade;

            const responsavelId = document.getElementById('projetoResponsavelId').value;
            if (responsavelId) projetoData.responsavel_id = responsavelId;

            const dataInicio = document.getElementById('projetoDataInicio').value;
            if (dataInicio) projetoData.data_inicio = dataInicio;

            const dataPrevista = document.getElementById('projetoDataPrevista').value;
            if (dataPrevista) projetoData.data_prevista = dataPrevista;

            // Data de conclus√£o - ser√° adicionada se preenchida
            const dataConclusao = document.getElementById('projetoDataConclusao').value;
            if (dataConclusao) projetoData.data_conclusao = dataConclusao;

            const valor = document.getElementById('projetoValor').value;
            if (valor) projetoData.valor = parseFloat(valor);

            // Tags - processar string separada por v√≠rgula e converter para array
            const tagsInput = document.getElementById('projetoTags').value.trim();
            if (tagsInput) {
                const tagsArray = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
                projetoData.tags = tagsArray;
            }

            const descricao = document.getElementById('projetoDescricao').value.trim();
            if (descricao) projetoData.descricao = descricao;

            const observacoes = document.getElementById('projetoObservacoes').value.trim();
            if (observacoes) projetoData.observacoes = observacoes;

            try {
                if (id) {
                    // Atualizar
                    const { error } = await supabase
                        .from('projetos')
                        .update(projetoData)
                        .eq('id', id);

                    if (error) throw error;
                    alert('Projeto atualizado com sucesso!');
                } else {
                    // Criar
                    const { error } = await supabase
                        .from('projetos')
                        .insert([projetoData]);

                    if (error) throw error;
                    alert('Projeto criado com sucesso!');
                }

                closeProjetoModal();
                loadProjetos();
                loadDashboardData(); // Atualizar dashboard
            } catch (error) {
                console.error('Erro ao salvar projeto:', error);
                
                // Mensagem de erro mais amig√°vel
                let errorMessage = 'Erro ao salvar projeto: ' + (error.message || 'Erro desconhecido');
                
                // Se o erro for sobre coluna n√£o encontrada, orientar o usu√°rio
                if (error.message && error.message.includes('column') && error.message.includes('schema cache')) {
                    errorMessage = 'Erro: A estrutura da tabela "projetos" est√° incompleta.\n\n' +
                                 'Por favor, execute o script SQL (supabase_schema.sql) no Supabase para criar todas as colunas necess√°rias.\n\n' +
                                 'Erro t√©cnico: ' + error.message;
                }
                
                alert(errorMessage);
            }
        });

        // Ver detalhes do projeto
        async function viewProjetoDetails(id) {
            const projeto = allProjetos.find(p => p.id === id);
            if (!projeto) {
                alert('Projeto n√£o encontrado');
                return;
            }

            const content = document.getElementById('projetoDetailsContent');
            const editBtn = document.getElementById('editProjetoFromDetailsBtn');
            const deleteBtn = document.getElementById('deleteProjetoFromDetailsBtn');
            
            // Configurar bot√£o de editar
            editBtn.onclick = () => {
                closeProjetoDetailsModal();
                editProjeto(id);
            };

            // Configurar bot√£o de excluir com confirma√ß√£o
            deleteBtn.onclick = async () => {
                if (!confirm('Tem certeza que deseja excluir este projeto? Esta a√ß√£o n√£o pode ser desfeita.')) {
                    return;
                }

                try {
                    const { error } = await supabase
                        .from('projetos')
                        .delete()
                        .eq('id', id);

                    if (error) throw error;
                    
                    alert('Projeto exclu√≠do com sucesso!');
                    closeProjetoDetailsModal();
                    loadProjetos();
                    loadDashboardData(); // Atualizar dashboard
                } catch (error) {
                    console.error('Erro ao excluir projeto:', error);
                    alert('Erro ao excluir projeto: ' + (error.message || 'Erro desconhecido'));
                }
            };

            const cliente = projeto.cliente || {};
            const clienteNome = cliente.nome || cliente.empresa || 'Cliente n√£o encontrado';

            // Formatar data
            const formatDate = (dateStr) => {
                if (!dateStr) return '-';
                try {
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('pt-BR');
                } catch {
                    return dateStr;
                }
            };

            // Formatar moeda
            const formatCurrency = (value) => {
                if (!value) return 'R$ 0,00';
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(value);
            };

            // Status
            const statusMap = {
                'planejamento': { label: 'Planejamento', class: 'badge-planejamento' },
                'em_andamento': { label: 'Em Andamento', class: 'badge-em-andamento' },
                'pausado': { label: 'Pausado', class: 'badge-pausado' },
                'concluido': { label: 'Conclu√≠do', class: 'badge-concluido' },
                'cancelado': { label: 'Cancelado', class: 'badge-cancelado' }
            };

            const status = statusMap[projeto.status] || { label: projeto.status, class: 'badge-planejamento' };

            // Prioridade
            const prioridadeMap = {
                'baixa': { label: 'Baixa', class: 'badge-prioridade-baixa' },
                'media': { label: 'M√©dia', class: 'badge-prioridade-media' },
                'alta': { label: 'Alta', class: 'badge-prioridade-alta' },
                'urgente': { label: 'Urgente', class: 'badge-prioridade-urgente' }
            };
            const prioridade = prioridadeMap[projeto.prioridade] || null;

            // Respons√°vel
            const responsavel = projeto.responsavel || {};
            const responsavelNome = responsavel.nome || '-';

            // Tags
            let tagsHtml = '<span class="details-value empty">Nenhuma tag</span>';
            if (projeto.tags) {
                let tagsArray = [];
                if (Array.isArray(projeto.tags)) {
                    tagsArray = projeto.tags;
                } else if (typeof projeto.tags === 'string') {
                    tagsArray = projeto.tags.split(',').map(t => t.trim()).filter(t => t.length > 0);
                }
                
                if (tagsArray.length > 0) {
                    tagsHtml = tagsArray.map(tag => 
                        `<span class="tag-badge">${tag}</span>`
                    ).join('');
                }
            }

            // Helper para exibir valor ou "-"
            const displayValue = (value) => value || '<span class="empty">-</span>';

            content.innerHTML = `
                <div class="details-section">
                    <div class="details-section-title">Informa√ß√µes B√°sicas</div>
                    <div class="details-grid">
                        <div class="details-item">
                            <div class="details-label">Nome do Projeto</div>
                            <div class="details-value">${projeto.nome || '-'}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Cliente</div>
                            <div class="details-value">${clienteNome}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Status</div>
                            <div class="details-value">
                                <span class="badge ${status.class}">
                                    ${status.label}
                                </span>
                            </div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Prioridade</div>
                            <div class="details-value">
                                ${prioridade ? `<span class="badge ${prioridade.class}">${prioridade.label}</span>` : '<span class="empty">-</span>'}
                            </div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Respons√°vel</div>
                            <div class="details-value">${responsavelNome}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Valor do Projeto</div>
                            <div class="details-value">${formatCurrency(projeto.valor)}</div>
                        </div>
                    </div>
                </div>

                <div class="details-section">
                    <div class="details-section-title">Tags/Categorias</div>
                    <div class="servicos-list">
                        ${tagsHtml}
                    </div>
                </div>

                <div class="details-section">
                    <div class="details-section-title">Datas</div>
                    <div class="details-grid">
                        <div class="details-item">
                            <div class="details-label">Data de In√≠cio</div>
                            <div class="details-value">${formatDate(projeto.data_inicio)}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Data Prevista de Conclus√£o</div>
                            <div class="details-value">${formatDate(projeto.data_prevista)}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Data de Conclus√£o</div>
                            <div class="details-value">${formatDate(projeto.data_conclusao)}</div>
                        </div>
                    </div>
                </div>

                <div class="details-section">
                    <div class="details-section-title">Descri√ß√£o</div>
                    <div class="details-item">
                        <div class="details-value" style="white-space: pre-wrap;">${displayValue(projeto.descricao)}</div>
                    </div>
                </div>

                <div class="details-section">
                    <div class="details-section-title">Observa√ß√µes</div>
                    <div class="details-item">
                        <div class="details-value" style="white-space: pre-wrap;">${displayValue(projeto.observacoes)}</div>
                    </div>
                </div>

                <div class="details-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div class="details-section-title">Checklist de Tarefas</div>
                        <button type="button" class="btn btn-primary" onclick="adicionarTarefa('${projeto.id}')" style="padding: 6px 12px; font-size: 12px;">+ Nova Tarefa</button>
                    </div>
                    <div id="tarefasContainer-${projeto.id}" class="tarefas-container">
                        <div style="text-align: center; padding: 20px; color: var(--text-gray);">
                            Carregando tarefas...
                        </div>
                    </div>
                </div>

                <div class="details-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div class="details-section-title">Arquivos e Documentos</div>
                        <button type="button" class="btn btn-primary" onclick="abrirUploadArquivo('${projeto.id}')" style="padding: 6px 12px; font-size: 12px;">üìé Enviar Arquivo</button>
                    </div>
                    <div id="arquivosContainer-${projeto.id}" class="arquivos-container">
                        <div style="text-align: center; padding: 20px; color: var(--text-gray);">
                            Carregando arquivos...
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('projetoDetailsModal').classList.add('active');
            
            // Carregar tarefas e arquivos do projeto
            await Promise.all([
                loadTarefas(projeto.id),
                loadArquivos(projeto.id)
            ]);
        }

        // Fechar modal de detalhes
        function closeProjetoDetailsModal() {
            document.getElementById('projetoDetailsModal').classList.remove('active');
        }

        // ========== GEST√ÉO DE TAREFAS ==========
        let tarefasEditando = {}; // Armazena tarefas sendo editadas

        // Carregar tarefas do projeto
        async function loadTarefas(projetoId) {
            const container = document.getElementById(`tarefasContainer-${projetoId}`);
            if (!container) return;

            try {
                const { data, error } = await supabase
                    .from('tarefas')
                    .select('*')
                    .eq('projeto_id', projetoId)
                    .order('ordem', { ascending: true })
                    .order('created_at', { ascending: true });

                if (error) throw error;

                renderTarefas(projetoId, data || []);
            } catch (error) {
                console.error('Erro ao carregar tarefas:', error);
                container.innerHTML = '<div class="tarefa-empty">Erro ao carregar tarefas</div>';
            }
        }

        // Renderizar tarefas
        function renderTarefas(projetoId, tarefas) {
            const container = document.getElementById(`tarefasContainer-${projetoId}`);
            if (!container) return;

            if (!tarefas || tarefas.length === 0) {
                container.innerHTML = '<div class="tarefa-empty">Nenhuma tarefa adicionada ainda</div>';
                return;
            }

            let html = '';
            tarefas.forEach(tarefa => {
                const isEditando = tarefasEditando[tarefa.id];
                if (isEditando) {
                    // Modo de edi√ß√£o
                    html += `
                        <div class="tarefa-item">
                            <div class="tarefa-form" style="width: 100%;">
                                <input type="text" id="tarefaEditInput-${tarefa.id}" value="${(tarefa.descricao || '').replace(/"/g, '&quot;')}" placeholder="Descri√ß√£o da tarefa" style="flex: 1;">
                                <button type="button" class="btn btn-primary" onclick="salvarTarefa('${tarefa.id}', '${projetoId}')" style="padding: 8px 16px; font-size: 12px;">Salvar</button>
                                <button type="button" class="btn btn-secondary" onclick="cancelarEdicaoTarefa('${tarefa.id}', '${projetoId}')" style="padding: 8px 16px; font-size: 12px;">Cancelar</button>
                            </div>
                        </div>
                    `;
                } else {
                    // Modo de visualiza√ß√£o
                    html += `
                        <div class="tarefa-item ${tarefa.concluida ? 'concluida' : ''}">
                            <input type="checkbox" class="tarefa-checkbox" ${tarefa.concluida ? 'checked' : ''} 
                                   onchange="toggleTarefa('${tarefa.id}', '${projetoId}', this.checked)">
                            <div class="tarefa-content">
                                <div class="tarefa-descricao">${tarefa.descricao || ''}</div>
                            </div>
                            <div class="tarefa-actions">
                                <button type="button" class="tarefa-btn tarefa-btn-edit" onclick="editarTarefa('${tarefa.id}', '${projetoId}')" title="Editar">
                                    ‚úèÔ∏è
                                </button>
                                <button type="button" class="tarefa-btn tarefa-btn-delete" onclick="deletarTarefa('${tarefa.id}', '${projetoId}')" title="Excluir">
                                    üóëÔ∏è
                                </button>
                            </div>
                        </div>
                    `;
                }
            });

            container.innerHTML = html;
        }

        // Adicionar nova tarefa
        async function adicionarTarefa(projetoId) {
            const container = document.getElementById(`tarefasContainer-${projetoId}`);
            if (!container) return;

            // Criar formul√°rio de nova tarefa
            const formHtml = `
                <div class="tarefa-item">
                    <div class="tarefa-form" style="width: 100%;">
                        <input type="text" id="novaTarefaInput-${projetoId}" placeholder="Digite a descri√ß√£o da tarefa..." style="flex: 1;">
                        <button type="button" class="btn btn-primary" onclick="criarTarefa('${projetoId}')" style="padding: 8px 16px; font-size: 12px;">Adicionar</button>
                        <button type="button" class="btn btn-secondary" onclick="cancelarNovaTarefa('${projetoId}')" style="padding: 8px 16px; font-size: 12px;">Cancelar</button>
                    </div>
                </div>
            `;

            // Se estiver vazio, substituir; sen√£o, adicionar no in√≠cio
            if (container.querySelector('.tarefa-empty')) {
                container.innerHTML = formHtml;
            } else {
                container.insertAdjacentHTML('afterbegin', formHtml);
            }

            // Focar no input
            setTimeout(() => {
                const input = document.getElementById(`novaTarefaInput-${projetoId}`);
                if (input) input.focus();
            }, 100);
        }

        // Criar tarefa
        async function criarTarefa(projetoId) {
            const input = document.getElementById(`novaTarefaInput-${projetoId}`);
            if (!input) return;

            const descricao = input.value.trim();
            if (!descricao) {
                alert('Por favor, digite uma descri√ß√£o para a tarefa');
                return;
            }

            try {
                // Contar tarefas existentes para definir ordem
                const { count } = await supabase
                    .from('tarefas')
                    .select('*', { count: 'exact', head: true })
                    .eq('projeto_id', projetoId);

                const { data, error } = await supabase
                    .from('tarefas')
                    .insert({
                        projeto_id: projetoId,
                        descricao: descricao,
                        concluida: false,
                        ordem: (count || 0) + 1
                    })
                    .select()
                    .single();

                if (error) throw error;

                // Recarregar tarefas
                await loadTarefas(projetoId);
            } catch (error) {
                console.error('Erro ao criar tarefa:', error);
                alert('Erro ao criar tarefa: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // Cancelar nova tarefa
        async function cancelarNovaTarefa(projetoId) {
            await loadTarefas(projetoId);
        }

        // Editar tarefa
        function editarTarefa(tarefaId, projetoId) {
            tarefasEditando[tarefaId] = true;
            loadTarefas(projetoId);
            
            // Focar no input ap√≥s renderizar
            setTimeout(() => {
                const input = document.getElementById(`tarefaEditInput-${tarefaId}`);
                if (input) {
                    input.focus();
                    input.select();
                }
            }, 100);
        }

        // Salvar tarefa editada
        async function salvarTarefa(tarefaId, projetoId) {
            const input = document.getElementById(`tarefaEditInput-${tarefaId}`);
            if (!input) return;

            const descricao = input.value.trim();
            if (!descricao) {
                alert('Por favor, digite uma descri√ß√£o para a tarefa');
                return;
            }

            try {
                const { error } = await supabase
                    .from('tarefas')
                    .update({ descricao: descricao })
                    .eq('id', tarefaId);

                if (error) throw error;

                delete tarefasEditando[tarefaId];
                await loadTarefas(projetoId);
            } catch (error) {
                console.error('Erro ao salvar tarefa:', error);
                alert('Erro ao salvar tarefa: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // Cancelar edi√ß√£o de tarefa
        function cancelarEdicaoTarefa(tarefaId, projetoId) {
            delete tarefasEditando[tarefaId];
            loadTarefas(projetoId);
        }

        // Toggle tarefa (marcar/desmarcar como conclu√≠da)
        async function toggleTarefa(tarefaId, projetoId, concluida) {
            try {
                const { error } = await supabase
                    .from('tarefas')
                    .update({ concluida: concluida })
                    .eq('id', tarefaId);

                if (error) throw error;

                // Recarregar tarefas para atualizar visual
                await loadTarefas(projetoId);
            } catch (error) {
                console.error('Erro ao atualizar tarefa:', error);
                alert('Erro ao atualizar tarefa: ' + (error.message || 'Erro desconhecido'));
                // Recarregar para reverter visual
                await loadTarefas(projetoId);
            }
        }

        // Deletar tarefa
        async function deletarTarefa(tarefaId, projetoId) {
            if (!confirm('Tem certeza que deseja excluir esta tarefa?')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('tarefas')
                    .delete()
                    .eq('id', tarefaId);

                if (error) throw error;

                await loadTarefas(projetoId);
            } catch (error) {
                console.error('Erro ao deletar tarefa:', error);
                alert('Erro ao deletar tarefa: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // ========== GEST√ÉO DE ARQUIVOS ==========
        let arquivosUpload = {}; // Armazena arquivos selecionados para upload

        // Obter √≠cone baseado na extens√£o do arquivo
        function getFileIcon(nomeArquivo) {
            const ext = nomeArquivo.split('.').pop().toLowerCase();
            const icons = {
                'pdf': 'üìÑ',
                'doc': 'üìù', 'docx': 'üìù',
                'xls': 'üìä', 'xlsx': 'üìä',
                'ppt': 'üìä', 'pptx': 'üìä',
                'jpg': 'üñºÔ∏è', 'jpeg': 'üñºÔ∏è', 'png': 'üñºÔ∏è', 'gif': 'üñºÔ∏è', 'svg': 'üñºÔ∏è',
                'zip': 'üì¶', 'rar': 'üì¶', '7z': 'üì¶',
                'mp4': 'üé•', 'avi': 'üé•', 'mov': 'üé•',
                'mp3': 'üéµ', 'wav': 'üéµ',
                'txt': 'üìã',
                'html': 'üåê', 'css': 'üåê', 'js': 'üåê',
            };
            return icons[ext] || 'üìé';
        }

        // Verificar se √© uma imagem
        function isImageFile(nomeArquivo, tipoMime) {
            const ext = nomeArquivo.split('.').pop().toLowerCase();
            const imageExts = ['jpg', 'jpeg', 'png', 'gif', 'svg', 'webp', 'bmp'];
            const imageMimes = ['image/jpeg', 'image/png', 'image/gif', 'image/svg+xml', 'image/webp', 'image/bmp'];
            return imageExts.includes(ext) || (tipoMime && imageMimes.includes(tipoMime));
        }

        // Formatar tamanho do arquivo
        function formatFileSize(bytes) {
            if (!bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // Carregar arquivos do projeto
        async function loadArquivos(projetoId) {
            const container = document.getElementById(`arquivosContainer-${projetoId}`);
            if (!container) return;

            try {
                const { data, error } = await supabase
                    .from('arquivos_projeto')
                    .select('*')
                    .eq('projeto_id', projetoId)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                renderArquivos(projetoId, data || []);
            } catch (error) {
                console.error('Erro ao carregar arquivos:', error);
                container.innerHTML = '<div class="arquivo-empty">Erro ao carregar arquivos</div>';
            }
        }

        // Renderizar arquivos
        function renderArquivos(projetoId, arquivos) {
            const container = document.getElementById(`arquivosContainer-${projetoId}`);
            if (!container) return;

            if (!arquivos || arquivos.length === 0) {
                container.innerHTML = '<div class="arquivo-empty">Nenhum arquivo enviado ainda</div>';
                return;
            }

            let html = '';
            arquivos.forEach(arquivo => {
                const icon = getFileIcon(arquivo.nome_original || arquivo.nome_arquivo);
                const tamanho = formatFileSize(arquivo.tamanho_bytes);
                const dataUpload = new Date(arquivo.created_at).toLocaleDateString('pt-BR');
                const isImage = isImageFile(arquivo.nome_original || arquivo.nome_arquivo, arquivo.tipo_mime);

                html += `
                    <div class="arquivo-item">
                        <div class="arquivo-icon">${icon}</div>
                        <div class="arquivo-info">
                            <div class="arquivo-nome">${arquivo.nome_original || arquivo.nome_arquivo}</div>
                            <div class="arquivo-meta">
                                <span>üìè ${tamanho}</span>
                                <span>üìÖ ${dataUpload}</span>
                                ${arquivo.tipo_mime ? `<span>${arquivo.tipo_mime}</span>` : ''}
                            </div>
                            ${arquivo.descricao ? `<div class="arquivo-descricao">${arquivo.descricao}</div>` : ''}
                        </div>
                        <div class="arquivo-actions">
                            ${isImage ? `
                                <button type="button" class="arquivo-btn arquivo-btn-view" onclick="visualizarArquivo('${arquivo.id}', '${projetoId}')" title="Visualizar">
                                    üëÅÔ∏è Visualizar
                                </button>
                            ` : ''}
                            <button type="button" class="arquivo-btn arquivo-btn-download" onclick="downloadArquivo('${arquivo.id}', '${projetoId}')" title="Download">
                                ‚¨áÔ∏è Download
                            </button>
                            <button type="button" class="arquivo-btn arquivo-btn-delete" onclick="deletarArquivo('${arquivo.id}', '${projetoId}')" title="Excluir">
                                üóëÔ∏è
                            </button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Abrir formul√°rio de upload
        function abrirUploadArquivo(projetoId) {
            const container = document.getElementById(`arquivosContainer-${projetoId}`);
            if (!container) return;

            // Criar formul√°rio de upload
            const formHtml = `
                <div class="upload-form">
                    <input type="file" id="arquivoInput-${projetoId}" onchange="selecionarArquivo('${projetoId}', this.files[0])" multiple>
                    <label for="arquivoInput-${projetoId}" class="upload-form-label" id="uploadLabel-${projetoId}">
                        <div>üìé Clique para selecionar arquivo(s) ou arraste aqui</div>
                        <div class="upload-file-name" id="uploadFileName-${projetoId}" style="display: none;"></div>
                    </label>
                    <textarea id="arquivoDescricao-${projetoId}" class="form-input" rows="2" placeholder="Descri√ß√£o opcional do arquivo..." style="margin-top: 12px; width: 100%; resize: vertical;"></textarea>
                    <div class="upload-actions">
                        <button type="button" class="btn btn-primary" onclick="uploadArquivo('${projetoId}')" style="flex: 1;">üì§ Enviar</button>
                        <button type="button" class="btn btn-secondary" onclick="cancelarUploadArquivo('${projetoId}')" style="flex: 1;">Cancelar</button>
                    </div>
                </div>
            `;

            // Se estiver vazio, substituir; sen√£o, adicionar no in√≠cio
            if (container.querySelector('.arquivo-empty')) {
                container.innerHTML = formHtml;
            } else {
                container.insertAdjacentHTML('afterbegin', formHtml);
            }

            // Permitir drag and drop
            const label = document.getElementById(`uploadLabel-${projetoId}`);
            if (label) {
                label.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    label.style.borderColor = 'var(--primary)';
                });
                label.addEventListener('dragleave', () => {
                    label.style.borderColor = 'rgba(255, 255, 255, 0.3)';
                });
                label.addEventListener('drop', (e) => {
                    e.preventDefault();
                    label.style.borderColor = 'rgba(255, 255, 255, 0.3)';
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        selecionarArquivo(projetoId, files[0]);
                    }
                });
            }
        }

        // Selecionar arquivo
        function selecionarArquivo(projetoId, file) {
            if (!file) return;

            arquivosUpload[projetoId] = file;
            const label = document.getElementById(`uploadLabel-${projetoId}`);
            const fileName = document.getElementById(`uploadFileName-${projetoId}`);

            if (label && fileName) {
                label.classList.add('has-file');
                fileName.textContent = `üìé ${file.name} (${formatFileSize(file.size)})`;
                fileName.style.display = 'block';
            }
        }

        // Upload de arquivo
        async function uploadArquivo(projetoId) {
            const file = arquivosUpload[projetoId];
            if (!file) {
                alert('Por favor, selecione um arquivo');
                return;
            }

            const descricao = document.getElementById(`arquivoDescricao-${projetoId}`)?.value.trim() || null;

            try {
                // Gerar nome √∫nico para o arquivo
                const fileExt = file.name.split('.').pop();
                const fileName = `${projetoId}/${Date.now()}_${Math.random().toString(36).substring(7)}.${fileExt}`;
                const storagePath = `projetos/${fileName}`;

                // Upload para Supabase Storage
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('arquivos')
                    .upload(storagePath, file, {
                        cacheControl: '3600',
                        upsert: false
                    });

                if (uploadError) {
                    console.error('Erro detalhado do Storage:', uploadError);
                    // Se o bucket n√£o existir, tentar criar
                    if (uploadError.message.includes('Bucket not found')) {
                        alert('Bucket de storage n√£o encontrado. Por favor, crie um bucket chamado "arquivos" no Supabase Storage.');
                        return;
                    }
                    // Se for erro de RLS/pol√≠tica
                    if (uploadError.message && (uploadError.message.includes('row-level security') || uploadError.message.includes('policy'))) {
                        alert('Erro de pol√≠tica de Storage: Configure as pol√≠ticas do bucket "arquivos" no Supabase Storage. Veja o arquivo configurar_storage_policies.md para instru√ß√µes.');
                        return;
                    }
                    throw uploadError;
                }

                // Obter URL p√∫blica do arquivo
                const { data: urlData } = supabase.storage
                    .from('arquivos')
                    .getPublicUrl(storagePath);

                // Verificar se h√° sess√£o ativa (opcional, mas ajuda no debug)
                const { data: { session } } = await supabase.auth.getSession();
                console.log('Session:', session);

                // Salvar metadados no banco
                const { data: dbData, error: dbError } = await supabase
                    .from('arquivos_projeto')
                    .insert({
                        projeto_id: projetoId,
                        nome_arquivo: fileName,
                        nome_original: file.name,
                        caminho_storage: storagePath,
                        tipo_mime: file.type || null,
                        tamanho_bytes: file.size,
                        descricao: descricao
                    })
                    .select()
                    .single();

                if (dbError) {
                    console.error('Erro detalhado do banco:', dbError);
                    // Se for erro de RLS, dar mensagem mais clara
                    if (dbError.message && dbError.message.includes('row-level security')) {
                        throw new Error('Erro de seguran√ßa: A tabela arquivos_projeto ainda tem RLS habilitado. Execute o SQL fix_arquivos_rls.sql no Supabase.');
                    }
                    throw dbError;
                }

                // Limpar formul√°rio
                delete arquivosUpload[projetoId];
                const input = document.getElementById(`arquivoInput-${projetoId}`);
                if (input) input.value = '';
                const descInput = document.getElementById(`arquivoDescricao-${projetoId}`);
                if (descInput) descInput.value = '';

                // Recarregar arquivos
                await loadArquivos(projetoId);
            } catch (error) {
                console.error('Erro ao fazer upload do arquivo:', error);
                alert('Erro ao fazer upload: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // Cancelar upload
        function cancelarUploadArquivo(projetoId) {
            delete arquivosUpload[projetoId];
            loadArquivos(projetoId);
        }

        // Download de arquivo
        async function downloadArquivo(arquivoId, projetoId) {
            try {
                // Buscar informa√ß√µes do arquivo
                const { data: arquivo, error: fetchError } = await supabase
                    .from('arquivos_projeto')
                    .select('*')
                    .eq('id', arquivoId)
                    .single();

                if (fetchError) throw fetchError;
                if (!arquivo) {
                    alert('Arquivo n√£o encontrado');
                    return;
                }

                // Baixar arquivo do storage
                const { data, error: downloadError } = await supabase.storage
                    .from('arquivos')
                    .download(arquivo.caminho_storage);

                if (downloadError) throw downloadError;

                // Criar link de download
                const url = window.URL.createObjectURL(data);
                const a = document.createElement('a');
                a.href = url;
                a.download = arquivo.nome_original || arquivo.nome_arquivo;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Erro ao fazer download do arquivo:', error);
                alert('Erro ao fazer download: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // Visualizar arquivo (imagem)
        async function visualizarArquivo(arquivoId, projetoId) {
            try {
                // Buscar informa√ß√µes do arquivo
                const { data: arquivo, error: fetchError } = await supabase
                    .from('arquivos_projeto')
                    .select('*')
                    .eq('id', arquivoId)
                    .single();

                if (fetchError) throw fetchError;
                if (!arquivo) {
                    alert('Arquivo n√£o encontrado');
                    return;
                }

                // Obter URL p√∫blica do arquivo
                const { data: urlData } = supabase.storage
                    .from('arquivos')
                    .getPublicUrl(arquivo.caminho_storage);

                // Criar modal de visualiza√ß√£o
                const modal = document.createElement('div');
                modal.className = 'image-viewer-modal';
                modal.innerHTML = `
                    <div class="image-viewer-content">
                        <button class="image-viewer-close" onclick="this.closest('.image-viewer-modal').remove()">&times;</button>
                        <img src="${urlData.publicUrl}" alt="${arquivo.nome_original}" style="display: block;">
                        <div style="text-align: center; margin-top: 16px; color: white;">
                            <div style="font-weight: 600; margin-bottom: 4px;">${arquivo.nome_original}</div>
                            <div style="font-size: 12px; color: rgba(255,255,255,0.7);">${formatFileSize(arquivo.tamanho_bytes)} ‚Ä¢ ${new Date(arquivo.created_at).toLocaleDateString('pt-BR')}</div>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                // Fechar ao clicar fora da imagem
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });

                // Fechar com ESC
                const handleEsc = (e) => {
                    if (e.key === 'Escape') {
                        modal.remove();
                        document.removeEventListener('keydown', handleEsc);
                    }
                };
                document.addEventListener('keydown', handleEsc);
            } catch (error) {
                console.error('Erro ao visualizar arquivo:', error);
                alert('Erro ao visualizar arquivo: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // Deletar arquivo
        async function deletarArquivo(arquivoId, projetoId) {
            if (!confirm('Tem certeza que deseja excluir este arquivo?')) {
                return;
            }

            try {
                // Buscar informa√ß√µes do arquivo
                const { data: arquivo, error: fetchError } = await supabase
                    .from('arquivos_projeto')
                    .select('*')
                    .eq('id', arquivoId)
                    .single();

                if (fetchError) throw fetchError;

                // Deletar do storage
                const { error: storageError } = await supabase.storage
                    .from('arquivos')
                    .remove([arquivo.caminho_storage]);

                if (storageError) {
                    console.warn('Erro ao deletar do storage (continuando):', storageError);
                }

                // Deletar do banco
                const { error: dbError } = await supabase
                    .from('arquivos_projeto')
                    .delete()
                    .eq('id', arquivoId);

                if (dbError) throw dbError;

                // Recarregar arquivos
                await loadArquivos(projetoId);
            } catch (error) {
                console.error('Erro ao deletar arquivo:', error);
                alert('Erro ao deletar arquivo: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // ========== CRUD OR√áAMENTOS ==========
        let allOrcamentos = [];
        let filteredOrcamentos = [];

        // Carregar or√ßamentos do Supabase
        async function loadOrcamentos() {
            const loading = document.getElementById('orcamentosLoading');
            const table = document.getElementById('orcamentosTable');
            const empty = document.getElementById('orcamentosEmpty');
            
            loading.classList.add('active');
            table.style.display = 'none';
            empty.style.display = 'none';

            try {
                // Buscar or√ßamentos (incluindo novos campos de link p√∫blico e assinatura)
                const { data: orcamentosData, error: orcamentosError } = await supabase
                    .from('orcamentos')
                    .select('*, cliente:clientes(*)')
                    .order('created_at', { ascending: false });

                if (orcamentosError) throw orcamentosError;

                // Combinar dados e fazer parse dos itens (cliente j√° vem na rela√ß√£o)
                allOrcamentos = (orcamentosData || []).map(orcamento => {
                    // Fazer parse dos itens se vier como string
                    let itens = orcamento.itens || [];
                    if (typeof itens === 'string') {
                        try {
                            itens = JSON.parse(itens);
                        } catch (e) {
                            console.error('Erro ao fazer parse dos itens do or√ßamento:', e);
                            itens = [];
                        }
                    }
                    if (!Array.isArray(itens)) {
                        itens = [];
                    }
                    
                    return {
                        ...orcamento,
                        itens: itens
                        // cliente j√° vem na rela√ß√£o do Supabase
                    };
                });

                filteredOrcamentos = [...allOrcamentos];
                renderOrcamentos();
            } catch (error) {
                console.error('Erro ao carregar or√ßamentos:', error);
                allOrcamentos = [];
                filteredOrcamentos = [];
                renderOrcamentos();
            } finally {
                loading.classList.remove('active');
            }
        }

        // Renderizar tabela de or√ßamentos
        function renderOrcamentos() {
            const tbody = document.getElementById('orcamentosTableBody');
            const table = document.getElementById('orcamentosTable');
            const empty = document.getElementById('orcamentosEmpty');

            if (filteredOrcamentos.length === 0) {
                table.style.display = 'none';
                empty.style.display = 'block';
                return;
            }

            table.style.display = 'table';
            empty.style.display = 'none';

            tbody.innerHTML = filteredOrcamentos.map(orcamento => {
                const cliente = orcamento.cliente || {};
                const clienteNome = cliente.nome || cliente.empresa || 'Cliente n√£o encontrado';
                
                const formatDate = (dateStr) => {
                    if (!dateStr) return '-';
                    try {
                        const date = new Date(dateStr);
                        return date.toLocaleDateString('pt-BR');
                    } catch {
                        return dateStr;
                    }
                };

                const formatCurrency = (value) => {
                    if (!value) return 'R$ 0,00';
                    return new Intl.NumberFormat('pt-BR', {
                        style: 'currency',
                        currency: 'BRL'
                    }).format(value);
                };

                // Calcular data de validade
                let dataValidade = '-';
                if (orcamento.data && orcamento.validade_dias) {
                    try {
                        const data = new Date(orcamento.data);
                        data.setDate(data.getDate() + parseInt(orcamento.validade_dias));
                        dataValidade = formatDate(data.toISOString());
                    } catch (e) {
                        dataValidade = '-';
                    }
                }

                const statusMap = {
                    'rascunho': { label: 'Rascunho', class: 'badge-rascunho' },
                    'enviado': { label: 'Enviado', class: 'badge-enviado' },
                    'aprovado': { label: 'Aprovado', class: 'badge-aprovado' },
                    'rejeitado': { label: 'Rejeitado', class: 'badge-rejeitado' },
                    'expirado': { label: 'Expirado', class: 'badge-expirado' }
                };

                const status = statusMap[orcamento.status] || { label: orcamento.status, class: 'badge-rascunho' };

                return `
                    <tr>
                        <td>${orcamento.numero || 'N/A'}</td>
                        <td>${clienteNome}</td>
                        <td>${formatDate(orcamento.data)}</td>
                        <td>${formatCurrency(orcamento.valor)}</td>
                        <td>${dataValidade}</td>
                        <td>
                            <span class="badge ${status.class}">
                                ${status.label}
                            </span>
                        </td>
                        <td>
                            <button class="btn-action" onclick="viewOrcamentoDetails('${orcamento.id}')" style="border-color: var(--primary); color: var(--primary); margin-right: 4px;">Ver</button>
                            ${orcamento.status === 'enviado' ? `
                                <button class="btn-action" onclick="aprovarOrcamento('${orcamento.id}')" style="border-color: var(--success); color: var(--success); margin-right: 4px;" title="Aprovar">‚úì</button>
                                <button class="btn-action" onclick="recusarOrcamento('${orcamento.id}')" style="border-color: var(--danger); color: var(--danger);" title="Recusar">‚úó</button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Filtrar or√ßamentos
        function filterOrcamentos() {
            const search = document.getElementById('orcamentoSearch').value.toLowerCase();
            const statusFilter = document.getElementById('orcamentoStatusFilter').value;

            filteredOrcamentos = allOrcamentos.filter(orcamento => {
                const cliente = orcamento.cliente || {};
                const clienteNome = (cliente.nome || cliente.empresa || '').toLowerCase();
                const numero = (orcamento.numero || '').toLowerCase();
                const descricao = (orcamento.descricao || '').toLowerCase();
                
                const matchSearch = !search || 
                    numero.includes(search) ||
                    clienteNome.includes(search) ||
                    descricao.includes(search);
                
                const matchStatus = !statusFilter || orcamento.status === statusFilter;
                
                return matchSearch && matchStatus;
            });

            renderOrcamentos();
        }

        // Abrir modal de or√ßamento (novo)
        async function openOrcamentoModal() {
            await criarOrcamentoParaCliente(null);
        }

        // Criar or√ßamento para um cliente espec√≠fico
        async function criarOrcamentoParaCliente(clienteId) {
            document.getElementById('orcamentoModalTitle').textContent = 'Novo Or√ßamento';
            document.getElementById('orcamentoForm').reset();
            document.getElementById('orcamentoId').value = '';
            
            // Limpar checkboxes de servi√ßos
            document.querySelectorAll('#orcamentoServicosContainer input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            // Fechar todos os submenus
            document.querySelectorAll('#orcamentoServicosContainer .servico-submenu').forEach(submenu => {
                submenu.classList.remove('active');
            });
            
            // Limpar checkboxes de forma de pagamento
            document.getElementById('formaPagamentoCartao').checked = false;
            document.getElementById('formaPagamentoPix').checked = false;
            document.getElementById('formaPagamentoDinheiro').checked = false;
            document.getElementById('formaPagamentoBoleto').checked = false;
            document.getElementById('orcamentoFormaPagamento').value = '';
            
            carregarItensOrcamento([]);
            document.getElementById('orcamentoDescontoGeral').value = '0';
            
            // Preencher data com hoje
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('orcamentoData').value = hoje;
            
            // Gerar n√∫mero do or√ßamento
            try {
                const { data, error } = await supabase
                    .from('orcamentos')
                    .select('numero')
                    .order('created_at', { ascending: false })
                    .limit(1);
                
                let proximoNumero = 1;
                if (!error && data && data.length > 0 && data[0].numero) {
                    const ultimoNumero = parseInt(data[0].numero) || 0;
                    proximoNumero = ultimoNumero + 1;
                }
                
                document.getElementById('orcamentoNumero').value = proximoNumero.toString().padStart(4, '0');
            } catch (e) {
                document.getElementById('orcamentoNumero').value = '0001';
            }
            
            // Carregar clientes no select
            await loadClientesForOrcamentoSelect();
            
            // Selecionar cliente se fornecido
            if (clienteId) {
                document.getElementById('orcamentoClienteId').value = clienteId;
            }
            
            document.getElementById('orcamentoModal').classList.add('active');
        }

        // Carregar clientes no select de or√ßamento
        async function loadClientesForOrcamentoSelect() {
            try {
                const { data, error } = await supabase
                    .from('clientes')
                    .select('id, nome, empresa')
                    .eq('status', 'ativo')
                    .order('nome', { ascending: true });

                if (error) throw error;

                const select = document.getElementById('orcamentoClienteId');
                select.innerHTML = '<option value="">Selecione um cliente</option>';
                
                (data || []).forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.id;
                    option.textContent = cliente.empresa ? `${cliente.nome} - ${cliente.empresa}` : cliente.nome;
                    select.appendChild(option);
                });

            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
            }
        }

        // Atualizar forma de pagamento (coletar checkboxes marcados)
        function atualizarFormaPagamento() {
            const formasSelecionadas = [];
            if (document.getElementById('formaPagamentoCartao').checked) {
                formasSelecionadas.push('Cart√£o de Cr√©dito e D√©bito');
            }
            if (document.getElementById('formaPagamentoPix').checked) {
                formasSelecionadas.push('PIX');
            }
            if (document.getElementById('formaPagamentoDinheiro').checked) {
                formasSelecionadas.push('Dinheiro');
            }
            if (document.getElementById('formaPagamentoBoleto').checked) {
                formasSelecionadas.push('Boleto');
            }
            document.getElementById('orcamentoFormaPagamento').value = formasSelecionadas.join(', ');
        }

        // Fechar modal
        function closeOrcamentoModal() {
            document.getElementById('orcamentoModal').classList.remove('active');
            // Limpar checkboxes de servi√ßos
            document.querySelectorAll('#orcamentoServicosContainer input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            // Fechar todos os submenus
            document.querySelectorAll('#orcamentoServicosContainer .servico-submenu').forEach(submenu => {
                submenu.classList.remove('active');
            });
            // Limpar checkboxes de forma de pagamento
            document.getElementById('formaPagamentoCartao').checked = false;
            document.getElementById('formaPagamentoPix').checked = false;
            document.getElementById('formaPagamentoDinheiro').checked = false;
            document.getElementById('formaPagamentoBoleto').checked = false;
            document.getElementById('orcamentoFormaPagamento').value = '';
        }

        // Editar or√ßamento
        async function editOrcamento(id) {
            const orcamento = allOrcamentos.find(o => o.id === id);
            if (!orcamento) return;

            document.getElementById('orcamentoModalTitle').textContent = 'Editar Or√ßamento';
            document.getElementById('orcamentoId').value = orcamento.id;
            document.getElementById('orcamentoNumero').value = orcamento.numero || '';
            document.getElementById('orcamentoData').value = orcamento.data ? orcamento.data.split('T')[0] : '';
            document.getElementById('orcamentoValidade').value = orcamento.validade_dias || 30;
            document.getElementById('orcamentoDescontoGeral').value = orcamento.desconto_geral || 0;
            document.getElementById('orcamentoStatus').value = orcamento.status || 'rascunho';
            
            // Extrair condi√ß√µes comerciais das observa√ß√µes
            const observacoes = orcamento.observacoes || '';
            let condicoesPagamento = '';
            let formaPagamento = '';
            let prazoEntrega = '';
            let observacoesLimpa = observacoes;
            
            if (observacoes.includes('=== CONDI√á√ïES COMERCIAIS ===')) {
                const partes = observacoes.split('=== CONDI√á√ïES COMERCIAIS ===');
                observacoesLimpa = partes[0].trim();
                const condicoesTexto = partes[1] || '';
                
                // Extrair condi√ß√µes de pagamento
                const matchCondicoes = condicoesTexto.match(/Condi√ß√µes de Pagamento:\s*(.+?)(?:\n|$)/i);
                if (matchCondicoes) condicoesPagamento = matchCondicoes[1].trim();
                
                // Extrair forma de pagamento
                const matchForma = condicoesTexto.match(/Forma de Pagamento:\s*(.+?)(?:\n|$)/i);
                if (matchForma) formaPagamento = matchForma[1].trim();
                
                // Extrair prazo de entrega
                const matchPrazo = condicoesTexto.match(/Prazo de Entrega:\s*(.+?)(?:\n|$)/i);
                if (matchPrazo) prazoEntrega = matchPrazo[1].trim();
            }
            
            document.getElementById('orcamentoCondicoesPagamento').value = condicoesPagamento;
            document.getElementById('orcamentoPrazoEntrega').value = prazoEntrega;
            document.getElementById('orcamentoObservacoes').value = observacoesLimpa;
            
            // Marcar checkboxes de forma de pagamento
            if (formaPagamento) {
                const formas = formaPagamento.split(',').map(f => f.trim());
                document.getElementById('formaPagamentoCartao').checked = formas.includes('Cart√£o de Cr√©dito e D√©bito');
                document.getElementById('formaPagamentoPix').checked = formas.includes('PIX');
                document.getElementById('formaPagamentoDinheiro').checked = formas.includes('Dinheiro');
                document.getElementById('formaPagamentoBoleto').checked = formas.includes('Boleto');
                atualizarFormaPagamento();
            } else {
                document.getElementById('formaPagamentoCartao').checked = false;
                document.getElementById('formaPagamentoPix').checked = false;
                document.getElementById('formaPagamentoDinheiro').checked = false;
                document.getElementById('formaPagamentoBoleto').checked = false;
                document.getElementById('orcamentoFormaPagamento').value = '';
            }

            // Carregar itens (pode vir como string JSON ou array)
            let itens = orcamento.itens || [];
            if (typeof itens === 'string') {
                try {
                    itens = JSON.parse(itens);
                } catch (e) {
                    console.error('Erro ao fazer parse dos itens:', e);
                    itens = [];
                }
            }
            if (!Array.isArray(itens)) {
                itens = [];
            }
            carregarItensOrcamento(itens);

            // Carregar clientes e selecionar o cliente do or√ßamento
            await loadClientesForOrcamentoSelect();
            const clienteId = orcamento.cliente_id || '';
            document.getElementById('orcamentoClienteId').value = clienteId;

            document.getElementById('orcamentoModal').classList.add('active');
        }

        // Salvar or√ßamento (criar ou atualizar)
        document.getElementById('orcamentoForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('orcamentoId').value;
            const itens = coletarItensOrcamento();

            if (itens.length === 0) {
                alert('Adicione pelo menos um item ao or√ßamento!');
                return;
            }

            // Coletar condi√ß√µes comerciais para incluir nas observa√ß√µes
            const condicoesPagamento = document.getElementById('orcamentoCondicoesPagamento').value.trim();
            const formaPagamento = document.getElementById('orcamentoFormaPagamento').value.trim();
            const prazoEntrega = document.getElementById('orcamentoPrazoEntrega').value.trim();
            const observacoes = document.getElementById('orcamentoObservacoes').value.trim();
            
            // Montar observa√ß√µes completas incluindo condi√ß√µes comerciais
            let observacoesCompletas = observacoes || '';
            if (condicoesPagamento || formaPagamento || prazoEntrega) {
                if (observacoesCompletas) observacoesCompletas += '\n\n';
                observacoesCompletas += '=== CONDI√á√ïES COMERCIAIS ===\n';
                if (condicoesPagamento) observacoesCompletas += `Condi√ß√µes de Pagamento: ${condicoesPagamento}\n`;
                if (formaPagamento) observacoesCompletas += `Forma de Pagamento: ${formaPagamento}\n`;
                if (prazoEntrega) observacoesCompletas += `Prazo de Entrega: ${prazoEntrega}`;
            }

            const orcamentoData = {
                numero: document.getElementById('orcamentoNumero').value.trim(),
                cliente_id: document.getElementById('orcamentoClienteId').value,
                data: document.getElementById('orcamentoData').value,
                validade_dias: parseInt(document.getElementById('orcamentoValidade').value) || 30,
                valor: parseFloat(document.getElementById('orcamentoValor').value) || 0,
                desconto_geral: parseFloat(document.getElementById('orcamentoDescontoGeral').value) || 0,
                status: document.getElementById('orcamentoStatus').value,
                itens: itens,
                observacoes: observacoesCompletas || null
            };

            try {
                if (id) {
                    // Atualizar
                    const { error } = await supabase
                        .from('orcamentos')
                        .update(orcamentoData)
                        .eq('id', id);

                    if (error) throw error;
                    alert('Or√ßamento atualizado com sucesso!');
                } else {
                    // Criar
                    const { error } = await supabase
                        .from('orcamentos')
                        .insert([orcamentoData]);

                    if (error) throw error;
                    alert('Or√ßamento criado com sucesso!');
                }

                closeOrcamentoModal();
                loadOrcamentos();
                loadDashboardData();
            } catch (error) {
                console.error('Erro ao salvar or√ßamento:', error);
                alert('Erro ao salvar or√ßamento: ' + (error.message || 'Erro desconhecido'));
            }
        });

        // Ver detalhes do or√ßamento
        function viewOrcamentoDetails(id) {
            const orcamento = allOrcamentos.find(o => o.id === id);
            if (!orcamento) {
                alert('Or√ßamento n√£o encontrado');
                return;
            }

            const content = document.getElementById('orcamentoDetailsContent');
            const editBtn = document.getElementById('editOrcamentoFromDetailsBtn');
            const deleteBtn = document.getElementById('deleteOrcamentoFromDetailsBtn');
            
            editBtn.onclick = () => {
                closeOrcamentoDetailsModal();
                editOrcamento(id);
            };

            deleteBtn.onclick = async () => {
                if (!confirm('Tem certeza que deseja excluir este or√ßamento? Esta a√ß√£o n√£o pode ser desfeita.')) {
                    return;
                }

                try {
                    const { error } = await supabase
                        .from('orcamentos')
                        .delete()
                        .eq('id', id);

                    if (error) throw error;
                    
                    alert('Or√ßamento exclu√≠do com sucesso!');
                    closeOrcamentoDetailsModal();
                    loadOrcamentos();
                    loadDashboardData();
                } catch (error) {
                    console.error('Erro ao excluir or√ßamento:', error);
                    alert('Erro ao excluir or√ßamento: ' + (error.message || 'Erro desconhecido'));
                }
            };

            const cliente = orcamento.cliente || {};
            const clienteNome = cliente.nome || cliente.empresa || 'Cliente n√£o encontrado';

            const formatDate = (dateStr) => {
                if (!dateStr) return '-';
                try {
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('pt-BR');
                } catch {
                    return dateStr;
                }
            };

            const formatCurrency = (value) => {
                if (!value) return 'R$ 0,00';
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(value);
            };

            // Calcular data de validade
            let dataValidade = '-';
            if (orcamento.data && orcamento.validade_dias) {
                try {
                    const data = new Date(orcamento.data);
                    data.setDate(data.getDate() + parseInt(orcamento.validade_dias));
                    dataValidade = formatDate(data.toISOString());
                } catch (e) {
                    dataValidade = '-';
                }
            }

            const statusMap = {
                'rascunho': { label: 'Rascunho', class: 'badge-rascunho' },
                'enviado': { label: 'Enviado', class: 'badge-enviado' },
                'aprovado': { label: 'Aprovado', class: 'badge-aprovado' },
                'rejeitado': { label: 'Rejeitado', class: 'badge-rejeitado' },
                'expirado': { label: 'Expirado', class: 'badge-expirado' }
            };

            const status = statusMap[orcamento.status] || { label: orcamento.status, class: 'badge-rascunho' };

            const displayValue = (value) => value || '<span class="empty">-</span>';

            // Preparar itens do or√ßamento
            const itens = orcamento.itens || [];
            let itensHtml = '';
            let subtotalItens = 0;

            if (itens.length > 0) {
                itensHtml = '<table style="width: 100%; border-collapse: collapse; margin-top: 12px;">';
                itensHtml += '<thead><tr style="background: var(--tertiary); border-bottom: 1px solid rgba(255,255,255,0.1);">';
                itensHtml += '<th style="padding: 8px; text-align: left; font-size: 12px;">Descri√ß√£o</th>';
                itensHtml += '<th style="padding: 8px; text-align: center; font-size: 12px;">Qtd</th>';
                itensHtml += '<th style="padding: 8px; text-align: right; font-size: 12px;">Valor Unit.</th>';
                itensHtml += '<th style="padding: 8px; text-align: right; font-size: 12px;">Desc. %</th>';
                itensHtml += '<th style="padding: 8px; text-align: right; font-size: 12px;">Subtotal</th>';
                itensHtml += '</tr></thead><tbody>';

                itens.forEach(item => {
                    const itemSubtotal = item.subtotal || 0;
                    subtotalItens += itemSubtotal;
                    itensHtml += `<tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">`;
                    itensHtml += `<td style="padding: 8px;">${item.descricao || '-'}</td>`;
                    itensHtml += `<td style="padding: 8px; text-align: center;">${item.quantidade || 0}</td>`;
                    itensHtml += `<td style="padding: 8px; text-align: right;">${formatCurrency(item.valor_unitario || 0)}</td>`;
                    itensHtml += `<td style="padding: 8px; text-align: right;">${item.desconto_percent || 0}%</td>`;
                    itensHtml += `<td style="padding: 8px; text-align: right; font-weight: 600;">${formatCurrency(itemSubtotal)}</td>`;
                    itensHtml += `</tr>`;
                });

                itensHtml += '</tbody></table>';
            } else {
                itensHtml = '<div style="padding: 20px; text-align: center; color: var(--text-gray); font-style: italic;">Nenhum item cadastrado</div>';
            }

            const descontoGeral = parseFloat(orcamento.desconto_geral || 0);

            content.innerHTML = `
                <div class="details-section">
                    <div class="details-section-title">Informa√ß√µes B√°sicas</div>
                    <div class="details-grid">
                        <div class="details-item">
                            <div class="details-label">N√∫mero do Or√ßamento</div>
                            <div class="details-value">${orcamento.numero || '-'}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Cliente</div>
                            <div class="details-value">${clienteNome}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Data do Or√ßamento</div>
                            <div class="details-value">${formatDate(orcamento.data)}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Validade</div>
                            <div class="details-value">${orcamento.validade_dias || '-'} dias (at√© ${dataValidade})</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Status</div>
                            <div class="details-value">
                                <span class="badge ${status.class}">
                                    ${status.label}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="details-section">
                    <div class="details-section-title">Itens do Or√ßamento</div>
                    ${itensHtml}
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-weight: 600;">Subtotal:</span>
                            <span style="font-weight: 600;">${formatCurrency(subtotalItens)}</span>
                        </div>
                        ${descontoGeral > 0 ? `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; color: var(--danger);">
                            <span>Desconto Geral:</span>
                            <span>${formatCurrency(descontoGeral)}</span>
                        </div>
                        ` : ''}
                        <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: 700; color: var(--primary); padding-top: 8px; border-top: 2px solid var(--primary);">
                            <span>Total:</span>
                            <span>${formatCurrency(orcamento.valor)}</span>
                        </div>
                    </div>
                </div>

                <div class="details-section">
                    <div class="details-section-title">Observa√ß√µes</div>
                    <div class="details-item">
                        <div class="details-value" style="white-space: pre-wrap;">${displayValue(orcamento.observacoes)}</div>
                    </div>
                </div>
            `;

            // Configurar bot√µes de a√ß√£o
            document.getElementById('orcamentoDetailsModal').dataset.orcamentoId = id;
            
            const pdfBtn = document.getElementById('downloadPDFBtn');
            pdfBtn.onclick = () => gerarPDFOrcamento();

            const aprovarBtn = document.getElementById('aprovarOrcamentoBtn');
            const recusarBtn = document.getElementById('recusarOrcamentoBtn');
            const criarProjetoBtn = document.getElementById('criarProjetoBtn');
            const gerarLinkBtn = document.getElementById('gerarLinkPublicoBtn');
            const linkContainer = document.getElementById('linkPublicoContainer');
            const linkInput = document.getElementById('linkPublicoInput');
            
            // Configurar bot√£o de gerar link
            gerarLinkBtn.onclick = () => gerarLinkPublico(id);
            
            // Verificar se j√° existe link p√∫blico
            if (orcamento.token_publico && orcamento.acesso_publico) {
                const linkPublico = window.location.origin + window.location.pathname + '?proposta=' + orcamento.token_publico;
                linkInput.value = linkPublico;
                linkContainer.style.display = 'block';
                gerarLinkBtn.style.display = 'none';
            } else {
                linkContainer.style.display = 'none';
                gerarLinkBtn.style.display = 'inline-block';
            }
            
            if (orcamento.status === 'enviado') {
                aprovarBtn.style.display = 'inline-block';
                recusarBtn.style.display = 'inline-block';
                aprovarBtn.onclick = () => aprovarOrcamento(id);
                recusarBtn.onclick = () => recusarOrcamento(id);
                criarProjetoBtn.style.display = 'none';
            } else if (orcamento.status === 'aprovado') {
                aprovarBtn.style.display = 'none';
                recusarBtn.style.display = 'none';
                criarProjetoBtn.style.display = 'inline-block';
                criarProjetoBtn.onclick = () => criarProjetoDoOrcamento(id);
            } else {
                aprovarBtn.style.display = 'none';
                recusarBtn.style.display = 'none';
                criarProjetoBtn.style.display = 'none';
            }

            document.getElementById('orcamentoDetailsModal').classList.add('active');
        }

        // Fechar modal de detalhes
        function closeOrcamentoDetailsModal() {
            document.getElementById('orcamentoDetailsModal').classList.remove('active');
        }

        // Criar projeto a partir de or√ßamento aprovado
        async function criarProjetoDoOrcamento(orcamentoId) {
            const orcamento = allOrcamentos.find(o => o.id === orcamentoId);
            if (!orcamento) {
                alert('Or√ßamento n√£o encontrado');
                return;
            }

            if (orcamento.status !== 'aprovado') {
                alert('Apenas or√ßamentos aprovados podem gerar projetos');
                return;
            }

            // Fechar modal de or√ßamento
            closeOrcamentoDetailsModal();

            // Abrir modal de projeto preenchido
            document.getElementById('projetoModalTitle').textContent = 'Novo Projeto (do Or√ßamento)';
            document.getElementById('projetoForm').reset();
            document.getElementById('projetoId').value = '';

            // Preencher dados do or√ßamento
            const clienteNome = orcamento.cliente?.nome || orcamento.cliente?.empresa || 'Cliente do Or√ßamento';
            const nomeProjeto = `Projeto - ${clienteNome} - Or√ßamento ${orcamento.numero || ''}`;
            
            document.getElementById('projetoNome').value = nomeProjeto;
            document.getElementById('projetoClienteId').value = orcamento.cliente_id || '';
            document.getElementById('projetoStatus').value = 'planejamento';
            document.getElementById('projetoValor').value = orcamento.valor || '';

            // Data de in√≠cio com hoje
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('projetoDataInicio').value = hoje;

            // Calcular data prevista (validade do or√ßamento + hoje)
            if (orcamento.validade_dias) {
                const dataPrevista = new Date();
                dataPrevista.setDate(dataPrevista.getDate() + parseInt(orcamento.validade_dias));
                document.getElementById('projetoDataPrevista').value = dataPrevista.toISOString().split('T')[0];
            }

            // Descri√ß√£o com informa√ß√µes do or√ßamento
            let descricao = `Projeto criado a partir do Or√ßamento ${orcamento.numero || ''}.\n\n`;
            descricao += `Itens do or√ßamento:\n`;
            const itens = orcamento.itens || [];
            itens.forEach((item, index) => {
                descricao += `${index + 1}. ${item.descricao || 'Item'} - Qtd: ${item.quantidade || 1} - Valor: R$ ${(item.subtotal || 0).toFixed(2)}\n`;
            });
            descricao += `\nTotal: R$ ${(orcamento.valor || 0).toFixed(2)}`;
            
            if (orcamento.condicoes_pagamento) {
                descricao += `\n\nCondi√ß√µes de Pagamento: ${orcamento.condicoes_pagamento}`;
            }
            if (orcamento.prazo_entrega) {
                descricao += `\nPrazo de Entrega: ${orcamento.prazo_entrega}`;
            }
            if (orcamento.observacoes) {
                descricao += `\n\nObserva√ß√µes do Or√ßamento: ${orcamento.observacoes}`;
            }

            document.getElementById('projetoDescricao').value = descricao;

            // Tags com refer√™ncia ao or√ßamento
            document.getElementById('projetoTags').value = `orcamento-${orcamento.numero || orcamentoId}, aprovado`;

            // Carregar clientes e usu√°rios
            await Promise.all([
                loadClientesForSelect(),
                loadUsuariosForSelect()
            ]);

            // Selecionar cliente
            if (orcamento.cliente_id) {
                document.getElementById('projetoClienteId').value = orcamento.cliente_id;
            }

            // Abrir modal
            document.getElementById('projetoModal').classList.add('active');
        }

        // ========== GERENCIAMENTO DE ITENS DO OR√áAMENTO ==========
        let orcamentoItens = [];
        let itemCounter = 0;

        // Adicionar item ao or√ßamento
        function adicionarItemOrcamento() {
            const tbody = document.getElementById('orcamentoItensBody');
            
            // Remover mensagem de "nenhum item"
            if (tbody.children.length === 1 && tbody.children[0].children.length === 1) {
                tbody.innerHTML = '';
            }

            const itemId = 'item_' + (++itemCounter);
            const row = document.createElement('tr');
            row.id = itemId;
            row.innerHTML = `
                <td data-label="Descri√ß√£o">
                    <input type="text" class="form-input item-descricao" placeholder="Descri√ß√£o do item" style="width: 100%; font-size: 12px; padding: 6px;" onchange="calcularTotalOrcamento()">
                </td>
                <td data-label="Quantidade">
                    <input type="number" class="form-input item-quantidade" value="1" min="1" step="1" style="width: 100%; font-size: 12px; padding: 6px; text-align: center;" onchange="calcularItem('${itemId}')">
                </td>
                <td data-label="Valor Unit√°rio">
                    <input type="number" class="form-input item-valor-unitario" value="0" min="0" step="0.01" style="width: 100%; font-size: 12px; padding: 6px; text-align: right;" onchange="calcularItem('${itemId}')">
                </td>
                <td data-label="Desconto %">
                    <input type="number" class="form-input item-desconto" value="0" min="0" max="100" step="0.01" style="width: 100%; font-size: 12px; padding: 6px; text-align: right;" onchange="calcularItem('${itemId}')">
                </td>
                <td class="item-subtotal" data-label="Subtotal" style="text-align: right; padding: 8px; font-weight: 600;">R$ 0,00</td>
                <td data-label="A√ß√µes" style="text-align: center;">
                    <button type="button" class="btn-action" onclick="removerItemOrcamento('${itemId}')" style="border-color: var(--danger); color: var(--danger); padding: 4px 8px;">‚úó</button>
                </td>
            `;
            tbody.appendChild(row);
            calcularTotalOrcamento();
        }

        // Remover item do or√ßamento
        function removerItemOrcamento(itemId) {
            const row = document.getElementById(itemId);
            if (row) {
                row.remove();
                calcularTotalOrcamento();
                
                // Se n√£o houver mais itens, mostrar mensagem
                const tbody = document.getElementById('orcamentoItensBody');
                if (tbody.children.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="padding: 20px; text-align: center; color: var(--text-gray); font-style: italic;">
                                Nenhum item adicionado. Clique em "Adicionar Item" para come√ßar.
                            </td>
                        </tr>
                    `;
                }
            }
        }

        // Toggle submenu de servi√ßos (para or√ßamento)
        function toggleSubmenu(contexto, servico) {
            const prefix = contexto === 'orcamento' ? 'orcamento' : '';
            
            // Mapear nomes de servi√ßos para IDs corretos (tratando underscores)
            const servicoMap = {
                'redes_sociais': 'RedesSociais',
                'automacao': 'Automacao',
                'site': 'Site',
                'trafego': 'Trafego',
                'design': 'Design'
            };
            
            const servicoFormatted = servicoMap[servico] || servico.charAt(0).toUpperCase() + servico.slice(1);
            const submenuId = prefix ? `orcamentoSubmenu${servicoFormatted}` : `submenu${servicoFormatted}`;
            const checkboxId = prefix ? `orcamentoServico${servicoFormatted}` : `servico${servicoFormatted}`;
            
            const submenu = document.getElementById(submenuId);
            const checkbox = document.getElementById(checkboxId);
            
            if (submenu && checkbox) {
                if (checkbox.checked) {
                    submenu.classList.add('active');
                } else {
                    submenu.classList.remove('active');
                    // Desmarcar todos os subitens quando o principal √© desmarcado
                    submenu.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                        if (cb.checked) {
                            cb.checked = false;
                            if (contexto === 'orcamento') {
                                removerServicoDoOrcamento(cb.value);
                            }
                        }
                    });
                }
            }
        }

        // Adicionar servi√ßo automaticamente aos itens do or√ßamento
        function adicionarServicoAoOrcamento(servicoId, descricao) {
            const checkbox = document.querySelector(`#orcamentoServicosContainer input[value="${servicoId}"]`);
            if (!checkbox) return;

            const tbody = document.getElementById('orcamentoItensBody');
            
            // Remover mensagem de "nenhum item"
            if (tbody.children.length === 1 && tbody.children[0].children.length === 1) {
                tbody.innerHTML = '';
            }

            if (checkbox.checked) {
                // Verificar se o item j√° existe
                const existingItem = Array.from(tbody.querySelectorAll('tr')).find(row => {
                    const descInput = row.querySelector('.item-descricao');
                    return descInput && descInput.value === descricao;
                });

                if (!existingItem) {
                    // Adicionar novo item
                    const itemId = 'item_' + (++itemCounter);
                    const row = document.createElement('tr');
                    row.id = itemId;
                    row.dataset.servicoId = servicoId;
                    row.innerHTML = `
                        <td data-label="Descri√ß√£o">
                            <input type="text" class="form-input item-descricao" value="${descricao}" style="width: 100%; font-size: 12px; padding: 6px;" onchange="calcularTotalOrcamento()">
                        </td>
                        <td data-label="Quantidade">
                            <input type="number" class="form-input item-quantidade" value="1" min="1" step="1" style="width: 100%; font-size: 12px; padding: 6px; text-align: center;" onchange="calcularItem('${itemId}')">
                        </td>
                        <td data-label="Valor Unit√°rio">
                            <input type="number" class="form-input item-valor-unitario" value="0" min="0" step="0.01" style="width: 100%; font-size: 12px; padding: 6px; text-align: right;" onchange="calcularItem('${itemId}')" placeholder="0.00">
                        </td>
                        <td data-label="Desconto %">
                            <input type="number" class="form-input item-desconto" value="0" min="0" max="100" step="0.01" style="width: 100%; font-size: 12px; padding: 6px; text-align: right;" onchange="calcularItem('${itemId}')">
                        </td>
                        <td class="item-subtotal" data-label="Subtotal" style="text-align: right; padding: 8px; font-weight: 600;">R$ 0,00</td>
                        <td data-label="A√ß√µes" style="text-align: center;">
                            <button type="button" class="btn-action" onclick="removerItemOrcamento('${itemId}')" style="border-color: var(--danger); color: var(--danger); padding: 4px 8px;">‚úó</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                    calcularTotalOrcamento();
                }
            } else {
                // Remover item quando desmarcado
                removerServicoDoOrcamento(servicoId);
            }
        }

        // Remover servi√ßo dos itens do or√ßamento
        function removerServicoDoOrcamento(servicoId) {
            const tbody = document.getElementById('orcamentoItensBody');
            const row = Array.from(tbody.querySelectorAll('tr')).find(r => r.dataset.servicoId === servicoId);
            if (row) {
                row.remove();
                calcularTotalOrcamento();
                
                // Se n√£o houver mais itens, mostrar mensagem
                if (tbody.children.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="padding: 20px; text-align: center; color: var(--text-gray); font-style: italic;">
                                Nenhum item adicionado. Clique em "Adicionar Item" para come√ßar.
                            </td>
                        </tr>
                    `;
                }
            }
        }

        // Calcular subtotal de um item - COM PRECIS√ÉO
        function calcularItem(itemId) {
            const row = document.getElementById(itemId);
            if (!row) return;

            const quantidade = parseFloat(row.querySelector('.item-quantidade').value) || 0;
            const valorUnitario = parseFloat(row.querySelector('.item-valor-unitario').value) || 0;
            const descontoPercent = parseFloat(row.querySelector('.item-desconto').value) || 0;

            // C√°lculos precisos com arredondamento correto
            const subtotal = Math.round((quantidade * valorUnitario) * 100) / 100; // Arredondar para 2 casas
            const descontoValor = Math.round((subtotal * (descontoPercent / 100)) * 100) / 100; // Arredondar desconto
            const subtotalFinal = Math.round((subtotal - descontoValor) * 100) / 100; // Arredondar resultado final

            row.querySelector('.item-subtotal').textContent = formatCurrency(subtotalFinal);
            calcularTotalOrcamento();
        }

        // Calcular total do or√ßamento - COM PRECIS√ÉO
        function calcularTotalOrcamento() {
            const tbody = document.getElementById('orcamentoItensBody');
            let subtotal = 0;

            tbody.querySelectorAll('tr').forEach(row => {
                // Pular linha de mensagem vazia
                if (row.children.length === 1) return;
                
                const quantidadeInput = row.querySelector('.item-quantidade');
                const valorUnitarioInput = row.querySelector('.item-valor-unitario');
                const descontoInput = row.querySelector('.item-desconto');
                
                if (!quantidadeInput || !valorUnitarioInput || !descontoInput) return;
                
                const quantidade = parseFloat(quantidadeInput.value) || 0;
                const valorUnitario = parseFloat(valorUnitarioInput.value) || 0;
                const descontoPercent = parseFloat(descontoInput.value) || 0;

                // C√°lculos precisos com arredondamento correto
                const itemSubtotal = Math.round((quantidade * valorUnitario) * 100) / 100;
                const descontoValor = Math.round((itemSubtotal * (descontoPercent / 100)) * 100) / 100;
                const subtotalItem = Math.round((itemSubtotal - descontoValor) * 100) / 100;
                subtotal = Math.round((subtotal + subtotalItem) * 100) / 100; // Acumular com precis√£o
                
                // Atualizar subtotal do item na tela
                const subtotalCell = row.querySelector('.item-subtotal');
                if (subtotalCell) {
                    subtotalCell.textContent = formatCurrency(subtotalItem);
                }
            });

            // Arredondar subtotal final
            subtotal = Math.round(subtotal * 100) / 100;
            
            const descontoGeral = parseFloat(document.getElementById('orcamentoDescontoGeral')?.value) || 0;
            const descontoGeralArredondado = Math.round(descontoGeral * 100) / 100;
            const total = Math.round((subtotal - descontoGeralArredondado) * 100) / 100;

            const subtotalEl = document.getElementById('orcamentoSubtotal');
            const descontoGeralEl = document.getElementById('orcamentoDescontoGeralValor');
            const totalEl = document.getElementById('orcamentoValorTotal');
            const valorHidden = document.getElementById('orcamentoValor');
            
            if (subtotalEl) subtotalEl.textContent = formatCurrency(subtotal);
            if (descontoGeralEl) descontoGeralEl.textContent = formatCurrency(descontoGeralArredondado);
            if (totalEl) totalEl.textContent = formatCurrency(total);
            if (valorHidden) valorHidden.value = total.toFixed(2);
        }

        // Coletar itens do formul√°rio
        function coletarItensOrcamento() {
            const tbody = document.getElementById('orcamentoItensBody');
            const itens = [];

            tbody.querySelectorAll('tr').forEach(row => {
                // Pular linha de mensagem vazia
                if (row.children.length === 1) return;
                
                const descricaoInput = row.querySelector('.item-descricao');
                if (!descricaoInput) return;
                
                const descricao = descricaoInput.value.trim();
                if (!descricao) return; // Pular itens sem descri√ß√£o

                const quantidade = parseFloat(row.querySelector('.item-quantidade')?.value) || 0;
                const valorUnitario = parseFloat(row.querySelector('.item-valor-unitario')?.value) || 0;
                const descontoPercent = parseFloat(row.querySelector('.item-desconto')?.value) || 0;
                
                // Calcular subtotal corretamente - COM PRECIS√ÉO
                const itemSubtotal = Math.round((quantidade * valorUnitario) * 100) / 100;
                const descontoValor = Math.round((itemSubtotal * (descontoPercent / 100)) * 100) / 100;
                const subtotal = Math.round((itemSubtotal - descontoValor) * 100) / 100;

                itens.push({
                    descricao,
                    quantidade,
                    valor_unitario: valorUnitario,
                    desconto_percent: descontoPercent,
                    subtotal: subtotal
                });
            });

            return itens;
        }

        // Carregar itens no formul√°rio
        function carregarItensOrcamento(itens) {
            const tbody = document.getElementById('orcamentoItensBody');
            tbody.innerHTML = '';

            if (!itens || itens.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="padding: 20px; text-align: center; color: var(--text-gray); font-style: italic;">
                            Nenhum item adicionado. Clique em "Adicionar Item" para come√ßar.
                        </td>
                    </tr>
                `;
                return;
            }

            itemCounter = 0;
            itens.forEach(item => {
                const itemId = 'item_' + (++itemCounter);
                // Garantir que os valores sejam n√∫meros
                const quantidade = parseFloat(item.quantidade) || parseFloat(item.qtd) || 1;
                const valorUnitario = parseFloat(item.valor_unitario) || parseFloat(item.valorUnitario) || parseFloat(item.valor_unit) || 0;
                const descontoPercent = parseFloat(item.desconto_percent) || parseFloat(item.descontoPercent) || parseFloat(item.desconto) || 0;
                
                // Recalcular subtotal baseado nos valores - COM PRECIS√ÉO
                const itemSubtotal = Math.round((quantidade * valorUnitario) * 100) / 100;
                const descontoValor = Math.round((itemSubtotal * (descontoPercent / 100)) * 100) / 100;
                const subtotalCalculado = Math.round((itemSubtotal - descontoValor) * 100) / 100;
                
                const row = document.createElement('tr');
                row.id = itemId;
                if (item.servico_id) {
                    row.dataset.servicoId = item.servico_id;
                }
                row.innerHTML = `
                    <td data-label="Descri√ß√£o">
                        <input type="text" class="form-input item-descricao" value="${(item.descricao || '').replace(/"/g, '&quot;')}" placeholder="Descri√ß√£o do item" style="width: 100%; font-size: 12px; padding: 6px;" onchange="calcularTotalOrcamento()">
                    </td>
                    <td data-label="Quantidade">
                        <input type="number" class="form-input item-quantidade" value="${quantidade}" min="1" step="1" style="width: 100%; font-size: 12px; padding: 6px; text-align: center;" onchange="calcularItem('${itemId}')">
                    </td>
                    <td data-label="Valor Unit√°rio">
                        <input type="number" class="form-input item-valor-unitario" value="${valorUnitario}" min="0" step="0.01" style="width: 100%; font-size: 12px; padding: 6px; text-align: right;" onchange="calcularItem('${itemId}')">
                    </td>
                    <td data-label="Desconto %">
                        <input type="number" class="form-input item-desconto" value="${descontoPercent}" min="0" max="100" step="0.01" style="width: 100%; font-size: 12px; padding: 6px; text-align: right;" onchange="calcularItem('${itemId}')">
                    </td>
                    <td class="item-subtotal" data-label="Subtotal" style="text-align: right; padding: 8px; font-weight: 600;">${formatCurrency(subtotalCalculado)}</td>
                    <td data-label="A√ß√µes" style="text-align: center;">
                        <button type="button" class="btn-action" onclick="removerItemOrcamento('${itemId}')" style="border-color: var(--danger); color: var(--danger); padding: 4px 8px;">‚úó</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            calcularTotalOrcamento();
        }

        // Aprovar or√ßamento
        async function aprovarOrcamento(id) {
            if (!confirm('Deseja aprovar este or√ßamento?')) return;

            try {
                const { error } = await supabase
                    .from('orcamentos')
                    .update({ status: 'aprovado' })
                    .eq('id', id);

                if (error) throw error;
                alert('Or√ßamento aprovado com sucesso!');
                loadOrcamentos();
                closeOrcamentoDetailsModal();
            } catch (error) {
                console.error('Erro ao aprovar or√ßamento:', error);
                alert('Erro ao aprovar or√ßamento: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // Recusar or√ßamento
        async function recusarOrcamento(id) {
            if (!confirm('Deseja recusar este or√ßamento?')) return;

            try {
                const { error } = await supabase
                    .from('orcamentos')
                    .update({ status: 'rejeitado' })
                    .eq('id', id);

                if (error) throw error;
                alert('Or√ßamento recusado.');
                loadOrcamentos();
                closeOrcamentoDetailsModal();
            } catch (error) {
                console.error('Erro ao recusar or√ßamento:', error);
                alert('Erro ao recusar or√ßamento: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // Gerar PDF do or√ßamento
        async function gerarPDFOrcamento() {
            try {
                const orcamentoId = document.getElementById('orcamentoDetailsModal').dataset.orcamentoId;
                if (!orcamentoId) {
                    alert('Or√ßamento n√£o encontrado');
                    return;
                }
                
                const orcamento = allOrcamentos.find(o => o.id === orcamentoId);
                if (!orcamento) {
                    alert('Or√ßamento n√£o encontrado');
                    return;
                }

                // Buscar dados completos do cliente
                let clienteCompleto = orcamento.cliente || {};
                if (orcamento.cliente_id && !clienteCompleto.endereco) {
                    try {
                        const { data, error } = await supabase
                            .from('clientes')
                            .select('*')
                            .eq('id', orcamento.cliente_id)
                            .single();
                        if (!error && data) {
                            clienteCompleto = data;
                        }
                    } catch (e) {
                        console.warn('Erro ao buscar dados completos do cliente:', e);
                    }
                }

                // Verificar se jsPDF est√° dispon√≠vel
                if (!window.jspdf) {
                    alert('Biblioteca de PDF n√£o carregada. Por favor, recarregue a p√°gina.');
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Fun√ß√£o auxiliar para formatar moeda no PDF
                const formatCurrencyPDF = (value) => {
                    if (!value && value !== 0) return 'R$ 0,00';
                    return new Intl.NumberFormat('pt-BR', {
                        style: 'currency',
                        currency: 'BRL'
                    }).format(value);
                };

                // Fun√ß√£o auxiliar para formatar data no PDF
                const formatDatePDF = (dateStr) => {
                    if (!dateStr) return '-';
                    try {
                        const date = new Date(dateStr);
                        return date.toLocaleDateString('pt-BR');
                    } catch {
                        return dateStr;
                    }
                };

                // Configura√ß√µes
                const margin = 20;
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                let y = margin;

                // ========== CABE√áALHO - DADOS DA EMPRESA ==========
                let logoLoaded = false;
                
                // Tentar adicionar logo
                try {
                    const logoUrl = 'https://zhzhpctsndrcedukivhk.supabase.co/storage/v1/object/public/logo/LOGO%203D%20SEM%20FUNDO%20(1).png';
                    
                    // Usar fetch para obter a imagem como base64
                    const response = await fetch(logoUrl);
                    if (response.ok) {
                        const blob = await response.blob();
                        const reader = new FileReader();
                        
                        await new Promise((resolve, reject) => {
                            reader.onload = () => resolve(reader.result);
                            reader.onerror = reject;
                            reader.readAsDataURL(blob);
                        });
                        
                        const logoData = reader.result;
                        // Adicionar logo (ajustar tamanho conforme necess√°rio)
                        doc.addImage(logoData, 'PNG', margin, 5, 60, 25);
                        logoLoaded = true;
                    }
                } catch (e) {
                    console.warn('Erro ao carregar logo:', e);
                }
                
                // Se logo n√£o carregou, usar texto
                if (!logoLoaded) {
                    doc.setFillColor(255, 102, 0);
                    doc.rect(0, 0, pageWidth, 50, 'F');
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(28);
                    doc.setFont(undefined, 'bold');
                    doc.text('AUTOVIZION', margin, 30);
                    
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'normal');
                    doc.text('Solu√ß√µes em Marketing Digital e Tecnologia', margin, 38);
                }
                
                // Dados da empresa no cabe√ßalho (lado direito) - Melhor formatado
                const dadosX = pageWidth - margin - 60;
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('AUTOVIZION', dadosX, 12);
                
                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(60, 60, 60);
                doc.text('www.autovizon.com.br', dadosX, 20);
                doc.text('autovizioncomercial@gmail.com', dadosX, 26);
                doc.text('(14) 99600-5936', dadosX, 32);
                
                // Linha divis√≥ria abaixo do cabe√ßalho
                doc.setDrawColor(200, 200, 200);
                doc.line(margin, 35, pageWidth - margin, 35);
                
                y = 45;

                // ========== T√çTULO DO DOCUMENTO ==========
                // Fundo colorido para o t√≠tulo
                doc.setFillColor(255, 102, 0);
                doc.rect(margin, y - 5, pageWidth - (margin * 2), 20, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(22);
                doc.setFont(undefined, 'bold');
                doc.text('PROPOSTA COMERCIAL', margin + 5, y + 8);
                
                // N√∫mero e data √† direita (sobre o fundo)
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`N¬∫ ${orcamento.numero || 'N/A'}`, pageWidth - margin - 30, y + 2);
                doc.text(`Data: ${formatDatePDF(orcamento.data)}`, pageWidth - margin - 30, y + 9);
                
                y += 20;

                // ========== DADOS DO CLIENTE ==========
                // Definir vari√°veis do cliente primeiro
                const clienteNome = clienteCompleto.nome || clienteCompleto.empresa || 'Cliente n√£o encontrado';
                const clienteEmpresa = clienteCompleto.empresa || '';
                const clienteCpfCnpj = clienteCompleto.cpf_cnpj || '';
                const clienteEndereco = clienteCompleto.endereco || '';
                const clienteCidade = clienteCompleto.cidade || '';
                const clienteEstado = clienteCompleto.estado || '';
                const clienteCep = clienteCompleto.cep || '';
                const clienteTelefone = clienteCompleto.telefone || '';
                const clienteEmail = clienteCompleto.email || '';

                // ========== INTRODU√á√ÉO ==========
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(60, 60, 60);
                const introText = `Prezado(a) ${clienteNome},`;
                doc.text(introText, margin, y);
                y += 8;
                
                const apresentacao = `√â com grande entusiasmo que finalizamos a an√°lise de suas necessidades e desenvolvemos uma proposta comercial estrat√©gica. Nosso foco √© apresentar solu√ß√µes concretas que impulsionar√£o seus resultados e atender√£o, com excel√™ncia, aos seus objetivos espec√≠ficos.`;
                const apresentacaoLines = doc.splitTextToSize(apresentacao, pageWidth - (margin * 2));
                doc.text(apresentacaoLines, margin, y);
                y += apresentacaoLines.length * 5 + 10;

                // ========== DADOS DO CLIENTE ==========
                // Fundo com cor laranja suave
                doc.setFillColor(255, 102, 0);
                doc.rect(margin, y, pageWidth - (margin * 2), 8, 'F');
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('DADOS DO CLIENTE', margin + 3, y + 6);
                y += 12;
                
                doc.setTextColor(0, 0, 0);
                
                doc.text(`Cliente: ${clienteNome}`, margin, y);
                y += 6;
                if (clienteEmpresa && clienteEmpresa !== clienteNome) {
                    doc.text(`Empresa: ${clienteEmpresa}`, margin, y);
                    y += 6;
                }
                if (clienteCpfCnpj) {
                    doc.text(`CPF/CNPJ: ${clienteCpfCnpj}`, margin, y);
                    y += 6;
                }
                if (clienteEndereco) {
                    let enderecoCompleto = clienteEndereco;
                    if (clienteCidade) enderecoCompleto += `, ${clienteCidade}`;
                    if (clienteEstado) enderecoCompleto += ` - ${clienteEstado}`;
                    if (clienteCep) enderecoCompleto += ` - CEP: ${clienteCep}`;
                    doc.text(`Endere√ßo: ${enderecoCompleto}`, margin, y);
                    y += 6;
                }
                if (clienteTelefone) {
                    doc.text(`Telefone: ${clienteTelefone}`, margin, y);
                    y += 6;
                }
                if (clienteEmail) {
                    doc.text(`E-mail: ${clienteEmail}`, margin, y);
                    y += 6;
                }
                
                y += 10;

                // ========== ITENS DO OR√áAMENTO ==========
                // Fundo com cor laranja suave
                doc.setFillColor(255, 102, 0);
                doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('ITENS DO OR√áAMENTO', margin + 3, y + 4);
                y += 12;
                
                doc.setTextColor(0, 0, 0);

                // Fazer parse dos itens se necess√°rio
                let itens = orcamento.itens || [];
                if (typeof itens === 'string') {
                    try {
                        itens = JSON.parse(itens);
                    } catch (e) {
                        console.error('Erro ao fazer parse dos itens no PDF:', e);
                        itens = [];
                    }
                }
                if (!Array.isArray(itens)) {
                    itens = [];
                }
                
                if (itens.length > 0) {
                    // Definir posi√ß√µes das colunas de forma clara
                    const colDescricao = margin + 2;
                    const colQtd = margin + 65;
                    const colValorUnit = margin + 85;
                    const colDesconto = margin + 120;
                    
                    // Cabe√ßalho da tabela com cor destacada
                    doc.setFillColor(45, 45, 45);
                    doc.rect(margin, y - 5, pageWidth - (margin * 2), 8, 'F');
                    
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(255, 255, 255);
                    doc.text('Descri√ß√£o', colDescricao, y);
                    doc.text('Qtd', colQtd, y);
                    doc.text('Valor Unit.', colValorUnit, y);
                    doc.text('Desconto', colDesconto, y);
                    y += 8;

                    let subtotal = 0;
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(9);
                    
                    itens.forEach((item, index) => {
                        // Verificar se precisa de nova p√°gina (deixar espa√ßo para pelo menos 3 linhas + totais)
                        if (y > pageHeight - 80) {
                            doc.addPage();
                            y = margin + 10;
                        }
                        
                        // Linha alternada (opcional)
                        if (index % 2 === 0) {
                            doc.setFillColor(250, 250, 250);
                            doc.rect(margin, y - 3, pageWidth - (margin * 2), 6, 'F');
                        }
                        
                        // Acessar campos com fallback para diferentes nomes
                        const descricao = item.descricao || item.desc || '-';
                        const quantidade = parseFloat(item.quantidade || item.qtd || 0);
                        const valorUnitario = parseFloat(item.valor_unitario || item.valorUnitario || item.valor_unit || 0);
                        const descontoPercent = parseFloat(item.desconto_percent || item.descontoPercent || item.desconto || 0);
                        
                        // Recalcular subtotal do item - COM PRECIS√ÉO
                        const itemSubtotal = Math.round((quantidade * valorUnitario) * 100) / 100;
                        const descontoValor = Math.round((itemSubtotal * (descontoPercent / 100)) * 100) / 100;
                        const subtotalItem = Math.round((itemSubtotal - descontoValor) * 100) / 100;
                        subtotal = Math.round((subtotal + subtotalItem) * 100) / 100;
                        
                        // Descri√ß√£o (pode quebrar linha se muito longa)
                        const descLines = doc.splitTextToSize(descricao, 60);
                        const firstLineY = y;
                        doc.setTextColor(0, 0, 0);
                        doc.text(descLines, colDescricao, firstLineY);
                        
                        // Quantidade
                        doc.text(quantidade.toString(), colQtd, firstLineY);
                        
                        // Valor unit√°rio
                        doc.text(formatCurrencyPDF(valorUnitario), colValorUnit, firstLineY);
                        
                        // Desconto
                        doc.text(descontoPercent + '%', colDesconto, firstLineY);
                        
                        y += Math.max(6, descLines.length * 6);
                    });

                    y += 5;
                    doc.setDrawColor(200, 200, 200);
                    doc.line(margin, y, pageWidth - margin, y);
                    y += 10;

                    // ========== TOTAIS ==========
                    // Verificar se h√° espa√ßo para os totais (subtotal + desconto + total + linha = ~30px)
                    if (y > pageHeight - 50) {
                        doc.addPage();
                        y = margin + 10;
                    }
                    
                    const descontoGeral = parseFloat(orcamento.desconto_geral || 0);
                    // Calcular total corretamente - COM PRECIS√ÉO
                    const descontoGeralArredondado = Math.round(descontoGeral * 100) / 100;
                    const subtotalArredondado = Math.round(subtotal * 100) / 100;
                    const total = Math.round((subtotalArredondado - descontoGeralArredondado) * 100) / 100;
                    
                    // Subtotal e Total - mesma linha, mesmo estilo, apenas linha de separa√ß√£o
                    // Alinhar mais √† esquerda para seguir o alinhamento geral da p√°gina
                    const labelX = margin + 10; // Posi√ß√£o do label (alinhado √† esquerda, seguindo o alinhamento geral)
                    const valueX = labelX + 100; // Posi√ß√£o do valor (espa√ßamento fixo ap√≥s o label, mais √† esquerda)
                    
                    // Subtotal - texto preto, tamanho normal
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(0, 0, 0);
                    doc.text('Subtotal:', labelX, y);
                    doc.text(formatCurrencyPDF(subtotal), valueX, y);
                    y += 7;

                    if (descontoGeral > 0) {
                        doc.setTextColor(200, 0, 0);
                        doc.text('Desconto Geral:', labelX, y);
                        doc.text(formatCurrencyPDF(descontoGeral), valueX, y);
                        y += 7;
                    }

                    // Linha laranja para separar (apenas uma listra)
                    doc.setDrawColor(255, 102, 0);
                    doc.setLineWidth(1);
                    doc.line(labelX - 10, y, valueX + 50, y);
                    y += 8;

                    // TOTAL - mesmo estilo do subtotal, seguindo as mesmas linhas
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold'); // Negrito para destacar
                    doc.setTextColor(0, 0, 0); // Texto preto, igual ao subtotal
                    doc.text('TOTAL:', labelX, y);
                    // Valor tamb√©m preto, negrito - alinhado √† esquerda, mesmo estilo do subtotal
                    const totalText = formatCurrencyPDF(total);
                    doc.text(totalText, valueX, y);
                    y += 15;
                } else {
                    doc.setFontSize(10);
                    doc.setTextColor(128, 128, 128);
                    doc.text('Nenhum item cadastrado', margin, y);
                    y += 10;
                }

                // ========== CONDI√á√ïES COMERCIAIS ==========
                // Extrair condi√ß√µes comerciais das observa√ß√µes
                const observacoes = orcamento.observacoes || '';
                let condicoesPagamento = '';
                let formaPagamento = '';
                let prazoEntrega = '';
                
                if (observacoes.includes('=== CONDI√á√ïES COMERCIAIS ===')) {
                    const partes = observacoes.split('=== CONDI√á√ïES COMERCIAIS ===');
                    const condicoesTexto = partes[1] || '';
                    
                    // Extrair condi√ß√µes de pagamento
                    const matchCondicoes = condicoesTexto.match(/Condi√ß√µes de Pagamento:\s*(.+?)(?:\n|$)/i);
                    if (matchCondicoes) condicoesPagamento = matchCondicoes[1].trim();
                    
                    // Extrair forma de pagamento
                    const matchForma = condicoesTexto.match(/Forma de Pagamento:\s*(.+?)(?:\n|$)/i);
                    if (matchForma) formaPagamento = matchForma[1].trim();
                    
                    // Extrair prazo de entrega
                    const matchPrazo = condicoesTexto.match(/Prazo de Entrega:\s*(.+?)(?:\n|$)/i);
                    if (matchPrazo) prazoEntrega = matchPrazo[1].trim();
                }

                if (condicoesPagamento || formaPagamento || prazoEntrega) {
                    // Verificar se precisa de nova p√°gina
                    if (y > pageHeight - 60) {
                        doc.addPage();
                        y = margin + 10;
                    }

                    doc.setFillColor(245, 245, 245);
                    doc.rect(margin, y, pageWidth - (margin * 2), 8, 'F');
                    
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(0, 0, 0);
                    doc.text('CONDI√á√ïES COMERCIAIS', margin + 3, y + 6);
                    y += 12;

                    doc.setFontSize(9);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(60, 60, 60);

                    if (condicoesPagamento) {
                        doc.setFont(undefined, 'bold');
                        doc.text('Condi√ß√µes de Pagamento:', margin, y);
                        y += 6;
                        doc.setFont(undefined, 'normal');
                        const condicoesLines = doc.splitTextToSize(condicoesPagamento, pageWidth - (margin * 2));
                        doc.text(condicoesLines, margin + 5, y);
                        y += condicoesLines.length * 5 + 5;
                    }

                    if (formaPagamento) {
                        doc.setFont(undefined, 'bold');
                        doc.text('Forma de Pagamento:', margin, y);
                        y += 6;
                        doc.setFont(undefined, 'normal');
                        const formaLines = doc.splitTextToSize(formaPagamento, pageWidth - (margin * 2));
                        doc.text(formaLines, margin + 5, y);
                        y += formaLines.length * 5 + 5;
                    }

                    if (prazoEntrega) {
                        doc.setFont(undefined, 'bold');
                        doc.text('Prazo de Entrega:', margin, y);
                        y += 6;
                        doc.setFont(undefined, 'normal');
                        const prazoLines = doc.splitTextToSize(prazoEntrega, pageWidth - (margin * 2));
                        doc.text(prazoLines, margin + 5, y);
                        y += prazoLines.length * 5 + 5;
                    }

                    y += 5;
                }

                // ========== TERMOS E CONDI√á√ïES ==========
                // Verificar se precisa de nova p√°gina
                if (y > pageHeight - 80) {
                    doc.addPage();
                    y = margin + 10;
                }

                doc.setFillColor(250, 250, 250);
                doc.rect(margin, y, pageWidth - (margin * 2), 8, 'F');
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('TERMOS E CONDI√á√ïES', margin + 3, y + 6);
                y += 12;

                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(60, 60, 60);

                const termos = [
                    '1. Esta proposta tem validade de ' + (orcamento.validade_dias || 30) + ' dias corridos a partir da data de emiss√£o.',
                    '2. Os valores apresentados est√£o sujeitos a altera√ß√£o sem aviso pr√©vio ap√≥s o prazo de validade.',
                    '3. O in√≠cio dos trabalhos est√° condicionado √† aprova√ß√£o formal desta proposta e ao pagamento conforme condi√ß√µes acordadas.',
                    '4. Todas as informa√ß√µes e materiais fornecidos pelo cliente ser√£o tratados com confidencialidade.',
                    '5. A empresa se reserva o direito de alterar prazos em caso de atraso na entrega de materiais ou informa√ß√µes necess√°rias pelo cliente.',
                    '6. Esta proposta n√£o inclui altera√ß√µes ou modifica√ß√µes n√£o especificadas, que ser√£o or√ßadas separadamente.',
                    '7. O cliente se compromete a fornecer todas as informa√ß√µes e materiais necess√°rios em tempo h√°bil para a execu√ß√£o dos servi√ßos.',
                    '8. Em caso de cancelamento, ser√£o aplicadas as pol√≠ticas de reembolso conforme acordo pr√©vio.'
                ];

                termos.forEach((termo, index) => {
                    if (y > pageHeight - 20) {
                        doc.addPage();
                        y = margin + 10;
                    }
                    const termoLines = doc.splitTextToSize(termo, pageWidth - (margin * 2) - 5);
                    doc.text(termoLines, margin + 5, y);
                    y += termoLines.length * 4 + 3;
                });

                y += 10;

                // ========== OBSERVA√á√ïES ==========
                // Extrair observa√ß√µes sem as condi√ß√µes comerciais
                let observacoesParaPDF = observacoes || '';
                if (observacoesParaPDF.includes('=== CONDI√á√ïES COMERCIAIS ===')) {
                    const partes = observacoesParaPDF.split('=== CONDI√á√ïES COMERCIAIS ===');
                    observacoesParaPDF = partes[0].trim();
                }
                
                if (observacoesParaPDF) {
                    if (y > pageHeight - 40) {
                        doc.addPage();
                        y = margin + 10;
                    }
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(0, 0, 0);
                    doc.text('OBSERVA√á√ïES:', margin, y);
                    y += 6;
                    
                    doc.setFont(undefined, 'normal');
                    const splitObservacoes = doc.splitTextToSize(observacoesParaPDF, pageWidth - (margin * 2));
                    doc.text(splitObservacoes, margin, y);
                    y += splitObservacoes.length * 6 + 10;
                }

                // ========== VALIDADE E FORMA DE PAGAMENTO ==========
                // Verificar se h√° espa√ßo suficiente na p√°gina (condi√ß√µes ~35px + rodap√© ~20px = 55px)
                // Se n√£o houver espa√ßo, quebrar para nova p√°gina
                if (y > pageHeight - 55) {
                    doc.addPage();
                    y = margin + 10;
                }
                
                y += 5;
                doc.setFillColor(250, 250, 250);
                const condicoesHeight = 35;
                doc.rect(margin, y, pageWidth - (margin * 2), condicoesHeight, 'F');
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('CONDI√á√ïES COMERCIAIS', margin + 3, y + 8);
                
                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                doc.setTextColor(60, 60, 60);
                
                let condY = y + 16;
                doc.text(`Validade da proposta: ${orcamento.validade_dias || 30} dias, sujeita √† disponibilidade de recursos.`, margin + 3, condY);
                condY += 6;
                
                doc.text('Forma de pagamento: A combinar, sujeita √† aprova√ß√£o m√∫tua.', margin + 3, condY);
                condY += 6;
                
                doc.text('Prazo de entrega: A combinar.', margin + 3, condY);
                condY += 6;
                
                doc.text('Condi√ß√µes especiais: Conforme negocia√ß√£o.', margin + 3, condY);
                
                y += condicoesHeight + 5;

                // ========== RODAP√â COM TERMOS ==========
                // Verificar se h√° espa√ßo para o rodap√© (termos + contato = ~25px)
                if (y > pageHeight - 25) {
                    doc.addPage();
                    y = margin + 10;
                }
                
                // Linha divis√≥ria antes do rodap√©
                doc.setDrawColor(200, 200, 200);
                doc.line(margin, y, pageWidth - margin, y);
                y += 5;
                
                doc.setFontSize(7);
                doc.setTextColor(100, 100, 100);
                doc.setFont(undefined, 'normal');
                
                const termosRodape = [
                    'A contrata√ß√£o dos servi√ßos est√° sujeita √† assinatura de contrato espec√≠fico.',
                    'Para mais informa√ß√µes, entre em contato conosco atrav√©s dos canais indicados.'
                ];
                
                termosRodape.forEach(termo => {
                    // Verificar se precisa de nova p√°gina para os termos
                    if (y > pageHeight - 15) {
                        doc.addPage();
                        y = margin + 10;
                    }
                    const termoLines = doc.splitTextToSize(termo, pageWidth - (margin * 2));
                    doc.text(termoLines, margin, y);
                    y += termoLines.length * 4 + 2;
                });
                
                // Informa√ß√µes de contato no rodap√© - Sempre na √∫ltima linha da p√°gina
                const contatoY = pageHeight - 8;
                doc.setFontSize(7);
                doc.setTextColor(128, 128, 128);
                doc.setFont(undefined, 'normal');
                doc.text('AUTOVIZION', margin, contatoY);
                doc.text('|', margin + 25, contatoY);
                doc.text('www.autovizon.com.br', margin + 30, contatoY);
                doc.text('|', margin + 70, contatoY);
                doc.text('autovizioncomercial@gmail.com', margin + 75, contatoY);
                doc.text('|', margin + 130, contatoY);
                doc.text('(14) 99600-5936', margin + 135, contatoY);
                
                // Salvar PDF
                const fileName = `Proposta_${orcamento.numero || 'N'}_${clienteNome.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                alert('Erro ao gerar PDF: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // ========== GERENCIAMENTO DE LINK P√öBLICO ==========
        
        // Gerar link p√∫blico para proposta
        async function gerarLinkPublico(orcamentoId) {
            try {
                // Gerar token √∫nico (64 caracteres hexadecimal)
                const token = Array.from(crypto.getRandomValues(new Uint8Array(32)))
                    .map(b => b.toString(16).padStart(2, '0'))
                    .join('');
                
                // Criar link p√∫blico
                const linkPublico = window.location.origin + window.location.pathname + '?proposta=' + token;
                
                // Salvar token e link no banco
                const { data, error } = await supabase
                    .from('orcamentos')
                    .update({
                        token_publico: token,
                        link_publico: linkPublico,
                        acesso_publico: true
                    })
                    .eq('id', orcamentoId)
                    .select()
                    .single();
                
                if (error) throw error;
                
                // Atualizar UI
                document.getElementById('linkPublicoInput').value = linkPublico;
                document.getElementById('linkPublicoContainer').style.display = 'block';
                document.getElementById('gerarLinkPublicoBtn').style.display = 'none';
                
                // Recarregar or√ßamentos para atualizar dados
                await loadOrcamentos();
                
                alert('Link p√∫blico gerado com sucesso!');
            } catch (error) {
                console.error('Erro ao gerar link p√∫blico:', error);
                alert('Erro ao gerar link p√∫blico: ' + (error.message || 'Erro desconhecido'));
            }
        }
        
        // Copiar link p√∫blico
        function copiarLinkPublico() {
            const linkInput = document.getElementById('linkPublicoInput');
            linkInput.select();
            linkInput.setSelectionRange(0, 99999); // Para mobile
            document.execCommand('copy');
            alert('Link copiado para a √°rea de transfer√™ncia!');
        }
        
        // Enviar link por WhatsApp
        function enviarLinkPorWhatsApp() {
            const linkPublico = document.getElementById('linkPublicoInput').value;
            const orcamento = allOrcamentos.find(o => o.id === document.getElementById('orcamentoDetailsModal').dataset.orcamentoId);
            const clienteNome = orcamento?.cliente?.nome || orcamento?.cliente?.empresa || 'Cliente';
            
            // Buscar telefone do cliente ou usar telefone padr√£o
            const telefoneCliente = orcamento?.cliente?.whatsapp || orcamento?.cliente?.telefone || '5514996005936';
            // Remover caracteres n√£o num√©ricos
            const telefoneLimpo = telefoneCliente.replace(/\D/g, '');
            // Garantir formato internacional (55 para Brasil)
            const telefoneFormatado = telefoneLimpo.startsWith('55') ? telefoneLimpo : '55' + telefoneLimpo;
            
            // Mensagem pr√©-formatada
            const mensagem = `Ol√° ${clienteNome}! üëã\n\nSegue sua proposta comercial:\n${linkPublico}\n\nAguardo sua resposta! üòä`;
            
            // Criar link do WhatsApp
            const whatsappLink = `https://wa.me/${telefoneFormatado}?text=${encodeURIComponent(mensagem)}`;
            
            // Abrir WhatsApp
            window.open(whatsappLink, '_blank');
        }
        
        // Desativar link p√∫blico
        async function desativarLinkPublico() {
            if (!confirm('Tem certeza que deseja desativar o link p√∫blico? O cliente n√£o conseguir√° mais acessar a proposta por este link.')) {
                return;
            }
            
            try {
                const orcamentoId = document.getElementById('orcamentoDetailsModal').dataset.orcamentoId;
                
                const { error } = await supabase
                    .from('orcamentos')
                    .update({
                        acesso_publico: false
                    })
                    .eq('id', orcamentoId);
                
                if (error) throw error;
                
                // Atualizar UI
                document.getElementById('linkPublicoContainer').style.display = 'none';
                document.getElementById('gerarLinkPublicoBtn').style.display = 'inline-block';
                
                // Recarregar or√ßamentos
                await loadOrcamentos();
                
                alert('Link p√∫blico desativado com sucesso!');
            } catch (error) {
                console.error('Erro ao desativar link p√∫blico:', error);
                alert('Erro ao desativar link p√∫blico: ' + (error.message || 'Erro desconhecido'));
            }
        }
        
        // Fun√ß√µes para menu mobile
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        }

        function closeSidebarMobile() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
        }

        // Fechar sidebar ao clicar no overlay
        document.getElementById('sidebarOverlay').addEventListener('click', closeSidebarMobile);

        // Fechar sidebar ao redimensionar para desktop
        window.addEventListener('resize', () => {
            if (window.innerWidth > 768) {
                closeSidebarMobile();
            }
        });

        // ========== CONFIGURA√á√ÉO DA PLATAFORMA ==========
        // Configure aqui o nome e logo da sua plataforma
        
        const PLATAFORMA_CONFIG = {
            nome: 'Vizion Hub',  // Nome da plataforma
            emoji: '',  // Emoji ao lado do nome (deixar vazio para n√£o exibir)
            logoUrl: 'https://zhzhpctsndrcedukivhk.supabase.co/storage/v1/object/public/logo/LOGO%203D%20SEM%20FUNDO%20(1).png',  // Logo na p√°gina de login
            sidebarLogoUrl: 'https://zhzhpctsndrcedukivhk.supabase.co/storage/v1/object/public/logo/Design%20sem%20nome%20(32).png',  // Logo no sidebar
        };

        // Aplicar configura√ß√µes
        function aplicarConfiguracaoPlataforma() {
            // Atualizar nome (com emoji apenas se fornecido)
            const nomeCompleto = PLATAFORMA_CONFIG.emoji ? `${PLATAFORMA_CONFIG.emoji} ${PLATAFORMA_CONFIG.nome}` : PLATAFORMA_CONFIG.nome;
            
            if (PLATAFORMA_CONFIG.nome) {
                // Se tiver logo, ocultar o t√≠tulo no login (s√≥ mostrar logo)
                if (PLATAFORMA_CONFIG.logoUrl) {
                    document.getElementById('loginTitle').style.display = 'none';
                } else {
                    document.getElementById('loginTitle').textContent = nomeCompleto;
                    document.getElementById('loginTitle').style.display = 'block';
                }
                
                document.getElementById('sidebarLogoText').textContent = nomeCompleto;
                document.getElementById('pageTitle').textContent = PLATAFORMA_CONFIG.nome + ' - Empresarial';
            }

            // Aplicar logo na p√°gina de login
            if (PLATAFORMA_CONFIG.logoUrl) {
                const loginLogo = document.getElementById('loginLogo');
                
                if (loginLogo) {
                    loginLogo.src = PLATAFORMA_CONFIG.logoUrl;
                    loginLogo.style.display = 'block';
                    loginLogo.onerror = function() {
                        this.style.display = 'none';
                        console.warn('Erro ao carregar logo do login');
                    };
                }
            }

            // Aplicar logo no sidebar
            if (PLATAFORMA_CONFIG.sidebarLogoUrl) {
                const sidebarLogo = document.getElementById('sidebarLogo');
                const sidebarLogoText = document.getElementById('sidebarLogoText');
                
                if (sidebarLogo) {
                    sidebarLogo.src = PLATAFORMA_CONFIG.sidebarLogoUrl;
                    sidebarLogo.style.display = 'block';
                    sidebarLogo.onerror = function() {
                        this.style.display = 'none';
                        console.warn('Erro ao carregar logo do sidebar');
                    };
                }
                
                // Ocultar o texto quando tiver logo
                if (sidebarLogoText) {
                    sidebarLogoText.style.display = 'none';
                }
            }
        }

        // Verificar se √© acesso p√∫blico (proposta p√∫blica)
        async function verificarAcessoPublico() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('proposta');
            
            if (token) {
                // Buscar or√ßamento por token
                try {
                    // Primeiro buscar or√ßamento sem rela√ß√£o (mais simples)
                    const { data: orcamentoData, error: orcamentoError } = await supabase
                        .from('orcamentos')
                        .select('*')
                        .eq('token_publico', token)
                        .eq('acesso_publico', true)
                        .single();
                    
                    if (orcamentoError) throw orcamentoError;
                    
                    if (orcamentoData) {
                        // Buscar cliente separadamente
                        let cliente = null;
                        if (orcamentoData.cliente_id) {
                            try {
                                const { data: clienteData, error: clienteError } = await supabase
                                    .from('clientes')
                                    .select('*')
                                    .eq('id', orcamentoData.cliente_id)
                                    .single();
                                
                                if (!clienteError && clienteData) {
                                    cliente = clienteData;
                                }
                            } catch (e) {
                                console.warn('Erro ao buscar cliente:', e);
                            }
                        }
                        
                        // Combinar dados
                        const orcamentoCompleto = {
                            ...orcamentoData,
                            cliente: cliente
                        };
                        
                        // Mostrar p√°gina p√∫blica da proposta
                        mostrarPropostaPublica(orcamentoCompleto);
                        return true;
                    }
                } catch (error) {
                    console.error('Erro ao buscar proposta p√∫blica:', error);
                    alert('Link inv√°lido ou expirado. Entre em contato com o vendedor.');
                    window.location.href = window.location.pathname;
                    return false;
                }
            }
            
            return false;
        }
        
        // Mostrar proposta p√∫blica
        function mostrarPropostaPublica(orcamento) {
            console.log('=== DEBUG PROPOSTA P√öBLICA ===');
            console.log('Or√ßamento completo:', JSON.stringify(orcamento, null, 2));
            console.log('Cliente:', orcamento.cliente);
            console.log('Cliente ID:', orcamento.cliente_id);
            console.log('Itens (bruto):', orcamento.itens);
            console.log('Tipo de itens:', typeof orcamento.itens);
            
            // Esconder dashboard e login
            if (document.getElementById('loginPage')) {
                document.getElementById('loginPage').style.display = 'none';
            }
            if (document.getElementById('dashboardPage')) {
                document.getElementById('dashboardPage').style.display = 'none';
            }
            
            // Criar p√°gina p√∫blica se n√£o existir
            let publicPage = document.getElementById('propostaPublicaPage');
            if (!publicPage) {
                publicPage = document.createElement('div');
                publicPage.id = 'propostaPublicaPage';
                publicPage.style.cssText = 'min-height: 100vh; background: #f5f5f5; padding: 40px 20px; font-family: Arial, sans-serif;';
                document.body.appendChild(publicPage);
            }
            
            publicPage.style.display = 'block';
            
            // Buscar itens do or√ßamento (pode vir como string JSON ou array)
            let itens = orcamento.itens || [];
            console.log('Itens brutos:', itens);
            console.log('Tipo de itens:', typeof itens);
            console.log('√â array?', Array.isArray(itens));
            
            // Se for null ou undefined, usar array vazio
            if (!itens) {
                itens = [];
            }
            
            // Se for string, tentar fazer parse
            if (typeof itens === 'string') {
                console.log('Itens √© string, tentando fazer parse...');
                try {
                    const itensTrimmed = itens.trim();
                    if (itensTrimmed.length > 0) {
                        if (itensTrimmed.startsWith('[') || itensTrimmed.startsWith('{')) {
                            itens = JSON.parse(itensTrimmed);
                            console.log('Parse bem-sucedido:', itens);
                        } else {
                            console.warn('String n√£o √© JSON v√°lido:', itensTrimmed.substring(0, 50));
                            itens = [];
                        }
                    } else {
                        console.warn('String vazia');
                        itens = [];
                    }
                } catch (e) {
                    console.error('Erro ao fazer parse dos itens:', e);
                    console.error('String que falhou:', itens.substring(0, 100));
                    itens = [];
                }
            }
            
            // Garantir que √© array
            if (!Array.isArray(itens)) {
                console.log('N√£o √© array, tentando converter...');
                if (itens && typeof itens === 'object') {
                    // Se for objeto √∫nico, transformar em array
                    console.log('Convertendo objeto √∫nico para array');
                    itens = [itens];
                } else {
                    console.warn('N√£o √© objeto v√°lido, usando array vazio');
                    itens = [];
                }
            }
            
            console.log('Itens processados (final):', itens);
            console.log('Quantidade de itens:', itens.length);
            
            // Recalcular subtotais dos itens se necess√°rio
            itens = itens.map(item => {
                const quantidade = parseFloat(item.quantidade) || 1;
                const valorUnitario = parseFloat(item.valor_unitario) || 0;
                const descontoPercent = parseFloat(item.desconto_percent) || 0;
                
                const subtotal = Math.round((quantidade * valorUnitario) * 100) / 100;
                const descontoValor = Math.round((subtotal * (descontoPercent / 100)) * 100) / 100;
                const subtotalFinal = Math.round((subtotal - descontoValor) * 100) / 100;
                
                return {
                    ...item,
                    quantidade: quantidade,
                    valor_unitario: valorUnitario,
                    desconto_percent: descontoPercent,
                    subtotal: item.subtotal || subtotalFinal
                };
            });
            
            // Calcular total se n√£o existir
            let total = parseFloat(orcamento.valor) || 0;
            if (total === 0 && itens.length > 0) {
                total = itens.reduce((sum, item) => sum + (parseFloat(item.subtotal) || 0), 0);
                total = Math.round(total * 100) / 100;
            }
            
            // Formatar moeda
            const formatCurrency = (value) => {
                if (!value && value !== 0) return 'R$ 0,00';
                const num = parseFloat(value) || 0;
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(num);
            };
            
            // Formatar data
            const formatDate = (dateStr) => {
                if (!dateStr) return '-';
                try {
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('pt-BR');
                } catch {
                    return dateStr;
                }
            };
            
            // Extrair dados do cliente (pode vir como objeto ou aninhado)
            let cliente = orcamento.cliente || null;
            
            // Se cliente n√£o vier na rela√ß√£o, tentar buscar pelo cliente_id
            if (!cliente && orcamento.cliente_id) {
                // Cliente j√° foi buscado na fun√ß√£o verificarAcessoPublico
                // Mas vamos garantir que temos os dados
                cliente = orcamento.cliente || {};
            }
            
            if (typeof cliente === 'string') {
                try {
                    cliente = JSON.parse(cliente);
                } catch (e) {
                    cliente = {};
                }
            }
            
            // Garantir que cliente √© um objeto
            if (!cliente || typeof cliente !== 'object') {
                cliente = {};
            }
            
            console.log('Cliente processado:', cliente);
            console.log('Cliente ID no or√ßamento:', orcamento.cliente_id);
            console.log('Cliente tem nome?', !!cliente.nome);
            console.log('Cliente tem empresa?', !!cliente.empresa);
            
            const clienteNome = cliente.nome || cliente.empresa || (orcamento.cliente_id ? 'Cliente ID: ' + orcamento.cliente_id : 'Cliente n√£o informado');
            const clienteEmail = cliente.email || '';
            const clienteTelefone = cliente.telefone || cliente.whatsapp || '';
            const clienteCpfCnpj = cliente.cpf_cnpj || '';
            const clienteEndereco = cliente.endereco || '';
            const clienteCidade = cliente.cidade || '';
            const clienteEstado = cliente.estado || '';
            
            console.log('Dados do cliente para exibi√ß√£o:');
            console.log('- Nome:', clienteNome);
            console.log('- Email:', clienteEmail);
            console.log('- Telefone:', clienteTelefone);
            
            // Extrair observa√ß√µes (remover condi√ß√µes comerciais se existir)
            let observacoes = orcamento.observacoes || '';
            if (observacoes.includes('=== CONDI√á√ïES COMERCIAIS ===')) {
                const partes = observacoes.split('=== CONDI√á√ïES COMERCIAIS ===');
                observacoes = partes[0].trim();
            }
            
            // Renderizar proposta
            publicPage.innerHTML = `
                <div style="max-width: 800px; margin: 0 auto; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <div style="text-align: right; margin-bottom: 20px; color: #666; font-size: 14px;">
                        N¬∞ ${String(orcamento.numero || 'N/A').padStart(4, '0')} - ${formatDate(orcamento.data)}
                    </div>
                    
                    <div style="text-align: center; margin-bottom: 40px;">
                        <h1 style="color: #FF6600; font-size: 28px; margin-bottom: 10px; font-weight: bold;">PROPOSTA COMERCIAL</h1>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <div style="background: #FF6600; color: white; padding: 10px; font-weight: bold; font-size: 16px; margin-bottom: 15px;">
                            Dados do Cliente
                        </div>
                        <div style="padding: 15px 10px; background: #fafafa; border-radius: 4px;">
                            ${clienteNome && clienteNome !== 'Cliente n√£o informado' ? `<p style="margin: 8px 0; color: #333;"><strong>Cliente:</strong> ${clienteNome.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>` : '<p style="margin: 8px 0; color: #999; font-style: italic;">Cliente n√£o informado</p>'}
                            ${clienteEmail ? `<p style="margin: 8px 0; color: #333;"><strong>Email:</strong> ${clienteEmail.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>` : ''}
                            ${clienteTelefone ? `<p style="margin: 8px 0; color: #333;"><strong>Telefone:</strong> ${clienteTelefone.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>` : ''}
                            ${clienteCpfCnpj ? `<p style="margin: 8px 0; color: #333;"><strong>CPF/CNPJ:</strong> ${clienteCpfCnpj.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>` : ''}
                            ${clienteEndereco ? `<p style="margin: 8px 0; color: #333;"><strong>Endere√ßo:</strong> ${clienteEndereco.replace(/</g, '&lt;').replace(/>/g, '&gt;')}${clienteCidade ? ', ' + clienteCidade.replace(/</g, '&lt;').replace(/>/g, '&gt;') : ''}${clienteEstado ? ' - ' + clienteEstado.replace(/</g, '&lt;').replace(/>/g, '&gt;') : ''}</p>` : ''}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <div style="background: #FF6600; color: white; padding: 10px; font-weight: bold; font-size: 16px; margin-bottom: 15px;">
                            Itens do Or√ßamento
                        </div>
                        ${itens.length > 0 ? `
                            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; background: white;">
                                <thead>
                                    <tr style="background: #FF6600; color: white;">
                                        <th style="padding: 12px; text-align: left; font-weight: bold; border: none;">Descri√ß√£o</th>
                                        <th style="padding: 12px; text-align: center; font-weight: bold; border: none; width: 80px;">Qtd</th>
                                        <th style="padding: 12px; text-align: right; font-weight: bold; border: none; width: 120px;">Valor Unit.</th>
                                        <th style="padding: 12px; text-align: right; font-weight: bold; border: none; width: 120px;">Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${itens.map((item, index) => `
                                        <tr style="border-bottom: 1px solid #e5e5e5; ${index % 2 === 0 ? 'background: #fafafa;' : 'background: white;'}">
                                            <td style="padding: 12px; color: #333;">${(item.descricao || '-').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</td>
                                            <td style="padding: 12px; text-align: center; color: #333;">${item.quantidade || 1}</td>
                                            <td style="padding: 12px; text-align: right; color: #333;">${formatCurrency(item.valor_unitario || 0)}</td>
                                            <td style="padding: 12px; text-align: right; color: #333; font-weight: 600;">${formatCurrency(item.subtotal || 0)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                                <tfoot>
                                    <tr style="background: #f5f5f5; font-weight: bold; border-top: 2px solid #FF6600;">
                                        <td colspan="3" style="padding: 15px; text-align: right; font-size: 16px; color: #333;">Total:</td>
                                        <td style="padding: 15px; text-align: right; color: #FF6600; font-size: 20px; font-weight: bold;">${formatCurrency(total)}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        ` : `
                            <div style="padding: 40px; text-align: center; background: #fafafa; border-radius: 4px; border: 1px dashed #ddd;">
                                <p style="color: #999; font-style: italic; margin: 0;">Nenhum item adicionado ao or√ßamento.</p>
                            </div>
                        `}
                    </div>
                    
                    ${observacoes ? `
                        <div style="margin-bottom: 30px;">
                            <div style="background: #FF6600; color: white; padding: 10px; font-weight: bold; font-size: 16px; margin-bottom: 15px;">
                                Observa√ß√µes
                            </div>
                            <div style="padding: 0 10px;">
                                <p style="white-space: pre-wrap; line-height: 1.6;">${observacoes.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #FF6600; text-align: center;">
                        <button onclick="gerarPDFOrcamentoPublico('${orcamento.id}')" style="background: #FF6600; color: white; border: none; padding: 12px 24px; border-radius: 4px; font-size: 16px; cursor: pointer; margin-right: 10px; font-weight: bold;">
                            üìÑ Baixar PDF
                        </button>
                        ${!orcamento.assinado ? `
                            <button onclick="abrirAssinatura('${orcamento.id}')" style="background: #10B981; color: white; border: none; padding: 12px 24px; border-radius: 4px; font-size: 16px; cursor: pointer; font-weight: bold;">
                                ‚úçÔ∏è Assinar Proposta
                            </button>
                        ` : `
                            <div style="margin-top: 20px; padding: 15px; background: #d4edda; border-radius: 4px; color: #155724; font-weight: bold;">
                                ‚úÖ Proposta assinada em ${formatDate(orcamento.data_assinatura || orcamento.updated_at)}
                            </div>
                        `}
                    </div>
                </div>
            `;
        }
        
        // Gerar PDF da proposta p√∫blica
        async function gerarPDFOrcamentoPublico(orcamentoId) {
            try {
                // Buscar or√ßamento completo
                const { data: orcamentoData, error: orcamentoError } = await supabase
                    .from('orcamentos')
                    .select('*')
                    .eq('id', orcamentoId)
                    .single();
                
                if (orcamentoError) throw orcamentoError;
                if (!orcamentoData) {
                    alert('Or√ßamento n√£o encontrado');
                    return;
                }
                
                // Buscar cliente separadamente
                let clienteCompleto = {};
                if (orcamentoData.cliente_id) {
                    try {
                        const { data: clienteData, error: clienteError } = await supabase
                            .from('clientes')
                            .select('*')
                            .eq('id', orcamentoData.cliente_id)
                            .single();
                        
                        if (!clienteError && clienteData) {
                            clienteCompleto = clienteData;
                        }
                    } catch (e) {
                        console.warn('Erro ao buscar cliente para PDF:', e);
                    }
                }
                
                // Combinar dados
                const orcamento = {
                    ...orcamentoData,
                    cliente: clienteCompleto
                };
                
                // Chamar fun√ß√£o de gerar PDF com or√ßamento
                await gerarPDFOrcamentoDireto(orcamento);
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                alert('Erro ao gerar PDF: ' + (error.message || 'Erro desconhecido'));
            }
        }
        
        // Gerar PDF diretamente a partir de um or√ßamento (sem depender do modal)
        async function gerarPDFOrcamentoDireto(orcamento) {
            try {
                // Verificar se jsPDF est√° dispon√≠vel
                if (!window.jspdf) {
                    alert('Biblioteca de PDF n√£o carregada. Por favor, recarregue a p√°gina.');
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Fun√ß√£o auxiliar para formatar moeda no PDF
                const formatCurrencyPDF = (value) => {
                    if (!value && value !== 0) return 'R$ 0,00';
                    return new Intl.NumberFormat('pt-BR', {
                        style: 'currency',
                        currency: 'BRL'
                    }).format(value);
                };

                // Fun√ß√£o auxiliar para formatar data no PDF
                const formatDatePDF = (dateStr) => {
                    if (!dateStr) return '-';
                    try {
                        const date = new Date(dateStr);
                        return date.toLocaleDateString('pt-BR');
                    } catch {
                        return dateStr;
                    }
                };

                // Configura√ß√µes
                const margin = 20;
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                let y = margin;

                // ========== CABE√áALHO - DADOS DA EMPRESA ==========
                let logoLoaded = false;
                
                // Tentar adicionar logo
                try {
                    const logoUrl = 'https://zhzhpctsndrcedukivhk.supabase.co/storage/v1/object/public/logo/LOGO%203D%20SEM%20FUNDO%20(1).png';
                    
                    // Usar fetch para obter a imagem como base64
                    const response = await fetch(logoUrl);
                    if (response.ok) {
                        const blob = await response.blob();
                        const reader = new FileReader();
                        
                        await new Promise((resolve, reject) => {
                            reader.onload = () => resolve(reader.result);
                            reader.onerror = reject;
                            reader.readAsDataURL(blob);
                        });
                        
                        const logoData = reader.result;
                        // Adicionar logo (ajustar tamanho conforme necess√°rio)
                        doc.addImage(logoData, 'PNG', margin, 5, 60, 25);
                        logoLoaded = true;
                    }
                } catch (e) {
                    console.warn('Erro ao carregar logo:', e);
                }
                
                // Se logo n√£o carregou, usar texto
                if (!logoLoaded) {
                    doc.setFillColor(255, 102, 0);
                    doc.rect(0, 0, pageWidth, 50, 'F');
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(28);
                    doc.setFont(undefined, 'bold');
                    doc.text('AUTOVIZION', margin, 30);
                    
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'normal');
                    doc.text('Solu√ß√µes em Marketing Digital e Tecnologia', margin, 38);
                }
                
                // Dados da empresa no cabe√ßalho (lado direito) - Melhor formatado
                const dadosX = pageWidth - margin - 60;
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('AUTOVIZION', dadosX, 12);
                
                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(60, 60, 60);
                doc.text('www.autovizon.com.br', dadosX, 20);
                doc.text('autovizioncomercial@gmail.com', dadosX, 26);
                doc.text('(14) 99600-5936', dadosX, 32);
                
                // Linha divis√≥ria abaixo do cabe√ßalho
                doc.setDrawColor(200, 200, 200);
                doc.line(margin, 35, pageWidth - margin, 35);
                
                y = 45;

                // ========== T√çTULO DO DOCUMENTO ==========
                // Fundo colorido para o t√≠tulo
                doc.setFillColor(255, 102, 0);
                doc.rect(margin, y - 5, pageWidth - (margin * 2), 20, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(22);
                doc.setFont(undefined, 'bold');
                doc.text('PROPOSTA COMERCIAL', margin + 5, y + 8);
                
                // N√∫mero e data √† direita (sobre o fundo)
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`N¬∫ ${orcamento.numero || 'N/A'}`, pageWidth - margin - 30, y + 2);
                doc.text(`Data: ${formatDatePDF(orcamento.data)}`, pageWidth - margin - 30, y + 9);
                
                y += 20;

                // ========== DADOS DO CLIENTE ==========
                // Definir vari√°veis do cliente primeiro
                const clienteNome = orcamento.cliente?.nome || orcamento.cliente?.empresa || 'Cliente n√£o encontrado';
                const clienteEmpresa = orcamento.cliente?.empresa || '';
                const clienteCpfCnpj = orcamento.cliente?.cpf_cnpj || '';
                const clienteEndereco = orcamento.cliente?.endereco || '';
                const clienteCidade = orcamento.cliente?.cidade || '';
                const clienteEstado = orcamento.cliente?.estado || '';
                const clienteCep = orcamento.cliente?.cep || '';
                const clienteTelefone = orcamento.cliente?.telefone || '';
                const clienteEmail = orcamento.cliente?.email || '';

                // ========== INTRODU√á√ÉO ==========
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(60, 60, 60);
                const introText = `Prezado(a) ${clienteNome},`;
                doc.text(introText, margin, y);
                y += 8;
                
                const apresentacao = `√â com grande entusiasmo que finalizamos a an√°lise de suas necessidades e desenvolvemos uma proposta comercial estrat√©gica. Nosso foco √© apresentar solu√ß√µes concretas que impulsionar√£o seus resultados e atender√£o, com excel√™ncia, aos seus objetivos espec√≠ficos.`;
                const apresentacaoLines = doc.splitTextToSize(apresentacao, pageWidth - (margin * 2));
                doc.text(apresentacaoLines, margin, y);
                y += apresentacaoLines.length * 5 + 10;

                // ========== DADOS DO CLIENTE ==========
                // Fundo com cor laranja suave
                doc.setFillColor(255, 102, 0);
                doc.rect(margin, y, pageWidth - (margin * 2), 8, 'F');
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('DADOS DO CLIENTE', margin + 3, y + 6);
                y += 12;
                
                doc.setTextColor(0, 0, 0);
                
                doc.text(`Cliente: ${clienteNome}`, margin, y);
                y += 6;
                if (clienteEmpresa && clienteEmpresa !== clienteNome) {
                    doc.text(`Empresa: ${clienteEmpresa}`, margin, y);
                    y += 6;
                }
                if (clienteCpfCnpj) {
                    doc.text(`CPF/CNPJ: ${clienteCpfCnpj}`, margin, y);
                    y += 6;
                }
                if (clienteEndereco) {
                    let enderecoCompleto = clienteEndereco;
                    if (clienteCidade) enderecoCompleto += `, ${clienteCidade}`;
                    if (clienteEstado) enderecoCompleto += ` - ${clienteEstado}`;
                    if (clienteCep) enderecoCompleto += ` - CEP: ${clienteCep}`;
                    doc.text(`Endere√ßo: ${enderecoCompleto}`, margin, y);
                    y += 6;
                }
                if (clienteTelefone) {
                    doc.text(`Telefone: ${clienteTelefone}`, margin, y);
                    y += 6;
                }
                if (clienteEmail) {
                    doc.text(`E-mail: ${clienteEmail}`, margin, y);
                    y += 6;
                }
                
                y += 10;

                // ========== ITENS DO OR√áAMENTO ==========
                // Fundo com cor laranja suave
                doc.setFillColor(255, 102, 0);
                doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('ITENS DO OR√áAMENTO', margin + 3, y + 4);
                y += 12;
                
                doc.setTextColor(0, 0, 0);

                // Fazer parse dos itens se necess√°rio
                let itens = orcamento.itens || [];
                if (typeof itens === 'string') {
                    try {
                        itens = JSON.parse(itens);
                    } catch (e) {
                        console.error('Erro ao fazer parse dos itens no PDF:', e);
                        itens = [];
                    }
                }
                if (!Array.isArray(itens)) {
                    itens = [];
                }
                
                if (itens.length > 0) {
                    // Definir posi√ß√µes das colunas de forma clara
                    const colDescricao = margin + 2;
                    const colQtd = margin + 65;
                    const colValorUnit = margin + 85;
                    const colDesconto = margin + 120;
                    
                    // Cabe√ßalho da tabela com cor destacada
                    doc.setFillColor(45, 45, 45);
                    doc.rect(margin, y - 5, pageWidth - (margin * 2), 8, 'F');
                    
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(255, 255, 255);
                    doc.text('Descri√ß√£o', colDescricao, y);
                    doc.text('Qtd', colQtd, y);
                    doc.text('Valor Unit.', colValorUnit, y);
                    doc.text('Desconto', colDesconto, y);
                    y += 8;

                    let subtotal = 0;
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(9);
                    
                    itens.forEach((item, index) => {
                        // Verificar se precisa de nova p√°gina (deixar espa√ßo para pelo menos 3 linhas + totais)
                        if (y > pageHeight - 80) {
                            doc.addPage();
                            y = margin + 10;
                        }
                        
                        // Linha alternada (opcional)
                        if (index % 2 === 0) {
                            doc.setFillColor(250, 250, 250);
                            doc.rect(margin, y - 3, pageWidth - (margin * 2), 6, 'F');
                        }
                        
                        // Acessar campos com fallback para diferentes nomes
                        const descricao = item.descricao || item.desc || '-';
                        const quantidade = parseFloat(item.quantidade || item.qtd || 0);
                        const valorUnitario = parseFloat(item.valor_unitario || item.valorUnitario || item.valor_unit || 0);
                        const descontoPercent = parseFloat(item.desconto_percent || item.descontoPercent || item.desconto || 0);
                        
                        // Recalcular subtotal do item - COM PRECIS√ÉO
                        const itemSubtotal = Math.round((quantidade * valorUnitario) * 100) / 100;
                        const descontoValor = Math.round((itemSubtotal * (descontoPercent / 100)) * 100) / 100;
                        const subtotalItem = Math.round((itemSubtotal - descontoValor) * 100) / 100;
                        subtotal = Math.round((subtotal + subtotalItem) * 100) / 100;
                        
                        // Descri√ß√£o (pode quebrar linha se muito longa)
                        const descLines = doc.splitTextToSize(descricao, 60);
                        const firstLineY = y;
                        doc.setTextColor(0, 0, 0);
                        doc.text(descLines, colDescricao, firstLineY);
                        
                        // Quantidade
                        doc.text(quantidade.toString(), colQtd, firstLineY);
                        
                        // Valor unit√°rio
                        doc.text(formatCurrencyPDF(valorUnitario), colValorUnit, firstLineY);
                        
                        // Desconto
                        doc.text(descontoPercent + '%', colDesconto, firstLineY);
                        
                        y += Math.max(6, descLines.length * 6);
                    });

                    y += 5;
                    doc.setDrawColor(200, 200, 200);
                    doc.line(margin, y, pageWidth - margin, y);
                    y += 10;

                    // ========== TOTAIS ==========
                    // Verificar se h√° espa√ßo para os totais (subtotal + desconto + total + linha = ~30px)
                    if (y > pageHeight - 50) {
                        doc.addPage();
                        y = margin + 10;
                    }
                    
                    const descontoGeral = parseFloat(orcamento.desconto_geral || 0);
                    // Calcular total corretamente - COM PRECIS√ÉO
                    const descontoGeralArredondado = Math.round(descontoGeral * 100) / 100;
                    const subtotalArredondado = Math.round(subtotal * 100) / 100;
                    const total = Math.round((subtotalArredondado - descontoGeralArredondado) * 100) / 100;
                    
                    // Subtotal e Total - mesma linha, mesmo estilo, apenas linha de separa√ß√£o
                    // Alinhar mais √† esquerda para seguir o alinhamento geral da p√°gina
                    const labelX = margin + 10; // Posi√ß√£o do label (alinhado √† esquerda, seguindo o alinhamento geral)
                    const valueX = labelX + 100; // Posi√ß√£o do valor (espa√ßamento fixo ap√≥s o label, mais √† esquerda)
                    
                    // Subtotal - texto preto, tamanho normal
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(0, 0, 0);
                    doc.text('Subtotal:', labelX, y);
                    doc.text(formatCurrencyPDF(subtotal), valueX, y);
                    y += 7;

                    if (descontoGeral > 0) {
                        doc.setTextColor(200, 0, 0);
                        doc.text('Desconto Geral:', labelX, y);
                        doc.text(formatCurrencyPDF(descontoGeral), valueX, y);
                        y += 7;
                    }

                    // Linha laranja para separar (apenas uma listra)
                    doc.setDrawColor(255, 102, 0);
                    doc.setLineWidth(1);
                    doc.line(labelX - 10, y, valueX + 50, y);
                    y += 8;

                    // TOTAL - mesmo estilo do subtotal, seguindo as mesmas linhas
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold'); // Negrito para destacar
                    doc.setTextColor(0, 0, 0); // Texto preto, igual ao subtotal
                    doc.text('TOTAL:', labelX, y);
                    // Valor tamb√©m preto, negrito - alinhado √† esquerda, mesmo estilo do subtotal
                    const totalText = formatCurrencyPDF(total);
                    doc.text(totalText, valueX, y);
                    y += 15;
                } else {
                    doc.setFontSize(10);
                    doc.setTextColor(128, 128, 128);
                    doc.text('Nenhum item cadastrado', margin, y);
                    y += 10;
                }
                
                y += 10;

                // ========== CONDI√á√ïES COMERCIAIS ==========
                const observacoes = orcamento.observacoes || '';
                let condicoesPagamento = '';
                let formaPagamento = '';
                let prazoEntrega = '';
                
                if (observacoes.includes('=== CONDI√á√ïES COMERCIAIS ===')) {
                    const partes = observacoes.split('=== CONDI√á√ïES COMERCIAIS ===');
                    const condicoesTexto = partes[1] || '';
                    
                    const matchCondicoes = condicoesTexto.match(/Condi√ß√µes de Pagamento:\s*(.+?)(?:\n|$)/i);
                    if (matchCondicoes) condicoesPagamento = matchCondicoes[1].trim();
                    
                    const matchForma = condicoesTexto.match(/Forma de Pagamento:\s*(.+?)(?:\n|$)/i);
                    if (matchForma) formaPagamento = matchForma[1].trim();
                    
                    const matchPrazo = condicoesTexto.match(/Prazo de Entrega:\s*(.+?)(?:\n|$)/i);
                    if (matchPrazo) prazoEntrega = matchPrazo[1].trim();
                }
                
                if (condicoesPagamento || formaPagamento || prazoEntrega) {
                    // Verificar se precisa de nova p√°gina
                    if (y > pageHeight - 60) {
                        doc.addPage();
                        y = margin + 10;
                    }
                    
                    doc.setFillColor(255, 102, 0);
                    doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                    
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(255, 255, 255);
                    doc.text('CONDI√á√ïES COMERCIAIS', margin + 3, y + 4);
                    y += 12;
                    
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(9);
                    doc.setTextColor(0, 0, 0);
                    
                    if (condicoesPagamento) {
                        doc.text(`Condi√ß√µes de Pagamento: ${condicoesPagamento}`, margin, y);
                        y += 6;
                    }
                    if (formaPagamento) {
                        doc.text(`Forma de Pagamento: ${formaPagamento}`, margin, y);
                        y += 6;
                    }
                    if (prazoEntrega) {
                        doc.text(`Prazo de Entrega: ${prazoEntrega}`, margin, y);
                        y += 6;
                    }
                    
                    y += 5;
                }
                
                // ========== OBSERVA√á√ïES ==========
                let observacoesParaPDF = observacoes;
                if (observacoesParaPDF.includes('=== CONDI√á√ïES COMERCIAIS ===')) {
                    const partes = observacoesParaPDF.split('=== CONDI√á√ïES COMERCIAIS ===');
                    observacoesParaPDF = partes[0].trim();
                }
                
                if (observacoesParaPDF) {
                    // Verificar se precisa de nova p√°gina
                    if (y > pageHeight - 40) {
                        doc.addPage();
                        y = margin + 10;
                    }
                    
                    doc.setFillColor(255, 102, 0);
                    doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                    
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(255, 255, 255);
                    doc.text('OBSERVA√á√ïES', margin + 3, y + 4);
                    y += 12;
                    
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(9);
                    doc.setTextColor(60, 60, 60);
                    const observacoesLines = doc.splitTextToSize(observacoesParaPDF, pageWidth - (margin * 2));
                    doc.text(observacoesLines, margin, y);
                    y += observacoesLines.length * 4 + 5;
                }
                
                // ========== TERMOS E CONDI√á√ïES ==========
                // Verificar se precisa de nova p√°gina
                if (y > pageHeight - 50) {
                    doc.addPage();
                    y = margin + 10;
                }
                
                doc.setFillColor(255, 102, 0);
                doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('TERMOS E CONDI√á√ïES', margin + 3, y + 4);
                y += 12;
                
                doc.setFont(undefined, 'normal');
                doc.setFontSize(8);
                doc.setTextColor(60, 60, 60);
                
                const validadeDias = orcamento.validade_dias || 30;
                const termosRodape = [
                    `1. Esta proposta tem validade de ${validadeDias} dias corridos a partir da data de emiss√£o.`,
                    '2. A contrata√ß√£o dos servi√ßos est√° sujeita √† assinatura de contrato espec√≠fico.',
                    '3. Os valores podem sofrer altera√ß√µes mediante altera√ß√£o de escopo.',
                    '4. Para mais informa√ß√µes, entre em contato conosco atrav√©s dos canais indicados.'
                ];
                
                termosRodape.forEach(termo => {
                    // Verificar se precisa de nova p√°gina para os termos
                    if (y > pageHeight - 15) {
                        doc.addPage();
                        y = margin + 10;
                    }
                    const termoLines = doc.splitTextToSize(termo, pageWidth - (margin * 2));
                    doc.text(termoLines, margin, y);
                    y += termoLines.length * 4 + 2;
                });
                
                // Informa√ß√µes de contato no rodap√© - Sempre na √∫ltima linha da p√°gina
                const contatoY = pageHeight - 8;
                doc.setFontSize(7);
                doc.setTextColor(128, 128, 128);
                doc.setFont(undefined, 'normal');
                doc.text('AUTOVIZION', margin, contatoY);
                doc.text('|', margin + 25, contatoY);
                doc.text('www.autovizon.com.br', margin + 30, contatoY);
                doc.text('|', margin + 70, contatoY);
                doc.text('autovizioncomercial@gmail.com', margin + 75, contatoY);
                doc.text('|', margin + 130, contatoY);
                doc.text('(14) 99600-5936', margin + 135, contatoY);
                
                // Salvar PDF
                const fileName = `Proposta_${orcamento.numero || 'N'}_${clienteNome.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                alert('Erro ao gerar PDF: ' + (error.message || 'Erro desconhecido'));
            }
        }
        
        // Abrir modal de assinatura
        function abrirAssinatura(orcamentoId) {
            alert('Funcionalidade de assinatura ser√° implementada em breve. Por enquanto, voc√™ pode baixar o PDF e assinar manualmente.');
        }
        
        // Verificar autentica√ß√£o ao carregar
        aplicarConfiguracaoPlataforma();
        
        // Verificar se √© acesso p√∫blico primeiro
        verificarAcessoPublico().then(isPublic => {
            if (!isPublic) {
                // Se n√£o for acesso p√∫blico, verificar autentica√ß√£o normal
                checkAuth();
            }
        });
    </script>
</body>
</html>

