<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title id="pageTitle">Sistema de Gestão Empresarial</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #FF6600;
            --secondary: #1a1a1a;
            --tertiary: #2d2d2d;
            --text: #FFFFFF;
            --text-gray: #AFAFAF;
            --success: #10b981;
            --warning: #fbbf24;
            --danger: #ef4444;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: #000000;
            color: var(--text);
            min-height: 100vh;
        }

        /* Login Page */
        .login-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .login-box {
            background: var(--secondary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 40px;
            width: 100%;
            max-width: 400px;
        }

        .login-title {
            text-align: center;
            color: var(--primary);
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .login-subtitle {
            text-align: center;
            color: var(--text-gray);
            margin-bottom: 32px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            color: var(--text-gray);
            font-size: 14px;
            font-weight: 500;
            margin-bottom: 8px;
        }

        .form-input {
            width: 100%;
            background: var(--tertiary);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px 16px;
            color: var(--text);
            font-size: 16px;
            transition: all 0.3s;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.4);
        }

        .btn {
            width: 100%;
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-primary {
            background: var(--primary);
            color: white;
        }

        .btn-primary:hover {
            background: rgba(255, 102, 0, 0.8);
        }

        .btn-primary:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .error-message {
            background: rgba(239, 68, 68, 0.1);
            border: 1px solid var(--danger);
            color: var(--danger);
            padding: 12px;
            border-radius: 8px;
            margin-bottom: 20px;
            display: none;
        }

        .error-message.show {
            display: block;
        }

        /* Dashboard */
        .dashboard-container {
            display: none;
            min-height: 100vh;
        }

        .dashboard-container.active {
            display: block;
        }

        .sidebar {
            position: fixed;
            left: 0;
            top: 0;
            width: 260px;
            height: 100vh;
            background: var(--secondary);
            border-right: 1px solid rgba(255, 255, 255, 0.1);
            padding: 24px;
            overflow-y: auto;
            z-index: 1000;
            transition: transform 0.3s ease;
        }

        .sidebar-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
        }

        .sidebar-overlay.active {
            display: block;
        }

        .menu-toggle {
            display: none;
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text);
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 20px;
            margin-right: 16px;
        }

        .sidebar-logo {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 12px;
            margin-bottom: 32px;
            padding-bottom: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            width: 100%;
        }

        .logo-image {
            max-width: 100%;
            max-height: 120px;
            width: auto;
            height: auto;
            object-fit: contain;
            display: block;
        }

        /* Logo no mobile - maior */
        @media (max-width: 768px) {
            .sidebar .logo-image {
                max-height: 180px !important;
                min-height: 140px !important;
                width: auto !important;
                height: auto !important;
                object-fit: contain !important;
            }

            .sidebar-logo {
                margin-bottom: 24px;
                padding-bottom: 20px;
                min-height: 160px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .login-logo-container {
                min-height: 200px;
                display: flex;
                align-items: center;
                justify-content: center;
            }

            .login-logo {
                max-width: 85% !important;
                max-height: 200px !important;
                min-height: 160px !important;
                width: auto !important;
                height: auto !important;
                object-fit: contain !important;
            }
        }

        .logo-text {
            color: var(--primary);
            font-size: 24px;
            font-weight: 700;
        }

        .sidebar-logo:has(.logo-image) .logo-text {
            font-size: 20px;
        }

        /* Quando só tem logo (sem texto), centralizar */
        .sidebar-logo:has(.logo-image:not([style*="display: none"])):has(.logo-text[style*="display: none"]) {
            justify-content: center;
        }

        .login-logo-container {
            text-align: center;
            margin-bottom: 24px;
            display: flex;
            justify-content: center;
            align-items: center;
            width: 100%;
        }

        .login-logo {
            max-width: 280px;
            max-height: 160px;
            width: auto;
            height: auto;
            object-fit: contain;
            margin-bottom: 16px;
            display: block;
            margin-left: auto;
            margin-right: auto;
        }

        .menu-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            color: var(--text-gray);
            text-decoration: none;
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .menu-item:hover {
            background: rgba(255, 255, 255, 0.05);
            color: var(--text);
        }

        .menu-item.active {
            background: rgba(255, 102, 0, 0.2);
            color: var(--primary);
            border: 1px solid rgba(255, 102, 0, 0.3);
        }

        .main-content {
            margin-left: 260px;
            padding: 24px;
        }

        .header {
            background: var(--secondary);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            padding: 16px 24px;
            margin: -24px -24px 24px -24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 12px;
        }

        .header-title {
            font-size: 20px;
            font-weight: 600;
        }

        .header-user {
            display: flex;
            align-items: center;
            gap: 16px;
            flex-wrap: wrap;
        }

        .user-info {
            text-align: right;
        }

        .user-name {
            font-size: 14px;
            font-weight: 500;
        }

        .user-email {
            font-size: 12px;
            color: var(--text-gray);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: var(--primary);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }

        .btn-logout {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text);
            padding: 8px 16px;
            font-size: 14px;
        }

        .btn-logout:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Cards */
        .page-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 8px;
        }

        .page-subtitle {
            color: var(--text-gray);
            margin-bottom: 24px;
        }

        .cards-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 24px;
            margin-bottom: 24px;
        }

        .card {
            background: var(--secondary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 24px;
            transition: all 0.3s;
        }

        .card:hover {
            border-color: rgba(255, 102, 0, 0.5);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 16px;
        }

        .card-title {
            font-size: 14px;
            color: var(--text-gray);
            margin-bottom: 8px;
        }

        .card-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text);
        }

        .card-icon {
            width: 48px;
            height: 48px;
            background: rgba(255, 102, 0, 0.2);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--primary);
            font-size: 24px;
        }

        .card-footer {
            font-size: 12px;
            color: var(--text-gray);
        }

        .template-card:hover {
            border-color: var(--primary) !important;
            background: rgba(255, 102, 0, 0.1) !important;
            transform: translateY(-2px);
        }

        .section-card {
            background: var(--secondary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
        }

        .section-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 16px;
        }

        .empty-state {
            text-align: center;
            padding: 40px;
            color: var(--text-gray);
        }

        /* Table */
        .table-container {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        th {
            color: var(--text-gray);
            font-weight: 600;
            font-size: 14px;
        }

        td {
            color: var(--text);
        }

        tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-ativo {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .badge-inativo {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .badge-planejamento {
            background: rgba(147, 197, 253, 0.2);
            color: #60a5fa;
        }

        .badge-em-andamento {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .badge-pausado {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .badge-concluido {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .badge-cancelado {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        /* Badges de Status de Orçamento */
        .badge-rascunho {
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
        }

        .badge-enviado {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .badge-aprovado {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .badge-rejeitado {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .badge-expirado {
            background: rgba(107, 114, 128, 0.2);
            color: #6b7280;
        }

        /* Badges de Prioridade */
        .badge-prioridade-baixa {
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
        }

        .badge-prioridade-media {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .badge-prioridade-alta {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
        }

        .badge-prioridade-urgente {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        /* Kanban Board */
        .kanban-board {
            display: flex;
            gap: 16px;
            overflow-x: auto;
            padding: 16px 0;
            min-height: 500px;
        }

        .kanban-column {
            min-width: 280px;
            max-width: 280px;
            background: var(--tertiary);
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            flex-direction: column;
            max-height: calc(100vh - 300px);
        }

        .kanban-column-header {
            padding: 16px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .kanban-column-header h3 {
            margin: 0;
            font-size: 14px;
            font-weight: 600;
            color: var(--text);
        }

        .kanban-count {
            background: var(--primary);
            color: white;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .kanban-column-body {
            flex: 1;
            overflow-y: auto;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .kanban-card {
            background: var(--secondary);
            border-radius: 8px;
            padding: 12px;
            border: 1px solid rgba(255, 255, 255, 0.1);
            cursor: grab;
            transition: all 0.2s;
            user-select: none;
        }

        .kanban-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            border-color: var(--primary);
        }

        .kanban-card.dragging {
            opacity: 0.5;
            cursor: grabbing;
            transform: rotate(5deg);
        }

        .kanban-column-body.drag-over {
            background: rgba(255, 102, 0, 0.1);
            border: 2px dashed var(--primary);
        }

        .kanban-card-title {
            font-weight: 600;
            font-size: 14px;
            color: var(--text);
            margin-bottom: 8px;
        }

        .kanban-card-client {
            font-size: 12px;
            color: var(--text-gray);
            margin-bottom: 8px;
        }

        .kanban-card-info {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-gray);
            margin-bottom: 8px;
        }

        .kanban-card-value {
            font-weight: 600;
            color: var(--primary);
            font-size: 13px;
        }

        .kanban-card-actions {
            margin-top: 8px;
            display: flex;
            gap: 8px;
        }

        .kanban-card-actions button {
            flex: 1;
            padding: 6px;
            font-size: 11px;
        }

        @media (max-width: 768px) {
            .kanban-board {
                flex-direction: column;
            }
            .kanban-column {
                min-width: 100%;
                max-width: 100%;
            }
        }

        /* Timeline/Gantt */
        .timeline-container {
            position: relative;
            padding: 20px 0;
        }

        .timeline-header {
            display: flex;
            gap: 8px;
            margin-bottom: 20px;
            padding: 0 20px;
        }

        .timeline-month {
            flex: 1;
            text-align: center;
            font-weight: 600;
            color: var(--text);
            padding: 8px;
            background: var(--secondary);
            border-radius: 6px;
        }

        .timeline-project {
            margin: 12px 0;
            padding: 12px;
            background: var(--secondary);
            border-radius: 8px;
            border-left: 4px solid var(--primary);
            position: relative;
        }

        .timeline-project-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .timeline-project-title {
            font-weight: 600;
            color: var(--text);
            font-size: 14px;
        }

        .timeline-project-client {
            font-size: 12px;
            color: var(--text-gray);
        }

        .timeline-project-bar {
            height: 8px;
            background: var(--primary);
            border-radius: 4px;
            margin-top: 8px;
            position: relative;
        }

        .timeline-project-dates {
            display: flex;
            justify-content: space-between;
            font-size: 11px;
            color: var(--text-gray);
            margin-top: 4px;
        }

        .timeline-legend {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
            padding: 12px;
            background: var(--secondary);
            border-radius: 8px;
        }

        .timeline-legend-item {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
        }

        .timeline-legend-color {
            width: 16px;
            height: 16px;
            border-radius: 4px;
        }

        /* Checklist de Tarefas */
        .tarefas-container {
            background: var(--tertiary);
            border-radius: 8px;
            padding: 16px;
            max-height: 400px;
            overflow-y: auto;
        }

        .tarefa-item {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            padding: 12px;
            background: var(--secondary);
            border-radius: 6px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }

        .tarefa-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .tarefa-item.concluida {
            opacity: 0.6;
        }

        .tarefa-checkbox {
            width: 20px;
            height: 20px;
            margin-top: 2px;
            cursor: pointer;
            accent-color: var(--primary);
        }

        .tarefa-content {
            flex: 1;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .tarefa-descricao {
            flex: 1;
            color: var(--text);
            font-size: 14px;
            word-break: break-word;
        }

        .tarefa-item.concluida .tarefa-descricao {
            text-decoration: line-through;
            color: var(--text-gray);
        }

        .tarefa-actions {
            display: flex;
            gap: 4px;
        }

        .tarefa-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text);
            padding: 4px 8px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .tarefa-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .tarefa-btn-edit {
            border-color: var(--primary);
            color: var(--primary);
        }

        .tarefa-btn-delete {
            border-color: var(--danger);
            color: var(--danger);
        }

        .tarefa-empty {
            text-align: center;
            padding: 40px;
            color: var(--text-gray);
            font-style: italic;
        }

        .tarefa-form {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .tarefa-form input {
            flex: 1;
            padding: 8px 12px;
            background: var(--secondary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            color: var(--text);
            font-size: 14px;
        }

        .tarefa-form input:focus {
            outline: none;
            border-color: var(--primary);
        }

        .tarefa-form .btn {
            padding: 8px 16px;
            font-size: 12px;
        }

        /* Arquivos e Documentos */
        .arquivos-container {
            background: var(--tertiary);
            border-radius: 8px;
            padding: 16px;
            max-height: 400px;
            overflow-y: auto;
        }

        .arquivo-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            background: var(--secondary);
            border-radius: 6px;
            margin-bottom: 8px;
            transition: all 0.2s;
        }

        .arquivo-item:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .arquivo-icon {
            font-size: 24px;
            width: 40px;
            text-align: center;
        }

        .arquivo-info {
            flex: 1;
            min-width: 0;
        }

        .arquivo-nome {
            color: var(--text);
            font-size: 14px;
            font-weight: 500;
            word-break: break-word;
            margin-bottom: 4px;
        }

        .arquivo-meta {
            display: flex;
            gap: 12px;
            font-size: 11px;
            color: var(--text-gray);
        }

        .arquivo-descricao {
            font-size: 12px;
            color: var(--text-gray);
            margin-top: 4px;
            font-style: italic;
        }

        .arquivo-actions {
            display: flex;
            gap: 4px;
        }

        .arquivo-btn {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text);
            padding: 6px 10px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 12px;
            transition: all 0.2s;
        }

        .arquivo-btn:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .arquivo-btn-download {
            border-color: var(--primary);
            color: var(--primary);
        }

        .arquivo-btn-delete {
            border-color: var(--danger);
            color: var(--danger);
        }

        .arquivo-btn-view {
            border-color: var(--primary);
            color: var(--primary);
        }

        /* Modal de visualização de imagem */
        .image-viewer-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
            padding: 20px;
        }

        .image-viewer-content {
            max-width: 90%;
            max-height: 90%;
            position: relative;
        }

        .image-viewer-content img {
            max-width: 100%;
            max-height: 90vh;
            object-fit: contain;
            border-radius: 8px;
        }

        .image-viewer-close {
            position: absolute;
            top: -40px;
            right: 0;
            background: var(--primary);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            font-size: 24px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s;
        }

        .image-viewer-close:hover {
            background: var(--danger);
            transform: scale(1.1);
        }

        /* Notificações de Prazos */
        .notification-badge {
            background: var(--danger);
            color: white;
            border-radius: 12px;
            padding: 4px 12px;
            font-size: 12px;
            font-weight: 600;
            min-width: 24px;
            text-align: center;
        }

        .menu-badge {
            background: var(--danger);
            color: white;
            border-radius: 10px;
            padding: 2px 8px;
            font-size: 11px;
            font-weight: 600;
            margin-left: auto;
        }

        .notification-card {
            background: var(--secondary);
            border-left: 4px solid;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
            cursor: pointer;
            transition: all 0.2s;
        }

        .notification-card:hover {
            background: rgba(255, 255, 255, 0.05);
            transform: translateX(4px);
        }

        .notification-card.atrasado {
            border-left-color: var(--danger);
        }

        .notification-card.proximo {
            border-left-color: var(--warning);
        }

        .notification-card.sem-data {
            border-left-color: var(--text-gray);
        }

        .notification-card.urgente {
            border-left-color: var(--danger);
            background: rgba(239, 68, 68, 0.1);
        }

        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 8px;
        }

        .notification-title {
            font-weight: 600;
            color: var(--text);
            font-size: 14px;
        }

        .notification-status {
            font-size: 11px;
            padding: 2px 8px;
            border-radius: 4px;
            font-weight: 600;
        }

        .notification-status.atrasado {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger);
        }

        .notification-status.proximo {
            background: rgba(251, 191, 36, 0.2);
            color: var(--warning);
        }

        .notification-status.sem-data {
            background: rgba(156, 163, 175, 0.2);
            color: var(--text-gray);
        }

        .notification-status.urgente {
            background: rgba(239, 68, 68, 0.3);
            color: var(--danger);
            font-weight: 700;
        }

        .notification-info {
            display: flex;
            gap: 16px;
            font-size: 12px;
            color: var(--text-gray);
            margin-top: 8px;
        }

        .notification-days {
            font-weight: 600;
            color: var(--text);
        }

        .notification-days.atrasado {
            color: var(--danger);
        }

        .notification-days.proximo {
            color: var(--warning);
        }

        .notification-days.urgente {
            color: var(--danger);
        }

        .arquivo-empty {
            text-align: center;
            padding: 40px;
            color: var(--text-gray);
            font-style: italic;
        }

        .upload-form {
            background: var(--secondary);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 12px;
        }

        .upload-form input[type="file"] {
            display: none;
        }

        .upload-form-label {
            display: block;
            padding: 12px;
            background: var(--tertiary);
            border: 2px dashed rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text);
        }

        .upload-form-label:hover {
            border-color: var(--primary);
            background: rgba(255, 102, 0, 0.1);
        }

        .upload-form-label.has-file {
            border-color: var(--primary);
            background: rgba(255, 102, 0, 0.1);
        }

        .upload-file-name {
            margin-top: 8px;
            font-size: 12px;
            color: var(--primary);
            word-break: break-word;
        }

        .upload-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        /* Tags */
        .tag-badge {
            background: rgba(255, 102, 0, 0.2);
            color: var(--primary);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
            margin-right: 8px;
            margin-bottom: 8px;
        }

        /* Badges para status financeiro */
        .badge-warning {
            background: rgba(251, 191, 36, 0.2);
            color: #fbbf24;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
        }

        .badge-success {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
        }

        .badge-danger {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
        }

        .badge-secondary {
            background: rgba(107, 114, 128, 0.2);
            color: #9ca3af;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
        }

        /* Tabs Financeiro */
        .financeiro-tab {
            display: block;
        }

        /* Botões pequenos para ações */
        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
            margin-right: 4px;
            border-radius: 6px;
        }

        /* Estilos para tabelas financeiras responsivas */
        @media (max-width: 768px) {
            #receitasTable tbody tr,
            #despesasTable tbody tr {
                display: block;
                background: var(--secondary);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 12px;
                margin-bottom: 12px;
                padding: 16px;
            }
            
            #receitasTable tbody td,
            #despesasTable tbody td {
                display: block;
                width: 100%;
                padding: 8px 0;
                text-align: left !important;
                border: none;
                border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            }
            
            #receitasTable tbody td:last-child,
            #despesasTable tbody td:last-child {
                border-bottom: none;
                padding-top: 12px;
            }
            
            #receitasTable tbody td:before,
            #despesasTable tbody td:before {
                content: attr(data-label) ": ";
                font-weight: 600;
                color: var(--primary);
                display: inline-block;
                margin-right: 8px;
                min-width: 120px;
            }
        }

        .btn-action {
            background: transparent;
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text);
            padding: 6px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 12px;
            margin-right: 8px;
            transition: all 0.3s;
        }

        .btn-action:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .btn-action.edit {
            border-color: var(--primary);
            color: var(--primary);
        }

        .btn-action.delete {
            border-color: var(--danger);
            color: var(--danger);
        }

        .search-bar {
            display: flex;
            gap: 16px;
            margin-bottom: 24px;
            align-items: center;
        }

        .search-input {
            flex: 1;
            background: var(--tertiary);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            padding: 12px 16px;
            color: var(--text);
            font-size: 14px;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            max-width: 100vw;
            max-height: 100vh;
            background: rgba(0, 0, 0, 0.8);
            z-index: 10000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            overflow-x: hidden;
            -webkit-overflow-scrolling: touch;
            overscroll-behavior: contain;
        }

        .modal.active {
            display: flex;
        }

        /* Prevenir scroll do body quando modal está aberto */
        /* Os estilos são aplicados inline via JavaScript para garantir que funcione */
        body.modal-open {
            overflow: hidden;
            position: fixed;
            width: 100%;
            height: 100%;
            touch-action: none;
        }
        
        html.modal-open {
            overflow: hidden;
            height: 100%;
        }

        .modal-content {
            background: var(--secondary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 16px;
            padding: 32px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            margin: 20px;
            cursor: default;
            position: relative;
            z-index: 10001;
            pointer-events: auto;
        }
        
        /* Prevenir propagação de eventos do conteúdo para o overlay */
        .modal-content * {
            pointer-events: auto;
        }


        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--primary);
        }

        .btn-close {
            background: transparent;
            border: none;
            color: var(--text-gray);
            font-size: 24px;
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-close:hover {
            color: var(--text);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 16px;
        }

        /* ========== RESPONSIVIDADE MOBILE ========== */
        @media (max-width: 768px) {
            /* Sidebar */
            .sidebar {
                transform: translateX(-100%);
                width: 280px;
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .sidebar-overlay.active {
                display: block;
            }

            .main-content {
                margin-left: 0;
                padding: 12px;
            }

            .menu-toggle {
                display: block;
                margin-right: 12px;
            }

            /* Header */
            .header {
                padding: 12px;
                margin: -12px -12px 16px -12px;
                flex-wrap: wrap;
            }

            .header-title {
                font-size: 18px;
                flex: 1;
                min-width: 0;
            }

            .header-user {
                width: 100%;
                justify-content: space-between;
                margin-top: 8px;
            }

            .user-info {
                display: none;
            }

            .user-avatar {
                width: 36px;
                height: 36px;
                font-size: 14px;
            }

            .btn-logout {
                padding: 6px 12px;
                font-size: 12px;
            }

            /* Títulos */
            .page-title {
                font-size: 22px;
                margin-bottom: 6px;
            }

            .page-subtitle {
                font-size: 13px;
                margin-bottom: 16px;
            }

            /* Cards Grid */
            .cards-grid {
                grid-template-columns: 1fr;
                gap: 16px;
                margin-bottom: 16px;
            }

            .card {
                padding: 16px;
            }

            .card-value {
                font-size: 20px;
            }

            /* Tabelas - Transformar em Cards */
            .table-container {
                overflow-x: visible;
                margin: 0 -12px;
                padding: 0 12px;
            }

            table {
                display: block;
                width: 100%;
                min-width: auto;
            }

            thead {
                display: none;
            }

            tbody {
                display: block;
            }

            tr {
                display: block;
                background: var(--secondary);
                border: 1px solid rgba(255, 255, 255, 0.1);
                border-radius: 12px;
                margin-bottom: 12px;
                padding: 16px;
            }

            td {
                display: block;
                width: 100%;
                padding: 8px 0;
                text-align: left !important;
                border: none;
                border-bottom: 1px solid rgba(255, 255, 255, 0.05);
            }

            td:last-child {
                border-bottom: none;
            }

            td:before {
                content: attr(data-label) ": ";
                font-weight: 600;
                color: var(--primary);
                display: inline-block;
                margin-right: 8px;
                min-width: 100px;
            }

            /* Tabela de orçamentos específica */
            table tr td:first-child {
                font-weight: 600;
                font-size: 16px;
                color: var(--primary);
                border-bottom: 2px solid rgba(255, 102, 0, 0.3);
                padding-bottom: 12px;
                margin-bottom: 8px;
            }

            table tr td:first-child:before {
                display: none;
            }

            /* Tabela de itens do orçamento - versão mobile */
            #orcamentoItensTable {
                display: block;
                width: 100%;
            }

            #orcamentoItensTable thead {
                display: none;
            }

            #orcamentoItensTable tbody,
            #orcamentoItensTable tr,
            #orcamentoItensTable td {
                display: block;
                width: 100%;
            }

            #orcamentoItensTable tr {
                margin-bottom: 16px;
                background: var(--tertiary);
                border-radius: 8px;
                padding: 12px;
                border: 1px solid rgba(255, 255, 255, 0.1);
            }

            #orcamentoItensTable td {
                padding: 8px 0;
                text-align: left !important;
                border: none;
            }

            #orcamentoItensTable td:before {
                content: attr(data-label);
                font-weight: 600;
                color: var(--primary);
                display: block;
                margin-bottom: 4px;
                font-size: 12px;
            }

            #orcamentoItensTable tfoot tr {
                background: transparent;
                border: none;
                padding: 0;
            }

            #orcamentoItensTable tfoot td {
                padding: 8px 0;
            }

            /* Formulários */
            .form-row {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .form-group {
                margin-bottom: 16px;
            }

            .form-label {
                font-size: 13px;
                margin-bottom: 6px;
            }

            .form-input,
            .search-input {
                font-size: 16px; /* Evita zoom no iOS */
                padding: 14px 16px;
            }

            textarea.form-input {
                min-height: 100px;
            }

            /* Botões */
            .btn {
                padding: 14px 20px;
                font-size: 15px;
                min-height: 48px; /* Área de toque adequada */
            }

            .btn-action {
                padding: 8px 12px;
                font-size: 13px;
                margin-right: 6px;
                margin-bottom: 6px;
            }

            /* Modais */
            .modal {
                padding: 0;
                align-items: flex-start;
                justify-content: flex-start;
                overflow-y: auto;
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch;
                overscroll-behavior: contain;
                width: 100vw;
                height: 100vh;
                max-width: 100vw;
                max-height: 100vh;
                position: fixed;
                top: 0;
                left: 0;
            }

            .modal.active {
                display: flex;
            }

            .modal-content {
                width: 100%;
                max-width: 100%;
                min-height: 100vh;
                padding: 16px;
                margin: 0;
                border-radius: 0;
                overflow-y: auto;
                overflow-x: hidden;
                -webkit-overflow-scrolling: touch;
                overscroll-behavior: contain;
                position: relative;
                z-index: 10001;
                background: var(--secondary);
                display: flex;
                flex-direction: column;
            }

            .modal-header {
                position: sticky;
                top: 0;
                background: var(--secondary);
                z-index: 10002;
                padding: 12px 0;
                margin-bottom: 16px;
                border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            }
            
            /* Garantir que body não scroll quando modal está aberto */
            body.modal-open,
            html.modal-open body {
                overflow: hidden !important;
                position: fixed !important;
                width: 100% !important;
                height: 100% !important;
                left: 0 !important;
                right: 0 !important;
                top: 0 !important;
                touch-action: none !important;
            }
            
            html.modal-open {
                overflow: hidden !important;
                height: 100% !important;
                position: relative !important;
            }
            
            /* Garantir que o modal ocupe toda a tela no mobile */
            .modal.active {
                position: fixed !important;
                top: 0 !important;
                left: 0 !important;
                width: 100vw !important;
                height: 100vh !important;
                max-width: 100vw !important;
                max-height: 100vh !important;
                z-index: 10000 !important;
            }

            .modal-title {
                font-size: 20px;
            }

            .btn-close {
                width: 40px;
                height: 40px;
                font-size: 28px;
            }

            .modal-actions {
                flex-direction: column;
                gap: 12px;
                position: sticky;
                bottom: 0;
                background: var(--secondary);
                padding: 16px 0;
                margin-top: 24px;
                border-top: 1px solid rgba(255, 255, 255, 0.1);
            }

            .modal-actions .btn {
                width: 100%;
                margin: 0;
            }

            /* Search Bar */
            .search-bar {
                flex-direction: column;
                gap: 12px;
                margin-bottom: 16px;
            }

            .search-input {
                width: 100%;
            }

            /* Section Cards */
            .section-card {
                padding: 16px;
                margin-bottom: 16px;
            }

            .section-title {
                font-size: 18px;
                margin-bottom: 12px;
            }

            /* Login */
            .login-container {
                padding: 16px;
            }

            .login-box {
                padding: 24px;
            }

            .login-title {
                font-size: 26px;
            }

            /* Kanban */
            .kanban-board {
                flex-direction: column;
                overflow-x: visible;
                overflow-y: visible;
                gap: 16px;
            }

            .kanban-column {
                width: 100%;
                min-width: 100%;
                margin-bottom: 16px;
            }

            .kanban-card {
                margin-bottom: 12px;
            }

            /* Badges e Tags */
            .badge {
                font-size: 11px;
                padding: 4px 10px;
            }

            .tag-badge {
                font-size: 11px;
                padding: 4px 10px;
                margin-right: 6px;
                margin-bottom: 6px;
            }

            /* Cards de Notificação */
            .notification-card {
                padding: 12px;
            }

            .notification-title {
                font-size: 13px;
            }

            /* Empty State */
            .empty-state {
                padding: 24px 16px;
                font-size: 14px;
            }

            /* Upload */
            .upload-form {
                padding: 12px;
            }

            .upload-actions {
                flex-direction: column;
            }

            .upload-actions .btn {
                width: 100%;
            }

            /* Checkbox Groups */
            .checkbox-group {
                padding: 12px;
            }

            .checkbox-item {
                padding: 10px 0;
            }

            /* Serviços Submenu */
            .servico-submenu {
                padding-left: 24px;
            }

            /* Image Viewer */
            .image-viewer {
                padding: 16px;
            }

            .image-viewer img {
                max-width: 100%;
                max-height: 70vh;
            }

            .image-viewer-close {
                top: -50px;
                right: 16px;
            }

            /* Proposta Pública Mobile */
            #propostaPublicaPage {
                padding: 16px 12px;
            }

            #propostaPublicaPage > div {
                padding: 20px 16px;
                border-radius: 12px;
            }

            #propostaPublicaPage h1 {
                font-size: 22px;
            }

            #propostaPublicaPage table {
                font-size: 12px;
            }

            #propostaPublicaPage button {
                width: 100%;
                margin-bottom: 12px;
                padding: 14px;
            }
        }

        /* Mobile muito pequeno (< 375px) */
        @media (max-width: 374px) {
            .page-title {
                font-size: 20px;
            }

            .modal-title {
                font-size: 18px;
            }

            .btn {
                padding: 12px 16px;
                font-size: 14px;
            }

            .card {
                padding: 12px;
            }

            .section-card {
                padding: 12px;
            }
        }

        /* Landscape mobile */
        @media (max-width: 768px) and (orientation: landscape) {
            .modal-content {
                max-height: 95vh;
            }

            .sidebar {
                width: 260px;
            }
        }

        .checkbox-group {
            display: flex;
            flex-wrap: wrap;
            gap: 16px;
            margin-top: 8px;
        }

        .checkbox-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .checkbox-item input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .servico-item {
            margin-bottom: 12px;
        }

        .servico-main {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .servico-submenu {
            margin-left: 26px;
            margin-top: 8px;
            padding-left: 16px;
            border-left: 2px solid rgba(255, 102, 0, 0.3);
            display: none;
        }

        .servico-submenu.active {
            display: block;
        }

        .servico-submenu .checkbox-item {
            margin-bottom: 8px;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
        }

        .btn-secondary {
            background: var(--tertiary);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: var(--text);
        }

        .btn-secondary:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Detalhes Cliente */
        .details-section {
            margin-bottom: 24px;
            padding-bottom: 24px;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .details-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }

        .details-section-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 16px;
        }

        .details-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        @media (max-width: 768px) {
            .details-grid {
                grid-template-columns: 1fr;
            }
        }

        .details-item {
            margin-bottom: 12px;
        }

        .details-label {
            font-size: 12px;
            color: var(--text-gray);
            margin-bottom: 4px;
            font-weight: 500;
        }

        .details-value {
            font-size: 14px;
            color: var(--text);
            word-break: break-word;
        }

        .details-value.empty {
            color: var(--text-gray);
            font-style: italic;
        }

        .servicos-list {
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
            margin-top: 8px;
        }

        .servico-badge {
            background: rgba(255, 102, 0, 0.2);
            color: var(--primary);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 500;
        }

        .btn-danger {
            background: var(--danger);
            color: white;
            border: 1px solid var(--danger);
        }

        .btn-danger:hover {
            background: rgba(239, 68, 68, 0.8);
        }

        /* Loading */
        .loading {
            display: none;
            text-align: center;
            padding: 40px;
        }

        .loading.active {
            display: block;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid rgba(255, 102, 0, 0.2);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Responsive */
        @media (max-width: 768px) {
            .menu-toggle {
                display: block;
            }

            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.open {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
                padding: 16px;
            }

            .header {
                padding: 12px 16px;
                margin: -16px -16px 16px -16px;
            }

            .header-title {
                font-size: 18px;
            }

            .user-info {
                display: none;
            }

            .user-avatar {
                width: 32px;
                height: 32px;
                font-size: 14px;
            }

            .btn-logout {
                padding: 6px 12px;
                font-size: 12px;
            }

            .page-title {
                font-size: 24px;
            }

            .page-subtitle {
                font-size: 14px;
            }

            .cards-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .card {
                padding: 16px;
            }

            .card-value {
                font-size: 20px;
            }

            .section-card {
                padding: 16px;
            }

            .section-title {
                font-size: 18px;
            }

            .search-bar {
                flex-direction: column;
                gap: 12px;
            }

            .search-input {
                width: 100%;
            }

            .table-container {
                overflow-x: auto;
                -webkit-overflow-scrolling: touch;
            }

            table {
                min-width: 600px;
                font-size: 14px;
            }

            th, td {
                padding: 8px;
                font-size: 12px;
            }

            .btn-action {
                padding: 4px 8px;
                font-size: 11px;
                margin-right: 4px;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
                max-height: 95vh;
                margin: 10px;
            }

            .modal-title {
                font-size: 20px;
            }

            .form-row {
                grid-template-columns: 1fr;
            }

            .details-grid {
                grid-template-columns: 1fr;
            }

            .details-section {
                margin-bottom: 20px;
                padding-bottom: 20px;
            }

            .details-section-title {
                font-size: 16px;
            }

            .modal-actions {
                flex-direction: column-reverse;
                gap: 8px;
            }

            .modal-actions .btn {
                width: 100%;
            }

            .servicos-list {
                gap: 6px;
            }

            .servico-badge, .tag-badge {
                font-size: 11px;
                padding: 3px 10px;
            }

            .login-box {
                padding: 24px;
            }

            .login-title {
                font-size: 28px;
            }

            .login-logo {
                max-width: 100px;
                max-height: 100px;
            }

            .logo-image {
                max-width: 32px;
                max-height: 32px;
            }

            .sidebar-logo:has(.logo-image) .logo-text {
                font-size: 18px;
            }
        }

        @media (max-width: 480px) {
            .main-content {
                padding: 12px;
            }

            .header {
                padding: 10px 12px;
                margin: -12px -12px 12px -12px;
            }

            .page-title {
                font-size: 20px;
            }

            .card {
                padding: 12px;
            }

            .card-value {
                font-size: 18px;
            }

            .section-card {
                padding: 12px;
            }

            .modal-content {
                padding: 16px;
            }

            .form-input, .btn {
                font-size: 14px;
            }

            .login-box {
                padding: 20px;
            }

            .login-title {
                font-size: 24px;
            }
        }

        /* Plataformas Grid */
        .plataformas-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 20px;
            margin-top: 24px;
        }

        .plataforma-card {
            background: var(--secondary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            transition: all 0.3s;
            cursor: pointer;
        }

        .plataforma-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            border-color: var(--primary);
        }

        .plataforma-card-header {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 16px;
        }

        .plataforma-card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text);
            margin: 0;
            flex: 1;
        }

        .plataforma-card-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            text-transform: uppercase;
        }

        .badge-tipo-unico {
            background: rgba(59, 130, 246, 0.2);
            color: #3b82f6;
        }

        .badge-tipo-recorrente {
            background: rgba(16, 185, 129, 0.2);
            color: #10b981;
        }

        .badge-tipo-gratis {
            background: rgba(156, 163, 175, 0.2);
            color: #9ca3af;
        }

        .plataforma-card-info {
            margin-bottom: 16px;
        }

        .plataforma-info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 8px;
            font-size: 13px;
        }

        .plataforma-info-label {
            color: var(--text-gray);
        }

        .plataforma-info-value {
            color: var(--text);
            font-weight: 500;
        }

        .plataforma-card-actions {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .plataforma-card-actions .btn {
            flex: 1;
            min-width: 80px;
            padding: 8px 12px;
            font-size: 12px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        @media (max-width: 768px) {
            .plataformas-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .plataforma-card {
                padding: 16px;
            }

            .plataforma-card-actions {
                flex-direction: column;
            }

            .plataforma-card-actions .btn {
                width: 100%;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="loginPage" class="login-container">
        <div class="login-box">
            <div class="login-logo-container">
                <img id="loginLogo" class="login-logo" src="" alt="Logo" style="display: none;">
            </div>
            <h1 class="login-title" id="loginTitle">Sistema de Gestão</h1>
            <p class="login-subtitle">Faça login para continuar</p>
            
            <div id="errorMessage" class="error-message"></div>
            
            <form id="loginForm">
                <div class="form-group">
                    <label class="form-label" for="nome">Nome</label>
                    <input 
                        type="text" 
                        id="nome" 
                        class="form-input" 
                        placeholder=""
                        autocomplete="off"
                    >
                </div>
                
                <div class="form-group">
                    <label class="form-label" for="password">Senha</label>
                    <input 
                        type="password" 
                        id="password" 
                        class="form-input" 
                        placeholder=""
                        autocomplete="off"
                    >
                </div>
                
                <button type="submit" class="btn btn-primary" id="loginBtn">
                    <span>Entrar</span>
                </button>
            </form>
        </div>
    </div>

    <!-- Dashboard -->
    <div id="dashboardPage" class="dashboard-container">
        <div class="sidebar-overlay" id="sidebarOverlay" onclick="toggleSidebar()"></div>
        <div class="sidebar" id="sidebar">
            <div class="sidebar-logo">
                <img id="sidebarLogo" class="logo-image" src="" alt="Logo" style="display: none;">
                <span class="logo-text" id="sidebarLogoText">Gestão</span>
            </div>
            <a href="#" class="menu-item active" data-page="dashboard" onclick="closeSidebarMobile()">
                <span>📊</span>
                <span>Dashboard</span>
            </a>
            <a href="#" class="menu-item" data-page="clientes" onclick="closeSidebarMobile()">
                <span>👥</span>
                <span>Clientes</span>
            </a>
            <a href="#" class="menu-item" data-page="orcamentos" onclick="closeSidebarMobile()">
                <span>📄</span>
                <span>Orçamentos</span>
            </a>
        <a href="#" class="menu-item" data-page="projetos" onclick="closeSidebarMobile()">
            <span>📁</span>
            <span>Projetos</span>
        </a>
            <a href="#" class="menu-item" data-page="ideias" onclick="closeSidebarMobile()">
                <span>💡</span>
                <span>Análises & Ideias</span>
            </a>
            <a href="#" class="menu-item" data-page="templates" onclick="closeSidebarMobile()">
                <span>📝</span>
                <span>Templates de Mensagens</span>
            </a>
            <a href="#" class="menu-item" data-page="financeiro" onclick="closeSidebarMobile()">
                <span>💰</span>
                <span>Financeiro</span>
            </a>
            <a href="#" class="menu-item" data-page="contratos" onclick="closeSidebarMobile()">
                <span>📋</span>
                <span>Contratos</span>
            </a>
            <a href="#" class="menu-item" data-page="plataformas" onclick="closeSidebarMobile()">
                <span>🔑</span>
                <span>Plataformas</span>
            </a>
            <a href="#" class="menu-item" data-page="tarefas" onclick="closeSidebarMobile()">
                <span>✅</span>
                <span>Tarefas & Hábitos</span>
            </a>
            <a href="#" class="menu-item" data-page="analises" onclick="closeSidebarMobile()">
                <span>📊</span>
                <span>Análises Avançadas</span>
            </a>
            <a href="#" class="menu-item" data-page="precificacao" onclick="closeSidebarMobile()">
                <span>💵</span>
                <span>Precificação</span>
            </a>
        </div>

        <div class="main-content">
            <div class="header">
                <div style="display: flex; align-items: center;">
                    <button class="menu-toggle" onclick="toggleSidebar()">☰</button>
                    <h2 class="header-title">Dashboard</h2>
                </div>
                <div class="header-user">
                    <div class="user-info">
                        <div class="user-name" id="userName">Usuário</div>
                        <div class="user-email" id="userEmail">email@exemplo.com</div>
                    </div>
                    <div class="user-avatar" id="userAvatar">U</div>
                    <button class="btn btn-logout" onclick="logout()">Sair</button>
                </div>
            </div>

            <!-- Dashboard Content -->
            <div id="dashboardContent" class="page-content">
                <h1 class="page-title">Dashboard</h1>
                <p class="page-subtitle">Visão geral do seu negócio</p>

                <div class="cards-grid">
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Faturamento do Mês</div>
                                <div class="card-value" id="faturamentoMes">R$ 0,00</div>
                            </div>
                            <div class="card-icon">💰</div>
                        </div>
                        <div class="card-footer">vs mês anterior</div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Projetos Ativos</div>
                                <div class="card-value" id="projetosAtivos">0</div>
                            </div>
                            <div class="card-icon">📁</div>
                        </div>
                        <div class="card-footer">Em andamento</div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Pagamentos Pendentes</div>
                                <div class="card-value" id="pagamentosPendentes">R$ 0,00</div>
                            </div>
                            <div class="card-icon">⏰</div>
                        </div>
                        <div class="card-footer">A receber</div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Pagamentos Vencidos</div>
                                <div class="card-value" id="pagamentosVencidos" style="color: var(--danger);">R$ 0,00</div>
                            </div>
                            <div class="card-icon">⚠️</div>
                        </div>
                        <div class="card-footer">Atrasados</div>
                    </div>
                </div>

                <!-- Gráficos de Vendas -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 24px;">
                    <div class="section-card">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                            <h2 class="section-title">📈 Receitas vs Despesas</h2>
                            <select id="graficoPeriodo" class="form-input" style="width: 150px; padding: 6px;" onchange="atualizarGraficos()">
                                <option value="mes">Este Mês</option>
                                <option value="trimestre">Trimestre</option>
                                <option value="ano">Este Ano</option>
                            </select>
                        </div>
                        <canvas id="graficoReceitasDespesas" style="max-height: 300px;"></canvas>
                    </div>

                    <div class="section-card">
                        <h2 class="section-title" style="margin-bottom: 16px;">🎯 Taxa de Conversão</h2>
                        <canvas id="graficoConversao" style="max-height: 300px;"></canvas>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-top: 24px;">
                    <div class="section-card">
                        <h2 class="section-title" style="margin-bottom: 16px;">📊 Projetos por Status</h2>
                        <canvas id="graficoProjetosStatus" style="max-height: 300px;"></canvas>
                    </div>

                    <div class="section-card">
                        <h2 class="section-title" style="margin-bottom: 16px;">💰 Faturamento Mensal</h2>
                        <canvas id="graficoFaturamentoMensal" style="max-height: 300px;"></canvas>
                    </div>
                </div>

                <div class="section-card" style="margin-top: 24px;">
                    <h2 class="section-title">📋 Top 5 Clientes (por Faturamento)</h2>
                    <div id="topClientesList" style="margin-top: 16px;">
                        <div class="empty-state">Carregando...</div>
                    </div>
                </div>

                <div class="section-card">
                    <h2 class="section-title">Próximos Vencimentos (7 dias)</h2>
                    <div id="proximosVencimentos" class="empty-state">Nenhum vencimento próximo</div>
                </div>

                <div class="section-card">
                    <h2 class="section-title">Orçamentos Aguardando Aprovação</h2>
                    <div id="orcamentosAguardando" class="empty-state">Nenhum orçamento aguardando aprovação</div>
                </div>

                <div class="section-card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <h2 class="section-title">⚠️ Projetos que Precisam de Atenção</h2>
                        <span id="notificacoesCount" class="notification-badge" style="display: none;">0</span>
                    </div>
                    <div id="notificacoesProjetos">
                        <div class="empty-state">Carregando notificações...</div>
                    </div>
                </div>
            </div>

            <!-- Other Pages Content (hidden by default) -->
            <div id="clientesContent" class="page-content" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <div>
                        <h1 class="page-title">Clientes</h1>
                        <p class="page-subtitle">Gerencie seus clientes</p>
                    </div>
                    <button class="btn btn-primary" onclick="openClienteModal()">+ Novo Cliente</button>
                </div>

                <div class="section-card">
                    <div class="search-bar">
                        <input 
                            type="text" 
                            id="clienteSearch" 
                            class="search-input" 
                            placeholder="Buscar por nome, empresa ou email..."
                            onkeyup="filterClientes()"
                        >
                        <select id="clienteStatusFilter" class="form-input" style="width: 200px;" onchange="filterClientes()">
                            <option value="">Todos os status</option>
                            <option value="ativo">Ativo</option>
                            <option value="inativo">Inativo</option>
                        </select>
                    </div>

                    <div class="table-container">
                        <div id="clientesLoading" class="loading active">
                            <div class="spinner"></div>
                            <p>Carregando clientes...</p>
                        </div>
                        <table id="clientesTable" style="display: none;">
                            <thead>
                        <tr>
                            <th>Nome</th>
                            <th>Empresa</th>
                            <th>Email</th>
                            <th>Telefone</th>
                            <th>Cidade/Estado</th>
                            <th>Status</th>
                            <th>Ações</th>
                        </tr>
                            </thead>
                            <tbody id="clientesTableBody">
                            </tbody>
                        </table>
                        <div id="clientesEmpty" class="empty-state" style="display: none;">
                            Nenhum cliente encontrado
                        </div>
                    </div>
                </div>
            </div>

            <div id="projetosContent" class="page-content" style="display: none;">
                <div style="margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1 class="page-title">Projetos</h1>
                        <p class="page-subtitle">Gerencie seus projetos</p>
                    </div>
                    <div style="display: flex; gap: 8px;">
                        <button id="viewTableBtn" class="btn" onclick="toggleProjetoView('table')" style="background: var(--primary); border-color: var(--primary);">
                            📋 Tabela
                        </button>
                        <button id="viewKanbanBtn" class="btn" onclick="toggleProjetoView('kanban')" style="background: var(--tertiary); border-color: var(--tertiary);">
                            📊 Kanban
                        </button>
                        <button id="viewTimelineBtn" class="btn" onclick="toggleProjetoView('timeline')" style="background: var(--tertiary); border-color: var(--tertiary);">
                            📅 Timeline
                        </button>
                    </div>
                </div>

                <div class="section-card">
                    <div class="search-bar">
                        <input 
                            type="text" 
                            id="projetoSearch" 
                            class="search-input" 
                            placeholder="Buscar por nome do projeto ou cliente..."
                            onkeyup="filterProjetos()"
                        >
                        <select id="projetoStatusFilter" class="form-input" style="width: 200px;" onchange="filterProjetos()">
                            <option value="">Todos os status</option>
                            <option value="planejamento">Planejamento</option>
                            <option value="em_andamento">Em Andamento</option>
                            <option value="pausado">Pausado</option>
                            <option value="concluido">Concluído</option>
                            <option value="cancelado">Cancelado</option>
                        </select>
                        <button type="button" class="btn btn-secondary" id="filterAlertasBtn" onclick="toggleFilterAlertas()" style="white-space: nowrap;">
                            ⚠️ Ver Alertas
                        </button>
                    </div>

                    <!-- Visualização Tabela -->
                    <div id="projetosTableView" class="table-container">
                        <div id="projetosLoading" class="loading active">
                            <div class="spinner"></div>
                            <p>Carregando projetos...</p>
                        </div>
                        <table id="projetosTable" style="display: none;">
                            <thead>
                                <tr>
                                    <th>Nome do Projeto</th>
                                    <th>Cliente</th>
                                    <th>Data Início</th>
                                    <th>Data Prevista</th>
                                    <th>Valor</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="projetosTableBody">
                            </tbody>
                        </table>
                        <div id="projetosEmpty" class="empty-state" style="display: none;">
                            Nenhum projeto encontrado
                        </div>
                    </div>

                    <!-- Visualização Kanban -->
                    <div id="projetosKanbanView" style="display: none;">
                        <div id="kanbanBoard" class="kanban-board">
                            <div class="kanban-column" data-status="planejamento">
                                <div class="kanban-column-header">
                                    <h3>📋 Planejamento</h3>
                                    <span class="kanban-count" id="count-planejamento">0</span>
                                </div>
                                <div class="kanban-column-body" 
                                     id="kanban-planejamento"
                                     data-status="planejamento"
                                     ondragover="handleDragOver(event)"
                                     ondrop="handleDrop(event)"
                                     ondragleave="handleDragLeave(event)">
                                    <!-- Cards serão inseridos aqui -->
                                </div>
                            </div>
                            <div class="kanban-column" data-status="em_andamento">
                                <div class="kanban-column-header">
                                    <h3>🚀 Em Andamento</h3>
                                    <span class="kanban-count" id="count-em_andamento">0</span>
                                </div>
                                <div class="kanban-column-body" 
                                     id="kanban-em_andamento"
                                     data-status="em_andamento"
                                     ondragover="handleDragOver(event)"
                                     ondrop="handleDrop(event)"
                                     ondragleave="handleDragLeave(event)">
                                    <!-- Cards serão inseridos aqui -->
                                </div>
                            </div>
                            <div class="kanban-column" data-status="pausado">
                                <div class="kanban-column-header">
                                    <h3>⏸️ Pausado</h3>
                                    <span class="kanban-count" id="count-pausado">0</span>
                                </div>
                                <div class="kanban-column-body" 
                                     id="kanban-pausado"
                                     data-status="pausado"
                                     ondragover="handleDragOver(event)"
                                     ondrop="handleDrop(event)"
                                     ondragleave="handleDragLeave(event)">
                                    <!-- Cards serão inseridos aqui -->
                                </div>
                            </div>
                            <div class="kanban-column" data-status="concluido">
                                <div class="kanban-column-header">
                                    <h3>✅ Concluído</h3>
                                    <span class="kanban-count" id="count-concluido">0</span>
                                </div>
                                <div class="kanban-column-body" 
                                     id="kanban-concluido"
                                     data-status="concluido"
                                     ondragover="handleDragOver(event)"
                                     ondrop="handleDrop(event)"
                                     ondragleave="handleDragLeave(event)">
                                    <!-- Cards serão inseridos aqui -->
                                </div>
                            </div>
                            <div class="kanban-column" data-status="cancelado">
                                <div class="kanban-column-header">
                                    <h3>❌ Cancelado</h3>
                                    <span class="kanban-count" id="count-cancelado">0</span>
                                </div>
                                <div class="kanban-column-body" 
                                     id="kanban-cancelado"
                                     data-status="cancelado"
                                     ondragover="handleDragOver(event)"
                                     ondrop="handleDrop(event)"
                                     ondragleave="handleDragLeave(event)">
                                    <!-- Cards serão inseridos aqui -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Visualização Timeline/Gantt -->
                    <div id="projetosTimelineView" style="display: none;">
                        <div id="timelineContainer" style="background: var(--tertiary); border-radius: 8px; padding: 20px; overflow-x: auto;">
                            <div id="timelineContent" style="min-width: 100%; position: relative;">
                                <!-- Timeline será renderizada aqui -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="orcamentosContent" class="page-content" style="display: none;">
                <div style="margin-bottom: 24px;">
                    <h1 class="page-title">Orçamentos</h1>
                    <p class="page-subtitle">Gerencie seus orçamentos</p>
                </div>

                <div class="section-card">
                    <div class="search-bar">
                        <input 
                            type="text" 
                            id="orcamentoSearch" 
                            class="search-input" 
                            placeholder="Buscar por número, cliente ou descrição..."
                            onkeyup="filterOrcamentos()"
                        >
                        <select id="orcamentoStatusFilter" class="form-input" style="width: 200px;" onchange="filterOrcamentos()">
                            <option value="">Todos os status</option>
                            <option value="rascunho">Rascunho</option>
                            <option value="enviado">Enviado</option>
                            <option value="aprovado">Aprovado</option>
                            <option value="rejeitado">Rejeitado</option>
                            <option value="expirado">Expirado</option>
                        </select>
                    </div>

                    <div class="table-container">
                        <div id="orcamentosLoading" class="loading active">
                            <div class="spinner"></div>
                            <p>Carregando orçamentos...</p>
                        </div>
                        <table id="orcamentosTable" style="display: none;">
                            <thead>
                                <tr>
                                    <th>Número</th>
                                    <th>Cliente</th>
                                    <th>Data</th>
                                    <th>Valor</th>
                                    <th>Validade</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="orcamentosTableBody">
                            </tbody>
                        </table>
                        <div id="orcamentosEmpty" class="empty-state" style="display: none;">
                            Nenhum orçamento encontrado
                        </div>
                    </div>
                </div>
            </div>

            <div id="financeiroContent" class="page-content" style="display: none;">
                <div style="margin-bottom: 24px; display: flex; justify-content: space-between; align-items: center;">
                    <div>
                        <h1 class="page-title">Financeiro</h1>
                        <p class="page-subtitle">Controle de receitas e despesas</p>
                    </div>
                    <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                        <button class="btn btn-primary" onclick="openReceitaModal()">+ Nova Receita</button>
                        <button class="btn btn-secondary" onclick="openDespesaModal()">+ Nova Despesa</button>
                        <button class="btn btn-primary" onclick="openCobrancaModal()" style="background: var(--success); border-color: var(--success);">💰 Nova Cobrança</button>
                    </div>
                </div>

                <!-- Dashboard Financeiro -->
                <div class="cards-grid" style="margin-bottom: 24px;">
                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Total a Receber</div>
                                <div class="card-value" id="totalReceber" style="color: var(--success);">R$ 0,00</div>
                            </div>
                            <div class="card-icon">💰</div>
                        </div>
                        <div class="card-footer">Pendentes</div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Total a Pagar</div>
                                <div class="card-value" id="totalPagar" style="color: var(--danger);">R$ 0,00</div>
                            </div>
                            <div class="card-icon">💸</div>
                        </div>
                        <div class="card-footer">Pendentes</div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Saldo Previsto</div>
                                <div class="card-value" id="saldoPrevisto">R$ 0,00</div>
                            </div>
                            <div class="card-icon">📊</div>
                        </div>
                        <div class="card-footer">Receitas - Despesas</div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Receitas Recebidas</div>
                                <div class="card-value" id="receitasRecebidas" style="color: var(--success);">R$ 0,00</div>
                            </div>
                            <div class="card-icon">✅</div>
                        </div>
                        <div class="card-footer">Este mês</div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Despesas Pagas</div>
                                <div class="card-value" id="despesasPagas" style="color: var(--danger);">R$ 0,00</div>
                            </div>
                            <div class="card-icon">💳</div>
                        </div>
                        <div class="card-footer">Este mês</div>
                    </div>

                    <div class="card">
                        <div class="card-header">
                            <div>
                                <div class="card-title">Vencimentos Hoje</div>
                                <div class="card-value" id="vencimentosHoje">0</div>
                            </div>
                            <div class="card-icon">⚠️</div>
                        </div>
                        <div class="card-footer">Atenção</div>
                    </div>
                </div>

                <!-- Tabs Receitas/Despesas -->
                <div class="section-card">
                    <div style="display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                        <button class="btn btn-secondary" id="tabReceitas" onclick="switchFinanceiroTab('receitas')" style="border-radius: 8px 8px 0 0; margin-bottom: -1px; border-bottom: 2px solid var(--primary);">
                            💰 Receitas
                        </button>
                        <button class="btn btn-secondary" id="tabDespesas" onclick="switchFinanceiroTab('despesas')" style="border-radius: 8px 8px 0 0; margin-bottom: -1px;">
                            💸 Despesas
                        </button>
                    </div>

                    <!-- Aba Receitas -->
                    <div id="receitasTab" class="financeiro-tab">
                        <div class="search-bar">
                            <input 
                                type="text" 
                                id="receitaSearch" 
                                class="search-input" 
                                placeholder="Buscar por descrição, cliente..."
                                onkeyup="filterReceitas()"
                            >
                            <select id="receitaStatusFilter" class="form-input" style="width: 200px;" onchange="filterReceitas()">
                                <option value="">Todos os status</option>
                                <option value="pendente">Pendente</option>
                                <option value="recebido">Recebido</option>
                                <option value="atrasado">Atrasado</option>
                                <option value="cancelado">Cancelado</option>
                            </select>
                            <select id="receitaClienteFilter" class="form-input" style="width: 200px;" onchange="filterReceitas()">
                                <option value="">Todos os clientes</option>
                            </select>
                        </div>

                        <div class="table-container">
                            <div id="receitasLoading" class="loading active">
                                <div class="spinner"></div>
                                <p>Carregando receitas...</p>
                            </div>
                            <table id="receitasTable" style="display: none;">
                                <thead>
                                    <tr>
                                        <th>Descrição</th>
                                        <th>Cliente</th>
                                        <th>Valor</th>
                                        <th>Vencimento</th>
                                        <th>Recebimento</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="receitasTableBody">
                                </tbody>
                            </table>
                            <div id="receitasEmpty" class="empty-state" style="display: none;">
                                Nenhuma receita encontrada
                            </div>
                        </div>
                    </div>

                    <!-- Aba Despesas -->
                    <div id="despesasTab" class="financeiro-tab" style="display: none;">
                        <div class="search-bar">
                            <input 
                                type="text" 
                                id="despesaSearch" 
                                class="search-input" 
                                placeholder="Buscar por descrição, categoria, fornecedor..."
                                onkeyup="filterDespesas()"
                            >
                            <select id="despesaStatusFilter" class="form-input" style="width: 200px;" onchange="filterDespesas()">
                                <option value="">Todos os status</option>
                                <option value="pendente">Pendente</option>
                                <option value="pago">Pago</option>
                                <option value="atrasado">Atrasado</option>
                                <option value="cancelado">Cancelado</option>
                            </select>
                            <select id="despesaCategoriaFilter" class="form-input" style="width: 200px;" onchange="filterDespesas()">
                                <option value="">Todas as categorias</option>
                            </select>
                        </div>

                        <div class="table-container">
                            <div id="despesasLoading" class="loading active">
                                <div class="spinner"></div>
                                <p>Carregando despesas...</p>
                            </div>
                            <table id="despesasTable" style="display: none;">
                                <thead>
                                    <tr>
                                        <th>Descrição</th>
                                        <th>Categoria</th>
                                        <th>Fornecedor</th>
                                        <th>Valor</th>
                                        <th>Vencimento</th>
                                        <th>Pagamento</th>
                                        <th>Status</th>
                                        <th>Ações</th>
                                    </tr>
                                </thead>
                                <tbody id="despesasTableBody">
                                </tbody>
                            </table>
                            <div id="despesasEmpty" class="empty-state" style="display: none;">
                                Nenhuma despesa encontrada
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contratos Content -->
            <div id="contratosContent" class="page-content" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <div>
                        <h1 class="page-title">📋 Contratos</h1>
                        <p class="page-subtitle">Gerencie seus contratos com clientes</p>
                    </div>
                    <button class="btn btn-primary" onclick="openContratoModal()">+ Novo Contrato</button>
                </div>

                <div class="section-card">
                    <div class="search-bar">
                        <input 
                            type="text" 
                            id="contratoSearch" 
                            class="search-input" 
                            placeholder="Buscar por número, cliente ou descrição..."
                            onkeyup="filterContratos()"
                        >
                        <select id="contratoStatusFilter" class="form-input" style="width: 200px;" onchange="filterContratos()">
                            <option value="">Todos os status</option>
                            <option value="rascunho">Rascunho</option>
                            <option value="aguardando_assinatura">Aguardando Assinatura</option>
                            <option value="ativo">Ativo</option>
                            <option value="vencido">Vencido</option>
                            <option value="renovado">Renovado</option>
                            <option value="cancelado">Cancelado</option>
                        </select>
                        <select id="contratoClienteFilter" class="form-input" style="width: 200px;" onchange="filterContratos()">
                            <option value="">Todos os clientes</option>
                        </select>
                    </div>

                    <div class="table-container">
                        <div id="contratosLoading" class="loading active">
                            <div class="spinner"></div>
                            <p>Carregando contratos...</p>
                        </div>
                        <table id="contratosTable" style="display: none;">
                            <thead>
                                <tr>
                                    <th>Número</th>
                                    <th>Cliente</th>
                                    <th>Descrição</th>
                                    <th>Valor</th>
                                    <th>Início</th>
                                    <th>Vencimento</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="contratosTableBody">
                            </tbody>
                        </table>
                        <div id="contratosEmpty" class="empty-state" style="display: none;">
                            Nenhum contrato encontrado
                        </div>
                    </div>
                </div>
            </div>

            <div id="plataformasContent" class="page-content" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <div>
                        <h1 class="page-title">Plataformas</h1>
                        <p class="page-subtitle">Gerencie suas plataformas, assinaturas e credenciais</p>
                    </div>
                    <button class="btn btn-primary" onclick="openPlataformaModal()">+ Nova Plataforma</button>
                </div>

                <div class="section-card">
                    <div class="search-bar">
                        <input 
                            type="text" 
                            id="plataformaSearch" 
                            class="search-input" 
                            placeholder="Buscar por nome..."
                            onkeyup="filterPlataformas()"
                        >
                        <select id="plataformaTipoFilter" class="form-input" style="width: 200px;" onchange="filterPlataformas()">
                            <option value="">Todos os tipos</option>
                            <option value="unico">Pagamento Único</option>
                            <option value="recorrente">Pagamento Recorrente</option>
                            <option value="gratis">Grátis</option>
                        </select>
                    </div>

                    <div id="plataformasLoading" class="loading active">
                        <div class="spinner"></div>
                        <p>Carregando plataformas...</p>
                    </div>

                    <div id="plataformasGrid" class="plataformas-grid" style="display: none;">
                        <!-- Cards serão inseridos aqui dinamicamente -->
                    </div>

                    <div id="plataformasEmpty" class="empty-state" style="display: none;">
                        Nenhuma plataforma encontrada
                    </div>
                </div>
            </div>

            <!-- Análises & Ideias Content -->
            <div id="ideiasContent" class="page-content" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <div>
                        <h1 class="page-title">💡 Análises & Ideias</h1>
                        <p class="page-subtitle">Registre análises de empresas e ideias de melhorias estratégicas</p>
                    </div>
                    <div style="display: flex; gap: 12px;">
                        <button class="btn btn-primary" onclick="openIdeiaModal()">+ Nova Análise/Ideia</button>
                        <button class="btn btn-secondary" id="gerarPdfIdeiasBtn" onclick="gerarPdfIdeias()" style="display: none;">
                            📄 Gerar PDF das Selecionadas
                        </button>
                    </div>
                </div>

                <div class="section-card">
                    <div style="margin-bottom: 16px; display: flex; gap: 12px; align-items: center;">
                        <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                            <input type="checkbox" id="selectAllIdeias" onchange="toggleSelectAllIdeias()" style="width: 18px; height: 18px; cursor: pointer;">
                            <span>Selecionar todas</span>
                        </label>
                        <span id="ideiasSelecionadasCount" style="color: var(--text-gray); font-size: 14px;"></span>
                    </div>
                    <div class="search-bar">
                        <input 
                            type="text" 
                            id="ideiaSearch" 
                            class="search-input" 
                            placeholder="Buscar por título, cliente ou descrição..."
                            onkeyup="filterIdeias()"
                        >
                        <select id="ideiaClienteFilter" class="form-input" style="width: 200px;" onchange="filterIdeias()">
                            <option value="">Todos os clientes</option>
                        </select>
                        <select id="ideiaStatusFilter" class="form-input" style="width: 180px;" onchange="filterIdeias()">
                            <option value="">Todos os status</option>
                            <option value="nova">Nova</option>
                            <option value="em_analise">Em Análise</option>
                            <option value="aprovada">Aprovada</option>
                            <option value="rejeitada">Rejeitada</option>
                            <option value="implementada">Implementada</option>
                        </select>
                        <select id="ideiaCategoriaFilter" class="form-input" style="width: 180px;" onchange="filterIdeias()">
                            <option value="">Todas as categorias</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Operacional">Operacional</option>
                            <option value="Tecnologia">Tecnologia</option>
                            <option value="Estratégia">Estratégia</option>
                            <option value="Vendas">Vendas</option>
                            <option value="Atendimento">Atendimento</option>
                            <option value="Outro">Outro</option>
                        </select>
                        <select id="ideiaPrioridadeFilter" class="form-input" style="width: 150px;" onchange="filterIdeias()">
                            <option value="">Todas as prioridades</option>
                            <option value="baixa">Baixa</option>
                            <option value="media">Média</option>
                            <option value="alta">Alta</option>
                        </select>
                    </div>

                    <div class="table-container">
                        <div id="ideiasLoading" class="loading active">
                            <div class="spinner"></div>
                            <p>Carregando ideias...</p>
                        </div>
                        <table id="ideiasTable" style="display: none;">
                            <thead>
                                <tr>
                                    <th style="width: 40px;">
                                        <input type="checkbox" id="selectAllIdeiasHeader" onchange="toggleSelectAllIdeias()" style="width: 18px; height: 18px; cursor: pointer;">
                                    </th>
                                    <th>Título</th>
                                    <th>Cliente</th>
                                    <th>Categoria</th>
                                    <th>Prioridade</th>
                                    <th>Status</th>
                                    <th>Data</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="ideiasTableBody">
                            </tbody>
                        </table>
                        <div id="ideiasEmpty" class="empty-state" style="display: none;">
                            Nenhuma ideia encontrada. Clique em "+ Nova Ideia" para começar!
                        </div>
                    </div>
                </div>
            </div>

            <!-- Precificação Content -->
            <div id="precificacaoContent" class="page-content" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <div>
                        <h1 class="page-title">💵 Precificação</h1>
                        <p class="page-subtitle">Gerencie sua tabela de preços e calcule valores de forma inteligente</p>
                    </div>
                    <button class="btn btn-primary" onclick="openPrecificacaoModal()">+ Novo Serviço</button>
                </div>

                <!-- Calculadora de Preços -->
                <div class="section-card" style="margin-bottom: 24px;">
                    <h2 class="section-title">🧮 Calculadora de Preços</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 16px;">
                        <div>
                            <label class="form-label">Método de Precificação</label>
                            <select id="calcMetodo" class="form-input" onchange="atualizarCalculadora()">
                                <option value="hora">Por Hora</option>
                                <option value="projeto">Por Projeto</option>
                                <option value="valor">Por Valor Agregado</option>
                                <option value="custo">Custo + Margem</option>
                            </select>
                        </div>
                        <div id="calcCampo1">
                            <label class="form-label" id="calcLabel1">Valor por Hora (R$)</label>
                            <input type="number" id="calcValor1" class="form-input" step="0.01" min="0" placeholder="0.00" oninput="calcularPreco()">
                        </div>
                        <div id="calcCampo2">
                            <label class="form-label" id="calcLabel2">Horas Estimadas</label>
                            <input type="number" id="calcValor2" class="form-input" step="0.01" min="0" placeholder="0" oninput="calcularPreco()">
                        </div>
                    </div>
                    <div style="margin-top: 20px; padding: 20px; background: var(--tertiary); border-radius: 8px; border: 2px solid var(--primary);">
                        <div style="display: flex; justify-content: space-between; align-items: center;">
                            <div>
                                <div style="color: var(--text-gray); font-size: 14px; margin-bottom: 4px;">Preço Calculado</div>
                                <div id="calcResultado" style="font-size: 32px; font-weight: 700; color: var(--primary);">R$ 0,00</div>
                            </div>
                            <div style="text-align: right;">
                                <div style="color: var(--text-gray); font-size: 12px; margin-bottom: 4px;" id="calcDetalhes"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Tabela de Precificação -->
                <div class="section-card">
                    <div class="search-bar">
                        <input 
                            type="text" 
                            id="precificacaoSearch" 
                            class="search-input" 
                            placeholder="Buscar por nome do serviço..."
                            onkeyup="filterPrecificacao()"
                        >
                        <select id="precificacaoCategoriaFilter" class="form-input" style="width: 200px;" onchange="filterPrecificacao()">
                            <option value="">Todas as categorias</option>
                            <option value="desenvolvimento">Desenvolvimento</option>
                            <option value="design">Design</option>
                            <option value="marketing">Marketing</option>
                            <option value="consultoria">Consultoria</option>
                            <option value="suporte">Suporte</option>
                            <option value="outro">Outro</option>
                        </select>
                        <select id="precificacaoTipoFilter" class="form-input" style="width: 200px;" onchange="filterPrecificacao()">
                            <option value="">Todos os tipos</option>
                            <option value="hora">Por Hora</option>
                            <option value="projeto">Por Projeto</option>
                            <option value="valor">Por Valor</option>
                            <option value="custo">Custo + Margem</option>
                        </select>
                    </div>

                    <div class="table-container">
                        <div id="precificacaoLoading" class="loading active">
                            <div class="spinner"></div>
                            <p>Carregando tabela de precificação...</p>
                        </div>
                        <table id="precificacaoTable" style="display: none;">
                            <thead>
                                <tr>
                                    <th>Serviço</th>
                                    <th>Categoria</th>
                                    <th>Tipo</th>
                                    <th>Preço Base</th>
                                    <th>Preço Mínimo</th>
                                    <th>Preço Máximo</th>
                                    <th>Margem (%)</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="precificacaoTableBody">
                            </tbody>
                        </table>
                        <div id="precificacaoEmpty" class="empty-state" style="display: none;">
                            Nenhum serviço cadastrado. Clique em "+ Novo Serviço" para começar!
                        </div>
                    </div>
                </div>

                <!-- Guia de Precificação -->
                <div class="section-card" style="margin-top: 24px;">
                    <h2 class="section-title">📚 Guia de Precificação</h2>
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 16px;">
                        <div style="background: var(--tertiary); padding: 16px; border-radius: 8px; border-left: 4px solid var(--primary);">
                            <h3 style="color: var(--primary); margin-bottom: 8px; font-size: 16px;">💰 Por Hora</h3>
                            <p style="color: var(--text-gray); font-size: 13px; line-height: 1.6;">
                                Ideal para trabalhos com tempo variável. Calcule: (Valor/Hora × Horas) + Margem de segurança (20-30%).
                            </p>
                        </div>
                        <div style="background: var(--tertiary); padding: 16px; border-radius: 8px; border-left: 4px solid var(--success);">
                            <h3 style="color: var(--success); margin-bottom: 8px; font-size: 16px;">📦 Por Projeto</h3>
                            <p style="color: var(--text-gray); font-size: 13px; line-height: 1.6;">
                                Valor fixo por projeto completo. Considere complexidade, prazo e valor agregado ao cliente.
                            </p>
                        </div>
                        <div style="background: var(--tertiary); padding: 16px; border-radius: 8px; border-left: 4px solid var(--warning);">
                            <h3 style="color: var(--warning); margin-bottom: 8px; font-size: 16px;">💎 Por Valor Agregado</h3>
                            <p style="color: var(--text-gray); font-size: 13px; line-height: 1.6;">
                                Preço baseado no valor que o serviço gera para o cliente. Ideal para projetos estratégicos.
                            </p>
                        </div>
                        <div style="background: var(--tertiary); padding: 16px; border-radius: 8px; border-left: 4px solid #3b82f6;">
                            <h3 style="color: #3b82f6; margin-bottom: 8px; font-size: 16px;">📊 Custo + Margem</h3>
                            <p style="color: var(--text-gray); font-size: 13px; line-height: 1.6;">
                                (Custos Diretos + Custos Indiretos) × (1 + Margem%). Margem recomendada: 50-100%.
                            </p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Templates de Mensagens Content -->
            <div id="templatesContent" class="page-content" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
                    <div>
                        <h1 class="page-title">📝 Templates de Mensagens</h1>
                        <p class="page-subtitle">Gerencie templates de mensagens para WhatsApp e comunicação</p>
                    </div>
                    <button class="btn btn-primary" onclick="openTemplateModal()">+ Novo Template</button>
                </div>

                <div class="section-card">
                    <div class="search-bar">
                        <input 
                            type="text" 
                            id="templateSearch" 
                            class="search-input" 
                            placeholder="Buscar por nome, tipo ou categoria..."
                            onkeyup="filterTemplates()"
                        >
                        <select id="templateTipoFilter" class="form-input" style="width: 200px;" onchange="filterTemplates()">
                            <option value="">Todos os tipos</option>
                            <option value="orcamento">Orçamento</option>
                            <option value="cobranca">Cobrança</option>
                            <option value="followup">Follow-up</option>
                            <option value="personalizado">Personalizado</option>
                        </select>
                        <select id="templateCategoriaFilter" class="form-input" style="width: 200px;" onchange="filterTemplates()">
                            <option value="">Todas as categorias</option>
                            <option value="comercial">Comercial</option>
                            <option value="financeiro">Financeiro</option>
                            <option value="projetos">Projetos</option>
                            <option value="atendimento">Atendimento</option>
                        </select>
                    </div>

                    <div class="table-container">
                        <div id="templatesLoading" class="loading active">
                            <div class="spinner"></div>
                            <p>Carregando templates...</p>
                        </div>
                        <table id="templatesTable" style="display: none;">
                            <thead>
                                <tr>
                                    <th>Nome</th>
                                    <th>Tipo</th>
                                    <th>Categoria</th>
                                    <th>Mensagem (Preview)</th>
                                    <th>Status</th>
                                    <th>Ações</th>
                                </tr>
                            </thead>
                            <tbody id="templatesTableBody">
                            </tbody>
                        </table>
                        <div id="templatesEmpty" class="empty-state" style="display: none;">
                            Nenhum template encontrado. Clique em "+ Novo Template" para começar!
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Cliente -->
    <div id="clienteModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="clienteModalTitle">Novo Cliente</h2>
                <button class="btn-close" onclick="closeClienteModal()">&times;</button>
            </div>
            <form id="clienteForm">
                <input type="hidden" id="clienteId">
                
                <div class="form-group">
                    <label class="form-label">Nome *</label>
                    <input type="text" id="clienteNome" class="form-input" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Empresa</label>
                        <input type="text" id="clienteEmpresa" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Email *</label>
                        <input type="email" id="clienteEmail" class="form-input" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Telefone</label>
                        <input type="text" id="clienteTelefone" class="form-input" placeholder="(00) 00000-0000">
                    </div>
                    <div class="form-group">
                        <label class="form-label">WhatsApp</label>
                        <input type="text" id="clienteWhatsapp" class="form-input" placeholder="(00) 00000-0000">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">CPF/CNPJ</label>
                        <input type="text" id="clienteCpfCnpj" class="form-input" placeholder="000.000.000-00 ou 00.000.000/0000-00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Segmento</label>
                        <input type="text" id="clienteSegmento" class="form-input" placeholder="Ex: Distribuidor, Varejo, Serviços">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Endereço Completo</label>
                    <input type="text" id="clienteEndereco" class="form-input" placeholder="Rua, número, complemento">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Cidade</label>
                        <input type="text" id="clienteCidade" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Estado</label>
                        <select id="clienteEstado" class="form-input">
                            <option value="">Selecione</option>
                            <option value="AC">Acre</option>
                            <option value="AL">Alagoas</option>
                            <option value="AP">Amapá</option>
                            <option value="AM">Amazonas</option>
                            <option value="BA">Bahia</option>
                            <option value="CE">Ceará</option>
                            <option value="DF">Distrito Federal</option>
                            <option value="ES">Espírito Santo</option>
                            <option value="GO">Goiás</option>
                            <option value="MA">Maranhão</option>
                            <option value="MT">Mato Grosso</option>
                            <option value="MS">Mato Grosso do Sul</option>
                            <option value="MG">Minas Gerais</option>
                            <option value="PA">Pará</option>
                            <option value="PB">Paraíba</option>
                            <option value="PR">Paraná</option>
                            <option value="PE">Pernambuco</option>
                            <option value="PI">Piauí</option>
                            <option value="RJ">Rio de Janeiro</option>
                            <option value="RN">Rio Grande do Norte</option>
                            <option value="RS">Rio Grande do Sul</option>
                            <option value="RO">Rondônia</option>
                            <option value="RR">Roraima</option>
                            <option value="SC">Santa Catarina</option>
                            <option value="SP">São Paulo</option>
                            <option value="SE">Sergipe</option>
                            <option value="TO">Tocantins</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">CEP</label>
                        <input type="text" id="clienteCep" class="form-input" placeholder="00000-000">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Data de Cadastro</label>
                        <input type="date" id="clienteDataCadastro" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Origem do Cliente</label>
                        <select id="clienteOrigem" class="form-input">
                            <option value="">Selecione</option>
                            <option value="indicacao">Indicação</option>
                            <option value="google">Google</option>
                            <option value="facebook">Facebook</option>
                            <option value="instagram">Instagram</option>
                            <option value="linkedin">LinkedIn</option>
                            <option value="site">Site próprio</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select id="clienteStatus" class="form-input">
                            <option value="ativo">Ativo</option>
                            <option value="inativo">Inativo</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Observações</label>
                    <textarea id="clienteObservacoes" class="form-input" rows="4" style="resize: vertical;"></textarea>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeClienteModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Detalhes Cliente -->
    <div id="clienteDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">Detalhes do Cliente</h2>
                <button class="btn-close" onclick="closeClienteDetailsModal()">&times;</button>
            </div>
            <div id="clienteDetailsContent" style="color: var(--text);">
                <!-- Conteúdo será preenchido dinamicamente -->
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeClienteDetailsModal()">Fechar</button>
                <button type="button" class="btn btn-primary" id="editFromDetailsBtn" onclick="">Editar</button>
                <button type="button" class="btn btn-danger" id="deleteFromDetailsBtn" onclick="">Excluir</button>
            </div>
        </div>
    </div>

    <!-- Modal Projeto -->
    <div id="projetoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="projetoModalTitle">Novo Projeto</h2>
                <button class="btn-close" onclick="closeProjetoModal()">&times;</button>
            </div>
            <form id="projetoForm">
                <input type="hidden" id="projetoId">
                
                <div class="form-group">
                    <label class="form-label">Nome do Projeto *</label>
                    <input type="text" id="projetoNome" class="form-input" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Cliente *</label>
                        <select id="projetoClienteId" class="form-input" required>
                            <option value="">Selecione um cliente</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status *</label>
                        <select id="projetoStatus" class="form-input" required>
                            <option value="planejamento">Planejamento</option>
                            <option value="em_andamento">Em Andamento</option>
                            <option value="pausado">Pausado</option>
                            <option value="concluido">Concluído</option>
                            <option value="cancelado">Cancelado</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Prioridade</label>
                        <select id="projetoPrioridade" class="form-input">
                            <option value="">Selecione a prioridade</option>
                            <option value="baixa">Baixa</option>
                            <option value="media">Média</option>
                            <option value="alta">Alta</option>
                            <option value="urgente">Urgente</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Responsável</label>
                        <select id="projetoResponsavelId" class="form-input">
                            <option value="">Selecione um responsável</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Data de Início</label>
                        <input type="date" id="projetoDataInicio" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Data Prevista de Conclusão</label>
                        <input type="date" id="projetoDataPrevista" class="form-input">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Data de Conclusão</label>
                        <input type="date" id="projetoDataConclusao" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Valor do Projeto (R$)</label>
                        <input type="number" id="projetoValor" class="form-input" step="0.01" min="0" placeholder="0.00">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Tags/Categorias</label>
                    <input type="text" id="projetoTags" class="form-input" placeholder="Ex: urgente, site, e-commerce (separadas por vírgula)">
                    <small style="color: var(--text-gray); font-size: 12px; margin-top: 4px; display: block;">Separe as tags por vírgula</small>
                </div>

                <div class="form-group">
                    <label class="form-label">Descrição</label>
                    <textarea id="projetoDescricao" class="form-input" rows="4" style="resize: vertical;" placeholder="Descreva o projeto..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Observações</label>
                    <textarea id="projetoObservacoes" class="form-input" rows="3" style="resize: vertical;" placeholder="Observações adicionais..."></textarea>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeProjetoModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Detalhes Projeto -->
    <div id="projetoDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">Detalhes do Projeto</h2>
                <button class="btn-close" onclick="closeProjetoDetailsModal()">&times;</button>
            </div>
            <div id="projetoDetailsContent" style="color: var(--text);">
                <!-- Conteúdo será preenchido dinamicamente -->
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeProjetoDetailsModal()">Fechar</button>
                <button type="button" class="btn btn-primary" id="editProjetoFromDetailsBtn" onclick="">Editar</button>
                <button type="button" class="btn btn-primary" id="gerarDocumentoFinalizacaoBtn" onclick="" style="background: var(--success); border-color: var(--success);">📄 Gerar Documento de Finalização</button>
                <button type="button" class="btn btn-danger" id="deleteProjetoFromDetailsBtn" onclick="">Excluir</button>
            </div>
        </div>
    </div>

    <!-- Modal Orçamento -->
    <div id="orcamentoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="orcamentoModalTitle">Novo Orçamento</h2>
                <button class="btn-close" onclick="closeOrcamentoModal()">&times;</button>
            </div>
            <form id="orcamentoForm">
                <input type="hidden" id="orcamentoId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Número do Orçamento</label>
                        <input type="text" id="orcamentoNumero" class="form-input" placeholder="Gerado automaticamente" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cliente *</label>
                        <select id="orcamentoClienteId" class="form-input" required>
                            <option value="">Selecione um cliente</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Data do Orçamento *</label>
                        <input type="date" id="orcamentoData" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Validade (dias) *</label>
                        <input type="number" id="orcamentoValidade" class="form-input" min="1" value="30" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label" style="margin-bottom: 12px; display: block;">Serviços a serem Oferecidos</label>
                    <div class="checkbox-group" id="orcamentoServicosContainer" style="background: var(--tertiary); padding: 16px; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1); max-height: 400px; overflow-y: auto;">
                        <!-- Automação -->
                        <div class="servico-item">
                            <div class="servico-main">
                                <input type="checkbox" id="orcamentoServicoAutomacao" value="automacao" onchange="toggleSubmenu('orcamento', 'automacao')">
                                <label for="orcamentoServicoAutomacao" style="font-weight: 600;">Automação</label>
                            </div>
                            <div class="servico-submenu" id="orcamentoSubmenuAutomacao">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoAutomacaoWhatsapp" value="automacao_whatsapp" onchange="adicionarServicoAoOrcamento('automacao_whatsapp', 'Automação - WhatsApp')">
                                    <label for="orcamentoAutomacaoWhatsapp">WhatsApp</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoAutomacaoFacebook" value="automacao_facebook" onchange="adicionarServicoAoOrcamento('automacao_facebook', 'Automação - Facebook')">
                                    <label for="orcamentoAutomacaoFacebook">Facebook</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoAutomacaoInstagram" value="automacao_instagram" onchange="adicionarServicoAoOrcamento('automacao_instagram', 'Automação - Instagram')">
                                    <label for="orcamentoAutomacaoInstagram">Instagram</label>
                                </div>
                            </div>
                        </div>

                        <!-- Site -->
                        <div class="servico-item">
                            <div class="servico-main">
                                <input type="checkbox" id="orcamentoServicoSite" value="site" onchange="toggleSubmenu('orcamento', 'site')">
                                <label for="orcamentoServicoSite" style="font-weight: 600;">Site</label>
                            </div>
                            <div class="servico-submenu" id="orcamentoSubmenuSite">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoSiteCriacao" value="site_criacao" onchange="adicionarServicoAoOrcamento('site_criacao', 'Site - Criação')">
                                    <label for="orcamentoSiteCriacao">Criação</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoSitePersonalizacao" value="site_personalizacao" onchange="adicionarServicoAoOrcamento('site_personalizacao', 'Site - Personalização')">
                                    <label for="orcamentoSitePersonalizacao">Personalização</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoSitePaginaCaptura" value="site_pagina_captura" onchange="adicionarServicoAoOrcamento('site_pagina_captura', 'Site - Página de Captura')">
                                    <label for="orcamentoSitePaginaCaptura">Página de Captura</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoSiteEcommerce" value="site_ecommerce" onchange="adicionarServicoAoOrcamento('site_ecommerce', 'Site - E-commerce')">
                                    <label for="orcamentoSiteEcommerce">E-commerce</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoSiteLandingPage" value="site_landing_page" onchange="adicionarServicoAoOrcamento('site_landing_page', 'Site - Landing Page')">
                                    <label for="orcamentoSiteLandingPage">Landing Page</label>
                                </div>
                            </div>
                        </div>

                        <!-- Tráfego -->
                        <div class="servico-item">
                            <div class="servico-main">
                                <input type="checkbox" id="orcamentoServicoTrafego" value="trafego" onchange="toggleSubmenu('orcamento', 'trafego')">
                                <label for="orcamentoServicoTrafego" style="font-weight: 600;">Tráfego</label>
                            </div>
                            <div class="servico-submenu" id="orcamentoSubmenuTrafego">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoTrafegoMetaAds" value="trafego_meta_ads" onchange="adicionarServicoAoOrcamento('trafego_meta_ads', 'Tráfego - Configuração Meta Ads')">
                                    <label for="orcamentoTrafegoMetaAds">Configuração Meta Ads</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoTrafegoGoogleAds" value="trafego_google_ads" onchange="adicionarServicoAoOrcamento('trafego_google_ads', 'Tráfego - Configuração Google Ads')">
                                    <label for="orcamentoTrafegoGoogleAds">Configuração Google Ads</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoTrafegoBM" value="trafego_bm" onchange="adicionarServicoAoOrcamento('trafego_bm', 'Tráfego - Configuração BM')">
                                    <label for="orcamentoTrafegoBM">Configuração BM (Business Manager)</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoTrafegoCriacaoCampanha" value="trafego_criacao_campanha" onchange="adicionarServicoAoOrcamento('trafego_criacao_campanha', 'Tráfego - Criação de Campanha')">
                                    <label for="orcamentoTrafegoCriacaoCampanha">Criação de Campanha</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoTrafegoOtimizacao" value="trafego_otimizacao" onchange="adicionarServicoAoOrcamento('trafego_otimizacao', 'Tráfego - Otimização de Campanhas')">
                                    <label for="orcamentoTrafegoOtimizacao">Otimização de Campanhas</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoTrafegoRemarketing" value="trafego_remarketing" onchange="adicionarServicoAoOrcamento('trafego_remarketing', 'Tráfego - Remarketing')">
                                    <label for="orcamentoTrafegoRemarketing">Remarketing</label>
                                </div>
                            </div>
                        </div>

                        <!-- Design -->
                        <div class="servico-item">
                            <div class="servico-main">
                                <input type="checkbox" id="orcamentoServicoDesign" value="design" onchange="toggleSubmenu('orcamento', 'design')">
                                <label for="orcamentoServicoDesign" style="font-weight: 600;">Design</label>
                            </div>
                            <div class="servico-submenu" id="orcamentoSubmenuDesign">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoDesignCriacaoPost" value="design_criacao_post" onchange="adicionarServicoAoOrcamento('design_criacao_post', 'Design - Criação de Post')">
                                    <label for="orcamentoDesignCriacaoPost">Criação de Post</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoDesignCriacaoStories" value="design_criacao_stories" onchange="adicionarServicoAoOrcamento('design_criacao_stories', 'Design - Criação de Stories')">
                                    <label for="orcamentoDesignCriacaoStories">Criação de Stories</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoDesignCriacaoFotosIA" value="design_criacao_fotos_ia" onchange="adicionarServicoAoOrcamento('design_criacao_fotos_ia', 'Design - Criação de Fotos com IA')">
                                    <label for="orcamentoDesignCriacaoFotosIA">Criação de Fotos com IA</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoDesignIdentidadeVisual" value="design_identidade_visual" onchange="adicionarServicoAoOrcamento('design_identidade_visual', 'Design - Identidade Visual')">
                                    <label for="orcamentoDesignIdentidadeVisual">Identidade Visual</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoDesignLogo" value="design_logo" onchange="adicionarServicoAoOrcamento('design_logo', 'Design - Criação de Logo')">
                                    <label for="orcamentoDesignLogo">Criação de Logo</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoDesignBanner" value="design_banner" onchange="adicionarServicoAoOrcamento('design_banner', 'Design - Banners e Materiais')">
                                    <label for="orcamentoDesignBanner">Banners e Materiais</label>
                                </div>
                            </div>
                        </div>

                        <!-- Redes Sociais -->
                        <div class="servico-item">
                            <div class="servico-main">
                                <input type="checkbox" id="orcamentoServicoRedesSociais" value="redes_sociais" onchange="toggleSubmenu('orcamento', 'redes_sociais')">
                                <label for="orcamentoServicoRedesSociais" style="font-weight: 600;">Redes Sociais</label>
                            </div>
                            <div class="servico-submenu" id="orcamentoSubmenuRedesSociais">
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoRedesGestao" value="redes_gestao" onchange="adicionarServicoAoOrcamento('redes_gestao', 'Redes Sociais - Gestão')">
                                    <label for="orcamentoRedesGestao">Gestão de Redes Sociais</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoRedesCriacao" value="redes_criacao" onchange="adicionarServicoAoOrcamento('redes_criacao', 'Redes Sociais - Criação')">
                                    <label for="orcamentoRedesCriacao">Criação de Redes Sociais</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoRedesPlanejamento" value="redes_planejamento" onchange="adicionarServicoAoOrcamento('redes_planejamento', 'Redes Sociais - Planejamento')">
                                    <label for="orcamentoRedesPlanejamento">Planejamento de Conteúdo</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoRedesModeracao" value="redes_moderacao" onchange="adicionarServicoAoOrcamento('redes_moderacao', 'Redes Sociais - Moderação')">
                                    <label for="orcamentoRedesModeracao">Moderação de Comentários</label>
                                </div>
                                <div class="checkbox-item">
                                    <input type="checkbox" id="orcamentoRedesAnalise" value="redes_analise" onchange="adicionarServicoAoOrcamento('redes_analise', 'Redes Sociais - Análise')">
                                    <label for="orcamentoRedesAnalise">Análise de Métricas</label>
                                </div>
                            </div>
                        </div>
                    </div>
                    <small style="color: var(--text-gray); font-size: 12px; margin-top: 8px; display: block;">Selecione os serviços que serão oferecidos neste orçamento. Ao marcar um serviço, ele será adicionado automaticamente aos itens do orçamento.</small>
                </div>

                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 12px;">
                        <label class="form-label">Itens do Orçamento *</label>
                        <button type="button" class="btn btn-secondary" onclick="adicionarItemOrcamento()" style="padding: 6px 12px; font-size: 12px;">+ Adicionar Item Manual</button>
                    </div>
                    <div style="overflow-x: auto;">
                        <table id="orcamentoItensTable" style="width: 100%; border-collapse: collapse;">
                            <thead>
                                <tr style="background: var(--tertiary);">
                                    <th style="padding: 8px; text-align: left; font-size: 12px; color: var(--text-gray);">Descrição</th>
                                    <th style="padding: 8px; text-align: center; font-size: 12px; color: var(--text-gray); width: 80px;">Qtd</th>
                                    <th style="padding: 8px; text-align: right; font-size: 12px; color: var(--text-gray); width: 100px;">Valor Unit.</th>
                                    <th style="padding: 8px; text-align: right; font-size: 12px; color: var(--text-gray); width: 80px;">Desc. %</th>
                                    <th style="padding: 8px; text-align: right; font-size: 12px; color: var(--text-gray); width: 120px;">Subtotal</th>
                                    <th style="padding: 8px; text-align: center; font-size: 12px; color: var(--text-gray); width: 50px;">Ações</th>
                                </tr>
                            </thead>
                            <tbody id="orcamentoItensBody">
                                <tr>
                                    <td colspan="6" style="padding: 20px; text-align: center; color: var(--text-gray); font-style: italic;">
                                        Nenhum item adicionado. Clique em "Adicionar Item" para começar.
                                    </td>
                                </tr>
                            </tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="4" style="padding: 8px; text-align: right; font-weight: 600;">Subtotal:</td>
                                    <td id="orcamentoSubtotal" style="padding: 8px; text-align: right; font-weight: 600;">R$ 0,00</td>
                                    <td></td>
                                </tr>
                                <tr>
                                    <td colspan="4" style="padding: 8px; text-align: right;">
                                        <input type="number" id="orcamentoDescontoGeral" class="form-input" step="0.01" min="0" placeholder="0.00" style="width: 100px; display: inline-block; margin-left: 8px;" onchange="calcularTotalOrcamento()">
                                        <label style="display: inline-block; margin-left: 4px;">Desconto Geral (R$):</label>
                                    </td>
                                    <td id="orcamentoDescontoGeralValor" style="padding: 8px; text-align: right; color: var(--danger);">R$ 0,00</td>
                                    <td></td>
                                </tr>
                                <tr style="border-top: 2px solid var(--primary);">
                                    <td colspan="4" style="padding: 8px; text-align: right; font-weight: 700; font-size: 16px;">Total:</td>
                                    <td id="orcamentoValorTotal" style="padding: 8px; text-align: right; font-weight: 700; font-size: 16px; color: var(--primary);">R$ 0,00</td>
                                    <td></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                    <input type="hidden" id="orcamentoValor" value="0">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Status *</label>
                        <select id="orcamentoStatus" class="form-input" required>
                            <option value="rascunho">Rascunho</option>
                            <option value="enviado">Enviado</option>
                            <option value="aprovado">Aprovado</option>
                            <option value="rejeitado">Rejeitado</option>
                            <option value="expirado">Expirado</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Condições de Pagamento</label>
                    <textarea id="orcamentoCondicoesPagamento" class="form-input" rows="3" style="resize: vertical;" placeholder="Ex: Pagamento à vista com 5% de desconto, ou parcelado em até 3x sem juros..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Forma de Pagamento</label>
                    <div class="checkbox-group" style="background: var(--tertiary); padding: 12px; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1);">
                        <div class="checkbox-item">
                            <input type="checkbox" id="orcamentoFormaPagamentoCartao" value="Cartão de Crédito e Débito" onchange="atualizarFormaPagamento()">
                            <label for="orcamentoFormaPagamentoCartao">Cartão de Crédito e Débito</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="orcamentoFormaPagamentoPix" value="PIX" onchange="atualizarFormaPagamento()">
                            <label for="orcamentoFormaPagamentoPix">PIX</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="orcamentoFormaPagamentoDinheiro" value="Dinheiro" onchange="atualizarFormaPagamento()">
                            <label for="orcamentoFormaPagamentoDinheiro">Dinheiro</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="orcamentoFormaPagamentoBoleto" value="Boleto" onchange="atualizarFormaPagamento()">
                            <label for="orcamentoFormaPagamentoBoleto">Boleto</label>
                        </div>
                    </div>
                    <input type="hidden" id="orcamentoFormaPagamento" value="">
                </div>

                <div class="form-group">
                    <label class="form-label">Prazo de Entrega</label>
                    <input type="text" id="orcamentoPrazoEntrega" class="form-input" placeholder="Ex: 30 dias corridos após aprovação...">
                </div>

                <div class="form-group">
                    <label class="form-label">Observações</label>
                    <textarea id="orcamentoObservacoes" class="form-input" rows="3" style="resize: vertical;" placeholder="Observações adicionais..."></textarea>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeOrcamentoModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Detalhes Orçamento -->
    <div id="orcamentoDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">Detalhes do Orçamento</h2>
                <button class="btn-close" onclick="closeOrcamentoDetailsModal()">&times;</button>
            </div>
            <div id="orcamentoDetailsContent" style="color: var(--text);">
                <!-- Conteúdo será preenchido dinamicamente -->
            </div>
            <div class="modal-actions">
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button type="button" class="btn btn-secondary" onclick="closeOrcamentoDetailsModal()">Fechar</button>
                    <button type="button" class="btn btn-primary" id="downloadPDFBtn" style="background: var(--danger); border-color: var(--danger);">📄 Baixar PDF</button>
                    <button type="button" class="btn btn-primary" id="gerarLinkPublicoBtn" style="background: var(--primary); border-color: var(--primary);">🔗 Gerar Link Público</button>
                    <button type="button" class="btn btn-primary" id="copiarLinkBtn" style="background: var(--tertiary); border-color: var(--tertiary); display: none;">📋 Copiar Link</button>
                    <button type="button" class="btn btn-primary" id="enviarWhatsAppBtn" style="background: #25D366; border-color: #25D366; display: none;">💬 Enviar por WhatsApp</button>
                    <button type="button" class="btn btn-primary" id="aprovarOrcamentoBtn" style="background: var(--success); border-color: var(--success); display: none;">✓ Aprovar</button>
                    <button type="button" class="btn btn-primary" id="recusarOrcamentoBtn" style="background: var(--danger); border-color: var(--danger); display: none;">✗ Recusar</button>
                    <button type="button" class="btn btn-primary" id="criarProjetoBtn" style="background: var(--primary); border-color: var(--primary); display: none;">📁 Criar Projeto</button>
                    <button type="button" class="btn btn-primary" id="editOrcamentoFromDetailsBtn" onclick="">Editar</button>
                    <button type="button" class="btn btn-danger" id="deleteOrcamentoFromDetailsBtn" onclick="">Excluir</button>
                </div>
            </div>
            <!-- Área para exibir link público -->
            <div id="linkPublicoContainer" style="display: none; margin-top: 16px; padding: 16px; background: var(--tertiary); border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <label style="font-weight: 600; color: var(--text);">Link Público:</label>
                    <span id="linkStatusBadge" class="badge badge-aprovado" style="font-size: 11px;">Ativo</span>
                </div>
                <input type="text" id="linkPublicoInput" readonly style="width: 100%; padding: 8px; background: var(--secondary); border: 1px solid rgba(255, 255, 255, 0.2); border-radius: 4px; color: var(--text); font-size: 12px; margin-bottom: 8px;">
                <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                    <button type="button" class="btn btn-secondary" onclick="copiarLinkPublico()" style="padding: 6px 12px; font-size: 12px;">📋 Copiar Link</button>
                    <button type="button" class="btn btn-primary" onclick="enviarLinkPorWhatsApp()" style="padding: 6px 12px; font-size: 12px; background: #25D366; border-color: #25D366;">💬 Enviar por WhatsApp</button>
                    <button type="button" class="btn btn-secondary" onclick="desativarLinkPublico()" style="padding: 6px 12px; font-size: 12px; background: var(--danger); border-color: var(--danger);">🚫 Desativar Link</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Receita -->
    <div id="receitaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="receitaModalTitle">Nova Receita</h2>
                <button class="btn-close" onclick="closeReceitaModal()">&times;</button>
            </div>
            <form id="receitaForm">
                <input type="hidden" id="receitaId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Cliente *</label>
                        <select id="receitaClienteId" class="form-input" required>
                            <option value="">Selecione um cliente</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Projeto (opcional)</label>
                        <select id="receitaProjetoId" class="form-input">
                            <option value="">Nenhum</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Orçamento (opcional)</label>
                        <select id="receitaOrcamentoId" class="form-input">
                            <option value="">Nenhum</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status *</label>
                        <select id="receitaStatus" class="form-input" required>
                            <option value="pendente">Pendente</option>
                            <option value="recebido">Recebido</option>
                            <option value="atrasado">Atrasado</option>
                            <option value="cancelado">Cancelado</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Descrição *</label>
                    <input type="text" id="receitaDescricao" class="form-input" placeholder="Ex: Pagamento mensalidade Janeiro" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Valor *</label>
                        <input type="number" id="receitaValor" class="form-input" step="0.01" min="0" placeholder="0.00" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Forma de Pagamento</label>
                        <select id="receitaFormaPagamento" class="form-input">
                            <option value="">Selecione</option>
                            <option value="PIX">PIX</option>
                            <option value="Boleto">Boleto</option>
                            <option value="Cartão de Crédito">Cartão de Crédito</option>
                            <option value="Cartão de Débito">Cartão de Débito</option>
                            <option value="Transferência">Transferência</option>
                            <option value="Dinheiro">Dinheiro</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Data de Vencimento *</label>
                        <input type="date" id="receitaDataVencimento" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Data de Recebimento</label>
                        <input type="date" id="receitaDataRecebimento" class="form-input">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Observações</label>
                    <textarea id="receitaObservacoes" class="form-input" rows="3" placeholder="Observações adicionais..."></textarea>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeReceitaModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Despesa -->
    <div id="despesaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="despesaModalTitle">Nova Despesa</h2>
                <button class="btn-close" onclick="closeDespesaModal()">&times;</button>
            </div>
            <form id="despesaForm">
                <input type="hidden" id="despesaId">
                
                <div class="form-group">
                    <label class="form-label">Descrição *</label>
                    <input type="text" id="despesaDescricao" class="form-input" placeholder="Ex: Pagamento de fornecedor X" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Categoria *</label>
                        <select id="despesaCategoria" class="form-input" required>
                            <option value="">Selecione uma categoria</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status *</label>
                        <select id="despesaStatus" class="form-input" required>
                            <option value="pendente">Pendente</option>
                            <option value="pago">Pago</option>
                            <option value="atrasado">Atrasado</option>
                            <option value="cancelado">Cancelado</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Fornecedor</label>
                        <input type="text" id="despesaFornecedor" class="form-input" placeholder="Nome do fornecedor">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Valor *</label>
                        <input type="number" id="despesaValor" class="form-input" step="0.01" min="0" placeholder="0.00" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Forma de Pagamento</label>
                        <select id="despesaFormaPagamento" class="form-input">
                            <option value="">Selecione</option>
                            <option value="PIX">PIX</option>
                            <option value="Boleto">Boleto</option>
                            <option value="Cartão de Crédito">Cartão de Crédito</option>
                            <option value="Cartão de Débito">Cartão de Débito</option>
                            <option value="Transferência">Transferência</option>
                            <option value="Dinheiro">Dinheiro</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Data de Vencimento *</label>
                        <input type="date" id="despesaDataVencimento" class="form-input" required>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Data de Pagamento</label>
                    <input type="date" id="despesaDataPagamento" class="form-input">
                </div>

                <div class="form-group">
                    <label class="form-label">Observações</label>
                    <textarea id="despesaObservacoes" class="form-input" rows="3" placeholder="Observações adicionais..."></textarea>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeDespesaModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Contrato -->
    <div id="contratoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="contratoModalTitle">Novo Contrato</h2>
                <button class="btn-close" onclick="closeContratoModal()">&times;</button>
            </div>
            <form id="contratoForm">
                <input type="hidden" id="contratoId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Número do Contrato</label>
                        <input type="text" id="contratoNumero" class="form-input" placeholder="Gerado automaticamente" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Cliente *</label>
                        <select id="contratoClienteId" class="form-input" required>
                            <option value="">Selecione um cliente</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Projeto (opcional)</label>
                        <select id="contratoProjetoId" class="form-input">
                            <option value="">Nenhum</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Orçamento (opcional)</label>
                        <select id="contratoOrcamentoId" class="form-input">
                            <option value="">Nenhum</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Tipo de Contrato *</label>
                        <select id="contratoTipo" class="form-input" required>
                            <option value="prestacao_servicos">Prestação de Serviços</option>
                            <option value="fornecimento">Fornecimento de Produtos</option>
                            <option value="locacao">Locação</option>
                            <option value="licenciamento">Licenciamento</option>
                            <option value="parceria">Parceria</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status *</label>
                        <select id="contratoStatus" class="form-input" required>
                            <option value="rascunho">Rascunho</option>
                            <option value="aguardando_assinatura">Aguardando Assinatura</option>
                            <option value="ativo">Ativo</option>
                            <option value="vencido">Vencido</option>
                            <option value="renovado">Renovado</option>
                            <option value="cancelado">Cancelado</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Serviços Incluídos *</label>
                    <div class="checkbox-group" style="background: var(--tertiary); padding: 16px; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1); max-height: 200px; overflow-y: auto;">
                        <div class="checkbox-item">
                            <input type="checkbox" id="servicoSite" value="Criação e edição de site" onchange="atualizarObjetoContrato()">
                            <label for="servicoSite">🌐 Criação e edição de site</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="servicoAutomacao" value="Automação para redes sociais" onchange="atualizarObjetoContrato()">
                            <label for="servicoAutomacao">🤖 Automação para redes sociais</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="servicoAgenteIA" value="Criação de agente IA" onchange="atualizarObjetoContrato()">
                            <label for="servicoAgenteIA">🧠 Criação de agente IA</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="servicoPlataforma" value="Desenvolvimento de plataforma própria" onchange="atualizarObjetoContrato()">
                            <label for="servicoPlataforma">💻 Desenvolvimento de plataforma própria</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="servicoMarca" value="Criação de marca digital" onchange="atualizarObjetoContrato()">
                            <label for="servicoMarca">🎨 Criação de marca digital</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="servicoRedes" value="Criação de redes sociais" onchange="atualizarObjetoContrato()">
                            <label for="servicoRedes">📱 Criação de redes sociais</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="servicoSocialMedia" value="Serviço de social media" onchange="atualizarObjetoContrato()">
                            <label for="servicoSocialMedia">📲 Serviço de social media</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="servicoAnalise" value="Análise estratégica" onchange="atualizarObjetoContrato()">
                            <label for="servicoAnalise">📊 Análise estratégica</label>
                        </div>
                    </div>
                    <div style="margin-top: 8px; display: flex; justify-content: space-between; align-items: center;">
                        <small style="color: var(--text-gray); font-size: 12px;">Selecione os serviços que serão incluídos no contrato</small>
                        <button type="button" onclick="abrirTemplatesObjeto()" class="btn" style="width: auto; padding: 6px 12px; font-size: 12px; background: rgba(255, 102, 0, 0.2); border: 1px solid var(--primary); color: var(--primary);">
                            📋 Usar Template
                        </button>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Objeto do Contrato *</label>
                    <textarea id="contratoObjeto" class="form-input" rows="8" placeholder="O objeto será preenchido automaticamente ao selecionar os serviços acima, ou você pode usar um template profissional..." required></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Descrição/Resumo</label>
                    <textarea id="contratoDescricao" class="form-input" rows="3" placeholder="Descrição resumida do contrato..."></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Valor Total *</label>
                        <input type="number" id="contratoValor" class="form-input" step="0.01" min="0" placeholder="0.00" required onchange="calcularParcela()">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Pagamento Parcelado</label>
                        <select id="contratoValorParcelado" class="form-input" onchange="toggleParcelas()">
                            <option value="false">À Vista</option>
                            <option value="true">Parcelado</option>
                        </select>
                    </div>
                </div>

                <div id="parcelasGroup" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Número de Parcelas</label>
                            <input type="number" id="contratoNumeroParcelas" class="form-input" min="1" value="1" onchange="calcularParcela()">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Valor da Parcela</label>
                            <input type="number" id="contratoValorParcela" class="form-input" step="0.01" min="0" placeholder="0.00" readonly>
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Data de Início *</label>
                        <input type="date" id="contratoDataInicio" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Data de Vencimento *</label>
                        <input type="date" id="contratoDataVencimento" class="form-input" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Prazo de Execução (dias)</label>
                        <input type="number" id="contratoPrazoExecucao" class="form-input" min="1" placeholder="Ex: 30">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Data de Assinatura</label>
                        <input type="date" id="contratoDataAssinatura" class="form-input">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Local de Assinatura</label>
                    <input type="text" id="contratoLocalAssinatura" class="form-input" placeholder="Ex: São Paulo, SP">
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Tipo de Pagamento</label>
                        <select id="contratoTipoPagamento" class="form-input" onchange="toggleValorRecorrente()">
                            <option value="unico">Pagamento Único</option>
                            <option value="recorrente">Pagamento Recorrente</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Renovação Automática</label>
                        <select id="contratoRenovacaoAutomatica" class="form-input">
                            <option value="false">Não</option>
                            <option value="true">Sim</option>
                        </select>
                    </div>
                </div>

                <!-- Campos para Pagamento Recorrente -->
                <div id="camposValorRecorrente" style="display: none; background: var(--tertiary); padding: 16px; border-radius: 8px; margin: 16px 0; border: 1px solid rgba(255, 102, 0, 0.3);">
                    <h3 style="color: var(--primary); margin-bottom: 12px; font-size: 16px;">💰 Valores Recorrentes</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Frequência de Cobrança *</label>
                            <select id="contratoFrequenciaRecorrente" class="form-input">
                                <option value="mensal">Mensal</option>
                                <option value="trimestral">Trimestral (3 meses)</option>
                                <option value="semestral">Semestral (6 meses)</option>
                                <option value="anual">Anual (12 meses)</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Valor Recorrente *</label>
                            <input type="number" id="contratoValorRecorrente" class="form-input" step="0.01" min="0" placeholder="0.00">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Data de Início da Cobrança</label>
                            <input type="date" id="contratoDataInicioRecorrente" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Número de Ciclos</label>
                            <input type="number" id="contratoNumeroCiclos" class="form-input" min="1" placeholder="Ilimitado (deixe vazio)">
                            <small style="color: var(--text-gray); font-size: 11px;">Deixe vazio para cobrança ilimitada</small>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Observações para Valores Recorrentes</label>
                        <textarea id="contratoObservacoesRecorrente" class="form-input" rows="4" placeholder="Ex: Valor será reajustado anualmente pelo IPCA. Cobrança automática via cartão de crédito. Cliente pode cancelar com 30 dias de antecedência..."></textarea>
                        <small style="color: var(--text-gray); font-size: 11px;">Informações importantes sobre o pagamento recorrente, reajustes, cancelamento, etc.</small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Período de Renovação (dias)</label>
                        <input type="number" id="contratoPeriodoRenovacao" class="form-input" min="1" placeholder="30" value="30">
                        <small style="color: var(--text-gray); font-size: 11px;">Aplicável apenas se Renovação Automática estiver ativa</small>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Condições de Pagamento *</label>
                    <textarea id="contratoCondicoesPagamento" class="form-input" rows="3" placeholder="Ex: 50% na assinatura, 50% na entrega" required></textarea>
                </div>

                <div style="background: var(--tertiary); padding: 16px; border-radius: 8px; margin: 16px 0; border: 1px solid rgba(255, 255, 255, 0.1);">
                    <h3 style="color: var(--primary); margin-bottom: 12px; font-size: 16px;">📋 Dados da Empresa (Contratado)</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Nome/Razão Social</label>
                            <input type="text" id="contratoContratadoNome" class="form-input" placeholder="Nome da sua empresa">
                        </div>
                        <div class="form-group">
                            <label class="form-label">CNPJ</label>
                            <input type="text" id="contratoContratadoCnpj" class="form-input" placeholder="00.000.000/0000-00">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Endereço Completo</label>
                        <input type="text" id="contratoContratadoEndereco" class="form-input" placeholder="Rua, número, complemento, cidade - estado, CEP">
                    </div>
                </div>

                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <label class="form-label" style="margin-bottom: 0;">Cláusulas Específicas</label>
                        <button type="button" onclick="abrirTemplatesClausulas()" class="btn" style="width: auto; padding: 6px 12px; font-size: 12px; background: rgba(255, 102, 0, 0.2); border: 1px solid var(--primary); color: var(--primary);">
                            📋 Templates
                        </button>
                    </div>
                    <textarea id="contratoClausulas" class="form-input" rows="5" placeholder="Adicione cláusulas específicas do contrato. Use o botão Templates para facilitar..."></textarea>
                </div>

                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <label class="form-label" style="margin-bottom: 0;">Termos e Condições Gerais</label>
                        <button type="button" onclick="abrirTemplatesTermos()" class="btn" style="width: auto; padding: 6px 12px; font-size: 12px; background: rgba(255, 102, 0, 0.2); border: 1px solid var(--primary); color: var(--primary);">
                            📋 Templates
                        </button>
                    </div>
                    <textarea id="contratoTermosCondicoes" class="form-input" rows="4" placeholder="Termos e condições gerais do contrato. Use o botão Templates para facilitar..."></textarea>
                </div>

                <div class="form-group">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                        <label class="form-label" style="margin-bottom: 0;">Penalidades</label>
                        <button type="button" onclick="abrirTemplatesPenalidades()" class="btn" style="width: auto; padding: 6px 12px; font-size: 12px; background: rgba(255, 102, 0, 0.2); border: 1px solid var(--primary); color: var(--primary);">
                            📋 Templates
                        </button>
                    </div>
                    <textarea id="contratoPenalidades" class="form-input" rows="3" placeholder="Descrição de penalidades em caso de descumprimento. Use o botão Templates para facilitar..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Foro (Local para resolução de disputas)</label>
                    <input type="text" id="contratoForo" class="form-input" placeholder="Ex: Comarca de São Paulo, SP">
                </div>

                <div class="form-group">
                    <label class="form-label">Observações</label>
                    <textarea id="contratoObservacoes" class="form-input" rows="3" placeholder="Observações adicionais..."></textarea>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeContratoModal()">Cancelar</button>
                    <button type="button" class="btn" onclick="previewContratoPDF()" style="background: var(--warning); border-color: var(--warning);">👁️ Visualizar PDF</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Templates de Objeto do Contrato -->
    <div id="templatesObjetoModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title">📋 Templates Profissionais - Objeto do Contrato</h2>
                <button class="btn-close" onclick="fecharTemplatesObjeto()">&times;</button>
            </div>
            <div style="padding: 20px; max-height: 70vh; overflow-y: auto;">
                <div style="margin-bottom: 20px; color: var(--text-gray); font-size: 14px;">
                    Selecione um template profissional para preencher automaticamente o campo "Objeto do Contrato". Você pode personalizar o texto após selecionar.
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">
                    <!-- Template 1: Criação e Edição de Site -->
                    <div class="template-card" onclick="aplicarTemplate('criacao-site')" style="background: var(--secondary); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s;">
                        <div style="font-size: 24px; margin-bottom: 12px;">🌐</div>
                        <h3 style="color: var(--primary); margin-bottom: 8px; font-size: 16px;">Criação e Edição de Site</h3>
                        <p style="color: var(--text-gray); font-size: 13px; line-height: 1.5;">Desenvolvimento completo de website responsivo e moderno.</p>
                    </div>

                    <!-- Template 2: Automação para Redes Sociais -->
                    <div class="template-card" onclick="aplicarTemplate('automacao-redes')" style="background: var(--secondary); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s;">
                        <div style="font-size: 24px; margin-bottom: 12px;">🤖</div>
                        <h3 style="color: var(--primary); margin-bottom: 8px; font-size: 16px;">Automação para Redes Sociais</h3>
                        <p style="color: var(--text-gray); font-size: 13px; line-height: 1.5;">Sistemas automatizados para gestão de redes sociais.</p>
                    </div>

                    <!-- Template 3: Criação de Agente IA -->
                    <div class="template-card" onclick="aplicarTemplate('agente-ia')" style="background: var(--secondary); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s;">
                        <div style="font-size: 24px; margin-bottom: 12px;">🧠</div>
                        <h3 style="color: var(--primary); margin-bottom: 8px; font-size: 16px;">Criação de Agente IA</h3>
                        <p style="color: var(--text-gray); font-size: 13px; line-height: 1.5;">Assistente virtual inteligente personalizado.</p>
                    </div>

                    <!-- Template 4: Desenvolvimento de Plataforma -->
                    <div class="template-card" onclick="aplicarTemplate('plataforma-propria')" style="background: var(--secondary); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s;">
                        <div style="font-size: 24px; margin-bottom: 12px;">💻</div>
                        <h3 style="color: var(--primary); margin-bottom: 8px; font-size: 16px;">Desenvolvimento de Plataforma</h3>
                        <p style="color: var(--text-gray); font-size: 13px; line-height: 1.5;">Plataforma digital personalizada e completa.</p>
                    </div>

                    <!-- Template 5: Criação de Marca Digital -->
                    <div class="template-card" onclick="aplicarTemplate('marca-digital')" style="background: var(--secondary); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s;">
                        <div style="font-size: 24px; margin-bottom: 12px;">🎨</div>
                        <h3 style="color: var(--primary); margin-bottom: 8px; font-size: 16px;">Criação de Marca Digital</h3>
                        <p style="color: var(--text-gray); font-size: 13px; line-height: 1.5;">Identidade visual completa e profissional.</p>
                    </div>

                    <!-- Template 6: Social Media Completo -->
                    <div class="template-card" onclick="aplicarTemplate('social-media-completo')" style="background: var(--secondary); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s;">
                        <div style="font-size: 24px; margin-bottom: 12px;">📱</div>
                        <h3 style="color: var(--primary); margin-bottom: 8px; font-size: 16px;">Social Media Completo</h3>
                        <p style="color: var(--text-gray); font-size: 13px; line-height: 1.5;">Gestão completa de redes sociais e conteúdo.</p>
                    </div>

                    <!-- Template 7: Análise Estratégica -->
                    <div class="template-card" onclick="aplicarTemplate('analise-estrategica')" style="background: var(--secondary); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s;">
                        <div style="font-size: 24px; margin-bottom: 12px;">📊</div>
                        <h3 style="color: var(--primary); margin-bottom: 8px; font-size: 16px;">Análise Estratégica</h3>
                        <p style="color: var(--text-gray); font-size: 13px; line-height: 1.5;">Análises detalhadas e recomendações estratégicas.</p>
                    </div>

                    <!-- Template 8: Pacote Completo -->
                    <div class="template-card" onclick="aplicarTemplate('pacote-completo')" style="background: var(--secondary); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s;">
                        <div style="font-size: 24px; margin-bottom: 12px;">🚀</div>
                        <h3 style="color: var(--primary); margin-bottom: 8px; font-size: 16px;">Pacote Completo</h3>
                        <p style="color: var(--text-gray); font-size: 13px; line-height: 1.5;">Todos os serviços em um contrato completo.</p>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="fecharTemplatesObjeto()">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal Templates de Cláusulas -->
    <div id="templatesClausulasModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title">📋 Templates de Cláusulas Específicas</h2>
                <button class="btn-close" onclick="fecharTemplatesClausulas()">&times;</button>
            </div>
            <div style="padding: 20px; max-height: 70vh; overflow-y: auto;">
                <div style="margin-bottom: 20px; color: var(--text-gray); font-size: 14px;">
                    Selecione um template profissional de cláusulas. Você pode personalizar o texto após selecionar.
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">
                    <div class="template-card" onclick="aplicarTemplateClausulas('basico')" style="background: var(--secondary); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s;">
                        <div style="font-size: 24px; margin-bottom: 12px;">📄</div>
                        <h3 style="color: var(--primary); margin-bottom: 8px; font-size: 16px;">Cláusulas Básicas</h3>
                        <p style="color: var(--text-gray); font-size: 13px; line-height: 1.5;">Cláusulas essenciais para contratos de prestação de serviços.</p>
                    </div>

                    <div class="template-card" onclick="aplicarTemplateClausulas('completo')" style="background: var(--secondary); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s;">
                        <div style="font-size: 24px; margin-bottom: 12px;">📑</div>
                        <h3 style="color: var(--primary); margin-bottom: 8px; font-size: 16px;">Cláusulas Completas</h3>
                        <p style="color: var(--text-gray); font-size: 13px; line-height: 1.5;">Conjunto completo de cláusulas profissionais.</p>
                    </div>

                    <div class="template-card" onclick="aplicarTemplateClausulas('recorrente')" style="background: var(--secondary); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s;">
                        <div style="font-size: 24px; margin-bottom: 12px;">🔄</div>
                        <h3 style="color: var(--primary); margin-bottom: 8px; font-size: 16px;">Cláusulas para Recorrentes</h3>
                        <p style="color: var(--text-gray); font-size: 13px; line-height: 1.5;">Cláusulas específicas para contratos recorrentes.</p>
                    </div>

                    <div class="template-card" onclick="aplicarTemplateClausulas('propriedade')" style="background: var(--secondary); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s;">
                        <div style="font-size: 24px; margin-bottom: 12px;">©️</div>
                        <h3 style="color: var(--primary); margin-bottom: 8px; font-size: 16px;">Propriedade Intelectual</h3>
                        <p style="color: var(--text-gray); font-size: 13px; line-height: 1.5;">Cláusulas sobre direitos autorais e propriedade.</p>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="fecharTemplatesClausulas()">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal Templates de Termos e Condições -->
    <div id="templatesTermosModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title">📋 Templates de Termos e Condições</h2>
                <button class="btn-close" onclick="fecharTemplatesTermos()">&times;</button>
            </div>
            <div style="padding: 20px; max-height: 70vh; overflow-y: auto;">
                <div style="margin-bottom: 20px; color: var(--text-gray); font-size: 14px;">
                    Selecione um template profissional de termos e condições. Você pode personalizar o texto após selecionar.
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">
                    <div class="template-card" onclick="aplicarTemplateTermos('basico')" style="background: var(--secondary); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s;">
                        <div style="font-size: 24px; margin-bottom: 12px;">📋</div>
                        <h3 style="color: var(--primary); margin-bottom: 8px; font-size: 16px;">Termos Básicos</h3>
                        <p style="color: var(--text-gray); font-size: 13px; line-height: 1.5;">Termos e condições essenciais.</p>
                    </div>

                    <div class="template-card" onclick="aplicarTemplateTermos('completo')" style="background: var(--secondary); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s;">
                        <div style="font-size: 24px; margin-bottom: 12px;">📚</div>
                        <h3 style="color: var(--primary); margin-bottom: 8px; font-size: 16px;">Termos Completos</h3>
                        <p style="color: var(--text-gray); font-size: 13px; line-height: 1.5;">Conjunto completo de termos e condições.</p>
                    </div>

                    <div class="template-card" onclick="aplicarTemplateTermos('cancelamento')" style="background: var(--secondary); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s;">
                        <div style="font-size: 24px; margin-bottom: 12px;">🚫</div>
                        <h3 style="color: var(--primary); margin-bottom: 8px; font-size: 16px;">Cancelamento e Rescisão</h3>
                        <p style="color: var(--text-gray); font-size: 13px; line-height: 1.5;">Termos sobre cancelamento e rescisão.</p>
                    </div>

                    <div class="template-card" onclick="aplicarTemplateTermos('garantia')" style="background: var(--secondary); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s;">
                        <div style="font-size: 24px; margin-bottom: 12px;">🛡️</div>
                        <h3 style="color: var(--primary); margin-bottom: 8px; font-size: 16px;">Garantias e Suporte</h3>
                        <p style="color: var(--text-gray); font-size: 13px; line-height: 1.5;">Termos sobre garantias e suporte técnico.</p>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="fecharTemplatesTermos()">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal Templates de Penalidades -->
    <div id="templatesPenalidadesModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title">📋 Templates de Penalidades</h2>
                <button class="btn-close" onclick="fecharTemplatesPenalidades()">&times;</button>
            </div>
            <div style="padding: 20px; max-height: 70vh; overflow-y: auto;">
                <div style="margin-bottom: 20px; color: var(--text-gray); font-size: 14px;">
                    Selecione um template profissional de penalidades. Você pode personalizar o texto após selecionar.
                </div>
                
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); gap: 16px;">
                    <div class="template-card" onclick="aplicarTemplatePenalidades('basico')" style="background: var(--secondary); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s;">
                        <div style="font-size: 24px; margin-bottom: 12px;">⚠️</div>
                        <h3 style="color: var(--primary); margin-bottom: 8px; font-size: 16px;">Penalidades Básicas</h3>
                        <p style="color: var(--text-gray); font-size: 13px; line-height: 1.5;">Penalidades essenciais para descumprimento.</p>
                    </div>

                    <div class="template-card" onclick="aplicarTemplatePenalidades('completo')" style="background: var(--secondary); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s;">
                        <div style="font-size: 24px; margin-bottom: 12px;">⚖️</div>
                        <h3 style="color: var(--primary); margin-bottom: 8px; font-size: 16px;">Penalidades Completas</h3>
                        <p style="color: var(--text-gray); font-size: 13px; line-height: 1.5;">Conjunto completo de penalidades e multas.</p>
                    </div>

                    <div class="template-card" onclick="aplicarTemplatePenalidades('atraso')" style="background: var(--secondary); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s;">
                        <div style="font-size: 24px; margin-bottom: 12px;">⏰</div>
                        <h3 style="color: var(--primary); margin-bottom: 8px; font-size: 16px;">Atraso no Pagamento</h3>
                        <p style="color: var(--text-gray); font-size: 13px; line-height: 1.5;">Penalidades por atraso no pagamento.</p>
                    </div>

                    <div class="template-card" onclick="aplicarTemplatePenalidades('descumprimento')" style="background: var(--secondary); border: 1px solid rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 20px; cursor: pointer; transition: all 0.3s;">
                        <div style="font-size: 24px; margin-bottom: 12px;">❌</div>
                        <h3 style="color: var(--primary); margin-bottom: 8px; font-size: 16px;">Descumprimento de Serviços</h3>
                        <p style="color: var(--text-gray); font-size: 13px; line-height: 1.5;">Penalidades por descumprimento de serviços.</p>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="fecharTemplatesPenalidades()">Fechar</button>
            </div>
        </div>
    </div>

    <!-- Modal Detalhes Contrato -->
    <div id="contratoDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">Detalhes do Contrato</h2>
                <button class="btn-close" onclick="closeContratoDetailsModal()">&times;</button>
            </div>
            <div id="contratoDetailsContent" style="color: var(--text);">
                <!-- Conteúdo será preenchido dinamicamente -->
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeContratoDetailsModal()">Fechar</button>
                <button type="button" class="btn" id="gerarPDFContratoBtn" onclick="" style="background: var(--primary); border-color: var(--primary);">📄 Gerar PDF</button>
                <button type="button" class="btn btn-primary" id="editContratoFromDetailsBtn" onclick="">Editar</button>
                <button type="button" class="btn" id="renovarContratoBtn" onclick="" style="background: var(--success); border-color: var(--success);">🔄 Renovar</button>
                <button type="button" class="btn btn-danger" id="deleteContratoFromDetailsBtn" onclick="">Excluir</button>
            </div>
        </div>
    </div>

    <!-- Modal Plataforma -->
    <div id="plataformaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="plataformaModalTitle">Nova Plataforma</h2>
                <button class="btn-close" onclick="closePlataformaModal()">&times;</button>
            </div>
            <form id="plataformaForm">
                <input type="hidden" id="plataformaId">
                
                <div class="form-group">
                    <label class="form-label">Nome da Plataforma *</label>
                    <input type="text" id="plataformaNome" class="form-input" placeholder="Ex: Netflix, Spotify, Adobe Creative Cloud" required>
                </div>

                <div class="form-group">
                    <label class="form-label">URL de Acesso</label>
                    <input type="url" id="plataformaUrl" class="form-input" placeholder="https://...">
                </div>

                <div class="form-group">
                    <label class="form-label">Tipo de Pagamento *</label>
                    <select id="plataformaTipoPagamento" class="form-input" required onchange="togglePlataformaCampos()">
                        <option value="">Selecione o tipo</option>
                        <option value="unico">Pagamento Único</option>
                        <option value="recorrente">Pagamento Recorrente</option>
                        <option value="gratis">Grátis</option>
                    </select>
                </div>

                <!-- Campos para Pagamento Único -->
                <div id="camposPagamentoUnico" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Valor Pago</label>
                            <input type="number" id="plataformaValor" class="form-input" step="0.01" min="0" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Data do Pagamento</label>
                            <input type="date" id="plataformaDataPagamento" class="form-input">
                        </div>
                    </div>
                </div>

                <!-- Campos para Pagamento Recorrente -->
                <div id="camposPagamentoRecorrente" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Valor Mensal</label>
                            <input type="number" id="plataformaValorRecorrente" class="form-input" step="0.01" min="0" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Data de Validade</label>
                            <input type="date" id="plataformaValidade" class="form-input">
                        </div>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Usuário/Email</label>
                        <input type="text" id="plataformaUsuario" class="form-input" placeholder="Email ou usuário de acesso">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Senha</label>
                        <div style="display: flex; gap: 8px;">
                            <input type="password" id="plataformaSenha" class="form-input" placeholder="Senha de acesso" style="flex: 1;">
                            <button type="button" class="btn btn-secondary" onclick="togglePlataformaSenha()" style="padding: 12px 16px;">👁️</button>
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Observações</label>
                    <textarea id="plataformaObservacoes" class="form-input" rows="3" placeholder="Observações adicionais..."></textarea>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closePlataformaModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Detalhes Plataforma -->
    <div id="plataformaDetailsModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">Detalhes da Plataforma</h2>
                <button class="btn-close" onclick="closePlataformaDetailsModal()">&times;</button>
            </div>
            <div id="plataformaDetailsContent" style="color: var(--text);">
                <!-- Conteúdo será preenchido dinamicamente -->
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closePlataformaDetailsModal()">Fechar</button>
                <button type="button" class="btn btn-primary" id="editPlataformaFromDetailsBtn" onclick="">Editar</button>
                <button type="button" class="btn btn-danger" id="deletePlataformaFromDetailsBtn" onclick="">Excluir</button>
            </div>
        </div>
    </div>

    <!-- Modal Documento de Finalização -->
    <div id="documentoFinalizacaoModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title" id="documentoFinalizacaoModalTitle">Gerar Documento de Finalização</h2>
                <button class="btn-close" onclick="closeDocumentoFinalizacaoModal()">&times;</button>
            </div>
            <form id="documentoFinalizacaoForm">
                <input type="hidden" id="documentoFinalizacaoId">
                <input type="hidden" id="documentoFinalizacaoProjetoId">
                <input type="hidden" id="documentoFinalizacaoClienteId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Número do Documento</label>
                        <input type="text" id="documentoFinalizacaoNumero" class="form-input" placeholder="Gerado automaticamente" readonly>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Data de Conclusão *</label>
                        <input type="date" id="documentoFinalizacaoDataConclusao" class="form-input" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Valor Total do Projeto</label>
                        <input type="number" id="documentoFinalizacaoValorTotal" class="form-input" step="0.01" min="0" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Valor Pago</label>
                        <input type="number" id="documentoFinalizacaoValorPago" class="form-input" step="0.01" min="0" placeholder="0.00">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Formas de Pagamento</label>
                    <div class="checkbox-group" style="background: var(--tertiary); padding: 12px; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1);">
                        <div class="checkbox-item">
                            <input type="checkbox" id="documentoFormaPagamentoPix" value="PIX" onchange="atualizarFormasPagamento()">
                            <label for="documentoFormaPagamentoPix">PIX</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="documentoFormaPagamentoCartao" value="Cartão de Crédito/Débito" onchange="atualizarFormasPagamento()">
                            <label for="documentoFormaPagamentoCartao">Cartão de Crédito/Débito</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="documentoFormaPagamentoBoleto" value="Boleto" onchange="atualizarFormasPagamento()">
                            <label for="documentoFormaPagamentoBoleto">Boleto</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="documentoFormaPagamentoDinheiro" value="Dinheiro" onchange="atualizarFormasPagamento()">
                            <label for="documentoFormaPagamentoDinheiro">Dinheiro</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="documentoFormaPagamentoTransferencia" value="Transferência Bancária" onchange="atualizarFormasPagamento()">
                            <label for="documentoFormaPagamentoTransferencia">Transferência Bancária</label>
                        </div>
                    </div>
                    <input type="hidden" id="documentoFinalizacaoFormasPagamento" value="">
                </div>

                <div class="form-group">
                    <label class="form-label">Entregas Realizadas *</label>
                    <div style="background: var(--tertiary); padding: 16px; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 12px;">
                        <div id="entregasContainer" style="margin-bottom: 12px;">
                            <!-- Entregas serão adicionadas aqui -->
                        </div>
                        <button type="button" class="btn btn-secondary" onclick="adicionarEntrega()" style="padding: 8px 16px; font-size: 14px; width: 100%;">
                            ➕ Adicionar Nova Entrega
                        </button>
                        <small style="color: var(--text-gray); font-size: 12px; display: block; margin-top: 8px;">
                            💡 Adicione cada item/serviço que foi entregue ao cliente
                        </small>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Garantia (dias)</label>
                        <input type="number" id="documentoFinalizacaoGarantia" class="form-input" min="0" value="30" placeholder="30">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Suporte Incluído</label>
                        <select id="documentoFinalizacaoSuporteIncluso" class="form-input" onchange="toggleSuporteDias()">
                            <option value="false">Não</option>
                            <option value="true">Sim</option>
                        </select>
                    </div>
                </div>

                <div class="form-group" id="suporteDiasGroup" style="display: none;">
                    <label class="form-label">Período de Suporte (dias)</label>
                    <input type="number" id="documentoFinalizacaoSuporteDias" class="form-input" min="0" placeholder="30">
                </div>

                <div class="form-group">
                    <label class="form-label">Observações</label>
                    <textarea id="documentoFinalizacaoObservacoes" class="form-input" rows="3" placeholder="Observações adicionais sobre o projeto..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Termos e Condições</label>
                    <textarea id="documentoFinalizacaoTermos" class="form-input" rows="4" placeholder="Termos e condições padrão...">O cliente confirma o recebimento de todas as entregas listadas acima. A empresa se compromete a corrigir eventuais problemas técnicos no período de garantia especificado.</textarea>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeDocumentoFinalizacaoModal()">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="previewDocumentoFinalizacao()" style="background: var(--warning); border-color: var(--warning);">👁️ Visualizar PDF</button>
                    <button type="submit" class="btn btn-primary">Salvar e Gerar PDF</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Cobrança -->
    <div id="cobrancaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="cobrancaModalTitle">Nova Cobrança</h2>
                <button class="btn-close" onclick="closeCobrancaModal()">&times;</button>
            </div>
            <form id="cobrancaForm">
                <input type="hidden" id="cobrancaId">
                
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Cliente *</label>
                        <select id="cobrancaClienteId" class="form-input" required onchange="loadOrcamentosParaCobranca()">
                            <option value="">Selecione um cliente</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Orçamento (opcional)</label>
                        <select id="cobrancaOrcamentoId" class="form-input" onchange="preencherDadosCobranca()">
                            <option value="">Nenhum</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Descrição da Cobrança *</label>
                    <input type="text" id="cobrancaDescricao" class="form-input" placeholder="Ex: Pagamento mensalidade Janeiro 2024" required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Valor *</label>
                        <input type="number" id="cobrancaValor" class="form-input" step="0.01" min="0" placeholder="0.00" required>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Data de Vencimento *</label>
                        <input type="date" id="cobrancaDataVencimento" class="form-input" required>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Forma de Pagamento *</label>
                        <select id="cobrancaFormaPagamento" class="form-input" required>
                            <option value="">Selecione</option>
                            <option value="PIX">PIX</option>
                            <option value="Boleto">Boleto</option>
                            <option value="Cartão de Crédito">Cartão de Crédito</option>
                            <option value="Cartão de Débito">Cartão de Débito</option>
                            <option value="Transferência">Transferência</option>
                            <option value="Dinheiro">Dinheiro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tipo de Cobrança *</label>
                        <select id="cobrancaTipo" class="form-input" required onchange="atualizarCamposCobranca()">
                            <option value="unica">Única</option>
                            <option value="parcelado">Parcelado</option>
                            <option value="recorrente">Recorrente (Mensalidade)</option>
                            <option value="manutencao">Taxa de Manutenção</option>
                        </select>
                    </div>
                </div>

                <!-- Campos para Parcelado -->
                <div id="cobrancaCamposParcelado" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Número de Parcelas *</label>
                            <input type="number" id="cobrancaNumeroParcelas" class="form-input" min="2" max="60" value="2" placeholder="Ex: 3, 6, 12">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Valor por Parcela</label>
                            <input type="number" id="cobrancaValorParcela" class="form-input" step="0.01" min="0" readonly style="background: var(--tertiary);">
                            <small style="color: var(--text-gray); font-size: 11px;">Calculado automaticamente</small>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Intervalo entre Parcelas (dias)</label>
                        <input type="number" id="cobrancaIntervaloParcelas" class="form-input" min="1" value="30" placeholder="Ex: 30 (mensal), 15 (quinzenal)">
                    </div>
                </div>

                <!-- Campos para Recorrente -->
                <div id="cobrancaCamposRecorrente" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Frequência *</label>
                            <select id="cobrancaFrequencia" class="form-input">
                                <option value="mensal">Mensal</option>
                                <option value="trimestral">Trimestral</option>
                                <option value="semestral">Semestral</option>
                                <option value="anual">Anual</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Dia do Mês (Vencimento)</label>
                            <input type="number" id="cobrancaDiaVencimento" class="form-input" min="1" max="31" value="10" placeholder="Ex: 10 (todo dia 10)">
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Data de Início *</label>
                            <input type="date" id="cobrancaDataInicio" class="form-input">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Data de Término (opcional)</label>
                            <input type="date" id="cobrancaDataTermino" class="form-input">
                            <small style="color: var(--text-gray); font-size: 11px;">Deixe em branco para cobrança indefinida</small>
                        </div>
                    </div>
                </div>

                <!-- Campos para Taxa de Manutenção -->
                <div id="cobrancaCamposManutencao" style="display: none;">
                    <div class="form-row">
                        <div class="form-group">
                            <label class="form-label">Valor da Taxa Mensal *</label>
                            <input type="number" id="cobrancaValorManutencao" class="form-input" step="0.01" min="0" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Dia do Mês (Vencimento) *</label>
                            <input type="number" id="cobrancaDiaVencimentoManutencao" class="form-input" min="1" max="31" value="10" placeholder="Ex: 10">
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Data de Início *</label>
                        <input type="date" id="cobrancaDataInicioManutencao" class="form-input">
                    </div>
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="cobrancaManutencaoAtiva" checked>
                            <span style="margin-left: 8px;">Ativar cobrança automática mensal</span>
                        </label>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Instruções de Pagamento</label>
                    <textarea id="cobrancaInstrucoes" class="form-input" rows="3" placeholder="Instruções para pagamento (ex: Chave PIX, dados bancários, etc.)"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">QR Code PIX (opcional)</label>
                    
                    <!-- Opção 1: Upload de QR Code do Banco (RECOMENDADO) -->
                    <div style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                        <p style="font-size: 12px; color: var(--text); margin: 0 0 8px 0; line-height: 1.5;">
                            <strong>✅ Opção 1 (Recomendado):</strong> Gere o QR Code PIX no app do seu banco e faça upload aqui.
                        </p>
                        <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap;">
                            <input type="file" id="cobrancaQRCodeFile" accept="image/*" style="display: none;" onchange="previewQRCode()">
                            <button type="button" class="btn btn-secondary" onclick="document.getElementById('cobrancaQRCodeFile').click()" style="background: var(--success); border-color: var(--success);">📷 Upload QR Code do Banco</button>
                        </div>
                    </div>
                    
                    <!-- Opção 2: Integração com Gateway de Pagamento -->
                    <div style="background: rgba(59, 130, 246, 0.1); border: 1px solid rgba(59, 130, 246, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                        <p style="font-size: 12px; color: var(--text); margin: 0 0 8px 0; line-height: 1.5;">
                            <strong>💳 Opção 2 (Integração):</strong> Use uma API de pagamento para gerar QR Code PIX válido automaticamente.
                        </p>
                        <div style="margin-top: 8px;">
                            <select id="cobrancaGatewayPagamento" class="form-input" style="margin-bottom: 8px;" onchange="atualizarCamposGateway()">
                                <option value="">Selecione um gateway...</option>
                                <option value="mercadopago">Mercado Pago</option>
                                <option value="asaas">Asaas</option>
                                <option value="gerencianet">Gerencianet (Efí)</option>
                                <option value="pagseguro">PagSeguro</option>
                                <option value="stripe">Stripe (não suporta PIX no Brasil)</option>
                            </select>
                            <div id="camposGateway" style="display: none;">
                                <input type="text" id="cobrancaApiKey" class="form-input" placeholder="API Key / Access Token" style="margin-bottom: 8px;">
                                <input type="text" id="cobrancaApiSecret" class="form-input" placeholder="API Secret (se necessário)" style="margin-bottom: 8px;">
                                <button type="button" class="btn btn-secondary" onclick="gerarQRCodeViaGateway()" style="background: var(--primary); border-color: var(--primary);">🔲 Gerar QR Code via Gateway</button>
                            </div>
                            <small style="color: var(--text-gray); font-size: 10px; display: block; margin-top: 8px;">
                                💡 <strong>Nota:</strong> Você precisará criar uma conta e obter as credenciais da API do gateway escolhido. O Stripe não suporta PIX no Brasil.
                            </small>
                        </div>
                        <span id="cobrancaGatewayStatus" style="font-size: 11px; color: var(--text-gray); display: block; margin-top: 8px;"></span>
                    </div>
                    
                    <!-- Opção 3: Gerar QR Code com Chave PIX (Teste) -->
                    <div style="background: rgba(255, 193, 7, 0.1); border: 1px solid rgba(255, 193, 7, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 12px;">
                        <p style="font-size: 12px; color: var(--text); margin: 0 0 8px 0; line-height: 1.5;">
                            <strong>⚠️ Opção 3 (Teste - Não recomendado):</strong> Informe sua Chave PIX abaixo. <strong>Nota:</strong> Este QR Code pode não funcionar em todos os apps. Use a Opção 1 ou 2 para garantir funcionalidade.
                        </p>
                        <div style="display: flex; gap: 8px; align-items: center; flex-wrap: wrap; margin-top: 8px;">
                            <input type="text" id="cobrancaChavePIX" class="form-input" placeholder="Sua Chave PIX (CPF, CNPJ, e-mail, telefone ou chave aleatória)" style="flex: 1; min-width: 200px;">
                            <button type="button" class="btn btn-secondary" onclick="gerarQRCodePIX()" style="background: var(--warning); border-color: var(--warning);">🔲 Gerar QR Code (Teste)</button>
                        </div>
                        <span id="cobrancaQRCodeStatus" style="font-size: 11px; color: var(--text-gray); display: block; margin-top: 8px;"></span>
                    </div>
                    
                    <!-- Preview do QR Code -->
                    <div id="cobrancaQRCodePreview" style="margin-top: 12px; display: none;">
                        <div style="display: flex; flex-direction: column; align-items: center; gap: 12px;">
                            <div style="background: white; padding: 16px; border-radius: 8px; border: 2px solid var(--primary); display: flex; justify-content: center; align-items: center;">
                                <img id="cobrancaQRCodeImage" src="" alt="QR Code" style="width: 180px; height: 180px; max-width: 180px; max-height: 180px; display: block; object-fit: contain;">
                            </div>
                            <div style="text-align: center; width: 100%;">
                                <button type="button" class="btn btn-sm btn-danger" onclick="removerQRCode()">❌ Remover QR Code</button>
                                <p style="font-size: 11px; color: var(--text-gray); margin-top: 8px; line-height: 1.5;">
                                    O QR Code será incluído no PDF da cobrança centralizado e em tamanho médio (30x30mm) para melhor visualização.
                                </p>
                            </div>
                        </div>
                    </div>
                    <input type="hidden" id="cobrancaQRCodeBase64">
                </div>

                <div class="form-group">
                    <label class="form-label">Observações</label>
                    <textarea id="cobrancaObservacoes" class="form-input" rows="3" placeholder="Observações adicionais..."></textarea>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeCobrancaModal()">Cancelar</button>
                    <button type="button" class="btn btn-primary" onclick="gerarPDFCobranca(); return false;" style="background: var(--warning); border-color: var(--warning);">📄 Gerar PDF Cobrança</button>
                    <button type="button" class="btn btn-primary" onclick="enviarCobrancaWhatsApp(); return false;" style="background: #25D366; border-color: #25D366;">💬 Enviar por WhatsApp</button>
                    <button type="submit" class="btn btn-primary">Salvar e Criar Receita</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Ideia de Melhoria -->
    <div id="ideiaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="ideiaModalTitle">Nova Análise/Ideia</h2>
                <button class="btn-close" onclick="closeIdeiaModal()">&times;</button>
            </div>
            <form id="ideiaForm">
                <input type="hidden" id="ideiaId">
                
                <div class="form-group">
                    <label class="form-label">Cliente/Empresa *</label>
                    <select id="ideiaClienteId" class="form-input" required>
                        <option value="">Selecione um cliente</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">Título da Análise/Ideia *</label>
                    <input type="text" id="ideiaTitulo" class="form-input" placeholder="Ex: Análise de estratégia digital - Melhorias sugeridas" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Análise e Ideias de Melhorias *</label>
                    <textarea id="ideiaDescricao" class="form-input" rows="6" placeholder="Descreva sua análise da empresa e as ideias de melhorias que surgiram dessa análise..." required></textarea>
                    <small style="color: var(--text-gray); font-size: 12px; margin-top: 4px; display: block;">
                        💡 Dica: Descreva o que você observou na empresa e quais melhorias/estratégias poderiam funcionar.
                    </small>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Categoria</label>
                        <select id="ideiaCategoria" class="form-input">
                            <option value="">Selecione</option>
                            <option value="Marketing">Marketing</option>
                            <option value="Operacional">Operacional</option>
                            <option value="Tecnologia">Tecnologia</option>
                            <option value="Estratégia">Estratégia</option>
                            <option value="Vendas">Vendas</option>
                            <option value="Atendimento">Atendimento</option>
                            <option value="Outro">Outro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Prioridade</label>
                        <select id="ideiaPrioridade" class="form-input">
                            <option value="media">Média</option>
                            <option value="baixa">Baixa</option>
                            <option value="alta">Alta</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select id="ideiaStatus" class="form-input">
                            <option value="nova">Nova</option>
                            <option value="em_analise">Em Análise</option>
                            <option value="aprovada">Aprovada</option>
                            <option value="rejeitada">Rejeitada</option>
                            <option value="implementada">Implementada</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Observações</label>
                    <textarea id="ideiaObservacoes" class="form-input" rows="3" placeholder="Anotações adicionais, pontos de atenção, etc."></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Data de Criação</label>
                        <input type="date" id="ideiaDataCriacao" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Data de Implementação (se aplicável)</label>
                        <input type="date" id="ideiaDataImplementacao" class="form-input">
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeIdeiaModal()">Cancelar</button>
                    <button type="button" class="btn btn-secondary" id="transformarIdeiaBtn" onclick="transformarIdeiaEmOrcamento()" style="display: none; background: var(--primary); border-color: var(--primary);">📄 Transformar em Orçamento</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Precificação -->
    <div id="precificacaoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="precificacaoModalTitle">Novo Serviço</h2>
                <button class="btn-close" onclick="closePrecificacaoModal()">&times;</button>
            </div>
            <form id="precificacaoForm">
                <input type="hidden" id="precificacaoId">
                
                <div class="form-group">
                    <label class="form-label">Nome do Serviço *</label>
                    <input type="text" id="precificacaoNome" class="form-input" placeholder="Ex: Desenvolvimento de Site, Consultoria, etc." required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Categoria *</label>
                        <select id="precificacaoCategoria" class="form-input" required>
                            <option value="">Selecione</option>
                            <option value="desenvolvimento">Desenvolvimento</option>
                            <option value="design">Design</option>
                            <option value="marketing">Marketing</option>
                            <option value="consultoria">Consultoria</option>
                            <option value="suporte">Suporte</option>
                            <option value="outro">Outro</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Tipo de Precificação *</label>
                        <select id="precificacaoTipo" class="form-input" required onchange="atualizarCamposPrecificacao()">
                            <option value="">Selecione</option>
                            <option value="hora">Por Hora</option>
                            <option value="projeto">Por Projeto</option>
                            <option value="valor">Por Valor Agregado</option>
                            <option value="custo">Custo + Margem</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label" id="precificacaoLabel1">Preço Base (R$)</label>
                        <input type="number" id="precificacaoPrecoBase" class="form-input" step="0.01" min="0" placeholder="0.00" required>
                        <small style="color: var(--text-gray); font-size: 11px;" id="precificacaoHelp1"></small>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Preço Mínimo (R$)</label>
                        <input type="number" id="precificacaoPrecoMinimo" class="form-input" step="0.01" min="0" placeholder="0.00">
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Preço Máximo (R$)</label>
                        <input type="number" id="precificacaoPrecoMaximo" class="form-input" step="0.01" min="0" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Margem de Lucro (%)</label>
                        <input type="number" id="precificacaoMargem" class="form-input" step="0.01" min="0" max="1000" value="50" placeholder="50">
                        <small style="color: var(--text-gray); font-size: 11px;">Margem recomendada: 50-100%</small>
                    </div>
                </div>

                <div class="form-group" id="precificacaoCampoExtra" style="display: none;">
                    <label class="form-label" id="precificacaoLabelExtra"></label>
                    <input type="number" id="precificacaoValorExtra" class="form-input" step="0.01" min="0" placeholder="0.00">
                </div>

                <div class="form-group">
                    <label class="form-label">Descrição</label>
                    <textarea id="precificacaoDescricao" class="form-input" rows="3" placeholder="Descrição detalhada do serviço..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Observações Internas</label>
                    <textarea id="precificacaoObservacoes" class="form-input" rows="2" placeholder="Observações sobre precificação, custos, etc..."></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="precificacaoAtivo" checked>
                            <span style="margin-left: 8px;">Serviço ativo</span>
                        </label>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closePrecificacaoModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Template de Mensagem -->
    <div id="templateModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="templateModalTitle">Novo Template</h2>
                <button class="btn-close" onclick="closeTemplateModal()">&times;</button>
            </div>
            <form id="templateForm">
                <input type="hidden" id="templateId">
                
                <div class="form-group">
                    <label class="form-label">Nome do Template *</label>
                    <input type="text" id="templateNome" class="form-input" placeholder="Ex: Orçamento Padrão, Follow-up, etc." required>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Tipo *</label>
                        <select id="templateTipo" class="form-input" required>
                            <option value="">Selecione</option>
                            <option value="orcamento">Orçamento</option>
                            <option value="cobranca">Cobrança</option>
                            <option value="followup">Follow-up</option>
                            <option value="personalizado">Personalizado</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Categoria</label>
                        <select id="templateCategoria" class="form-input">
                            <option value="">Selecione</option>
                            <option value="comercial">Comercial</option>
                            <option value="financeiro">Financeiro</option>
                            <option value="projetos">Projetos</option>
                            <option value="atendimento">Atendimento</option>
                        </select>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Mensagem *</label>
                    <textarea id="templateMensagem" class="form-input" rows="8" placeholder="Digite a mensagem do template..." required></textarea>
                    <small style="color: var(--text-gray); font-size: 12px; margin-top: 4px; display: block;">
                        💡 Variáveis disponíveis: *{cliente_nome}*, *{cliente_empresa}*, *{projeto_nome}*, *{orcamento_numero}*, *{valor}*, *{data_vencimento}*
                    </small>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="templateAtivo" checked>
                            <span style="margin-left: 8px;">Template ativo</span>
                        </label>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Ordem</label>
                        <input type="number" id="templateOrdem" class="form-input" value="0" min="0">
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeTemplateModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Supabase CDN -->
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <!-- jsPDF para geração de PDF -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- QRCode.js para geração de QR Code -->
    <script src="https://cdn.jsdelivr.net/npm/qrcode@1.5.3/build/qrcode.min.js"></script>
    <!-- Nota: Para QR Code PIX válido, é necessário usar API do banco ou fazer upload do QR Code gerado pelo banco -->
    
    <script>
        // Configuração do Supabase
        const SUPABASE_URL = 'https://zhzhpctsndrcedukivhk.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InpoemhwY3RzbmRyY2VkdWtpdmhrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI5OTA2NjMsImV4cCI6MjA3ODU2NjY2M30.POJaM5AK2RPvczhIAPEjA7bvLxQxnN9rJC4f_oR5bC8';
        
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY, {
            auth: {
                persistSession: false,
                autoRefreshToken: false
            }
        });

        // Verificar se usuário está logado (localStorage)
        function checkAuth() {
            const loggedIn = localStorage.getItem('loggedIn');
            if (loggedIn === 'true') {
                showDashboard();
                loadDashboardData();
            } else {
                showLogin();
            }
        }

        // Funções auxiliares globais
        function formatDate(dateStr) {
            if (!dateStr) return '-';
            try {
                const date = new Date(dateStr);
                return date.toLocaleDateString('pt-BR');
            } catch {
                return dateStr;
            }
        }

        function formatCurrency(value) {
            if (!value && value !== 0) return 'R$ 0,00';
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        // Mostrar página de login
        function showLogin() {
            document.getElementById('loginPage').style.display = 'flex';
            document.getElementById('dashboardPage').classList.remove('active');
        }

        // Mostrar dashboard
        function showDashboard() {
            document.getElementById('loginPage').style.display = 'none';
            document.getElementById('dashboardPage').classList.add('active');
            
            // Informações do usuário do localStorage
            const nome = localStorage.getItem('userName') || 'Usuário';
            const email = localStorage.getItem('userEmail') || '';
            
            document.getElementById('userName').textContent = nome;
            document.getElementById('userEmail').textContent = email;
            document.getElementById('userAvatar').textContent = nome.charAt(0).toUpperCase();
        }

        // Login - Buscar na tabela usuarios
        document.getElementById('loginForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const nome = document.getElementById('nome').value.trim();
            const senha = document.getElementById('password').value;
            const errorMessage = document.getElementById('errorMessage');
            const loginBtn = document.getElementById('loginBtn');
            
            if (!nome || !senha) {
                errorMessage.textContent = 'Preencha nome e senha';
                errorMessage.classList.add('show');
                return;
            }
            
            loginBtn.disabled = true;
            loginBtn.innerHTML = '<span>Entrando...</span>';
            errorMessage.classList.remove('show');
            
            try {
                // Buscar na tabela usuarios (aceita maiúsculas/minúsculas)
                const { data, error } = await supabase
                    .from('usuarios')
                    .select('*')
                    .ilike('nome', nome)  // Case insensitive
                    .eq('senha', senha)
                    .eq('ativo', true)
                    .maybeSingle();
                
                if (error) {
                    console.error('Erro ao buscar usuário:', error);
                    // Se for erro 404 ou 406, a tabela não existe ou não tem acesso
                    if (error.code === 'PGRST116' || error.message?.includes('permission denied')) {
                        throw new Error('Tabela usuarios não configurada. Execute o SQL no Supabase.');
                    }
                    throw new Error('Erro ao conectar com o banco de dados');
                }
                
                if (!data) {
                    throw new Error('Nome ou senha incorretos');
                }
                
                // Login válido
                localStorage.setItem('loggedIn', 'true');
                localStorage.setItem('userName', data.nome);
                localStorage.setItem('userEmail', data.email || '');
                localStorage.setItem('userPerfil', data.perfil || '');
                
                showDashboard();
                loadDashboardData();
            } catch (error) {
                errorMessage.textContent = error.message || 'Nome ou senha incorretos';
                errorMessage.classList.add('show');
            } finally {
                loginBtn.disabled = false;
                loginBtn.innerHTML = '<span>Entrar</span>';
            }
        });

        // Logout
        function logout() {
            if (confirm('Deseja realmente sair?')) {
                localStorage.removeItem('loggedIn');
                showLogin();
            }
        }

        // Carregar dados do dashboard
        async function loadDashboardData() {
            try {
                // Buscar pagamentos
                let pagamentos = [];
                try {
                    const { data, error } = await supabase
                        .from('pagamentos')
                        .select('*')
                        .eq('tipo', 'receber');
                    
                    if (!error && data) {
                        pagamentos = data;
                    }
                } catch (e) {
                    // Tabela não existe ou erro, continuar
                }

                // Calcular totais
                const hoje = new Date();
                const mesAtual = hoje.getMonth();
                const anoAtual = hoje.getFullYear();
                
                let faturamentoMes = 0;
                let pagamentosPendentes = 0;
                let pagamentosVencidos = 0;

                if (pagamentos && pagamentos.length > 0) {
                    pagamentos.forEach(p => {
                        const dataVenc = new Date(p.data_vencimento);
                        const valor = parseFloat(p.valor) || 0;
                        
                        if (p.status === 'pago' && dataVenc.getMonth() === mesAtual && dataVenc.getFullYear() === anoAtual) {
                            faturamentoMes += valor;
                        }
                        
                        if (p.status === 'pendente') {
                            pagamentosPendentes += valor;
                        }
                        
                        if (p.status === 'atrasado') {
                            pagamentosVencidos += valor;
                        }
                    });
                }

                // Buscar projetos
                let projetos = [];
                try {
                    const { data, error } = await supabase
                        .from('projetos')
                        .select('*')
                        .eq('status', 'em_andamento');
                    
                    if (!error && data) {
                        projetos = data;
                    }
                } catch (e) {
                    // Tabela não existe ou erro, continuar
                }

                // Atualizar UI
                document.getElementById('faturamentoMes').textContent = formatCurrency(faturamentoMes);
                document.getElementById('projetosAtivos').textContent = projetos?.length || 0;
                document.getElementById('pagamentosPendentes').textContent = formatCurrency(pagamentosPendentes);
                document.getElementById('pagamentosVencidos').textContent = formatCurrency(pagamentosVencidos);

                // Carregar notificações de prazos
                await loadNotificacoesPrazos();
            } catch (error) {
                console.error('Erro ao carregar dados:', error);
            }
        }

        // ========== NOTIFICAÇÕES DE PRAZOS ==========
        
        // Calcular dias até o prazo ou dias de atraso
        function calcularDiasPrazo(dataPrevista) {
            if (!dataPrevista) return null;
            
            const hoje = new Date();
            hoje.setHours(0, 0, 0, 0);
            
            const prazo = new Date(dataPrevista);
            prazo.setHours(0, 0, 0, 0);
            
            const diffTime = prazo - hoje;
            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
            
            return diffDays;
        }

        // Classificar projeto por prazo
        function classificarProjetoPorPrazo(projeto) {
            // Projetos com prioridade urgente sempre aparecem
            if (projeto.prioridade === 'urgente') {
                if (!projeto.data_prevista) {
                    return { tipo: 'urgente', dias: null, label: 'Prioridade Urgente' };
                }
                const dias = calcularDiasPrazo(projeto.data_prevista);
                if (dias < 0) {
                    return { tipo: 'atrasado', dias: Math.abs(dias), label: `⚠️ URGENTE - Data de entrega venceu há ${Math.abs(dias)} dia(s)` };
                } else if (dias === 0) {
                    return { tipo: 'urgente', dias: 0, label: '⚠️ URGENTE - Data de entrega vence hoje!' };
                } else {
                    return { tipo: 'urgente', dias: dias, label: `⚠️ URGENTE - Data de entrega vence em ${dias} dia(s)` };
                }
            }

            // Projetos sem data definida
            if (!projeto.data_prevista) {
                return { tipo: 'sem-data', dias: null, label: 'Sem data de entrega definida' };
            }

            const dias = calcularDiasPrazo(projeto.data_prevista);
            
            if (dias < 0) {
                return { tipo: 'atrasado', dias: Math.abs(dias), label: `Data de entrega venceu há ${Math.abs(dias)} dia(s)` };
            } else if (dias === 0) {
                return { tipo: 'proximo', dias: 0, label: 'Data de entrega vence hoje!' };
            } else if (dias <= 3) {
                return { tipo: 'proximo', dias: dias, label: `Data de entrega vence em ${dias} dia(s)` };
            } else if (dias <= 7) {
                return { tipo: 'proximo', dias: dias, label: `Data de entrega vence em ${dias} dias` };
            }
            
            return null; // Não precisa de notificação
        }

        // Carregar notificações de prazos
        async function loadNotificacoesPrazos() {
            try {
                // Buscar projetos de forma mais simples e segura
                let projetos = [];

                // Primeiro, buscar projetos sem relação (mais simples)
                const { data: projetosData, error: projetosError } = await supabase
                    .from('projetos')
                    .select('*')
                    .neq('status', 'concluido')
                    .neq('status', 'cancelado');

                if (projetosError) {
                    console.error('Erro ao buscar projetos:', projetosError);
                    throw projetosError;
                }

                projetos = projetosData || [];

                // Buscar clientes separadamente se houver projetos
                if (projetos.length > 0) {
                    const clienteIds = [...new Set(projetos.map(p => p.cliente_id).filter(Boolean))];
                    if (clienteIds.length > 0) {
                        const { data: clientes, error: clientesError } = await supabase
                            .from('clientes')
                            .select('id, nome, empresa')
                            .in('id', clienteIds);
                        
                        if (!clientesError && clientes) {
                            const clientesMap = {};
                            clientes.forEach(c => {
                                clientesMap[c.id] = c;
                            });
                            
                            projetos = projetos.map(p => ({
                                ...p,
                                cliente: clientesMap[p.cliente_id] || null
                            }));
                        }
                    }
                }

                const projetosComAlerta = [];

                projetos.forEach(projeto => {
                    try {
                        const classificacao = classificarProjetoPorPrazo(projeto);
                        if (classificacao) {
                            projetosComAlerta.push({
                                ...projeto,
                                alerta: classificacao
                            });
                        }
                    } catch (e) {
                        console.warn('Erro ao classificar projeto:', projeto.id, e);
                    }
                });

                // Ordenar: urgentes primeiro, depois atrasados, depois próximos, depois sem data
                projetosComAlerta.sort((a, b) => {
                    const ordem = { 'urgente': 0, 'atrasado': 1, 'proximo': 2, 'sem-data': 3 };
                    return (ordem[a.alerta.tipo] || 99) - (ordem[b.alerta.tipo] || 99);
                });

                // Renderizar notificações
                renderNotificacoes(projetosComAlerta);
            } catch (error) {
                // Expandir objeto de erro para ver todos os detalhes
                console.error('=== ERRO AO CARREGAR NOTIFICAÇÕES ===');
                console.error('Erro completo:', JSON.stringify(error, null, 2));
                console.error('Mensagem:', error?.message);
                console.error('Código:', error?.code);
                console.error('Detalhes:', error?.details);
                console.error('Hint:', error?.hint);
                console.error('Stack:', error?.stack);
                console.error('Objeto completo:', error);
                
                const container = document.getElementById('notificacoesProjetos');
                if (container) {
                    let errorMsg = 'Erro ao carregar notificações';
                    if (error?.message) {
                        errorMsg += ': ' + error.message;
                    } else if (error?.details) {
                        errorMsg += ': ' + error.details;
                    } else if (error?.hint) {
                        errorMsg += ': ' + error.hint;
                    } else {
                        errorMsg += '. Verifique o console para mais detalhes.';
                    }
                    container.innerHTML = '<div class="empty-state">' + errorMsg + '</div>';
                }
            }
        }

        // Renderizar notificações
        function renderNotificacoes(projetos) {
            const container = document.getElementById('notificacoesProjetos');
            const countBadge = document.getElementById('notificacoesCount');

            if (!container) return;

            if (!projetos || projetos.length === 0) {
                container.innerHTML = '<div class="empty-state">✅ Nenhum projeto precisa de atenção no momento</div>';
                if (countBadge) countBadge.style.display = 'none';
                return;
            }

            if (countBadge) {
                countBadge.textContent = projetos.length;
                countBadge.style.display = 'inline-block';
            }

            let html = '';
            projetos.forEach(projeto => {
                const cliente = projeto.cliente || {};
                const clienteNome = cliente.nome || cliente.empresa || 'Cliente não encontrado';
                const alerta = projeto.alerta;

                html += `
                    <div class="notification-card ${alerta.tipo}" onclick="viewProjetoDetails('${projeto.id}')">
                        <div class="notification-header">
                            <div class="notification-title">${projeto.nome || 'Sem nome'}</div>
                            <span class="notification-status ${alerta.tipo}">${alerta.label}</span>
                        </div>
                        <div style="font-size: 12px; color: var(--text-gray); margin-bottom: 8px;">
                            👤 ${clienteNome}
                        </div>
                        <div class="notification-info">
                            <span>📅 Prazo: ${projeto.data_prevista ? formatDate(projeto.data_prevista) : 'Não definido'}</span>
                            <span>📊 Status: ${projeto.status === 'em_andamento' ? 'Em Andamento' : 
                                          projeto.status === 'planejamento' ? 'Planejamento' :
                                          projeto.status === 'pausado' ? 'Pausado' : projeto.status}</span>
                        </div>
                        ${alerta.dias !== null ? `
                            <div class="notification-days ${alerta.tipo}" style="margin-top: 8px; font-size: 13px;">
                                ${alerta.tipo === 'atrasado' ? '⚠️' : '⏰'} ${alerta.label}
                            </div>
                        ` : ''}
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Formatar moeda
        function formatCurrency(value) {
            return new Intl.NumberFormat('pt-BR', {
                style: 'currency',
                currency: 'BRL'
            }).format(value);
        }

        // Mapeamento de títulos das páginas
        const pageTitles = {
            'dashboard': 'Dashboard',
            'clientes': 'Clientes',
            'projetos': 'Projetos',
            'orcamentos': 'Orçamentos',
            'ideias': 'Análises & Ideias',
            'templates': 'Templates de Mensagens',
            'financeiro': 'Financeiro',
            'contratos': 'Contratos',
            'plataformas': 'Plataformas',
            'tarefas': 'Tarefas & Hábitos',
            'analises': 'Análises Avançadas',
            'precificacao': 'Precificação'
        };

        // Navegação do menu
        document.querySelectorAll('.menu-item').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                
                // Remover classe active de todos os itens
                document.querySelectorAll('.menu-item').forEach(i => i.classList.remove('active'));
                // Adicionar classe active ao item clicado
                item.classList.add('active');
                
                // Obter página do data-page
                const page = item.getAttribute('data-page');
                if (!page) return;
                
                // Esconder todas as páginas
                document.querySelectorAll('.page-content').forEach(p => {
                    p.style.display = 'none';
                });
                
                // Mostrar página selecionada
                const pageContent = document.getElementById(page + 'Content');
                if (pageContent) {
                    pageContent.style.display = 'block';
                    
                    // Atualizar título do header
                    const headerTitle = document.querySelector('.header-title');
                    if (headerTitle) {
                        headerTitle.textContent = pageTitles[page] || page;
                    }
                    
                    // Carregar dados da página
                    if (page === 'dashboard') {
                        loadDashboardData();
                    } else if (page === 'clientes') {
                        loadClientes();
                    } else if (page === 'projetos') {
                        loadProjetos();
                    } else if (page === 'orcamentos') {
                        loadOrcamentos();
                    } else if (page === 'ideias') {
                        loadIdeias();
                    } else if (page === 'templates') {
                        loadTemplates();
                    } else if (page === 'financeiro') {
                        loadFinanceiro();
                    } else if (page === 'contratos') {
                        loadContratos();
                    } else if (page === 'plataformas') {
                        loadPlataformas();
                    } else if (page === 'tarefas') {
                        loadTarefas();
                        loadHabitos();
                    } else if (page === 'analises') {
                        loadAnalisesAvancadas();
                    } else if (page === 'precificacao') {
                        loadPrecificacao();
                        atualizarCalculadora();
                    }
                }
            });
        });
        
        // Função auxiliar para fechar sidebar no mobile (se necessário)
        function closeSidebarMobile() {
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('open');
                document.getElementById('sidebarOverlay').classList.remove('active');
            }
        }
        
        // ========== CRUD CLIENTES ==========
        let allClientes = [];
        let filteredClientes = [];

        // Carregar clientes do Supabase
        async function loadClientes() {
            const loading = document.getElementById('clientesLoading');
            const table = document.getElementById('clientesTable');
            const empty = document.getElementById('clientesEmpty');
            
            loading.classList.add('active');
            table.style.display = 'none';
            empty.style.display = 'none';

            try {
                // Buscar usuário logado (simulado - usar ID do localStorage se tiver)
                const { data, error } = await supabase
                    .from('clientes')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                allClientes = data || [];
                filteredClientes = [...allClientes];
                renderClientes();
            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
                allClientes = [];
                filteredClientes = [];
                renderClientes();
            } finally {
                loading.classList.remove('active');
            }
        }

        // Renderizar tabela de clientes
        function renderClientes() {
            const tbody = document.getElementById('clientesTableBody');
            const table = document.getElementById('clientesTable');
            const empty = document.getElementById('clientesEmpty');

            if (filteredClientes.length === 0) {
                table.style.display = 'none';
                empty.style.display = 'block';
                return;
            }

            table.style.display = 'table';
            empty.style.display = 'none';

            tbody.innerHTML = filteredClientes.map(cliente => {
                const cidadeEstado = [cliente.cidade, cliente.estado].filter(Boolean).join('/') || '-';
                
                return `
                    <tr>
                        <td data-label="Nome">${cliente.nome || ''}</td>
                        <td data-label="Empresa">${cliente.empresa || '-'}</td>
                        <td data-label="Email">${cliente.email || ''}</td>
                        <td data-label="Telefone">${cliente.telefone || cliente.whatsapp || '-'}</td>
                        <td data-label="Localização">${cidadeEstado}</td>
                        <td data-label="Status">
                            <span class="badge ${cliente.status === 'ativo' ? 'badge-ativo' : 'badge-inativo'}">
                                ${cliente.status === 'ativo' ? 'Ativo' : 'Inativo'}
                            </span>
                        </td>
                        <td data-label="Ações">
                            <button class="btn-action" onclick="viewClienteDetails('${cliente.id}')" style="border-color: var(--primary); color: var(--primary); margin-right: 4px;">Ver</button>
                            <button class="btn-action" onclick="selecionarTemplateEEnviar('${cliente.id}')" style="border-color: #25D366; color: #25D366; margin-right: 4px;" title="Enviar WhatsApp">💬</button>
                            <button class="btn-action" onclick="criarOrcamentoParaCliente('${cliente.id}')" style="border-color: var(--success); color: var(--success);">📄</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Filtrar clientes
        function filterClientes() {
            const search = document.getElementById('clienteSearch').value.toLowerCase();
            const statusFilter = document.getElementById('clienteStatusFilter').value;

            filteredClientes = allClientes.filter(cliente => {
                const matchSearch = !search || 
                    (cliente.nome && cliente.nome.toLowerCase().includes(search)) ||
                    (cliente.empresa && cliente.empresa.toLowerCase().includes(search)) ||
                    (cliente.email && cliente.email.toLowerCase().includes(search));
                
                const matchStatus = !statusFilter || cliente.status === statusFilter;
                
                return matchSearch && matchStatus;
            });

            renderClientes();
        }

        // ========== FUNÇÕES AUXILIARES PARA MODAIS ==========
        // Variável global para armazenar posição do scroll
        let modalScrollY = 0;
        
        // Função para abrir modal (prevenir scroll do body)
        function openModal(modalElement) {
            if (!modalElement) return;
            
            // Salvar posição atual do scroll
            modalScrollY = window.pageYOffset || window.scrollY || document.documentElement.scrollTop || 0;
            
            // Aplicar estilos inline diretamente para garantir que funcione
            document.body.style.position = 'fixed';
            document.body.style.top = `-${modalScrollY}px`;
            document.body.style.left = '0';
            document.body.style.right = '0';
            document.body.style.width = '100%';
            document.body.style.overflow = 'hidden';
            document.body.style.touchAction = 'none';
            
            document.documentElement.style.overflow = 'hidden';
            document.documentElement.style.height = '100%';
            
            // Adicionar classe
            document.body.classList.add('modal-open');
            document.documentElement.classList.add('modal-open');
            
            // Mostrar modal
            modalElement.classList.add('active');
        }
        
        // Função para fechar modal (restaurar scroll do body)
        function closeModal(modalElement) {
            if (!modalElement) return;
            
            // Esconder modal
            modalElement.classList.remove('active');
            
            // Remover estilos inline
            document.body.style.position = '';
            document.body.style.top = '';
            document.body.style.left = '';
            document.body.style.right = '';
            document.body.style.width = '';
            document.body.style.overflow = '';
            document.body.style.touchAction = '';
            document.documentElement.style.overflow = '';
            document.documentElement.style.height = '';
            
            // Remover classes
            document.body.classList.remove('modal-open');
            document.documentElement.classList.remove('modal-open');
            
            // Restaurar posição do scroll após um pequeno delay para garantir que os estilos foram removidos
            setTimeout(() => {
                window.scrollTo(0, modalScrollY);
                modalScrollY = 0;
            }, 10);
        }
        
        // Toggle submenu de serviços
        function toggleSubmenu(servico) {
            // Mapear nomes para IDs corretos
            const idMap = {
                'automacao': { main: 'servicoAutomacao', sub: 'submenuAutomacao' },
                'site': { main: 'servicoSite', sub: 'submenuSite' },
                'trafego': { main: 'servicoTrafego', sub: 'submenuTrafego' },
                'design': { main: 'servicoDesign', sub: 'submenuDesign' },
                'redes_sociais': { main: 'servicoRedesSociais', sub: 'submenuRedesSociais' }
            };
            
            const ids = idMap[servico];
            if (!ids) return;
            
            const checkbox = document.getElementById(ids.main);
            const submenu = document.getElementById(ids.sub);
            
            if (checkbox && submenu) {
                if (checkbox.checked) {
                    submenu.classList.add('active');
                } else {
                    submenu.classList.remove('active');
                    // Desmarcar todos os subitens
                    submenu.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.checked = false);
                }
            }
        }

        // Abrir modal de cliente (novo)
        function openClienteModal() {
            document.getElementById('clienteModalTitle').textContent = 'Novo Cliente';
            document.getElementById('clienteForm').reset();
            document.getElementById('clienteId').value = '';
            
            // Preencher data de cadastro com hoje
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('clienteDataCadastro').value = hoje;
            
            // Limpar checkboxes principais
            ['servicoAutomacao', 'servicoSite', 'servicoDesign', 'servicoTrafego', 'servicoRedesSociais'].forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox) {
                    checkbox.checked = false;
                    // Fechar submenu
                    const servico = id.replace('servico', '').toLowerCase();
                    const submenu = document.getElementById(`submenu${servico.charAt(0).toUpperCase() + servico.slice(1)}`);
                    if (submenu) {
                        submenu.classList.remove('active');
                    }
                }
            });
            
            // Limpar todos os subitens
            document.querySelectorAll('.servico-submenu input[type="checkbox"]').forEach(cb => cb.checked = false);
            
            const modal = document.getElementById('clienteModal');
            openModal(modal);
        }

        // Fechar modal
        function closeClienteModal() {
            const modal = document.getElementById('clienteModal');
            closeModal(modal);
        }

        // Editar cliente
        async function editCliente(id) {
            const cliente = allClientes.find(c => c.id === id);
            if (!cliente) return;

            document.getElementById('clienteModalTitle').textContent = 'Editar Cliente';
            document.getElementById('clienteId').value = cliente.id;
            document.getElementById('clienteNome').value = cliente.nome || '';
            document.getElementById('clienteEmpresa').value = cliente.empresa || '';
            document.getElementById('clienteEmail').value = cliente.email || '';
            document.getElementById('clienteTelefone').value = cliente.telefone || '';
            document.getElementById('clienteWhatsapp').value = cliente.whatsapp || '';
            document.getElementById('clienteCpfCnpj').value = cliente.cpf_cnpj || '';
            document.getElementById('clienteSegmento').value = cliente.segmento || '';
            document.getElementById('clienteEndereco').value = cliente.endereco || '';
            document.getElementById('clienteCidade').value = cliente.cidade || '';
            document.getElementById('clienteEstado').value = cliente.estado || '';
            document.getElementById('clienteCep').value = cliente.cep || '';
            document.getElementById('clienteDataCadastro').value = cliente.data_cadastro ? cliente.data_cadastro.split('T')[0] : '';
            document.getElementById('clienteOrigem').value = cliente.origem || '';
            document.getElementById('clienteStatus').value = cliente.status || 'ativo';
            document.getElementById('clienteObservacoes').value = cliente.observacoes || '';

            const modal = document.getElementById('clienteModal');
            openModal(modal);
        }

        // Salvar cliente (criar ou atualizar)
        document.getElementById('clienteForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('clienteId').value;

            const clienteData = {
                nome: document.getElementById('clienteNome').value.trim(),
                empresa: document.getElementById('clienteEmpresa').value.trim() || null,
                email: document.getElementById('clienteEmail').value.trim(),
                telefone: document.getElementById('clienteTelefone').value.trim() || null,
                whatsapp: document.getElementById('clienteWhatsapp').value.trim() || null,
                cpf_cnpj: document.getElementById('clienteCpfCnpj').value.trim() || null,
                segmento: document.getElementById('clienteSegmento').value.trim() || null,
                endereco: document.getElementById('clienteEndereco').value.trim() || null,
                cidade: document.getElementById('clienteCidade').value.trim() || null,
                estado: document.getElementById('clienteEstado').value || null,
                cep: document.getElementById('clienteCep').value.trim() || null,
                data_cadastro: document.getElementById('clienteDataCadastro').value || null,
                origem: document.getElementById('clienteOrigem').value || null,
                status: document.getElementById('clienteStatus').value,
                observacoes: document.getElementById('clienteObservacoes').value.trim() || null
            };

            try {
                if (id) {
                    // Atualizar
                    const { error } = await supabase
                        .from('clientes')
                        .update(clienteData)
                        .eq('id', id);

                    if (error) throw error;
                    alert('Cliente atualizado com sucesso!');
                } else {
                    // Criar - sem user_id (removido foreign key constraint)
                    const { error } = await supabase
                        .from('clientes')
                        .insert([clienteData]);

                    if (error) throw error;
                    alert('Cliente criado com sucesso!');
                }

                closeClienteModal();
                loadClientes();
            } catch (error) {
                console.error('Erro ao salvar cliente:', error);
                alert('Erro ao salvar cliente: ' + (error.message || 'Erro desconhecido'));
            }
        });

        // Excluir cliente
        async function deleteCliente(id) {
            if (!confirm('Tem certeza que deseja excluir este cliente?')) return;

            try {
                const { error } = await supabase
                    .from('clientes')
                    .delete()
                    .eq('id', id);

                if (error) throw error;
                alert('Cliente excluído com sucesso!');
                loadClientes();
            } catch (error) {
                console.error('Erro ao excluir cliente:', error);
                alert('Erro ao excluir cliente: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // Ver detalhes do cliente
        function viewClienteDetails(id) {
            const cliente = allClientes.find(c => c.id === id);
            if (!cliente) {
                alert('Cliente não encontrado');
                return;
            }

            const content = document.getElementById('clienteDetailsContent');
            const editBtn = document.getElementById('editFromDetailsBtn');
            const deleteBtn = document.getElementById('deleteFromDetailsBtn');
            
            // Configurar botão de editar
            editBtn.onclick = () => {
                closeClienteDetailsModal();
                editCliente(id);
            };

            // Configurar botão de excluir com confirmação
            deleteBtn.onclick = async () => {
                if (!confirm('Tem certeza que deseja excluir este cliente? Esta ação não pode ser desfeita.')) {
                    return;
                }

                try {
                    const { error } = await supabase
                        .from('clientes')
                        .delete()
                        .eq('id', id);

                    if (error) throw error;
                    
                    alert('Cliente excluído com sucesso!');
                    closeClienteDetailsModal();
                    loadClientes();
                } catch (error) {
                    console.error('Erro ao excluir cliente:', error);
                    alert('Erro ao excluir cliente: ' + (error.message || 'Erro desconhecido'));
                }
            };

            // Formatar serviços
            const servicos = cliente.servicos_contratados || [];
            const servicosHtml = servicos.length > 0
                ? servicos.map(s => {
                    // Formatar nome do serviço
                    const nomeFormatado = s
                        .replace(/_/g, ' ')
                        .split(' ')
                        .map(p => p.charAt(0).toUpperCase() + p.slice(1))
                        .join(' ');
                    return `<span class="servico-badge">${nomeFormatado}</span>`;
                }).join('')
                : '<span class="details-value empty">Nenhum serviço contratado</span>';

            // Formatar origem
            const origemMap = {
                'indicacao': 'Indicação',
                'google': 'Google',
                'facebook': 'Facebook',
                'instagram': 'Instagram',
                'linkedin': 'LinkedIn',
                'site': 'Site próprio',
                'outro': 'Outro'
            };
            const origemFormatada = origemMap[cliente.origem] || cliente.origem || '-';

            // Formatar data
            const formatDate = (dateStr) => {
                if (!dateStr) return '-';
                try {
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('pt-BR');
                } catch {
                    return dateStr;
                }
            };

            // Helper para exibir valor ou "-"
            const displayValue = (value) => value || '<span class="empty">-</span>';

            content.innerHTML = `
                <div class="details-section">
                    <div class="details-section-title">Informações Básicas</div>
                    <div class="details-grid">
                        <div class="details-item">
                            <div class="details-label">Nome</div>
                            <div class="details-value">${cliente.nome || '-'}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Empresa</div>
                            <div class="details-value">${displayValue(cliente.empresa)}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Email</div>
                            <div class="details-value">${cliente.email || '-'}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Status</div>
                            <div class="details-value">
                                <span class="badge ${cliente.status === 'ativo' ? 'badge-ativo' : 'badge-inativo'}">
                                    ${cliente.status === 'ativo' ? 'Ativo' : 'Inativo'}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="details-section">
                    <div class="details-section-title">Contato</div>
                    <div class="details-grid">
                        <div class="details-item">
                            <div class="details-label">Telefone</div>
                            <div class="details-value">${displayValue(cliente.telefone)}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">WhatsApp</div>
                            <div class="details-value">${displayValue(cliente.whatsapp)}</div>
                        </div>
                    </div>
                </div>

                <div class="details-section">
                    <div class="details-section-title">Documentos e Segmento</div>
                    <div class="details-grid">
                        <div class="details-item">
                            <div class="details-label">CPF/CNPJ</div>
                            <div class="details-value">${displayValue(cliente.cpf_cnpj)}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Segmento</div>
                            <div class="details-value">${displayValue(cliente.segmento)}</div>
                        </div>
                    </div>
                </div>

                <div class="details-section">
                    <div class="details-section-title">Endereço</div>
                    <div class="details-grid">
                        <div class="details-item" style="grid-column: 1 / -1;">
                            <div class="details-label">Endereço Completo</div>
                            <div class="details-value">${displayValue(cliente.endereco)}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Cidade</div>
                            <div class="details-value">${displayValue(cliente.cidade)}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Estado</div>
                            <div class="details-value">${displayValue(cliente.estado)}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">CEP</div>
                            <div class="details-value">${displayValue(cliente.cep)}</div>
                        </div>
                    </div>
                </div>

                <div class="details-section">
                    <div class="details-section-title">Serviços Contratados</div>
                    <div class="servicos-list">
                        ${servicosHtml}
                    </div>
                </div>

                <div class="details-section">
                    <div class="details-section-title">Informações Adicionais</div>
                    <div class="details-grid">
                        <div class="details-item">
                            <div class="details-label">Data de Cadastro</div>
                            <div class="details-value">${formatDate(cliente.data_cadastro)}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Origem do Cliente</div>
                            <div class="details-value">${origemFormatada}</div>
                        </div>
                    </div>
                    <div class="details-item" style="margin-top: 12px;">
                        <div class="details-label">Observações</div>
                        <div class="details-value" style="white-space: pre-wrap;">${displayValue(cliente.observacoes)}</div>
                    </div>
                </div>
            `;

            const modal = document.getElementById('clienteDetailsModal');
            openModal(modal);
        }

        // Fechar modal de detalhes
        function closeClienteDetailsModal() {
            const modal = document.getElementById('clienteDetailsModal');
            closeModal(modal);
        }

        // ========== CRUD PROJETOS ==========
        let allProjetos = [];
        let filteredProjetos = [];

        // Carregar projetos do Supabase
        async function loadProjetos() {
            const loading = document.getElementById('projetosLoading');
            const table = document.getElementById('projetosTable');
            const empty = document.getElementById('projetosEmpty');
            
            loading.classList.add('active');
            table.style.display = 'none';
            empty.style.display = 'none';

            try {
                // Buscar projetos
                const { data: projetosData, error: projetosError } = await supabase
                    .from('projetos')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (projetosError) throw projetosError;

                // Buscar clientes
                let clientesMap = {};
                try {
                    const { data: clientesData, error: clientesError } = await supabase
                        .from('clientes')
                        .select('id, nome, empresa');

                    if (!clientesError && clientesData) {
                        clientesData.forEach(cliente => {
                            clientesMap[cliente.id] = cliente;
                        });
                    }
                } catch (e) {
                    console.warn('Erro ao carregar clientes para projetos:', e);
                }

                // Buscar usuários (responsáveis)
                let usuariosMap = {};
                try {
                    const { data: usuariosData, error: usuariosError } = await supabase
                        .from('usuarios')
                        .select('id, nome');

                    if (!usuariosError && usuariosData) {
                        usuariosData.forEach(usuario => {
                            usuariosMap[usuario.id] = usuario;
                        });
                    }
                } catch (e) {
                    console.warn('Erro ao carregar usuários para projetos:', e);
                }

                // Combinar dados
                allProjetos = (projetosData || []).map(projeto => ({
                    ...projeto,
                    cliente: clientesMap[projeto.cliente_id] || null,
                    responsavel: usuariosMap[projeto.responsavel_id] || null
                }));

                filteredProjetos = [...allProjetos];
                renderProjetos();
            } catch (error) {
                console.error('Erro ao carregar projetos:', error);
                allProjetos = [];
                filteredProjetos = [];
                renderProjetos();
            } finally {
                loading.classList.remove('active');
            }
        }

        // Variável para controlar a visualização atual
        let projetoViewMode = 'table'; // 'table' ou 'kanban'

        // Alternar entre visualização de tabela, kanban e timeline
        function toggleProjetoView(mode) {
            projetoViewMode = mode;
            const tableView = document.getElementById('projetosTableView');
            const kanbanView = document.getElementById('projetosKanbanView');
            const timelineView = document.getElementById('projetosTimelineView');
            const tableBtn = document.getElementById('viewTableBtn');
            const kanbanBtn = document.getElementById('viewKanbanBtn');
            const timelineBtn = document.getElementById('viewTimelineBtn');

            // Resetar todos os botões
            tableBtn.style.background = 'var(--tertiary)';
            tableBtn.style.borderColor = 'var(--tertiary)';
            kanbanBtn.style.background = 'var(--tertiary)';
            kanbanBtn.style.borderColor = 'var(--tertiary)';
            timelineBtn.style.background = 'var(--tertiary)';
            timelineBtn.style.borderColor = 'var(--tertiary)';

            // Ocultar todas as visualizações
            tableView.style.display = 'none';
            kanbanView.style.display = 'none';
            timelineView.style.display = 'none';

            // Mostrar a visualização selecionada
            if (mode === 'table') {
                tableView.style.display = 'block';
                tableBtn.style.background = 'var(--primary)';
                tableBtn.style.borderColor = 'var(--primary)';
            } else if (mode === 'kanban') {
                kanbanView.style.display = 'block';
                kanbanBtn.style.background = 'var(--primary)';
                kanbanBtn.style.borderColor = 'var(--primary)';
            } else if (mode === 'timeline') {
                timelineView.style.display = 'block';
                timelineBtn.style.background = 'var(--primary)';
                timelineBtn.style.borderColor = 'var(--primary)';
            }

            renderProjetos();
        }

        // ========== DRAG AND DROP NO KANBAN ==========
        let draggedCard = null;
        let isDragging = false;

        function handleDragStart(e) {
            // Verificar se o clique foi em um botão (não arrastar)
            if (e.target.tagName === 'BUTTON' || e.target.closest('button')) {
                e.preventDefault();
                return false;
            }
            
            draggedCard = e.target.closest('.kanban-card');
            if (!draggedCard) return;
            
            isDragging = false;
            draggedCard.classList.add('dragging');
            e.dataTransfer.effectAllowed = 'move';
            e.dataTransfer.setData('text/html', draggedCard.outerHTML);
            
            // Adicionar um pequeno delay para diferenciar drag de click
            setTimeout(() => {
                isDragging = true;
            }, 100);
        }

        function handleDragEnd(e) {
            if (draggedCard) {
                draggedCard.classList.remove('dragging');
            }
            // Remover classe drag-over de todas as colunas
            document.querySelectorAll('.kanban-column-body').forEach(col => {
                col.classList.remove('drag-over');
            });
            isDragging = false;
            draggedCard = null;
        }

        function handleDragOver(e) {
            if (e.preventDefault) {
                e.preventDefault();
            }
            e.dataTransfer.dropEffect = 'move';
            e.currentTarget.classList.add('drag-over');
            return false;
        }

        function handleDragLeave(e) {
            e.currentTarget.classList.remove('drag-over');
        }

        async function handleDrop(e) {
            if (e.stopPropagation) {
                e.stopPropagation();
            }
            e.preventDefault();
            e.currentTarget.classList.remove('drag-over');

            // Verificar se draggedCard existe e é válido
            if (!draggedCard || !draggedCard.getAttribute) {
                draggedCard = null;
                return false;
            }

            const newStatus = e.currentTarget.getAttribute('data-status');
            const projetoId = draggedCard.getAttribute('data-projeto-id');
            const oldStatus = draggedCard.getAttribute('data-projeto-status');

            // Validar dados
            if (!projetoId || !newStatus) {
                draggedCard = null;
                return false;
            }

            // Se o status não mudou, não fazer nada
            if (newStatus === oldStatus) {
                draggedCard = null;
                return false;
            }

            // Salvar referência do card antes de atualizar
            const cardToMove = draggedCard;
            const cardId = projetoId;

            // Atualizar status no banco de dados
            try {
                const { error } = await supabase
                    .from('projetos')
                    .update({ status: newStatus })
                    .eq('id', cardId);

                if (error) throw error;

                // Atualizar o projeto no array primeiro
                const projeto = allProjetos.find(p => p.id === cardId);
                if (projeto) {
                    projeto.status = newStatus;
                }

                // Re-renderizar para atualizar tudo (move o card e atualiza contadores)
                renderProjetosKanban();

            } catch (error) {
                console.error('Erro ao atualizar status do projeto:', error);
                alert('Erro ao atualizar status: ' + (error.message || 'Erro desconhecido'));
                // Recarregar projetos em caso de erro
                await loadProjetos();
            }

            draggedCard = null;
            isDragging = false;
            return false;
        }

        // Renderizar projetos no Kanban
        function renderProjetosKanban() {
            const statusColumns = ['planejamento', 'em_andamento', 'pausado', 'concluido', 'cancelado'];
            const statusMap = {
                'planejamento': { label: 'Planejamento', emoji: '📋' },
                'em_andamento': { label: 'Em Andamento', emoji: '🚀' },
                'pausado': { label: 'Pausado', emoji: '⏸️' },
                'concluido': { label: 'Concluído', emoji: '✅' },
                'cancelado': { label: 'Cancelado', emoji: '❌' }
            };

            statusColumns.forEach(status => {
                const columnBody = document.getElementById(`kanban-${status}`);
                const countEl = document.getElementById(`count-${status}`);
                
                if (!columnBody || !countEl) return;

                // Filtrar projetos por status
                const projetosStatus = filteredProjetos.filter(p => p.status === status);
                countEl.textContent = projetosStatus.length;

                if (projetosStatus.length === 0) {
                    columnBody.innerHTML = '<div style="text-align: center; color: var(--text-gray); font-style: italic; padding: 20px;">Nenhum projeto</div>';
                    return;
                }

                columnBody.innerHTML = projetosStatus.map(projeto => {
                    const cliente = projeto.cliente || {};
                    const clienteNome = cliente.nome || cliente.empresa || 'Cliente não encontrado';
                    
                    const formatDate = (dateStr) => {
                        if (!dateStr) return '-';
                        try {
                            const date = new Date(dateStr);
                            return date.toLocaleDateString('pt-BR');
                        } catch {
                            return dateStr;
                        }
                    };

                    const formatCurrency = (value) => {
                        if (!value) return 'R$ 0,00';
                        return new Intl.NumberFormat('pt-BR', {
                            style: 'currency',
                            currency: 'BRL'
                        }).format(value);
                    };

                    return `
                        <div class="kanban-card" 
                             draggable="true" 
                             data-projeto-id="${projeto.id}"
                             data-projeto-status="${projeto.status}"
                             ondragstart="handleDragStart(event)"
                             ondragend="handleDragEnd(event)"
                             onclick="if (!isDragging) viewProjetoDetails('${projeto.id}')">
                            <div class="kanban-card-title">${projeto.nome || 'Sem nome'}</div>
                            <div class="kanban-card-client">👤 ${clienteNome}</div>
                            <div class="kanban-card-info">
                                <span>📅 ${formatDate(projeto.data_inicio)}</span>
                                <span>📆 ${formatDate(projeto.data_prevista)}</span>
                            </div>
                            <div class="kanban-card-value">${formatCurrency(projeto.valor)}</div>
                            <div class="kanban-card-actions">
                                <button class="btn btn-primary" onclick="event.stopPropagation(); viewProjetoDetails('${projeto.id}')" style="font-size: 11px; padding: 6px;">
                                    Ver Detalhes
                                </button>
                            </div>
                        </div>
                    `;
                }).join('');
            });
        }

        // Renderizar projetos na Timeline
        function renderProjetosTimeline() {
            const timelineContent = document.getElementById('timelineContent');
            if (!timelineContent) return;

            if (filteredProjetos.length === 0) {
                timelineContent.innerHTML = '<div style="text-align: center; padding: 40px; color: var(--text-gray);">Nenhum projeto encontrado</div>';
                return;
            }

            const formatDate = (dateStr) => {
                if (!dateStr) return '-';
                try {
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('pt-BR');
                } catch {
                    return dateStr;
                }
            };

            const formatCurrency = (value) => {
                if (!value) return 'R$ 0,00';
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(value);
            };

            // Agrupar projetos por mês
            const projetosPorMes = {};
            filteredProjetos.forEach(projeto => {
                if (!projeto.data_inicio) return;
                const date = new Date(projeto.data_inicio);
                const mesAno = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                const mesNome = date.toLocaleDateString('pt-BR', { month: 'long', year: 'numeric' });
                
                if (!projetosPorMes[mesAno]) {
                    projetosPorMes[mesAno] = {
                        nome: mesNome.charAt(0).toUpperCase() + mesNome.slice(1),
                        projetos: []
                    };
                }
                projetosPorMes[mesAno].projetos.push(projeto);
            });

            // Ordenar meses
            const mesesOrdenados = Object.keys(projetosPorMes).sort();

            let html = '<div class="timeline-legend">';
            html += '<div class="timeline-legend-item"><span class="timeline-legend-color" style="background: var(--primary);"></span><span>Em Andamento</span></div>';
            html += '<div class="timeline-legend-item"><span class="timeline-legend-color" style="background: rgba(156, 163, 175, 0.5);"></span><span>Planejamento</span></div>';
            html += '<div class="timeline-legend-item"><span class="timeline-legend-color" style="background: rgba(16, 185, 129, 0.5);"></span><span>Concluído</span></div>';
            html += '<div class="timeline-legend-item"><span class="timeline-legend-color" style="background: rgba(239, 68, 68, 0.5);"></span><span>Pausado/Cancelado</span></div>';
            html += '</div>';

            mesesOrdenados.forEach(mesAno => {
                const mes = projetosPorMes[mesAno];
                html += `<div style="margin-bottom: 24px;">`;
                html += `<h3 style="color: var(--text); margin-bottom: 16px; font-size: 16px;">${mes.nome}</h3>`;
                
                mes.projetos.forEach(projeto => {
                    const cliente = projeto.cliente || {};
                    const clienteNome = cliente.nome || cliente.empresa || 'Cliente não encontrado';
                    
                    // Determinar cor baseada no status
                    let corBarra = 'var(--primary)';
                    if (projeto.status === 'planejamento') corBarra = 'rgba(156, 163, 175, 0.5)';
                    else if (projeto.status === 'concluido') corBarra = 'rgba(16, 185, 129, 0.5)';
                    else if (projeto.status === 'pausado' || projeto.status === 'cancelado') corBarra = 'rgba(239, 68, 68, 0.5)';

                    html += `
                        <div class="timeline-project" onclick="viewProjetoDetails('${projeto.id}')" style="cursor: pointer;">
                            <div class="timeline-project-header">
                                <div>
                                    <div class="timeline-project-title">${projeto.nome || 'Sem nome'}</div>
                                    <div class="timeline-project-client">👤 ${clienteNome}</div>
                                </div>
                                <div style="text-align: right;">
                                    <div style="font-weight: 600; color: var(--primary);">${formatCurrency(projeto.valor)}</div>
                                    <span class="badge badge-${projeto.status || 'planejamento'}" style="font-size: 10px; padding: 2px 8px;">
                                        ${projeto.status === 'em_andamento' ? 'Em Andamento' : 
                                          projeto.status === 'concluido' ? 'Concluído' :
                                          projeto.status === 'pausado' ? 'Pausado' :
                                          projeto.status === 'cancelado' ? 'Cancelado' : 'Planejamento'}
                                    </span>
                                </div>
                            </div>
                            <div class="timeline-project-bar" style="background: ${corBarra};"></div>
                            <div class="timeline-project-dates">
                                <span>📅 Início: ${formatDate(projeto.data_inicio)}</span>
                                <span>📆 Prevista: ${formatDate(projeto.data_prevista)}</span>
                            </div>
                        </div>
                    `;
                });
                
                html += `</div>`;
            });

            timelineContent.innerHTML = html;
        }

        // Renderizar tabela de projetos
        function renderProjetos() {
            // Verificar qual visualização está ativa
            if (projetoViewMode === 'kanban') {
                renderProjetosKanban();
                return;
            }
            
            if (projetoViewMode === 'timeline') {
                renderProjetosTimeline();
                return;
            }

            const tbody = document.getElementById('projetosTableBody');
            const table = document.getElementById('projetosTable');
            const empty = document.getElementById('projetosEmpty');

            if (filteredProjetos.length === 0) {
                table.style.display = 'none';
                empty.style.display = 'block';
                return;
            }

            table.style.display = 'table';
            empty.style.display = 'none';

            tbody.innerHTML = filteredProjetos.map(projeto => {
                const cliente = projeto.cliente || {};
                const clienteNome = cliente.nome || cliente.empresa || 'Cliente não encontrado';
                
                const formatDate = (dateStr) => {
                    if (!dateStr) return '-';
                    try {
                        const date = new Date(dateStr);
                        return date.toLocaleDateString('pt-BR');
                    } catch {
                        return dateStr;
                    }
                };

                const formatCurrency = (value) => {
                    if (!value) return 'R$ 0,00';
                    return new Intl.NumberFormat('pt-BR', {
                        style: 'currency',
                        currency: 'BRL'
                    }).format(value);
                };

                const statusMap = {
                    'planejamento': { label: 'Planejamento', class: 'badge-planejamento' },
                    'em_andamento': { label: 'Em Andamento', class: 'badge-em-andamento' },
                    'pausado': { label: 'Pausado', class: 'badge-pausado' },
                    'concluido': { label: 'Concluído', class: 'badge-concluido' },
                    'cancelado': { label: 'Cancelado', class: 'badge-cancelado' }
                };

                const status = statusMap[projeto.status] || { label: projeto.status, class: 'badge-planejamento' };

                return `
                    <tr>
                        <td data-label="Nome do Projeto">${projeto.nome || ''}</td>
                        <td data-label="Cliente">${clienteNome}</td>
                        <td data-label="Data Início">${formatDate(projeto.data_inicio)}</td>
                        <td data-label="Data Prevista">${formatDate(projeto.data_prevista)}</td>
                        <td data-label="Valor">${formatCurrency(projeto.valor)}</td>
                        <td data-label="Status">
                            <span class="badge ${status.class}">
                                ${status.label}
                            </span>
                        </td>
                        <td data-label="Ações">
                            <button class="btn-action" onclick="viewProjetoDetails('${projeto.id}')" style="border-color: var(--primary); color: var(--primary);">Ver Detalhes</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Variável para controlar filtro de alertas
        let filterAlertasAtivo = false;

        // Toggle filtro de alertas
        function toggleFilterAlertas() {
            filterAlertasAtivo = !filterAlertasAtivo;
            const btn = document.getElementById('filterAlertasBtn');
            if (btn) {
                if (filterAlertasAtivo) {
                    btn.textContent = '✅ Ver Todos';
                    btn.style.background = 'var(--primary)';
                } else {
                    btn.textContent = '⚠️ Ver Alertas';
                    btn.style.background = 'var(--tertiary)';
                }
            }
            filterProjetos();
        }

        // Filtrar projetos
        function filterProjetos() {
            const search = document.getElementById('projetoSearch').value.toLowerCase();
            const statusFilter = document.getElementById('projetoStatusFilter').value;

            filteredProjetos = allProjetos.filter(projeto => {
                const cliente = projeto.cliente || {};
                const clienteNome = (cliente.nome || cliente.empresa || '').toLowerCase();
                
                const matchSearch = !search || 
                    (projeto.nome && projeto.nome.toLowerCase().includes(search)) ||
                    clienteNome.includes(search);
                
                const matchStatus = !statusFilter || projeto.status === statusFilter;
                
                // Filtro de alertas
                let matchAlertas = true;
                if (filterAlertasAtivo) {
                    const classificacao = classificarProjetoPorPrazo(projeto);
                    matchAlertas = classificacao !== null;
                }
                
                return matchSearch && matchStatus && matchAlertas;
            });

            renderProjetos();
        }

        // Carregar clientes no select
        async function loadClientesForSelect() {
            try {
                const { data, error } = await supabase
                    .from('clientes')
                    .select('id, nome, empresa')
                    .eq('status', 'ativo')
                    .order('nome', { ascending: true });

                if (error) throw error;

                const select = document.getElementById('projetoClienteId');
                select.innerHTML = '<option value="">Selecione um cliente</option>';
                
                (data || []).forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.id;
                    option.textContent = cliente.empresa ? `${cliente.nome} - ${cliente.empresa}` : cliente.nome;
                    select.appendChild(option);
                });

                // Remover listeners antigos e adicionar novo listener para carregar serviços quando cliente for selecionado
                const newSelect = select.cloneNode(true);
                select.parentNode.replaceChild(newSelect, select);
                document.getElementById('projetoClienteId').addEventListener('change', async (e) => {
                    const clienteId = e.target.value;
                    if (clienteId) {
                        await loadServicosCliente(clienteId, 'projeto');
                    } else {
                        clearServicosContainer('projeto');
                    }
                });
            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
            }
        }

        // Carregar usuários no select de responsável
        async function loadUsuariosForSelect() {
            try {
                const { data, error } = await supabase
                    .from('usuarios')
                    .select('id, nome')
                    .eq('ativo', true)
                    .order('nome', { ascending: true });

                if (error) throw error;

                const select = document.getElementById('projetoResponsavelId');
                const currentValue = select.value; // Preservar valor atual
                select.innerHTML = '<option value="">Selecione um responsável</option>';
                
                (data || []).forEach(usuario => {
                    const option = document.createElement('option');
                    option.value = usuario.id;
                    option.textContent = usuario.nome;
                    select.appendChild(option);
                });
                
                // Restaurar valor se existir
                if (currentValue) {
                    select.value = currentValue;
                }
            } catch (error) {
                console.error('Erro ao carregar usuários:', error);
                // Se não conseguir carregar, apenas limpa o select
                const select = document.getElementById('projetoResponsavelId');
                select.innerHTML = '<option value="">Erro ao carregar usuários</option>';
            }
        }

        // Abrir modal de projeto (novo)
        async function openProjetoModal() {
            document.getElementById('projetoModalTitle').textContent = 'Novo Projeto';
            document.getElementById('projetoForm').reset();
            document.getElementById('projetoId').value = '';
            
            // Preencher data de início com hoje
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('projetoDataInicio').value = hoje;
            
            // Carregar clientes e usuários nos selects
            await Promise.all([
                loadClientesForSelect(),
                loadUsuariosForSelect()
            ]);
            
            const modal = document.getElementById('projetoModal');
            openModal(modal);
        }

        // Fechar modal
        function closeProjetoModal() {
            const modal = document.getElementById('projetoModal');
            closeModal(modal);
        }

        // Editar projeto
        async function editProjeto(id) {
            const projeto = allProjetos.find(p => p.id === id);
            if (!projeto) return;

            document.getElementById('projetoModalTitle').textContent = 'Editar Projeto';
            document.getElementById('projetoId').value = projeto.id;
            document.getElementById('projetoNome').value = projeto.nome || '';
            document.getElementById('projetoStatus').value = projeto.status || 'planejamento';
            document.getElementById('projetoPrioridade').value = projeto.prioridade || '';
            document.getElementById('projetoDataInicio').value = projeto.data_inicio ? projeto.data_inicio.split('T')[0] : '';
            document.getElementById('projetoDataPrevista').value = projeto.data_prevista ? projeto.data_prevista.split('T')[0] : '';
            document.getElementById('projetoDataConclusao').value = projeto.data_conclusao ? projeto.data_conclusao.split('T')[0] : '';
            document.getElementById('projetoValor').value = projeto.valor || '';
            document.getElementById('projetoDescricao').value = projeto.descricao || '';
            document.getElementById('projetoObservacoes').value = projeto.observacoes || '';
            
            // Tags - converter array para string separada por vírgula
            if (projeto.tags && Array.isArray(projeto.tags)) {
                document.getElementById('projetoTags').value = projeto.tags.join(', ');
            } else if (typeof projeto.tags === 'string') {
                document.getElementById('projetoTags').value = projeto.tags;
            } else {
                document.getElementById('projetoTags').value = '';
            }

            // Carregar clientes e usuários, depois selecionar valores
            await Promise.all([
                loadClientesForSelect(),
                loadUsuariosForSelect()
            ]);
            
            const clienteId = projeto.cliente_id || '';
            document.getElementById('projetoClienteId').value = clienteId;
            document.getElementById('projetoResponsavelId').value = projeto.responsavel_id || '';

            const modal = document.getElementById('projetoModal');
            openModal(modal);
        }

        // Salvar projeto (criar ou atualizar)
        document.getElementById('projetoForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('projetoId').value;

            // Construir objeto apenas com campos preenchidos
            const projetoData = {
                nome: document.getElementById('projetoNome').value.trim(),
                cliente_id: document.getElementById('projetoClienteId').value,
                status: document.getElementById('projetoStatus').value
            };

            // Adicionar campos opcionais apenas se preenchidos
            const prioridade = document.getElementById('projetoPrioridade').value;
            if (prioridade) projetoData.prioridade = prioridade;
            
            // Verificar se há campo orcamento_id no formulário
            const orcamentoIdInput = document.getElementById('projetoOrcamentoId');
            if (orcamentoIdInput && orcamentoIdInput.value) {
                projetoData.orcamento_id = orcamentoIdInput.value;
            }

            const responsavelId = document.getElementById('projetoResponsavelId').value;
            if (responsavelId) projetoData.responsavel_id = responsavelId;

            const dataInicio = document.getElementById('projetoDataInicio').value;
            if (dataInicio) projetoData.data_inicio = dataInicio;

            const dataPrevista = document.getElementById('projetoDataPrevista').value;
            if (dataPrevista) projetoData.data_prevista = dataPrevista;

            // Data de conclusão - será adicionada se preenchida
            const dataConclusao = document.getElementById('projetoDataConclusao').value;
            if (dataConclusao) projetoData.data_conclusao = dataConclusao;

            const valor = document.getElementById('projetoValor').value;
            if (valor) projetoData.valor = parseFloat(valor);

            // Tags - processar string separada por vírgula e converter para array
            const tagsInput = document.getElementById('projetoTags').value.trim();
            if (tagsInput) {
                const tagsArray = tagsInput.split(',').map(tag => tag.trim()).filter(tag => tag.length > 0);
                projetoData.tags = tagsArray;
            }

            const descricao = document.getElementById('projetoDescricao').value.trim();
            if (descricao) projetoData.descricao = descricao;

            const observacoes = document.getElementById('projetoObservacoes').value.trim();
            if (observacoes) projetoData.observacoes = observacoes;

            try {
                if (id) {
                    // Atualizar
                    const { error } = await supabase
                        .from('projetos')
                        .update(projetoData)
                        .eq('id', id);

                    if (error) throw error;
                    alert('Projeto atualizado com sucesso!');
                } else {
                    // Criar - verificar se tem orcamento_id e copiar itens
                    // Verificar campo hidden primeiro
                    const orcamentoIdInput = document.getElementById('projetoOrcamentoId');
                    const orcamentoId = orcamentoIdInput ? orcamentoIdInput.value : (projetoData.orcamento_id || null);
                    
                    console.log('Criando projeto. Orcamento ID:', orcamentoId);
                    
                    // Se tiver orcamento_id, buscar itens do orçamento e copiar para o projeto
                    if (orcamentoId && orcamentoId.trim() !== '') {
                        try {
                            console.log('Buscando itens do orçamento:', orcamentoId);
                            
                            // Validar formato do ID (UUID)
                            if (!/^[0-9a-f]{8}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{4}-[0-9a-f]{12}$/i.test(orcamentoId)) {
                                console.warn('⚠️ ID do orçamento inválido:', orcamentoId);
                            } else {
                                const { data: orcamento, error: orcError } = await supabase
                                    .from('orcamentos')
                                    .select('itens')
                                    .eq('id', orcamentoId.trim())
                                    .maybeSingle(); // Usar maybeSingle para evitar erro se não encontrar
                                
                                if (orcError) {
                                    console.error('❌ Erro ao buscar orçamento:', orcError);
                                    console.error('Detalhes do erro:', JSON.stringify(orcError, null, 2));
                                } else if (orcamento) {
                                    console.log('Orçamento encontrado. Itens (tipo):', typeof orcamento.itens, orcamento.itens);
                                    
                                    // Parse dos itens se for string
                                    let itens = [];
                                    if (typeof orcamento.itens === 'string') {
                                        try {
                                            itens = JSON.parse(orcamento.itens);
                                            console.log('Itens parseados de string:', itens);
                                        } catch (e) {
                                            console.warn('Erro ao parsear itens do orçamento:', e);
                                        }
                                    } else if (Array.isArray(orcamento.itens)) {
                                        itens = orcamento.itens;
                                        console.log('Itens já são array:', itens);
                                    } else if (orcamento.itens) {
                                        // Se for objeto, tentar converter
                                        console.warn('Itens não são array nem string:', orcamento.itens);
                                    }
                                    
                                    // Copiar itens para o campo 'itens' do projeto
                                    if (itens && itens.length > 0) {
                                        projetoData.itens = itens;
                                        projetoData.orcamento_id = orcamentoId; // Garantir que o orcamento_id seja salvo
                                        console.log('✅ Itens copiados do orçamento para o projeto:', itens.length, 'itens');
                                        console.log('Dados do projeto antes de salvar:', JSON.stringify(projetoData, null, 2));
                                    } else {
                                        console.warn('⚠️ Orçamento não possui itens válidos. Itens encontrados:', itens);
                                    }
                                } else {
                                    console.warn('⚠️ Orçamento não encontrado com ID:', orcamentoId);
                                }
                            }
                        } catch (e) {
                            console.error('❌ Erro ao buscar itens do orçamento para copiar:', e);
                            console.error('Stack trace:', e.stack);
                            // Continuar criação mesmo se não conseguir copiar itens
                        }
                    } else {
                        console.log('ℹ️ Projeto criado sem orcamento_id válido');
                    }
                    
                    // Criar projeto
                    console.log('Salvando projeto com dados:', JSON.stringify(projetoData, null, 2));
                    const { error } = await supabase
                        .from('projetos')
                        .insert([projetoData]);

                    if (error) throw error;
                    alert('Projeto criado com sucesso!');
                }

                closeProjetoModal();
                loadProjetos();
                loadDashboardData(); // Atualizar dashboard
            } catch (error) {
                console.error('Erro ao salvar projeto:', error);
                
                // Mensagem de erro mais amigável
                let errorMessage = 'Erro ao salvar projeto: ' + (error.message || 'Erro desconhecido');
                
                // Se o erro for sobre coluna não encontrada, orientar o usuário
                if (error.message && error.message.includes('column') && error.message.includes('schema cache')) {
                    errorMessage = 'Erro: A estrutura da tabela "projetos" está incompleta.\n\n' +
                                 'Por favor, execute o script SQL (supabase_schema.sql) no Supabase para criar todas as colunas necessárias.\n\n' +
                                 'Erro técnico: ' + error.message;
                }
                
                alert(errorMessage);
            }
        });

        // Ver detalhes do projeto
        async function viewProjetoDetails(id) {
            const projeto = allProjetos.find(p => p.id === id);
            if (!projeto) {
                alert('Projeto não encontrado');
                return;
            }

            const content = document.getElementById('projetoDetailsContent');
            const editBtn = document.getElementById('editProjetoFromDetailsBtn');
            const deleteBtn = document.getElementById('deleteProjetoFromDetailsBtn');
            
            // Configurar botão de editar
            editBtn.onclick = () => {
                closeProjetoDetailsModal();
                editProjeto(id);
            };

            // Configurar botão de gerar documento de finalização
            const gerarDocBtn = document.getElementById('gerarDocumentoFinalizacaoBtn');
            if (gerarDocBtn) {
                gerarDocBtn.onclick = () => {
                    closeProjetoDetailsModal();
                    openDocumentoFinalizacaoModal(id);
                };
                // Mostrar botão apenas se projeto estiver concluído ou em andamento
                gerarDocBtn.style.display = (projeto.status === 'concluido' || projeto.status === 'em_andamento') ? 'inline-block' : 'none';
            }

            // Configurar botão de excluir com confirmação
            deleteBtn.onclick = async () => {
                if (!confirm('Tem certeza que deseja excluir este projeto? Esta ação não pode ser desfeita.')) {
                    return;
                }

                try {
                    const { error } = await supabase
                        .from('projetos')
                        .delete()
                        .eq('id', id);

                    if (error) throw error;
                    
                    alert('Projeto excluído com sucesso!');
                    closeProjetoDetailsModal();
                    loadProjetos();
                    loadDashboardData(); // Atualizar dashboard
                } catch (error) {
                    console.error('Erro ao excluir projeto:', error);
                    alert('Erro ao excluir projeto: ' + (error.message || 'Erro desconhecido'));
                }
            };

            const cliente = projeto.cliente || {};
            const clienteNome = cliente.nome || cliente.empresa || 'Cliente não encontrado';

            // Formatar data
            const formatDate = (dateStr) => {
                if (!dateStr) return '-';
                try {
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('pt-BR');
                } catch {
                    return dateStr;
                }
            };

            // Formatar moeda
            const formatCurrency = (value) => {
                if (!value) return 'R$ 0,00';
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(value);
            };

            // Status
            const statusMap = {
                'planejamento': { label: 'Planejamento', class: 'badge-planejamento' },
                'em_andamento': { label: 'Em Andamento', class: 'badge-em-andamento' },
                'pausado': { label: 'Pausado', class: 'badge-pausado' },
                'concluido': { label: 'Concluído', class: 'badge-concluido' },
                'cancelado': { label: 'Cancelado', class: 'badge-cancelado' }
            };

            const status = statusMap[projeto.status] || { label: projeto.status, class: 'badge-planejamento' };

            // Prioridade
            const prioridadeMap = {
                'baixa': { label: 'Baixa', class: 'badge-prioridade-baixa' },
                'media': { label: 'Média', class: 'badge-prioridade-media' },
                'alta': { label: 'Alta', class: 'badge-prioridade-alta' },
                'urgente': { label: 'Urgente', class: 'badge-prioridade-urgente' }
            };
            const prioridade = prioridadeMap[projeto.prioridade] || null;

            // Responsável
            const responsavel = projeto.responsavel || {};
            const responsavelNome = responsavel.nome || '-';

            // Tags
            let tagsHtml = '<span class="details-value empty">Nenhuma tag</span>';
            if (projeto.tags) {
                let tagsArray = [];
                if (Array.isArray(projeto.tags)) {
                    tagsArray = projeto.tags;
                } else if (typeof projeto.tags === 'string') {
                    tagsArray = projeto.tags.split(',').map(t => t.trim()).filter(t => t.length > 0);
                }
                
                if (tagsArray.length > 0) {
                    tagsHtml = tagsArray.map(tag => 
                        `<span class="tag-badge">${tag}</span>`
                    ).join('');
                }
            }

            // Helper para exibir valor ou "-"
            const displayValue = (value) => value || '<span class="empty">-</span>';

            content.innerHTML = `
                <div class="details-section">
                    <div class="details-section-title">Informações Básicas</div>
                    <div class="details-grid">
                        <div class="details-item">
                            <div class="details-label">Nome do Projeto</div>
                            <div class="details-value">${projeto.nome || '-'}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Cliente</div>
                            <div class="details-value">${clienteNome}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Status</div>
                            <div class="details-value">
                                <span class="badge ${status.class}">
                                    ${status.label}
                                </span>
                            </div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Prioridade</div>
                            <div class="details-value">
                                ${prioridade ? `<span class="badge ${prioridade.class}">${prioridade.label}</span>` : '<span class="empty">-</span>'}
                            </div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Responsável</div>
                            <div class="details-value">${responsavelNome}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Valor do Projeto</div>
                            <div class="details-value">${formatCurrency(projeto.valor)}</div>
                        </div>
                    </div>
                </div>

                <div class="details-section">
                    <div class="details-section-title">Tags/Categorias</div>
                    <div class="servicos-list">
                        ${tagsHtml}
                    </div>
                </div>

                <div class="details-section">
                    <div class="details-section-title">Datas</div>
                    <div class="details-grid">
                        <div class="details-item">
                            <div class="details-label">Data de Início</div>
                            <div class="details-value">${formatDate(projeto.data_inicio)}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Data Prevista de Conclusão</div>
                            <div class="details-value">${formatDate(projeto.data_prevista)}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Data de Conclusão</div>
                            <div class="details-value">${formatDate(projeto.data_conclusao)}</div>
                        </div>
                    </div>
                </div>

                <div class="details-section">
                    <div class="details-section-title">Descrição</div>
                    <div class="details-item">
                        <div class="details-value" style="white-space: pre-wrap;">${displayValue(projeto.descricao)}</div>
                    </div>
                </div>

                <div class="details-section">
                    <div class="details-section-title">Observações</div>
                    <div class="details-item">
                        <div class="details-value" style="white-space: pre-wrap;">${displayValue(projeto.observacoes)}</div>
                    </div>
                </div>

                <div class="details-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div class="details-section-title">Checklist de Tarefas</div>
                        <button type="button" class="btn btn-primary" onclick="adicionarTarefa('${projeto.id}')" style="padding: 6px 12px; font-size: 12px;">+ Nova Tarefa</button>
                    </div>
                    <div id="tarefasContainer-${projeto.id}" class="tarefas-container">
                        <div style="text-align: center; padding: 20px; color: var(--text-gray);">
                            Carregando tarefas...
                        </div>
                    </div>
                </div>

                <div class="details-section">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
                        <div class="details-section-title">Arquivos e Documentos</div>
                        <button type="button" class="btn btn-primary" onclick="abrirUploadArquivo('${projeto.id}')" style="padding: 6px 12px; font-size: 12px;">📎 Enviar Arquivo</button>
                    </div>
                    <div id="arquivosContainer-${projeto.id}" class="arquivos-container">
                        <div style="text-align: center; padding: 20px; color: var(--text-gray);">
                            Carregando arquivos...
                        </div>
                    </div>
                </div>
            `;

            const modal = document.getElementById('projetoDetailsModal');
            openModal(modal);
            
            // Carregar tarefas e arquivos do projeto
            await Promise.all([
                loadTarefas(projeto.id),
                loadArquivos(projeto.id)
            ]);
        }

        // Fechar modal de detalhes
        function closeProjetoDetailsModal() {
            const modal = document.getElementById('projetoDetailsModal');
            closeModal(modal);
        }

        // ========== GESTÃO DE TAREFAS ==========
        let tarefasEditando = {}; // Armazena tarefas sendo editadas

        // Carregar tarefas do projeto
        async function loadTarefas(projetoId) {
            const container = document.getElementById(`tarefasContainer-${projetoId}`);
            if (!container) return;

            try {
                const { data, error } = await supabase
                    .from('tarefas')
                    .select('*')
                    .eq('projeto_id', projetoId)
                    .order('ordem', { ascending: true })
                    .order('created_at', { ascending: true });

                if (error) throw error;

                renderTarefas(projetoId, data || []);
            } catch (error) {
                console.error('Erro ao carregar tarefas:', error);
                container.innerHTML = '<div class="tarefa-empty">Erro ao carregar tarefas</div>';
            }
        }

        // Renderizar tarefas
        function renderTarefas(projetoId, tarefas) {
            const container = document.getElementById(`tarefasContainer-${projetoId}`);
            if (!container) return;

            if (!tarefas || tarefas.length === 0) {
                container.innerHTML = '<div class="tarefa-empty">Nenhuma tarefa adicionada ainda</div>';
                return;
            }

            let html = '';
            tarefas.forEach(tarefa => {
                const isEditando = tarefasEditando[tarefa.id];
                if (isEditando) {
                    // Modo de edição
                    html += `
                        <div class="tarefa-item">
                            <div class="tarefa-form" style="width: 100%;">
                                <input type="text" id="tarefaEditInput-${tarefa.id}" value="${(tarefa.descricao || '').replace(/"/g, '&quot;')}" placeholder="Descrição da tarefa" style="flex: 1;">
                                <button type="button" class="btn btn-primary" onclick="salvarTarefa('${tarefa.id}', '${projetoId}')" style="padding: 8px 16px; font-size: 12px;">Salvar</button>
                                <button type="button" class="btn btn-secondary" onclick="cancelarEdicaoTarefa('${tarefa.id}', '${projetoId}')" style="padding: 8px 16px; font-size: 12px;">Cancelar</button>
                            </div>
                        </div>
                    `;
                } else {
                    // Modo de visualização
                    html += `
                        <div class="tarefa-item ${tarefa.concluida ? 'concluida' : ''}">
                            <input type="checkbox" class="tarefa-checkbox" ${tarefa.concluida ? 'checked' : ''} 
                                   onchange="toggleTarefa('${tarefa.id}', '${projetoId}', this.checked)">
                            <div class="tarefa-content">
                                <div class="tarefa-descricao">${tarefa.descricao || ''}</div>
                            </div>
                            <div class="tarefa-actions">
                                <button type="button" class="tarefa-btn tarefa-btn-edit" onclick="editarTarefa('${tarefa.id}', '${projetoId}')" title="Editar">
                                    ✏️
                                </button>
                                <button type="button" class="tarefa-btn tarefa-btn-delete" onclick="deletarTarefa('${tarefa.id}', '${projetoId}')" title="Excluir">
                                    🗑️
                                </button>
                            </div>
                        </div>
                    `;
                }
            });

            container.innerHTML = html;
        }

        // Adicionar nova tarefa
        async function adicionarTarefa(projetoId) {
            const container = document.getElementById(`tarefasContainer-${projetoId}`);
            if (!container) return;

            // Criar formulário de nova tarefa
            const formHtml = `
                <div class="tarefa-item">
                    <div class="tarefa-form" style="width: 100%;">
                        <input type="text" id="novaTarefaInput-${projetoId}" placeholder="Digite a descrição da tarefa..." style="flex: 1;">
                        <button type="button" class="btn btn-primary" onclick="criarTarefa('${projetoId}')" style="padding: 8px 16px; font-size: 12px;">Adicionar</button>
                        <button type="button" class="btn btn-secondary" onclick="cancelarNovaTarefa('${projetoId}')" style="padding: 8px 16px; font-size: 12px;">Cancelar</button>
                    </div>
                </div>
            `;

            // Se estiver vazio, substituir; senão, adicionar no início
            if (container.querySelector('.tarefa-empty')) {
                container.innerHTML = formHtml;
            } else {
                container.insertAdjacentHTML('afterbegin', formHtml);
            }

            // Focar no input
            setTimeout(() => {
                const input = document.getElementById(`novaTarefaInput-${projetoId}`);
                if (input) input.focus();
            }, 100);
        }

        // Criar tarefa
        async function criarTarefa(projetoId) {
            const input = document.getElementById(`novaTarefaInput-${projetoId}`);
            if (!input) return;

            const descricao = input.value.trim();
            if (!descricao) {
                alert('Por favor, digite uma descrição para a tarefa');
                return;
            }

            try {
                // Contar tarefas existentes para definir ordem
                const { count } = await supabase
                    .from('tarefas')
                    .select('*', { count: 'exact', head: true })
                    .eq('projeto_id', projetoId);

                const { data, error } = await supabase
                    .from('tarefas')
                    .insert({
                        projeto_id: projetoId,
                        descricao: descricao,
                        concluida: false,
                        ordem: (count || 0) + 1
                    })
                    .select()
                    .single();

                if (error) throw error;

                // Recarregar tarefas
                await loadTarefas(projetoId);
            } catch (error) {
                console.error('Erro ao criar tarefa:', error);
                alert('Erro ao criar tarefa: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // Cancelar nova tarefa
        async function cancelarNovaTarefa(projetoId) {
            await loadTarefas(projetoId);
        }

        // Editar tarefa
        function editarTarefa(tarefaId, projetoId) {
            tarefasEditando[tarefaId] = true;
            loadTarefas(projetoId);
            
            // Focar no input após renderizar
            setTimeout(() => {
                const input = document.getElementById(`tarefaEditInput-${tarefaId}`);
                if (input) {
                    input.focus();
                    input.select();
                }
            }, 100);
        }

        // Salvar tarefa editada
        async function salvarTarefa(tarefaId, projetoId) {
            const input = document.getElementById(`tarefaEditInput-${tarefaId}`);
            if (!input) return;

            const descricao = input.value.trim();
            if (!descricao) {
                alert('Por favor, digite uma descrição para a tarefa');
                return;
            }

            try {
                const { error } = await supabase
                    .from('tarefas')
                    .update({ descricao: descricao })
                    .eq('id', tarefaId);

                if (error) throw error;

                delete tarefasEditando[tarefaId];
                await loadTarefas(projetoId);
            } catch (error) {
                console.error('Erro ao salvar tarefa:', error);
                alert('Erro ao salvar tarefa: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // Cancelar edição de tarefa
        function cancelarEdicaoTarefa(tarefaId, projetoId) {
            delete tarefasEditando[tarefaId];
            loadTarefas(projetoId);
        }

        // Toggle tarefa (marcar/desmarcar como concluída)
        async function toggleTarefa(tarefaId, projetoId, concluida) {
            try {
                const { error } = await supabase
                    .from('tarefas')
                    .update({ concluida: concluida })
                    .eq('id', tarefaId);

                if (error) throw error;

                // Recarregar tarefas para atualizar visual
                await loadTarefas(projetoId);
            } catch (error) {
                console.error('Erro ao atualizar tarefa:', error);
                alert('Erro ao atualizar tarefa: ' + (error.message || 'Erro desconhecido'));
                // Recarregar para reverter visual
                await loadTarefas(projetoId);
            }
        }

        // Deletar tarefa
        async function deletarTarefa(tarefaId, projetoId) {
            if (!confirm('Tem certeza que deseja excluir esta tarefa?')) {
                return;
            }

            try {
                const { error } = await supabase
                    .from('tarefas')
                    .delete()
                    .eq('id', tarefaId);

                if (error) throw error;

                await loadTarefas(projetoId);
            } catch (error) {
                console.error('Erro ao deletar tarefa:', error);
                alert('Erro ao deletar tarefa: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // ========== GESTÃO DE ARQUIVOS ==========
        let arquivosUpload = {}; // Armazena arquivos selecionados para upload

        // Obter ícone baseado na extensão do arquivo
        function getFileIcon(nomeArquivo) {
            const ext = nomeArquivo.split('.').pop().toLowerCase();
            const icons = {
                'pdf': '📄',
                'doc': '📝', 'docx': '📝',
                'xls': '📊', 'xlsx': '📊',
                'ppt': '📊', 'pptx': '📊',
                'jpg': '🖼️', 'jpeg': '🖼️', 'png': '🖼️', 'gif': '🖼️', 'svg': '🖼️',
                'zip': '📦', 'rar': '📦', '7z': '📦',
                'mp4': '🎥', 'avi': '🎥', 'mov': '🎥',
                'mp3': '🎵', 'wav': '🎵',
                'txt': '📋',
                'html': '🌐', 'css': '🌐', 'js': '🌐',
            };
            return icons[ext] || '📎';
        }

        // Verificar se é uma imagem
        function isImageFile(nomeArquivo, tipoMime) {
            const ext = nomeArquivo.split('.').pop().toLowerCase();
            const imageExts = ['jpg', 'jpeg', 'png', 'gif', 'svg', 'webp', 'bmp'];
            const imageMimes = ['image/jpeg', 'image/png', 'image/gif', 'image/svg+xml', 'image/webp', 'image/bmp'];
            return imageExts.includes(ext) || (tipoMime && imageMimes.includes(tipoMime));
        }

        // Formatar tamanho do arquivo
        function formatFileSize(bytes) {
            if (!bytes) return '0 B';
            const k = 1024;
            const sizes = ['B', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        // Carregar arquivos do projeto
        async function loadArquivos(projetoId) {
            const container = document.getElementById(`arquivosContainer-${projetoId}`);
            if (!container) return;

            try {
                const { data, error } = await supabase
                    .from('arquivos_projeto')
                    .select('*')
                    .eq('projeto_id', projetoId)
                    .order('created_at', { ascending: false });

                if (error) throw error;

                renderArquivos(projetoId, data || []);
            } catch (error) {
                console.error('Erro ao carregar arquivos:', error);
                container.innerHTML = '<div class="arquivo-empty">Erro ao carregar arquivos</div>';
            }
        }

        // Renderizar arquivos
        function renderArquivos(projetoId, arquivos) {
            const container = document.getElementById(`arquivosContainer-${projetoId}`);
            if (!container) return;

            if (!arquivos || arquivos.length === 0) {
                container.innerHTML = '<div class="arquivo-empty">Nenhum arquivo enviado ainda</div>';
                return;
            }

            let html = '';
            arquivos.forEach(arquivo => {
                const icon = getFileIcon(arquivo.nome_original || arquivo.nome_arquivo);
                const tamanho = formatFileSize(arquivo.tamanho_bytes);
                const dataUpload = new Date(arquivo.created_at).toLocaleDateString('pt-BR');
                const isImage = isImageFile(arquivo.nome_original || arquivo.nome_arquivo, arquivo.tipo_mime);

                html += `
                    <div class="arquivo-item">
                        <div class="arquivo-icon">${icon}</div>
                        <div class="arquivo-info">
                            <div class="arquivo-nome">${arquivo.nome_original || arquivo.nome_arquivo}</div>
                            <div class="arquivo-meta">
                                <span>📏 ${tamanho}</span>
                                <span>📅 ${dataUpload}</span>
                                ${arquivo.tipo_mime ? `<span>${arquivo.tipo_mime}</span>` : ''}
                            </div>
                            ${arquivo.descricao ? `<div class="arquivo-descricao">${arquivo.descricao}</div>` : ''}
                        </div>
                        <div class="arquivo-actions">
                            ${isImage ? `
                                <button type="button" class="arquivo-btn arquivo-btn-view" onclick="visualizarArquivo('${arquivo.id}', '${projetoId}')" title="Visualizar">
                                    👁️ Visualizar
                                </button>
                            ` : ''}
                            <button type="button" class="arquivo-btn arquivo-btn-download" onclick="downloadArquivo('${arquivo.id}', '${projetoId}')" title="Download">
                                ⬇️ Download
                            </button>
                            <button type="button" class="arquivo-btn arquivo-btn-delete" onclick="deletarArquivo('${arquivo.id}', '${projetoId}')" title="Excluir">
                                🗑️
                            </button>
                        </div>
                    </div>
                `;
            });

            container.innerHTML = html;
        }

        // Abrir formulário de upload
        function abrirUploadArquivo(projetoId) {
            const container = document.getElementById(`arquivosContainer-${projetoId}`);
            if (!container) return;

            // Criar formulário de upload
            const formHtml = `
                <div class="upload-form">
                    <input type="file" id="arquivoInput-${projetoId}" onchange="selecionarArquivo('${projetoId}', this.files[0])" multiple>
                    <label for="arquivoInput-${projetoId}" class="upload-form-label" id="uploadLabel-${projetoId}">
                        <div>📎 Clique para selecionar arquivo(s) ou arraste aqui</div>
                        <div class="upload-file-name" id="uploadFileName-${projetoId}" style="display: none;"></div>
                    </label>
                    <textarea id="arquivoDescricao-${projetoId}" class="form-input" rows="2" placeholder="Descrição opcional do arquivo..." style="margin-top: 12px; width: 100%; resize: vertical;"></textarea>
                    <div class="upload-actions">
                        <button type="button" class="btn btn-primary" onclick="uploadArquivo('${projetoId}')" style="flex: 1;">📤 Enviar</button>
                        <button type="button" class="btn btn-secondary" onclick="cancelarUploadArquivo('${projetoId}')" style="flex: 1;">Cancelar</button>
                    </div>
                </div>
            `;

            // Se estiver vazio, substituir; senão, adicionar no início
            if (container.querySelector('.arquivo-empty')) {
                container.innerHTML = formHtml;
            } else {
                container.insertAdjacentHTML('afterbegin', formHtml);
            }

            // Permitir drag and drop
            const label = document.getElementById(`uploadLabel-${projetoId}`);
            if (label) {
                label.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    label.style.borderColor = 'var(--primary)';
                });
                label.addEventListener('dragleave', () => {
                    label.style.borderColor = 'rgba(255, 255, 255, 0.3)';
                });
                label.addEventListener('drop', (e) => {
                    e.preventDefault();
                    label.style.borderColor = 'rgba(255, 255, 255, 0.3)';
                    const files = e.dataTransfer.files;
                    if (files.length > 0) {
                        selecionarArquivo(projetoId, files[0]);
                    }
                });
            }
        }

        // Selecionar arquivo
        function selecionarArquivo(projetoId, file) {
            if (!file) return;

            arquivosUpload[projetoId] = file;
            const label = document.getElementById(`uploadLabel-${projetoId}`);
            const fileName = document.getElementById(`uploadFileName-${projetoId}`);

            if (label && fileName) {
                label.classList.add('has-file');
                fileName.textContent = `📎 ${file.name} (${formatFileSize(file.size)})`;
                fileName.style.display = 'block';
            }
        }

        // Upload de arquivo
        async function uploadArquivo(projetoId) {
            const file = arquivosUpload[projetoId];
            if (!file) {
                alert('Por favor, selecione um arquivo');
                return;
            }

            const descricao = document.getElementById(`arquivoDescricao-${projetoId}`)?.value.trim() || null;

            try {
                // Gerar nome único para o arquivo
                const fileExt = file.name.split('.').pop();
                const fileName = `${projetoId}/${Date.now()}_${Math.random().toString(36).substring(7)}.${fileExt}`;
                const storagePath = `projetos/${fileName}`;

                // Upload para Supabase Storage
                const { data: uploadData, error: uploadError } = await supabase.storage
                    .from('arquivos')
                    .upload(storagePath, file, {
                        cacheControl: '3600',
                        upsert: false
                    });

                if (uploadError) {
                    console.error('Erro detalhado do Storage:', uploadError);
                    // Se o bucket não existir, tentar criar
                    if (uploadError.message.includes('Bucket not found')) {
                        alert('Bucket de storage não encontrado. Por favor, crie um bucket chamado "arquivos" no Supabase Storage.');
                        return;
                    }
                    // Se for erro de RLS/política
                    if (uploadError.message && (uploadError.message.includes('row-level security') || uploadError.message.includes('policy'))) {
                        alert('Erro de política de Storage: Configure as políticas do bucket "arquivos" no Supabase Storage. Veja o arquivo configurar_storage_policies.md para instruções.');
                        return;
                    }
                    throw uploadError;
                }

                // Obter URL pública do arquivo
                const { data: urlData } = supabase.storage
                    .from('arquivos')
                    .getPublicUrl(storagePath);

                // Verificar se há sessão ativa (opcional, mas ajuda no debug)
                const { data: { session } } = await supabase.auth.getSession();
                console.log('Session:', session);

                // Salvar metadados no banco
                const { data: dbData, error: dbError } = await supabase
                    .from('arquivos_projeto')
                    .insert({
                        projeto_id: projetoId,
                        nome_arquivo: fileName,
                        nome_original: file.name,
                        caminho_storage: storagePath,
                        tipo_mime: file.type || null,
                        tamanho_bytes: file.size,
                        descricao: descricao
                    })
                    .select()
                    .single();

                if (dbError) {
                    console.error('Erro detalhado do banco:', dbError);
                    // Se for erro de RLS, dar mensagem mais clara
                    if (dbError.message && dbError.message.includes('row-level security')) {
                        throw new Error('Erro de segurança: A tabela arquivos_projeto ainda tem RLS habilitado. Execute o SQL fix_arquivos_rls.sql no Supabase.');
                    }
                    throw dbError;
                }

                // Limpar formulário
                delete arquivosUpload[projetoId];
                const input = document.getElementById(`arquivoInput-${projetoId}`);
                if (input) input.value = '';
                const descInput = document.getElementById(`arquivoDescricao-${projetoId}`);
                if (descInput) descInput.value = '';

                // Recarregar arquivos
                await loadArquivos(projetoId);
            } catch (error) {
                console.error('Erro ao fazer upload do arquivo:', error);
                alert('Erro ao fazer upload: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // Cancelar upload
        function cancelarUploadArquivo(projetoId) {
            delete arquivosUpload[projetoId];
            loadArquivos(projetoId);
        }

        // Download de arquivo
        async function downloadArquivo(arquivoId, projetoId) {
            try {
                // Buscar informações do arquivo
                const { data: arquivo, error: fetchError } = await supabase
                    .from('arquivos_projeto')
                    .select('*')
                    .eq('id', arquivoId)
                    .single();

                if (fetchError) throw fetchError;
                if (!arquivo) {
                    alert('Arquivo não encontrado');
                    return;
                }

                // Baixar arquivo do storage
                const { data, error: downloadError } = await supabase.storage
                    .from('arquivos')
                    .download(arquivo.caminho_storage);

                if (downloadError) throw downloadError;

                // Criar link de download
                const url = window.URL.createObjectURL(data);
                const a = document.createElement('a');
                a.href = url;
                a.download = arquivo.nome_original || arquivo.nome_arquivo;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                window.URL.revokeObjectURL(url);
            } catch (error) {
                console.error('Erro ao fazer download do arquivo:', error);
                alert('Erro ao fazer download: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // Visualizar arquivo (imagem)
        async function visualizarArquivo(arquivoId, projetoId) {
            try {
                // Buscar informações do arquivo
                const { data: arquivo, error: fetchError } = await supabase
                    .from('arquivos_projeto')
                    .select('*')
                    .eq('id', arquivoId)
                    .single();

                if (fetchError) throw fetchError;
                if (!arquivo) {
                    alert('Arquivo não encontrado');
                    return;
                }

                // Obter URL pública do arquivo
                const { data: urlData } = supabase.storage
                    .from('arquivos')
                    .getPublicUrl(arquivo.caminho_storage);

                // Criar modal de visualização
                const modal = document.createElement('div');
                modal.className = 'image-viewer-modal';
                modal.innerHTML = `
                    <div class="image-viewer-content">
                        <button class="image-viewer-close" onclick="this.closest('.image-viewer-modal').remove()">&times;</button>
                        <img src="${urlData.publicUrl}" alt="${arquivo.nome_original}" style="display: block;">
                        <div style="text-align: center; margin-top: 16px; color: white;">
                            <div style="font-weight: 600; margin-bottom: 4px;">${arquivo.nome_original}</div>
                            <div style="font-size: 12px; color: rgba(255,255,255,0.7);">${formatFileSize(arquivo.tamanho_bytes)} • ${new Date(arquivo.created_at).toLocaleDateString('pt-BR')}</div>
                        </div>
                    </div>
                `;

                document.body.appendChild(modal);

                // Fechar ao clicar fora da imagem
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.remove();
                    }
                });

                // Fechar com ESC
                const handleEsc = (e) => {
                    if (e.key === 'Escape') {
                        modal.remove();
                        document.removeEventListener('keydown', handleEsc);
                    }
                };
                document.addEventListener('keydown', handleEsc);
            } catch (error) {
                console.error('Erro ao visualizar arquivo:', error);
                alert('Erro ao visualizar arquivo: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // Deletar arquivo
        async function deletarArquivo(arquivoId, projetoId) {
            if (!confirm('Tem certeza que deseja excluir este arquivo?')) {
                return;
            }

            try {
                // Buscar informações do arquivo
                const { data: arquivo, error: fetchError } = await supabase
                    .from('arquivos_projeto')
                    .select('*')
                    .eq('id', arquivoId)
                    .single();

                if (fetchError) throw fetchError;

                // Deletar do storage
                const { error: storageError } = await supabase.storage
                    .from('arquivos')
                    .remove([arquivo.caminho_storage]);

                if (storageError) {
                    console.warn('Erro ao deletar do storage (continuando):', storageError);
                }

                // Deletar do banco
                const { error: dbError } = await supabase
                    .from('arquivos_projeto')
                    .delete()
                    .eq('id', arquivoId);

                if (dbError) throw dbError;

                // Recarregar arquivos
                await loadArquivos(projetoId);
            } catch (error) {
                console.error('Erro ao deletar arquivo:', error);
                alert('Erro ao deletar arquivo: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // ========== CRUD ORÇAMENTOS ==========
        let allOrcamentos = [];
        let filteredOrcamentos = [];

        // Carregar orçamentos do Supabase
        async function loadOrcamentos() {
            const loading = document.getElementById('orcamentosLoading');
            const table = document.getElementById('orcamentosTable');
            const empty = document.getElementById('orcamentosEmpty');
            
            loading.classList.add('active');
            table.style.display = 'none';
            empty.style.display = 'none';

            try {
                // Buscar orçamentos (incluindo novos campos de link público e assinatura)
                const { data: orcamentosData, error: orcamentosError } = await supabase
                    .from('orcamentos')
                    .select('*, cliente:clientes(*)')
                    .order('created_at', { ascending: false });

                if (orcamentosError) throw orcamentosError;

                // Combinar dados e fazer parse dos itens (cliente já vem na relação)
                allOrcamentos = (orcamentosData || []).map(orcamento => {
                    // Fazer parse dos itens se vier como string
                    let itens = orcamento.itens || [];
                    if (typeof itens === 'string') {
                        try {
                            itens = JSON.parse(itens);
                        } catch (e) {
                            console.error('Erro ao fazer parse dos itens do orçamento:', e);
                            itens = [];
                        }
                    }
                    if (!Array.isArray(itens)) {
                        itens = [];
                    }
                    
                    return {
                        ...orcamento,
                        itens: itens
                        // cliente já vem na relação do Supabase
                    };
                });

                filteredOrcamentos = [...allOrcamentos];
                renderOrcamentos();
            } catch (error) {
                console.error('Erro ao carregar orçamentos:', error);
                allOrcamentos = [];
                filteredOrcamentos = [];
                renderOrcamentos();
            } finally {
                loading.classList.remove('active');
            }
        }

        // Renderizar tabela de orçamentos
        function renderOrcamentos() {
            const tbody = document.getElementById('orcamentosTableBody');
            const table = document.getElementById('orcamentosTable');
            const empty = document.getElementById('orcamentosEmpty');

            if (filteredOrcamentos.length === 0) {
                table.style.display = 'none';
                empty.style.display = 'block';
                return;
            }

            table.style.display = 'table';
            empty.style.display = 'none';

            tbody.innerHTML = filteredOrcamentos.map(orcamento => {
                const cliente = orcamento.cliente || {};
                const clienteNome = cliente.nome || cliente.empresa || 'Cliente não encontrado';
                
                const formatDate = (dateStr) => {
                    if (!dateStr) return '-';
                    try {
                        const date = new Date(dateStr);
                        return date.toLocaleDateString('pt-BR');
                    } catch {
                        return dateStr;
                    }
                };

                const formatCurrency = (value) => {
                    if (!value) return 'R$ 0,00';
                    return new Intl.NumberFormat('pt-BR', {
                        style: 'currency',
                        currency: 'BRL'
                    }).format(value);
                };

                // Calcular data de validade
                let dataValidade = '-';
                if (orcamento.data && orcamento.validade_dias) {
                    try {
                        const data = new Date(orcamento.data);
                        data.setDate(data.getDate() + parseInt(orcamento.validade_dias));
                        dataValidade = formatDate(data.toISOString());
                    } catch (e) {
                        dataValidade = '-';
                    }
                }

                const statusMap = {
                    'rascunho': { label: 'Rascunho', class: 'badge-rascunho' },
                    'enviado': { label: 'Enviado', class: 'badge-enviado' },
                    'aprovado': { label: 'Aprovado', class: 'badge-aprovado' },
                    'rejeitado': { label: 'Rejeitado', class: 'badge-rejeitado' },
                    'expirado': { label: 'Expirado', class: 'badge-expirado' }
                };

                const status = statusMap[orcamento.status] || { label: orcamento.status, class: 'badge-rascunho' };

                return `
                    <tr>
                        <td data-label="Número">${orcamento.numero || 'N/A'}</td>
                        <td data-label="Cliente">${clienteNome}</td>
                        <td data-label="Data">${formatDate(orcamento.data)}</td>
                        <td data-label="Valor">${formatCurrency(orcamento.valor)}</td>
                        <td data-label="Validade">${dataValidade}</td>
                        <td data-label="Status">
                            <span class="badge ${status.class}">
                                ${status.label}
                            </span>
                        </td>
                        <td data-label="Ações">
                            <button class="btn-action" onclick="viewOrcamentoDetails('${orcamento.id}')" style="border-color: var(--primary); color: var(--primary); margin-right: 4px;">Ver</button>
                            <button class="btn-action" onclick="selecionarTemplateEEnviar('${orcamento.cliente_id}', 'orcamento', {orcamento_numero: '${orcamento.numero || ''}', valor: ${orcamento.valor || 0}})" style="border-color: #25D366; color: #25D366; margin-right: 4px;" title="Enviar WhatsApp">💬</button>
                            ${orcamento.status === 'enviado' ? `
                                <button class="btn-action" onclick="aprovarOrcamento('${orcamento.id}')" style="border-color: var(--success); color: var(--success); margin-right: 4px;" title="Aprovar">✓</button>
                                <button class="btn-action" onclick="recusarOrcamento('${orcamento.id}')" style="border-color: var(--danger); color: var(--danger);" title="Recusar">✗</button>
                            ` : ''}
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Filtrar orçamentos
        function filterOrcamentos() {
            const search = document.getElementById('orcamentoSearch').value.toLowerCase();
            const statusFilter = document.getElementById('orcamentoStatusFilter').value;

            filteredOrcamentos = allOrcamentos.filter(orcamento => {
                const cliente = orcamento.cliente || {};
                const clienteNome = (cliente.nome || cliente.empresa || '').toLowerCase();
                const numero = (orcamento.numero || '').toLowerCase();
                const descricao = (orcamento.descricao || '').toLowerCase();
                
                const matchSearch = !search || 
                    numero.includes(search) ||
                    clienteNome.includes(search) ||
                    descricao.includes(search);
                
                const matchStatus = !statusFilter || orcamento.status === statusFilter;
                
                return matchSearch && matchStatus;
            });

            renderOrcamentos();
        }

        // Abrir modal de orçamento (novo)
        async function openOrcamentoModal() {
            await criarOrcamentoParaCliente(null);
        }

        // Criar orçamento para um cliente específico
        async function criarOrcamentoParaCliente(clienteId) {
            document.getElementById('orcamentoModalTitle').textContent = 'Novo Orçamento';
            document.getElementById('orcamentoForm').reset();
            document.getElementById('orcamentoId').value = '';
            
            // Limpar checkboxes de serviços
            document.querySelectorAll('#orcamentoServicosContainer input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            // Fechar todos os submenus
            document.querySelectorAll('#orcamentoServicosContainer .servico-submenu').forEach(submenu => {
                submenu.classList.remove('active');
            });
            
            // Limpar checkboxes de forma de pagamento
            document.getElementById('orcamentoFormaPagamentoCartao').checked = false;
            document.getElementById('orcamentoFormaPagamentoPix').checked = false;
            document.getElementById('orcamentoFormaPagamentoDinheiro').checked = false;
            document.getElementById('orcamentoFormaPagamentoBoleto').checked = false;
            document.getElementById('orcamentoFormaPagamento').value = '';
            
            carregarItensOrcamento([]);
            document.getElementById('orcamentoDescontoGeral').value = '0';
            
            // Preencher data com hoje
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('orcamentoData').value = hoje;
            
            // Gerar número do orçamento
            try {
                const { data, error } = await supabase
                    .from('orcamentos')
                    .select('numero')
                    .order('created_at', { ascending: false })
                    .limit(1);
                
                let proximoNumero = 1;
                if (!error && data && data.length > 0 && data[0].numero) {
                    const ultimoNumero = parseInt(data[0].numero) || 0;
                    proximoNumero = ultimoNumero + 1;
                }
                
                document.getElementById('orcamentoNumero').value = proximoNumero.toString().padStart(4, '0');
            } catch (e) {
                document.getElementById('orcamentoNumero').value = '0001';
            }
            
            // Carregar clientes no select
            await loadClientesForOrcamentoSelect();
            
            // Selecionar cliente se fornecido
            if (clienteId) {
                document.getElementById('orcamentoClienteId').value = clienteId;
            }
            
            const modal = document.getElementById('orcamentoModal');
            openModal(modal);
        }

        // Carregar clientes no select de orçamento
        async function loadClientesForOrcamentoSelect() {
            try {
                const { data, error } = await supabase
                    .from('clientes')
                    .select('id, nome, empresa')
                    .eq('status', 'ativo')
                    .order('nome', { ascending: true });

                if (error) throw error;

                const select = document.getElementById('orcamentoClienteId');
                select.innerHTML = '<option value="">Selecione um cliente</option>';
                
                (data || []).forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.id;
                    option.textContent = cliente.empresa ? `${cliente.nome} - ${cliente.empresa}` : cliente.nome;
                    select.appendChild(option);
                });

            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
            }
        }

        // Atualizar forma de pagamento (coletar checkboxes marcados)
        function atualizarFormaPagamento() {
            const formasSelecionadas = [];
            if (document.getElementById('orcamentoFormaPagamentoCartao').checked) {
                formasSelecionadas.push('Cartão de Crédito e Débito');
            }
            if (document.getElementById('orcamentoFormaPagamentoPix').checked) {
                formasSelecionadas.push('PIX');
            }
            if (document.getElementById('orcamentoFormaPagamentoDinheiro').checked) {
                formasSelecionadas.push('Dinheiro');
            }
            if (document.getElementById('orcamentoFormaPagamentoBoleto').checked) {
                formasSelecionadas.push('Boleto');
            }
            document.getElementById('orcamentoFormaPagamento').value = formasSelecionadas.join(', ');
        }

        // Fechar modal
        function closeOrcamentoModal() {
            const modal = document.getElementById('orcamentoModal');
            closeModal(modal);
            
            // Limpar checkboxes de serviços
            document.querySelectorAll('#orcamentoServicosContainer input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
            // Fechar todos os submenus
            document.querySelectorAll('#orcamentoServicosContainer .servico-submenu').forEach(submenu => {
                submenu.classList.remove('active');
            });
            // Limpar checkboxes de forma de pagamento
            document.getElementById('orcamentoFormaPagamentoCartao').checked = false;
            document.getElementById('orcamentoFormaPagamentoPix').checked = false;
            document.getElementById('orcamentoFormaPagamentoDinheiro').checked = false;
            document.getElementById('orcamentoFormaPagamentoBoleto').checked = false;
            document.getElementById('orcamentoFormaPagamento').value = '';
        }

        // Editar orçamento
        async function editOrcamento(id) {
            const orcamento = allOrcamentos.find(o => o.id === id);
            if (!orcamento) return;

            document.getElementById('orcamentoModalTitle').textContent = 'Editar Orçamento';
            document.getElementById('orcamentoId').value = orcamento.id;
            document.getElementById('orcamentoNumero').value = orcamento.numero || '';
            document.getElementById('orcamentoData').value = orcamento.data ? orcamento.data.split('T')[0] : '';
            document.getElementById('orcamentoValidade').value = orcamento.validade_dias || 30;
            document.getElementById('orcamentoDescontoGeral').value = orcamento.desconto_geral || 0;
            document.getElementById('orcamentoStatus').value = orcamento.status || 'rascunho';
            
            // Extrair condições comerciais das observações
            const observacoes = orcamento.observacoes || '';
            let condicoesPagamento = '';
            let formaPagamento = '';
            let prazoEntrega = '';
            let observacoesLimpa = observacoes;
            
            if (observacoes.includes('=== CONDIÇÕES COMERCIAIS ===')) {
                const partes = observacoes.split('=== CONDIÇÕES COMERCIAIS ===');
                observacoesLimpa = partes[0].trim();
                const condicoesTexto = partes[1] || '';
                
                // Extrair condições de pagamento
                const matchCondicoes = condicoesTexto.match(/Condições de Pagamento:\s*(.+?)(?:\n|$)/i);
                if (matchCondicoes) condicoesPagamento = matchCondicoes[1].trim();
                
                // Extrair forma de pagamento
                const matchForma = condicoesTexto.match(/Forma de Pagamento:\s*(.+?)(?:\n|$)/i);
                if (matchForma) formaPagamento = matchForma[1].trim();
                
                // Extrair prazo de entrega
                const matchPrazo = condicoesTexto.match(/Prazo de Entrega:\s*(.+?)(?:\n|$)/i);
                if (matchPrazo) prazoEntrega = matchPrazo[1].trim();
            }
            
            document.getElementById('orcamentoCondicoesPagamento').value = condicoesPagamento;
            document.getElementById('orcamentoPrazoEntrega').value = prazoEntrega;
            document.getElementById('orcamentoObservacoes').value = observacoesLimpa;
            
            // Marcar checkboxes de forma de pagamento
            if (formaPagamento) {
                const formas = formaPagamento.split(',').map(f => f.trim());
                document.getElementById('orcamentoFormaPagamentoCartao').checked = formas.includes('Cartão de Crédito e Débito');
                document.getElementById('orcamentoFormaPagamentoPix').checked = formas.includes('PIX');
                document.getElementById('orcamentoFormaPagamentoDinheiro').checked = formas.includes('Dinheiro');
                document.getElementById('orcamentoFormaPagamentoBoleto').checked = formas.includes('Boleto');
                atualizarFormaPagamento();
            } else {
                document.getElementById('orcamentoFormaPagamentoCartao').checked = false;
                document.getElementById('orcamentoFormaPagamentoPix').checked = false;
                document.getElementById('orcamentoFormaPagamentoDinheiro').checked = false;
                document.getElementById('orcamentoFormaPagamentoBoleto').checked = false;
                document.getElementById('orcamentoFormaPagamento').value = '';
            }

            // Carregar itens (pode vir como string JSON ou array)
            let itens = orcamento.itens || [];
            if (typeof itens === 'string') {
                try {
                    itens = JSON.parse(itens);
                } catch (e) {
                    console.error('Erro ao fazer parse dos itens:', e);
                    itens = [];
                }
            }
            if (!Array.isArray(itens)) {
                itens = [];
            }
            carregarItensOrcamento(itens);

            // Carregar clientes e selecionar o cliente do orçamento
            await loadClientesForOrcamentoSelect();
            const clienteId = orcamento.cliente_id || '';
            document.getElementById('orcamentoClienteId').value = clienteId;

            document.getElementById('orcamentoModal').classList.add('active');
        }

        // Salvar orçamento (criar ou atualizar)
        document.getElementById('orcamentoForm').addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('orcamentoId').value;
            const itens = coletarItensOrcamento();

            if (itens.length === 0) {
                alert('Adicione pelo menos um item ao orçamento!');
                return;
            }

            // Coletar condições comerciais para incluir nas observações
            const condicoesPagamento = document.getElementById('orcamentoCondicoesPagamento').value.trim();
            const formaPagamento = document.getElementById('orcamentoFormaPagamento').value.trim();
            const prazoEntrega = document.getElementById('orcamentoPrazoEntrega').value.trim();
            const observacoes = document.getElementById('orcamentoObservacoes').value.trim();
            
            // Montar observações completas incluindo condições comerciais
            let observacoesCompletas = observacoes || '';
            if (condicoesPagamento || formaPagamento || prazoEntrega) {
                if (observacoesCompletas) observacoesCompletas += '\n\n';
                observacoesCompletas += '=== CONDIÇÕES COMERCIAIS ===\n';
                if (condicoesPagamento) observacoesCompletas += `Condições de Pagamento: ${condicoesPagamento}\n`;
                if (formaPagamento) observacoesCompletas += `Forma de Pagamento: ${formaPagamento}\n`;
                if (prazoEntrega) observacoesCompletas += `Prazo de Entrega: ${prazoEntrega}`;
            }

            const orcamentoData = {
                numero: document.getElementById('orcamentoNumero').value.trim(),
                cliente_id: document.getElementById('orcamentoClienteId').value,
                data: document.getElementById('orcamentoData').value,
                validade_dias: parseInt(document.getElementById('orcamentoValidade').value) || 30,
                valor: parseFloat(document.getElementById('orcamentoValor').value) || 0,
                desconto_geral: parseFloat(document.getElementById('orcamentoDescontoGeral').value) || 0,
                status: document.getElementById('orcamentoStatus').value,
                itens: itens,
                observacoes: observacoesCompletas || null
            };

            try {
                if (id) {
                    // Atualizar
                    const { error } = await supabase
                        .from('orcamentos')
                        .update(orcamentoData)
                        .eq('id', id);

                    if (error) throw error;
                    alert('Orçamento atualizado com sucesso!');
                } else {
                    // Criar
                    const { error } = await supabase
                        .from('orcamentos')
                        .insert([orcamentoData]);

                    if (error) throw error;
                    alert('Orçamento criado com sucesso!');
                }

                closeOrcamentoModal();
                loadOrcamentos();
                loadDashboardData();
            } catch (error) {
                console.error('Erro ao salvar orçamento:', error);
                alert('Erro ao salvar orçamento: ' + (error.message || 'Erro desconhecido'));
            }
        });

        // Ver detalhes do orçamento
        function viewOrcamentoDetails(id) {
            const orcamento = allOrcamentos.find(o => o.id === id);
            if (!orcamento) {
                alert('Orçamento não encontrado');
                return;
            }

            const content = document.getElementById('orcamentoDetailsContent');
            const editBtn = document.getElementById('editOrcamentoFromDetailsBtn');
            const deleteBtn = document.getElementById('deleteOrcamentoFromDetailsBtn');
            
            editBtn.onclick = () => {
                closeOrcamentoDetailsModal();
                editOrcamento(id);
            };

            deleteBtn.onclick = async () => {
                if (!confirm('Tem certeza que deseja excluir este orçamento? Esta ação não pode ser desfeita.')) {
                    return;
                }

                try {
                    const { error } = await supabase
                        .from('orcamentos')
                        .delete()
                        .eq('id', id);

                    if (error) throw error;
                    
                    alert('Orçamento excluído com sucesso!');
                    closeOrcamentoDetailsModal();
                    loadOrcamentos();
                    loadDashboardData();
                } catch (error) {
                    console.error('Erro ao excluir orçamento:', error);
                    alert('Erro ao excluir orçamento: ' + (error.message || 'Erro desconhecido'));
                }
            };

            const cliente = orcamento.cliente || {};
            const clienteNome = cliente.nome || cliente.empresa || 'Cliente não encontrado';

            const formatDate = (dateStr) => {
                if (!dateStr) return '-';
                try {
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('pt-BR');
                } catch {
                    return dateStr;
                }
            };

            const formatCurrency = (value) => {
                if (!value) return 'R$ 0,00';
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(value);
            };

            // Calcular data de validade
            let dataValidade = '-';
            if (orcamento.data && orcamento.validade_dias) {
                try {
                    const data = new Date(orcamento.data);
                    data.setDate(data.getDate() + parseInt(orcamento.validade_dias));
                    dataValidade = formatDate(data.toISOString());
                } catch (e) {
                    dataValidade = '-';
                }
            }

            const statusMap = {
                'rascunho': { label: 'Rascunho', class: 'badge-rascunho' },
                'enviado': { label: 'Enviado', class: 'badge-enviado' },
                'aprovado': { label: 'Aprovado', class: 'badge-aprovado' },
                'rejeitado': { label: 'Rejeitado', class: 'badge-rejeitado' },
                'expirado': { label: 'Expirado', class: 'badge-expirado' }
            };

            const status = statusMap[orcamento.status] || { label: orcamento.status, class: 'badge-rascunho' };

            const displayValue = (value) => value || '<span class="empty">-</span>';

            // Preparar itens do orçamento
            const itens = orcamento.itens || [];
            let itensHtml = '';
            let subtotalItens = 0;

            if (itens.length > 0) {
                itensHtml = '<table style="width: 100%; border-collapse: collapse; margin-top: 12px;">';
                itensHtml += '<thead><tr style="background: var(--tertiary); border-bottom: 1px solid rgba(255,255,255,0.1);">';
                itensHtml += '<th style="padding: 8px; text-align: left; font-size: 12px;">Descrição</th>';
                itensHtml += '<th style="padding: 8px; text-align: center; font-size: 12px;">Qtd</th>';
                itensHtml += '<th style="padding: 8px; text-align: right; font-size: 12px;">Valor Unit.</th>';
                itensHtml += '<th style="padding: 8px; text-align: right; font-size: 12px;">Desc. %</th>';
                itensHtml += '<th style="padding: 8px; text-align: right; font-size: 12px;">Subtotal</th>';
                itensHtml += '</tr></thead><tbody>';

                itens.forEach(item => {
                    const itemSubtotal = item.subtotal || 0;
                    subtotalItens += itemSubtotal;
                    itensHtml += `<tr style="border-bottom: 1px solid rgba(255,255,255,0.05);">`;
                    itensHtml += `<td style="padding: 8px;">${item.descricao || '-'}</td>`;
                    itensHtml += `<td style="padding: 8px; text-align: center;">${item.quantidade || 0}</td>`;
                    itensHtml += `<td style="padding: 8px; text-align: right;">${formatCurrency(item.valor_unitario || 0)}</td>`;
                    itensHtml += `<td style="padding: 8px; text-align: right;">${item.desconto_percent || 0}%</td>`;
                    itensHtml += `<td style="padding: 8px; text-align: right; font-weight: 600;">${formatCurrency(itemSubtotal)}</td>`;
                    itensHtml += `</tr>`;
                });

                itensHtml += '</tbody></table>';
            } else {
                itensHtml = '<div style="padding: 20px; text-align: center; color: var(--text-gray); font-style: italic;">Nenhum item cadastrado</div>';
            }

            const descontoGeral = parseFloat(orcamento.desconto_geral || 0);

            content.innerHTML = `
                <div class="details-section">
                    <div class="details-section-title">Informações Básicas</div>
                    <div class="details-grid">
                        <div class="details-item">
                            <div class="details-label">Número do Orçamento</div>
                            <div class="details-value">${orcamento.numero || '-'}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Cliente</div>
                            <div class="details-value">${clienteNome}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Data do Orçamento</div>
                            <div class="details-value">${formatDate(orcamento.data)}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Validade</div>
                            <div class="details-value">${orcamento.validade_dias || '-'} dias (até ${dataValidade})</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Status</div>
                            <div class="details-value">
                                <span class="badge ${status.class}">
                                    ${status.label}
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="details-section">
                    <div class="details-section-title">Itens do Orçamento</div>
                    ${itensHtml}
                    <div style="margin-top: 16px; padding-top: 16px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                            <span style="font-weight: 600;">Subtotal:</span>
                            <span style="font-weight: 600;">${formatCurrency(subtotalItens)}</span>
                        </div>
                        ${descontoGeral > 0 ? `
                        <div style="display: flex; justify-content: space-between; margin-bottom: 8px; color: var(--danger);">
                            <span>Desconto Geral:</span>
                            <span>${formatCurrency(descontoGeral)}</span>
                        </div>
                        ` : ''}
                        <div style="display: flex; justify-content: space-between; font-size: 18px; font-weight: 700; color: var(--primary); padding-top: 8px; border-top: 2px solid var(--primary);">
                            <span>Total:</span>
                            <span>${formatCurrency(orcamento.valor)}</span>
                        </div>
                    </div>
                </div>

                <div class="details-section">
                    <div class="details-section-title">Observações</div>
                    <div class="details-item">
                        <div class="details-value" style="white-space: pre-wrap;">${displayValue(orcamento.observacoes)}</div>
                    </div>
                </div>
            `;

            // Configurar botões de ação
            document.getElementById('orcamentoDetailsModal').dataset.orcamentoId = id;
            
            const pdfBtn = document.getElementById('downloadPDFBtn');
            pdfBtn.onclick = () => gerarPDFOrcamento();

            const aprovarBtn = document.getElementById('aprovarOrcamentoBtn');
            const recusarBtn = document.getElementById('recusarOrcamentoBtn');
            const criarProjetoBtn = document.getElementById('criarProjetoBtn');
            const gerarLinkBtn = document.getElementById('gerarLinkPublicoBtn');
            const linkContainer = document.getElementById('linkPublicoContainer');
            const linkInput = document.getElementById('linkPublicoInput');
            
            // Configurar botão de gerar link
            gerarLinkBtn.onclick = () => gerarLinkPublico(id);
            
            // Verificar se já existe link público
            if (orcamento.token_publico && orcamento.acesso_publico) {
                const linkPublico = window.location.origin + window.location.pathname + '?proposta=' + orcamento.token_publico;
                linkInput.value = linkPublico;
                linkContainer.style.display = 'block';
                gerarLinkBtn.style.display = 'none';
            } else {
                linkContainer.style.display = 'none';
                gerarLinkBtn.style.display = 'inline-block';
            }
            
            if (orcamento.status === 'enviado') {
                aprovarBtn.style.display = 'inline-block';
                recusarBtn.style.display = 'inline-block';
                aprovarBtn.onclick = () => aprovarOrcamento(id);
                recusarBtn.onclick = () => recusarOrcamento(id);
                criarProjetoBtn.style.display = 'none';
            } else if (orcamento.status === 'aprovado') {
                aprovarBtn.style.display = 'none';
                recusarBtn.style.display = 'none';
                criarProjetoBtn.style.display = 'inline-block';
                criarProjetoBtn.onclick = () => criarProjetoDoOrcamento(id);
            } else {
                aprovarBtn.style.display = 'none';
                recusarBtn.style.display = 'none';
                criarProjetoBtn.style.display = 'none';
            }

            const modal = document.getElementById('orcamentoDetailsModal');
            openModal(modal);
        }

        // Fechar modal de detalhes
        function closeOrcamentoDetailsModal() {
            const modal = document.getElementById('orcamentoDetailsModal');
            closeModal(modal);
        }

        // Criar projeto a partir de orçamento aprovado
        async function criarProjetoDoOrcamento(orcamentoId) {
            const orcamento = allOrcamentos.find(o => o.id === orcamentoId);
            if (!orcamento) {
                alert('Orçamento não encontrado');
                return;
            }

            if (orcamento.status !== 'aprovado') {
                alert('Apenas orçamentos aprovados podem gerar projetos');
                return;
            }

            // Fechar modal de orçamento
            closeOrcamentoDetailsModal();

            // Abrir modal de projeto preenchido
            document.getElementById('projetoModalTitle').textContent = 'Novo Projeto (do Orçamento)';
            document.getElementById('projetoForm').reset();
            document.getElementById('projetoId').value = '';

            // Preencher dados do orçamento
            const clienteNome = orcamento.cliente?.nome || orcamento.cliente?.empresa || 'Cliente do Orçamento';
            const nomeProjeto = `Projeto - ${clienteNome} - Orçamento ${orcamento.numero || ''}`;
            
            document.getElementById('projetoNome').value = nomeProjeto;
            document.getElementById('projetoClienteId').value = orcamento.cliente_id || '';
            document.getElementById('projetoStatus').value = 'planejamento';
            document.getElementById('projetoValor').value = orcamento.valor || '';

            // Data de início com hoje
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('projetoDataInicio').value = hoje;

            // Calcular data prevista (validade do orçamento + hoje)
            if (orcamento.validade_dias) {
                const dataPrevista = new Date();
                dataPrevista.setDate(dataPrevista.getDate() + parseInt(orcamento.validade_dias));
                document.getElementById('projetoDataPrevista').value = dataPrevista.toISOString().split('T')[0];
            }

            // Descrição com informações do orçamento
            let descricao = `Projeto criado a partir do Orçamento ${orcamento.numero || ''}.\n\n`;
            descricao += `Itens do orçamento:\n`;
            const itens = orcamento.itens || [];
            itens.forEach((item, index) => {
                descricao += `${index + 1}. ${item.descricao || 'Item'} - Qtd: ${item.quantidade || 1} - Valor: R$ ${(item.subtotal || 0).toFixed(2)}\n`;
            });
            descricao += `\nTotal: R$ ${(orcamento.valor || 0).toFixed(2)}`;
            
            if (orcamento.condicoes_pagamento) {
                descricao += `\n\nCondições de Pagamento: ${orcamento.condicoes_pagamento}`;
            }
            if (orcamento.prazo_entrega) {
                descricao += `\nPrazo de Entrega: ${orcamento.prazo_entrega}`;
            }
            if (orcamento.observacoes) {
                descricao += `\n\nObservações do Orçamento: ${orcamento.observacoes}`;
            }

            document.getElementById('projetoDescricao').value = descricao;

            // Tags com referência ao orçamento
            document.getElementById('projetoTags').value = `orcamento-${orcamento.numero || orcamentoId}, aprovado`;

            // Adicionar campo hidden para orcamento_id (criar se não existir)
            let orcamentoIdInput = document.getElementById('projetoOrcamentoId');
            if (!orcamentoIdInput) {
                orcamentoIdInput = document.createElement('input');
                orcamentoIdInput.type = 'hidden';
                orcamentoIdInput.id = 'projetoOrcamentoId';
                document.getElementById('projetoForm').appendChild(orcamentoIdInput);
            }
            orcamentoIdInput.value = orcamentoId;

            // Carregar clientes e usuários
            await Promise.all([
                loadClientesForSelect(),
                loadUsuariosForSelect()
            ]);

            // Selecionar cliente
            if (orcamento.cliente_id) {
                document.getElementById('projetoClienteId').value = orcamento.cliente_id;
            }

            // Abrir modal
            document.getElementById('projetoModal').classList.add('active');
        }

        // ========== GERENCIAMENTO DE ITENS DO ORÇAMENTO ==========
        let orcamentoItens = [];
        let itemCounter = 0;

        // Adicionar item ao orçamento
        function adicionarItemOrcamento() {
            const tbody = document.getElementById('orcamentoItensBody');
            
            // Remover mensagem de "nenhum item"
            if (tbody.children.length === 1 && tbody.children[0].children.length === 1) {
                tbody.innerHTML = '';
            }

            const itemId = 'item_' + (++itemCounter);
            const row = document.createElement('tr');
            row.id = itemId;
            row.innerHTML = `
                <td data-label="Descrição">
                    <input type="text" class="form-input item-descricao" placeholder="Descrição do item" style="width: 100%; font-size: 12px; padding: 6px;" onchange="calcularTotalOrcamento()">
                </td>
                <td data-label="Quantidade">
                    <input type="number" class="form-input item-quantidade" value="1" min="1" step="1" style="width: 100%; font-size: 12px; padding: 6px; text-align: center;" onchange="calcularItem('${itemId}')">
                </td>
                <td data-label="Valor Unitário">
                    <input type="number" class="form-input item-valor-unitario" value="0" min="0" step="0.01" style="width: 100%; font-size: 12px; padding: 6px; text-align: right;" onchange="calcularItem('${itemId}')">
                </td>
                <td data-label="Desconto %">
                    <input type="number" class="form-input item-desconto" value="0" min="0" max="100" step="0.01" style="width: 100%; font-size: 12px; padding: 6px; text-align: right;" onchange="calcularItem('${itemId}')">
                </td>
                <td class="item-subtotal" data-label="Subtotal" style="text-align: right; padding: 8px; font-weight: 600;">R$ 0,00</td>
                <td data-label="Ações" style="text-align: center;">
                    <button type="button" class="btn-action" onclick="removerItemOrcamento('${itemId}')" style="border-color: var(--danger); color: var(--danger); padding: 4px 8px;">✗</button>
                </td>
            `;
            tbody.appendChild(row);
            calcularTotalOrcamento();
        }

        // Remover item do orçamento
        function removerItemOrcamento(itemId) {
            const row = document.getElementById(itemId);
            if (row) {
                row.remove();
                calcularTotalOrcamento();
                
                // Se não houver mais itens, mostrar mensagem
                const tbody = document.getElementById('orcamentoItensBody');
                if (tbody.children.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="padding: 20px; text-align: center; color: var(--text-gray); font-style: italic;">
                                Nenhum item adicionado. Clique em "Adicionar Item" para começar.
                            </td>
                        </tr>
                    `;
                }
            }
        }

        // Toggle submenu de serviços (para orçamento)
        function toggleSubmenu(contexto, servico) {
            const prefix = contexto === 'orcamento' ? 'orcamento' : '';
            
            // Mapear nomes de serviços para IDs corretos (tratando underscores)
            const servicoMap = {
                'redes_sociais': 'RedesSociais',
                'automacao': 'Automacao',
                'site': 'Site',
                'trafego': 'Trafego',
                'design': 'Design'
            };
            
            const servicoFormatted = servicoMap[servico] || servico.charAt(0).toUpperCase() + servico.slice(1);
            const submenuId = prefix ? `orcamentoSubmenu${servicoFormatted}` : `submenu${servicoFormatted}`;
            const checkboxId = prefix ? `orcamentoServico${servicoFormatted}` : `servico${servicoFormatted}`;
            
            const submenu = document.getElementById(submenuId);
            const checkbox = document.getElementById(checkboxId);
            
            if (submenu && checkbox) {
                if (checkbox.checked) {
                    submenu.classList.add('active');
                } else {
                    submenu.classList.remove('active');
                    // Desmarcar todos os subitens quando o principal é desmarcado
                    submenu.querySelectorAll('input[type="checkbox"]').forEach(cb => {
                        if (cb.checked) {
                            cb.checked = false;
                            if (contexto === 'orcamento') {
                                removerServicoDoOrcamento(cb.value);
                            }
                        }
                    });
                }
            }
        }

        // Adicionar serviço automaticamente aos itens do orçamento
        function adicionarServicoAoOrcamento(servicoId, descricao) {
            const checkbox = document.querySelector(`#orcamentoServicosContainer input[value="${servicoId}"]`);
            if (!checkbox) return;

            const tbody = document.getElementById('orcamentoItensBody');
            
            // Remover mensagem de "nenhum item"
            if (tbody.children.length === 1 && tbody.children[0].children.length === 1) {
                tbody.innerHTML = '';
            }

            if (checkbox.checked) {
                // Verificar se o item já existe
                const existingItem = Array.from(tbody.querySelectorAll('tr')).find(row => {
                    const descInput = row.querySelector('.item-descricao');
                    return descInput && descInput.value === descricao;
                });

                if (!existingItem) {
                    // Adicionar novo item
                    const itemId = 'item_' + (++itemCounter);
                    const row = document.createElement('tr');
                    row.id = itemId;
                    row.dataset.servicoId = servicoId;
                    row.innerHTML = `
                        <td data-label="Descrição">
                            <input type="text" class="form-input item-descricao" value="${descricao}" style="width: 100%; font-size: 12px; padding: 6px;" onchange="calcularTotalOrcamento()">
                        </td>
                        <td data-label="Quantidade">
                            <input type="number" class="form-input item-quantidade" value="1" min="1" step="1" style="width: 100%; font-size: 12px; padding: 6px; text-align: center;" onchange="calcularItem('${itemId}')">
                        </td>
                        <td data-label="Valor Unitário">
                            <input type="number" class="form-input item-valor-unitario" value="0" min="0" step="0.01" style="width: 100%; font-size: 12px; padding: 6px; text-align: right;" onchange="calcularItem('${itemId}')" placeholder="0.00">
                        </td>
                        <td data-label="Desconto %">
                            <input type="number" class="form-input item-desconto" value="0" min="0" max="100" step="0.01" style="width: 100%; font-size: 12px; padding: 6px; text-align: right;" onchange="calcularItem('${itemId}')">
                        </td>
                        <td class="item-subtotal" data-label="Subtotal" style="text-align: right; padding: 8px; font-weight: 600;">R$ 0,00</td>
                        <td data-label="Ações" style="text-align: center;">
                            <button type="button" class="btn-action" onclick="removerItemOrcamento('${itemId}')" style="border-color: var(--danger); color: var(--danger); padding: 4px 8px;">✗</button>
                        </td>
                    `;
                    tbody.appendChild(row);
                    calcularTotalOrcamento();
                }
            } else {
                // Remover item quando desmarcado
                removerServicoDoOrcamento(servicoId);
            }
        }

        // Remover serviço dos itens do orçamento
        function removerServicoDoOrcamento(servicoId) {
            const tbody = document.getElementById('orcamentoItensBody');
            const row = Array.from(tbody.querySelectorAll('tr')).find(r => r.dataset.servicoId === servicoId);
            if (row) {
                row.remove();
                calcularTotalOrcamento();
                
                // Se não houver mais itens, mostrar mensagem
                if (tbody.children.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="6" style="padding: 20px; text-align: center; color: var(--text-gray); font-style: italic;">
                                Nenhum item adicionado. Clique em "Adicionar Item" para começar.
                            </td>
                        </tr>
                    `;
                }
            }
        }

        // Calcular subtotal de um item - COM PRECISÃO
        function calcularItem(itemId) {
            const row = document.getElementById(itemId);
            if (!row) return;

            const quantidade = parseFloat(row.querySelector('.item-quantidade').value) || 0;
            const valorUnitario = parseFloat(row.querySelector('.item-valor-unitario').value) || 0;
            const descontoPercent = parseFloat(row.querySelector('.item-desconto').value) || 0;

            // Cálculos precisos com arredondamento correto
            const subtotal = Math.round((quantidade * valorUnitario) * 100) / 100; // Arredondar para 2 casas
            const descontoValor = Math.round((subtotal * (descontoPercent / 100)) * 100) / 100; // Arredondar desconto
            const subtotalFinal = Math.round((subtotal - descontoValor) * 100) / 100; // Arredondar resultado final

            row.querySelector('.item-subtotal').textContent = formatCurrency(subtotalFinal);
            calcularTotalOrcamento();
        }

        // Calcular total do orçamento - COM PRECISÃO
        function calcularTotalOrcamento() {
            const tbody = document.getElementById('orcamentoItensBody');
            let subtotal = 0;

            tbody.querySelectorAll('tr').forEach(row => {
                // Pular linha de mensagem vazia
                if (row.children.length === 1) return;
                
                const quantidadeInput = row.querySelector('.item-quantidade');
                const valorUnitarioInput = row.querySelector('.item-valor-unitario');
                const descontoInput = row.querySelector('.item-desconto');
                
                if (!quantidadeInput || !valorUnitarioInput || !descontoInput) return;
                
                const quantidade = parseFloat(quantidadeInput.value) || 0;
                const valorUnitario = parseFloat(valorUnitarioInput.value) || 0;
                const descontoPercent = parseFloat(descontoInput.value) || 0;

                // Cálculos precisos com arredondamento correto
                const itemSubtotal = Math.round((quantidade * valorUnitario) * 100) / 100;
                const descontoValor = Math.round((itemSubtotal * (descontoPercent / 100)) * 100) / 100;
                const subtotalItem = Math.round((itemSubtotal - descontoValor) * 100) / 100;
                subtotal = Math.round((subtotal + subtotalItem) * 100) / 100; // Acumular com precisão
                
                // Atualizar subtotal do item na tela
                const subtotalCell = row.querySelector('.item-subtotal');
                if (subtotalCell) {
                    subtotalCell.textContent = formatCurrency(subtotalItem);
                }
            });

            // Arredondar subtotal final
            subtotal = Math.round(subtotal * 100) / 100;
            
            const descontoGeral = parseFloat(document.getElementById('orcamentoDescontoGeral')?.value) || 0;
            const descontoGeralArredondado = Math.round(descontoGeral * 100) / 100;
            const total = Math.round((subtotal - descontoGeralArredondado) * 100) / 100;

            const subtotalEl = document.getElementById('orcamentoSubtotal');
            const descontoGeralEl = document.getElementById('orcamentoDescontoGeralValor');
            const totalEl = document.getElementById('orcamentoValorTotal');
            const valorHidden = document.getElementById('orcamentoValor');
            
            if (subtotalEl) subtotalEl.textContent = formatCurrency(subtotal);
            if (descontoGeralEl) descontoGeralEl.textContent = formatCurrency(descontoGeralArredondado);
            if (totalEl) totalEl.textContent = formatCurrency(total);
            if (valorHidden) valorHidden.value = total.toFixed(2);
        }

        // Coletar itens do formulário
        function coletarItensOrcamento() {
            const tbody = document.getElementById('orcamentoItensBody');
            const itens = [];

            tbody.querySelectorAll('tr').forEach(row => {
                // Pular linha de mensagem vazia
                if (row.children.length === 1) return;
                
                const descricaoInput = row.querySelector('.item-descricao');
                if (!descricaoInput) return;
                
                const descricao = descricaoInput.value.trim();
                if (!descricao) return; // Pular itens sem descrição

                const quantidade = parseFloat(row.querySelector('.item-quantidade')?.value) || 0;
                const valorUnitario = parseFloat(row.querySelector('.item-valor-unitario')?.value) || 0;
                const descontoPercent = parseFloat(row.querySelector('.item-desconto')?.value) || 0;
                
                // Calcular subtotal corretamente - COM PRECISÃO
                const itemSubtotal = Math.round((quantidade * valorUnitario) * 100) / 100;
                const descontoValor = Math.round((itemSubtotal * (descontoPercent / 100)) * 100) / 100;
                const subtotal = Math.round((itemSubtotal - descontoValor) * 100) / 100;

                itens.push({
                    descricao,
                    quantidade,
                    valor_unitario: valorUnitario,
                    desconto_percent: descontoPercent,
                    subtotal: subtotal
                });
            });

            return itens;
        }

        // Carregar itens no formulário
        function carregarItensOrcamento(itens) {
            const tbody = document.getElementById('orcamentoItensBody');
            tbody.innerHTML = '';

            if (!itens || itens.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" style="padding: 20px; text-align: center; color: var(--text-gray); font-style: italic;">
                            Nenhum item adicionado. Clique em "Adicionar Item" para começar.
                        </td>
                    </tr>
                `;
                return;
            }

            itemCounter = 0;
            itens.forEach(item => {
                const itemId = 'item_' + (++itemCounter);
                // Garantir que os valores sejam números
                const quantidade = parseFloat(item.quantidade) || parseFloat(item.qtd) || 1;
                const valorUnitario = parseFloat(item.valor_unitario) || parseFloat(item.valorUnitario) || parseFloat(item.valor_unit) || 0;
                const descontoPercent = parseFloat(item.desconto_percent) || parseFloat(item.descontoPercent) || parseFloat(item.desconto) || 0;
                
                // Recalcular subtotal baseado nos valores - COM PRECISÃO
                const itemSubtotal = Math.round((quantidade * valorUnitario) * 100) / 100;
                const descontoValor = Math.round((itemSubtotal * (descontoPercent / 100)) * 100) / 100;
                const subtotalCalculado = Math.round((itemSubtotal - descontoValor) * 100) / 100;
                
                const row = document.createElement('tr');
                row.id = itemId;
                if (item.servico_id) {
                    row.dataset.servicoId = item.servico_id;
                }
                row.innerHTML = `
                    <td data-label="Descrição">
                        <input type="text" class="form-input item-descricao" value="${(item.descricao || '').replace(/"/g, '&quot;')}" placeholder="Descrição do item" style="width: 100%; font-size: 12px; padding: 6px;" onchange="calcularTotalOrcamento()">
                    </td>
                    <td data-label="Quantidade">
                        <input type="number" class="form-input item-quantidade" value="${quantidade}" min="1" step="1" style="width: 100%; font-size: 12px; padding: 6px; text-align: center;" onchange="calcularItem('${itemId}')">
                    </td>
                    <td data-label="Valor Unitário">
                        <input type="number" class="form-input item-valor-unitario" value="${valorUnitario}" min="0" step="0.01" style="width: 100%; font-size: 12px; padding: 6px; text-align: right;" onchange="calcularItem('${itemId}')">
                    </td>
                    <td data-label="Desconto %">
                        <input type="number" class="form-input item-desconto" value="${descontoPercent}" min="0" max="100" step="0.01" style="width: 100%; font-size: 12px; padding: 6px; text-align: right;" onchange="calcularItem('${itemId}')">
                    </td>
                    <td class="item-subtotal" data-label="Subtotal" style="text-align: right; padding: 8px; font-weight: 600;">${formatCurrency(subtotalCalculado)}</td>
                    <td data-label="Ações" style="text-align: center;">
                        <button type="button" class="btn-action" onclick="removerItemOrcamento('${itemId}')" style="border-color: var(--danger); color: var(--danger); padding: 4px 8px;">✗</button>
                    </td>
                `;
                tbody.appendChild(row);
            });
            calcularTotalOrcamento();
        }

        // Aprovar orçamento
        async function aprovarOrcamento(id) {
            if (!confirm('Deseja aprovar este orçamento?')) return;

            try {
                const { error } = await supabase
                    .from('orcamentos')
                    .update({ status: 'aprovado' })
                    .eq('id', id);

                if (error) throw error;
                alert('Orçamento aprovado com sucesso!');
                loadOrcamentos();
                closeOrcamentoDetailsModal();
            } catch (error) {
                console.error('Erro ao aprovar orçamento:', error);
                alert('Erro ao aprovar orçamento: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // Recusar orçamento
        async function recusarOrcamento(id) {
            if (!confirm('Deseja recusar este orçamento?')) return;

            try {
                const { error } = await supabase
                    .from('orcamentos')
                    .update({ status: 'rejeitado' })
                    .eq('id', id);

                if (error) throw error;
                alert('Orçamento recusado.');
                loadOrcamentos();
                closeOrcamentoDetailsModal();
            } catch (error) {
                console.error('Erro ao recusar orçamento:', error);
                alert('Erro ao recusar orçamento: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // Gerar PDF do orçamento
        async function gerarPDFOrcamento() {
            try {
                const orcamentoId = document.getElementById('orcamentoDetailsModal').dataset.orcamentoId;
                if (!orcamentoId) {
                    alert('Orçamento não encontrado');
                    return;
                }
                
                const orcamento = allOrcamentos.find(o => o.id === orcamentoId);
                if (!orcamento) {
                    alert('Orçamento não encontrado');
                    return;
                }

                // Buscar dados completos do cliente
                let clienteCompleto = orcamento.cliente || {};
                if (orcamento.cliente_id && !clienteCompleto.endereco) {
                    try {
                        const { data, error } = await supabase
                            .from('clientes')
                            .select('*')
                            .eq('id', orcamento.cliente_id)
                            .single();
                        if (!error && data) {
                            clienteCompleto = data;
                        }
                    } catch (e) {
                        console.warn('Erro ao buscar dados completos do cliente:', e);
                    }
                }

                // Verificar se jsPDF está disponível
                if (!window.jspdf) {
                    alert('Biblioteca de PDF não carregada. Por favor, recarregue a página.');
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Função auxiliar para formatar moeda no PDF
                const formatCurrencyPDF = (value) => {
                    if (!value && value !== 0) return 'R$ 0,00';
                    return new Intl.NumberFormat('pt-BR', {
                        style: 'currency',
                        currency: 'BRL'
                    }).format(value);
                };

                // Função auxiliar para formatar data no PDF
                const formatDatePDF = (dateStr) => {
                    if (!dateStr) return '-';
                    try {
                        const date = new Date(dateStr);
                        return date.toLocaleDateString('pt-BR');
                    } catch {
                        return dateStr;
                    }
                };

                // Configurações
                const margin = 20;
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                let y = margin;

                // ========== CABEÇALHO - DADOS DA EMPRESA ==========
                let logoLoaded = false;
                
                // Tentar adicionar logo
                try {
                    const logoUrl = 'https://zhzhpctsndrcedukivhk.supabase.co/storage/v1/object/public/logo/LOGO%203D%20SEM%20FUNDO%20(1).png';
                    
                    // Usar fetch para obter a imagem como base64
                    const response = await fetch(logoUrl);
                    if (response.ok) {
                        const blob = await response.blob();
                        const reader = new FileReader();
                        
                        await new Promise((resolve, reject) => {
                            reader.onload = () => resolve(reader.result);
                            reader.onerror = reject;
                            reader.readAsDataURL(blob);
                        });
                        
                        const logoData = reader.result;
                        // Adicionar logo (ajustar tamanho conforme necessário)
                        doc.addImage(logoData, 'PNG', margin, 5, 60, 25);
                        logoLoaded = true;
                    }
                } catch (e) {
                    console.warn('Erro ao carregar logo:', e);
                }
                
                // Se logo não carregou, usar texto
                if (!logoLoaded) {
                    doc.setFillColor(255, 102, 0);
                    doc.rect(0, 0, pageWidth, 50, 'F');
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(28);
                    doc.setFont(undefined, 'bold');
                    doc.text('AUTOVIZION', margin, 30);
                    
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'normal');
                    doc.text('Soluções em Marketing Digital e Tecnologia', margin, 38);
                }
                
                // Dados da empresa no cabeçalho (lado direito) - Melhor formatado
                const dadosX = pageWidth - margin - 60;
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('AUTOVIZION', dadosX, 12);
                
                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(60, 60, 60);
                doc.text('www.autovizon.com.br', dadosX, 20);
                doc.text('autovizioncomercial@gmail.com', dadosX, 26);
                doc.text('(14) 99683-3385', dadosX, 32);
                
                // Linha divisória abaixo do cabeçalho
                doc.setDrawColor(200, 200, 200);
                doc.line(margin, 35, pageWidth - margin, 35);
                
                y = 45;

                // ========== TÍTULO DO DOCUMENTO ==========
                // Fundo colorido para o título
                doc.setFillColor(255, 102, 0);
                doc.rect(margin, y - 5, pageWidth - (margin * 2), 20, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(22);
                doc.setFont(undefined, 'bold');
                doc.text('PROPOSTA COMERCIAL', margin + 5, y + 8);
                
                // Número e data à direita (sobre o fundo)
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Nº ${orcamento.numero || 'N/A'}`, pageWidth - margin - 30, y + 2);
                doc.text(`Data: ${formatDatePDF(orcamento.data)}`, pageWidth - margin - 30, y + 9);
                
                y += 20;

                // ========== DADOS DO CLIENTE ==========
                // Definir variáveis do cliente primeiro
                const clienteNome = clienteCompleto.nome || clienteCompleto.empresa || 'Cliente não encontrado';
                const clienteEmpresa = clienteCompleto.empresa || '';
                const clienteCpfCnpj = clienteCompleto.cpf_cnpj || '';
                const clienteEndereco = clienteCompleto.endereco || '';
                const clienteCidade = clienteCompleto.cidade || '';
                const clienteEstado = clienteCompleto.estado || '';
                const clienteCep = clienteCompleto.cep || '';
                const clienteTelefone = clienteCompleto.telefone || '';
                const clienteEmail = clienteCompleto.email || '';

                // ========== INTRODUÇÃO ==========
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(60, 60, 60);
                const introText = `Prezado(a) ${clienteNome},`;
                doc.text(introText, margin, y);
                y += 8;
                
                const apresentacao = `É com grande entusiasmo que finalizamos a análise de suas necessidades e desenvolvemos uma proposta comercial estratégica. Nosso foco é apresentar soluções concretas que impulsionarão seus resultados e atenderão, com excelência, aos seus objetivos específicos.`;
                const apresentacaoLines = doc.splitTextToSize(apresentacao, pageWidth - (margin * 2));
                doc.text(apresentacaoLines, margin, y);
                y += apresentacaoLines.length * 5 + 10;

                // ========== DADOS DO CLIENTE ==========
                // Fundo com cor laranja suave
                doc.setFillColor(255, 102, 0);
                doc.rect(margin, y, pageWidth - (margin * 2), 8, 'F');
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('DADOS DO CLIENTE', margin + 3, y + 6);
                y += 12;
                
                doc.setTextColor(0, 0, 0);
                
                doc.text(`Cliente: ${clienteNome}`, margin, y);
                y += 6;
                if (clienteEmpresa && clienteEmpresa !== clienteNome) {
                    doc.text(`Empresa: ${clienteEmpresa}`, margin, y);
                    y += 6;
                }
                if (clienteCpfCnpj) {
                    doc.text(`CPF/CNPJ: ${clienteCpfCnpj}`, margin, y);
                    y += 6;
                }
                if (clienteEndereco) {
                    let enderecoCompleto = clienteEndereco;
                    if (clienteCidade) enderecoCompleto += `, ${clienteCidade}`;
                    if (clienteEstado) enderecoCompleto += ` - ${clienteEstado}`;
                    if (clienteCep) enderecoCompleto += ` - CEP: ${clienteCep}`;
                    doc.text(`Endereço: ${enderecoCompleto}`, margin, y);
                    y += 6;
                }
                if (clienteTelefone) {
                    doc.text(`Telefone: ${clienteTelefone}`, margin, y);
                    y += 6;
                }
                if (clienteEmail) {
                    doc.text(`E-mail: ${clienteEmail}`, margin, y);
                    y += 6;
                }
                
                y += 10;

                // ========== ITENS DO ORÇAMENTO ==========
                // Fundo com cor laranja suave
                doc.setFillColor(255, 102, 0);
                doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('ITENS DO ORÇAMENTO', margin + 3, y + 4);
                y += 12;
                
                doc.setTextColor(0, 0, 0);

                // Fazer parse dos itens se necessário
                let itens = orcamento.itens || [];
                if (typeof itens === 'string') {
                    try {
                        itens = JSON.parse(itens);
                    } catch (e) {
                        console.error('Erro ao fazer parse dos itens no PDF:', e);
                        itens = [];
                    }
                }
                if (!Array.isArray(itens)) {
                    itens = [];
                }
                
                if (itens.length > 0) {
                    // Definir posições das colunas de forma clara
                    const colDescricao = margin + 2;
                    const colQtd = margin + 65;
                    const colValorUnit = margin + 85;
                    const colDesconto = margin + 120;
                    
                    // Cabeçalho da tabela com cor destacada
                    doc.setFillColor(45, 45, 45);
                    doc.rect(margin, y - 5, pageWidth - (margin * 2), 8, 'F');
                    
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(255, 255, 255);
                    doc.text('Descrição', colDescricao, y);
                    doc.text('Qtd', colQtd, y);
                    doc.text('Valor Unit.', colValorUnit, y);
                    doc.text('Desconto', colDesconto, y);
                    y += 8;

                    let subtotal = 0;
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(9);
                    
                    itens.forEach((item, index) => {
                        // Verificar se precisa de nova página (deixar espaço para pelo menos 3 linhas + totais)
                        if (y > pageHeight - 80) {
                            doc.addPage();
                            y = margin + 10;
                        }
                        
                        // Linha alternada (opcional)
                        if (index % 2 === 0) {
                            doc.setFillColor(250, 250, 250);
                            doc.rect(margin, y - 3, pageWidth - (margin * 2), 6, 'F');
                        }
                        
                        // Acessar campos com fallback para diferentes nomes
                        const descricao = item.descricao || item.desc || '-';
                        const quantidade = parseFloat(item.quantidade || item.qtd || 0);
                        const valorUnitario = parseFloat(item.valor_unitario || item.valorUnitario || item.valor_unit || 0);
                        const descontoPercent = parseFloat(item.desconto_percent || item.descontoPercent || item.desconto || 0);
                        
                        // Recalcular subtotal do item - COM PRECISÃO
                        const itemSubtotal = Math.round((quantidade * valorUnitario) * 100) / 100;
                        const descontoValor = Math.round((itemSubtotal * (descontoPercent / 100)) * 100) / 100;
                        const subtotalItem = Math.round((itemSubtotal - descontoValor) * 100) / 100;
                        subtotal = Math.round((subtotal + subtotalItem) * 100) / 100;
                        
                        // Descrição (pode quebrar linha se muito longa)
                        const descLines = doc.splitTextToSize(descricao, 60);
                        const firstLineY = y;
                        doc.setTextColor(0, 0, 0);
                        doc.text(descLines, colDescricao, firstLineY);
                        
                        // Quantidade
                        doc.text(quantidade.toString(), colQtd, firstLineY);
                        
                        // Valor unitário
                        doc.text(formatCurrencyPDF(valorUnitario), colValorUnit, firstLineY);
                        
                        // Desconto
                        doc.text(descontoPercent + '%', colDesconto, firstLineY);
                        
                        y += Math.max(6, descLines.length * 6);
                    });

                    y += 5;
                    doc.setDrawColor(200, 200, 200);
                    doc.line(margin, y, pageWidth - margin, y);
                    y += 10;

                    // ========== TOTAIS ==========
                    // Verificar se há espaço para os totais (subtotal + desconto + total + linha = ~30px)
                    if (y > pageHeight - 50) {
                        doc.addPage();
                        y = margin + 10;
                    }
                    
                    const descontoGeral = parseFloat(orcamento.desconto_geral || 0);
                    // Calcular total corretamente - COM PRECISÃO
                    const descontoGeralArredondado = Math.round(descontoGeral * 100) / 100;
                    const subtotalArredondado = Math.round(subtotal * 100) / 100;
                    const total = Math.round((subtotalArredondado - descontoGeralArredondado) * 100) / 100;
                    
                    // Subtotal e Total - mesma linha, mesmo estilo, apenas linha de separação
                    // Alinhar mais à esquerda para seguir o alinhamento geral da página
                    const labelX = margin + 10; // Posição do label (alinhado à esquerda, seguindo o alinhamento geral)
                    const valueX = labelX + 100; // Posição do valor (espaçamento fixo após o label, mais à esquerda)
                    
                    // Subtotal - texto preto, tamanho normal
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(0, 0, 0);
                    doc.text('Subtotal:', labelX, y);
                    doc.text(formatCurrencyPDF(subtotal), valueX, y);
                    y += 7;

                    if (descontoGeral > 0) {
                        doc.setTextColor(200, 0, 0);
                        doc.text('Desconto Geral:', labelX, y);
                        doc.text(formatCurrencyPDF(descontoGeral), valueX, y);
                        y += 7;
                    }

                    // Linha laranja para separar (apenas uma listra)
                    doc.setDrawColor(255, 102, 0);
                    doc.setLineWidth(1);
                    doc.line(labelX - 10, y, valueX + 50, y);
                    y += 8;

                    // TOTAL - mesmo estilo do subtotal, seguindo as mesmas linhas
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold'); // Negrito para destacar
                    doc.setTextColor(0, 0, 0); // Texto preto, igual ao subtotal
                    doc.text('TOTAL:', labelX, y);
                    // Valor também preto, negrito - alinhado à esquerda, mesmo estilo do subtotal
                    const totalText = formatCurrencyPDF(total);
                    doc.text(totalText, valueX, y);
                    y += 15;
                } else {
                    doc.setFontSize(10);
                    doc.setTextColor(128, 128, 128);
                    doc.text('Nenhum item cadastrado', margin, y);
                    y += 10;
                }

                // ========== CONDIÇÕES COMERCIAIS ==========
                // Extrair condições comerciais das observações
                const observacoes = orcamento.observacoes || '';
                let condicoesPagamento = '';
                let formaPagamento = '';
                let prazoEntrega = '';
                
                if (observacoes.includes('=== CONDIÇÕES COMERCIAIS ===')) {
                    const partes = observacoes.split('=== CONDIÇÕES COMERCIAIS ===');
                    const condicoesTexto = partes[1] || '';
                    
                    // Extrair condições de pagamento
                    const matchCondicoes = condicoesTexto.match(/Condições de Pagamento:\s*(.+?)(?:\n|$)/i);
                    if (matchCondicoes) condicoesPagamento = matchCondicoes[1].trim();
                    
                    // Extrair forma de pagamento
                    const matchForma = condicoesTexto.match(/Forma de Pagamento:\s*(.+?)(?:\n|$)/i);
                    if (matchForma) formaPagamento = matchForma[1].trim();
                    
                    // Extrair prazo de entrega
                    const matchPrazo = condicoesTexto.match(/Prazo de Entrega:\s*(.+?)(?:\n|$)/i);
                    if (matchPrazo) prazoEntrega = matchPrazo[1].trim();
                }

                if (condicoesPagamento || formaPagamento || prazoEntrega) {
                    // Verificar se precisa de nova página
                    if (y > pageHeight - 60) {
                        doc.addPage();
                        y = margin + 10;
                    }

                    doc.setFillColor(245, 245, 245);
                    doc.rect(margin, y, pageWidth - (margin * 2), 8, 'F');
                    
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(0, 0, 0);
                    doc.text('CONDIÇÕES COMERCIAIS', margin + 3, y + 6);
                    y += 12;

                    doc.setFontSize(9);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(60, 60, 60);

                    if (condicoesPagamento) {
                        doc.setFont(undefined, 'bold');
                        doc.text('Condições de Pagamento:', margin, y);
                        y += 6;
                        doc.setFont(undefined, 'normal');
                        const condicoesLines = doc.splitTextToSize(condicoesPagamento, pageWidth - (margin * 2));
                        doc.text(condicoesLines, margin + 5, y);
                        y += condicoesLines.length * 5 + 5;
                    }

                    if (formaPagamento) {
                        doc.setFont(undefined, 'bold');
                        doc.text('Forma de Pagamento:', margin, y);
                        y += 6;
                        doc.setFont(undefined, 'normal');
                        const formaLines = doc.splitTextToSize(formaPagamento, pageWidth - (margin * 2));
                        doc.text(formaLines, margin + 5, y);
                        y += formaLines.length * 5 + 5;
                    }

                    if (prazoEntrega) {
                        doc.setFont(undefined, 'bold');
                        doc.text('Prazo de Entrega:', margin, y);
                        y += 6;
                        doc.setFont(undefined, 'normal');
                        const prazoLines = doc.splitTextToSize(prazoEntrega, pageWidth - (margin * 2));
                        doc.text(prazoLines, margin + 5, y);
                        y += prazoLines.length * 5 + 5;
                    }

                    y += 5;
                }

                // ========== TERMOS E CONDIÇÕES ==========
                // Verificar se precisa de nova página
                if (y > pageHeight - 80) {
                    doc.addPage();
                    y = margin + 10;
                }

                doc.setFillColor(250, 250, 250);
                doc.rect(margin, y, pageWidth - (margin * 2), 8, 'F');
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('TERMOS E CONDIÇÕES', margin + 3, y + 6);
                y += 12;

                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(60, 60, 60);

                const termos = [
                    '1. Esta proposta tem validade de ' + (orcamento.validade_dias || 30) + ' dias corridos a partir da data de emissão.',
                    '2. Os valores apresentados estão sujeitos a alteração sem aviso prévio após o prazo de validade.',
                    '3. O início dos trabalhos está condicionado à aprovação formal desta proposta e ao pagamento conforme condições acordadas.',
                    '4. Todas as informações e materiais fornecidos pelo cliente serão tratados com confidencialidade.',
                    '5. A empresa se reserva o direito de alterar prazos em caso de atraso na entrega de materiais ou informações necessárias pelo cliente.',
                    '6. Esta proposta não inclui alterações ou modificações não especificadas, que serão orçadas separadamente.',
                    '7. O cliente se compromete a fornecer todas as informações e materiais necessários em tempo hábil para a execução dos serviços.',
                    '8. Em caso de cancelamento, serão aplicadas as políticas de reembolso conforme acordo prévio.'
                ];

                termos.forEach((termo, index) => {
                    if (y > pageHeight - 20) {
                        doc.addPage();
                        y = margin + 10;
                    }
                    const termoLines = doc.splitTextToSize(termo, pageWidth - (margin * 2) - 5);
                    doc.text(termoLines, margin + 5, y);
                    y += termoLines.length * 4 + 3;
                });

                y += 10;

                // ========== OBSERVAÇÕES ==========
                // Extrair observações sem as condições comerciais
                let observacoesParaPDF = observacoes || '';
                if (observacoesParaPDF.includes('=== CONDIÇÕES COMERCIAIS ===')) {
                    const partes = observacoesParaPDF.split('=== CONDIÇÕES COMERCIAIS ===');
                    observacoesParaPDF = partes[0].trim();
                }
                
                if (observacoesParaPDF) {
                    if (y > pageHeight - 40) {
                        doc.addPage();
                        y = margin + 10;
                    }
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(0, 0, 0);
                    doc.text('OBSERVAÇÕES:', margin, y);
                    y += 6;
                    
                    doc.setFont(undefined, 'normal');
                    const splitObservacoes = doc.splitTextToSize(observacoesParaPDF, pageWidth - (margin * 2));
                    doc.text(splitObservacoes, margin, y);
                    y += splitObservacoes.length * 6 + 10;
                }

                // ========== VALIDADE E FORMA DE PAGAMENTO ==========
                // Verificar se há espaço suficiente na página (condições ~35px + rodapé ~20px = 55px)
                // Se não houver espaço, quebrar para nova página
                if (y > pageHeight - 55) {
                    doc.addPage();
                    y = margin + 10;
                }
                
                y += 5;
                doc.setFillColor(250, 250, 250);
                const condicoesHeight = 35;
                doc.rect(margin, y, pageWidth - (margin * 2), condicoesHeight, 'F');
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('CONDIÇÕES COMERCIAIS', margin + 3, y + 8);
                
                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                doc.setTextColor(60, 60, 60);
                
                let condY = y + 16;
                doc.text(`Validade da proposta: ${orcamento.validade_dias || 30} dias, sujeita à disponibilidade de recursos.`, margin + 3, condY);
                condY += 6;
                
                doc.text('Forma de pagamento: A combinar, sujeita à aprovação mútua.', margin + 3, condY);
                condY += 6;
                
                doc.text('Prazo de entrega: A combinar.', margin + 3, condY);
                condY += 6;
                
                doc.text('Condições especiais: Conforme negociação.', margin + 3, condY);
                
                y += condicoesHeight + 5;

                // ========== RODAPÉ COM TERMOS ==========
                // Verificar se há espaço para o rodapé (termos + contato = ~25px)
                if (y > pageHeight - 25) {
                    doc.addPage();
                    y = margin + 10;
                }
                
                // Linha divisória antes do rodapé
                doc.setDrawColor(200, 200, 200);
                doc.line(margin, y, pageWidth - margin, y);
                y += 5;
                
                doc.setFontSize(7);
                doc.setTextColor(100, 100, 100);
                doc.setFont(undefined, 'normal');
                
                const termosRodape = [
                    'A contratação dos serviços está sujeita à assinatura de contrato específico.',
                    'Para mais informações, entre em contato conosco através dos canais indicados.'
                ];
                
                termosRodape.forEach(termo => {
                    // Verificar se precisa de nova página para os termos
                    if (y > pageHeight - 15) {
                        doc.addPage();
                        y = margin + 10;
                    }
                    const termoLines = doc.splitTextToSize(termo, pageWidth - (margin * 2));
                    doc.text(termoLines, margin, y);
                    y += termoLines.length * 4 + 2;
                });
                
                // Informações de contato no rodapé - Sempre na última linha da página
                const contatoY = pageHeight - 8;
                doc.setFontSize(7);
                doc.setTextColor(128, 128, 128);
                doc.setFont(undefined, 'normal');
                doc.text('AUTOVIZION', margin, contatoY);
                doc.text('|', margin + 25, contatoY);
                doc.text('www.autovizon.com.br', margin + 30, contatoY);
                doc.text('|', margin + 70, contatoY);
                doc.text('autovizioncomercial@gmail.com', margin + 75, contatoY);
                doc.text('|', margin + 130, contatoY);
                doc.text('(14) 99683-3385', margin + 135, contatoY);
                
                // Salvar PDF
                const fileName = `Proposta_${orcamento.numero || 'N'}_${clienteNome.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                alert('Erro ao gerar PDF: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // ========== GERENCIAMENTO DE LINK PÚBLICO ==========
        
        // Gerar link público para proposta
        async function gerarLinkPublico(orcamentoId) {
            try {
                // Gerar token único (64 caracteres hexadecimal)
                const token = Array.from(crypto.getRandomValues(new Uint8Array(32)))
                    .map(b => b.toString(16).padStart(2, '0'))
                    .join('');
                
                // Criar link público
                const linkPublico = window.location.origin + window.location.pathname + '?proposta=' + token;
                
                // Salvar token e link no banco
                const { data, error } = await supabase
                    .from('orcamentos')
                    .update({
                        token_publico: token,
                        link_publico: linkPublico,
                        acesso_publico: true
                    })
                    .eq('id', orcamentoId)
                    .select()
                    .single();
                
                if (error) throw error;
                
                // Atualizar UI
                document.getElementById('linkPublicoInput').value = linkPublico;
                document.getElementById('linkPublicoContainer').style.display = 'block';
                document.getElementById('gerarLinkPublicoBtn').style.display = 'none';
                
                // Recarregar orçamentos para atualizar dados
                await loadOrcamentos();
                
                alert('Link público gerado com sucesso!');
            } catch (error) {
                console.error('Erro ao gerar link público:', error);
                alert('Erro ao gerar link público: ' + (error.message || 'Erro desconhecido'));
            }
        }
        
        // Copiar link público
        function copiarLinkPublico() {
            const linkInput = document.getElementById('linkPublicoInput');
            linkInput.select();
            linkInput.setSelectionRange(0, 99999); // Para mobile
            document.execCommand('copy');
            alert('Link copiado para a área de transferência!');
        }
        
        // Enviar link por WhatsApp
        function enviarLinkPorWhatsApp() {
            const linkPublico = document.getElementById('linkPublicoInput').value;
            const orcamento = allOrcamentos.find(o => o.id === document.getElementById('orcamentoDetailsModal').dataset.orcamentoId);
            const clienteNome = orcamento?.cliente?.nome || orcamento?.cliente?.empresa || 'Cliente';
            
            // Buscar telefone do cliente ou usar telefone padrão
            const telefoneCliente = orcamento?.cliente?.whatsapp || orcamento?.cliente?.telefone || '5514996005936';
            // Remover caracteres não numéricos
            const telefoneLimpo = telefoneCliente.replace(/\D/g, '');
            // Garantir formato internacional (55 para Brasil)
            const telefoneFormatado = telefoneLimpo.startsWith('55') ? telefoneLimpo : '55' + telefoneLimpo;
            
            // Mensagem pré-formatada
            const mensagem = `Olá ${clienteNome}! 👋\n\nSegue sua proposta comercial:\n${linkPublico}\n\nAguardo sua resposta! 😊`;
            
            // Criar link do WhatsApp
            const whatsappLink = `https://wa.me/${telefoneFormatado}?text=${encodeURIComponent(mensagem)}`;
            
            // Abrir WhatsApp
            window.open(whatsappLink, '_blank');
        }
        
        // Desativar link público
        async function desativarLinkPublico() {
            if (!confirm('Tem certeza que deseja desativar o link público? O cliente não conseguirá mais acessar a proposta por este link.')) {
                return;
            }
            
            try {
                const orcamentoId = document.getElementById('orcamentoDetailsModal').dataset.orcamentoId;
                
                const { error } = await supabase
                    .from('orcamentos')
                    .update({
                        acesso_publico: false
                    })
                    .eq('id', orcamentoId);
                
                if (error) throw error;
                
                // Atualizar UI
                document.getElementById('linkPublicoContainer').style.display = 'none';
                document.getElementById('gerarLinkPublicoBtn').style.display = 'inline-block';
                
                // Recarregar orçamentos
                await loadOrcamentos();
                
                alert('Link público desativado com sucesso!');
            } catch (error) {
                console.error('Erro ao desativar link público:', error);
                alert('Erro ao desativar link público: ' + (error.message || 'Erro desconhecido'));
            }
        }
        
        // Funções para menu mobile
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.toggle('open');
            overlay.classList.toggle('active');
        }

        function closeSidebarMobile() {
            const sidebar = document.getElementById('sidebar');
            const overlay = document.getElementById('sidebarOverlay');
            sidebar.classList.remove('open');
            overlay.classList.remove('active');
        }

        // Fechar sidebar ao clicar no overlay
        document.getElementById('sidebarOverlay').addEventListener('click', closeSidebarMobile);

        // Fechar sidebar ao redimensionar para desktop
        window.addEventListener('resize', () => {
            if (window.innerWidth > 768) {
                closeSidebarMobile();
            }
        });

        // ========== CONFIGURAÇÃO DA PLATAFORMA ==========
        // Configure aqui o nome e logo da sua plataforma
        
        const PLATAFORMA_CONFIG = {
            nome: 'Vizion Hub',  // Nome da plataforma
            emoji: '',  // Emoji ao lado do nome (deixar vazio para não exibir)
            logoUrl: 'https://zhzhpctsndrcedukivhk.supabase.co/storage/v1/object/public/logo/LOGO%203D%20SEM%20FUNDO%20(1).png',  // Logo na página de login
            sidebarLogoUrl: 'https://zhzhpctsndrcedukivhk.supabase.co/storage/v1/object/public/logo/Design%20sem%20nome%20(32).png',  // Logo no sidebar
        };

        // Aplicar configurações
        function aplicarConfiguracaoPlataforma() {
            // Atualizar nome (com emoji apenas se fornecido)
            const nomeCompleto = PLATAFORMA_CONFIG.emoji ? `${PLATAFORMA_CONFIG.emoji} ${PLATAFORMA_CONFIG.nome}` : PLATAFORMA_CONFIG.nome;
            
            if (PLATAFORMA_CONFIG.nome) {
                // Se tiver logo, ocultar o título no login (só mostrar logo)
                if (PLATAFORMA_CONFIG.logoUrl) {
                    document.getElementById('loginTitle').style.display = 'none';
                } else {
                    document.getElementById('loginTitle').textContent = nomeCompleto;
                    document.getElementById('loginTitle').style.display = 'block';
                }
                
                document.getElementById('sidebarLogoText').textContent = nomeCompleto;
                document.getElementById('pageTitle').textContent = PLATAFORMA_CONFIG.nome + ' - Empresarial';
            }

            // Aplicar logo na página de login
            if (PLATAFORMA_CONFIG.logoUrl) {
                const loginLogo = document.getElementById('loginLogo');
                
                if (loginLogo) {
                    loginLogo.src = PLATAFORMA_CONFIG.logoUrl;
                    loginLogo.style.display = 'block';
                    loginLogo.onerror = function() {
                        this.style.display = 'none';
                        console.warn('Erro ao carregar logo do login');
                    };
                }
            }

            // Aplicar logo no sidebar
            if (PLATAFORMA_CONFIG.sidebarLogoUrl) {
                const sidebarLogo = document.getElementById('sidebarLogo');
                const sidebarLogoText = document.getElementById('sidebarLogoText');
                
                if (sidebarLogo) {
                    sidebarLogo.src = PLATAFORMA_CONFIG.sidebarLogoUrl;
                    sidebarLogo.style.display = 'block';
                    sidebarLogo.onerror = function() {
                        this.style.display = 'none';
                        console.warn('Erro ao carregar logo do sidebar');
                    };
                }
                
                // Ocultar o texto quando tiver logo
                if (sidebarLogoText) {
                    sidebarLogoText.style.display = 'none';
                }
            }
        }

        // Verificar se é acesso público (proposta pública)
        async function verificarAcessoPublico() {
            const urlParams = new URLSearchParams(window.location.search);
            const token = urlParams.get('proposta');
            
            if (token) {
                // Buscar orçamento por token
                try {
                    // Primeiro buscar orçamento sem relação (mais simples)
                    const { data: orcamentoData, error: orcamentoError } = await supabase
                        .from('orcamentos')
                        .select('*')
                        .eq('token_publico', token)
                        .eq('acesso_publico', true)
                        .single();
                    
                    if (orcamentoError) throw orcamentoError;
                    
                    if (orcamentoData) {
                        // Buscar cliente separadamente
                        let cliente = null;
                        if (orcamentoData.cliente_id) {
                            try {
                                const { data: clienteData, error: clienteError } = await supabase
                                    .from('clientes')
                                    .select('*')
                                    .eq('id', orcamentoData.cliente_id)
                                    .single();
                                
                                if (!clienteError && clienteData) {
                                    cliente = clienteData;
                                }
                            } catch (e) {
                                console.warn('Erro ao buscar cliente:', e);
                            }
                        }
                        
                        // Combinar dados
                        const orcamentoCompleto = {
                            ...orcamentoData,
                            cliente: cliente
                        };
                        
                        // Mostrar página pública da proposta
                        mostrarPropostaPublica(orcamentoCompleto);
                        return true;
                    }
                } catch (error) {
                    console.error('Erro ao buscar proposta pública:', error);
                    alert('Link inválido ou expirado. Entre em contato com o vendedor.');
                    window.location.href = window.location.pathname;
                    return false;
                }
            }
            
            return false;
        }
        
        // Mostrar proposta pública
        function mostrarPropostaPublica(orcamento) {
            console.log('=== DEBUG PROPOSTA PÚBLICA ===');
            console.log('Orçamento completo:', JSON.stringify(orcamento, null, 2));
            console.log('Cliente:', orcamento.cliente);
            console.log('Cliente ID:', orcamento.cliente_id);
            console.log('Itens (bruto):', orcamento.itens);
            console.log('Tipo de itens:', typeof orcamento.itens);
            
            // Esconder dashboard e login
            if (document.getElementById('loginPage')) {
                document.getElementById('loginPage').style.display = 'none';
            }
            if (document.getElementById('dashboardPage')) {
                document.getElementById('dashboardPage').style.display = 'none';
            }
            
            // Criar página pública se não existir
            let publicPage = document.getElementById('propostaPublicaPage');
            if (!publicPage) {
                publicPage = document.createElement('div');
                publicPage.id = 'propostaPublicaPage';
                publicPage.style.cssText = 'min-height: 100vh; background: #f5f5f5; padding: 40px 20px; font-family: Arial, sans-serif;';
                document.body.appendChild(publicPage);
            }
            
            publicPage.style.display = 'block';
            
            // Buscar itens do orçamento (pode vir como string JSON ou array)
            let itens = orcamento.itens || [];
            console.log('Itens brutos:', itens);
            console.log('Tipo de itens:', typeof itens);
            console.log('É array?', Array.isArray(itens));
            
            // Se for null ou undefined, usar array vazio
            if (!itens) {
                itens = [];
            }
            
            // Se for string, tentar fazer parse
            if (typeof itens === 'string') {
                console.log('Itens é string, tentando fazer parse...');
                try {
                    const itensTrimmed = itens.trim();
                    if (itensTrimmed.length > 0) {
                        if (itensTrimmed.startsWith('[') || itensTrimmed.startsWith('{')) {
                            itens = JSON.parse(itensTrimmed);
                            console.log('Parse bem-sucedido:', itens);
                        } else {
                            console.warn('String não é JSON válido:', itensTrimmed.substring(0, 50));
                            itens = [];
                        }
                    } else {
                        console.warn('String vazia');
                        itens = [];
                    }
                } catch (e) {
                    console.error('Erro ao fazer parse dos itens:', e);
                    console.error('String que falhou:', itens.substring(0, 100));
                    itens = [];
                }
            }
            
            // Garantir que é array
            if (!Array.isArray(itens)) {
                console.log('Não é array, tentando converter...');
                if (itens && typeof itens === 'object') {
                    // Se for objeto único, transformar em array
                    console.log('Convertendo objeto único para array');
                    itens = [itens];
                } else {
                    console.warn('Não é objeto válido, usando array vazio');
                    itens = [];
                }
            }
            
            console.log('Itens processados (final):', itens);
            console.log('Quantidade de itens:', itens.length);
            
            // Recalcular subtotais dos itens se necessário
            itens = itens.map(item => {
                const quantidade = parseFloat(item.quantidade) || 1;
                const valorUnitario = parseFloat(item.valor_unitario) || 0;
                const descontoPercent = parseFloat(item.desconto_percent) || 0;
                
                const subtotal = Math.round((quantidade * valorUnitario) * 100) / 100;
                const descontoValor = Math.round((subtotal * (descontoPercent / 100)) * 100) / 100;
                const subtotalFinal = Math.round((subtotal - descontoValor) * 100) / 100;
                
                return {
                    ...item,
                    quantidade: quantidade,
                    valor_unitario: valorUnitario,
                    desconto_percent: descontoPercent,
                    subtotal: item.subtotal || subtotalFinal
                };
            });
            
            // Calcular total se não existir
            let total = parseFloat(orcamento.valor) || 0;
            if (total === 0 && itens.length > 0) {
                total = itens.reduce((sum, item) => sum + (parseFloat(item.subtotal) || 0), 0);
                total = Math.round(total * 100) / 100;
            }
            
            // Formatar moeda
            const formatCurrency = (value) => {
                if (!value && value !== 0) return 'R$ 0,00';
                const num = parseFloat(value) || 0;
                return new Intl.NumberFormat('pt-BR', {
                    style: 'currency',
                    currency: 'BRL'
                }).format(num);
            };
            
            // Formatar data
            const formatDate = (dateStr) => {
                if (!dateStr) return '-';
                try {
                    const date = new Date(dateStr);
                    return date.toLocaleDateString('pt-BR');
                } catch {
                    return dateStr;
                }
            };
            
            // Extrair dados do cliente (pode vir como objeto ou aninhado)
            let cliente = orcamento.cliente || null;
            
            // Se cliente não vier na relação, tentar buscar pelo cliente_id
            if (!cliente && orcamento.cliente_id) {
                // Cliente já foi buscado na função verificarAcessoPublico
                // Mas vamos garantir que temos os dados
                cliente = orcamento.cliente || {};
            }
            
            if (typeof cliente === 'string') {
                try {
                    cliente = JSON.parse(cliente);
                } catch (e) {
                    cliente = {};
                }
            }
            
            // Garantir que cliente é um objeto
            if (!cliente || typeof cliente !== 'object') {
                cliente = {};
            }
            
            console.log('Cliente processado:', cliente);
            console.log('Cliente ID no orçamento:', orcamento.cliente_id);
            console.log('Cliente tem nome?', !!cliente.nome);
            console.log('Cliente tem empresa?', !!cliente.empresa);
            
            const clienteNome = cliente.nome || cliente.empresa || (orcamento.cliente_id ? 'Cliente ID: ' + orcamento.cliente_id : 'Cliente não informado');
            const clienteEmail = cliente.email || '';
            const clienteTelefone = cliente.telefone || cliente.whatsapp || '';
            const clienteCpfCnpj = cliente.cpf_cnpj || '';
            const clienteEndereco = cliente.endereco || '';
            const clienteCidade = cliente.cidade || '';
            const clienteEstado = cliente.estado || '';
            
            console.log('Dados do cliente para exibição:');
            console.log('- Nome:', clienteNome);
            console.log('- Email:', clienteEmail);
            console.log('- Telefone:', clienteTelefone);
            
            // Extrair observações (remover condições comerciais se existir)
            let observacoes = orcamento.observacoes || '';
            if (observacoes.includes('=== CONDIÇÕES COMERCIAIS ===')) {
                const partes = observacoes.split('=== CONDIÇÕES COMERCIAIS ===');
                observacoes = partes[0].trim();
            }
            
            // Renderizar proposta
            publicPage.innerHTML = `
                <div style="max-width: 800px; margin: 0 auto; background: white; padding: 40px; border-radius: 8px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
                    <div style="text-align: right; margin-bottom: 20px; color: #666; font-size: 14px;">
                        N° ${String(orcamento.numero || 'N/A').padStart(4, '0')} - ${formatDate(orcamento.data)}
                    </div>
                    
                    <div style="text-align: center; margin-bottom: 40px;">
                        <h1 style="color: #FF6600; font-size: 28px; margin-bottom: 10px; font-weight: bold;">PROPOSTA COMERCIAL</h1>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <div style="background: #FF6600; color: white; padding: 10px; font-weight: bold; font-size: 16px; margin-bottom: 15px;">
                            Dados do Cliente
                        </div>
                        <div style="padding: 15px 10px; background: #fafafa; border-radius: 4px;">
                            ${clienteNome && clienteNome !== 'Cliente não informado' ? `<p style="margin: 8px 0; color: #333;"><strong>Cliente:</strong> ${clienteNome.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>` : '<p style="margin: 8px 0; color: #999; font-style: italic;">Cliente não informado</p>'}
                            ${clienteEmail ? `<p style="margin: 8px 0; color: #333;"><strong>Email:</strong> ${clienteEmail.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>` : ''}
                            ${clienteTelefone ? `<p style="margin: 8px 0; color: #333;"><strong>Telefone:</strong> ${clienteTelefone.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>` : ''}
                            ${clienteCpfCnpj ? `<p style="margin: 8px 0; color: #333;"><strong>CPF/CNPJ:</strong> ${clienteCpfCnpj.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>` : ''}
                            ${clienteEndereco ? `<p style="margin: 8px 0; color: #333;"><strong>Endereço:</strong> ${clienteEndereco.replace(/</g, '&lt;').replace(/>/g, '&gt;')}${clienteCidade ? ', ' + clienteCidade.replace(/</g, '&lt;').replace(/>/g, '&gt;') : ''}${clienteEstado ? ' - ' + clienteEstado.replace(/</g, '&lt;').replace(/>/g, '&gt;') : ''}</p>` : ''}
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 30px;">
                        <div style="background: #FF6600; color: white; padding: 10px; font-weight: bold; font-size: 16px; margin-bottom: 15px;">
                            Itens do Orçamento
                        </div>
                        ${itens.length > 0 ? `
                            <table style="width: 100%; border-collapse: collapse; margin-bottom: 20px; background: white;">
                                <thead>
                                    <tr style="background: #FF6600; color: white;">
                                        <th style="padding: 12px; text-align: left; font-weight: bold; border: none;">Descrição</th>
                                        <th style="padding: 12px; text-align: center; font-weight: bold; border: none; width: 80px;">Qtd</th>
                                        <th style="padding: 12px; text-align: right; font-weight: bold; border: none; width: 120px;">Valor Unit.</th>
                                        <th style="padding: 12px; text-align: right; font-weight: bold; border: none; width: 120px;">Subtotal</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${itens.map((item, index) => `
                                        <tr style="border-bottom: 1px solid #e5e5e5; ${index % 2 === 0 ? 'background: #fafafa;' : 'background: white;'}">
                                            <td style="padding: 12px; color: #333;">${(item.descricao || '-').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</td>
                                            <td style="padding: 12px; text-align: center; color: #333;">${item.quantidade || 1}</td>
                                            <td style="padding: 12px; text-align: right; color: #333;">${formatCurrency(item.valor_unitario || 0)}</td>
                                            <td style="padding: 12px; text-align: right; color: #333; font-weight: 600;">${formatCurrency(item.subtotal || 0)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                                <tfoot>
                                    <tr style="background: #f5f5f5; font-weight: bold; border-top: 2px solid #FF6600;">
                                        <td colspan="3" style="padding: 15px; text-align: right; font-size: 16px; color: #333;">Total:</td>
                                        <td style="padding: 15px; text-align: right; color: #FF6600; font-size: 20px; font-weight: bold;">${formatCurrency(total)}</td>
                                    </tr>
                                </tfoot>
                            </table>
                        ` : `
                            <div style="padding: 40px; text-align: center; background: #fafafa; border-radius: 4px; border: 1px dashed #ddd;">
                                <p style="color: #999; font-style: italic; margin: 0;">Nenhum item adicionado ao orçamento.</p>
                            </div>
                        `}
                    </div>
                    
                    ${observacoes ? `
                        <div style="margin-bottom: 30px;">
                            <div style="background: #FF6600; color: white; padding: 10px; font-weight: bold; font-size: 16px; margin-bottom: 15px;">
                                Observações
                            </div>
                            <div style="padding: 0 10px;">
                                <p style="white-space: pre-wrap; line-height: 1.6;">${observacoes.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</p>
                            </div>
                        </div>
                    ` : ''}
                    
                    <div style="margin-top: 40px; padding-top: 20px; border-top: 2px solid #FF6600; text-align: center;">
                        <button onclick="gerarPDFOrcamentoPublico('${orcamento.id}')" style="background: #FF6600; color: white; border: none; padding: 12px 24px; border-radius: 4px; font-size: 16px; cursor: pointer; margin-right: 10px; font-weight: bold;">
                            📄 Baixar PDF
                        </button>
                        ${!orcamento.assinado ? `
                            <button onclick="abrirAssinatura('${orcamento.id}')" style="background: #10B981; color: white; border: none; padding: 12px 24px; border-radius: 4px; font-size: 16px; cursor: pointer; font-weight: bold;">
                                ✍️ Assinar Proposta
                            </button>
                        ` : `
                            <div style="margin-top: 20px; padding: 15px; background: #d4edda; border-radius: 4px; color: #155724; font-weight: bold;">
                                ✅ Proposta assinada em ${formatDate(orcamento.data_assinatura || orcamento.updated_at)}
                            </div>
                        `}
                    </div>
                </div>
            `;
        }
        
        // Gerar PDF da proposta pública
        async function gerarPDFOrcamentoPublico(orcamentoId) {
            try {
                // Buscar orçamento completo
                const { data: orcamentoData, error: orcamentoError } = await supabase
                    .from('orcamentos')
                    .select('*')
                    .eq('id', orcamentoId)
                    .single();
                
                if (orcamentoError) throw orcamentoError;
                if (!orcamentoData) {
                    alert('Orçamento não encontrado');
                    return;
                }
                
                // Buscar cliente separadamente
                let clienteCompleto = {};
                if (orcamentoData.cliente_id) {
                    try {
                        const { data: clienteData, error: clienteError } = await supabase
                            .from('clientes')
                            .select('*')
                            .eq('id', orcamentoData.cliente_id)
                            .single();
                        
                        if (!clienteError && clienteData) {
                            clienteCompleto = clienteData;
                        }
                    } catch (e) {
                        console.warn('Erro ao buscar cliente para PDF:', e);
                    }
                }
                
                // Combinar dados
                const orcamento = {
                    ...orcamentoData,
                    cliente: clienteCompleto
                };
                
                // Chamar função de gerar PDF com orçamento
                await gerarPDFOrcamentoDireto(orcamento);
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                alert('Erro ao gerar PDF: ' + (error.message || 'Erro desconhecido'));
            }
        }
        
        // Gerar PDF diretamente a partir de um orçamento (sem depender do modal)
        async function gerarPDFOrcamentoDireto(orcamento) {
            try {
                // Verificar se jsPDF está disponível
                if (!window.jspdf) {
                    alert('Biblioteca de PDF não carregada. Por favor, recarregue a página.');
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // Função auxiliar para formatar moeda no PDF
                const formatCurrencyPDF = (value) => {
                    if (!value && value !== 0) return 'R$ 0,00';
                    return new Intl.NumberFormat('pt-BR', {
                        style: 'currency',
                        currency: 'BRL'
                    }).format(value);
                };

                // Função auxiliar para formatar data no PDF
                const formatDatePDF = (dateStr) => {
                    if (!dateStr) return '-';
                    try {
                        const date = new Date(dateStr);
                        return date.toLocaleDateString('pt-BR');
                    } catch {
                        return dateStr;
                    }
                };

                // Configurações
                const margin = 20;
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                let y = margin;

                // ========== CABEÇALHO - DADOS DA EMPRESA ==========
                let logoLoaded = false;
                
                // Tentar adicionar logo
                try {
                    const logoUrl = 'https://zhzhpctsndrcedukivhk.supabase.co/storage/v1/object/public/logo/LOGO%203D%20SEM%20FUNDO%20(1).png';
                    
                    // Usar fetch para obter a imagem como base64
                    const response = await fetch(logoUrl);
                    if (response.ok) {
                        const blob = await response.blob();
                        const reader = new FileReader();
                        
                        await new Promise((resolve, reject) => {
                            reader.onload = () => resolve(reader.result);
                            reader.onerror = reject;
                            reader.readAsDataURL(blob);
                        });
                        
                        const logoData = reader.result;
                        // Adicionar logo (ajustar tamanho conforme necessário)
                        doc.addImage(logoData, 'PNG', margin, 5, 60, 25);
                        logoLoaded = true;
                    }
                } catch (e) {
                    console.warn('Erro ao carregar logo:', e);
                }
                
                // Se logo não carregou, usar texto
                if (!logoLoaded) {
                    doc.setFillColor(255, 102, 0);
                    doc.rect(0, 0, pageWidth, 50, 'F');
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(28);
                    doc.setFont(undefined, 'bold');
                    doc.text('AUTOVIZION', margin, 30);
                    
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'normal');
                    doc.text('Soluções em Marketing Digital e Tecnologia', margin, 38);
                }
                
                // Dados da empresa no cabeçalho (lado direito) - Melhor formatado
                const dadosX = pageWidth - margin - 60;
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('AUTOVIZION', dadosX, 12);
                
                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(60, 60, 60);
                doc.text('www.autovizon.com.br', dadosX, 20);
                doc.text('autovizioncomercial@gmail.com', dadosX, 26);
                doc.text('(14) 99683-3385', dadosX, 32);
                
                // Linha divisória abaixo do cabeçalho
                doc.setDrawColor(200, 200, 200);
                doc.line(margin, 35, pageWidth - margin, 35);
                
                y = 45;

                // ========== TÍTULO DO DOCUMENTO ==========
                // Fundo colorido para o título
                doc.setFillColor(255, 102, 0);
                doc.rect(margin, y - 5, pageWidth - (margin * 2), 20, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(22);
                doc.setFont(undefined, 'bold');
                doc.text('PROPOSTA COMERCIAL', margin + 5, y + 8);
                
                // Número e data à direita (sobre o fundo)
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Nº ${orcamento.numero || 'N/A'}`, pageWidth - margin - 30, y + 2);
                doc.text(`Data: ${formatDatePDF(orcamento.data)}`, pageWidth - margin - 30, y + 9);
                
                y += 20;

                // ========== DADOS DO CLIENTE ==========
                // Definir variáveis do cliente primeiro
                const clienteNome = orcamento.cliente?.nome || orcamento.cliente?.empresa || 'Cliente não encontrado';
                const clienteEmpresa = orcamento.cliente?.empresa || '';
                const clienteCpfCnpj = orcamento.cliente?.cpf_cnpj || '';
                const clienteEndereco = orcamento.cliente?.endereco || '';
                const clienteCidade = orcamento.cliente?.cidade || '';
                const clienteEstado = orcamento.cliente?.estado || '';
                const clienteCep = orcamento.cliente?.cep || '';
                const clienteTelefone = orcamento.cliente?.telefone || '';
                const clienteEmail = orcamento.cliente?.email || '';

                // ========== INTRODUÇÃO ==========
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(60, 60, 60);
                const introText = `Prezado(a) ${clienteNome},`;
                doc.text(introText, margin, y);
                y += 8;
                
                const apresentacao = `É com grande entusiasmo que finalizamos a análise de suas necessidades e desenvolvemos uma proposta comercial estratégica. Nosso foco é apresentar soluções concretas que impulsionarão seus resultados e atenderão, com excelência, aos seus objetivos específicos.`;
                const apresentacaoLines = doc.splitTextToSize(apresentacao, pageWidth - (margin * 2));
                doc.text(apresentacaoLines, margin, y);
                y += apresentacaoLines.length * 5 + 10;

                // ========== DADOS DO CLIENTE ==========
                // Fundo com cor laranja suave
                doc.setFillColor(255, 102, 0);
                doc.rect(margin, y, pageWidth - (margin * 2), 8, 'F');
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('DADOS DO CLIENTE', margin + 3, y + 6);
                y += 12;
                
                doc.setTextColor(0, 0, 0);
                
                doc.text(`Cliente: ${clienteNome}`, margin, y);
                y += 6;
                if (clienteEmpresa && clienteEmpresa !== clienteNome) {
                    doc.text(`Empresa: ${clienteEmpresa}`, margin, y);
                    y += 6;
                }
                if (clienteCpfCnpj) {
                    doc.text(`CPF/CNPJ: ${clienteCpfCnpj}`, margin, y);
                    y += 6;
                }
                if (clienteEndereco) {
                    let enderecoCompleto = clienteEndereco;
                    if (clienteCidade) enderecoCompleto += `, ${clienteCidade}`;
                    if (clienteEstado) enderecoCompleto += ` - ${clienteEstado}`;
                    if (clienteCep) enderecoCompleto += ` - CEP: ${clienteCep}`;
                    doc.text(`Endereço: ${enderecoCompleto}`, margin, y);
                    y += 6;
                }
                if (clienteTelefone) {
                    doc.text(`Telefone: ${clienteTelefone}`, margin, y);
                    y += 6;
                }
                if (clienteEmail) {
                    doc.text(`E-mail: ${clienteEmail}`, margin, y);
                    y += 6;
                }
                
                y += 10;

                // ========== ITENS DO ORÇAMENTO ==========
                // Fundo com cor laranja suave
                doc.setFillColor(255, 102, 0);
                doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('ITENS DO ORÇAMENTO', margin + 3, y + 4);
                y += 12;
                
                doc.setTextColor(0, 0, 0);

                // Fazer parse dos itens se necessário
                let itens = orcamento.itens || [];
                if (typeof itens === 'string') {
                    try {
                        itens = JSON.parse(itens);
                    } catch (e) {
                        console.error('Erro ao fazer parse dos itens no PDF:', e);
                        itens = [];
                    }
                }
                if (!Array.isArray(itens)) {
                    itens = [];
                }
                
                if (itens.length > 0) {
                    // Definir posições das colunas de forma clara
                    const colDescricao = margin + 2;
                    const colQtd = margin + 65;
                    const colValorUnit = margin + 85;
                    const colDesconto = margin + 120;
                    
                    // Cabeçalho da tabela com cor destacada
                    doc.setFillColor(45, 45, 45);
                    doc.rect(margin, y - 5, pageWidth - (margin * 2), 8, 'F');
                    
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(255, 255, 255);
                    doc.text('Descrição', colDescricao, y);
                    doc.text('Qtd', colQtd, y);
                    doc.text('Valor Unit.', colValorUnit, y);
                    doc.text('Desconto', colDesconto, y);
                    y += 8;

                    let subtotal = 0;
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(9);
                    
                    itens.forEach((item, index) => {
                        // Verificar se precisa de nova página (deixar espaço para pelo menos 3 linhas + totais)
                        if (y > pageHeight - 80) {
                            doc.addPage();
                            y = margin + 10;
                        }
                        
                        // Linha alternada (opcional)
                        if (index % 2 === 0) {
                            doc.setFillColor(250, 250, 250);
                            doc.rect(margin, y - 3, pageWidth - (margin * 2), 6, 'F');
                        }
                        
                        // Acessar campos com fallback para diferentes nomes
                        const descricao = item.descricao || item.desc || '-';
                        const quantidade = parseFloat(item.quantidade || item.qtd || 0);
                        const valorUnitario = parseFloat(item.valor_unitario || item.valorUnitario || item.valor_unit || 0);
                        const descontoPercent = parseFloat(item.desconto_percent || item.descontoPercent || item.desconto || 0);
                        
                        // Recalcular subtotal do item - COM PRECISÃO
                        const itemSubtotal = Math.round((quantidade * valorUnitario) * 100) / 100;
                        const descontoValor = Math.round((itemSubtotal * (descontoPercent / 100)) * 100) / 100;
                        const subtotalItem = Math.round((itemSubtotal - descontoValor) * 100) / 100;
                        subtotal = Math.round((subtotal + subtotalItem) * 100) / 100;
                        
                        // Descrição (pode quebrar linha se muito longa)
                        const descLines = doc.splitTextToSize(descricao, 60);
                        const firstLineY = y;
                        doc.setTextColor(0, 0, 0);
                        doc.text(descLines, colDescricao, firstLineY);
                        
                        // Quantidade
                        doc.text(quantidade.toString(), colQtd, firstLineY);
                        
                        // Valor unitário
                        doc.text(formatCurrencyPDF(valorUnitario), colValorUnit, firstLineY);
                        
                        // Desconto
                        doc.text(descontoPercent + '%', colDesconto, firstLineY);
                        
                        y += Math.max(6, descLines.length * 6);
                    });

                    y += 5;
                    doc.setDrawColor(200, 200, 200);
                    doc.line(margin, y, pageWidth - margin, y);
                    y += 10;

                    // ========== TOTAIS ==========
                    // Verificar se há espaço para os totais (subtotal + desconto + total + linha = ~30px)
                    if (y > pageHeight - 50) {
                        doc.addPage();
                        y = margin + 10;
                    }
                    
                    const descontoGeral = parseFloat(orcamento.desconto_geral || 0);
                    // Calcular total corretamente - COM PRECISÃO
                    const descontoGeralArredondado = Math.round(descontoGeral * 100) / 100;
                    const subtotalArredondado = Math.round(subtotal * 100) / 100;
                    const total = Math.round((subtotalArredondado - descontoGeralArredondado) * 100) / 100;
                    
                    // Subtotal e Total - mesma linha, mesmo estilo, apenas linha de separação
                    // Alinhar mais à esquerda para seguir o alinhamento geral da página
                    const labelX = margin + 10; // Posição do label (alinhado à esquerda, seguindo o alinhamento geral)
                    const valueX = labelX + 100; // Posição do valor (espaçamento fixo após o label, mais à esquerda)
                    
                    // Subtotal - texto preto, tamanho normal
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(0, 0, 0);
                    doc.text('Subtotal:', labelX, y);
                    doc.text(formatCurrencyPDF(subtotal), valueX, y);
                    y += 7;

                    if (descontoGeral > 0) {
                        doc.setTextColor(200, 0, 0);
                        doc.text('Desconto Geral:', labelX, y);
                        doc.text(formatCurrencyPDF(descontoGeral), valueX, y);
                        y += 7;
                    }

                    // Linha laranja para separar (apenas uma listra)
                    doc.setDrawColor(255, 102, 0);
                    doc.setLineWidth(1);
                    doc.line(labelX - 10, y, valueX + 50, y);
                    y += 8;

                    // TOTAL - mesmo estilo do subtotal, seguindo as mesmas linhas
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold'); // Negrito para destacar
                    doc.setTextColor(0, 0, 0); // Texto preto, igual ao subtotal
                    doc.text('TOTAL:', labelX, y);
                    // Valor também preto, negrito - alinhado à esquerda, mesmo estilo do subtotal
                    const totalText = formatCurrencyPDF(total);
                    doc.text(totalText, valueX, y);
                    y += 15;
                } else {
                    doc.setFontSize(10);
                    doc.setTextColor(128, 128, 128);
                    doc.text('Nenhum item cadastrado', margin, y);
                    y += 10;
                }
                
                y += 10;

                // ========== CONDIÇÕES COMERCIAIS ==========
                const observacoes = orcamento.observacoes || '';
                let condicoesPagamento = '';
                let formaPagamento = '';
                let prazoEntrega = '';
                
                if (observacoes.includes('=== CONDIÇÕES COMERCIAIS ===')) {
                    const partes = observacoes.split('=== CONDIÇÕES COMERCIAIS ===');
                    const condicoesTexto = partes[1] || '';
                    
                    const matchCondicoes = condicoesTexto.match(/Condições de Pagamento:\s*(.+?)(?:\n|$)/i);
                    if (matchCondicoes) condicoesPagamento = matchCondicoes[1].trim();
                    
                    const matchForma = condicoesTexto.match(/Forma de Pagamento:\s*(.+?)(?:\n|$)/i);
                    if (matchForma) formaPagamento = matchForma[1].trim();
                    
                    const matchPrazo = condicoesTexto.match(/Prazo de Entrega:\s*(.+?)(?:\n|$)/i);
                    if (matchPrazo) prazoEntrega = matchPrazo[1].trim();
                }
                
                if (condicoesPagamento || formaPagamento || prazoEntrega) {
                    // Verificar se precisa de nova página
                    if (y > pageHeight - 60) {
                        doc.addPage();
                        y = margin + 10;
                    }
                    
                    doc.setFillColor(255, 102, 0);
                    doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                    
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(255, 255, 255);
                    doc.text('CONDIÇÕES COMERCIAIS', margin + 3, y + 4);
                    y += 12;
                    
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(9);
                    doc.setTextColor(0, 0, 0);
                    
                    if (condicoesPagamento) {
                        doc.text(`Condições de Pagamento: ${condicoesPagamento}`, margin, y);
                        y += 6;
                    }
                    if (formaPagamento) {
                        doc.text(`Forma de Pagamento: ${formaPagamento}`, margin, y);
                        y += 6;
                    }
                    if (prazoEntrega) {
                        doc.text(`Prazo de Entrega: ${prazoEntrega}`, margin, y);
                        y += 6;
                    }
                    
                    y += 5;
                }
                
                // ========== OBSERVAÇÕES ==========
                let observacoesParaPDF = observacoes;
                if (observacoesParaPDF.includes('=== CONDIÇÕES COMERCIAIS ===')) {
                    const partes = observacoesParaPDF.split('=== CONDIÇÕES COMERCIAIS ===');
                    observacoesParaPDF = partes[0].trim();
                }
                
                if (observacoesParaPDF) {
                    // Verificar se precisa de nova página
                    if (y > pageHeight - 40) {
                        doc.addPage();
                        y = margin + 10;
                    }
                    
                    doc.setFillColor(255, 102, 0);
                    doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                    
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(255, 255, 255);
                    doc.text('OBSERVAÇÕES', margin + 3, y + 4);
                    y += 12;
                    
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(9);
                    doc.setTextColor(60, 60, 60);
                    const observacoesLines = doc.splitTextToSize(observacoesParaPDF, pageWidth - (margin * 2));
                    doc.text(observacoesLines, margin, y);
                    y += observacoesLines.length * 4 + 5;
                }
                
                // ========== TERMOS E CONDIÇÕES ==========
                // Verificar se precisa de nova página
                if (y > pageHeight - 50) {
                    doc.addPage();
                    y = margin + 10;
                }
                
                doc.setFillColor(255, 102, 0);
                doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('TERMOS E CONDIÇÕES', margin + 3, y + 4);
                y += 12;
                
                doc.setFont(undefined, 'normal');
                doc.setFontSize(8);
                doc.setTextColor(60, 60, 60);
                
                const validadeDias = orcamento.validade_dias || 30;
                const termosRodape = [
                    `1. Esta proposta tem validade de ${validadeDias} dias corridos a partir da data de emissão.`,
                    '2. A contratação dos serviços está sujeita à assinatura de contrato específico.',
                    '3. Os valores podem sofrer alterações mediante alteração de escopo.',
                    '4. Para mais informações, entre em contato conosco através dos canais indicados.'
                ];
                
                termosRodape.forEach(termo => {
                    // Verificar se precisa de nova página para os termos
                    if (y > pageHeight - 15) {
                        doc.addPage();
                        y = margin + 10;
                    }
                    const termoLines = doc.splitTextToSize(termo, pageWidth - (margin * 2));
                    doc.text(termoLines, margin, y);
                    y += termoLines.length * 4 + 2;
                });
                
                // Informações de contato no rodapé - Sempre na última linha da página
                const contatoY = pageHeight - 8;
                doc.setFontSize(7);
                doc.setTextColor(128, 128, 128);
                doc.setFont(undefined, 'normal');
                doc.text('AUTOVIZION', margin, contatoY);
                doc.text('|', margin + 25, contatoY);
                doc.text('www.autovizon.com.br', margin + 30, contatoY);
                doc.text('|', margin + 70, contatoY);
                doc.text('autovizioncomercial@gmail.com', margin + 75, contatoY);
                doc.text('|', margin + 130, contatoY);
                doc.text('(14) 99683-3385', margin + 135, contatoY);
                
                // Salvar PDF
                const fileName = `Proposta_${orcamento.numero || 'N'}_${clienteNome.replace(/[^a-zA-Z0-9]/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(fileName);
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                alert('Erro ao gerar PDF: ' + (error.message || 'Erro desconhecido'));
            }
        }
        
        // Abrir modal de assinatura
        function abrirAssinatura(orcamentoId) {
            alert('Funcionalidade de assinatura será implementada em breve. Por enquanto, você pode baixar o PDF e assinar manualmente.');
        }
        
        // Fechar modal ao clicar no overlay (mas não no conteúdo)
        // Adicionar evento de clique em todos os modais
        function setupModalCloseOnOverlay() {
            document.querySelectorAll('.modal').forEach(modal => {
                // Remover listener antigo se existir
                if (modal._overlayClickHandler) {
                    modal.removeEventListener('click', modal._overlayClickHandler);
                }
                
                // Criar novo handler
                modal._overlayClickHandler = function(e) {
                    // Verificar se o clique foi no overlay (não no conteúdo)
                    // Se o clique foi no próprio modal (overlay), não no conteúdo
                    if (e.target === modal) {
                        // Prevenir qualquer ação padrão
                        e.preventDefault();
                        e.stopPropagation();
                        
                        // Clique foi no overlay, fechar modal
                        const modalId = modal.id;
                        if (modalId === 'clienteDetailsModal') {
                            closeClienteDetailsModal();
                        } else if (modalId === 'projetoDetailsModal') {
                            closeProjetoDetailsModal();
                        } else if (modalId === 'orcamentoDetailsModal') {
                            closeOrcamentoDetailsModal();
                        } else if (modalId === 'clienteModal') {
                            closeClienteModal();
                        } else if (modalId === 'projetoModal') {
                            closeProjetoModal();
                        } else if (modalId === 'orcamentoModal') {
                            closeOrcamentoModal();
                        } else if (modalId === 'receitaModal') {
                            closeReceitaModal();
                        } else if (modalId === 'despesaModal') {
                            closeDespesaModal();
                        } else if (modalId === 'cobrancaModal') {
                            closeCobrancaModal();
                        } else {
                            // Para outros modais, usar função genérica
                            closeModal(modal);
                        }
                    }
                };
                
                // Adicionar listener
                modal.addEventListener('click', modal._overlayClickHandler);
                
                // Prevenir propagação de cliques no conteúdo do modal
                const modalContent = modal.querySelector('.modal-content');
                if (modalContent) {
                    // Remover listener antigo se existir
                    if (modalContent._contentClickHandler) {
                        modalContent.removeEventListener('click', modalContent._contentClickHandler);
                    }
                    
                    modalContent._contentClickHandler = function(e) {
                        // Prevenir que o clique no conteúdo propague para o overlay
                        e.stopPropagation();
                    };
                    
                    modalContent.addEventListener('click', modalContent._contentClickHandler);
                }
            });
        }
        
        // Configurar modais ao carregar
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', setupModalCloseOnOverlay);
        } else {
            setupModalCloseOnOverlay();
        }
        
        // Reconfigurar quando novos modais são criados (se necessário)
        const observer = new MutationObserver(function(mutations) {
            mutations.forEach(function(mutation) {
                if (mutation.addedNodes.length) {
                    mutation.addedNodes.forEach(function(node) {
                        if (node.nodeType === 1 && node.classList && node.classList.contains('modal')) {
                            setupModalCloseOnOverlay();
                        }
                    });
                }
            });
        });
        
        observer.observe(document.body, {
            childList: true,
            subtree: true
        });

        // ========== MÓDULO FINANCEIRO ==========
        let allReceitas = [];
        let filteredReceitas = [];
        let allDespesas = [];
        let filteredDespesas = [];
        let currentFinanceiroTab = 'receitas';

        // Carregar módulo financeiro
        async function loadFinanceiro() {
            await Promise.all([
                loadReceitas(),
                loadDespesas(),
                loadCategoriasDespesa(),
                loadClientesForFinanceiro()
            ]);
            // Gerar cobranças recorrentes pendentes
            await gerarProximasCobrancasRecorrentes();
            updateDashboardFinanceiro();
        }

        // Alternar entre tabs de Receitas e Despesas
        function switchFinanceiroTab(tab) {
            currentFinanceiroTab = tab;
            
            // Atualizar visual dos botões
            document.getElementById('tabReceitas').style.borderBottom = tab === 'receitas' ? '2px solid var(--primary)' : 'none';
            document.getElementById('tabDespesas').style.borderBottom = tab === 'despesas' ? '2px solid var(--primary)' : 'none';
            
            // Mostrar/ocultar tabs
            document.getElementById('receitasTab').style.display = tab === 'receitas' ? 'block' : 'none';
            document.getElementById('despesasTab').style.display = tab === 'despesas' ? 'block' : 'none';
        }

        // ========== RECEITAS ==========
        
        // Carregar receitas
        async function loadReceitas() {
            const loading = document.getElementById('receitasLoading');
            const table = document.getElementById('receitasTable');
            const empty = document.getElementById('receitasEmpty');
            const tbody = document.getElementById('receitasTableBody');
            
            try {
                if (loading) loading.classList.add('active');
                if (table) table.style.display = 'none';
                if (empty) empty.style.display = 'none';
                
                const { data, error } = await supabase
                    .from('receitas')
                    .select('*, cliente:clientes(*), projeto:projetos(*), orcamento:orcamentos(*)')
                    .order('data_vencimento', { ascending: false });
                
                if (error) throw error;
                
                allReceitas = data || [];
                filteredReceitas = [...allReceitas];
                
                // Atualizar status baseado em vencimento
                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);
                
                allReceitas = allReceitas.map(receita => {
                    if (receita.status === 'pendente') {
                        const vencimento = new Date(receita.data_vencimento);
                        vencimento.setHours(0, 0, 0, 0);
                        if (vencimento < hoje) {
                            receita.status = 'atrasado';
                            // Atualizar no banco
                            supabase.from('receitas').update({ status: 'atrasado' }).eq('id', receita.id);
                        }
                    }
                    return receita;
                });
                
                renderReceitas();
                
                if (loading) loading.classList.remove('active');
                if (tbody && filteredReceitas.length > 0) {
                    if (table) table.style.display = 'table';
                } else {
                    if (empty) empty.style.display = 'block';
                }
            } catch (error) {
                console.error('Erro ao carregar receitas:', error);
                if (loading) loading.classList.remove('active');
                if (empty) empty.style.display = 'block';
                if (empty) empty.textContent = 'Erro ao carregar receitas: ' + (error.message || 'Erro desconhecido');
            }
        }

        // Renderizar receitas
        function renderReceitas() {
            const tbody = document.getElementById('receitasTableBody');
            if (!tbody) return;
            
            if (filteredReceitas.length === 0) {
                tbody.innerHTML = '';
                return;
            }
            
            tbody.innerHTML = filteredReceitas.map(receita => {
                const cliente = receita.cliente || {};
                const clienteNome = cliente.nome || cliente.empresa || 'Cliente não encontrado';
                const statusMap = {
                    'pendente': { label: 'Pendente', class: 'badge-warning' },
                    'recebido': { label: 'Recebido', class: 'badge-success' },
                    'atrasado': { label: 'Atrasado', class: 'badge-danger' },
                    'cancelado': { label: 'Cancelado', class: 'badge-secondary' }
                };
                const status = statusMap[receita.status] || { label: receita.status, class: 'badge-secondary' };
                
                // Badge para tipo de cobrança
                let tipoBadge = '';
                if (receita.tipo_cobranca === 'parcelado') {
                    tipoBadge = `<span class="badge badge-secondary" style="font-size: 10px; margin-left: 4px;">Parcela ${receita.parcela_numero || '?'}/${receita.parcela_total || '?'}</span>`;
                } else if (receita.tipo_cobranca === 'recorrente') {
                    tipoBadge = `<span class="badge badge-secondary" style="font-size: 10px; margin-left: 4px;">Recorrente</span>`;
                } else if (receita.tipo_cobranca === 'manutencao') {
                    tipoBadge = `<span class="badge badge-secondary" style="font-size: 10px; margin-left: 4px;">Manutenção</span>`;
                }
                
                return `
                    <tr>
                        <td data-label="Descrição">
                            ${(receita.descricao || '-').replace(/</g, '&lt;').replace(/>/g, '&gt;')}
                            ${tipoBadge}
                        </td>
                        <td data-label="Cliente">${clienteNome.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</td>
                        <td data-label="Valor">${formatCurrency(receita.valor || 0)}</td>
                        <td data-label="Vencimento">${formatDate(receita.data_vencimento)}</td>
                        <td data-label="Recebimento">${receita.data_recebimento ? formatDate(receita.data_recebimento) : '-'}</td>
                        <td data-label="Status"><span class="badge ${status.class}">${status.label}</span></td>
                        <td data-label="Ações">
                            <button class="btn btn-sm btn-primary" onclick="viewReceita('${receita.id}')">Ver</button>
                            <button class="btn btn-sm btn-secondary" onclick="editReceita('${receita.id}')">Editar</button>
                            ${receita.status === 'recebido' ? `<button class="btn btn-sm btn-success" onclick="gerarComprovantePagamento('${receita.id}')" style="background: var(--success); border-color: var(--success);">📄 Comprovante</button>` : ''}
                            <button class="btn btn-sm btn-danger" onclick="deleteReceita('${receita.id}')">Excluir</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Filtrar receitas
        function filterReceitas() {
            const search = document.getElementById('receitaSearch')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('receitaStatusFilter')?.value || '';
            const clienteFilter = document.getElementById('receitaClienteFilter')?.value || '';
            
            filteredReceitas = allReceitas.filter(receita => {
                const matchSearch = !search || 
                    (receita.descricao && receita.descricao.toLowerCase().includes(search)) ||
                    (receita.cliente && (receita.cliente.nome || '').toLowerCase().includes(search)) ||
                    (receita.cliente && (receita.cliente.empresa || '').toLowerCase().includes(search));
                
                const matchStatus = !statusFilter || receita.status === statusFilter;
                const matchCliente = !clienteFilter || receita.cliente_id === clienteFilter;
                
                return matchSearch && matchStatus && matchCliente;
            });
            
            renderReceitas();
            
            // Atualizar empty state
            const table = document.getElementById('receitasTable');
            const empty = document.getElementById('receitasEmpty');
            if (filteredReceitas.length === 0) {
                if (table) table.style.display = 'none';
                if (empty) empty.style.display = 'block';
            } else {
                if (table) table.style.display = 'table';
                if (empty) empty.style.display = 'none';
            }
        }

        // Abrir modal de receita (novo)
        async function openReceitaModal() {
            document.getElementById('receitaModalTitle').textContent = 'Nova Receita';
            document.getElementById('receitaForm').reset();
            document.getElementById('receitaId').value = '';
            
            // Preencher data de vencimento com hoje + 30 dias
            const hoje = new Date();
            hoje.setDate(hoje.getDate() + 30);
            document.getElementById('receitaDataVencimento').value = hoje.toISOString().split('T')[0];
            
            // Carregar selects
            await loadClientesForReceitaSelect();
            await loadProjetosForReceitaSelect();
            await loadOrcamentosForReceitaSelect();
            
            const modal = document.getElementById('receitaModal');
            openModal(modal);
        }

        // Fechar modal de receita
        function closeReceitaModal() {
            const modal = document.getElementById('receitaModal');
            closeModal(modal);
        }

        // Editar receita
        async function editReceita(id) {
            const receita = allReceitas.find(r => r.id === id);
            if (!receita) return;
            
            document.getElementById('receitaModalTitle').textContent = 'Editar Receita';
            document.getElementById('receitaId').value = receita.id;
            document.getElementById('receitaDescricao').value = receita.descricao || '';
            document.getElementById('receitaValor').value = receita.valor || '';
            document.getElementById('receitaStatus').value = receita.status || 'pendente';
            document.getElementById('receitaFormaPagamento').value = receita.forma_pagamento || '';
            document.getElementById('receitaDataVencimento').value = receita.data_vencimento ? receita.data_vencimento.split('T')[0] : '';
            document.getElementById('receitaDataRecebimento').value = receita.data_recebimento ? receita.data_recebimento.split('T')[0] : '';
            document.getElementById('receitaObservacoes').value = receita.observacoes || '';
            
            // Carregar selects
            await loadClientesForReceitaSelect();
            await loadProjetosForReceitaSelect();
            await loadOrcamentosForReceitaSelect();
            
            // Selecionar valores
            document.getElementById('receitaClienteId').value = receita.cliente_id || '';
            document.getElementById('receitaProjetoId').value = receita.projeto_id || '';
            document.getElementById('receitaOrcamentoId').value = receita.orcamento_id || '';
            
            const modal = document.getElementById('receitaModal');
            openModal(modal);
        }

        // Ver receita (detalhes)
        function viewReceita(id) {
            const receita = allReceitas.find(r => r.id === id);
            if (!receita) return;
            
            // Por enquanto, apenas editar
            editReceita(id);
        }

        // Excluir receita
        async function deleteReceita(id) {
            if (!confirm('Tem certeza que deseja excluir esta receita?')) return;
            
            try {
                const { error } = await supabase
                    .from('receitas')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                alert('Receita excluída com sucesso!');
                await loadReceitas();
                updateDashboardFinanceiro();
            } catch (error) {
                console.error('Erro ao excluir receita:', error);
                alert('Erro ao excluir receita: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // Salvar receita (criar ou atualizar)
        document.getElementById('receitaForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('receitaId').value;
            const receitaData = {
                cliente_id: document.getElementById('receitaClienteId').value,
                projeto_id: document.getElementById('receitaProjetoId').value || null,
                orcamento_id: document.getElementById('receitaOrcamentoId').value || null,
                descricao: document.getElementById('receitaDescricao').value.trim(),
                valor: parseFloat(document.getElementById('receitaValor').value) || 0,
                data_vencimento: document.getElementById('receitaDataVencimento').value,
                data_recebimento: document.getElementById('receitaDataRecebimento').value || null,
                status: document.getElementById('receitaStatus').value,
                forma_pagamento: document.getElementById('receitaFormaPagamento').value || null,
                observacoes: document.getElementById('receitaObservacoes').value.trim() || null
            };
            
            // Se recebido, atualizar data_recebimento se não estiver preenchida
            if (receitaData.status === 'recebido' && !receitaData.data_recebimento) {
                receitaData.data_recebimento = new Date().toISOString().split('T')[0];
            }
            
            try {
                if (id) {
                    // Atualizar
                    const { error } = await supabase
                        .from('receitas')
                        .update(receitaData)
                        .eq('id', id);
                    
                    if (error) throw error;
                    alert('Receita atualizada com sucesso!');
                } else {
                    // Criar
                    const { error } = await supabase
                        .from('receitas')
                        .insert([receitaData]);
                    
                    if (error) throw error;
                    alert('Receita criada com sucesso!');
                }
                
                closeReceitaModal();
                await loadReceitas();
                updateDashboardFinanceiro();
            } catch (error) {
                console.error('Erro ao salvar receita:', error);
                alert('Erro ao salvar receita: ' + (error.message || 'Erro desconhecido'));
            }
        });

        // Carregar clientes para select de receita
        async function loadClientesForReceitaSelect() {
            try {
                const { data, error } = await supabase
                    .from('clientes')
                    .select('id, nome, empresa')
                    .eq('status', 'ativo')
                    .order('nome', { ascending: true });
                
                if (error) throw error;
                
                const select = document.getElementById('receitaClienteId');
                if (!select) return;
                
                const currentValue = select.value;
                select.innerHTML = '<option value="">Selecione um cliente</option>';
                
                (data || []).forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.id;
                    option.textContent = cliente.empresa ? `${cliente.nome} - ${cliente.empresa}` : cliente.nome;
                    select.appendChild(option);
                });
                
                if (currentValue) select.value = currentValue;
            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
            }
        }

        // Carregar clientes para filtro de receita
        async function loadClientesForFinanceiro() {
            try {
                const { data, error } = await supabase
                    .from('clientes')
                    .select('id, nome, empresa')
                    .eq('status', 'ativo')
                    .order('nome', { ascending: true });
                
                if (error) throw error;
                
                const select = document.getElementById('receitaClienteFilter');
                if (!select) return;
                
                select.innerHTML = '<option value="">Todos os clientes</option>';
                
                (data || []).forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.id;
                    option.textContent = cliente.empresa ? `${cliente.nome} - ${cliente.empresa}` : cliente.nome;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
            }
        }

        // Carregar projetos para select de receita
        async function loadProjetosForReceitaSelect() {
            try {
                const { data, error } = await supabase
                    .from('projetos')
                    .select('id, nome')
                    .order('nome', { ascending: true });
                
                if (error) throw error;
                
                const select = document.getElementById('receitaProjetoId');
                if (!select) return;
                
                const currentValue = select.value;
                select.innerHTML = '<option value="">Nenhum</option>';
                
                (data || []).forEach(projeto => {
                    const option = document.createElement('option');
                    option.value = projeto.id;
                    option.textContent = projeto.nome;
                    select.appendChild(option);
                });
                
                if (currentValue) select.value = currentValue;
            } catch (error) {
                console.error('Erro ao carregar projetos:', error);
            }
        }

        // Carregar orçamentos para select de receita
        async function loadOrcamentosForReceitaSelect() {
            try {
                const { data, error } = await supabase
                    .from('orcamentos')
                    .select('id, numero, data')
                    .order('numero', { ascending: false });
                
                if (error) throw error;
                
                const select = document.getElementById('receitaOrcamentoId');
                if (!select) return;
                
                const currentValue = select.value;
                select.innerHTML = '<option value="">Nenhum</option>';
                
                (data || []).forEach(orcamento => {
                    const option = document.createElement('option');
                    option.value = orcamento.id;
                    option.textContent = `Orçamento ${String(orcamento.numero || 'N/A').padStart(4, '0')} - ${formatDate(orcamento.data)}`;
                    select.appendChild(option);
                });
                
                if (currentValue) select.value = currentValue;
            } catch (error) {
                console.error('Erro ao carregar orçamentos:', error);
            }
        }

        // ========== DESPESAS ==========
        
        // Carregar despesas
        async function loadDespesas() {
            const loading = document.getElementById('despesasLoading');
            const table = document.getElementById('despesasTable');
            const empty = document.getElementById('despesasEmpty');
            const tbody = document.getElementById('despesasTableBody');
            
            try {
                if (loading) loading.classList.add('active');
                if (table) table.style.display = 'none';
                if (empty) empty.style.display = 'none';
                
                const { data, error } = await supabase
                    .from('despesas')
                    .select('*')
                    .order('data_vencimento', { ascending: false });
                
                if (error) throw error;
                
                allDespesas = data || [];
                filteredDespesas = [...allDespesas];
                
                // Atualizar status baseado em vencimento
                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);
                
                allDespesas = allDespesas.map(despesa => {
                    if (despesa.status === 'pendente') {
                        const vencimento = new Date(despesa.data_vencimento);
                        vencimento.setHours(0, 0, 0, 0);
                        if (vencimento < hoje) {
                            despesa.status = 'atrasado';
                            // Atualizar no banco
                            supabase.from('despesas').update({ status: 'atrasado' }).eq('id', despesa.id);
                        }
                    }
                    return despesa;
                });
                
                renderDespesas();
                
                if (loading) loading.classList.remove('active');
                if (tbody && filteredDespesas.length > 0) {
                    if (table) table.style.display = 'table';
                } else {
                    if (empty) empty.style.display = 'block';
                }
            } catch (error) {
                console.error('Erro ao carregar despesas:', error);
                if (loading) loading.classList.remove('active');
                if (empty) empty.style.display = 'block';
                if (empty) empty.textContent = 'Erro ao carregar despesas: ' + (error.message || 'Erro desconhecido');
            }
        }

        // Renderizar despesas
        function renderDespesas() {
            const tbody = document.getElementById('despesasTableBody');
            if (!tbody) return;
            
            if (filteredDespesas.length === 0) {
                tbody.innerHTML = '';
                return;
            }
            
            tbody.innerHTML = filteredDespesas.map(despesa => {
                const statusMap = {
                    'pendente': { label: 'Pendente', class: 'badge-warning' },
                    'pago': { label: 'Pago', class: 'badge-success' },
                    'atrasado': { label: 'Atrasado', class: 'badge-danger' },
                    'cancelado': { label: 'Cancelado', class: 'badge-secondary' }
                };
                const status = statusMap[despesa.status] || { label: despesa.status, class: 'badge-secondary' };
                
                return `
                    <tr>
                        <td data-label="Descrição">${(despesa.descricao || '-').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</td>
                        <td data-label="Categoria">${(despesa.categoria || '-').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</td>
                        <td data-label="Fornecedor">${(despesa.fornecedor || '-').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</td>
                        <td data-label="Valor">${formatCurrency(despesa.valor || 0)}</td>
                        <td data-label="Vencimento">${formatDate(despesa.data_vencimento)}</td>
                        <td data-label="Pagamento">${despesa.data_pagamento ? formatDate(despesa.data_pagamento) : '-'}</td>
                        <td data-label="Status"><span class="badge ${status.class}">${status.label}</span></td>
                        <td data-label="Ações">
                            <button class="btn btn-sm btn-primary" onclick="viewDespesa('${despesa.id}')">Ver</button>
                            <button class="btn btn-sm btn-secondary" onclick="editDespesa('${despesa.id}')">Editar</button>
                            <button class="btn btn-sm btn-danger" onclick="deleteDespesa('${despesa.id}')">Excluir</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Filtrar despesas
        function filterDespesas() {
            const search = document.getElementById('despesaSearch')?.value.toLowerCase() || '';
            const statusFilter = document.getElementById('despesaStatusFilter')?.value || '';
            const categoriaFilter = document.getElementById('despesaCategoriaFilter')?.value || '';
            
            filteredDespesas = allDespesas.filter(despesa => {
                const matchSearch = !search || 
                    (despesa.descricao && despesa.descricao.toLowerCase().includes(search)) ||
                    (despesa.categoria && despesa.categoria.toLowerCase().includes(search)) ||
                    (despesa.fornecedor && despesa.fornecedor.toLowerCase().includes(search));
                
                const matchStatus = !statusFilter || despesa.status === statusFilter;
                const matchCategoria = !categoriaFilter || despesa.categoria === categoriaFilter;
                
                return matchSearch && matchStatus && matchCategoria;
            });
            
            renderDespesas();
            
            // Atualizar empty state
            const table = document.getElementById('despesasTable');
            const empty = document.getElementById('despesasEmpty');
            if (filteredDespesas.length === 0) {
                if (table) table.style.display = 'none';
                if (empty) empty.style.display = 'block';
            } else {
                if (table) table.style.display = 'table';
                if (empty) empty.style.display = 'none';
            }
        }

        // Abrir modal de despesa (novo)
        async function openDespesaModal() {
            document.getElementById('despesaModalTitle').textContent = 'Nova Despesa';
            document.getElementById('despesaForm').reset();
            document.getElementById('despesaId').value = '';
            
            // Preencher data de vencimento com hoje + 30 dias
            const hoje = new Date();
            hoje.setDate(hoje.getDate() + 30);
            document.getElementById('despesaDataVencimento').value = hoje.toISOString().split('T')[0];
            
            // Carregar categorias
            await loadCategoriasDespesaSelect();
            
            const modal = document.getElementById('despesaModal');
            openModal(modal);
        }

        // Fechar modal de despesa
        function closeDespesaModal() {
            const modal = document.getElementById('despesaModal');
            closeModal(modal);
        }

        // Editar despesa
        async function editDespesa(id) {
            const despesa = allDespesas.find(d => d.id === id);
            if (!despesa) return;
            
            document.getElementById('despesaModalTitle').textContent = 'Editar Despesa';
            document.getElementById('despesaId').value = despesa.id;
            document.getElementById('despesaDescricao').value = despesa.descricao || '';
            document.getElementById('despesaCategoria').value = despesa.categoria || '';
            document.getElementById('despesaFornecedor').value = despesa.fornecedor || '';
            document.getElementById('despesaValor').value = despesa.valor || '';
            document.getElementById('despesaStatus').value = despesa.status || 'pendente';
            document.getElementById('despesaFormaPagamento').value = despesa.forma_pagamento || '';
            document.getElementById('despesaDataVencimento').value = despesa.data_vencimento ? despesa.data_vencimento.split('T')[0] : '';
            document.getElementById('despesaDataPagamento').value = despesa.data_pagamento ? despesa.data_pagamento.split('T')[0] : '';
            document.getElementById('despesaObservacoes').value = despesa.observacoes || '';
            
            // Carregar categorias
            await loadCategoriasDespesaSelect();
            
            const modal = document.getElementById('despesaModal');
            openModal(modal);
        }

        // Ver despesa (detalhes)
        function viewDespesa(id) {
            const despesa = allDespesas.find(d => d.id === id);
            if (!despesa) return;
            
            // Por enquanto, apenas editar
            editDespesa(id);
        }

        // Excluir despesa
        async function deleteDespesa(id) {
            if (!confirm('Tem certeza que deseja excluir esta despesa?')) return;
            
            try {
                const { error } = await supabase
                    .from('despesas')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                alert('Despesa excluída com sucesso!');
                await loadDespesas();
                updateDashboardFinanceiro();
            } catch (error) {
                console.error('Erro ao excluir despesa:', error);
                alert('Erro ao excluir despesa: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // Salvar despesa (criar ou atualizar)
        document.getElementById('despesaForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('despesaId').value;
            const despesaData = {
                descricao: document.getElementById('despesaDescricao').value.trim(),
                categoria: document.getElementById('despesaCategoria').value || null,
                fornecedor: document.getElementById('despesaFornecedor').value.trim() || null,
                valor: parseFloat(document.getElementById('despesaValor').value) || 0,
                data_vencimento: document.getElementById('despesaDataVencimento').value,
                data_pagamento: document.getElementById('despesaDataPagamento').value || null,
                status: document.getElementById('despesaStatus').value,
                forma_pagamento: document.getElementById('despesaFormaPagamento').value || null,
                observacoes: document.getElementById('despesaObservacoes').value.trim() || null
            };
            
            // Se pago, atualizar data_pagamento se não estiver preenchida
            if (despesaData.status === 'pago' && !despesaData.data_pagamento) {
                despesaData.data_pagamento = new Date().toISOString().split('T')[0];
            }
            
            try {
                if (id) {
                    // Atualizar
                    const { error } = await supabase
                        .from('despesas')
                        .update(despesaData)
                        .eq('id', id);
                    
                    if (error) throw error;
                    alert('Despesa atualizada com sucesso!');
                } else {
                    // Criar
                    const { error } = await supabase
                        .from('despesas')
                        .insert([despesaData]);
                    
                    if (error) throw error;
                    alert('Despesa criada com sucesso!');
                }
                
                closeDespesaModal();
                await loadDespesas();
                updateDashboardFinanceiro();
            } catch (error) {
                console.error('Erro ao salvar despesa:', error);
                alert('Erro ao salvar despesa: ' + (error.message || 'Erro desconhecido'));
            }
        });

        // Carregar categorias de despesa
        async function loadCategoriasDespesa() {
            try {
                const { data, error } = await supabase
                    .from('categorias_despesa')
                    .select('*')
                    .eq('ativo', true)
                    .order('nome', { ascending: true });
                
                if (error) throw error;
                return data || [];
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
                return [];
            }
        }

        // Carregar categorias para select de despesa
        async function loadCategoriasDespesaSelect() {
            try {
                const categorias = await loadCategoriasDespesa();
                
                const select = document.getElementById('despesaCategoria');
                if (!select) return;
                
                const currentValue = select.value;
                select.innerHTML = '<option value="">Selecione uma categoria</option>';
                
                categorias.forEach(categoria => {
                    const option = document.createElement('option');
                    option.value = categoria.nome;
                    option.textContent = categoria.nome;
                    select.appendChild(option);
                });
                
                if (currentValue) select.value = currentValue;
                
                // Carregar também no filtro
                const filterSelect = document.getElementById('despesaCategoriaFilter');
                if (filterSelect) {
                    filterSelect.innerHTML = '<option value="">Todas as categorias</option>';
                    categorias.forEach(categoria => {
                        const option = document.createElement('option');
                        option.value = categoria.nome;
                        option.textContent = categoria.nome;
                        filterSelect.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar categorias:', error);
            }
        }

        // Gerar próximas cobranças recorrentes (executar diariamente ou quando necessário)
        async function gerarProximasCobrancasRecorrentes() {
            try {
                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);
                
                // Buscar cobranças recorrentes ativas que precisam gerar próxima cobrança
                const { data: cobrancasRecorrentes, error } = await supabase
                    .from('receitas')
                    .select('*')
                    .in('tipo_cobranca', ['recorrente', 'manutencao'])
                    .eq('ativa', true)
                    .lte('data_vencimento', hoje.toISOString().split('T')[0])
                    .order('data_vencimento', { ascending: true });
                
                if (error) throw error;
                
                if (!cobrancasRecorrentes || cobrancasRecorrentes.length === 0) {
                    return; // Nenhuma cobrança para gerar
                }
                
                const novasCobrancas = [];
                
                for (const cobranca of cobrancasRecorrentes) {
                    // Verificar se já existe próxima cobrança gerada
                    const { data: proximaCobranca } = await supabase
                        .from('receitas')
                        .select('id')
                        .eq('cobranca_original_id', cobranca.id)
                        .gt('data_vencimento', hoje.toISOString().split('T')[0])
                        .maybeSingle();
                    
                    if (proximaCobranca) {
                        continue; // Já existe próxima cobrança
                    }
                    
                    // Verificar se está dentro do período (se houver data_termino)
                    if (cobranca.data_termino) {
                        const dataTermino = new Date(cobranca.data_termino);
                        if (hoje > dataTermino) {
                            // Desativar cobrança recorrente
                            await supabase
                                .from('receitas')
                                .update({ ativa: false })
                                .eq('id', cobranca.id);
                            continue;
                        }
                    }
                    
                    // Calcular próxima data de vencimento
                    let proximaDataVencimento = new Date(cobranca.data_vencimento);
                    
                    if (cobranca.tipo_cobranca === 'manutencao' || cobranca.frequencia === 'mensal') {
                        proximaDataVencimento.setMonth(proximaDataVencimento.getMonth() + 1);
                    } else if (cobranca.frequencia === 'trimestral') {
                        proximaDataVencimento.setMonth(proximaDataVencimento.getMonth() + 3);
                    } else if (cobranca.frequencia === 'semestral') {
                        proximaDataVencimento.setMonth(proximaDataVencimento.getMonth() + 6);
                    } else if (cobranca.frequencia === 'anual') {
                        proximaDataVencimento.setFullYear(proximaDataVencimento.getFullYear() + 1);
                    }
                    
                    // Ajustar para o dia de vencimento correto
                    if (cobranca.dia_vencimento) {
                        proximaDataVencimento.setDate(cobranca.dia_vencimento);
                    }
                    
                    // Criar nova cobrança
                    novasCobrancas.push({
                        cliente_id: cobranca.cliente_id,
                        orcamento_id: cobranca.orcamento_id,
                        descricao: cobranca.descricao,
                        valor: cobranca.valor,
                        data_vencimento: proximaDataVencimento.toISOString().split('T')[0],
                        status: 'pendente',
                        forma_pagamento: cobranca.forma_pagamento,
                        tipo_cobranca: cobranca.tipo_cobranca,
                        frequencia: cobranca.frequencia,
                        dia_vencimento: cobranca.dia_vencimento,
                        data_inicio: cobranca.data_inicio,
                        data_termino: cobranca.data_termino,
                        ativa: cobranca.ativa,
                        cobranca_original_id: cobranca.cobranca_original_id || cobranca.id,
                        observacoes: cobranca.observacoes
                    });
                }
                
                // Inserir novas cobranças
                if (novasCobrancas.length > 0) {
                    const { error: insertError } = await supabase
                        .from('receitas')
                        .insert(novasCobrancas);
                    
                    if (insertError) throw insertError;
                    
                    console.log(`${novasCobrancas.length} cobrança(s) recorrente(s) gerada(s) automaticamente.`);
                }
            } catch (error) {
                console.error('Erro ao gerar cobranças recorrentes:', error);
            }
        }

        // Executar geração de cobranças recorrentes ao carregar o módulo financeiro
        // e também periodicamente (a cada 1 hora)
        setInterval(gerarProximasCobrancasRecorrentes, 60 * 60 * 1000); // 1 hora

        // Atualizar dashboard financeiro
        async function updateDashboardFinanceiro() {
            try {
                // Calcular totais
                const hoje = new Date();
                hoje.setHours(0, 0, 0, 0);
                const mesAtual = hoje.getMonth();
                const anoAtual = hoje.getFullYear();
                
                // Receitas
                let totalReceber = 0;
                let receitasRecebidas = 0;
                
                allReceitas.forEach(receita => {
                    const valor = parseFloat(receita.valor) || 0;
                    const dataReceb = receita.data_recebimento ? new Date(receita.data_recebimento) : null;
                    
                    if (receita.status === 'pendente' || receita.status === 'atrasado') {
                        totalReceber += valor;
                    }
                    
                    if (receita.status === 'recebido' && dataReceb) {
                        if (dataReceb.getMonth() === mesAtual && dataReceb.getFullYear() === anoAtual) {
                            receitasRecebidas += valor;
                        }
                    }
                });
                
                // Despesas
                let totalPagar = 0;
                let despesasPagas = 0;
                
                allDespesas.forEach(despesa => {
                    const valor = parseFloat(despesa.valor) || 0;
                    const dataPag = despesa.data_pagamento ? new Date(despesa.data_pagamento) : null;
                    
                    if (despesa.status === 'pendente' || despesa.status === 'atrasado') {
                        totalPagar += valor;
                    }
                    
                    if (despesa.status === 'pago' && dataPag) {
                        if (dataPag.getMonth() === mesAtual && dataPag.getFullYear() === anoAtual) {
                            despesasPagas += valor;
                        }
                    }
                });
                
                // Saldo previsto
                const saldoPrevisto = totalReceber - totalPagar;
                
                // Vencimentos hoje
                const vencimentosHoje = [...allReceitas, ...allDespesas].filter(item => {
                    const vencimento = new Date(item.data_vencimento);
                    vencimento.setHours(0, 0, 0, 0);
                    return vencimento.getTime() === hoje.getTime() && 
                           (item.status === 'pendente' || item.status === 'atrasado');
                }).length;
                
                // Atualizar UI
                const totalReceberEl = document.getElementById('totalReceber');
                const totalPagarEl = document.getElementById('totalPagar');
                const saldoPrevistoEl = document.getElementById('saldoPrevisto');
                const receitasRecebidasEl = document.getElementById('receitasRecebidas');
                const despesasPagasEl = document.getElementById('despesasPagas');
                const vencimentosHojeEl = document.getElementById('vencimentosHoje');
                
                if (totalReceberEl) totalReceberEl.textContent = formatCurrency(totalReceber);
                if (totalPagarEl) totalPagarEl.textContent = formatCurrency(totalPagar);
                if (saldoPrevistoEl) {
                    saldoPrevistoEl.textContent = formatCurrency(saldoPrevisto);
                    saldoPrevistoEl.style.color = saldoPrevisto >= 0 ? 'var(--success)' : 'var(--danger)';
                }
                if (receitasRecebidasEl) receitasRecebidasEl.textContent = formatCurrency(receitasRecebidas);
                if (despesasPagasEl) despesasPagasEl.textContent = formatCurrency(despesasPagas);
                if (vencimentosHojeEl) vencimentosHojeEl.textContent = vencimentosHoje;
            } catch (error) {
                console.error('Erro ao atualizar dashboard financeiro:', error);
            }
        }

        // ========== COBRANÇAS ==========
        
        // Abrir modal de cobrança (novo)
        async function openCobrancaModal() {
            document.getElementById('cobrancaModalTitle').textContent = 'Nova Cobrança';
            document.getElementById('cobrancaForm').reset();
            document.getElementById('cobrancaId').value = '';
            
            // Limpar QR Code
            removerQRCode();
            
            // Preencher data de vencimento com hoje + 30 dias
            const hoje = new Date();
            hoje.setDate(hoje.getDate() + 30);
            document.getElementById('cobrancaDataVencimento').value = hoje.toISOString().split('T')[0];
            
            // Preencher data de início com hoje
            document.getElementById('cobrancaDataInicio').value = hoje.toISOString().split('T')[0];
            document.getElementById('cobrancaDataInicioManutencao').value = hoje.toISOString().split('T')[0];
            
            // Resetar campos de parcelado/recorrente
            atualizarCamposCobranca();
            
            // Carregar clientes
            await loadClientesForCobrancaSelect();
            
            const modal = document.getElementById('cobrancaModal');
            openModal(modal);
        }

        // Atualizar campos baseado no tipo de cobrança
        function atualizarCamposCobranca() {
            const tipo = document.getElementById('cobrancaTipo').value;
            
            // Esconder todos os campos específicos
            document.getElementById('cobrancaCamposParcelado').style.display = 'none';
            document.getElementById('cobrancaCamposRecorrente').style.display = 'none';
            document.getElementById('cobrancaCamposManutencao').style.display = 'none';
            
            // Mostrar campos específicos baseado no tipo
            if (tipo === 'parcelado') {
                document.getElementById('cobrancaCamposParcelado').style.display = 'block';
                calcularValorParcela();
            } else if (tipo === 'recorrente') {
                document.getElementById('cobrancaCamposRecorrente').style.display = 'block';
            } else if (tipo === 'manutencao') {
                document.getElementById('cobrancaCamposManutencao').style.display = 'block';
            }
        }

        // Calcular valor da parcela
        function calcularValorParcela() {
            const valorTotal = parseFloat(document.getElementById('cobrancaValor').value) || 0;
            const numeroParcelas = parseInt(document.getElementById('cobrancaNumeroParcelas').value) || 1;
            
            if (valorTotal > 0 && numeroParcelas > 0) {
                const valorParcela = valorTotal / numeroParcelas;
                document.getElementById('cobrancaValorParcela').value = valorParcela.toFixed(2);
            } else {
                document.getElementById('cobrancaValorParcela').value = '';
            }
        }

        // Adicionar listeners para calcular parcela
        document.addEventListener('DOMContentLoaded', function() {
            const valorInput = document.getElementById('cobrancaValor');
            const parcelasInput = document.getElementById('cobrancaNumeroParcelas');
            
            if (valorInput) {
                valorInput.addEventListener('input', function() {
                    if (document.getElementById('cobrancaTipo').value === 'parcelado') {
                        calcularValorParcela();
                    }
                });
            }
            
            if (parcelasInput) {
                parcelasInput.addEventListener('input', function() {
                    if (document.getElementById('cobrancaTipo').value === 'parcelado') {
                        calcularValorParcela();
                    }
                });
            }
        });

        // Fechar modal de cobrança
        function closeCobrancaModal() {
            const modal = document.getElementById('cobrancaModal');
            closeModal(modal);
        }

        // Carregar clientes para select de cobrança
        async function loadClientesForCobrancaSelect() {
            try {
                const { data, error } = await supabase
                    .from('clientes')
                    .select('id, nome, empresa')
                    .eq('status', 'ativo')
                    .order('nome', { ascending: true });
                
                if (error) throw error;
                
                const select = document.getElementById('cobrancaClienteId');
                if (!select) return;
                
                select.innerHTML = '<option value="">Selecione um cliente</option>';
                
                (data || []).forEach(cliente => {
                    const option = document.createElement('option');
                    option.value = cliente.id;
                    option.textContent = cliente.empresa ? `${cliente.nome} - ${cliente.empresa}` : cliente.nome;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar clientes:', error);
            }
        }

        // Carregar orçamentos para cobrança
        async function loadOrcamentosParaCobranca() {
            const clienteId = document.getElementById('cobrancaClienteId').value;
            if (!clienteId) {
                document.getElementById('cobrancaOrcamentoId').innerHTML = '<option value="">Nenhum</option>';
                return;
            }
            
            try {
                const { data, error } = await supabase
                    .from('orcamentos')
                    .select('id, numero, data, valor, status')
                    .eq('cliente_id', clienteId)
                    .in('status', ['aprovado', 'enviado'])
                    .order('numero', { ascending: false });
                
                if (error) throw error;
                
                const select = document.getElementById('cobrancaOrcamentoId');
                if (!select) return;
                
                select.innerHTML = '<option value="">Nenhum</option>';
                
                (data || []).forEach(orcamento => {
                    const option = document.createElement('option');
                    option.value = orcamento.id;
                    option.textContent = `Orçamento ${String(orcamento.numero || 'N/A').padStart(4, '0')} - ${formatCurrency(orcamento.valor || 0)}`;
                    option.dataset.valor = orcamento.valor || 0;
                    select.appendChild(option);
                });
            } catch (error) {
                console.error('Erro ao carregar orçamentos:', error);
            }
        }

        // Preencher dados da cobrança baseado no orçamento
        async function preencherDadosCobranca() {
            const orcamentoId = document.getElementById('cobrancaOrcamentoId').value;
            if (!orcamentoId) return;
            
            try {
                const { data, error } = await supabase
                    .from('orcamentos')
                    .select('*, cliente:clientes(*)')
                    .eq('id', orcamentoId)
                    .single();
                
                if (error) throw error;
                
                if (data) {
                    // Preencher descrição
                    const descricao = `Pagamento - Orçamento ${String(data.numero || 'N/A').padStart(4, '0')}`;
                    document.getElementById('cobrancaDescricao').value = descricao;
                    
                    // Preencher valor
                    document.getElementById('cobrancaValor').value = data.valor || '';
                    
                    // Preencher forma de pagamento se existir
                    if (data.forma_pagamento) {
                        const formas = data.forma_pagamento.split(',').map(f => f.trim());
                        if (formas.length > 0) {
                            document.getElementById('cobrancaFormaPagamento').value = formas[0];
                        }
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar orçamento:', error);
            }
        }

        // Preview QR Code
        function previewQRCode() {
            const fileInput = document.getElementById('cobrancaQRCodeFile');
            const preview = document.getElementById('cobrancaQRCodePreview');
            const image = document.getElementById('cobrancaQRCodeImage');
            const status = document.getElementById('cobrancaQRCodeStatus');
            
            if (fileInput.files && fileInput.files[0]) {
                const file = fileInput.files[0];
                
                // Verificar se é uma imagem
                if (!file.type.startsWith('image/')) {
                    alert('Por favor, selecione um arquivo de imagem.');
                    return;
                }
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    const base64 = e.target.result;
                    image.src = base64;
                    document.getElementById('cobrancaQRCodeBase64').value = base64;
                    preview.style.display = 'block';
                    status.textContent = 'QR Code carregado com sucesso!';
                    status.style.color = 'var(--success)';
                };
                reader.readAsDataURL(file);
            }
        }

        // Remover QR Code
        function removerQRCode() {
            document.getElementById('cobrancaQRCodeFile').value = '';
            document.getElementById('cobrancaQRCodeBase64').value = '';
            document.getElementById('cobrancaQRCodePreview').style.display = 'none';
            document.getElementById('cobrancaQRCodeImage').src = '';
            document.getElementById('cobrancaQRCodeStatus').textContent = '';
            document.getElementById('cobrancaChavePIX').value = '';
            document.getElementById('cobrancaGatewayStatus').textContent = '';
            document.getElementById('cobrancaGatewayPagamento').value = '';
            document.getElementById('cobrancaApiKey').value = '';
            document.getElementById('cobrancaApiSecret').value = '';
            document.getElementById('camposGateway').style.display = 'none';
        }

        // Atualizar campos do gateway de pagamento
        function atualizarCamposGateway() {
            const gateway = document.getElementById('cobrancaGatewayPagamento').value;
            const camposDiv = document.getElementById('camposGateway');
            
            if (gateway) {
                camposDiv.style.display = 'block';
                // Limpar campos anteriores
                document.getElementById('cobrancaApiKey').value = '';
                document.getElementById('cobrancaApiSecret').value = '';
            } else {
                camposDiv.style.display = 'none';
            }
        }

        // Gerar QR Code via Gateway de Pagamento
        async function gerarQRCodeViaGateway() {
            const gateway = document.getElementById('cobrancaGatewayPagamento').value;
            const apiKey = document.getElementById('cobrancaApiKey').value.trim();
            const apiSecret = document.getElementById('cobrancaApiSecret').value.trim();
            const valor = document.getElementById('cobrancaValor').value;
            const clienteId = document.getElementById('cobrancaClienteId').value;
            const descricao = document.getElementById('cobrancaDescricao').value || 'Cobrança';
            
            if (!gateway) {
                alert('Por favor, selecione um gateway de pagamento.');
                return;
            }
            
            if (!apiKey) {
                alert('Por favor, informe a API Key do gateway.');
                return;
            }
            
            if (!valor || parseFloat(valor) <= 0) {
                alert('Por favor, informe o valor da cobrança.');
                return;
            }
            
            const statusEl = document.getElementById('cobrancaGatewayStatus');
            statusEl.textContent = 'Gerando QR Code via gateway...';
            statusEl.style.color = 'var(--warning)';
            
            try {
                // Buscar dados do cliente
                let nomeCliente = 'Cliente';
                if (clienteId) {
                    const { data: cliente, error } = await supabase
                        .from('clientes')
                        .select('nome, empresa')
                        .eq('id', clienteId)
                        .single();
                    
                    if (!error && cliente) {
                        nomeCliente = cliente.empresa || cliente.nome || 'Cliente';
                    }
                }
                
                // IMPORTANTE: Para usar gateways de pagamento, você precisa:
                // 1. Criar uma conta no gateway escolhido
                // 2. Obter as credenciais da API (API Key, API Secret, etc.)
                // 3. Implementar a chamada à API do gateway (requer backend/server)
                // 4. O gateway retornará o QR Code PIX válido
                
                // Exemplo de estrutura para integração (requer backend):
                /*
                const response = await fetch('/api/gerar-qrcode-pix', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        gateway: gateway,
                        apiKey: apiKey,
                        apiSecret: apiSecret,
                        valor: parseFloat(valor),
                        descricao: descricao,
                        cliente: nomeCliente
                    })
                });
                
                const data = await response.json();
                if (data.qrCode) {
                    // Usar o QR Code retornado
                    document.getElementById('cobrancaQRCodeBase64').value = data.qrCode;
                    document.getElementById('cobrancaQRCodeImage').src = data.qrCode;
                    document.getElementById('cobrancaQRCodePreview').style.display = 'block';
                    statusEl.textContent = 'QR Code gerado com sucesso via ' + gateway + '!';
                    statusEl.style.color = 'var(--success)';
                }
                */
                
                // Por enquanto, mostrar instruções
                alert(`Para usar ${gateway}, você precisa:\n\n1. Criar uma conta no ${gateway}\n2. Obter suas credenciais de API\n3. Implementar um backend que faça a chamada à API do gateway\n4. O backend retornará o QR Code PIX válido\n\nPor enquanto, use a Opção 1 (Upload) ou Opção 3 (Chave PIX) para testes.`);
                
                statusEl.textContent = 'Integração com gateway requer backend. Use Upload ou Chave PIX para testes.';
                statusEl.style.color = 'var(--text-gray)';
                
            } catch (error) {
                console.error('Erro ao gerar QR Code via gateway:', error);
                statusEl.textContent = 'Erro ao gerar QR Code. Verifique suas credenciais.';
                statusEl.style.color = 'var(--danger)';
            }
        }

        // Gerar QR Code PIX (formato EMV válido)
        async function gerarQRCodePIX() {
            const chavePIX = document.getElementById('cobrancaChavePIX').value.trim();
            const valor = document.getElementById('cobrancaValor').value;
            const clienteId = document.getElementById('cobrancaClienteId').value;
            const descricao = document.getElementById('cobrancaDescricao').value || 'Cobrança';
            
            if (!chavePIX) {
                alert('Por favor, informe a Chave PIX para gerar o QR Code.');
                return;
            }
            
            if (!valor || parseFloat(valor) <= 0) {
                alert('Por favor, informe o valor da cobrança para gerar o QR Code PIX.');
                return;
            }
            
            try {
                // Buscar dados do cliente para o nome
                let nomeCliente = 'AUTOVIZION';
                if (clienteId) {
                    const { data: cliente, error } = await supabase
                        .from('clientes')
                        .select('nome, empresa')
                        .eq('id', clienteId)
                        .single();
                    
                    if (!error && cliente) {
                        nomeCliente = cliente.empresa || cliente.nome || 'AUTOVIZION';
                    }
                }
                
                // IMPORTANTE: Para gerar QR Code PIX válido, você precisa:
                // 1. Usar API do seu banco (Itaú, Banco do Brasil, etc.) que gera QR Code PIX dinâmico
                // 2. OU fazer upload do QR Code gerado pelo banco
                // 3. OU usar serviço de terceiros que gera QR Code PIX válido
                
                // Gerar código EMV PIX (formato simplificado - pode não funcionar em todos os apps)
                // O formato EMV PIX completo requer validação e certificação do Banco Central
                const valorFormatado = parseFloat(valor).toFixed(2);
                const nomeFormatado = nomeCliente.substring(0, 25).toUpperCase();
                const descricaoFormatada = descricao.substring(0, 25).toUpperCase();
                
                // Formato EMV PIX básico (não totalmente válido sem certificação)
                // Para QR Code PIX válido, use a API do seu banco ou faça upload
                const emvPix = gerarCodigoEMVPIX(chavePIX, valorFormatado, nomeFormatado, descricaoFormatada);
                
                // Gerar QR Code com o código EMV
                let qrCodeBase64 = '';
                
                if (typeof QRCode !== 'undefined') {
                    // Usar biblioteca QRCode.js
                    const canvas = document.createElement('canvas');
                    await QRCode.toCanvas(canvas, emvPix, {
                        width: 200, // Tamanho menor (200x200 pixels)
                        margin: 2,
                        color: {
                            dark: '#000000',
                            light: '#FFFFFF'
                        },
                        errorCorrectionLevel: 'M'
                    });
                    
                    qrCodeBase64 = canvas.toDataURL('image/png');
                } else {
                    // Fallback: usar API pública
                    const qrCodeUrl = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(emvPix)}&format=png&ecc=M`;
                    const response = await fetch(qrCodeUrl);
                    if (response.ok) {
                        const blob = await response.blob();
                        qrCodeBase64 = await new Promise((resolve, reject) => {
                            const reader = new FileReader();
                            reader.onload = () => resolve(reader.result);
                            reader.onerror = reject;
                            reader.readAsDataURL(blob);
                        });
                    } else {
                        throw new Error('Erro ao gerar QR Code');
                    }
                }
                
                // Atualizar UI
                document.getElementById('cobrancaQRCodeImage').src = qrCodeBase64;
                document.getElementById('cobrancaQRCodeBase64').value = qrCodeBase64;
                document.getElementById('cobrancaQRCodePreview').style.display = 'block';
                document.getElementById('cobrancaQRCodeStatus').innerHTML = '⚠️ QR Code gerado (formato de teste). <strong>Importante:</strong> Este QR Code pode não funcionar em todos os apps. Para QR Code PIX válido, use Upload do banco ou integração com gateway de pagamento.';
                document.getElementById('cobrancaQRCodeStatus').style.color = 'var(--warning)';
                
            } catch (error) {
                console.error('Erro ao gerar QR Code PIX:', error);
                alert('Erro ao gerar QR Code PIX. Por favor, faça upload de uma imagem do QR Code gerado pelo seu banco.');
            }
        }

        // Gerar código EMV PIX (formato simplificado - pode não ser totalmente válido)
        function gerarCodigoEMVPIX(chave, valor, nome, descricao) {
            // Formato EMV PIX básico
            // ATENÇÃO: Este é um formato simplificado. Para QR Code PIX válido e certificado,
            // você DEVE usar a API do seu banco ou serviço certificado pelo Banco Central.
            
            const payload = [];
            
            // Payload Format Indicator (00)
            payload.push('000201');
            
            // Merchant Account Information (26) - PIX
            let pixData = '0014br.gov.bcb.pix';
            pixData += String(chave.length).padStart(2, '0') + chave;
            payload.push('26' + String(pixData.length).padStart(2, '0') + pixData);
            
            // Merchant Category Code (52) - 0000 = não especificado
            payload.push('52040000');
            
            // Transaction Currency (53) - 986 = BRL
            payload.push('5303986');
            
            // Transaction Amount (54) - valor
            payload.push('54' + String(valor.length).padStart(2, '0') + valor);
            
            // Country Code (58) - BR
            payload.push('5802BR');
            
            // Merchant Name (59) - nome do recebedor
            payload.push('59' + String(nome.length).padStart(2, '0') + nome);
            
            // Merchant City (60) - cidade
            payload.push('60' + String('SAO PAULO'.length).padStart(2, '0') + 'SAO PAULO');
            
            // Additional Data Field Template (62) - descrição
            if (descricao) {
                const descricaoData = '05' + String(descricao.length).padStart(2, '0') + descricao;
                payload.push('62' + String(descricaoData.length).padStart(2, '0') + descricaoData);
            }
            
            // CRC16 (63) - checksum
            const payloadString = payload.join('');
            const crc = calcularCRC16(payloadString + '6304');
            payload.push('6304' + crc);
            
            return payload.join('');
        }

        // Calcular CRC16 para PIX
        function calcularCRC16(data) {
            const polynomial = 0x1021;
            let crc = 0xFFFF;
            
            for (let i = 0; i < data.length; i++) {
                crc ^= (data.charCodeAt(i) << 8);
                for (let j = 0; j < 8; j++) {
                    if (crc & 0x8000) {
                        crc = (crc << 1) ^ polynomial;
                    } else {
                        crc <<= 1;
                    }
                }
            }
            
            crc &= 0xFFFF;
            return crc.toString(16).toUpperCase().padStart(4, '0');
        }

        // Enviar cobrança por WhatsApp
        async function enviarCobrancaWhatsApp() {
            try {
                const clienteId = document.getElementById('cobrancaClienteId').value;
                const descricao = document.getElementById('cobrancaDescricao').value;
                const valor = document.getElementById('cobrancaValor').value;
                const dataVencimento = document.getElementById('cobrancaDataVencimento').value;
                const formaPagamento = document.getElementById('cobrancaFormaPagamento').value;
                const instrucoes = document.getElementById('cobrancaInstrucoes').value;
                
                if (!clienteId || !descricao || !valor || !dataVencimento) {
                    alert('Preencha todos os campos obrigatórios antes de enviar por WhatsApp.');
                    return;
                }
                
                // Buscar dados do cliente
                const { data: cliente, error: clienteError } = await supabase
                    .from('clientes')
                    .select('*')
                    .eq('id', clienteId)
                    .single();
                
                if (clienteError) throw clienteError;
                
                if (!cliente.telefone && !cliente.whatsapp) {
                    alert('Cliente não possui telefone cadastrado para envio por WhatsApp.');
                    return;
                }
                
                const telefone = cliente.whatsapp || cliente.telefone;
                // Remover caracteres não numéricos
                const telefoneLimpo = telefone.replace(/\D/g, '');
                
                // Formatar mensagem
                const formatDate = (dateStr) => {
                    if (!dateStr) return '-';
                    try {
                        const date = new Date(dateStr);
                        return date.toLocaleDateString('pt-BR');
                    } catch {
                        return dateStr;
                    }
                };
                
                const formatCurrency = (value) => {
                    if (!value && value !== 0) return 'R$ 0,00';
                    return new Intl.NumberFormat('pt-BR', {
                        style: 'currency',
                        currency: 'BRL'
                    }).format(value);
                };
                
                let mensagem = `Olá ${cliente.nome || cliente.empresa || 'Cliente'}!\n\n`;
                mensagem += `📋 *COBRANÇA*\n\n`;
                mensagem += `📝 Descrição: ${descricao}\n`;
                mensagem += `💰 Valor: ${formatCurrency(parseFloat(valor))}\n`;
                mensagem += `📅 Vencimento: ${formatDate(dataVencimento)}\n`;
                mensagem += `💳 Forma de Pagamento: ${formaPagamento || 'Não especificada'}\n\n`;
                
                if (instrucoes) {
                    mensagem += `📌 Instruções de Pagamento:\n${instrucoes}\n\n`;
                }
                
                mensagem += `Agradecemos a atenção!\n\n`;
                mensagem += `*AUTOVIZION*`;
                
                // Gerar PDF primeiro (opcional - para anexar)
                // Por enquanto, apenas enviar mensagem
                
                // Abrir WhatsApp
                const url = `https://wa.me/55${telefoneLimpo}?text=${encodeURIComponent(mensagem)}`;
                window.open(url, '_blank');
                
                alert('WhatsApp aberto! Você pode enviar a mensagem e anexar o PDF da cobrança se necessário.');
            } catch (error) {
                console.error('Erro ao enviar cobrança por WhatsApp:', error);
                alert('Erro ao enviar cobrança por WhatsApp: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // Gerar PDF de cobrança
        async function gerarPDFCobranca() {
            try {
                // Verificar se jsPDF está disponível
                if (!window.jspdf) {
                    alert('Biblioteca de PDF não carregada. Por favor, recarregue a página.');
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Obter dados do formulário
                const clienteId = document.getElementById('cobrancaClienteId').value;
                const descricao = document.getElementById('cobrancaDescricao').value;
                const valor = parseFloat(document.getElementById('cobrancaValor').value) || 0;
                const dataVencimento = document.getElementById('cobrancaDataVencimento').value;
                const formaPagamento = document.getElementById('cobrancaFormaPagamento').value;
                const instrucoes = document.getElementById('cobrancaInstrucoes').value;
                const observacoes = document.getElementById('cobrancaObservacoes').value;
                
                if (!clienteId || !descricao || !valor || !dataVencimento) {
                    alert('Preencha todos os campos obrigatórios antes de gerar o PDF.');
                    return;
                }
                
                // Buscar dados do cliente
                const { data: cliente, error: clienteError } = await supabase
                    .from('clientes')
                    .select('*')
                    .eq('id', clienteId)
                    .single();
                
                if (clienteError) throw clienteError;
                
                // Função auxiliar para formatar moeda
                const formatCurrencyPDF = (value) => {
                    if (!value && value !== 0) return 'R$ 0,00';
                    return new Intl.NumberFormat('pt-BR', {
                        style: 'currency',
                        currency: 'BRL'
                    }).format(value);
                };
                
                // Função auxiliar para formatar data
                const formatDatePDF = (dateStr) => {
                    if (!dateStr) return '-';
                    try {
                        const date = new Date(dateStr);
                        return date.toLocaleDateString('pt-BR');
                    } catch {
                        return dateStr;
                    }
                };
                
                // Configurações
                const margin = 20;
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                let y = margin;
                
                // ========== CABEÇALHO - DADOS DA EMPRESA ==========
                let logoLoaded = false;
                
                try {
                    const logoUrl = 'https://zhzhpctsndrcedukivhk.supabase.co/storage/v1/object/public/logo/LOGO%203D%20SEM%20FUNDO%20(1).png';
                    const response = await fetch(logoUrl);
                    if (response.ok) {
                        const blob = await response.blob();
                        const reader = new FileReader();
                        
                        await new Promise((resolve, reject) => {
                            reader.onload = () => resolve(reader.result);
                            reader.onerror = reject;
                            reader.readAsDataURL(blob);
                        });
                        
                        const logoData = reader.result;
                        doc.addImage(logoData, 'PNG', margin, 5, 60, 25);
                        logoLoaded = true;
                    }
                } catch (e) {
                    console.warn('Erro ao carregar logo:', e);
                }
                
                if (!logoLoaded) {
                    doc.setFillColor(255, 102, 0);
                    doc.rect(0, 0, pageWidth, 50, 'F');
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(28);
                    doc.setFont(undefined, 'bold');
                    doc.text('AUTOVIZION', margin, 30);
                    
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'normal');
                    doc.text('Soluções em Marketing Digital e Tecnologia', margin, 38);
                }
                
                // Dados da empresa no cabeçalho
                const dadosX = pageWidth - margin - 60;
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('AUTOVIZION', dadosX, 12);
                
                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(60, 60, 60);
                doc.text('www.autovizon.com.br', dadosX, 20);
                doc.text('autovizioncomercial@gmail.com', dadosX, 26);
                doc.text('(14) 99683-3385', dadosX, 32);
                
                // Linha divisória
                doc.setDrawColor(200, 200, 200);
                doc.line(margin, 35, pageWidth - margin, 35);
                
                y = 45;
                
                // ========== TÍTULO DO DOCUMENTO ==========
                doc.setFillColor(255, 102, 0);
                const headerRectY = y - 5;
                const headerRectHeight = 20;
                doc.rect(margin, headerRectY, pageWidth - (margin * 2), headerRectHeight, 'F');
                
                // Título "COBRANÇA" à esquerda
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(22);
                doc.setFont(undefined, 'bold');
                doc.text('COBRANÇA', margin + 5, y + 8);
                
                // Datas alinhadas à direita (dentro do cabeçalho laranja)
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                const dataHoje = formatDatePDF(new Date().toISOString());
                const dataVenc = formatDatePDF(dataVencimento);
                const dataTexto = `Data: ${dataHoje}`;
                const vencimentoTexto = `Vencimento: ${dataVenc}`;
                
                // Calcular largura dos textos (após configurar fonte)
                const dataWidth = doc.getTextWidth(dataTexto);
                const vencimentoWidth = doc.getTextWidth(vencimentoTexto);
                const maxWidth = Math.max(dataWidth, vencimentoWidth);
                
                // Posição X: alinhado à direita com margem
                const rightPadding = 10;
                const dataX = pageWidth - margin - maxWidth - rightPadding;
                
                // Posição Y: centralizar verticalmente no cabeçalho
                // Cabeçalho: altura 20, começa em headerRectY (y - 5)
                // Centro vertical: headerRectY + (headerRectHeight / 2) = (y - 5) + 10 = y + 5
                const headerCenterY = headerRectY + (headerRectHeight / 2);
                const lineHeight = 5;
                
                // Primeira linha (Data) - um pouco acima do centro
                doc.text(dataTexto, dataX, headerCenterY - (lineHeight / 2) - 0.5);
                // Segunda linha (Vencimento) - um pouco abaixo do centro
                doc.text(vencimentoTexto, dataX, headerCenterY + (lineHeight / 2) + 0.5);
                
                y += 25;
                
                // ========== DADOS DO CLIENTE ==========
                doc.setFillColor(255, 102, 0);
                doc.rect(margin, y, pageWidth - (margin * 2), 8, 'F');
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('DADOS DO CLIENTE', margin + 3, y + 6);
                y += 12;
                
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'normal');
                doc.text(`Cliente: ${cliente.nome || cliente.empresa || 'Cliente não encontrado'}`, margin, y);
                y += 6;
                if (cliente.empresa && cliente.empresa !== cliente.nome) {
                    doc.text(`Empresa: ${cliente.empresa}`, margin, y);
                    y += 6;
                }
                if (cliente.cpf_cnpj) {
                    doc.text(`CPF/CNPJ: ${cliente.cpf_cnpj}`, margin, y);
                    y += 6;
                }
                if (cliente.endereco) {
                    let enderecoCompleto = cliente.endereco;
                    if (cliente.cidade) enderecoCompleto += `, ${cliente.cidade}`;
                    if (cliente.estado) enderecoCompleto += ` - ${cliente.estado}`;
                    doc.text(`Endereço: ${enderecoCompleto}`, margin, y);
                    y += 6;
                }
                if (cliente.telefone) {
                    doc.text(`Telefone: ${cliente.telefone}`, margin, y);
                    y += 6;
                }
                if (cliente.email) {
                    doc.text(`E-mail: ${cliente.email}`, margin, y);
                    y += 6;
                }
                
                y += 10;
                
                // ========== DADOS DA COBRANÇA ==========
                doc.setFillColor(255, 102, 0);
                doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('DADOS DA COBRANÇA', margin + 3, y + 4);
                y += 12;
                
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                
                doc.text(`Descrição: ${descricao}`, margin, y);
                y += 8;
                
                doc.setFont(undefined, 'bold');
                doc.setFontSize(14);
                doc.text(`Valor: ${formatCurrencyPDF(valor)}`, margin, y);
                y += 10;
                
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                doc.text(`Forma de Pagamento: ${formaPagamento || 'Não especificada'}`, margin, y);
                y += 8;
                doc.text(`Data de Vencimento: ${formatDatePDF(dataVencimento)}`, margin, y);
                y += 10;
                
                // ========== INSTRUÇÕES DE PAGAMENTO ==========
                if (instrucoes || document.getElementById('cobrancaQRCodeBase64').value) {
                    doc.setFillColor(255, 102, 0);
                    doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                    
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(255, 255, 255);
                    doc.text('INSTRUÇÕES DE PAGAMENTO', margin + 3, y + 4);
                    y += 12;
                    
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(9);
                    doc.setTextColor(0, 0, 0);
                    
                    if (instrucoes) {
                        const instrucoesLines = doc.splitTextToSize(instrucoes, pageWidth - (margin * 2));
                        doc.text(instrucoesLines, margin, y);
                        y += instrucoesLines.length * 5 + 5;
                    }
                    
                    // Adicionar QR Code se existir
                    const qrCodeBase64 = document.getElementById('cobrancaQRCodeBase64')?.value;
                    if (qrCodeBase64) {
                        try {
                            // Verificar se há espaço na página
                            if (y > pageHeight - 80) {
                                doc.addPage();
                                y = margin + 10;
                            }
                            
                            // Adicionar título do QR Code
                            doc.setFontSize(11);
                            doc.setFont(undefined, 'bold');
                            doc.setTextColor(0, 0, 0);
                            
                            // Centralizar título
                            const tituloTexto = 'QR Code PIX:';
                            const tituloWidth = doc.getTextWidth(tituloTexto);
                            const tituloX = (pageWidth - tituloWidth) / 2;
                            doc.text(tituloTexto, tituloX, y);
                            y += 10;
                            
                            // Adicionar QR Code centralizado (30x30mm - tamanho médio)
                            // Converter mm para pontos (1mm = 2.83465 pontos)
                            const qrSizeMM = 30; // 30mm (aproximadamente 85 pontos)
                            const qrSizePoints = qrSizeMM * 2.83465;
                            
                            // Centralizar QR Code horizontalmente
                            const qrX = (pageWidth - qrSizePoints) / 2;
                            
                            // Adicionar QR Code centralizado
                            try {
                                doc.addImage(qrCodeBase64, 'PNG', qrX, y, qrSizePoints, qrSizePoints);
                                y += qrSizePoints + 10;
                                
                                // Adicionar texto abaixo do QR Code (opcional)
                                doc.setFontSize(8);
                                doc.setFont(undefined, 'normal');
                                doc.setTextColor(100, 100, 100);
                                const textoAjuda = 'Escaneie o QR Code com o app do seu banco';
                                const textoWidth = doc.getTextWidth(textoAjuda);
                                const textoX = (pageWidth - textoWidth) / 2;
                                doc.text(textoAjuda, textoX, y);
                                y += 8;
                            } catch (e) {
                                console.error('Erro ao adicionar imagem QR Code:', e);
                                // Se falhar, apenas adicionar texto
                                doc.setFontSize(9);
                                doc.setFont(undefined, 'normal');
                                const erroTexto = 'QR Code PIX disponível (erro ao renderizar imagem)';
                                const erroWidth = doc.getTextWidth(erroTexto);
                                const erroX = (pageWidth - erroWidth) / 2;
                                doc.text(erroTexto, erroX, y);
                                y += 8;
                            }
                        } catch (e) {
                            console.error('Erro ao adicionar QR Code ao PDF:', e);
                            // Continuar mesmo se houver erro
                        }
                    }
                }
                
                // ========== OBSERVAÇÕES ==========
                if (observacoes) {
                    if (y > pageHeight - 40) {
                        doc.addPage();
                        y = margin + 10;
                    }
                    
                    doc.setFillColor(255, 102, 0);
                    doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                    
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(255, 255, 255);
                    doc.text('OBSERVAÇÕES', margin + 3, y + 4);
                    y += 12;
                    
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(9);
                    doc.setTextColor(60, 60, 60);
                    const observacoesLines = doc.splitTextToSize(observacoes, pageWidth - (margin * 2));
                    doc.text(observacoesLines, margin, y);
                    y += observacoesLines.length * 4 + 5;
                }
                
                // ========== RODAPÉ ==========
                const contatoY = pageHeight - 8;
                doc.setFontSize(7);
                doc.setTextColor(128, 128, 128);
                doc.setFont(undefined, 'normal');
                doc.text('AUTOVIZION', margin, contatoY);
                doc.text('|', margin + 25, contatoY);
                doc.text('www.autovizon.com.br', margin + 30, contatoY);
                doc.text('|', margin + 70, contatoY);
                doc.text('autovizioncomercial@gmail.com', margin + 75, contatoY);
                doc.text('|', margin + 130, contatoY);
                doc.text('(14) 99683-3385', margin + 135, contatoY);
                
                // Salvar PDF
                const clienteNome = cliente.nome || cliente.empresa || 'Cliente';
                const dataFormatada = formatDatePDF(dataVencimento).replace(/\//g, '_');
                const fileName = `Cobranca_${clienteNome.replace(/[^a-zA-Z0-9]/g, '_')}_${dataFormatada}.pdf`;
                doc.save(fileName);
                
                // Mostrar mensagem de sucesso
                alert('PDF de cobrança gerado com sucesso!');
            } catch (error) {
                console.error('Erro ao gerar PDF de cobrança:', error);
                alert('Erro ao gerar PDF de cobrança: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // Gerar Comprovante de Pagamento
        async function gerarComprovantePagamento(receitaId) {
            try {
                // Verificar se jsPDF está disponível
                if (!window.jspdf) {
                    alert('Biblioteca de PDF não carregada. Por favor, recarregue a página.');
                    return;
                }

                // Buscar dados da receita
                const { data: receita, error: receitaError } = await supabase
                    .from('receitas')
                    .select('*, cliente:clientes(*), projeto:projetos(*), orcamento:orcamentos(*)')
                    .eq('id', receitaId)
                    .single();

                if (receitaError) throw receitaError;

                if (!receita) {
                    alert('Receita não encontrada.');
                    return;
                }

                // Verificar se está recebida
                if (receita.status !== 'recebido') {
                    alert('Apenas receitas recebidas podem ter comprovante de pagamento gerado.');
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                const cliente = receita.cliente || {};
                const projeto = receita.projeto || {};
                const orcamento = receita.orcamento || {};

                // Função auxiliar para formatar moeda
                const formatCurrencyPDF = (value) => {
                    if (!value && value !== 0) return 'R$ 0,00';
                    return new Intl.NumberFormat('pt-BR', {
                        style: 'currency',
                        currency: 'BRL'
                    }).format(value);
                };

                // Função auxiliar para formatar data
                const formatDatePDF = (dateStr) => {
                    if (!dateStr) return '-';
                    try {
                        const date = new Date(dateStr);
                        return date.toLocaleDateString('pt-BR');
                    } catch {
                        return dateStr;
                    }
                };

                // Configurações
                const margin = 20;
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                let y = margin;

                // ========== CABEÇALHO - DADOS DA EMPRESA ==========
                let logoLoaded = false;

                try {
                    const logoUrl = 'https://zhzhpctsndrcedukivhk.supabase.co/storage/v1/object/public/logo/LOGO%203D%20SEM%20FUNDO%20(1).png';
                    const response = await fetch(logoUrl);
                    if (response.ok) {
                        const blob = await response.blob();
                        const reader = new FileReader();
                        
                        await new Promise((resolve, reject) => {
                            reader.onload = () => resolve(reader.result);
                            reader.onerror = reject;
                            reader.readAsDataURL(blob);
                        });
                        
                        const logoData = reader.result;
                        doc.addImage(logoData, 'PNG', margin, 5, 60, 25);
                        logoLoaded = true;
                    }
                } catch (e) {
                    console.warn('Erro ao carregar logo:', e);
                }

                if (!logoLoaded) {
                    doc.setFillColor(255, 102, 0);
                    doc.rect(0, 0, pageWidth, 50, 'F');
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(28);
                    doc.setFont(undefined, 'bold');
                    doc.text('AUTOVIZION', margin, 30);
                    
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'normal');
                    doc.text('Soluções em Marketing Digital e Tecnologia', margin, 38);
                }

                // Dados da empresa no cabeçalho
                const dadosX = pageWidth - margin - 60;
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('AUTOVIZION', dadosX, 12);

                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(60, 60, 60);
                doc.text('www.autovizon.com.br', dadosX, 20);
                doc.text('autovizioncomercial@gmail.com', dadosX, 26);
                doc.text('(14) 99683-3385', dadosX, 32);

                // Linha divisória
                doc.setDrawColor(200, 200, 200);
                doc.line(margin, 35, pageWidth - margin, 35);

                y = 45;

                // ========== TÍTULO DO DOCUMENTO ==========
                doc.setFillColor(16, 185, 129); // Verde para comprovante
                const headerRectY = y - 5;
                const headerRectHeight = 20;
                doc.rect(margin, headerRectY, pageWidth - (margin * 2), headerRectHeight, 'F');

                // Título "COMPROVANTE DE PAGAMENTO" centralizado
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                const tituloTexto = 'COMPROVANTE DE PAGAMENTO';
                const tituloWidth = doc.getTextWidth(tituloTexto);
                const tituloX = (pageWidth - tituloWidth) / 2;
                doc.text(tituloTexto, tituloX, y + 8);

                // Data do comprovante alinhada à direita
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                const dataComprovante = formatDatePDF(new Date().toISOString());
                const dataTexto = `Data do Comprovante: ${dataComprovante}`;
                const dataWidth = doc.getTextWidth(dataTexto);
                const rightPadding = 10;
                const dataX = pageWidth - margin - dataWidth - rightPadding;
                const headerCenterY = headerRectY + (headerRectHeight / 2);
                doc.text(dataTexto, dataX, headerCenterY + 6);

                y += 25;

                // ========== DADOS DO CLIENTE ==========
                doc.setFillColor(255, 102, 0);
                doc.rect(margin, y, pageWidth - (margin * 2), 8, 'F');

                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('DADOS DO CLIENTE', margin + 3, y + 6);
                y += 12;

                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                doc.text(`Cliente: ${cliente.nome || cliente.empresa || 'Cliente não encontrado'}`, margin, y);
                y += 6;
                if (cliente.empresa && cliente.empresa !== cliente.nome) {
                    doc.text(`Empresa: ${cliente.empresa}`, margin, y);
                    y += 6;
                }
                if (cliente.cpf_cnpj) {
                    doc.text(`CPF/CNPJ: ${cliente.cpf_cnpj}`, margin, y);
                    y += 6;
                }
                if (cliente.endereco) {
                    let enderecoCompleto = cliente.endereco;
                    if (cliente.cidade) enderecoCompleto += `, ${cliente.cidade}`;
                    if (cliente.estado) enderecoCompleto += ` - ${cliente.estado}`;
                    doc.text(`Endereço: ${enderecoCompleto}`, margin, y);
                    y += 6;
                }
                if (cliente.telefone) {
                    doc.text(`Telefone: ${cliente.telefone}`, margin, y);
                    y += 6;
                }
                if (cliente.email) {
                    doc.text(`E-mail: ${cliente.email}`, margin, y);
                    y += 6;
                }

                y += 10;

                // ========== DADOS DO PAGAMENTO ==========
                doc.setFillColor(16, 185, 129); // Verde
                doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');

                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('DADOS DO PAGAMENTO', margin + 3, y + 4);
                y += 12;

                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);

                doc.text(`Descrição: ${receita.descricao || '-'}`, margin, y);
                y += 8;

                // Valor destacado
                doc.setFont(undefined, 'bold');
                doc.setFontSize(16);
                doc.setTextColor(16, 185, 129); // Verde para valor
                doc.text(`Valor Recebido: ${formatCurrencyPDF(receita.valor || 0)}`, margin, y);
                y += 12;

                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);

                doc.text(`Forma de Pagamento: ${receita.forma_pagamento || 'Não especificada'}`, margin, y);
                y += 8;

                doc.text(`Data de Vencimento: ${formatDatePDF(receita.data_vencimento)}`, margin, y);
                y += 8;

                if (receita.data_recebimento) {
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(16, 185, 129);
                    doc.text(`Data de Recebimento: ${formatDatePDF(receita.data_recebimento)}`, margin, y);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(0, 0, 0);
                    y += 8;
                }

                // Informações adicionais
                if (projeto.nome) {
                    doc.text(`Projeto: ${projeto.nome}`, margin, y);
                    y += 6;
                }

                if (orcamento.numero) {
                    doc.text(`Orçamento: ${String(orcamento.numero).padStart(4, '0')}`, margin, y);
                    y += 6;
                }

                // Tipo de cobrança
                if (receita.tipo_cobranca === 'parcelado') {
                    doc.text(`Parcela: ${receita.parcela_numero || '?'} de ${receita.parcela_total || '?'}`, margin, y);
                    y += 6;
                } else if (receita.tipo_cobranca === 'recorrente') {
                    doc.text(`Tipo: Cobrança Recorrente`, margin, y);
                    y += 6;
                } else if (receita.tipo_cobranca === 'manutencao') {
                    doc.text(`Tipo: Taxa de Manutenção`, margin, y);
                    y += 6;
                }

                y += 10;

                // ========== OBSERVAÇÕES ==========
                if (receita.observacoes) {
                    doc.setFillColor(255, 102, 0);
                    doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');

                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(255, 255, 255);
                    doc.text('OBSERVAÇÕES', margin + 3, y + 4);
                    y += 12;

                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(9);
                    doc.setTextColor(0, 0, 0);
                    const obsLines = doc.splitTextToSize(receita.observacoes, pageWidth - (margin * 2));
                    doc.text(obsLines, margin, y);
                    y += obsLines.length * 5 + 5;
                }

                // ========== RODAPÉ ==========
                y = pageHeight - 40;
                doc.setDrawColor(200, 200, 200);
                doc.line(margin, y, pageWidth - margin, y);
                y += 5;

                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(100, 100, 100);
                doc.text('Este documento comprova o recebimento do pagamento descrito acima.', margin, y);
                y += 5;
                doc.text('Documento gerado automaticamente pelo Sistema de Gestão AUTOVIZION.', margin, y);

                // Rodapé com dados de contato
                const contatoY = pageHeight - 8;
                doc.setFontSize(7);
                doc.setTextColor(128, 128, 128);
                doc.text('AUTOVIZION', margin, contatoY);
                doc.text('|', margin + 25, contatoY);
                doc.text('www.autovizon.com.br', margin + 30, contatoY);
                doc.text('|', margin + 70, contatoY);
                doc.text('autovizioncomercial@gmail.com', margin + 75, contatoY);
                doc.text('|', margin + 130, contatoY);
                doc.text('(14) 99683-3385', margin + 135, contatoY);

                // Gerar e baixar PDF
                const clienteNome = cliente.nome || cliente.empresa || 'Cliente';
                const fileName = `Comprovante_Pagamento_${clienteNome.replace(/[^a-zA-Z0-9]/g, '_')}_${receitaId.substring(0, 8)}_${new Date().toISOString().split('T')[0].replace(/-/g, '')}.pdf`;
                doc.save(fileName);

                alert('Comprovante de pagamento gerado com sucesso!');
            } catch (error) {
                console.error('Erro ao gerar comprovante de pagamento:', error);
                alert('Erro ao gerar comprovante de pagamento: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // Salvar cobrança (criar receita(s))
        document.getElementById('cobrancaForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const clienteId = document.getElementById('cobrancaClienteId').value;
            const orcamentoId = document.getElementById('cobrancaOrcamentoId').value || null;
            const descricao = document.getElementById('cobrancaDescricao').value.trim();
            const valor = parseFloat(document.getElementById('cobrancaValor').value) || 0;
            const dataVencimento = document.getElementById('cobrancaDataVencimento').value;
            const formaPagamento = document.getElementById('cobrancaFormaPagamento').value || null;
            const tipo = document.getElementById('cobrancaTipo').value || 'unica';
            const instrucoes = document.getElementById('cobrancaInstrucoes').value.trim() || null;
            const observacoes = document.getElementById('cobrancaObservacoes').value.trim() || null;
            
            try {
                const receitasParaCriar = [];
                
                if (tipo === 'unica') {
                    // Cobrança única - criar apenas uma receita
                    receitasParaCriar.push({
                        cliente_id: clienteId,
                        orcamento_id: orcamentoId,
                        descricao: descricao,
                        valor: valor,
                        data_vencimento: dataVencimento,
                        status: 'pendente',
                        forma_pagamento: formaPagamento,
                        tipo_cobranca: 'unica',
                        observacoes: observacoes ? (instrucoes ? `Instruções: ${instrucoes}\n\n${observacoes}` : observacoes) : (instrucoes ? `Instruções: ${instrucoes}` : null)
                    });
                } else if (tipo === 'parcelado') {
                    // Cobrança parcelada - criar múltiplas receitas
                    const numeroParcelas = parseInt(document.getElementById('cobrancaNumeroParcelas').value) || 1;
                    const intervaloDias = parseInt(document.getElementById('cobrancaIntervaloParcelas').value) || 30;
                    const valorParcela = valor / numeroParcelas;
                    
                    let dataVencimentoParcela = new Date(dataVencimento);
                    
                    for (let i = 1; i <= numeroParcelas; i++) {
                        receitasParaCriar.push({
                            cliente_id: clienteId,
                            orcamento_id: orcamentoId,
                            descricao: `${descricao} - Parcela ${i}/${numeroParcelas}`,
                            valor: Math.round(valorParcela * 100) / 100, // Arredondar para 2 casas decimais
                            data_vencimento: dataVencimentoParcela.toISOString().split('T')[0],
                            status: 'pendente',
                            forma_pagamento: formaPagamento,
                            tipo_cobranca: 'parcelado',
                            parcela_numero: i,
                            parcela_total: numeroParcelas,
                            observacoes: observacoes ? (instrucoes ? `Instruções: ${instrucoes}\n\n${observacoes}` : observacoes) : (instrucoes ? `Instruções: ${instrucoes}` : null)
                        });
                        
                        // Próxima parcela
                        dataVencimentoParcela.setDate(dataVencimentoParcela.getDate() + intervaloDias);
                    }
                } else if (tipo === 'recorrente') {
                    // Cobrança recorrente - criar primeira receita e salvar configuração
                    const frequencia = document.getElementById('cobrancaFrequencia').value;
                    const diaVencimento = parseInt(document.getElementById('cobrancaDiaVencimento').value) || 10;
                    const dataInicio = document.getElementById('cobrancaDataInicio').value;
                    const dataTermino = document.getElementById('cobrancaDataTermino').value || null;
                    
                    // Calcular primeira data de vencimento
                    let primeiraDataVencimento = new Date(dataInicio);
                    primeiraDataVencimento.setDate(diaVencimento);
                    if (primeiraDataVencimento < new Date(dataInicio)) {
                        primeiraDataVencimento.setMonth(primeiraDataVencimento.getMonth() + 1);
                    }
                    
                    receitasParaCriar.push({
                        cliente_id: clienteId,
                        orcamento_id: orcamentoId,
                        descricao: descricao,
                        valor: valor,
                        data_vencimento: primeiraDataVencimento.toISOString().split('T')[0],
                        status: 'pendente',
                        forma_pagamento: formaPagamento,
                        tipo_cobranca: 'recorrente',
                        frequencia: frequencia,
                        dia_vencimento: diaVencimento,
                        data_inicio: dataInicio,
                        data_termino: dataTermino,
                        observacoes: observacoes ? (instrucoes ? `Instruções: ${instrucoes}\n\n${observacoes}` : observacoes) : (instrucoes ? `Instruções: ${instrucoes}` : null)
                    });
                } else if (tipo === 'manutencao') {
                    // Taxa de manutenção - criar primeira receita e salvar configuração
                    const valorManutencao = parseFloat(document.getElementById('cobrancaValorManutencao').value) || valor;
                    const diaVencimento = parseInt(document.getElementById('cobrancaDiaVencimentoManutencao').value) || 10;
                    const dataInicio = document.getElementById('cobrancaDataInicioManutencao').value;
                    const ativa = document.getElementById('cobrancaManutencaoAtiva').checked;
                    
                    // Calcular primeira data de vencimento
                    let primeiraDataVencimento = new Date(dataInicio);
                    primeiraDataVencimento.setDate(diaVencimento);
                    if (primeiraDataVencimento < new Date(dataInicio)) {
                        primeiraDataVencimento.setMonth(primeiraDataVencimento.getMonth() + 1);
                    }
                    
                    receitasParaCriar.push({
                        cliente_id: clienteId,
                        orcamento_id: orcamentoId,
                        descricao: descricao || 'Taxa de Manutenção Mensal',
                        valor: valorManutencao,
                        data_vencimento: primeiraDataVencimento.toISOString().split('T')[0],
                        status: 'pendente',
                        forma_pagamento: formaPagamento,
                        tipo_cobranca: 'manutencao',
                        dia_vencimento: diaVencimento,
                        data_inicio: dataInicio,
                        ativa: ativa,
                        observacoes: observacoes ? (instrucoes ? `Instruções: ${instrucoes}\n\n${observacoes}` : observacoes) : (instrucoes ? `Instruções: ${instrucoes}` : null)
                    });
                }
                
                // Inserir todas as receitas
                if (receitasParaCriar.length > 0) {
                    const { error } = await supabase
                        .from('receitas')
                        .insert(receitasParaCriar);
                    
                    if (error) throw error;
                    
                    const mensagem = tipo === 'parcelado' 
                        ? `${receitasParaCriar.length} parcelas criadas com sucesso!`
                        : tipo === 'recorrente' || tipo === 'manutencao'
                        ? 'Cobrança recorrente criada com sucesso! As próximas cobranças serão geradas automaticamente.'
                        : 'Cobrança criada com sucesso!';
                    
                    alert(mensagem);
                    closeCobrancaModal();
                    await loadReceitas();
                    updateDashboardFinanceiro();
                }
            } catch (error) {
                console.error('Erro ao salvar cobrança:', error);
                alert('Erro ao salvar cobrança: ' + (error.message || 'Erro desconhecido'));
            }
        });

        // Gerar comprovante de pagamento
        async function gerarComprovantePagamento(receitaId) {
            try {
                // Verificar se jsPDF está disponível
                if (!window.jspdf) {
                    alert('Biblioteca de PDF não carregada. Por favor, recarregue a página.');
                    return;
                }
                
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Buscar receita
                const { data: receita, error: receitaError } = await supabase
                    .from('receitas')
                    .select('*, cliente:clientes(*), orcamento:orcamentos(*), projeto:projetos(*)')
                    .eq('id', receitaId)
                    .single();
                
                if (receitaError) throw receitaError;
                
                if (receita.status !== 'recebido') {
                    alert('Apenas receitas recebidas podem gerar comprovante de pagamento.');
                    return;
                }
                
                // Função auxiliar para formatar moeda
                const formatCurrencyPDF = (value) => {
                    if (!value && value !== 0) return 'R$ 0,00';
                    return new Intl.NumberFormat('pt-BR', {
                        style: 'currency',
                        currency: 'BRL'
                    }).format(value);
                };
                
                // Função auxiliar para formatar data
                const formatDatePDF = (dateStr) => {
                    if (!dateStr) return '-';
                    try {
                        const date = new Date(dateStr);
                        return date.toLocaleDateString('pt-BR');
                    } catch {
                        return dateStr;
                    }
                };
                
                // Configurações
                const margin = 20;
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                let y = margin;
                
                // ========== CABEÇALHO - DADOS DA EMPRESA ==========
                let logoLoaded = false;
                
                try {
                    const logoUrl = 'https://zhzhpctsndrcedukivhk.supabase.co/storage/v1/object/public/logo/LOGO%203D%20SEM%20FUNDO%20(1).png';
                    const response = await fetch(logoUrl);
                    if (response.ok) {
                        const blob = await response.blob();
                        const reader = new FileReader();
                        
                        await new Promise((resolve, reject) => {
                            reader.onload = () => resolve(reader.result);
                            reader.onerror = reject;
                            reader.readAsDataURL(blob);
                        });
                        
                        const logoData = reader.result;
                        doc.addImage(logoData, 'PNG', margin, 5, 60, 25);
                        logoLoaded = true;
                    }
                } catch (e) {
                    console.warn('Erro ao carregar logo:', e);
                }
                
                if (!logoLoaded) {
                    doc.setFillColor(255, 102, 0);
                    doc.rect(0, 0, pageWidth, 50, 'F');
                    
                    doc.setTextColor(255, 255, 255);
                    doc.setFontSize(28);
                    doc.setFont(undefined, 'bold');
                    doc.text('AUTOVIZION', margin, 30);
                    
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'normal');
                    doc.text('Soluções em Marketing Digital e Tecnologia', margin, 38);
                }
                
                // Dados da empresa no cabeçalho
                const dadosX = pageWidth - margin - 60;
                doc.setFontSize(9);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('AUTOVIZION', dadosX, 12);
                
                doc.setFontSize(8);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(60, 60, 60);
                doc.text('www.autovizon.com.br', dadosX, 20);
                doc.text('autovizioncomercial@gmail.com', dadosX, 26);
                doc.text('(14) 99683-3385', dadosX, 32);
                
                // Linha divisória
                doc.setDrawColor(200, 200, 200);
                doc.line(margin, 35, pageWidth - margin, 35);
                
                y = 45;
                
                // ========== TÍTULO DO DOCUMENTO ==========
                doc.setFillColor(10, 185, 129);
                doc.rect(margin, y - 5, pageWidth - (margin * 2), 20, 'F');
                
                doc.setTextColor(255, 255, 255);
                doc.setFontSize(22);
                doc.setFont(undefined, 'bold');
                doc.text('COMPROVANTE DE PAGAMENTO', margin + 5, y + 8);
                
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Data: ${formatDatePDF(new Date().toISOString())}`, pageWidth - margin - 30, y + 2);
                
                y += 25;
                
                // ========== DADOS DO CLIENTE ==========
                const cliente = receita.cliente || {};
                doc.setFillColor(255, 102, 0);
                doc.rect(margin, y, pageWidth - (margin * 2), 8, 'F');
                
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('DADOS DO CLIENTE', margin + 3, y + 6);
                y += 12;
                
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'normal');
                doc.text(`Cliente: ${cliente.nome || cliente.empresa || 'Cliente não encontrado'}`, margin, y);
                y += 6;
                if (cliente.empresa && cliente.empresa !== cliente.nome) {
                    doc.text(`Empresa: ${cliente.empresa}`, margin, y);
                    y += 6;
                }
                if (cliente.cpf_cnpj) {
                    doc.text(`CPF/CNPJ: ${cliente.cpf_cnpj}`, margin, y);
                    y += 6;
                }
                if (cliente.endereco) {
                    let enderecoCompleto = cliente.endereco;
                    if (cliente.cidade) enderecoCompleto += `, ${cliente.cidade}`;
                    if (cliente.estado) enderecoCompleto += ` - ${cliente.estado}`;
                    doc.text(`Endereço: ${enderecoCompleto}`, margin, y);
                    y += 6;
                }
                
                y += 10;
                
                // ========== DADOS DO PAGAMENTO ==========
                doc.setFillColor(10, 185, 129);
                doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('DADOS DO PAGAMENTO', margin + 3, y + 4);
                y += 12;
                
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                
                doc.text(`Descrição: ${receita.descricao || '-'}`, margin, y);
                y += 8;
                
                doc.setFont(undefined, 'bold');
                doc.setFontSize(16);
                doc.setTextColor(10, 185, 129);
                doc.text(`Valor Pago: ${formatCurrencyPDF(receita.valor || 0)}`, margin, y);
                y += 10;
                
                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text(`Forma de Pagamento: ${receita.forma_pagamento || 'Não especificada'}`, margin, y);
                y += 8;
                doc.text(`Data de Recebimento: ${formatDatePDF(receita.data_recebimento)}`, margin, y);
                y += 8;
                doc.text(`Data de Vencimento: ${formatDatePDF(receita.data_vencimento)}`, margin, y);
                y += 10;
                
                // ========== OBSERVAÇÕES ==========
                if (receita.observacoes) {
                    if (y > pageHeight - 40) {
                        doc.addPage();
                        y = margin + 10;
                    }
                    
                    doc.setFillColor(255, 102, 0);
                    doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                    
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(255, 255, 255);
                    doc.text('OBSERVAÇÕES', margin + 3, y + 4);
                    y += 12;
                    
                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(9);
                    doc.setTextColor(60, 60, 60);
                    const observacoesLines = doc.splitTextToSize(receita.observacoes, pageWidth - (margin * 2));
                    doc.text(observacoesLines, margin, y);
                    y += observacoesLines.length * 4 + 5;
                }
                
                // ========== RODAPÉ ==========
                const contatoY = pageHeight - 8;
                doc.setFontSize(7);
                doc.setTextColor(128, 128, 128);
                doc.setFont(undefined, 'normal');
                doc.text('AUTOVIZION', margin, contatoY);
                doc.text('|', margin + 25, contatoY);
                doc.text('www.autovizon.com.br', margin + 30, contatoY);
                doc.text('|', margin + 70, contatoY);
                doc.text('autovizioncomercial@gmail.com', margin + 75, contatoY);
                doc.text('|', margin + 130, contatoY);
                doc.text('(14) 99683-3385', margin + 135, contatoY);
                
                // Salvar PDF
                const clienteNome = cliente.nome || cliente.empresa || 'Cliente';
                const dataFormatada = formatDatePDF(receita.data_recebimento).replace(/\//g, '_');
                const fileName = `Comprovante_Pagamento_${clienteNome.replace(/[^a-zA-Z0-9]/g, '_')}_${dataFormatada}.pdf`;
                doc.save(fileName);
                
                // Mostrar mensagem de sucesso
                alert('Comprovante de pagamento gerado com sucesso!');
            } catch (error) {
                console.error('Erro ao gerar comprovante de pagamento:', error);
                alert('Erro ao gerar comprovante de pagamento: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // ========== PLATAFORMAS ==========
        
        let allPlataformas = [];
        let filteredPlataformas = [];

        // Carregar plataformas
        async function loadPlataformas() {
            const loading = document.getElementById('plataformasLoading');
            const grid = document.getElementById('plataformasGrid');
            const empty = document.getElementById('plataformasEmpty');
            
            if (loading) loading.classList.add('active');
            if (grid) grid.style.display = 'none';
            if (empty) empty.style.display = 'none';
            
            try {
                const { data, error } = await supabase
                    .from('plataformas')
                    .select('*')
                    .order('nome', { ascending: true });
                
                if (error) throw error;
                
                allPlataformas = data || [];
                filteredPlataformas = [...allPlataformas];
                
                renderPlataformas();
                
                if (loading) loading.classList.remove('active');
                if (filteredPlataformas.length > 0) {
                    if (grid) grid.style.display = 'grid';
                } else {
                    if (empty) empty.style.display = 'block';
                }
            } catch (error) {
                console.error('Erro ao carregar plataformas:', error);
                if (loading) loading.classList.remove('active');
                if (empty) empty.style.display = 'block';
                if (empty) empty.textContent = 'Erro ao carregar plataformas: ' + (error.message || 'Erro desconhecido');
            }
        }

        // Renderizar plataformas em cards
        function renderPlataformas() {
            const grid = document.getElementById('plataformasGrid');
            if (!grid) return;
            
            if (filteredPlataformas.length === 0) {
                grid.innerHTML = '';
                return;
            }
            
            grid.innerHTML = filteredPlataformas.map(plataforma => {
                const tipoMap = {
                    'unico': { label: 'Pagamento Único', class: 'badge-tipo-unico' },
                    'recorrente': { label: 'Recorrente', class: 'badge-tipo-recorrente' },
                    'gratis': { label: 'Grátis', class: 'badge-tipo-gratis' }
                };
                const tipo = tipoMap[plataforma.tipo_pagamento] || { label: plataforma.tipo_pagamento, class: 'badge-tipo-gratis' };
                
                let valorInfo = '';
                if (plataforma.tipo_pagamento === 'unico' && plataforma.valor) {
                    valorInfo = `<div class="plataforma-info-item">
                        <span class="plataforma-info-label">Valor Pago:</span>
                        <span class="plataforma-info-value">${formatCurrency(plataforma.valor)}</span>
                    </div>`;
                    if (plataforma.data_pagamento) {
                        valorInfo += `<div class="plataforma-info-item">
                            <span class="plataforma-info-label">Data:</span>
                            <span class="plataforma-info-value">${formatDate(plataforma.data_pagamento)}</span>
                        </div>`;
                    }
                } else if (plataforma.tipo_pagamento === 'recorrente' && plataforma.valor) {
                    valorInfo = `<div class="plataforma-info-item">
                        <span class="plataforma-info-label">Valor Mensal:</span>
                        <span class="plataforma-info-value">${formatCurrency(plataforma.valor)}</span>
                    </div>`;
                    if (plataforma.validade) {
                        const validade = new Date(plataforma.validade);
                        const hoje = new Date();
                        const diasRestantes = Math.ceil((validade - hoje) / (1000 * 60 * 60 * 24));
                        const statusClass = diasRestantes < 0 ? 'badge-danger' : diasRestantes <= 7 ? 'badge-warning' : 'badge-success';
                        valorInfo += `<div class="plataforma-info-item">
                            <span class="plataforma-info-label">Validade:</span>
                            <span class="plataforma-info-value">
                                ${formatDate(plataforma.validade)}
                                ${diasRestantes < 0 ? ' <span class="badge badge-danger">Vencido</span>' : diasRestantes <= 7 ? ' <span class="badge badge-warning">Expira em ' + diasRestantes + ' dias</span>' : ''}
                            </span>
                        </div>`;
                    }
                }
                
                return `
                    <div class="plataforma-card" onclick="viewPlataforma('${plataforma.id}')">
                        <div class="plataforma-card-header">
                            <h3 class="plataforma-card-title">${(plataforma.nome || '-').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</h3>
                            <span class="plataforma-card-badge ${tipo.class}">${tipo.label}</span>
                        </div>
                        <div class="plataforma-card-info">
                            ${valorInfo}
                            ${plataforma.usuario ? `<div class="plataforma-info-item">
                                <span class="plataforma-info-label">Usuário:</span>
                                <span class="plataforma-info-value">${(plataforma.usuario || '-').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</span>
                            </div>` : ''}
                            ${plataforma.url ? `<div class="plataforma-info-item">
                                <span class="plataforma-info-label">URL:</span>
                                <span class="plataforma-info-value" style="font-size: 11px; word-break: break-all;">${(plataforma.url || '-').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</span>
                            </div>` : ''}
                        </div>
                        <div class="plataforma-card-actions" onclick="event.stopPropagation()">
                            ${plataforma.url ? `<button class="btn btn-sm btn-primary" onclick="abrirPlataforma('${plataforma.id}')" title="Abrir URL">🔗 Acessar</button>` : ''}
                            ${plataforma.usuario || plataforma.senha ? `<button class="btn btn-sm btn-secondary" onclick="copiarCredenciais('${plataforma.id}')" title="Copiar credenciais">📋 Copiar</button>` : ''}
                            <button class="btn btn-sm btn-primary" onclick="editPlataforma('${plataforma.id}')" title="Editar">✏️ Editar</button>
                            <button class="btn btn-sm btn-danger" onclick="deletePlataforma('${plataforma.id}')" title="Excluir">🗑️ Excluir</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Filtrar plataformas
        function filterPlataformas() {
            const search = document.getElementById('plataformaSearch')?.value.toLowerCase() || '';
            const tipoFilter = document.getElementById('plataformaTipoFilter')?.value || '';
            
            filteredPlataformas = allPlataformas.filter(plataforma => {
                const matchSearch = !search || 
                    (plataforma.nome && plataforma.nome.toLowerCase().includes(search));
                
                const matchTipo = !tipoFilter || plataforma.tipo_pagamento === tipoFilter;
                
                return matchSearch && matchTipo;
            });
            
            renderPlataformas();
            
            // Atualizar empty state
            const grid = document.getElementById('plataformasGrid');
            const empty = document.getElementById('plataformasEmpty');
            if (filteredPlataformas.length === 0) {
                if (grid) grid.style.display = 'none';
                if (empty) empty.style.display = 'block';
            } else {
                if (grid) grid.style.display = 'grid';
                if (empty) empty.style.display = 'none';
            }
        }

        // Toggle campos do formulário baseado no tipo de pagamento
        function togglePlataformaCampos() {
            const tipo = document.getElementById('plataformaTipoPagamento').value;
            const camposUnico = document.getElementById('camposPagamentoUnico');
            const camposRecorrente = document.getElementById('camposPagamentoRecorrente');
            
            if (camposUnico) camposUnico.style.display = tipo === 'unico' ? 'block' : 'none';
            if (camposRecorrente) camposRecorrente.style.display = tipo === 'recorrente' ? 'block' : 'none';
            
            // Limpar campos quando mudar tipo
            if (tipo !== 'unico') {
                document.getElementById('plataformaValor').value = '';
                document.getElementById('plataformaDataPagamento').value = '';
            }
            if (tipo !== 'recorrente') {
                document.getElementById('plataformaValorRecorrente').value = '';
                document.getElementById('plataformaValidade').value = '';
            }
        }

        // Toggle visibilidade da senha
        function togglePlataformaSenha() {
            const senhaInput = document.getElementById('plataformaSenha');
            if (senhaInput.type === 'password') {
                senhaInput.type = 'text';
            } else {
                senhaInput.type = 'password';
            }
        }

        // Abrir modal de plataforma (novo)
        function openPlataformaModal() {
            document.getElementById('plataformaModalTitle').textContent = 'Nova Plataforma';
            document.getElementById('plataformaForm').reset();
            document.getElementById('plataformaId').value = '';
            togglePlataformaCampos();
            
            const modal = document.getElementById('plataformaModal');
            openModal(modal);
        }

        // Fechar modal de plataforma
        function closePlataformaModal() {
            const modal = document.getElementById('plataformaModal');
            closeModal(modal);
        }

        // Editar plataforma
        function editPlataforma(id) {
            const plataforma = allPlataformas.find(p => p.id === id);
            if (!plataforma) return;
            
            document.getElementById('plataformaModalTitle').textContent = 'Editar Plataforma';
            document.getElementById('plataformaId').value = plataforma.id;
            document.getElementById('plataformaNome').value = plataforma.nome || '';
            document.getElementById('plataformaUrl').value = plataforma.url || '';
            document.getElementById('plataformaTipoPagamento').value = plataforma.tipo_pagamento || 'gratis';
            document.getElementById('plataformaUsuario').value = plataforma.usuario || '';
            document.getElementById('plataformaSenha').value = plataforma.senha || '';
            document.getElementById('plataformaObservacoes').value = plataforma.observacoes || '';
            
            // Preencher campos específicos do tipo
            if (plataforma.tipo_pagamento === 'unico') {
                document.getElementById('plataformaValor').value = plataforma.valor || '';
                document.getElementById('plataformaDataPagamento').value = plataforma.data_pagamento ? plataforma.data_pagamento.split('T')[0] : '';
            } else if (plataforma.tipo_pagamento === 'recorrente') {
                document.getElementById('plataformaValorRecorrente').value = plataforma.valor || '';
                document.getElementById('plataformaValidade').value = plataforma.validade ? plataforma.validade.split('T')[0] : '';
            }
            
            togglePlataformaCampos();
            
            const modal = document.getElementById('plataformaModal');
            openModal(modal);
        }

        // Ver plataforma (detalhes)
        async function viewPlataforma(id) {
            const plataforma = allPlataformas.find(p => p.id === id);
            if (!plataforma) return;
            
            const tipoMap = {
                'unico': { label: 'Pagamento Único', class: 'badge-tipo-unico' },
                'recorrente': { label: 'Pagamento Recorrente', class: 'badge-tipo-recorrente' },
                'gratis': { label: 'Grátis', class: 'badge-tipo-gratis' }
            };
            const tipo = tipoMap[plataforma.tipo_pagamento] || { label: plataforma.tipo_pagamento, class: 'badge-tipo-gratis' };
            
            let pagamentoInfo = '';
            if (plataforma.tipo_pagamento === 'unico') {
                pagamentoInfo = `
                    <div class="details-item">
                        <div class="details-label">Valor Pago</div>
                        <div class="details-value">${plataforma.valor ? formatCurrency(plataforma.valor) : '-'}</div>
                    </div>
                    <div class="details-item">
                        <div class="details-label">Data do Pagamento</div>
                        <div class="details-value">${plataforma.data_pagamento ? formatDate(plataforma.data_pagamento) : '-'}</div>
                    </div>
                `;
            } else if (plataforma.tipo_pagamento === 'recorrente') {
                pagamentoInfo = `
                    <div class="details-item">
                        <div class="details-label">Valor Mensal</div>
                        <div class="details-value">${plataforma.valor ? formatCurrency(plataforma.valor) : '-'}</div>
                    </div>
                    <div class="details-item">
                        <div class="details-label">Data de Validade</div>
                        <div class="details-value">
                            ${plataforma.validade ? formatDate(plataforma.validade) : '-'}
                            ${plataforma.validade ? (() => {
                                const validade = new Date(plataforma.validade);
                                const hoje = new Date();
                                const diasRestantes = Math.ceil((validade - hoje) / (1000 * 60 * 60 * 24));
                                if (diasRestantes < 0) return ' <span class="badge badge-danger">Vencido</span>';
                                if (diasRestantes <= 7) return ' <span class="badge badge-warning">Expira em ' + diasRestantes + ' dias</span>';
                                return '';
                            })() : ''}
                        </div>
                    </div>
                `;
            }
            
            const content = `
                <div class="details-section">
                    <div class="details-section-title">Informações Gerais</div>
                    <div class="details-grid">
                        <div class="details-item">
                            <div class="details-label">Nome</div>
                            <div class="details-value">${(plataforma.nome || '-').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Tipo de Pagamento</div>
                            <div class="details-value"><span class="badge ${tipo.class}">${tipo.label}</span></div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">URL</div>
                            <div class="details-value">
                                ${plataforma.url ? `<a href="${plataforma.url}" target="_blank" style="color: var(--primary); text-decoration: underline;">${plataforma.url}</a>` : '-'}
                            </div>
                        </div>
                    </div>
                </div>
                
                ${pagamentoInfo ? `<div class="details-section">
                    <div class="details-section-title">Informações de Pagamento</div>
                    <div class="details-grid">
                        ${pagamentoInfo}
                    </div>
                </div>` : ''}
                
                <div class="details-section">
                    <div class="details-section-title">Credenciais</div>
                    <div class="details-grid">
                        <div class="details-item">
                            <div class="details-label">Usuário/Email</div>
                            <div class="details-value">${(plataforma.usuario || '-').replace(/</g, '&lt;').replace(/>/g, '&gt;')}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Senha</div>
                            <div class="details-value">
                                ${plataforma.senha ? '••••••••' : '-'}
                                ${plataforma.senha ? `<button class="btn btn-sm btn-secondary" onclick="copiarCredenciais('${plataforma.id}')" style="margin-left: 8px;">📋 Copiar</button>` : ''}
                            </div>
                        </div>
                    </div>
                </div>
                
                ${plataforma.observacoes ? `<div class="details-section">
                    <div class="details-section-title">Observações</div>
                    <div class="details-value">${(plataforma.observacoes || '-').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/\n/g, '<br>')}</div>
                </div>` : ''}
            `;
            
            document.getElementById('plataformaDetailsContent').innerHTML = content;
            document.getElementById('editPlataformaFromDetailsBtn').onclick = () => {
                closePlataformaDetailsModal();
                editPlataforma(id);
            };
            document.getElementById('deletePlataformaFromDetailsBtn').onclick = () => {
                closePlataformaDetailsModal();
                deletePlataforma(id);
            };
            
            const modal = document.getElementById('plataformaDetailsModal');
            openModal(modal);
        }

        // Fechar modal de detalhes
        function closePlataformaDetailsModal() {
            const modal = document.getElementById('plataformaDetailsModal');
            closeModal(modal);
        }

        // Copiar credenciais
        async function copiarCredenciais(id) {
            const plataforma = allPlataformas.find(p => p.id === id);
            if (!plataforma) return;
            
            let texto = '';
            if (plataforma.usuario) texto += `Usuário: ${plataforma.usuario}\n`;
            if (plataforma.senha) texto += `Senha: ${plataforma.senha}\n`;
            if (plataforma.url) texto += `URL: ${plataforma.url}`;
            
            if (!texto) {
                alert('Nenhuma credencial disponível para copiar.');
                return;
            }
            
            try {
                await navigator.clipboard.writeText(texto);
                alert('Credenciais copiadas para a área de transferência!');
            } catch (error) {
                // Fallback para navegadores antigos
                const textarea = document.createElement('textarea');
                textarea.value = texto;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('Credenciais copiadas para a área de transferência!');
            }
        }

        // Abrir plataforma (URL)
        function abrirPlataforma(id) {
            const plataforma = allPlataformas.find(p => p.id === id);
            if (!plataforma || !plataforma.url) return;
            
            window.open(plataforma.url, '_blank');
        }

        // Excluir plataforma
        async function deletePlataforma(id) {
            if (!confirm('Tem certeza que deseja excluir esta plataforma?')) return;
            
            try {
                const { error } = await supabase
                    .from('plataformas')
                    .delete()
                    .eq('id', id);
                
                if (error) throw error;
                
                alert('Plataforma excluída com sucesso!');
                await loadPlataformas();
            } catch (error) {
                console.error('Erro ao excluir plataforma:', error);
                alert('Erro ao excluir plataforma: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // Salvar plataforma (criar ou atualizar)
        document.getElementById('plataformaForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('plataformaId').value;
            const tipoPagamento = document.getElementById('plataformaTipoPagamento').value;
            
            const plataformaData = {
                nome: document.getElementById('plataformaNome').value.trim(),
                url: document.getElementById('plataformaUrl').value.trim() || null,
                tipo_pagamento: tipoPagamento,
                usuario: document.getElementById('plataformaUsuario').value.trim() || null,
                senha: document.getElementById('plataformaSenha').value.trim() || null,
                observacoes: document.getElementById('plataformaObservacoes').value.trim() || null
            };
            
            // Campos específicos por tipo
            if (tipoPagamento === 'unico') {
                plataformaData.valor = document.getElementById('plataformaValor').value ? parseFloat(document.getElementById('plataformaValor').value) : null;
                plataformaData.data_pagamento = document.getElementById('plataformaDataPagamento').value || null;
                plataformaData.validade = null;
            } else if (tipoPagamento === 'recorrente') {
                plataformaData.valor = document.getElementById('plataformaValorRecorrente').value ? parseFloat(document.getElementById('plataformaValorRecorrente').value) : null;
                plataformaData.validade = document.getElementById('plataformaValidade').value || null;
                plataformaData.data_pagamento = null;
            } else {
                // Grátis
                plataformaData.valor = null;
                plataformaData.data_pagamento = null;
                plataformaData.validade = null;
            }
            
            try {
                if (id) {
                    // Atualizar
                    const { error } = await supabase
                        .from('plataformas')
                        .update(plataformaData)
                        .eq('id', id);
                    
                    if (error) throw error;
                    
                    alert('Plataforma atualizada com sucesso!');
                } else {
                    // Criar
                    const { error } = await supabase
                        .from('plataformas')
                        .insert([plataformaData]);
                    
                    if (error) throw error;
                    
                    alert('Plataforma criada com sucesso!');
                }
                
                closePlataformaModal();
                await loadPlataformas();
            } catch (error) {
                console.error('Erro ao salvar plataforma:', error);
                alert('Erro ao salvar plataforma: ' + (error.message || 'Erro desconhecido'));
            }
        });

        // ========== DOCUMENTOS DE FINALIZAÇÃO ==========
        
        let entregasList = [];

        // Adicionar entrega
        function adicionarEntrega() {
            const container = document.getElementById('entregasContainer');
            if (!container) return;
            
            const entregaId = Date.now();
            const numeroEntrega = container.children.length + 1;
            const entregaHtml = `
                <div class="entrega-item" data-id="${entregaId}" style="background: var(--secondary); padding: 12px; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 12px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                        <span style="color: var(--primary); font-weight: 600; font-size: 14px;">Entrega #${numeroEntrega}</span>
                        <button type="button" class="btn btn-danger" onclick="removerEntrega(${entregaId})" style="padding: 6px 12px; font-size: 12px;">🗑️ Remover</button>
                    </div>
                    <div style="display: flex; flex-direction: column; gap: 8px;">
                        <div>
                            <label style="display: block; color: var(--text-gray); font-size: 12px; margin-bottom: 4px;">Nome da Entrega *</label>
                            <input type="text" class="form-input" placeholder="Ex: Site institucional, Logo, Sistema de gestão..." data-field="item" style="width: 100%;">
                        </div>
                        <div>
                            <label style="display: block; color: var(--text-gray); font-size: 12px; margin-bottom: 4px;">Descrição (opcional)</label>
                            <textarea class="form-input" placeholder="Descreva detalhes da entrega, funcionalidades, etc." rows="2" data-field="descricao" style="width: 100%; resize: vertical;"></textarea>
                        </div>
                    </div>
                </div>
            `;
            container.insertAdjacentHTML('beforeend', entregaHtml);
        }

        // Remover entrega
        function removerEntrega(id) {
            if (!confirm('Deseja remover esta entrega?')) return;
            
            const item = document.querySelector(`.entrega-item[data-id="${id}"]`);
            if (item) {
                item.remove();
                // Renumerar entregas
                renumerarEntregas();
            }
        }

        // Renumerar entregas
        function renumerarEntregas() {
            const container = document.getElementById('entregasContainer');
            if (!container) return;
            
            const items = container.querySelectorAll('.entrega-item');
            items.forEach((item, index) => {
                const numeroSpan = item.querySelector('span');
                if (numeroSpan) {
                    numeroSpan.textContent = `Entrega #${index + 1}`;
                }
            });
        }

        // Toggle suporte dias
        function toggleSuporteDias() {
            const suporteIncluso = document.getElementById('documentoFinalizacaoSuporteIncluso').value === 'true';
            const suporteDiasGroup = document.getElementById('suporteDiasGroup');
            if (suporteDiasGroup) {
                suporteDiasGroup.style.display = suporteIncluso ? 'block' : 'none';
            }
        }

        // Atualizar formas de pagamento
        function atualizarFormasPagamento() {
            const formasSelecionadas = [];
            if (document.getElementById('documentoFormaPagamentoPix').checked) formasSelecionadas.push('PIX');
            if (document.getElementById('documentoFormaPagamentoCartao').checked) formasSelecionadas.push('Cartão de Crédito/Débito');
            if (document.getElementById('documentoFormaPagamentoBoleto').checked) formasSelecionadas.push('Boleto');
            if (document.getElementById('documentoFormaPagamentoDinheiro').checked) formasSelecionadas.push('Dinheiro');
            if (document.getElementById('documentoFormaPagamentoTransferencia').checked) formasSelecionadas.push('Transferência Bancária');
            document.getElementById('documentoFinalizacaoFormasPagamento').value = formasSelecionadas.join(', ');
        }

        // Abrir modal de documento de finalização
        async function openDocumentoFinalizacaoModal(projetoId) {
            const projeto = allProjetos.find(p => p.id === projetoId);
            if (!projeto) {
                alert('Projeto não encontrado');
                return;
            }

            // Limpar formulário
            document.getElementById('documentoFinalizacaoForm').reset();
            document.getElementById('documentoFinalizacaoId').value = '';
            document.getElementById('entregasContainer').innerHTML = '';
            entregasList = [];
            
            // Limpar checkboxes de formas de pagamento
            document.getElementById('documentoFormaPagamentoPix').checked = false;
            document.getElementById('documentoFormaPagamentoCartao').checked = false;
            document.getElementById('documentoFormaPagamentoBoleto').checked = false;
            document.getElementById('documentoFormaPagamentoDinheiro').checked = false;
            document.getElementById('documentoFormaPagamentoTransferencia').checked = false;
            document.getElementById('documentoFinalizacaoFormasPagamento').value = '';

            // Preencher dados do projeto
            document.getElementById('documentoFinalizacaoProjetoId').value = projetoId;
            document.getElementById('documentoFinalizacaoClienteId').value = projeto.cliente_id || '';
            
            // Preencher data de conclusão (usar data de conclusão do projeto ou hoje)
            const dataConclusao = projeto.data_conclusao ? projeto.data_conclusao.split('T')[0] : new Date().toISOString().split('T')[0];
            document.getElementById('documentoFinalizacaoDataConclusao').value = dataConclusao;

            // Preencher valor total do projeto
            if (projeto.valor) {
                document.getElementById('documentoFinalizacaoValorTotal').value = projeto.valor;
            }

            // Buscar orçamento relacionado para pegar formas de pagamento
            try {
                const { data: orcamento } = await supabase
                    .from('orcamentos')
                    .select('forma_pagamento')
                    .eq('id', projeto.orcamento_id)
                    .single();
                
                if (orcamento && orcamento.forma_pagamento) {
                    const formas = orcamento.forma_pagamento.split(',').map(f => f.trim());
                    formas.forEach(forma => {
                        if (forma.includes('PIX')) document.getElementById('documentoFormaPagamentoPix').checked = true;
                        if (forma.includes('Cartão')) document.getElementById('documentoFormaPagamentoCartao').checked = true;
                        if (forma.includes('Boleto')) document.getElementById('documentoFormaPagamentoBoleto').checked = true;
                        if (forma.includes('Dinheiro')) document.getElementById('documentoFormaPagamentoDinheiro').checked = true;
                        if (forma.includes('Transferência')) document.getElementById('documentoFormaPagamentoTransferencia').checked = true;
                    });
                    atualizarFormasPagamento();
                }
            } catch (e) {
                console.warn('Erro ao buscar formas de pagamento:', e);
            }

            // Calcular valor pago (buscar receitas do projeto)
            try {
                const { data: receitas } = await supabase
                    .from('receitas')
                    .select('valor, status, forma_pagamento')
                    .eq('projeto_id', projetoId)
                    .eq('status', 'recebido');
                
                let valorPago = 0;
                if (receitas) {
                    valorPago = receitas.reduce((sum, r) => sum + (parseFloat(r.valor) || 0), 0);
                }
                document.getElementById('documentoFinalizacaoValorPago').value = valorPago.toFixed(2);
            } catch (e) {
                console.warn('Erro ao calcular valor pago:', e);
            }

            // Gerar número do documento
            try {
                const { data } = await supabase
                    .from('documentos_finalizacao')
                    .select('numero_documento')
                    .order('created_at', { ascending: false })
                    .limit(1);
                
                let proximoNumero = 1;
                if (data && data.length > 0 && data[0].numero_documento) {
                    const match = data[0].numero_documento.match(/\d+/);
                    if (match) {
                        proximoNumero = parseInt(match[0]) + 1;
                    }
                }
                
                const ano = new Date().getFullYear();
                document.getElementById('documentoFinalizacaoNumero').value = `${String(proximoNumero).padStart(4, '0')}/${ano}`;
            } catch (e) {
                const ano = new Date().getFullYear();
                document.getElementById('documentoFinalizacaoNumero').value = `0001/${ano}`;
            }

            // Preencher entregas automaticamente dos trabalhos/itens do projeto
            try {
                // Buscar projeto completo com todos os campos (incluindo possíveis campos de trabalhos/itens)
                const { data: projetoCompleto, error: projetoError } = await supabase
                    .from('projetos')
                    .select('*')
                    .eq('id', projetoId)
                    .single();
                
                if (projetoError) throw projetoError;
                
                let itens = [];
                
                // Tentar buscar itens/trabalhos diretamente do projeto
                // Primeiro, verificar se o projeto tem um campo 'itens' ou 'trabalhos'
                if (projetoCompleto.itens) {
                    // Se o projeto tem campo 'itens'
                    if (typeof projetoCompleto.itens === 'string') {
                        try {
                            itens = JSON.parse(projetoCompleto.itens);
                        } catch (e) {
                            console.warn('Erro ao parsear itens do projeto:', e);
                        }
                    } else if (Array.isArray(projetoCompleto.itens)) {
                        itens = projetoCompleto.itens;
                    }
                } else if (projetoCompleto.trabalhos) {
                    // Se o projeto tem campo 'trabalhos'
                    if (typeof projetoCompleto.trabalhos === 'string') {
                        try {
                            itens = JSON.parse(projetoCompleto.trabalhos);
                        } catch (e) {
                            console.warn('Erro ao parsear trabalhos do projeto:', e);
                        }
                    } else if (Array.isArray(projetoCompleto.trabalhos)) {
                        itens = projetoCompleto.trabalhos;
                    }
                }
                
                // Se não encontrou itens no projeto, buscar do orçamento como fallback
                if (!itens || itens.length === 0) {
                    if (projeto.orcamento_id) {
                        const { data: orcamento } = await supabase
                            .from('orcamentos')
                            .select('itens')
                            .eq('id', projeto.orcamento_id)
                            .single();
                        
                        if (orcamento && orcamento.itens) {
                            try {
                                if (typeof orcamento.itens === 'string') {
                                    itens = JSON.parse(orcamento.itens);
                                } else if (Array.isArray(orcamento.itens)) {
                                    itens = orcamento.itens;
                                }
                            } catch (e) {
                                console.warn('Erro ao parsear itens do orçamento:', e);
                            }
                        }
                    }
                }
                
                // Adicionar cada item como entrega
                if (itens && itens.length > 0) {
                    itens.forEach((item) => {
                        const container = document.getElementById('entregasContainer');
                        if (!container) return;
                        
                        // Adicionar entrega
                        const entregaId = Date.now() + Math.random();
                        const numeroEntrega = container.children.length + 1;
                        const entregaHtml = `
                            <div class="entrega-item" data-id="${entregaId}" style="background: var(--secondary); padding: 12px; border-radius: 8px; border: 1px solid rgba(255, 255, 255, 0.1); margin-bottom: 12px;">
                                <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                    <span style="color: var(--primary); font-weight: 600; font-size: 14px;">Entrega #${numeroEntrega}</span>
                                    <button type="button" class="btn btn-danger" onclick="removerEntrega(${entregaId})" style="padding: 6px 12px; font-size: 12px;">🗑️ Remover</button>
                                </div>
                                <div style="display: flex; flex-direction: column; gap: 8px;">
                                    <div>
                                        <label style="display: block; color: var(--text-gray); font-size: 12px; margin-bottom: 4px;">Nome da Entrega *</label>
                                        <input type="text" class="form-input" placeholder="Ex: Site institucional, Logo, Sistema de gestão..." data-field="item" style="width: 100%;" value="${(item.descricao || item.desc || item.item || item.trabalho || '').replace(/"/g, '&quot;')}">
                                    </div>
                                    <div>
                                        <label style="display: block; color: var(--text-gray); font-size: 12px; margin-bottom: 4px;">Descrição (opcional)</label>
                                        <textarea class="form-input" placeholder="Descreva detalhes da entrega, funcionalidades, etc." rows="2" data-field="descricao" style="width: 100%; resize: vertical;">${(() => {
                                            let descTexto = '';
                                            if (item.quantidade) descTexto += `Quantidade: ${item.quantidade}`;
                                            if (item.valor_unitario) {
                                                if (descTexto) descTexto += ' | ';
                                                descTexto += `Valor: ${formatCurrency(item.valor_unitario)}`;
                                            }
                                            if (item.desconto_percent && item.desconto_percent > 0) {
                                                if (descTexto) descTexto += ' | ';
                                                descTexto += `Desconto: ${item.desconto_percent}%`;
                                            }
                                            // Se tiver descrição separada, adicionar também
                                            if (item.descricao_detalhada && item.descricao_detalhada !== item.descricao) {
                                                if (descTexto) descTexto += '\n';
                                                descTexto += item.descricao_detalhada;
                                            }
                                            return descTexto.replace(/"/g, '&quot;');
                                        })()}</textarea>
                                    </div>
                                </div>
                            </div>
                        `;
                        container.insertAdjacentHTML('beforeend', entregaHtml);
                    });
                } else {
                    // Se não houver itens, adicionar uma entrega padrão
                    adicionarEntrega();
                }
            } catch (e) {
                console.warn('Erro ao buscar trabalhos/itens do projeto:', e);
                // Fallback: adicionar uma entrega padrão
                adicionarEntrega();
            }

            const modal = document.getElementById('documentoFinalizacaoModal');
            openModal(modal);
        }

        // Fechar modal
        function closeDocumentoFinalizacaoModal() {
            const modal = document.getElementById('documentoFinalizacaoModal');
            closeModal(modal);
        }

        // Coletar entregas do formulário
        function coletarEntregas() {
            const entregas = [];
            const container = document.getElementById('entregasContainer');
            if (!container) return entregas;
            
            const items = container.querySelectorAll('.entrega-item');
            
            items.forEach(item => {
                const itemInput = item.querySelector('[data-field="item"]');
                const descricaoInput = item.querySelector('[data-field="descricao"]');
                
                if (itemInput) {
                    const itemValue = itemInput.value ? itemInput.value.trim() : '';
                    const descricaoValue = descricaoInput && descricaoInput.value ? descricaoInput.value.trim() : '';
                    
                    if (itemValue) {
                        entregas.push({
                            item: itemValue,
                            descricao: descricaoValue || '',
                            status: 'entregue'
                        });
                    }
                }
            });
            
            return entregas;
        }

        // Salvar documento de finalização
        document.getElementById('documentoFinalizacaoForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const entregas = coletarEntregas();
            if (entregas.length === 0) {
                alert('Adicione pelo menos uma entrega!');
                return;
            }

            const documentoData = {
                projeto_id: document.getElementById('documentoFinalizacaoProjetoId').value,
                cliente_id: document.getElementById('documentoFinalizacaoClienteId').value,
                numero_documento: document.getElementById('documentoFinalizacaoNumero').value,
                data_conclusao: document.getElementById('documentoFinalizacaoDataConclusao').value,
                entregas: entregas,
                valor_total: document.getElementById('documentoFinalizacaoValorTotal').value ? parseFloat(document.getElementById('documentoFinalizacaoValorTotal').value) : null,
                valor_pago: document.getElementById('documentoFinalizacaoValorPago').value ? parseFloat(document.getElementById('documentoFinalizacaoValorPago').value) : null,
                garantia_dias: parseInt(document.getElementById('documentoFinalizacaoGarantia').value) || 30,
                suporte_incluso: document.getElementById('documentoFinalizacaoSuporteIncluso').value === 'true',
                suporte_dias: document.getElementById('documentoFinalizacaoSuporteDias').value ? parseInt(document.getElementById('documentoFinalizacaoSuporteDias').value) : null,
                observacoes: document.getElementById('documentoFinalizacaoObservacoes').value.trim() || null,
                termos_condicoes: document.getElementById('documentoFinalizacaoTermos').value.trim() || null,
                status: 'rascunho'
            };
            
            // Adicionar formas_pagamento apenas se a coluna existir (evitar erro)
            const formasPagamento = document.getElementById('documentoFinalizacaoFormasPagamento').value.trim();
            if (formasPagamento) {
                documentoData.formas_pagamento = formasPagamento;
            }

            // Calcular valor pendente
            if (documentoData.valor_total && documentoData.valor_pago) {
                documentoData.valor_pendente = Math.max(0, documentoData.valor_total - documentoData.valor_pago);
            } else {
                documentoData.valor_pendente = null;
            }

            try {
                let documentoId;
                const id = document.getElementById('documentoFinalizacaoId').value;

                if (id) {
                    // Atualizar
                    const { data, error } = await supabase
                        .from('documentos_finalizacao')
                        .update(documentoData)
                        .eq('id', id)
                        .select()
                        .single();
                    
                    if (error) throw error;
                    documentoId = data.id;
                } else {
                    // Criar
                    const { data, error } = await supabase
                        .from('documentos_finalizacao')
                        .insert([documentoData])
                        .select()
                        .single();
                    
                    if (error) throw error;
                    documentoId = data.id;
                }

                // Gerar PDF
                await gerarPDFDocumentoFinalizacao(documentoId);
                
                alert('Documento de finalização criado e PDF gerado com sucesso!');
                closeDocumentoFinalizacaoModal();
            } catch (error) {
                console.error('Erro ao salvar documento:', error);
                alert('Erro ao salvar documento: ' + (error.message || 'Erro desconhecido'));
            }
        });

        // Gerar PDF do documento de finalização
        async function gerarPDFDocumentoFinalizacao(documentoId) {
            try {
                if (!window.jspdf) {
                    alert('Biblioteca de PDF não carregada. Por favor, recarregue a página.');
                    return;
                }

                // Buscar documento
                const { data: documento, error } = await supabase
                    .from('documentos_finalizacao')
                    .select('*')
                    .eq('id', documentoId)
                    .single();

                if (error) throw error;
                if (!documento) throw new Error('Documento não encontrado');

                // Buscar projeto separadamente
                let projeto = null;
                if (documento.projeto_id) {
                    try {
                        const { data: projetoData, error: projetoError } = await supabase
                            .from('projetos')
                            .select('*')
                            .eq('id', documento.projeto_id)
                            .single();
                        
                        if (!projetoError && projetoData) {
                            projeto = projetoData;
                            documento.projeto = projeto;
                        }
                    } catch (e) {
                        console.warn('Erro ao buscar projeto:', e);
                    }
                }

                // Buscar cliente separadamente
                let cliente = null;
                if (documento.cliente_id) {
                    try {
                        const { data: clienteData, error: clienteError } = await supabase
                            .from('clientes')
                            .select('*')
                            .eq('id', documento.cliente_id)
                            .single();
                        
                        if (!clienteError && clienteData) {
                            cliente = clienteData;
                            documento.cliente = cliente;
                        }
                    } catch (e) {
                        console.warn('Erro ao buscar cliente:', e);
                    }
                }

                // Buscar orçamento separadamente se o projeto tiver orcamento_id
                if (projeto && projeto.orcamento_id) {
                    try {
                        const { data: orcamento, error: orcError } = await supabase
                            .from('orcamentos')
                            .select('*')
                            .eq('id', projeto.orcamento_id)
                            .single();
                        
                        if (!orcError && orcamento) {
                            documento.projeto = documento.projeto || {};
                            documento.projeto.orcamento = orcamento;
                        }
                    } catch (e) {
                        console.warn('Erro ao buscar orçamento:', e);
                    }
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const margin = 20;
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                let y = margin;

                // Funções auxiliares
                const formatCurrencyPDF = (value) => {
                    if (!value && value !== 0) return 'R$ 0,00';
                    return new Intl.NumberFormat('pt-BR', {
                        style: 'currency',
                        currency: 'BRL'
                    }).format(value);
                };

                const formatDatePDF = (dateStr) => {
                    if (!dateStr) return '-';
                    try {
                        const date = new Date(dateStr);
                        return date.toLocaleDateString('pt-BR');
                    } catch {
                        return dateStr;
                    }
                };

                // ========== CABEÇALHO ==========
                // Fundo laranja no topo
                doc.setFillColor(255, 102, 0);
                doc.rect(0, 0, pageWidth, 45, 'F');
                
                // Logo (se disponível)
                let logoLoaded = false;
                try {
                    const logoUrl = 'https://zhzhpctsndrcedukivhk.supabase.co/storage/v1/object/public/logo/LOGO%203D%20SEM%20FUNDO%20(1).png';
                    const response = await fetch(logoUrl);
                    if (response.ok) {
                        const blob = await response.blob();
                        const reader = new FileReader();
                        await new Promise((resolve, reject) => {
                            reader.onload = () => resolve(reader.result);
                            reader.onerror = reject;
                            reader.readAsDataURL(blob);
                        });
                        // Logo menor e melhor posicionado
                        doc.addImage(reader.result, 'PNG', margin, 8, 50, 20);
                        logoLoaded = true;
                    }
                } catch (e) {
                    console.warn('Erro ao carregar logo:', e);
                }

                // Título
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 255, 255);
                const tituloX = logoLoaded ? margin + 55 : margin;
                doc.text('TERMO DE FINALIZAÇÃO DE PROJETO', tituloX, 20);
                
                // Número e data
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Nº ${documento.numero_documento}`, tituloX, 28);
                doc.text(`Data de Emissão: ${formatDatePDF(documento.data_emissao)}`, tituloX, 35);
                
                y = 55;

                // ========== DADOS DAS PARTES ==========
                // Usar cliente já buscado ou objeto vazio
                const clienteData = documento.cliente || cliente || {};
                doc.setFillColor(255, 102, 0);
                doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('DADOS DAS PARTES', margin + 3, y + 4);
                y += 12;

                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(0, 0, 0);
                
                doc.setFont(undefined, 'bold');
                doc.text('CONTRATANTE (Cliente):', margin, y);
                y += 6;
                doc.setFont(undefined, 'normal');
                doc.text(`Nome: ${clienteData.nome || '-'}`, margin + 5, y);
                y += 6;
                if (clienteData.empresa) {
                    doc.text(`Empresa: ${clienteData.empresa}`, margin + 5, y);
                    y += 6;
                }
                if (clienteData.cpf_cnpj) {
                    doc.text(`CPF/CNPJ: ${clienteData.cpf_cnpj}`, margin + 5, y);
                    y += 6;
                }
                if (clienteData.endereco) {
                    let enderecoCompleto = clienteData.endereco;
                    if (clienteData.cidade) enderecoCompleto += `, ${clienteData.cidade}`;
                    if (clienteData.estado) enderecoCompleto += ` - ${clienteData.estado}`;
                    doc.text(`Endereço: ${enderecoCompleto}`, margin + 5, y);
                    y += 6;
                }
                if (clienteData.email) {
                    doc.text(`Email: ${clienteData.email}`, margin + 5, y);
                    y += 6;
                }
                if (clienteData.telefone || clienteData.whatsapp) {
                    doc.text(`Telefone: ${clienteData.telefone || clienteData.whatsapp || '-'}`, margin + 5, y);
                    y += 6;
                }

                y += 5;
                doc.setFont(undefined, 'bold');
                doc.text('CONTRATADO (Empresa):', margin, y);
                y += 6;
                doc.setFont(undefined, 'normal');
                doc.text('Razão Social: Autovizion Comercial', margin + 5, y);
                y += 6;
                doc.text('CNPJ: 12.345.678/0001-90', margin + 5, y);
                y += 6;
                doc.text('Endereço: Bauru/SP', margin + 5, y);
                y += 6;
                doc.text('Email: autovizioncomercial@gmail.com', margin + 5, y);
                y += 6;
                doc.text('Telefone: (14) 99683-3385', margin + 5, y);
                y += 10;

                // ========== INFORMAÇÕES DO PROJETO ==========
                // Usar projeto já buscado ou objeto vazio
                const projetoData = documento.projeto || projeto || {};
                if (y > pageHeight - 60) {
                    doc.addPage();
                    y = margin;
                }

                doc.setFillColor(10, 185, 129);
                doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('INFORMAÇÕES DO PROJETO', margin + 3, y + 4);
                y += 12;

                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(0, 0, 0);
                doc.text(`Nome do Projeto: ${projetoData.nome || '-'}`, margin, y);
                y += 6;
                doc.text(`Data de Início: ${formatDatePDF(projetoData.data_inicio)}`, margin, y);
                y += 6;
                doc.text(`Data de Conclusão: ${formatDatePDF(documento.data_conclusao)}`, margin, y);
                y += 6;
                doc.text(`Valor Total: ${formatCurrencyPDF(documento.valor_total || 0)}`, margin, y);
                y += 10;

                // ========== ENTREGAS ==========
                if (y > pageHeight - 80) {
                    doc.addPage();
                    y = margin;
                }

                doc.setFillColor(59, 130, 246);
                doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('ENTREGAS REALIZADAS', margin + 3, y + 4);
                y += 12;

                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(0, 0, 0);

                const entregas = Array.isArray(documento.entregas) ? documento.entregas : [];
                if (entregas.length === 0) {
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(128, 128, 128);
                    doc.text('Nenhuma entrega cadastrada', margin + 5, y);
                    y += 6;
                } else {
                    entregas.forEach((entrega, index) => {
                        if (y > pageHeight - 30) {
                            doc.addPage();
                            y = margin;
                        }
                        doc.setFont(undefined, 'bold');
                        doc.setTextColor(0, 0, 0);
                        let itemTexto = String(entrega.item || `Item ${index + 1}`).trim();
                        // Garantir que seja texto válido
                        if (!itemTexto) itemTexto = `Item ${index + 1}`;
                        // Adicionar texto diretamente (jsPDF lida bem com UTF-8)
                        doc.text(`[OK] ${itemTexto}`, margin + 5, y);
                        y += 6;
                        if (entrega.descricao && entrega.descricao.trim()) {
                            doc.setFont(undefined, 'normal');
                            let descTexto = String(entrega.descricao).trim();
                            // Normalizar e limpar texto mantendo acentos
                            descTexto = descTexto.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^\w\s\-.,;:!?()áàâãéêíóôõúçÁÀÂÃÉÊÍÓÔÕÚÇ]/gi, ' ').replace(/\s+/g, ' ').trim();
                            if (descTexto) {
                                // Usar splitTextToSize corretamente
                                try {
                                    const maxWidth = pageWidth - (margin * 2) - 10;
                                    const descLines = doc.splitTextToSize(descTexto, maxWidth);
                                    if (Array.isArray(descLines)) {
                                        descLines.forEach(line => {
                                            if (line && String(line).trim()) {
                                                doc.text(String(line).trim(), margin + 10, y);
                                                y += 5;
                                            }
                                        });
                                    } else if (descLines) {
                                        doc.text(String(descLines).trim(), margin + 10, y);
                                        y += 5;
                                    }
                                } catch (e) {
                                    console.warn('Erro ao processar descrição:', e);
                                    // Fallback: adicionar texto direto limitado
                                    const textoLimitado = descTexto.substring(0, 80);
                                    doc.text(textoLimitado, margin + 10, y);
                                    y += 5;
                                }
                            }
                        }
                        y += 3;
                    });
                }
                y += 5;

                // ========== INFORMAÇÕES FINANCEIRAS ==========
                if (y > pageHeight - 60) {
                    doc.addPage();
                    y = margin;
                }

                doc.setFillColor(251, 191, 36);
                doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('INFORMAÇÕES FINANCEIRAS', margin + 3, y + 4);
                y += 12;

                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(0, 0, 0);
                doc.text(`Valor Total do Projeto: ${formatCurrencyPDF(documento.valor_total || 0)}`, margin, y);
                y += 6;
                doc.text(`Valor Pago: ${formatCurrencyPDF(documento.valor_pago || 0)}`, margin, y);
                y += 6;
                doc.text(`Valor Pendente: ${formatCurrencyPDF(documento.valor_pendente || 0)}`, margin, y);
                y += 6;
                
                // Formas de pagamento
                if (documento.formas_pagamento && documento.formas_pagamento.trim()) {
                    doc.setFont(undefined, 'bold');
                    doc.text('Formas de Pagamento:', margin, y);
                    y += 6;
                    doc.setFont(undefined, 'normal');
                    const formasPagamento = documento.formas_pagamento.split(',').map(f => f.trim()).filter(f => f);
                    formasPagamento.forEach(forma => {
                        doc.text(`• ${forma}`, margin + 5, y);
                        y += 5;
                    });
                }
                y += 5;

                // ========== GARANTIA E SUPORTE ==========
                if (y > pageHeight - 50) {
                    doc.addPage();
                    y = margin;
                }

                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('GARANTIA E SUPORTE:', margin, y);
                y += 6;
                doc.setFont(undefined, 'normal');
                doc.text(`Período de Garantia: ${documento.garantia_dias || 30} dias`, margin + 5, y);
                y += 6;
                if (documento.suporte_incluso) {
                    doc.text(`Suporte Incluído: Sim (${documento.suporte_dias || 30} dias)`, margin + 5, y);
                    y += 6;
                } else {
                    doc.text('Suporte Incluído: Não', margin + 5, y);
                    y += 6;
                }
                y += 5;

                // ========== OBSERVAÇÕES E CONDIÇÕES COMERCIAIS ==========
                // projeto já foi declarado acima
                const orcamento = projeto.orcamento || {};
                
                // Observações do documento
                if (documento.observacoes) {
                    if (y > pageHeight - 50) {
                        doc.addPage();
                        y = margin;
                    }

                    doc.setFillColor(45, 45, 45);
                    doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(255, 255, 255);
                    doc.text('OBSERVAÇÕES', margin + 3, y + 4);
                    y += 12;

                    doc.setFontSize(9);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(0, 0, 0);
                    const obsLines = doc.splitTextToSize(documento.observacoes, pageWidth - (margin * 2));
                    doc.text(obsLines, margin, y);
                    y += obsLines.length * 4 + 5;
                }

                // Observações do orçamento (se houver)
                if (orcamentoData.observacoes) {
                    let obsOrcamento = orcamentoData.observacoes;
                    // Extrair condições comerciais se estiverem nas observações
                    if (obsOrcamento.includes('=== CONDIÇÕES COMERCIAIS ===')) {
                        const partes = obsOrcamento.split('=== CONDIÇÕES COMERCIAIS ===');
                        obsOrcamento = partes[0].trim();
                    }
                    
                    if (obsOrcamento.trim()) {
                        if (y > pageHeight - 50) {
                            doc.addPage();
                            y = margin;
                        }

                        doc.setFillColor(245, 245, 245);
                        doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                        doc.setFontSize(11);
                        doc.setFont(undefined, 'bold');
                        doc.setTextColor(0, 0, 0);
                        doc.text('OBSERVAÇÕES DO ORÇAMENTO', margin + 3, y + 4);
                        y += 12;

                        doc.setFontSize(9);
                        doc.setFont(undefined, 'normal');
                        const obsOrcLines = doc.splitTextToSize(obsOrcamento, pageWidth - (margin * 2));
                        doc.text(obsOrcLines, margin, y);
                        y += obsOrcLines.length * 4 + 5;
                    }
                }

                // Condições Comerciais do Orçamento
                if (orcamentoData.observacoes && orcamentoData.observacoes.includes('=== CONDIÇÕES COMERCIAIS ===')) {
                    if (y > pageHeight - 60) {
                        doc.addPage();
                        y = margin;
                    }

                    doc.setFillColor(255, 102, 0);
                    doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(255, 255, 255);
                    doc.text('CONDIÇÕES COMERCIAIS', margin + 3, y + 4);
                    y += 12;

                    doc.setFontSize(9);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(0, 0, 0);
                    
                    const partes = orcamentoData.observacoes.split('=== CONDIÇÕES COMERCIAIS ===');
                    const condicoesTexto = partes[1] || '';
                    
                    // Extrair informações específicas
                    const matchCondicoes = condicoesTexto.match(/Condições de Pagamento:\s*(.+?)(?:\n|$)/i);
                    const matchForma = condicoesTexto.match(/Forma de Pagamento:\s*(.+?)(?:\n|$)/i);
                    const matchPrazo = condicoesTexto.match(/Prazo de Entrega:\s*(.+?)(?:\n|$)/i);
                    
                    if (matchCondicoes) {
                        doc.setFont(undefined, 'bold');
                        doc.text('Condições de Pagamento:', margin, y);
                        y += 5;
                        doc.setFont(undefined, 'normal');
                        const condLines = doc.splitTextToSize(matchCondicoes[1].trim(), pageWidth - (margin * 2));
                        doc.text(condLines, margin + 5, y);
                        y += condLines.length * 4 + 3;
                    }
                    
                    if (matchForma) {
                        doc.setFont(undefined, 'bold');
                        doc.text('Forma de Pagamento:', margin, y);
                        y += 5;
                        doc.setFont(undefined, 'normal');
                        doc.text(matchForma[1].trim(), margin + 5, y);
                        y += 5;
                    }
                    
                    if (matchPrazo) {
                        doc.setFont(undefined, 'bold');
                        doc.text('Prazo de Entrega:', margin, y);
                        y += 5;
                        doc.setFont(undefined, 'normal');
                        doc.text(matchPrazo[1].trim(), margin + 5, y);
                        y += 5;
                    }
                    
                    // Se não encontrou padrão, mostrar texto completo
                    if (!matchCondicoes && !matchForma && !matchPrazo && condicoesTexto.trim()) {
                        const condLines = doc.splitTextToSize(condicoesTexto.trim(), pageWidth - (margin * 2));
                        doc.text(condLines, margin, y);
                        y += condLines.length * 4;
                    }
                    
                    y += 5;
                }

                // Termos e Condições do Documento
                if (documento.termos_condicoes) {
                    if (y > pageHeight - 60) {
                        doc.addPage();
                        y = margin;
                    }

                    doc.setFillColor(45, 45, 45);
                    doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(255, 255, 255);
                    doc.text('TERMOS E CONDIÇÕES', margin + 3, y + 4);
                    y += 12;

                    doc.setFontSize(9);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(0, 0, 0);
                    const termosLines = doc.splitTextToSize(documento.termos_condicoes, pageWidth - (margin * 2));
                    doc.text(termosLines, margin, y);
                    y += termosLines.length * 4 + 5;
                }

                // ========== ASSINATURAS ==========
                if (y > pageHeight - 50) {
                    doc.addPage();
                    y = margin;
                }

                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('ASSINATURAS:', margin, y);
                y += 15;

                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                doc.text('_________________________', margin, y);
                doc.text('Cliente', margin, y + 6);
                doc.text(`${clienteData.nome || 'Nome do Cliente'}`, margin, y + 12);
                doc.text(`Data: ${formatDatePDF(documento.data_conclusao)}`, margin, y + 18);

                doc.text('_________________________', pageWidth - margin - 60, y);
                doc.text('Responsável', pageWidth - margin - 60, y + 6);
                doc.text('Autovizion Comercial', pageWidth - margin - 60, y + 12);
                doc.text(`Data: ${formatDatePDF(documento.data_emissao)}`, pageWidth - margin - 60, y + 18);

                // ========== RODAPÉ ==========
                const contatoY = pageHeight - 8;
                doc.setFontSize(7);
                doc.setTextColor(128, 128, 128);
                doc.setFont(undefined, 'normal');
                doc.text('AUTOVIZION', margin, contatoY);
                doc.text('|', margin + 25, contatoY);
                doc.text('www.autovizon.com.br', margin + 30, contatoY);
                doc.text('|', margin + 70, contatoY);
                doc.text('autovizioncomercial@gmail.com', margin + 75, contatoY);
                doc.text('|', margin + 130, contatoY);
                doc.text('(14) 99683-3385', margin + 135, contatoY);

                // Salvar PDF
                const clienteNome = cliente.nome || cliente.empresa || 'Cliente';
                const dataFormatada = formatDatePDF(documento.data_conclusao).replace(/\//g, '_');
                const fileName = `Documento_Finalizacao_${clienteNome.replace(/[^a-zA-Z0-9]/g, '_')}_${dataFormatada}.pdf`;
                doc.save(fileName);

                // Upload para Supabase Storage (opcional)
                try {
                    const pdfBlob = doc.output('blob');
                    const fileNameStorage = `documentos-finalizacao/${documentoId}.pdf`;
                    
                    const { error: uploadError } = await supabase.storage
                        .from('pdfs-temporarios')
                        .upload(fileNameStorage, pdfBlob, {
                            contentType: 'application/pdf',
                            upsert: true
                        });

                    if (!uploadError) {
                        const { data: { publicUrl } } = supabase.storage
                            .from('pdfs-temporarios')
                            .getPublicUrl(fileNameStorage);

                        // Atualizar documento com URL do PDF
                        await supabase
                            .from('documentos_finalizacao')
                            .update({ pdf_url: publicUrl, status: 'enviado' })
                            .eq('id', documentoId);
                    }
                } catch (e) {
                    console.warn('Erro ao fazer upload do PDF:', e);
                }

            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                alert('Erro ao gerar PDF: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // Enviar documento por WhatsApp
        async function enviarDocumentoFinalizacaoWhatsApp(documentoId) {
            try {
                const { data: documento, error } = await supabase
                    .from('documentos_finalizacao')
                    .select(`
                        *,
                        cliente:clientes(*)
                    `)
                    .eq('id', documentoId)
                    .single();

                if (error) throw error;
                if (!documento) {
                    alert('Documento não encontrado');
                    return;
                }

                const cliente = documento.cliente || {};
                const whatsapp = cliente.whatsapp || cliente.telefone || '';
                
                if (!whatsapp) {
                    alert('Cliente não possui WhatsApp cadastrado');
                    return;
                }

                // Limpar formatação do WhatsApp
                const whatsappLimpo = whatsapp.replace(/\D/g, '');
                
                // Mensagem
                const mensagem = `Olá ${cliente.nome || 'Cliente'}! 🎉

Seu projeto foi finalizado com sucesso!

Segue o documento de finalização com todas as entregas e informações:

${documento.pdf_url || 'PDF será gerado em breve'}

Por favor, confirme o recebimento e, se possível, assine o documento.

Obrigado pela confiança! 🙏`;

                // Abrir WhatsApp
                const url = `https://wa.me/55${whatsappLimpo}?text=${encodeURIComponent(mensagem)}`;
                window.open(url, '_blank');
            } catch (error) {
                console.error('Erro ao enviar por WhatsApp:', error);
                alert('Erro ao enviar por WhatsApp: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // Preview do documento
        async function previewDocumentoFinalizacao() {
            const entregas = coletarEntregas();
            if (entregas.length === 0) {
                alert('Adicione pelo menos uma entrega!');
                return;
            }

            // Criar documento temporário para preview
            const tempData = {
                numero_documento: document.getElementById('documentoFinalizacaoNumero').value,
                data_emissao: new Date().toISOString().split('T')[0],
                data_conclusao: document.getElementById('documentoFinalizacaoDataConclusao').value,
                entregas: entregas,
                valor_total: document.getElementById('documentoFinalizacaoValorTotal').value ? parseFloat(document.getElementById('documentoFinalizacaoValorTotal').value) : null,
                valor_pago: document.getElementById('documentoFinalizacaoValorPago').value ? parseFloat(document.getElementById('documentoFinalizacaoValorPago').value) : null,
                garantia_dias: parseInt(document.getElementById('documentoFinalizacaoGarantia').value) || 30,
                suporte_incluso: document.getElementById('documentoFinalizacaoSuporteIncluso').value === 'true',
                suporte_dias: document.getElementById('documentoFinalizacaoSuporteDias').value ? parseInt(document.getElementById('documentoFinalizacaoSuporteDias').value) : null,
                observacoes: document.getElementById('documentoFinalizacaoObservacoes').value.trim() || null,
                termos_condicoes: document.getElementById('documentoFinalizacaoTermos').value.trim() || null
            };

            // Buscar dados do projeto e cliente
            const projetoId = document.getElementById('documentoFinalizacaoProjetoId').value;
            const clienteId = document.getElementById('documentoFinalizacaoClienteId').value;

            try {
                const [projetoResult, clienteResult] = await Promise.all([
                    supabase.from('projetos').select('*').eq('id', projetoId).single(),
                    supabase.from('clientes').select('*').eq('id', clienteId).single()
                ]);

                tempData.projeto = projetoResult.data || {};
                tempData.cliente = clienteResult.data || {};

                // Buscar orçamento se houver
                if (tempData.projeto.orcamento_id) {
                    try {
                        const { data: orcamentoData } = await supabase
                            .from('orcamentos')
                            .select('*')
                            .eq('id', tempData.projeto.orcamento_id)
                            .single();
                        if (orcamentoData) {
                            tempData.projeto.orcamento = orcamentoData;
                        }
                    } catch (e) {
                        console.warn('Erro ao buscar orçamento:', e);
                    }
                }

                // Adicionar formas de pagamento ao tempData
                const formasPagamento = document.getElementById('documentoFinalizacaoFormasPagamento').value.trim();
                if (formasPagamento) {
                    tempData.formas_pagamento = formasPagamento;
                }

                // Calcular valor pendente
                if (tempData.valor_total && tempData.valor_pago) {
                    tempData.valor_pendente = Math.max(0, tempData.valor_total - tempData.valor_pago);
                }

                // Gerar PDF temporário
                if (!window.jspdf) {
                    alert('Biblioteca de PDF não carregada.');
                    return;
                }

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Usar tempData como documento para o PDF
                const documento = tempData;
                
                const margin = 20;
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                let y = margin;

                // Funções auxiliares
                const formatCurrencyPDF = (value) => {
                    if (!value && value !== 0) return 'R$ 0,00';
                    return new Intl.NumberFormat('pt-BR', {
                        style: 'currency',
                        currency: 'BRL'
                    }).format(value);
                };

                const formatDatePDF = (dateStr) => {
                    if (!dateStr) return '-';
                    try {
                        const date = new Date(dateStr);
                        return date.toLocaleDateString('pt-BR');
                    } catch {
                        return dateStr;
                    }
                };

                // ========== CABEÇALHO ==========
                // Fundo laranja no topo
                doc.setFillColor(255, 102, 0);
                doc.rect(0, 0, pageWidth, 45, 'F');
                
                // Logo (se disponível)
                let logoLoaded = false;
                try {
                    const logoUrl = 'https://zhzhpctsndrcedukivhk.supabase.co/storage/v1/object/public/logo/LOGO%203D%20SEM%20FUNDO%20(1).png';
                    const response = await fetch(logoUrl);
                    if (response.ok) {
                        const blob = await response.blob();
                        const reader = new FileReader();
                        await new Promise((resolve, reject) => {
                            reader.onload = () => resolve(reader.result);
                            reader.onerror = reject;
                            reader.readAsDataURL(blob);
                        });
                        // Logo menor e melhor posicionado
                        doc.addImage(reader.result, 'PNG', margin, 8, 50, 20);
                        logoLoaded = true;
                    }
                } catch (e) {
                    console.warn('Erro ao carregar logo:', e);
                }

                // Título
                doc.setFontSize(18);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 255, 255);
                const tituloX = logoLoaded ? margin + 55 : margin;
                doc.text('TERMO DE FINALIZAÇÃO DE PROJETO', tituloX, 20);
                
                // Número e data
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.text(`Nº ${documento.numero_documento || '0001/2024'}`, tituloX, 28);
                doc.text(`Data de Emissão: ${formatDatePDF(documento.data_emissao)}`, tituloX, 35);
                
                y = 55;

                // ========== DADOS DAS PARTES ==========
                // Usar cliente já buscado ou objeto vazio
                const clienteData = documento.cliente || cliente || {};
                doc.setFillColor(255, 102, 0);
                doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('DADOS DAS PARTES', margin + 3, y + 4);
                y += 12;

                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(0, 0, 0);
                
                doc.setFont(undefined, 'bold');
                doc.text('CONTRATANTE (Cliente):', margin, y);
                y += 6;
                doc.setFont(undefined, 'normal');
                doc.text(`Nome: ${clienteData.nome || '-'}`, margin + 5, y);
                y += 6;
                if (clienteData.empresa) {
                    doc.text(`Empresa: ${clienteData.empresa}`, margin + 5, y);
                    y += 6;
                }
                if (clienteData.cpf_cnpj) {
                    doc.text(`CPF/CNPJ: ${clienteData.cpf_cnpj}`, margin + 5, y);
                    y += 6;
                }
                if (clienteData.endereco) {
                    let enderecoCompleto = clienteData.endereco;
                    if (clienteData.cidade) enderecoCompleto += `, ${clienteData.cidade}`;
                    if (clienteData.estado) enderecoCompleto += ` - ${clienteData.estado}`;
                    doc.text(`Endereço: ${enderecoCompleto}`, margin + 5, y);
                    y += 6;
                }
                if (clienteData.email) {
                    doc.text(`Email: ${clienteData.email}`, margin + 5, y);
                    y += 6;
                }
                if (clienteData.telefone || clienteData.whatsapp) {
                    doc.text(`Telefone: ${clienteData.telefone || clienteData.whatsapp || '-'}`, margin + 5, y);
                    y += 6;
                }

                y += 5;
                doc.setFont(undefined, 'bold');
                doc.text('CONTRATADO (Empresa):', margin, y);
                y += 6;
                doc.setFont(undefined, 'normal');
                doc.text('Razão Social: Autovizion Comercial', margin + 5, y);
                y += 6;
                doc.text('CNPJ: 12.345.678/0001-90', margin + 5, y);
                y += 6;
                doc.text('Endereço: Bauru/SP', margin + 5, y);
                y += 6;
                doc.text('Email: autovizioncomercial@gmail.com', margin + 5, y);
                y += 6;
                doc.text('Telefone: (14) 99683-3385', margin + 5, y);
                y += 10;

                // ========== INFORMAÇÕES DO PROJETO ==========
                // Usar projeto já buscado ou objeto vazio
                const projetoData = documento.projeto || projeto || {};
                if (y > pageHeight - 60) {
                    doc.addPage();
                    y = margin;
                }

                doc.setFillColor(10, 185, 129);
                doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('INFORMAÇÕES DO PROJETO', margin + 3, y + 4);
                y += 12;

                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(0, 0, 0);
                doc.text(`Nome do Projeto: ${projetoData.nome || '-'}`, margin, y);
                y += 6;
                doc.text(`Data de Início: ${formatDatePDF(projetoData.data_inicio)}`, margin, y);
                y += 6;
                doc.text(`Data de Conclusão: ${formatDatePDF(documento.data_conclusao)}`, margin, y);
                y += 6;
                doc.text(`Valor Total: ${formatCurrencyPDF(documento.valor_total || 0)}`, margin, y);
                y += 10;

                // ========== ENTREGAS ==========
                if (y > pageHeight - 80) {
                    doc.addPage();
                    y = margin;
                }

                doc.setFillColor(59, 130, 246);
                doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('ENTREGAS REALIZADAS', margin + 3, y + 4);
                y += 12;

                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(0, 0, 0);

                const entregas = Array.isArray(documento.entregas) ? documento.entregas : [];
                if (entregas.length === 0) {
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(128, 128, 128);
                    doc.text('Nenhuma entrega cadastrada', margin + 5, y);
                    y += 6;
                } else {
                    entregas.forEach((entrega, index) => {
                        if (y > pageHeight - 30) {
                            doc.addPage();
                            y = margin;
                        }
                        doc.setFont(undefined, 'bold');
                        doc.setTextColor(0, 0, 0);
                        let itemTexto = String(entrega.item || `Item ${index + 1}`).trim();
                        if (!itemTexto) itemTexto = `Item ${index + 1}`;
                        doc.text(`[OK] ${itemTexto}`, margin + 5, y);
                        y += 6;
                        if (entrega.descricao && entrega.descricao.trim()) {
                            doc.setFont(undefined, 'normal');
                            let descTexto = String(entrega.descricao).trim();
                            descTexto = descTexto.normalize('NFD').replace(/[\u0300-\u036f]/g, '').replace(/[^\w\s\-.,;:!?()áàâãéêíóôõúçÁÀÂÃÉÊÍÓÔÕÚÇ]/gi, ' ').replace(/\s+/g, ' ').trim();
                            if (descTexto) {
                                try {
                                    const maxWidth = pageWidth - (margin * 2) - 10;
                                    const descLines = doc.splitTextToSize(descTexto, maxWidth);
                                    if (Array.isArray(descLines)) {
                                        descLines.forEach(line => {
                                            if (line && String(line).trim()) {
                                                doc.text(String(line).trim(), margin + 10, y);
                                                y += 5;
                                            }
                                        });
                                    } else if (descLines) {
                                        doc.text(String(descLines).trim(), margin + 10, y);
                                        y += 5;
                                    }
                                } catch (e) {
                                    console.warn('Erro ao processar descrição:', e);
                                    const textoLimitado = descTexto.substring(0, 80);
                                    doc.text(textoLimitado, margin + 10, y);
                                    y += 5;
                                }
                            }
                        }
                        y += 3;
                    });
                }
                y += 5;

                // ========== INFORMAÇÕES FINANCEIRAS ==========
                if (y > pageHeight - 60) {
                    doc.addPage();
                    y = margin;
                }

                doc.setFillColor(251, 191, 36);
                doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('INFORMAÇÕES FINANCEIRAS', margin + 3, y + 4);
                y += 12;

                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(0, 0, 0);
                doc.text(`Valor Total do Projeto: ${formatCurrencyPDF(documento.valor_total || 0)}`, margin, y);
                y += 6;
                doc.text(`Valor Pago: ${formatCurrencyPDF(documento.valor_pago || 0)}`, margin, y);
                y += 6;
                doc.text(`Valor Pendente: ${formatCurrencyPDF(documento.valor_pendente || 0)}`, margin, y);
                y += 6;
                
                // Formas de pagamento
                if (documento.formas_pagamento && documento.formas_pagamento.trim()) {
                    doc.setFont(undefined, 'bold');
                    doc.text('Formas de Pagamento:', margin, y);
                    y += 6;
                    doc.setFont(undefined, 'normal');
                    const formasPagamento = documento.formas_pagamento.split(',').map(f => f.trim()).filter(f => f);
                    formasPagamento.forEach(forma => {
                        doc.text(`• ${forma}`, margin + 5, y);
                        y += 5;
                    });
                }
                y += 5;

                // ========== GARANTIA E SUPORTE ==========
                if (y > pageHeight - 50) {
                    doc.addPage();
                    y = margin;
                }

                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('GARANTIA E SUPORTE:', margin, y);
                y += 6;
                doc.setFont(undefined, 'normal');
                doc.text(`Período de Garantia: ${documento.garantia_dias || 30} dias`, margin + 5, y);
                y += 6;
                if (documento.suporte_incluso) {
                    doc.text(`Suporte Incluído: Sim (${documento.suporte_dias || 30} dias)`, margin + 5, y);
                    y += 6;
                } else {
                    doc.text('Suporte Incluído: Não', margin + 5, y);
                    y += 6;
                }
                y += 5;

                // ========== OBSERVAÇÕES E CONDIÇÕES COMERCIAIS ==========
                const orcamentoData = projetoData?.orcamento || {};
                
                // Observações do documento
                if (documento.observacoes) {
                    if (y > pageHeight - 50) {
                        doc.addPage();
                        y = margin;
                    }

                    doc.setFillColor(45, 45, 45);
                    doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(255, 255, 255);
                    doc.text('OBSERVAÇÕES', margin + 3, y + 4);
                    y += 12;

                    doc.setFontSize(9);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(0, 0, 0);
                    const obsLines = doc.splitTextToSize(documento.observacoes, pageWidth - (margin * 2));
                    doc.text(obsLines, margin, y);
                    y += obsLines.length * 4 + 5;
                }

                // Observações do orçamento (se houver)
                if (orcamentoData.observacoes) {
                    let obsOrcamento = orcamentoData.observacoes;
                    if (obsOrcamento.includes('=== CONDIÇÕES COMERCIAIS ===')) {
                        const partes = obsOrcamento.split('=== CONDIÇÕES COMERCIAIS ===');
                        obsOrcamento = partes[0].trim();
                    }
                    
                    if (obsOrcamento.trim()) {
                        if (y > pageHeight - 50) {
                            doc.addPage();
                            y = margin;
                        }

                        doc.setFillColor(245, 245, 245);
                        doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                        doc.setFontSize(11);
                        doc.setFont(undefined, 'bold');
                        doc.setTextColor(0, 0, 0);
                        doc.text('OBSERVAÇÕES DO ORÇAMENTO', margin + 3, y + 4);
                        y += 12;

                        doc.setFontSize(9);
                        doc.setFont(undefined, 'normal');
                        const obsOrcLines = doc.splitTextToSize(obsOrcamento, pageWidth - (margin * 2));
                        doc.text(obsOrcLines, margin, y);
                        y += obsOrcLines.length * 4 + 5;
                    }
                }

                // Condições Comerciais do Orçamento
                if (orcamentoData.observacoes && orcamentoData.observacoes.includes('=== CONDIÇÕES COMERCIAIS ===')) {
                    if (y > pageHeight - 60) {
                        doc.addPage();
                        y = margin;
                    }

                    doc.setFillColor(255, 102, 0);
                    doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(255, 255, 255);
                    doc.text('CONDIÇÕES COMERCIAIS', margin + 3, y + 4);
                    y += 12;

                    doc.setFontSize(9);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(0, 0, 0);
                    
                    const partes = orcamentoData.observacoes.split('=== CONDIÇÕES COMERCIAIS ===');
                    const condicoesTexto = partes[1] || '';
                    
                    const matchCondicoes = condicoesTexto.match(/Condições de Pagamento:\s*(.+?)(?:\n|$)/i);
                    const matchForma = condicoesTexto.match(/Forma de Pagamento:\s*(.+?)(?:\n|$)/i);
                    const matchPrazo = condicoesTexto.match(/Prazo de Entrega:\s*(.+?)(?:\n|$)/i);
                    
                    if (matchCondicoes) {
                        doc.setFont(undefined, 'bold');
                        doc.text('Condições de Pagamento:', margin, y);
                        y += 5;
                        doc.setFont(undefined, 'normal');
                        const condLines = doc.splitTextToSize(matchCondicoes[1].trim(), pageWidth - (margin * 2));
                        doc.text(condLines, margin + 5, y);
                        y += condLines.length * 4 + 3;
                    }
                    
                    if (matchForma) {
                        doc.setFont(undefined, 'bold');
                        doc.text('Forma de Pagamento:', margin, y);
                        y += 5;
                        doc.setFont(undefined, 'normal');
                        doc.text(matchForma[1].trim(), margin + 5, y);
                        y += 5;
                    }
                    
                    if (matchPrazo) {
                        doc.setFont(undefined, 'bold');
                        doc.text('Prazo de Entrega:', margin, y);
                        y += 5;
                        doc.setFont(undefined, 'normal');
                        doc.text(matchPrazo[1].trim(), margin + 5, y);
                        y += 5;
                    }
                    
                    if (!matchCondicoes && !matchForma && !matchPrazo && condicoesTexto.trim()) {
                        const condLines = doc.splitTextToSize(condicoesTexto.trim(), pageWidth - (margin * 2));
                        doc.text(condLines, margin, y);
                        y += condLines.length * 4;
                    }
                    
                    y += 5;
                }

                // Termos e Condições do Documento
                if (documento.termos_condicoes) {
                    if (y > pageHeight - 60) {
                        doc.addPage();
                        y = margin;
                    }

                    doc.setFillColor(45, 45, 45);
                    doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(255, 255, 255);
                    doc.text('TERMOS E CONDIÇÕES', margin + 3, y + 4);
                    y += 12;

                    doc.setFontSize(9);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(0, 0, 0);
                    const termosLines = doc.splitTextToSize(documento.termos_condicoes, pageWidth - (margin * 2));
                    doc.text(termosLines, margin, y);
                    y += termosLines.length * 4 + 5;
                }

                // ========== ASSINATURAS ==========
                if (y > pageHeight - 50) {
                    doc.addPage();
                    y = margin;
                }

                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('ASSINATURAS:', margin, y);
                y += 15;

                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                doc.text('_________________________', margin, y);
                doc.text('Cliente', margin, y + 6);
                doc.text(`${clienteData.nome || 'Nome do Cliente'}`, margin, y + 12);
                doc.text(`Data: ${formatDatePDF(documento.data_conclusao)}`, margin, y + 18);

                doc.text('_________________________', pageWidth - margin - 60, y);
                doc.text('Responsável', pageWidth - margin - 60, y + 6);
                doc.text('Autovizion Comercial', pageWidth - margin - 60, y + 12);
                doc.text(`Data: ${formatDatePDF(documento.data_emissao)}`, pageWidth - margin - 60, y + 18);

                // ========== RODAPÉ ==========
                const contatoY = pageHeight - 8;
                doc.setFontSize(7);
                doc.setTextColor(128, 128, 128);
                doc.setFont(undefined, 'normal');
                doc.text('AUTOVIZION', margin, contatoY);
                doc.text('|', margin + 25, contatoY);
                doc.text('www.autovizon.com.br', margin + 30, contatoY);
                doc.text('|', margin + 70, contatoY);
                doc.text('autovizioncomercial@gmail.com', margin + 75, contatoY);
                doc.text('|', margin + 130, contatoY);
                doc.text('(14) 99683-3385', margin + 135, contatoY);

                // Abrir PDF em nova aba (preview)
                const pdfBlob = doc.output('blob');
                const pdfUrl = URL.createObjectURL(pdfBlob);
                window.open(pdfUrl, '_blank');
            } catch (error) {
                console.error('Erro no preview:', error);
                alert('Erro ao gerar preview: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // ========== CRUD IDEIAS DE MELHORIAS ==========
        let allIdeias = [];
        let filteredIdeias = [];

        // Carregar ideias do Supabase
        async function loadIdeias() {
            const loading = document.getElementById('ideiasLoading');
            const table = document.getElementById('ideiasTable');
            const empty = document.getElementById('ideiasEmpty');
            
            loading.classList.add('active');
            table.style.display = 'none';
            empty.style.display = 'none';

            try {
                const { data: ideiasData, error } = await supabase
                    .from('ideias_melhorias')
                    .select('*, cliente:clientes(*)')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                allIdeias = ideiasData || [];
                filteredIdeias = [...allIdeias];
                
                // Carregar clientes no filtro
                await loadClientesForIdeiaFilter();
                
                renderIdeias();
            } catch (error) {
                console.error('Erro ao carregar ideias:', error);
                allIdeias = [];
                filteredIdeias = [];
                renderIdeias();
            } finally {
                loading.classList.remove('active');
            }
        }

        // Carregar clientes para o filtro
        async function loadClientesForIdeiaFilter() {
            try {
                const { data: clientes } = await supabase
                    .from('clientes')
                    .select('id, nome, empresa')
                    .order('nome');
                
                const select = document.getElementById('ideiaClienteFilter');
                if (select) {
                    select.innerHTML = '<option value="">Todos os clientes</option>';
                    if (clientes) {
                        clientes.forEach(cliente => {
                            const nome = cliente.nome || cliente.empresa || 'Cliente';
                            const option = document.createElement('option');
                            option.value = cliente.id;
                            option.textContent = nome;
                            select.appendChild(option);
                        });
                    }
                }
            } catch (e) {
                console.warn('Erro ao carregar clientes para filtro:', e);
            }
        }

        // Renderizar tabela de ideias
        function renderIdeias() {
            const tbody = document.getElementById('ideiasTableBody');
            const table = document.getElementById('ideiasTable');
            const empty = document.getElementById('ideiasEmpty');

            if (filteredIdeias.length === 0) {
                table.style.display = 'none';
                empty.style.display = 'block';
                return;
            }

            table.style.display = 'table';
            empty.style.display = 'none';

            tbody.innerHTML = filteredIdeias.map(ideia => {
                const cliente = ideia.cliente || {};
                const clienteNome = cliente.nome || cliente.empresa || 'Cliente não encontrado';
                
                const statusMap = {
                    'nova': { label: 'Nova', class: 'badge-rascunho' },
                    'em_analise': { label: 'Em Análise', class: 'badge-enviado' },
                    'aprovada': { label: 'Aprovada', class: 'badge-aprovado' },
                    'rejeitada': { label: 'Rejeitada', class: 'badge-rejeitado' },
                    'implementada': { label: 'Implementada', class: 'badge-concluido' }
                };

                const prioridadeMap = {
                    'baixa': { label: 'Baixa', class: 'badge-prioridade-baixa' },
                    'media': { label: 'Média', class: 'badge-prioridade-media' },
                    'alta': { label: 'Alta', class: 'badge-prioridade-alta' }
                };

                const status = statusMap[ideia.status] || { label: ideia.status, class: 'badge-rascunho' };
                const prioridade = prioridadeMap[ideia.prioridade] || { label: 'Média', class: 'badge-prioridade-media' };

                return `
                    <tr>
                        <td data-label="Selecionar" style="text-align: center;">
                            <input type="checkbox" class="ideia-checkbox" value="${ideia.id}" onchange="updateIdeiasSelecionadas()" style="width: 18px; height: 18px; cursor: pointer;">
                        </td>
                        <td data-label="Título">
                            <div style="font-weight: 600; margin-bottom: 4px;">${ideia.titulo || '-'}</div>
                            <div style="font-size: 12px; color: var(--text-gray);">${(ideia.descricao || '').substring(0, 60)}${ideia.descricao && ideia.descricao.length > 60 ? '...' : ''}</div>
                        </td>
                        <td data-label="Cliente">${clienteNome}</td>
                        <td data-label="Categoria">${ideia.categoria || '-'}</td>
                        <td data-label="Prioridade">
                            <span class="badge ${prioridade.class}">${prioridade.label}</span>
                        </td>
                        <td data-label="Status">
                            <span class="badge ${status.class}">${status.label}</span>
                        </td>
                        <td data-label="Data">${formatDate(ideia.data_criacao)}</td>
                        <td data-label="Ações">
                            <button class="btn-action" onclick="editIdeia('${ideia.id}')" style="border-color: var(--primary); color: var(--primary); margin-right: 4px;">Editar</button>
                            <button class="btn-action" onclick="deleteIdeia('${ideia.id}')" style="border-color: var(--danger); color: var(--danger);">Excluir</button>
                        </td>
                    </tr>
                `;
            }).join('');
            
            // Atualizar contador após renderizar
            updateIdeiasSelecionadas();
        }

        // Filtrar ideias
        function filterIdeias() {
            const search = document.getElementById('ideiaSearch').value.toLowerCase();
            const clienteFilter = document.getElementById('ideiaClienteFilter').value;
            const statusFilter = document.getElementById('ideiaStatusFilter').value;
            const categoriaFilter = document.getElementById('ideiaCategoriaFilter').value;
            const prioridadeFilter = document.getElementById('ideiaPrioridadeFilter').value;

            filteredIdeias = allIdeias.filter(ideia => {
                const cliente = ideia.cliente || {};
                const clienteNome = (cliente.nome || cliente.empresa || '').toLowerCase();
                const titulo = (ideia.titulo || '').toLowerCase();
                const descricao = (ideia.descricao || '').toLowerCase();
                
                const matchSearch = !search || 
                    titulo.includes(search) ||
                    descricao.includes(search) ||
                    clienteNome.includes(search);
                
                const matchCliente = !clienteFilter || ideia.cliente_id === clienteFilter;
                const matchStatus = !statusFilter || ideia.status === statusFilter;
                const matchCategoria = !categoriaFilter || ideia.categoria === categoriaFilter;
                const matchPrioridade = !prioridadeFilter || ideia.prioridade === prioridadeFilter;
                
                return matchSearch && matchCliente && matchStatus && matchCategoria && matchPrioridade;
            });

            renderIdeias();
        }

        // Abrir modal de ideia (novo)
        async function openIdeiaModal() {
            document.getElementById('ideiaModalTitle').textContent = 'Nova Ideia de Melhoria';
            document.getElementById('ideiaForm').reset();
            document.getElementById('ideiaId').value = '';
            document.getElementById('transformarIdeiaBtn').style.display = 'none';
            
            // Preencher data de criação com hoje
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('ideiaDataCriacao').value = hoje;
            
            // Carregar clientes
            await loadClientesForIdeiaSelect();
            
            const modal = document.getElementById('ideiaModal');
            openModal(modal);
        }

        // Carregar clientes para o select
        async function loadClientesForIdeiaSelect() {
            try {
                const { data: clientes } = await supabase
                    .from('clientes')
                    .select('id, nome, empresa')
                    .order('nome');
                
                const select = document.getElementById('ideiaClienteId');
                if (select) {
                    select.innerHTML = '<option value="">Selecione um cliente</option>';
                    if (clientes) {
                        clientes.forEach(cliente => {
                            const nome = cliente.nome || cliente.empresa || 'Cliente';
                            const option = document.createElement('option');
                            option.value = cliente.id;
                            option.textContent = nome;
                            select.appendChild(option);
                        });
                    }
                }
            } catch (e) {
                console.error('Erro ao carregar clientes:', e);
            }
        }

        // Fechar modal
        function closeIdeiaModal() {
            const modal = document.getElementById('ideiaModal');
            closeModal(modal);
        }

        // Editar ideia
        async function editIdeia(id) {
            const ideia = allIdeias.find(i => i.id === id);
            if (!ideia) return;

            document.getElementById('ideiaModalTitle').textContent = 'Editar Ideia de Melhoria';
            document.getElementById('ideiaId').value = ideia.id;
            document.getElementById('ideiaTitulo').value = ideia.titulo || '';
            document.getElementById('ideiaDescricao').value = ideia.descricao || '';
            document.getElementById('ideiaCategoria').value = ideia.categoria || '';
            document.getElementById('ideiaPrioridade').value = ideia.prioridade || 'media';
            document.getElementById('ideiaStatus').value = ideia.status || 'nova';
            document.getElementById('ideiaObservacoes').value = ideia.observacoes || '';
            document.getElementById('ideiaDataCriacao').value = ideia.data_criacao ? ideia.data_criacao.split('T')[0] : '';
            document.getElementById('ideiaDataImplementacao').value = ideia.data_implementacao ? ideia.data_implementacao.split('T')[0] : '';
            
            // Carregar clientes e selecionar
            await loadClientesForIdeiaSelect();
            document.getElementById('ideiaClienteId').value = ideia.cliente_id || '';
            
            // Mostrar botão de transformar se status for aprovada
            const transformarBtn = document.getElementById('transformarIdeiaBtn');
            if (ideia.status === 'aprovada' && !ideia.orcamento_id && !ideia.projeto_id) {
                transformarBtn.style.display = 'inline-block';
                transformarBtn.onclick = () => transformarIdeiaEmOrcamento(id);
            } else {
                transformarBtn.style.display = 'none';
            }

            const modal = document.getElementById('ideiaModal');
            openModal(modal);
        }

        // Salvar ideia (criar ou atualizar)
        document.getElementById('ideiaForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('ideiaId').value;

            const ideiaData = {
                cliente_id: document.getElementById('ideiaClienteId').value,
                titulo: document.getElementById('ideiaTitulo').value.trim(),
                descricao: document.getElementById('ideiaDescricao').value.trim(),
                categoria: document.getElementById('ideiaCategoria').value || null,
                prioridade: document.getElementById('ideiaPrioridade').value || 'media',
                status: document.getElementById('ideiaStatus').value || 'nova',
                observacoes: document.getElementById('ideiaObservacoes').value.trim() || null,
                data_criacao: document.getElementById('ideiaDataCriacao').value || null,
                data_implementacao: document.getElementById('ideiaDataImplementacao').value || null
            };

            try {
                if (id) {
                    // Atualizar
                    const { error } = await supabase
                        .from('ideias_melhorias')
                        .update(ideiaData)
                        .eq('id', id);

                    if (error) throw error;
                    alert('Ideia atualizada com sucesso!');
                } else {
                    // Criar
                    const { error } = await supabase
                        .from('ideias_melhorias')
                        .insert([ideiaData]);

                    if (error) throw error;
                    alert('Ideia criada com sucesso!');
                }

                closeIdeiaModal();
                loadIdeias();
            } catch (error) {
                console.error('Erro ao salvar ideia:', error);
                alert('Erro ao salvar ideia: ' + (error.message || 'Erro desconhecido'));
            }
        });

        // Excluir ideia
        async function deleteIdeia(id) {
            if (!confirm('Tem certeza que deseja excluir esta ideia?')) return;

            try {
                const { error } = await supabase
                    .from('ideias_melhorias')
                    .delete()
                    .eq('id', id);

                if (error) throw error;
                alert('Ideia excluída com sucesso!');
                loadIdeias();
            } catch (error) {
                console.error('Erro ao excluir ideia:', error);
                alert('Erro ao excluir ideia: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // ========== FUNÇÕES DE SELEÇÃO E PDF ==========
        
        // Selecionar/Desselecionar todas as ideias
        function toggleSelectAllIdeias() {
            const selectAll = document.getElementById('selectAllIdeias');
            const selectAllHeader = document.getElementById('selectAllIdeiasHeader');
            const checkboxes = document.querySelectorAll('.ideia-checkbox');
            
            const isChecked = selectAll ? selectAll.checked : (selectAllHeader ? selectAllHeader.checked : false);
            
            checkboxes.forEach(checkbox => {
                checkbox.checked = isChecked;
            });
            
            if (selectAll) selectAll.checked = isChecked;
            if (selectAllHeader) selectAllHeader.checked = isChecked;
            
            updateIdeiasSelecionadas();
        }

        // Atualizar contador de ideias selecionadas
        function updateIdeiasSelecionadas() {
            const checkboxes = document.querySelectorAll('.ideia-checkbox:checked');
            const count = checkboxes.length;
            const countElement = document.getElementById('ideiasSelecionadasCount');
            const pdfButton = document.getElementById('gerarPdfIdeiasBtn');
            
            if (countElement) {
                countElement.textContent = count > 0 ? `${count} ideia(s) selecionada(s)` : '';
            }
            
            if (pdfButton) {
                pdfButton.style.display = count > 0 ? 'inline-block' : 'none';
            }
            
            // Atualizar estado dos checkboxes "selecionar todas"
            const selectAll = document.getElementById('selectAllIdeias');
            const selectAllHeader = document.getElementById('selectAllIdeiasHeader');
            const allCheckboxes = document.querySelectorAll('.ideia-checkbox');
            const allChecked = allCheckboxes.length > 0 && Array.from(allCheckboxes).every(cb => cb.checked);
            
            if (selectAll) selectAll.checked = allChecked;
            if (selectAllHeader) selectAllHeader.checked = allChecked;
        }

        // Gerar PDF com as ideias selecionadas
        async function gerarPdfIdeias() {
            const checkboxes = document.querySelectorAll('.ideia-checkbox:checked');
            if (checkboxes.length === 0) {
                alert('Selecione pelo menos uma ideia para gerar o PDF');
                return;
            }

            const ideiasIds = Array.from(checkboxes).map(cb => cb.value);
            const ideiasSelecionadas = allIdeias.filter(ideia => ideiasIds.includes(ideia.id));

            if (ideiasSelecionadas.length === 0) {
                alert('Nenhuma ideia encontrada');
                return;
            }

            try {
                // Usar jsPDF
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                // Configurações
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                const margin = 20;
                const maxWidth = pageWidth - (margin * 2);
                let yPos = margin;
                
                // Função para adicionar nova página se necessário
                const checkNewPage = (requiredHeight) => {
                    if (yPos + requiredHeight > pageHeight - margin) {
                        doc.addPage();
                        yPos = margin;
                        return true;
                    }
                    return false;
                };

                // Cabeçalho
                doc.setFontSize(20);
                doc.setTextColor(255, 102, 0); // Cor primária laranja
                doc.text('📋 Relatório de Análises & Ideias', margin, yPos);
                yPos += 15;
                
                doc.setFontSize(10);
                doc.setTextColor(100, 100, 100);
                const dataGeracao = new Date().toLocaleDateString('pt-BR', {
                    day: '2-digit',
                    month: '2-digit',
                    year: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                doc.text(`Gerado em: ${dataGeracao}`, margin, yPos);
                yPos += 10;
                
                doc.text(`Total de ideias: ${ideiasSelecionadas.length}`, margin, yPos);
                yPos += 15;

                // Separador
                doc.setDrawColor(255, 102, 0);
                doc.setLineWidth(0.5);
                doc.line(margin, yPos, pageWidth - margin, yPos);
                yPos += 10;

                // Agrupar por cliente
                const ideiasPorCliente = {};
                ideiasSelecionadas.forEach(ideia => {
                    const cliente = ideia.cliente || {};
                    const clienteNome = cliente.nome || cliente.empresa || 'Sem cliente';
                    if (!ideiasPorCliente[clienteNome]) {
                        ideiasPorCliente[clienteNome] = [];
                    }
                    ideiasPorCliente[clienteNome].push(ideia);
                });

                // Iterar sobre cada cliente
                Object.keys(ideiasPorCliente).forEach((clienteNome, clienteIndex) => {
                    if (clienteIndex > 0) {
                        yPos += 10;
                    }

                    // Título do cliente
                    checkNewPage(20);
                    doc.setFontSize(16);
                    doc.setTextColor(255, 102, 0);
                    doc.setFont(undefined, 'bold');
                    doc.text(`👤 ${clienteNome}`, margin, yPos);
                    yPos += 10;

                    // Ideias do cliente
                    ideiasPorCliente[clienteNome].forEach((ideia, index) => {
                        checkNewPage(40);
                        
                        // Título da ideia
                        doc.setFontSize(12);
                        doc.setTextColor(0, 0, 0);
                        doc.setFont(undefined, 'bold');
                        const tituloLines = doc.splitTextToSize(`${index + 1}. ${ideia.titulo || 'Sem título'}`, maxWidth);
                        doc.text(tituloLines, margin, yPos);
                        yPos += tituloLines.length * 6;

                        // Informações da ideia
                        doc.setFontSize(9);
                        doc.setFont(undefined, 'normal');
                        doc.setTextColor(100, 100, 100);
                        
                        const info = [];
                        if (ideia.categoria) info.push(`Categoria: ${ideia.categoria}`);
                        if (ideia.prioridade) {
                            const prioridadeLabels = { 'baixa': 'Baixa', 'media': 'Média', 'alta': 'Alta' };
                            info.push(`Prioridade: ${prioridadeLabels[ideia.prioridade] || ideia.prioridade}`);
                        }
                        if (ideia.status) {
                            const statusLabels = {
                                'nova': 'Nova',
                                'em_analise': 'Em Análise',
                                'aprovada': 'Aprovada',
                                'rejeitada': 'Rejeitada',
                                'implementada': 'Implementada'
                            };
                            info.push(`Status: ${statusLabels[ideia.status] || ideia.status}`);
                        }
                        if (ideia.data_criacao) {
                            const data = new Date(ideia.data_criacao).toLocaleDateString('pt-BR');
                            info.push(`Data: ${data}`);
                        }
                        
                        if (info.length > 0) {
                            doc.text(info.join(' | '), margin, yPos);
                            yPos += 8;
                        }

                        // Descrição
                        if (ideia.descricao) {
                            checkNewPage(30);
                            doc.setFontSize(10);
                            doc.setTextColor(0, 0, 0);
                            const descLines = doc.splitTextToSize(ideia.descricao, maxWidth);
                            doc.text(descLines, margin, yPos);
                            yPos += descLines.length * 5 + 5;
                        }

                        // Observações
                        if (ideia.observacoes) {
                            checkNewPage(20);
                            doc.setFontSize(9);
                            doc.setTextColor(80, 80, 80);
                            doc.setFont(undefined, 'italic');
                            const obsLines = doc.splitTextToSize(`Observações: ${ideia.observacoes}`, maxWidth);
                            doc.text(obsLines, margin, yPos);
                            yPos += obsLines.length * 4 + 5;
                        }

                        // Separador entre ideias
                        if (index < ideiasPorCliente[clienteNome].length - 1) {
                            yPos += 5;
                            doc.setDrawColor(200, 200, 200);
                            doc.setLineWidth(0.2);
                            doc.line(margin, yPos, pageWidth - margin, yPos);
                            yPos += 10;
                        }
                    });

                    // Separador entre clientes
                    if (clienteIndex < Object.keys(ideiasPorCliente).length - 1) {
                        yPos += 5;
                        doc.setDrawColor(255, 102, 0);
                        doc.setLineWidth(0.5);
                        doc.line(margin, yPos, pageWidth - margin, yPos);
                        yPos += 10;
                    }
                });

                // Rodapé em todas as páginas
                const totalPages = doc.internal.pages.length - 1;
                for (let i = 1; i <= totalPages; i++) {
                    doc.setPage(i);
                    doc.setFontSize(8);
                    doc.setTextColor(150, 150, 150);
                    doc.text(
                        `Página ${i} de ${totalPages}`,
                        pageWidth - margin - 20,
                        pageHeight - 10
                    );
                }

                // Salvar PDF
                const nomeArquivo = `Ideias_${new Date().toISOString().split('T')[0]}.pdf`;
                doc.save(nomeArquivo);
                
                alert(`PDF gerado com sucesso! ${ideiasSelecionadas.length} ideia(s) incluída(s).`);
            } catch (error) {
                console.error('Erro ao gerar PDF:', error);
                alert('Erro ao gerar PDF: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // ========== CRUD TEMPLATES DE MENSAGENS ==========
        let allTemplates = [];
        let filteredTemplates = [];

        // Carregar templates do Supabase
        async function loadTemplates() {
            const loading = document.getElementById('templatesLoading');
            const table = document.getElementById('templatesTable');
            const empty = document.getElementById('templatesEmpty');
            
            // Verificar se os elementos existem
            if (!loading || !table || !empty) {
                console.warn('Elementos da página de templates não encontrados. Tentando novamente...');
                // Tentar novamente após um pequeno delay
                setTimeout(() => {
                    loadTemplates();
                }, 100);
                return;
            }
            
            loading.classList.add('active');
            table.style.display = 'none';
            empty.style.display = 'none';

            try {
                const { data: templatesData, error } = await supabase
                    .from('templates_mensagens')
                    .select('*')
                    .order('nome', { ascending: true });

                if (error) throw error;

                allTemplates = templatesData || [];
                filteredTemplates = [...allTemplates];
                
                renderTemplates();
            } catch (error) {
                console.error('Erro ao carregar templates:', error);
                allTemplates = [];
                filteredTemplates = [];
                renderTemplates();
            } finally {
                loading.classList.remove('active');
            }
        }

        // Renderizar tabela de templates
        function renderTemplates() {
            const tbody = document.getElementById('templatesTableBody');
            const table = document.getElementById('templatesTable');
            const empty = document.getElementById('templatesEmpty');

            // Se os elementos não existem (página não está visível), não renderizar
            if (!tbody || !table || !empty) {
                return;
            }

            if (filteredTemplates.length === 0) {
                table.style.display = 'none';
                empty.style.display = 'block';
                return;
            }

            table.style.display = 'table';
            empty.style.display = 'none';

            tbody.innerHTML = filteredTemplates.map(template => {
                const preview = (template.mensagem || '').substring(0, 80) + ((template.mensagem || '').length > 80 ? '...' : '');
                const statusBadge = template.ativo 
                    ? '<span class="badge badge-aprovado">Ativo</span>'
                    : '<span class="badge badge-rejeitado">Inativo</span>';

                return `
                    <tr>
                        <td data-label="Nome">${template.nome || '-'}</td>
                        <td data-label="Tipo">${template.tipo || '-'}</td>
                        <td data-label="Categoria">${template.categoria || '-'}</td>
                        <td data-label="Mensagem" style="max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            ${preview}
                        </td>
                        <td data-label="Status">${statusBadge}</td>
                        <td data-label="Ações">
                            <button class="btn-action" onclick="editTemplate('${template.id}')" style="border-color: var(--primary); color: var(--primary); margin-right: 4px;">Editar</button>
                            <button class="btn-action" onclick="deleteTemplate('${template.id}')" style="border-color: var(--danger); color: var(--danger);">Excluir</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Filtrar templates
        function filterTemplates() {
            const search = document.getElementById('templateSearch').value.toLowerCase();
            const tipoFilter = document.getElementById('templateTipoFilter').value;
            const categoriaFilter = document.getElementById('templateCategoriaFilter').value;

            filteredTemplates = allTemplates.filter(template => {
                const nome = (template.nome || '').toLowerCase();
                const mensagem = (template.mensagem || '').toLowerCase();
                
                const matchSearch = !search || 
                    nome.includes(search) ||
                    mensagem.includes(search) ||
                    (template.tipo || '').toLowerCase().includes(search) ||
                    (template.categoria || '').toLowerCase().includes(search);
                
                const matchTipo = !tipoFilter || template.tipo === tipoFilter;
                const matchCategoria = !categoriaFilter || template.categoria === categoriaFilter;
                
                return matchSearch && matchTipo && matchCategoria;
            });

            renderTemplates();
        }

        // Abrir modal de template (novo)
        function openTemplateModal() {
            document.getElementById('templateModalTitle').textContent = 'Novo Template';
            document.getElementById('templateForm').reset();
            document.getElementById('templateId').value = '';
            document.getElementById('templateAtivo').checked = true;
            document.getElementById('templateOrdem').value = '0';
            
            const modal = document.getElementById('templateModal');
            openModal(modal);
        }

        // Fechar modal
        function closeTemplateModal() {
            const modal = document.getElementById('templateModal');
            closeModal(modal);
        }

        // Editar template
        function editTemplate(id) {
            const template = allTemplates.find(t => t.id === id);
            if (!template) return;

            document.getElementById('templateModalTitle').textContent = 'Editar Template';
            document.getElementById('templateId').value = template.id;
            document.getElementById('templateNome').value = template.nome || '';
            document.getElementById('templateTipo').value = template.tipo || '';
            document.getElementById('templateCategoria').value = template.categoria || '';
            document.getElementById('templateMensagem').value = template.mensagem || '';
            document.getElementById('templateAtivo').checked = template.ativo !== false;
            const ordemField = document.getElementById('templateOrdem');
            if (ordemField) {
                ordemField.value = template.ordem || 0;
            }

            const modal = document.getElementById('templateModal');
            openModal(modal);
        }

        // Salvar template (criar ou atualizar)
        document.getElementById('templateForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('templateId').value;

            const templateData = {
                nome: document.getElementById('templateNome').value.trim(),
                tipo: document.getElementById('templateTipo').value,
                categoria: document.getElementById('templateCategoria').value || null,
                mensagem: document.getElementById('templateMensagem').value.trim(),
                ativo: document.getElementById('templateAtivo').checked
            };
            
            // Nota: Coluna 'ordem' pode não existir no banco. 
            // Se quiser usar ordenação, execute o SQL: add_coluna_ordem_templates.sql

            try {
                if (id) {
                    // Atualizar
                    const { error } = await supabase
                        .from('templates_mensagens')
                        .update(templateData)
                        .eq('id', id);

                    if (error) throw error;
                    alert('Template atualizado com sucesso!');
                } else {
                    // Criar
                    const { error } = await supabase
                        .from('templates_mensagens')
                        .insert([templateData]);

                    if (error) throw error;
                    alert('Template criado com sucesso!');
                }

                closeTemplateModal();
                loadTemplates();
            } catch (error) {
                console.error('Erro ao salvar template:', error);
                alert('Erro ao salvar template: ' + (error.message || 'Erro desconhecido'));
            }
        });

        // Excluir template
        async function deleteTemplate(id) {
            if (!confirm('Tem certeza que deseja excluir este template?')) return;

            try {
                const { error } = await supabase
                    .from('templates_mensagens')
                    .delete()
                    .eq('id', id);

                if (error) throw error;
                alert('Template excluído com sucesso!');
                loadTemplates();
            } catch (error) {
                console.error('Erro ao excluir template:', error);
                alert('Erro ao excluir template: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // Função para substituir variáveis na mensagem
        function substituirVariaveisTemplate(mensagem, dados) {
            if (!mensagem) return '';
            
            let mensagemFinal = mensagem;
            
            // Variáveis disponíveis
            const variaveis = {
                '*{cliente_nome}*': dados.cliente_nome || dados.cliente?.nome || 'Cliente',
                '*{cliente_empresa}*': dados.cliente_empresa || dados.cliente?.empresa || '',
                '*{projeto_nome}*': dados.projeto_nome || dados.projeto?.nome || '',
                '*{orcamento_numero}*': dados.orcamento_numero || dados.orcamento?.numero || '',
                '*{valor}*': dados.valor ? formatCurrency(dados.valor) : '',
                '*{data_vencimento}*': dados.data_vencimento ? formatDate(dados.data_vencimento) : '',
                '*{COBRANÇA}*': dados.cobranca_texto || '',
                '*{ORÇAMENTO}*': dados.orcamento_texto || '',
                '*{MENSAGEM_PERSONALIZADA}*': dados.mensagem_personalizada || ''
            };
            
            // Substituir todas as variáveis
            Object.keys(variaveis).forEach(variavel => {
                const regex = new RegExp(variavel.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g');
                mensagemFinal = mensagemFinal.replace(regex, variaveis[variavel]);
            });
            
            return mensagemFinal;
        }

        // Enviar mensagem WhatsApp com template
        async function enviarWhatsAppComTemplate(templateId, dadosCliente, dadosAdicionais = {}) {
            try {
                // Buscar template
                const template = allTemplates.find(t => t.id === templateId);
                if (!template) {
                    alert('Template não encontrado');
                    return;
                }

                if (!template.ativo) {
                    alert('Este template está inativo');
                    return;
                }

                // Buscar dados do cliente se necessário
                let cliente = dadosCliente;
                if (typeof dadosCliente === 'string') {
                    const { data: clienteData } = await supabase
                        .from('clientes')
                        .select('*')
                        .eq('id', dadosCliente)
                        .single();
                    cliente = clienteData || {};
                }

                // Preparar dados para substituição
                const dados = {
                    cliente: cliente,
                    cliente_nome: cliente?.nome || 'Cliente',
                    cliente_empresa: cliente?.empresa || '',
                    ...dadosAdicionais
                };

                // Substituir variáveis
                const mensagemFinal = substituirVariaveisTemplate(template.mensagem, dados);

                // Obter WhatsApp do cliente
                const whatsapp = cliente?.whatsapp || cliente?.telefone || '';
                if (!whatsapp) {
                    alert('Cliente não possui WhatsApp cadastrado');
                    return;
                }

                // Limpar formatação do WhatsApp
                const whatsappLimpo = whatsapp.replace(/\D/g, '');
                
                // Abrir WhatsApp
                const url = `https://wa.me/55${whatsappLimpo}?text=${encodeURIComponent(mensagemFinal)}`;
                window.open(url, '_blank');
            } catch (error) {
                console.error('Erro ao enviar WhatsApp:', error);
                alert('Erro ao enviar WhatsApp: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // Selecionar template e enviar WhatsApp
        async function selecionarTemplateEEnviar(clienteId, tipoTemplate = null, dadosAdicionais = {}) {
            try {
                // Carregar templates se necessário
                if (allTemplates.length === 0) {
                    await loadTemplates();
                }

                // Filtrar templates por tipo se especificado
                let templatesDisponiveis = allTemplates.filter(t => t.ativo);
                if (tipoTemplate) {
                    templatesDisponiveis = templatesDisponiveis.filter(t => t.tipo === tipoTemplate);
                }

                if (templatesDisponiveis.length === 0) {
                    alert('Nenhum template disponível');
                    return;
                }

                // Buscar dados do cliente
                let cliente = {};
                if (typeof clienteId === 'string') {
                    const { data: clienteData } = await supabase
                        .from('clientes')
                        .select('*')
                        .eq('id', clienteId)
                        .single();
                    cliente = clienteData || {};
                } else {
                    cliente = clienteId;
                }

                // Preparar dados para substituição
                const dados = {
                    cliente: cliente,
                    cliente_nome: cliente?.nome || 'Cliente',
                    cliente_empresa: cliente?.empresa || '',
                    ...dadosAdicionais
                };

                // Criar modal de seleção e edição de template
                const modalDiv = document.createElement('div');
                modalDiv.id = 'selectTemplateModal';
                modalDiv.className = 'modal';
                
                modalDiv.innerHTML = `
                    <div class="modal-content" style="max-width: 700px;">
                        <div class="modal-header">
                            <h2 class="modal-title">Enviar WhatsApp</h2>
                            <button class="btn-close" onclick="fecharModalWhatsApp()">&times;</button>
                        </div>
                        <div style="padding: 20px;">
                            <div class="form-group" style="margin-bottom: 16px;">
                                <label class="form-label">Selecione um Template</label>
                                <select id="templateSelectWhatsApp" class="form-input" onchange="carregarTemplateNoEditor()">
                                    <option value="">Selecione um template...</option>
                                    ${templatesDisponiveis.map(template => {
                                        const nomeEscapado = (template.nome || '').replace(/"/g, '&quot;').replace(/'/g, '&#39;');
                                        return `<option value="${template.id}">${nomeEscapado} (${template.tipo || ''})</option>`;
                                    }).join('')}
                                </select>
                            </div>
                            
                            <div class="form-group" style="margin-bottom: 16px;">
                                <label class="form-label">Mensagem (edite se necessário)</label>
                                <textarea id="mensagemWhatsAppEditor" class="form-input" rows="10" placeholder="Selecione um template ou digite sua mensagem..."></textarea>
                                <small style="color: var(--text-gray); font-size: 12px; margin-top: 4px; display: block;">
                                    💡 Você pode editar a mensagem antes de enviar. Variáveis já foram substituídas automaticamente.
                                </small>
                            </div>

                            <div style="background: rgba(37, 211, 102, 0.1); border: 1px solid rgba(37, 211, 102, 0.3); border-radius: 8px; padding: 12px; margin-bottom: 16px;">
                                <div style="font-size: 12px; color: var(--text-gray);">
                                    <strong>Cliente:</strong> ${cliente?.nome || 'N/A'} ${cliente?.empresa ? '(' + cliente.empresa + ')' : ''}<br>
                                    <strong>WhatsApp:</strong> ${cliente?.whatsapp || cliente?.telefone || 'Não cadastrado'}
                                </div>
                            </div>

                            <div class="modal-actions">
                                <button type="button" class="btn btn-secondary" onclick="fecharModalWhatsApp()">Cancelar</button>
                                <button type="button" class="btn btn-primary" onclick="enviarWhatsAppFinal('${clienteId}')" style="background: #25D366; border-color: #25D366;">
                                    💬 Enviar WhatsApp
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                
                document.body.appendChild(modalDiv);
                
                // Armazenar dados para uso nas funções
                window._whatsappData = {
                    clienteId: clienteId,
                    cliente: cliente,
                    dadosAdicionais: dadosAdicionais,
                    dados: dados
                };
                
                // Abrir modal
                setTimeout(() => {
                    const modalElement = document.getElementById('selectTemplateModal');
                    if (modalElement) {
                        modalElement.classList.add('active');
                        modalElement.style.display = 'block';
                        document.body.classList.add('modal-open');
                    }
                }, 10);
            } catch (error) {
                console.error('Erro ao selecionar template:', error);
                alert('Erro ao selecionar template: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // Carregar template no editor
        function carregarTemplateNoEditor() {
            const select = document.getElementById('templateSelectWhatsApp');
            const editor = document.getElementById('mensagemWhatsAppEditor');
            
            if (!select || !editor) return;
            
            const selectedOption = select.options[select.selectedIndex];
            if (!selectedOption || !selectedOption.value) {
                editor.value = '';
                return;
            }
            
            const templateId = selectedOption.value;
            const template = allTemplates.find(t => t.id === templateId);
            
            if (!template) return;
            
            // Substituir variáveis
            const dados = window._whatsappData?.dados || {};
            const mensagemFinal = substituirVariaveisTemplate(template.mensagem, dados);
            
            editor.value = mensagemFinal;
        }

        // Fechar modal WhatsApp
        function fecharModalWhatsApp() {
            const modal = document.getElementById('selectTemplateModal');
            if (modal) {
                modal.classList.remove('active');
                modal.style.display = 'none';
                setTimeout(() => {
                    modal.remove();
                }, 300);
                document.body.classList.remove('modal-open');
            }
            window._whatsappData = null;
        }

        // Enviar WhatsApp final (com mensagem editada)
        async function enviarWhatsAppFinal(clienteId) {
            try {
                const editor = document.getElementById('mensagemWhatsAppEditor');
                if (!editor) {
                    alert('Editor de mensagem não encontrado');
                    return;
                }
                
                const mensagem = editor.value.trim();
                if (!mensagem) {
                    alert('Digite uma mensagem antes de enviar');
                    return;
                }
                
                // Buscar dados do cliente
                let cliente = window._whatsappData?.cliente;
                if (!cliente) {
                    if (typeof clienteId === 'string') {
                        const { data: clienteData } = await supabase
                            .from('clientes')
                            .select('*')
                            .eq('id', clienteId)
                            .single();
                        cliente = clienteData || {};
                    } else {
                        cliente = clienteId;
                    }
                }

                // Obter WhatsApp do cliente
                const whatsapp = cliente?.whatsapp || cliente?.telefone || '';
                if (!whatsapp) {
                    alert('Cliente não possui WhatsApp cadastrado');
                    return;
                }

                // Limpar formatação do WhatsApp
                const whatsappLimpo = whatsapp.replace(/\D/g, '');
                
                // Abrir WhatsApp com mensagem
                const url = `https://wa.me/55${whatsappLimpo}?text=${encodeURIComponent(mensagem)}`;
                window.open(url, '_blank');
                
                // Fechar modal
                fecharModalWhatsApp();
            } catch (error) {
                console.error('Erro ao enviar WhatsApp:', error);
                alert('Erro ao enviar WhatsApp: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // Transformar ideia em orçamento
        async function transformarIdeiaEmOrcamento(ideiaId) {
            const ideia = allIdeias.find(i => i.id === ideiaId);
            if (!ideia) {
                alert('Ideia não encontrada');
                return;
            }

            if (!ideia.cliente_id) {
                alert('A ideia precisa estar vinculada a um cliente');
                return;
            }

            if (!confirm('Deseja transformar esta ideia em um orçamento?')) return;

            try {
                // Fechar modal de ideia
                closeIdeiaModal();

                // Abrir modal de orçamento preenchido
                document.getElementById('orcamentoModalTitle').textContent = 'Novo Orçamento (da Ideia)';
                document.getElementById('orcamentoForm').reset();
                document.getElementById('orcamentoId').value = '';

                // Preencher dados da ideia
                // Carregar clientes para o select de orçamento (usar função existente ou criar)
                try {
                    const { data: clientes } = await supabase
                        .from('clientes')
                        .select('id, nome, empresa')
                        .order('nome');
                    
                    const select = document.getElementById('orcamentoClienteId');
                    if (select) {
                        select.innerHTML = '<option value="">Selecione um cliente</option>';
                        if (clientes) {
                            clientes.forEach(cliente => {
                                const nome = cliente.nome || cliente.empresa || 'Cliente';
                                const option = document.createElement('option');
                                option.value = cliente.id;
                                option.textContent = nome;
                                select.appendChild(option);
                            });
                        }
                    }
                } catch (e) {
                    console.warn('Erro ao carregar clientes:', e);
                }
                
                document.getElementById('orcamentoClienteId').value = ideia.cliente_id;
                document.getElementById('orcamentoDescricao').value = `Orçamento baseado na ideia: ${ideia.titulo}\n\n${ideia.descricao || ''}`;
                
                if (ideia.observacoes) {
                    const obsAtual = document.getElementById('orcamentoObservacoes').value;
                    document.getElementById('orcamentoObservacoes').value = obsAtual ? `${obsAtual}\n\nIdeia: ${ideia.observacoes}` : `Ideia: ${ideia.observacoes}`;
                }

                // Abrir modal de orçamento
                const modal = document.getElementById('orcamentoModal');
                openModal(modal);

                // Atualizar ideia com referência ao orçamento (será atualizado quando o orçamento for salvo)
                // Isso será feito manualmente ou podemos criar uma função para isso depois
            } catch (error) {
                console.error('Erro ao transformar ideia em orçamento:', error);
                alert('Erro ao transformar ideia: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // ========== INTEGRAÇÃO N8N + WHATSAPP ==========
        
        // Processar comando recebido do n8n
        async function processarComandoN8N(webhookData) {
            try {
                const { from, message, command, data, ai_response } = webhookData;
                
                console.log('📱 Comando recebido do n8n:', { from, command, data });
                
                let resultado = null;
                
                switch (command) {
                    case 'criar_cliente':
                        resultado = await criarClienteViaWhatsApp(data, from);
                        break;
                    
                    case 'consultar_cliente':
                        resultado = await consultarClienteViaWhatsApp(data?.query || message);
                        break;
                    
                    case 'criar_orcamento':
                        resultado = await criarOrcamentoViaWhatsApp(data, from);
                        break;
                    
                    case 'atualizar_projeto':
                        resultado = await atualizarProjetoViaWhatsApp(data);
                        break;
                    
                    case 'listar_projetos':
                        resultado = await listarProjetosViaWhatsApp(data?.status);
                        break;
                    
                    case 'consultar_orcamento':
                        resultado = await consultarOrcamentoViaWhatsApp(data?.query || message);
                        break;
                    
                    default:
                        resultado = {
                            success: false,
                            message: 'Comando não reconhecido',
                            available_commands: [
                                'criar_cliente',
                                'consultar_cliente',
                                'criar_orcamento',
                                'atualizar_projeto',
                                'listar_projetos',
                                'consultar_orcamento'
                            ]
                        };
                }
                
                // Retornar resposta para n8n
                return {
                    success: true,
                    command: command,
                    result: resultado,
                    ai_response: ai_response || resultado.message || 'Comando processado',
                    timestamp: new Date().toISOString()
                };
                
            } catch (error) {
                console.error('❌ Erro ao processar comando n8n:', error);
                return {
                    success: false,
                    error: error.message,
                    timestamp: new Date().toISOString()
                };
            }
        }
        
        // Criar cliente via WhatsApp
        async function criarClienteViaWhatsApp(data, whatsapp) {
            try {
                // Limpar WhatsApp (remover caracteres não numéricos)
                const whatsappLimpo = (whatsapp || data.telefone || '').replace(/\D/g, '');
                
                const clienteData = {
                    nome: data.nome || 'Cliente WhatsApp',
                    telefone: data.telefone || whatsappLimpo,
                    whatsapp: whatsappLimpo,
                    email: data.email || null,
                    empresa: data.empresa || null,
                    origem: 'whatsapp',
                    observacoes: data.observacoes || `Cliente criado via WhatsApp em ${new Date().toLocaleString('pt-BR')}`
                };
                
                const { data: cliente, error } = await supabase
                    .from('clientes')
                    .insert([clienteData])
                    .select()
                    .single();
                
                if (error) throw error;
                
                return {
                    success: true,
                    message: `Cliente "${cliente.nome}" criado com sucesso!`,
                    data: cliente
                };
                
            } catch (error) {
                console.error('Erro ao criar cliente via WhatsApp:', error);
                return {
                    success: false,
                    message: 'Erro ao criar cliente: ' + error.message,
                    error: error.message
                };
            }
        }
        
        // Consultar cliente via WhatsApp
        async function consultarClienteViaWhatsApp(query) {
            try {
                const queryLower = query.toLowerCase();
                
                // Buscar por nome, telefone ou WhatsApp
                const { data: clientes, error } = await supabase
                    .from('clientes')
                    .select('*')
                    .or(`nome.ilike.%${query}%,telefone.ilike.%${query}%,whatsapp.ilike.%${query}%,empresa.ilike.%${query}%`)
                    .limit(10);
                
                if (error) throw error;
                
                if (!clientes || clientes.length === 0) {
                    return {
                        success: true,
                        message: 'Nenhum cliente encontrado',
                        data: []
                    };
                }
                
                if (clientes.length === 1) {
                    return {
                        success: true,
                        message: `Cliente encontrado: ${clientes[0].nome}`,
                        data: clientes[0]
                    };
                }
                
                return {
                    success: true,
                    message: `Encontrados ${clientes.length} clientes`,
                    data: clientes.map(c => ({
                        id: c.id,
                        nome: c.nome,
                        empresa: c.empresa,
                        telefone: c.telefone,
                        whatsapp: c.whatsapp
                    }))
                };
                
            } catch (error) {
                console.error('Erro ao consultar cliente:', error);
                return {
                    success: false,
                    message: 'Erro ao consultar cliente: ' + error.message
                };
            }
        }
        
        // Criar orçamento via WhatsApp
        async function criarOrcamentoViaWhatsApp(data, whatsapp) {
            try {
                // Primeiro, encontrar ou criar cliente
                let clienteId = data.cliente_id;
                
                if (!clienteId && whatsapp) {
                    // Buscar cliente pelo WhatsApp
                    const { data: cliente } = await supabase
                        .from('clientes')
                        .select('id')
                        .eq('whatsapp', whatsapp.replace(/\D/g, ''))
                        .single();
                    
                    if (cliente) {
                        clienteId = cliente.id;
                    } else if (data.nome_cliente) {
                        // Criar cliente se não existir
                        const clienteNovo = await criarClienteViaWhatsApp({
                            nome: data.nome_cliente,
                            telefone: whatsapp
                        }, whatsapp);
                        if (clienteNovo.success) {
                            clienteId = clienteNovo.data.id;
                        }
                    }
                }
                
                if (!clienteId) {
                    return {
                        success: false,
                        message: 'Cliente não encontrado. Por favor, crie o cliente primeiro.'
                    };
                }
                
                // Criar orçamento
                const orcamentoData = {
                    cliente_id: clienteId,
                    descricao: data.descricao || 'Orçamento criado via WhatsApp',
                    valor: parseFloat(data.valor || 0),
                    status: 'rascunho',
                    observacoes: data.observacoes || `Orçamento criado via WhatsApp em ${new Date().toLocaleString('pt-BR')}`
                };
                
                const { data: orcamento, error } = await supabase
                    .from('orcamentos')
                    .insert([orcamentoData])
                    .select()
                    .single();
                
                if (error) throw error;
                
                return {
                    success: true,
                    message: `Orçamento criado com sucesso! Valor: R$ ${orcamento.valor.toFixed(2)}`,
                    data: orcamento
                };
                
            } catch (error) {
                console.error('Erro ao criar orçamento via WhatsApp:', error);
                return {
                    success: false,
                    message: 'Erro ao criar orçamento: ' + error.message
                };
            }
        }
        
        // Atualizar projeto via WhatsApp
        async function atualizarProjetoViaWhatsApp(data) {
            try {
                const { projeto_id, projeto_nome, status, observacoes } = data;
                
                let projetoId = projeto_id;
                
                // Se não tiver ID, buscar por nome
                if (!projetoId && projeto_nome) {
                    const { data: projetos } = await supabase
                        .from('projetos')
                        .select('id')
                        .ilike('nome', `%${projeto_nome}%`)
                        .limit(1)
                        .single();
                    
                    if (projetos) projetoId = projetos.id;
                }
                
                if (!projetoId) {
                    return {
                        success: false,
                        message: 'Projeto não encontrado'
                    };
                }
                
                const updateData = {};
                if (status) updateData.status = status;
                if (observacoes) {
                    const { data: projetoAtual } = await supabase
                        .from('projetos')
                        .select('observacoes')
                        .eq('id', projetoId)
                        .single();
                    
                    updateData.observacoes = (projetoAtual?.observacoes || '') + 
                        `\n\n[WhatsApp ${new Date().toLocaleString('pt-BR')}]: ${observacoes}`;
                }
                
                const { data: projeto, error } = await supabase
                    .from('projetos')
                    .update(updateData)
                    .eq('id', projetoId)
                    .select()
                    .single();
                
                if (error) throw error;
                
                return {
                    success: true,
                    message: `Projeto "${projeto.nome}" atualizado com sucesso!`,
                    data: projeto
                };
                
            } catch (error) {
                console.error('Erro ao atualizar projeto:', error);
                return {
                    success: false,
                    message: 'Erro ao atualizar projeto: ' + error.message
                };
            }
        }
        
        // Listar projetos via WhatsApp
        async function listarProjetosViaWhatsApp(status) {
            try {
                let query = supabase
                    .from('projetos')
                    .select('*, cliente:clientes(nome, empresa)')
                    .order('created_at', { ascending: false })
                    .limit(10);
                
                if (status) {
                    query = query.eq('status', status);
                }
                
                const { data: projetos, error } = await query;
                
                if (error) throw error;
                
                if (!projetos || projetos.length === 0) {
                    return {
                        success: true,
                        message: 'Nenhum projeto encontrado',
                        data: []
                    };
                }
                
                const projetosFormatados = projetos.map(p => ({
                    nome: p.nome,
                    cliente: p.cliente?.nome || p.cliente?.empresa || 'Sem cliente',
                    status: p.status,
                    valor: p.valor
                }));
                
                return {
                    success: true,
                    message: `Encontrados ${projetos.length} projetos`,
                    data: projetosFormatados
                };
                
            } catch (error) {
                console.error('Erro ao listar projetos:', error);
                return {
                    success: false,
                    message: 'Erro ao listar projetos: ' + error.message
                };
            }
        }
        
        // Consultar orçamento via WhatsApp
        async function consultarOrcamentoViaWhatsApp(query) {
            try {
                // Buscar por número, cliente ou descrição
                const { data: orcamentos, error } = await supabase
                    .from('orcamentos')
                    .select('*, cliente:clientes(nome, empresa)')
                    .or(`numero.ilike.%${query}%,descricao.ilike.%${query}%`)
                    .limit(5)
                    .order('created_at', { ascending: false });
                
                if (error) throw error;
                
                if (!orcamentos || orcamentos.length === 0) {
                    return {
                        success: true,
                        message: 'Nenhum orçamento encontrado',
                        data: []
                    };
                }
                
                return {
                    success: true,
                    message: `Encontrados ${orcamentos.length} orçamentos`,
                    data: orcamentos.map(o => ({
                        numero: o.numero,
                        cliente: o.cliente?.nome || o.cliente?.empresa || 'Sem cliente',
                        valor: o.valor,
                        status: o.status
                    }))
                };
                
            } catch (error) {
                console.error('Erro ao consultar orçamento:', error);
                return {
                    success: false,
                    message: 'Erro ao consultar orçamento: ' + error.message
                };
            }
        }
        
        // Endpoint para receber webhook do n8n (simulado - em produção usar Supabase Edge Function)
        // Esta função pode ser chamada via HTTP POST de um servidor externo
        window.receberWebhookN8N = async function(webhookData) {
            const resultado = await processarComandoN8N(webhookData);
            return resultado;
        };
        
        // Expor função globalmente para testes
        window.processarComandoN8N = processarComandoN8N;
        
        console.log('✅ Integração n8n + WhatsApp carregada!');

        // ========== DASHBOARD COM GRÁFICOS ==========
        let graficoReceitasDespesas = null;
        let graficoConversao = null;
        let graficoProjetosStatus = null;
        let graficoFaturamentoMensal = null;

        // Carregar dados do dashboard
        async function loadDashboardData() {
            try {
                // Carregar dados financeiros
                const hoje = new Date();
                const mesAtual = hoje.getMonth();
                const anoAtual = hoje.getFullYear();
                
                let receitas = [];
                let despesas = [];
                let projetos = [];
                let orcamentos = [];

                // Receitas do mês (com tratamento de erro)
                try {
                    // Primeiro, buscar todas as receitas (sem filtro de data para evitar erro 400)
                    const { data: receitasData, error: receitasError } = await supabase
                        .from('receitas')
                        .select('valor, data_recebimento, data_vencimento, status');
                    
                    if (!receitasError && receitasData) {
                        // Filtrar no JavaScript pelo mês atual
                        const dataInicio = new Date(anoAtual, mesAtual, 1);
                        const dataFim = new Date(anoAtual, mesAtual + 1, 0);
                        receitas = receitasData.filter(r => {
                            if (!r.data_vencimento) return false;
                            const dataVenc = new Date(r.data_vencimento);
                            return dataVenc >= dataInicio && dataVenc <= dataFim;
                        });
                    }
                } catch (e) {
                    console.warn('Erro ao carregar receitas (tabela pode não existir):', e);
                    receitas = [];
                }

                // Despesas do mês (com tratamento de erro)
                try {
                    // Primeiro, buscar todas as despesas (sem filtro de data para evitar erro 400)
                    const { data: despesasData, error: despesasError } = await supabase
                        .from('despesas')
                        .select('valor, data_pagamento, data_vencimento, status');
                    
                    if (!despesasError && despesasData) {
                        // Filtrar no JavaScript pelo mês atual
                        const dataInicio = new Date(anoAtual, mesAtual, 1);
                        const dataFim = new Date(anoAtual, mesAtual + 1, 0);
                        despesas = despesasData.filter(d => {
                            if (!d.data_vencimento) return false;
                            const dataVenc = new Date(d.data_vencimento);
                            return dataVenc >= dataInicio && dataVenc <= dataFim;
                        });
                    }
                } catch (e) {
                    console.warn('Erro ao carregar despesas (tabela pode não existir):', e);
                    despesas = [];
                }

                // Projetos ativos (com tratamento de erro)
                try {
                    const { data: projetosData, error: projetosError } = await supabase
                        .from('projetos')
                        .select('*')
                        .eq('status', 'em_andamento');
                    
                    if (!projetosError && projetosData) {
                        projetos = projetosData;
                    }
                } catch (e) {
                    console.warn('Erro ao carregar projetos:', e);
                }

                // Orçamentos (com tratamento de erro)
                try {
                    const { data: orcamentosData, error: orcamentosError } = await supabase
                        .from('orcamentos')
                        .select('*');
                    
                    if (!orcamentosError && orcamentosData) {
                        orcamentos = orcamentosData;
                    }
                } catch (e) {
                    console.warn('Erro ao carregar orçamentos:', e);
                }

                // Calcular totais
                const receitasTotal = receitas?.filter(r => r.status === 'recebido').reduce((sum, r) => sum + (r.valor || 0), 0) || 0;
                const despesasTotal = despesas?.filter(d => d.status === 'pago').reduce((sum, d) => sum + (d.valor || 0), 0) || 0;
                const pendentes = receitas?.filter(r => r.status === 'pendente').reduce((sum, r) => sum + (r.valor || 0), 0) || 0;
                const vencidos = receitas?.filter(r => r.status === 'atrasado').reduce((sum, r) => sum + (r.valor || 0), 0) || 0;

                // Atualizar cards
                const faturamentoEl = document.getElementById('faturamentoMes');
                const projetosEl = document.getElementById('projetosAtivos');
                const pendentesEl = document.getElementById('pagamentosPendentes');
                const vencidosEl = document.getElementById('pagamentosVencidos');
                
                if (faturamentoEl) faturamentoEl.textContent = formatCurrency(receitasTotal);
                if (projetosEl) projetosEl.textContent = projetos?.length || 0;
                if (pendentesEl) pendentesEl.textContent = formatCurrency(pendentes);
                if (vencidosEl) vencidosEl.textContent = formatCurrency(vencidos);

                // Carregar gráficos
                await atualizarGraficos();
                await loadTopClientes();
                await loadProximosVencimentos();
                await loadOrcamentosAguardando();

            } catch (error) {
                console.error('Erro ao carregar dashboard:', error);
            }
        }

        // Atualizar gráficos
        async function atualizarGraficos() {
            const periodo = document.getElementById('graficoPeriodo')?.value || 'mes';
            await criarGraficoReceitasDespesas(periodo);
            await criarGraficoConversao();
            await criarGraficoProjetosStatus();
            await criarGraficoFaturamentoMensal();
        }

        // Gráfico Receitas vs Despesas
        async function criarGraficoReceitasDespesas(periodo = 'mes') {
            const ctx = document.getElementById('graficoReceitasDespesas');
            if (!ctx) return;

            try {
                const hoje = new Date();
                let labels = [];
                let receitasData = [];
                let despesasData = [];

                if (periodo === 'mes') {
                    // Últimos 6 meses
                    for (let i = 5; i >= 0; i--) {
                        const data = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
                        labels.push(data.toLocaleDateString('pt-BR', { month: 'short', year: 'numeric' }));
                        
                        let receitasMes = 0;
                        let despesasMes = 0;

                        try {
                            // Buscar todas e filtrar no JavaScript
                            const { data: receitasAll } = await supabase
                                .from('receitas')
                                .select('valor, data_vencimento, status')
                                .eq('status', 'recebido');
                            
                            if (receitasAll) {
                                const dataInicio = new Date(data.getFullYear(), data.getMonth(), 1);
                                const dataFim = new Date(data.getFullYear(), data.getMonth() + 1, 0);
                                const receitasFiltradas = receitasAll.filter(r => {
                                    if (!r.data_vencimento) return false;
                                    const dataVenc = new Date(r.data_vencimento);
                                    return dataVenc >= dataInicio && dataVenc <= dataFim;
                                });
                                receitasMes = receitasFiltradas.reduce((sum, r) => sum + (r.valor || 0), 0);
                            }
                        } catch (e) {
                            console.warn('Erro ao buscar receitas do mês:', e);
                        }
                        
                        try {
                            // Buscar todas e filtrar no JavaScript
                            const { data: despesasAll } = await supabase
                                .from('despesas')
                                .select('valor, data_vencimento, status')
                                .eq('status', 'pago');

                            if (despesasAll) {
                                const dataInicio = new Date(data.getFullYear(), data.getMonth(), 1);
                                const dataFim = new Date(data.getFullYear(), data.getMonth() + 1, 0);
                                const despesasFiltradas = despesasAll.filter(d => {
                                    if (!d.data_vencimento) return false;
                                    const dataVenc = new Date(d.data_vencimento);
                                    return dataVenc >= dataInicio && dataVenc <= dataFim;
                                });
                                despesasMes = despesasFiltradas.reduce((sum, d) => sum + (d.valor || 0), 0);
                            }
                        } catch (e) {
                            console.warn('Erro ao buscar despesas do mês:', e);
                        }

                        receitasData.push(receitasMes);
                        despesasData.push(despesasMes);
                    }
                }

                if (graficoReceitasDespesas) {
                    graficoReceitasDespesas.destroy();
                }

                graficoReceitasDespesas = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'Receitas',
                                data: receitasData,
                                backgroundColor: 'rgba(16, 185, 129, 0.6)',
                                borderColor: '#10b981',
                                borderWidth: 1
                            },
                            {
                                label: 'Despesas',
                                data: despesasData,
                                backgroundColor: 'rgba(239, 68, 68, 0.6)',
                                borderColor: '#ef4444',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: '#fff' }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#AFAFAF' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            },
                            x: {
                                ticks: { color: '#AFAFAF' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Erro ao criar gráfico receitas/despesas:', error);
            }
        }

        // Gráfico Taxa de Conversão
        async function criarGraficoConversao() {
            const ctx = document.getElementById('graficoConversao');
            if (!ctx) return;

            try {
                const { data: orcamentos } = await supabase.from('orcamentos').select('status');
                
                const total = orcamentos?.length || 0;
                const aprovados = orcamentos?.filter(o => o.status === 'aprovado').length || 0;
                const taxa = total > 0 ? (aprovados / total * 100).toFixed(1) : 0;

                if (graficoConversao) {
                    graficoConversao.destroy();
                }

                graficoConversao = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: ['Aprovados', 'Outros'],
                        datasets: [{
                            data: [aprovados, total - aprovados],
                            backgroundColor: ['#10b981', 'rgba(255, 255, 255, 0.1)'],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return context.label + ': ' + context.parsed + ' (' + (context.parsed / total * 100).toFixed(1) + '%)';
                                    }
                                }
                            }
                        }
                    },
                    plugins: [{
                        id: 'text',
                        beforeDraw: function(chart) {
                            const width = chart.width;
                            const height = chart.height;
                            const ctx = chart.ctx;
                            ctx.restore();
                            ctx.font = 'bold 24px Montserrat';
                            ctx.fillStyle = '#FF6600';
                            ctx.textAlign = 'center';
                            ctx.textBaseline = 'middle';
                            ctx.fillText(taxa + '%', width / 2, height / 2);
                            ctx.save();
                        }
                    }]
                });
            } catch (error) {
                console.error('Erro ao criar gráfico conversão:', error);
            }
        }

        // Gráfico Projetos por Status
        async function criarGraficoProjetosStatus() {
            const ctx = document.getElementById('graficoProjetosStatus');
            if (!ctx) return;

            try {
                const { data: projetos } = await supabase.from('projetos').select('status');
                
                const statusCount = {
                    planejamento: 0,
                    em_andamento: 0,
                    pausado: 0,
                    concluido: 0,
                    cancelado: 0
                };

                projetos?.forEach(p => {
                    if (statusCount[p.status] !== undefined) {
                        statusCount[p.status]++;
                    }
                });

                if (graficoProjetosStatus) {
                    graficoProjetosStatus.destroy();
                }

                graficoProjetosStatus = new Chart(ctx, {
                    type: 'pie',
                    data: {
                        labels: ['Planejamento', 'Em Andamento', 'Pausado', 'Concluído', 'Cancelado'],
                        datasets: [{
                            data: [
                                statusCount.planejamento,
                                statusCount.em_andamento,
                                statusCount.pausado,
                                statusCount.concluido,
                                statusCount.cancelado
                            ],
                            backgroundColor: [
                                'rgba(156, 163, 175, 0.6)',
                                '#FF6600',
                                'rgba(251, 191, 36, 0.6)',
                                'rgba(16, 185, 129, 0.6)',
                                'rgba(239, 68, 68, 0.6)'
                            ],
                            borderWidth: 0
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'bottom',
                                labels: { color: '#fff', padding: 15 }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Erro ao criar gráfico projetos:', error);
            }
        }

        // Gráfico Faturamento Mensal
        async function criarGraficoFaturamentoMensal() {
            const ctx = document.getElementById('graficoFaturamentoMensal');
            if (!ctx) return;

            try {
                const hoje = new Date();
                const labels = [];
                const data = [];

                for (let i = 5; i >= 0; i--) {
                    const dataMes = new Date(hoje.getFullYear(), hoje.getMonth() - i, 1);
                    labels.push(dataMes.toLocaleDateString('pt-BR', { month: 'short' }));
                    
                    let receitasMes = 0;
                    try {
                        // Buscar todas e filtrar no JavaScript
                        const { data: receitasAll } = await supabase
                            .from('receitas')
                            .select('valor, data_vencimento, status')
                            .eq('status', 'recebido');

                        if (receitasAll) {
                            const dataInicio = new Date(dataMes.getFullYear(), dataMes.getMonth(), 1);
                            const dataFim = new Date(dataMes.getFullYear(), dataMes.getMonth() + 1, 0);
                            const receitasFiltradas = receitasAll.filter(r => {
                                if (!r.data_vencimento) return false;
                                const dataVenc = new Date(r.data_vencimento);
                                return dataVenc >= dataInicio && dataVenc <= dataFim;
                            });
                            receitasMes = receitasFiltradas.reduce((sum, r) => sum + (r.valor || 0), 0);
                        }
                    } catch (e) {
                        console.warn('Erro ao buscar receitas para gráfico:', e);
                    }

                    data.push(receitasMes);
                }

                if (graficoFaturamentoMensal) {
                    graficoFaturamentoMensal.destroy();
                }

                graficoFaturamentoMensal = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Faturamento',
                            data: data,
                            borderColor: '#FF6600',
                            backgroundColor: 'rgba(255, 102, 0, 0.1)',
                            borderWidth: 2,
                            fill: true,
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                labels: { color: '#fff' }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#AFAFAF' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            },
                            x: {
                                ticks: { color: '#AFAFAF' },
                                grid: { color: 'rgba(255, 255, 255, 0.1)' }
                            }
                        }
                    }
                });
            } catch (error) {
                console.error('Erro ao criar gráfico faturamento:', error);
            }
        }

        // Top 5 Clientes
        async function loadTopClientes() {
            try {
                const container = document.getElementById('topClientesList');
                if (!container) return;

                try {
                    const { data: receitas, error } = await supabase
                        .from('receitas')
                        .select('valor, cliente_id, cliente:clientes(nome, empresa)')
                        .eq('status', 'recebido');

                    if (error) throw error;

                    const clientesMap = {};
                    receitas?.forEach(r => {
                        const clienteId = r.cliente_id;
                        if (!clientesMap[clienteId]) {
                            clientesMap[clienteId] = {
                                cliente: r.cliente,
                                total: 0
                            };
                        }
                        clientesMap[clienteId].total += r.valor || 0;
                    });

                    const topClientes = Object.values(clientesMap)
                        .sort((a, b) => b.total - a.total)
                        .slice(0, 5);

                    if (topClientes.length === 0) {
                        container.innerHTML = '<div class="empty-state">Nenhum dado disponível</div>';
                        return;
                    }

                    container.innerHTML = topClientes.map((item, index) => {
                        const nome = item.cliente?.nome || item.cliente?.empresa || 'Cliente';
                        return `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--tertiary); border-radius: 8px; margin-bottom: 8px;">
                                <div style="display: flex; align-items: center; gap: 12px;">
                                    <span style="font-size: 18px; font-weight: 700; color: var(--primary);">#${index + 1}</span>
                                    <span style="font-weight: 600;">${nome}</span>
                                </div>
                                <span style="color: var(--success); font-weight: 600;">${formatCurrency(item.total)}</span>
                            </div>
                        `;
                    }).join('');
                } catch (e) {
                    console.warn('Erro ao carregar top clientes (tabela pode não existir):', e);
                    container.innerHTML = '<div class="empty-state">Nenhum dado disponível</div>';
                }
            } catch (error) {
                console.error('Erro ao carregar top clientes:', error);
            }
        }

        // Próximos Vencimentos
        async function loadProximosVencimentos() {
            try {
                const container = document.getElementById('proximosVencimentos');
                if (!container) return;

                try {
                    // Buscar todas as receitas pendentes e filtrar no JavaScript
                    const { data: receitasAll, error } = await supabase
                        .from('receitas')
                        .select('*, cliente:clientes(nome, empresa)')
                        .eq('status', 'pendente')
                        .order('data_vencimento', { ascending: true });

                    if (error) throw error;

                    // Filtrar no JavaScript pelos próximos 7 dias
                    const hoje = new Date();
                    hoje.setHours(0, 0, 0, 0);
                    const em7Dias = new Date();
                    em7Dias.setDate(hoje.getDate() + 7);
                    em7Dias.setHours(23, 59, 59, 999);

                    const receitas = (receitasAll || []).filter(r => {
                        if (!r.data_vencimento) return false;
                        const dataVenc = new Date(r.data_vencimento);
                        return dataVenc >= hoje && dataVenc <= em7Dias;
                    }).slice(0, 10);

                    if (!receitas || receitas.length === 0) {
                        container.innerHTML = '<div class="empty-state">Nenhum vencimento próximo</div>';
                        return;
                    }

                    container.innerHTML = receitas.map(r => {
                        const clienteNome = r.cliente?.nome || r.cliente?.empresa || 'Cliente';
                        return `
                            <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--tertiary); border-radius: 8px; margin-bottom: 8px;">
                                <div>
                                    <div style="font-weight: 600;">${r.descricao || 'Receita'}</div>
                                    <div style="font-size: 12px; color: var(--text-gray);">${clienteNome} • ${formatDate(r.data_vencimento)}</div>
                                </div>
                                <span style="color: var(--warning); font-weight: 600;">${formatCurrency(r.valor)}</span>
                            </div>
                        `;
                    }).join('');
                } catch (e) {
                    console.warn('Erro ao carregar vencimentos (tabela pode não existir):', e);
                    container.innerHTML = '<div class="empty-state">Nenhum vencimento próximo</div>';
                }
            } catch (error) {
                console.error('Erro ao carregar vencimentos:', error);
            }
        }

        // Orçamentos Aguardando
        async function loadOrcamentosAguardando() {
            try {
                const { data: orcamentos } = await supabase
                    .from('orcamentos')
                    .select('*, cliente:clientes(nome, empresa)')
                    .eq('status', 'enviado')
                    .order('created_at', { ascending: false })
                    .limit(10);

                const container = document.getElementById('orcamentosAguardando');
                if (!container) return;

                if (!orcamentos || orcamentos.length === 0) {
                    container.innerHTML = '<div class="empty-state">Nenhum orçamento aguardando aprovação</div>';
                    return;
                }

                container.innerHTML = orcamentos.map(o => {
                    const clienteNome = o.cliente?.nome || o.cliente?.empresa || 'Cliente';
                    return `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 12px; background: var(--tertiary); border-radius: 8px; margin-bottom: 8px;">
                            <div>
                                <div style="font-weight: 600;">Orçamento #${o.numero || o.id}</div>
                                <div style="font-size: 12px; color: var(--text-gray);">${clienteNome} • ${formatDate(o.data)}</div>
                            </div>
                            <span style="color: var(--primary); font-weight: 600;">${formatCurrency(o.valor)}</span>
                        </div>
                    `;
                }).join('');
            } catch (error) {
                console.error('Erro ao carregar orçamentos:', error);
            }
        }

        // ========== GESTÃO DE CONTRATOS ==========
        let allContratos = [];
        let filteredContratos = [];

        // Carregar contratos
        async function loadContratos() {
            const loading = document.getElementById('contratosLoading');
            const table = document.getElementById('contratosTable');
            const empty = document.getElementById('contratosEmpty');
            
            loading.classList.add('active');
            table.style.display = 'none';
            empty.style.display = 'none';

            try {
                const { data, error } = await supabase
                    .from('contratos')
                    .select('*, cliente:clientes(*), projeto:projetos(*), orcamento:orcamentos(*)')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                allContratos = data || [];
                filteredContratos = [...allContratos];
                renderContratos();
                
                // Carregar clientes no filtro
                await loadClientesForContratoFilter();
            } catch (error) {
                console.error('Erro ao carregar contratos:', error);
                allContratos = [];
                filteredContratos = [];
                renderContratos();
            } finally {
                loading.classList.remove('active');
            }
        }

        // Renderizar contratos
        function renderContratos() {
            const tbody = document.getElementById('contratosTableBody');
            const table = document.getElementById('contratosTable');
            const empty = document.getElementById('contratosEmpty');

            if (filteredContratos.length === 0) {
                table.style.display = 'none';
                empty.style.display = 'block';
                return;
            }

            table.style.display = 'table';
            empty.style.display = 'none';

            tbody.innerHTML = filteredContratos.map(contrato => {
                const cliente = contrato.cliente || {};
                const clienteNome = cliente.nome || cliente.empresa || 'Cliente não encontrado';
                
                const statusMap = {
                    'rascunho': { label: 'Rascunho', class: 'badge-rascunho' },
                    'aguardando_assinatura': { label: 'Aguardando Assinatura', class: 'badge-enviado' },
                    'ativo': { label: 'Ativo', class: 'badge-ativo' },
                    'vencido': { label: 'Vencido', class: 'badge-inativo' },
                    'renovado': { label: 'Renovado', class: 'badge-concluido' },
                    'cancelado': { label: 'Cancelado', class: 'badge-cancelado' }
                };

                const status = statusMap[contrato.status] || { label: contrato.status, class: 'badge-rascunho' };

                return `
                    <tr>
                        <td data-label="Número">${contrato.numero || '-'}</td>
                        <td data-label="Cliente">${clienteNome}</td>
                        <td data-label="Descrição">${(contrato.descricao || '').substring(0, 50)}${contrato.descricao && contrato.descricao.length > 50 ? '...' : ''}</td>
                        <td data-label="Valor">${formatCurrency(contrato.valor || 0)}</td>
                        <td data-label="Início">${formatDate(contrato.data_inicio)}</td>
                        <td data-label="Vencimento">${formatDate(contrato.data_vencimento)}</td>
                        <td data-label="Status">
                            <span class="badge ${status.class}">${status.label}</span>
                        </td>
                        <td data-label="Ações">
                            <button class="btn-action" onclick="viewContratoDetails('${contrato.id}')" style="border-color: var(--primary); color: var(--primary); margin-right: 4px;">Ver</button>
                            <button class="btn-action" onclick="editContrato('${contrato.id}')" style="border-color: var(--primary); color: var(--primary); margin-right: 4px;">Editar</button>
                            <button class="btn-action" onclick="deleteContrato('${contrato.id}')" style="border-color: var(--danger); color: var(--danger);">Excluir</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        // Filtrar contratos
        function filterContratos() {
            const search = document.getElementById('contratoSearch').value.toLowerCase();
            const statusFilter = document.getElementById('contratoStatusFilter').value;
            const clienteFilter = document.getElementById('contratoClienteFilter').value;

            filteredContratos = allContratos.filter(contrato => {
                const cliente = contrato.cliente || {};
                const clienteNome = (cliente.nome || cliente.empresa || '').toLowerCase();
                const descricao = (contrato.descricao || '').toLowerCase();
                const numero = (contrato.numero || '').toLowerCase();
                
                const matchSearch = !search || 
                    numero.includes(search) ||
                    descricao.includes(search) ||
                    clienteNome.includes(search);
                
                const matchStatus = !statusFilter || contrato.status === statusFilter;
                const matchCliente = !clienteFilter || contrato.cliente_id === clienteFilter;
                
                return matchSearch && matchStatus && matchCliente;
            });

            renderContratos();
        }

        // Carregar clientes para filtro
        async function loadClientesForContratoFilter() {
            try {
                const { data: clientes } = await supabase
                    .from('clientes')
                    .select('id, nome, empresa')
                    .order('nome');
                
                const select = document.getElementById('contratoClienteFilter');
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Todos os clientes</option>';
                    if (clientes) {
                        clientes.forEach(cliente => {
                            const nome = cliente.nome || cliente.empresa || 'Cliente';
                            const option = document.createElement('option');
                            option.value = cliente.id;
                            option.textContent = nome;
                            select.appendChild(option);
                        });
                    }
                    select.value = currentValue;
                }
            } catch (e) {
                console.error('Erro ao carregar clientes para filtro:', e);
            }
        }

        // Abrir modal de contrato
        async function openContratoModal() {
            document.getElementById('contratoModalTitle').textContent = 'Novo Contrato';
            document.getElementById('contratoForm').reset();
            document.getElementById('contratoId').value = '';
            
            // Limpar checkboxes de serviços
            document.querySelectorAll('input[type="checkbox"][id^="servico"]').forEach(cb => {
                cb.checked = false;
            });
            document.getElementById('contratoObjeto').value = '';
            
            // Limpar campos de valor recorrente
            if (document.getElementById('contratoTipoPagamento')) {
                document.getElementById('contratoTipoPagamento').value = 'unico';
            }
            if (document.getElementById('contratoFrequenciaRecorrente')) {
                document.getElementById('contratoFrequenciaRecorrente').value = 'mensal';
            }
            if (document.getElementById('contratoValorRecorrente')) {
                document.getElementById('contratoValorRecorrente').value = '';
            }
            if (document.getElementById('contratoDataInicioRecorrente')) {
                document.getElementById('contratoDataInicioRecorrente').value = '';
            }
            if (document.getElementById('contratoNumeroCiclos')) {
                document.getElementById('contratoNumeroCiclos').value = '';
            }
            if (document.getElementById('contratoObservacoesRecorrente')) {
                document.getElementById('contratoObservacoesRecorrente').value = '';
            }
            toggleValorRecorrente();
            
            // Gerar número automático
            const { data: ultimoContrato } = await supabase
                .from('contratos')
                .select('numero')
                .order('created_at', { ascending: false })
                .limit(1)
                .single();
            
            let proximoNumero = 1;
            if (ultimoContrato?.numero) {
                const num = parseInt(ultimoContrato.numero.replace(/\D/g, '')) || 0;
                proximoNumero = num + 1;
            }
            document.getElementById('contratoNumero').value = `CTR-${String(proximoNumero).padStart(4, '0')}`;
            
            // Data de hoje
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('contratoDataInicio').value = hoje;
            
            // Carregar clientes, projetos e orçamentos
            await Promise.all([
                loadClientesForContratoSelect(),
                loadProjetosForContratoSelect(),
                loadOrcamentosForContratoSelect()
            ]);
            
            const modal = document.getElementById('contratoModal');
            openModal(modal);
        }

        // Atualizar objeto do contrato com serviços selecionados
        function atualizarObjetoContrato() {
            const servicos = [];
            const servicosMap = {
                'servicoSite': 'Criação e edição de site',
                'servicoAutomacao': 'Automação para redes sociais',
                'servicoAgenteIA': 'Criação de agente IA',
                'servicoPlataforma': 'Desenvolvimento de plataforma própria',
                'servicoMarca': 'Criação de marca digital',
                'servicoRedes': 'Criação de redes sociais',
                'servicoSocialMedia': 'Serviço de social media',
                'servicoAnalise': 'Análise estratégica'
            };

            Object.keys(servicosMap).forEach(id => {
                const checkbox = document.getElementById(id);
                if (checkbox && checkbox.checked) {
                    servicos.push(servicosMap[id]);
                }
            });

            if (servicos.length > 0) {
                let objetoTexto = `PRESTAÇÃO DE SERVIÇOS DIGITAIS E TECNOLÓGICOS

A AUTOVIZION COMERCIAL, pessoa jurídica devidamente constituída, inscrita no CNPJ sob o nº [CNPJ], com sede na [ENDEREÇO COMPLETO], doravante denominada CONTRATADA, se compromete a prestar ao CONTRATANTE, pessoa física/jurídica identificada neste contrato, os seguintes serviços digitais e tecnológicos:

`;

                servicos.forEach((servico, index) => {
                    objetoTexto += `${index + 1}. ${servico.toUpperCase()}\n`;
                    objetoTexto += `   ${getDescricaoServico(servico)}\n\n`;
                });

                objetoTexto += `Os serviços serão prestados com qualidade, eficiência e em conformidade com as melhores práticas do mercado, utilizando profissionais qualificados e tecnologias atualizadas para a execução das atividades contratadas.

A CONTRATADA se compromete a manter sigilo absoluto sobre todas as informações confidenciais do CONTRATANTE, não divulgando dados comerciais, estratégicos ou operacionais sem prévia autorização escrita.

Todos os materiais, códigos, designs e soluções desenvolvidas serão entregues com documentação completa, garantindo que o CONTRATANTE tenha total autonomia e conhecimento sobre os serviços prestados.`;

                document.getElementById('contratoObjeto').value = objetoTexto;
            } else {
                document.getElementById('contratoObjeto').value = '';
            }
        }

        // Obter descrição detalhada do serviço
        function getDescricaoServico(servico) {
            const descricoes = {
                'Criação e edição de site': 'Desenvolvimento, criação e manutenção de website responsivo, incluindo design, programação, otimização e atualizações conforme necessário.',
                'Automação para redes sociais': 'Configuração e implementação de sistemas automatizados para gestão e publicação de conteúdo em redes sociais, incluindo agendamento e monitoramento.',
                'Criação de agente IA': 'Desenvolvimento e implementação de assistente virtual inteligente personalizado, utilizando inteligência artificial para atendimento, suporte e automação de processos.',
                'Desenvolvimento de plataforma própria': 'Criação de plataforma digital personalizada, incluindo desenvolvimento completo, integrações, banco de dados e sistema de gestão conforme especificações.',
                'Criação de marca digital': 'Desenvolvimento de identidade visual completa, incluindo logo, paleta de cores, tipografia, diretrizes de marca e aplicação em materiais digitais.',
                'Criação de redes sociais': 'Criação e configuração de perfis profissionais em redes sociais, incluindo otimização de biografia, capas, conteúdo inicial e estratégia de presença digital.',
                'Serviço de social media': 'Gestão completa de redes sociais, incluindo criação de conteúdo, publicação, engajamento com público, análise de métricas e estratégias de crescimento.',
                'Análise estratégica': 'Realização de análises detalhadas de mercado, concorrência, público-alvo e oportunidades, fornecendo relatórios estratégicos e recomendações para tomada de decisão.'
            };
            return descricoes[servico] || 'Serviço profissional de alta qualidade, executado com excelência e comprometimento.';
        }

        // Abrir modal de templates de objeto
        function abrirTemplatesObjeto() {
            const modal = document.getElementById('templatesObjetoModal');
            openModal(modal);
        }

        // Fechar modal de templates
        function fecharTemplatesObjeto() {
            const modal = document.getElementById('templatesObjetoModal');
            closeModal(modal);
        }

        // ========== FUNÇÕES PARA TEMPLATES DE CLÁUSULAS ==========
        function abrirTemplatesClausulas() {
            const modal = document.getElementById('templatesClausulasModal');
            openModal(modal);
        }

        function fecharTemplatesClausulas() {
            const modal = document.getElementById('templatesClausulasModal');
            closeModal(modal);
        }

        function aplicarTemplateClausulas(tipo) {
            const templates = {
                'basico': `CLÁUSULA 1 - DO OBJETO
O CONTRATADO se compromete a prestar os serviços descritos neste contrato com qualidade, eficiência e em conformidade com as especificações acordadas.

CLÁUSULA 2 - DO PRAZO
Os serviços serão executados no prazo estabelecido neste contrato, contado a partir da data de início.

CLÁUSULA 3 - DA QUALIDADE
A CONTRATADA garante que todos os serviços serão prestados por profissionais qualificados e utilizando as melhores práticas do mercado.

CLÁUSULA 4 - DO SIGILO
As partes se comprometem a manter sigilo absoluto sobre todas as informações confidenciais compartilhadas durante a execução deste contrato.`,

                'completo': `CLÁUSULA 1 - DO OBJETO E ESCOPO
O CONTRATADO se compromete a prestar os serviços descritos neste contrato com qualidade, eficiência e em conformidade com as especificações acordadas. O escopo dos serviços inclui todas as atividades necessárias para a completa execução do objeto contratado.

CLÁUSULA 2 - DO PRAZO E ENTREGA
Os serviços serão executados no prazo estabelecido neste contrato, contado a partir da data de início. A CONTRATADA se compromete a cumprir todos os prazos acordados, comunicando previamente qualquer necessidade de alteração.

CLÁUSULA 3 - DA QUALIDADE E PADRONIZAÇÃO
A CONTRATADA garante que todos os serviços serão prestados por profissionais qualificados, utilizando as melhores práticas do mercado, tecnologias atualizadas e metodologias adequadas. Todos os materiais entregues estarão em conformidade com os padrões de qualidade estabelecidos.

CLÁUSULA 4 - DO SIGILO E CONFIDENCIALIDADE
As partes se comprometem a manter sigilo absoluto sobre todas as informações confidenciais, estratégicas, comerciais ou técnicas compartilhadas durante a execução deste contrato. Esta obrigação permanece válida mesmo após o término do contrato.

CLÁUSULA 5 - DAS ALTERAÇÕES
Qualquer alteração no escopo, prazo ou valor dos serviços deverá ser formalizada por escrito e aprovada por ambas as partes, mediante aditivo contratual.

CLÁUSULA 6 - DA PROPRIEDADE INTELECTUAL
Todos os materiais, códigos, designs e soluções desenvolvidas pela CONTRATADA serão de propriedade do CONTRATANTE após o pagamento integral do contrato, salvo disposição em contrário.

CLÁUSULA 7 - DA COMUNICAÇÃO
Todas as comunicações entre as partes deverão ser feitas por escrito, através dos canais oficiais estabelecidos, garantindo rastreabilidade e formalidade.`,

                'recorrente': `CLÁUSULA 1 - DA NATUREZA RECORRENTE
Este contrato estabelece uma relação de prestação de serviços de natureza recorrente, com cobranças periódicas conforme frequência estabelecida.

CLÁUSULA 2 - DO VALOR E REAJUSTE
O valor recorrente será reajustado anualmente pelo índice IPCA ou outro índice acordado entre as partes. O reajuste será aplicado automaticamente, com comunicação prévia de 30 dias ao CONTRATANTE.

CLÁUSULA 3 - DA RENOVAÇÃO
Este contrato será renovado automaticamente por períodos sucessivos, salvo manifestação contrária de qualquer das partes com antecedência mínima de 30 dias do término do período vigente.

CLÁUSULA 4 - DO CANCELAMENTO
O CONTRATANTE poderá cancelar este contrato a qualquer momento, mediante comunicação escrita com antecedência mínima de 30 dias, sem ônus adicional, desde que não haja pendências financeiras.

CLÁUSULA 5 - DAS OBRIGAÇÕES RECORRENTES
A CONTRATADA se compromete a manter a qualidade e continuidade dos serviços durante todo o período de vigência do contrato, incluindo atualizações, melhorias e suporte técnico conforme acordado.`,

                'propriedade': `CLÁUSULA 1 - DA PROPRIEDADE INTELECTUAL
Todos os materiais, códigos, designs, textos, imagens, vídeos, sistemas e demais criações desenvolvidas pela CONTRATADA no âmbito deste contrato serão de propriedade exclusiva do CONTRATANTE após o pagamento integral.

CLÁUSULA 2 - DOS DIREITOS AUTORAIS
A CONTRATADA cede ao CONTRATANTE todos os direitos autorais sobre as obras criadas, incluindo direitos de uso, reprodução, distribuição, modificação e comercialização, sem limitações territoriais ou temporais.

CLÁUSULA 3 - DAS FERRAMENTAS E TECNOLOGIAS
Ferramentas, tecnologias, bibliotecas e frameworks de terceiros utilizados no desenvolvimento permanecerão sob suas respectivas licenças originais. A CONTRATADA garante que todas as licenças necessárias estão em conformidade.

CLÁUSULA 4 - DO MATERIAL PRÓPRIO
Materiais, códigos e soluções pré-existentes de propriedade da CONTRATADA poderão ser utilizados, desde que não comprometam a propriedade intelectual do CONTRATANTE sobre o trabalho desenvolvido especificamente para este contrato.

CLÁUSULA 5 - DA PROTEÇÃO
Ambas as partes se comprometem a proteger e respeitar os direitos de propriedade intelectual um do outro, não utilizando materiais protegidos sem autorização prévia e por escrito.`
            };

            const template = templates[tipo];
            if (template) {
                document.getElementById('contratoClausulas').value = template;
                fecharTemplatesClausulas();
            }
        }

        // ========== FUNÇÕES PARA TEMPLATES DE TERMOS ==========
        function abrirTemplatesTermos() {
            const modal = document.getElementById('templatesTermosModal');
            openModal(modal);
        }

        function fecharTemplatesTermos() {
            const modal = document.getElementById('templatesTermosModal');
            closeModal(modal);
        }

        function aplicarTemplateTermos(tipo) {
            const templates = {
                'basico': `TERMO 1 - DAS OBRIGAÇÕES GERAIS
As partes se comprometem a cumprir fielmente todas as obrigações estabelecidas neste contrato, agindo de boa-fé e colaborando mutuamente para o sucesso da relação contratual.

TERMO 2 - DA RESCISÃO
Este contrato poderá ser rescindido por qualquer das partes mediante comunicação escrita com antecedência mínima de 30 dias, ou imediatamente em caso de descumprimento grave das obrigações contratuais.

TERMO 3 - DAS DISPUTAS
Qualquer controvérsia oriunda deste contrato será resolvida preferencialmente através de negociação amigável entre as partes.`,

                'completo': `TERMO 1 - DAS OBRIGAÇÕES GERAIS
As partes se comprometem a cumprir fielmente todas as obrigações estabelecidas neste contrato, agindo de boa-fé, transparência e colaborando mutuamente para o sucesso da relação contratual. Todas as comunicações deverão ser feitas por escrito.

TERMO 2 - DA FORÇA MAIOR
Nenhuma das partes será responsabilizada por atrasos ou descumprimentos decorrentes de casos fortuitos, força maior ou eventos imprevisíveis, tais como: desastres naturais, pandemias, greves, alterações legislativas, falhas de sistemas de terceiros, entre outros.

TERMO 3 - DA RESCISÃO
Este contrato poderá ser rescindido por qualquer das partes mediante comunicação escrita com antecedência mínima de 30 dias, ou imediatamente em caso de: (a) descumprimento grave das obrigações contratuais; (b) declaração de falência ou insolvência; (c) prática de atos que comprometam a reputação da outra parte.

TERMO 4 - DAS ALTERAÇÕES CONTRATUAIS
Qualquer alteração neste contrato deverá ser formalizada por escrito, mediante aditivo contratual assinado por ambas as partes, não sendo válidas alterações verbais ou informais.

TERMO 5 - DA COMUNICAÇÃO
Todas as comunicações oficiais entre as partes deverão ser feitas por escrito, através de e-mail, correspondência ou plataforma oficial, garantindo rastreabilidade e formalidade.

TERMO 6 - DA CONFIDENCIALIDADE
As partes se comprometem a manter sigilo sobre todas as informações confidenciais compartilhadas, não divulgando dados comerciais, estratégicos, técnicos ou operacionais sem prévia autorização escrita.

TERMO 7 - DAS DISPUTAS E MEDIAÇÃO
Qualquer controvérsia oriunda deste contrato será resolvida preferencialmente através de negociação amigável. Caso não seja possível, as partes poderão recorrer à mediação ou arbitragem antes de acionar o Poder Judiciário.`,

                'cancelamento': `TERMO 1 - DO DIREITO DE CANCELAMENTO
O CONTRATANTE poderá cancelar este contrato a qualquer momento, mediante comunicação escrita com antecedência mínima de 30 dias, sem ônus adicional, desde que não haja pendências financeiras ou obrigações em aberto.

TERMO 2 - DO CANCELAMENTO PELA CONTRATADA
A CONTRATADA poderá cancelar este contrato mediante comunicação escrita com antecedência mínima de 60 dias, ou imediatamente em caso de: (a) inadimplência superior a 30 dias; (b) descumprimento grave das obrigações do CONTRATANTE; (c) uso indevido dos serviços prestados.

TERMO 3 - DAS CONSEQUÊNCIAS DO CANCELAMENTO
Em caso de cancelamento, o CONTRATANTE terá direito aos serviços já pagos e não utilizados, calculados proporcionalmente. Materiais e entregas já realizadas permanecerão de propriedade do CONTRATANTE.

TERMO 4 - DA CONTINUIDADE DOS SERVIÇOS
Após o cancelamento, a CONTRATADA se compromete a manter os serviços ativos pelo período de transição acordado, garantindo continuidade e migração adequada quando necessário.

TERMO 5 - DO REEMBOLSO
Em caso de cancelamento pelo CONTRATANTE dentro dos primeiros 7 dias, será concedido reembolso integral dos valores pagos, deduzidos apenas os custos já incorridos pela CONTRATADA.`,

                'garantia': `TERMO 1 - DAS GARANTIAS
A CONTRATADA garante que todos os serviços serão executados com qualidade profissional, utilizando profissionais qualificados, tecnologias atualizadas e seguindo as melhores práticas do mercado.

TERMO 2 - DO SUPORTE TÉCNICO
A CONTRATADA se compromete a fornecer suporte técnico adequado durante o período de vigência do contrato, incluindo correção de problemas, atualizações necessárias e orientações para utilização.

TERMO 3 - DA CORREÇÃO DE DEFEITOS
Em caso de defeitos ou não conformidades identificados, a CONTRATADA se compromete a corrigir os problemas sem custo adicional, dentro de prazo razoável, desde que comunicados dentro do período de garantia.

TERMO 4 - DO PERÍODO DE GARANTIA
Os serviços prestados terão garantia de 90 dias contados a partir da entrega, durante os quais a CONTRATADA corrigirá defeitos e não conformidades sem custo adicional.

TERMO 5 - DAS LIMITAÇÕES
A garantia não cobre: (a) alterações ou modificações realizadas por terceiros; (b) problemas decorrentes de uso inadequado; (c) falhas em sistemas ou serviços de terceiros; (d) atualizações ou mudanças solicitadas pelo CONTRATANTE após a entrega.`
            };

            const template = templates[tipo];
            if (template) {
                document.getElementById('contratoTermosCondicoes').value = template;
                fecharTemplatesTermos();
            }
        }

        // ========== FUNÇÕES PARA TEMPLATES DE PENALIDADES ==========
        function abrirTemplatesPenalidades() {
            const modal = document.getElementById('templatesPenalidadesModal');
            openModal(modal);
        }

        function fecharTemplatesPenalidades() {
            const modal = document.getElementById('templatesPenalidadesModal');
            closeModal(modal);
        }

        function aplicarTemplatePenalidades(tipo) {
            const templates = {
                'basico': `PENALIDADE POR ATRASO NO PAGAMENTO
Em caso de atraso no pagamento, será aplicada multa de 2% (dois por cento) sobre o valor em atraso, além de juros de mora de 1% (um por cento) ao mês, calculados proporcionalmente.

PENALIDADE POR DESCUMPRIMENTO
Em caso de descumprimento das obrigações contratuais por qualquer das partes, a parte inadimplente pagará à outra multa equivalente a 10% (dez por cento) do valor total do contrato.`,

                'completo': `PENALIDADE POR ATRASO NO PAGAMENTO
Em caso de atraso no pagamento de qualquer parcela ou valor devido, o CONTRATANTE pagará à CONTRATADA:
a) Multa de 2% (dois por cento) sobre o valor em atraso;
b) Juros de mora de 1% (um por cento) ao mês, calculados proporcionalmente;
c) Correção monetária pelo índice IPCA ou outro índice acordado.

PENALIDADE POR DESCUMPRIMENTO DE SERVIÇOS
Em caso de descumprimento das obrigações de prestação de serviços pela CONTRATADA, será aplicada:
a) Multa de 10% (dez por cento) do valor total do contrato;
b) Redução proporcional do valor a ser pago, correspondente aos serviços não executados ou executados de forma inadequada;
c) Obrigação de correção dos problemas sem custo adicional.

PENALIDADE POR CANCELAMENTO INDEVIDO
Em caso de cancelamento unilateral sem justa causa, a parte que cancelar pagará à outra multa equivalente a 20% (vinte por cento) do valor total do contrato, além das obrigações já assumidas.

PENALIDADE POR QUEBRA DE SIGILO
Em caso de violação da cláusula de sigilo e confidencialidade, a parte infratora pagará multa de R$ 50.000,00 (cinquenta mil reais) ou 50% (cinquenta por cento) do valor do contrato, o que for maior, além de responder por perdas e danos.

PENALIDADE POR USO INDEVIDO
Em caso de uso indevido dos materiais, códigos ou soluções desenvolvidas, a parte infratora pagará multa de 100% (cem por cento) do valor do contrato, além de responder por perdas e danos e violação de propriedade intelectual.`,

                'atraso': `PENALIDADE POR ATRASO NO PAGAMENTO

Em caso de atraso no pagamento de qualquer parcela ou valor devido, o CONTRATANTE pagará à CONTRATADA as seguintes penalidades:

a) MULTA: 2% (dois por cento) sobre o valor em atraso, calculada a partir do primeiro dia de atraso;

b) JUROS DE MORA: 1% (um por cento) ao mês, calculados proporcionalmente sobre o valor em atraso, capitalizados mensalmente;

c) CORREÇÃO MONETÁRIA: Aplicação do índice IPCA ou outro índice acordado entre as partes, para atualização do valor;

d) SUSPENSÃO DE SERVIÇOS: A CONTRATADA poderá suspender a prestação dos serviços após 15 (quinze) dias de atraso, mediante comunicação prévia, sem prejuízo da cobrança dos valores devidos;

e) RESCISÃO: Após 30 (trinta) dias de atraso, a CONTRATADA poderá rescindir o contrato, sem prejuízo da cobrança de todas as penalidades e valores devidos.

As penalidades serão aplicadas cumulativamente, não se excluindo mutuamente.`,

                'descumprimento': `PENALIDADE POR DESCUMPRIMENTO DE SERVIÇOS

Em caso de descumprimento das obrigações de prestação de serviços pela CONTRATADA, serão aplicadas as seguintes penalidades:

a) MULTA: 10% (dez por cento) do valor total do contrato, aplicável em caso de descumprimento grave ou repetido;

b) REDUÇÃO PROPORCIONAL: Redução do valor a ser pago, correspondente aos serviços não executados, executados de forma inadequada ou fora do prazo estabelecido;

c) CORREÇÃO SEM CUSTO: Obrigação de corrigir, refazer ou completar os serviços sem custo adicional para o CONTRATANTE, dentro de prazo razoável estabelecido;

d) RESCISÃO: O CONTRATANTE poderá rescindir o contrato em caso de descumprimento grave ou repetido, sem prejuízo do recebimento de multa e ressarcimento de prejuízos;

e) PERDAS E DANOS: A CONTRATADA responderá por todos os prejuízos causados ao CONTRATANTE em decorrência do descumprimento, incluindo lucros cessantes e danos morais quando aplicável.

As penalidades serão aplicadas de forma proporcional à gravidade do descumprimento, podendo ser aplicadas cumulativamente quando necessário.`
            };

            const template = templates[tipo];
            if (template) {
                document.getElementById('contratoPenalidades').value = template;
                fecharTemplatesPenalidades();
            }
        }

        // Aplicar template ao campo de objeto
        function aplicarTemplate(tipo) {
            const templates = {
                'criacao-site': `PRESTAÇÃO DE SERVIÇOS - CRIAÇÃO E EDIÇÃO DE SITE

A AUTOVIZION COMERCIAL, pessoa jurídica devidamente constituída, inscrita no CNPJ sob o nº [CNPJ], com sede na [ENDEREÇO COMPLETO], doravante denominada CONTRATADA, se compromete a prestar ao CONTRATANTE, pessoa física/jurídica identificada neste contrato, os seguintes serviços:

1. CRIAÇÃO E EDIÇÃO DE SITE
   Desenvolvimento completo de website responsivo e moderno, incluindo:
   - Design personalizado e profissional
   - Programação e desenvolvimento front-end e back-end
   - Otimização para mecanismos de busca (SEO)
   - Integração com sistemas e ferramentas necessárias
   - Responsividade para dispositivos móveis
   - Manutenção e atualizações conforme necessário

Os serviços serão prestados com qualidade, eficiência e em conformidade com as melhores práticas do mercado digital, utilizando tecnologias atualizadas e profissionais qualificados.

A CONTRATADA se compromete a manter sigilo absoluto sobre todas as informações confidenciais do CONTRATANTE, não divulgando dados comerciais, estratégicos ou operacionais sem prévia autorização escrita.

Todos os códigos, designs e materiais desenvolvidos serão entregues com documentação completa, garantindo que o CONTRATANTE tenha total autonomia sobre o website desenvolvido.`,

                'automacao-redes': `PRESTAÇÃO DE SERVIÇOS - AUTOMAÇÃO PARA REDES SOCIAIS

A AUTOVIZION COMERCIAL, pessoa jurídica devidamente constituída, inscrita no CNPJ sob o nº [CNPJ], com sede na [ENDEREÇO COMPLETO], doravante denominada CONTRATADA, se compromete a prestar ao CONTRATANTE, pessoa física/jurídica identificada neste contrato, os seguintes serviços:

1. AUTOMAÇÃO PARA REDES SOCIAIS
   Configuração e implementação de sistemas automatizados para gestão e publicação de conteúdo em redes sociais, incluindo:
   - Configuração de ferramentas de automação
   - Agendamento de publicações
   - Monitoramento e análise de métricas
   - Respostas automatizadas quando aplicável
   - Integração entre diferentes plataformas sociais
   - Otimização de horários de publicação

A CONTRATADA desenvolverá e implementará soluções de automação personalizadas, visando aumentar a eficiência e os resultados da presença digital do CONTRATANTE.

Todos os sistemas serão configurados com segurança e seguindo as melhores práticas de cada plataforma, garantindo conformidade com as políticas de uso.`,

                'agente-ia': `PRESTAÇÃO DE SERVIÇOS - CRIAÇÃO DE AGENTE IA

A AUTOVIZION COMERCIAL, pessoa jurídica devidamente constituída, inscrita no CNPJ sob o nº [CNPJ], com sede na [ENDEREÇO COMPLETO], doravante denominada CONTRATADA, se compromete a prestar ao CONTRATANTE, pessoa física/jurídica identificada neste contrato, os seguintes serviços:

1. CRIAÇÃO DE AGENTE IA
   Desenvolvimento e implementação de assistente virtual inteligente personalizado, incluindo:
   - Análise de necessidades e definição de funcionalidades
   - Desenvolvimento do agente utilizando inteligência artificial
   - Treinamento e configuração personalizada
   - Integração com sistemas e plataformas do CONTRATANTE
   - Implementação de fluxos de conversação
   - Suporte para atendimento, vendas ou automação de processos
   - Monitoramento e otimização contínua

O agente IA será desenvolvido utilizando tecnologias de ponta em inteligência artificial, garantindo respostas precisas, naturais e alinhadas com a identidade da marca do CONTRATANTE.

A CONTRATADA se compromete a fornecer documentação completa, treinamento e suporte para utilização e manutenção do agente desenvolvido.`,

                'plataforma-propria': `PRESTAÇÃO DE SERVIÇOS - DESENVOLVIMENTO DE PLATAFORMA PRÓPRIA

A AUTOVIZION COMERCIAL, pessoa jurídica devidamente constituída, inscrita no CNPJ sob o nº [CNPJ], com sede na [ENDEREÇO COMPLETO], doravante denominada CONTRATADA, se compromete a prestar ao CONTRATANTE, pessoa física/jurídica identificada neste contrato, os seguintes serviços:

1. DESENVOLVIMENTO DE PLATAFORMA PRÓPRIA
   Criação de plataforma digital personalizada e completa, incluindo:
   - Análise de requisitos e especificações técnicas
   - Arquitetura e design da plataforma
   - Desenvolvimento completo (front-end e back-end)
   - Banco de dados e sistema de gestão
   - Integrações com sistemas externos quando necessário
   - Testes e validações
   - Documentação técnica completa
   - Treinamento para utilização
   - Suporte para implantação

A plataforma será desenvolvida utilizando as melhores práticas de desenvolvimento, tecnologias atualizadas e metodologias ágeis, garantindo qualidade, segurança, performance e escalabilidade.

Todos os códigos, documentações e acessos serão entregues ao CONTRATANTE, garantindo total autonomia e propriedade sobre a plataforma desenvolvida.`,

                'marca-digital': `PRESTAÇÃO DE SERVIÇOS - CRIAÇÃO DE MARCA DIGITAL

A AUTOVIZION COMERCIAL, pessoa jurídica devidamente constituída, inscrita no CNPJ sob o nº [CNPJ], com sede na [ENDEREÇO COMPLETO], doravante denominada CONTRATADA, se compromete a prestar ao CONTRATANTE, pessoa física/jurídica identificada neste contrato, os seguintes serviços:

1. CRIAÇÃO DE MARCA DIGITAL
   Desenvolvimento de identidade visual completa e profissional, incluindo:
   - Criação de logo e variações
   - Definição de paleta de cores
   - Seleção e customização de tipografia
   - Desenvolvimento de elementos gráficos
   - Diretrizes de marca e manual de uso
   - Aplicação da marca em materiais digitais
   - Versões para diferentes aplicações (redes sociais, site, impressos, etc.)

A identidade visual será desenvolvida de forma estratégica, refletindo os valores, posicionamento e objetivos do CONTRATANTE, criando uma marca forte e memorável.

Todos os arquivos e materiais desenvolvidos serão entregues em formatos adequados para uso digital e impresso, garantindo consistência em todas as aplicações.`,

                'social-media-completo': `PRESTAÇÃO DE SERVIÇOS - SOCIAL MEDIA COMPLETO

A AUTOVIZION COMERCIAL, pessoa jurídica devidamente constituída, inscrita no CNPJ sob o nº [CNPJ], com sede na [ENDEREÇO COMPLETO], doravante denominada CONTRATADA, se compromete a prestar ao CONTRATANTE, pessoa física/jurídica identificada neste contrato, os seguintes serviços:

1. CRIAÇÃO DE REDES SOCIAIS
   Criação e configuração de perfis profissionais em redes sociais, incluindo otimização de biografia, capas, conteúdo inicial e estratégia de presença digital.

2. SERVIÇO DE SOCIAL MEDIA
   Gestão completa de redes sociais, incluindo:
   - Criação de conteúdo estratégico e engajador
   - Publicação e agendamento de posts
   - Engajamento com público e comunidade
   - Análise de métricas e relatórios de performance
   - Estratégias de crescimento e alcance
   - Gestão de comentários e mensagens
   - Campanhas e anúncios quando aplicável

A CONTRATADA desenvolverá estratégias personalizadas de social media, alinhadas aos objetivos do CONTRATANTE, visando aumentar visibilidade, engajamento e resultados.

Todos os conteúdos criados serão desenvolvidos com qualidade profissional, mantendo consistência com a identidade visual e os valores da marca do CONTRATANTE.`,

                'analise-estrategica': `PRESTAÇÃO DE SERVIÇOS - ANÁLISE ESTRATÉGICA

A AUTOVIZION COMERCIAL, pessoa jurídica devidamente constituída, inscrita no CNPJ sob o nº [CNPJ], com sede na [ENDEREÇO COMPLETO], doravante denominada CONTRATADA, se compromete a prestar ao CONTRATANTE, pessoa física/jurídica identificada neste contrato, os seguintes serviços:

1. ANÁLISE ESTRATÉGICA
   Realização de análises detalhadas e fornecimento de recomendações estratégicas, incluindo:
   - Análise de mercado e concorrência
   - Análise de público-alvo e personas
   - Análise de oportunidades e ameaças
   - Análise de performance digital
   - Análise de posicionamento de marca
   - Identificação de oportunidades de crescimento
   - Elaboração de relatórios estratégicos completos
   - Recomendações e plano de ação

A CONTRATADA realizará análises profundas utilizando metodologias comprovadas, ferramentas especializadas e conhecimento técnico atualizado, fornecendo insights valiosos para tomada de decisão.

Todos os relatórios e análises serão desenvolvidos com rigor técnico, profissionalismo e confidencialidade, fornecendo ao CONTRATANTE subsídios estratégicos para crescimento e desenvolvimento do negócio.`,

                'pacote-completo': `PRESTAÇÃO DE SERVIÇOS DIGITAIS E TECNOLÓGICOS - PACOTE COMPLETO

A AUTOVIZION COMERCIAL, pessoa jurídica devidamente constituída, inscrita no CNPJ sob o nº [CNPJ], com sede na [ENDEREÇO COMPLETO], doravante denominada CONTRATADA, se compromete a prestar ao CONTRATANTE, pessoa física/jurídica identificada neste contrato, o seguinte pacote completo de serviços digitais e tecnológicos:

1. CRIAÇÃO E EDIÇÃO DE SITE
   Desenvolvimento completo de website responsivo, incluindo design, programação, SEO e manutenção.

2. AUTOMAÇÃO PARA REDES SOCIAIS
   Configuração de sistemas automatizados para gestão e publicação em redes sociais.

3. CRIAÇÃO DE AGENTE IA
   Desenvolvimento de assistente virtual inteligente personalizado para atendimento e automação.

4. DESENVOLVIMENTO DE PLATAFORMA PRÓPRIA
   Criação de plataforma digital personalizada e completa conforme especificações.

5. CRIAÇÃO DE MARCA DIGITAL
   Desenvolvimento de identidade visual completa, incluindo logo, cores, tipografia e diretrizes.

6. CRIAÇÃO DE REDES SOCIAIS
   Criação e configuração de perfis profissionais em redes sociais.

7. SERVIÇO DE SOCIAL MEDIA
   Gestão completa de redes sociais, incluindo conteúdo, publicação, engajamento e análise.

8. ANÁLISE ESTRATÉGICA
   Análises detalhadas de mercado, concorrência e oportunidades, com relatórios e recomendações.

Os serviços serão prestados de forma integrada e coordenada, garantindo sinergia entre todas as soluções desenvolvidas e máxima eficiência para o CONTRATANTE.

A CONTRATADA se compromete a manter sigilo absoluto sobre todas as informações confidenciais do CONTRATANTE e a entregar todos os materiais, códigos e documentações desenvolvidas, garantindo total autonomia ao CONTRATANTE.`
            };

            const template = templates[tipo];
            if (template) {
                document.getElementById('contratoObjeto').value = template;
                fecharTemplatesObjeto();
            }
        }

        // Carregar clientes para select
        async function loadClientesForContratoSelect() {
            try {
                const { data: clientes } = await supabase
                    .from('clientes')
                    .select('id, nome, empresa')
                    .order('nome');
                
                const select = document.getElementById('contratoClienteId');
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Selecione um cliente</option>';
                    if (clientes) {
                        clientes.forEach(cliente => {
                            const nome = cliente.nome || cliente.empresa || 'Cliente';
                            const option = document.createElement('option');
                            option.value = cliente.id;
                            option.textContent = nome;
                            select.appendChild(option);
                        });
                    }
                    select.value = currentValue;
                }
            } catch (e) {
                console.error('Erro ao carregar clientes:', e);
            }
        }

        // Carregar projetos para select
        async function loadProjetosForContratoSelect() {
            try {
                const { data: projetos } = await supabase
                    .from('projetos')
                    .select('id, nome')
                    .order('nome');
                
                const select = document.getElementById('contratoProjetoId');
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Nenhum</option>';
                    if (projetos) {
                        projetos.forEach(projeto => {
                            const option = document.createElement('option');
                            option.value = projeto.id;
                            option.textContent = projeto.nome || 'Projeto';
                            select.appendChild(option);
                        });
                    }
                    select.value = currentValue;
                }
            } catch (e) {
                console.error('Erro ao carregar projetos:', e);
            }
        }

        // Carregar orçamentos para select
        async function loadOrcamentosForContratoSelect() {
            try {
                const { data: orcamentos } = await supabase
                    .from('orcamentos')
                    .select('id, numero, descricao')
                    .order('created_at', { ascending: false });
                
                const select = document.getElementById('contratoOrcamentoId');
                if (select) {
                    const currentValue = select.value;
                    select.innerHTML = '<option value="">Nenhum</option>';
                    if (orcamentos) {
                        orcamentos.forEach(orcamento => {
                            const option = document.createElement('option');
                            option.value = orcamento.id;
                            option.textContent = `#${orcamento.numero || orcamento.id} - ${(orcamento.descricao || '').substring(0, 30)}`;
                            select.appendChild(option);
                        });
                    }
                    select.value = currentValue;
                }
            } catch (e) {
                console.error('Erro ao carregar orçamentos:', e);
            }
        }

        // Toggle parcelas
        function toggleParcelas() {
            const parcelado = document.getElementById('contratoValorParcelado').value === 'true';
            const parcelasGroup = document.getElementById('parcelasGroup');
            if (parcelasGroup) {
                parcelasGroup.style.display = parcelado ? 'block' : 'none';
            }
            if (parcelado) {
                calcularParcela();
            }
        }

        // Toggle valor recorrente
        function toggleValorRecorrente() {
            const tipoPagamento = document.getElementById('contratoTipoPagamento').value;
            const camposRecorrente = document.getElementById('camposValorRecorrente');
            const parcelasGroup = document.getElementById('parcelasGroup');
            const valorParcelado = document.getElementById('contratoValorParcelado');
            const dataInicioRecorrente = document.getElementById('contratoDataInicioRecorrente');
            const dataInicio = document.getElementById('contratoDataInicio');
            
            if (camposRecorrente) {
                camposRecorrente.style.display = tipoPagamento === 'recorrente' ? 'block' : 'none';
            }
            
            // Se for recorrente, desabilitar parcelas
            if (tipoPagamento === 'recorrente') {
                if (parcelasGroup) parcelasGroup.style.display = 'none';
                if (valorParcelado) valorParcelado.value = 'false';
                
                // Se a data de início recorrente estiver vazia, usar a data de início do contrato
                if (dataInicioRecorrente && !dataInicioRecorrente.value && dataInicio && dataInicio.value) {
                    dataInicioRecorrente.value = dataInicio.value;
                }
            }
        }
        
        // Sincronizar data de início recorrente com data de início do contrato
        document.addEventListener('DOMContentLoaded', function() {
            const dataInicio = document.getElementById('contratoDataInicio');
            const dataInicioRecorrente = document.getElementById('contratoDataInicioRecorrente');
            
            if (dataInicio && dataInicioRecorrente) {
                dataInicio.addEventListener('change', function() {
                    const tipoPagamento = document.getElementById('contratoTipoPagamento');
                    if (tipoPagamento && tipoPagamento.value === 'recorrente' && !dataInicioRecorrente.value) {
                        dataInicioRecorrente.value = dataInicio.value;
                    }
                });
            }
        });

        // Calcular valor da parcela
        function calcularParcela() {
            const valorTotal = parseFloat(document.getElementById('contratoValor').value) || 0;
            const numParcelas = parseInt(document.getElementById('contratoNumeroParcelas').value) || 1;
            const valorParcela = valorTotal / numParcelas;
            document.getElementById('contratoValorParcela').value = valorParcela.toFixed(2);
        }

        // Fechar modal
        function closeContratoModal() {
            const modal = document.getElementById('contratoModal');
            closeModal(modal);
            
            // Limpar checkboxes de serviços
            document.querySelectorAll('input[type="checkbox"][id^="servico"]').forEach(cb => {
                cb.checked = false;
            });
        }

        // Editar contrato
        async function editContrato(id) {
            const contrato = allContratos.find(c => c.id === id);
            if (!contrato) return;

            document.getElementById('contratoModalTitle').textContent = 'Editar Contrato';
            document.getElementById('contratoId').value = contrato.id;
            document.getElementById('contratoNumero').value = contrato.numero || '';
            document.getElementById('contratoTipo').value = contrato.tipo_contrato || 'prestacao_servicos';
            document.getElementById('contratoObjeto').value = contrato.objeto || '';
            document.getElementById('contratoDescricao').value = contrato.descricao || '';
            document.getElementById('contratoValor').value = contrato.valor || '';
            document.getElementById('contratoValorParcelado').value = contrato.valor_parcelado ? 'true' : 'false';
            document.getElementById('contratoNumeroParcelas').value = contrato.numero_parcelas || 1;
            document.getElementById('contratoValorParcela').value = contrato.valor_parcela || '';
            document.getElementById('contratoTipoPagamento').value = contrato.tipo_pagamento || 'unico';
            if (document.getElementById('contratoFrequenciaRecorrente')) {
                document.getElementById('contratoFrequenciaRecorrente').value = contrato.frequencia_recorrente || 'mensal';
            }
            if (document.getElementById('contratoValorRecorrente')) {
                document.getElementById('contratoValorRecorrente').value = contrato.valor_recorrente || '';
            }
            if (document.getElementById('contratoDataInicioRecorrente')) {
                document.getElementById('contratoDataInicioRecorrente').value = contrato.data_inicio_recorrente ? contrato.data_inicio_recorrente.split('T')[0] : '';
            }
            if (document.getElementById('contratoNumeroCiclos')) {
                document.getElementById('contratoNumeroCiclos').value = contrato.numero_ciclos || '';
            }
            if (document.getElementById('contratoObservacoesRecorrente')) {
                document.getElementById('contratoObservacoesRecorrente').value = contrato.observacoes_recorrente || '';
            }
            document.getElementById('contratoStatus').value = contrato.status || 'rascunho';
            document.getElementById('contratoDataInicio').value = contrato.data_inicio ? contrato.data_inicio.split('T')[0] : '';
            document.getElementById('contratoDataVencimento').value = contrato.data_vencimento ? contrato.data_vencimento.split('T')[0] : '';
            document.getElementById('contratoPrazoExecucao').value = contrato.prazo_execucao_dias || '';
            document.getElementById('contratoDataAssinatura').value = contrato.data_assinatura ? contrato.data_assinatura.split('T')[0] : '';
            document.getElementById('contratoLocalAssinatura').value = contrato.local_assinatura || '';
            document.getElementById('contratoRenovacaoAutomatica').value = contrato.renovacao_automatica ? 'true' : 'false';
            document.getElementById('contratoPeriodoRenovacao').value = contrato.periodo_renovacao || 30;
            document.getElementById('contratoCondicoesPagamento').value = contrato.condicoes_pagamento || '';
            document.getElementById('contratoContratadoNome').value = contrato.contratado_nome || '';
            document.getElementById('contratoContratadoCnpj').value = contrato.contratado_cnpj || '';
            document.getElementById('contratoContratadoEndereco').value = contrato.contratado_endereco || '';
            document.getElementById('contratoClausulas').value = contrato.clausulas || '';
            document.getElementById('contratoTermosCondicoes').value = contrato.termos_condicoes || '';
            document.getElementById('contratoPenalidades').value = contrato.penalidades || '';
            document.getElementById('contratoForo').value = contrato.foro || '';
            document.getElementById('contratoObservacoes').value = contrato.observacoes || '';
            
            toggleParcelas();
            toggleValorRecorrente();

            await Promise.all([
                loadClientesForContratoSelect(),
                loadProjetosForContratoSelect(),
                loadOrcamentosForContratoSelect()
            ]);

            document.getElementById('contratoClienteId').value = contrato.cliente_id || '';
            document.getElementById('contratoProjetoId').value = contrato.projeto_id || '';
            document.getElementById('contratoOrcamentoId').value = contrato.orcamento_id || '';

            const modal = document.getElementById('contratoModal');
            openModal(modal);
        }

        // Salvar contrato
        document.getElementById('contratoForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();

            const id = document.getElementById('contratoId').value;

            const contratoData = {
                numero: document.getElementById('contratoNumero').value.trim(),
                cliente_id: document.getElementById('contratoClienteId').value,
                projeto_id: document.getElementById('contratoProjetoId').value || null,
                orcamento_id: document.getElementById('contratoOrcamentoId').value || null,
                tipo_contrato: document.getElementById('contratoTipo').value,
                objeto: document.getElementById('contratoObjeto').value.trim(),
                descricao: document.getElementById('contratoDescricao').value.trim() || null,
                valor: parseFloat(document.getElementById('contratoValor').value) || 0,
                valor_parcelado: document.getElementById('contratoValorParcelado').value === 'true',
                numero_parcelas: parseInt(document.getElementById('contratoNumeroParcelas').value) || 1,
                valor_parcela: parseFloat(document.getElementById('contratoValorParcela').value) || null,
                // Campos de valor recorrente - salvos nas observações por enquanto
                tipo_pagamento: document.getElementById('contratoTipoPagamento').value || 'unico',
                // Nota: Campos recorrentes serão salvos nas observações até que as colunas sejam criadas no banco
                // frequencia_recorrente: document.getElementById('contratoFrequenciaRecorrente')?.value || null,
                // valor_recorrente: parseFloat(document.getElementById('contratoValorRecorrente')?.value) || null,
                // data_inicio_recorrente: document.getElementById('contratoDataInicioRecorrente')?.value || null,
                // numero_ciclos: document.getElementById('contratoNumeroCiclos')?.value ? parseInt(document.getElementById('contratoNumeroCiclos').value) : null,
                // observacoes_recorrente: document.getElementById('contratoObservacoesRecorrente')?.value.trim() || null,
                status: document.getElementById('contratoStatus').value,
                data_inicio: document.getElementById('contratoDataInicio').value,
                data_vencimento: document.getElementById('contratoDataVencimento').value,
                prazo_execucao_dias: parseInt(document.getElementById('contratoPrazoExecucao').value) || null,
                data_assinatura: document.getElementById('contratoDataAssinatura').value || null,
                local_assinatura: document.getElementById('contratoLocalAssinatura').value.trim() || null,
                renovacao_automatica: document.getElementById('contratoRenovacaoAutomatica').value === 'true',
                periodo_renovacao: parseInt(document.getElementById('contratoPeriodoRenovacao').value) || 30,
                condicoes_pagamento: document.getElementById('contratoCondicoesPagamento').value.trim() || null,
                contratado_nome: document.getElementById('contratoContratadoNome').value.trim() || null,
                contratado_cnpj: document.getElementById('contratoContratadoCnpj').value.trim() || null,
                contratado_endereco: document.getElementById('contratoContratadoEndereco').value.trim() || null,
                clausulas: document.getElementById('contratoClausulas').value.trim() || null,
                termos_condicoes: document.getElementById('contratoTermosCondicoes').value.trim() || null,
                penalidades: document.getElementById('contratoPenalidades').value.trim() || null,
                foro: document.getElementById('contratoForo').value.trim() || null,
                observacoes: (() => {
                    const obs = document.getElementById('contratoObservacoes').value.trim() || '';
                    const obsRecorrente = document.getElementById('contratoObservacoesRecorrente')?.value.trim() || '';
                    const tipoPagamento = document.getElementById('contratoTipoPagamento').value;
                    
                    if (tipoPagamento === 'recorrente' && obsRecorrente) {
                        const freq = document.getElementById('contratoFrequenciaRecorrente')?.value || '';
                        const valor = document.getElementById('contratoValorRecorrente')?.value || '';
                        const data = document.getElementById('contratoDataInicioRecorrente')?.value || '';
                        const ciclos = document.getElementById('contratoNumeroCiclos')?.value || '';
                        
                        let infoRecorrente = '\n\n=== INFORMAÇÕES DE PAGAMENTO RECORRENTE ===\n';
                        if (freq) infoRecorrente += `Frequência: ${freq}\n`;
                        if (valor) infoRecorrente += `Valor Recorrente: R$ ${valor}\n`;
                        if (data) infoRecorrente += `Data de Início: ${data}\n`;
                        if (ciclos) infoRecorrente += `Número de Ciclos: ${ciclos}\n`;
                        if (obsRecorrente) infoRecorrente += `Observações: ${obsRecorrente}\n`;
                        
                        return (obs + infoRecorrente).trim();
                    }
                    return obs;
                })()
            };

            try {
                if (id) {
                    const { error } = await supabase
                        .from('contratos')
                        .update(contratoData)
                        .eq('id', id);

                    if (error) throw error;
                    alert('Contrato atualizado com sucesso!');
                } else {
                    const { error } = await supabase
                        .from('contratos')
                        .insert([contratoData]);

                    if (error) throw error;
                    alert('Contrato criado com sucesso!');
                }

                closeContratoModal();
                loadContratos();
            } catch (error) {
                console.error('Erro ao salvar contrato:', error);
                alert('Erro ao salvar contrato: ' + (error.message || 'Erro desconhecido'));
            }
        });

        // Ver detalhes do contrato
        async function viewContratoDetails(id) {
            const contrato = allContratos.find(c => c.id === id);
            if (!contrato) {
                alert('Contrato não encontrado');
                return;
            }

            const cliente = contrato.cliente || {};
            const projeto = contrato.projeto || {};
            const orcamento = contrato.orcamento || {};

                const statusMap = {
                    'rascunho': { label: 'Rascunho', class: 'badge-rascunho' },
                    'aguardando_assinatura': { label: 'Aguardando Assinatura', class: 'badge-enviado' },
                    'ativo': { label: 'Ativo', class: 'badge-ativo' },
                    'vencido': { label: 'Vencido', class: 'badge-inativo' },
                    'renovado': { label: 'Renovado', class: 'badge-concluido' },
                    'cancelado': { label: 'Cancelado', class: 'badge-cancelado' }
                };

                const status = statusMap[contrato.status] || { label: contrato.status, class: 'badge-rascunho' };
                
                const tipoMap = {
                    'prestacao_servicos': 'Prestação de Serviços',
                    'fornecimento': 'Fornecimento de Produtos',
                    'locacao': 'Locação',
                    'licenciamento': 'Licenciamento',
                    'parceria': 'Parceria',
                    'outro': 'Outro'
                };
                const tipoLabel = tipoMap[contrato.tipo_contrato] || contrato.tipo_contrato || 'Não especificado';

            // Verificar se está vencido
            const hoje = new Date();
            const vencimento = new Date(contrato.data_vencimento);
            const diasRestantes = Math.ceil((vencimento - hoje) / (1000 * 60 * 60 * 24));
            const estaVencido = diasRestantes < 0;

            const content = document.getElementById('contratoDetailsContent');
            content.innerHTML = `
                <div class="details-section">
                    <div class="details-section-title">Informações do Contrato</div>
                    <div class="details-grid">
                        <div class="details-item">
                            <div class="details-label">Número</div>
                            <div class="details-value">${contrato.numero || '-'}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Tipo</div>
                            <div class="details-value">${tipoLabel}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Status</div>
                            <div class="details-value">
                                <span class="badge ${status.class}">${status.label}</span>
                            </div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Cliente</div>
                            <div class="details-value">${cliente.nome || cliente.empresa || 'Não informado'}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Valor Total</div>
                            <div class="details-value" style="color: var(--primary); font-weight: 600;">${formatCurrency(contrato.valor || 0)}</div>
                        </div>
                        ${contrato.valor_parcelado ? `
                        <div class="details-item">
                            <div class="details-label">Pagamento</div>
                            <div class="details-value">${contrato.numero_parcelas || 1}x de ${formatCurrency(contrato.valor_parcela || 0)}</div>
                        </div>
                        ` : ''}
                        <div class="details-item">
                            <div class="details-label">Data de Início</div>
                            <div class="details-value">${formatDate(contrato.data_inicio)}</div>
                        </div>
                        <div class="details-item">
                            <div class="details-label">Data de Vencimento</div>
                            <div class="details-value" style="${estaVencido ? 'color: var(--danger);' : ''}">
                                ${formatDate(contrato.data_vencimento)}
                                ${estaVencido ? ' ⚠️ Vencido' : diasRestantes <= 30 ? ` ⏰ ${diasRestantes} dias restantes` : ''}
                            </div>
                        </div>
                        ${contrato.prazo_execucao_dias ? `
                        <div class="details-item">
                            <div class="details-label">Prazo de Execução</div>
                            <div class="details-value">${contrato.prazo_execucao_dias} dias</div>
                        </div>
                        ` : ''}
                        ${contrato.data_assinatura ? `
                        <div class="details-item">
                            <div class="details-label">Data de Assinatura</div>
                            <div class="details-value">${formatDate(contrato.data_assinatura)}</div>
                        </div>
                        ` : ''}
                        ${contrato.local_assinatura ? `
                        <div class="details-item">
                            <div class="details-label">Local de Assinatura</div>
                            <div class="details-value">${contrato.local_assinatura}</div>
                        </div>
                        ` : ''}
                        ${projeto.id ? `
                        <div class="details-item">
                            <div class="details-label">Projeto</div>
                            <div class="details-value">${projeto.nome || '-'}</div>
                        </div>
                        ` : ''}
                        ${orcamento.id ? `
                        <div class="details-item">
                            <div class="details-label">Orçamento</div>
                            <div class="details-value">#${orcamento.numero || orcamento.id}</div>
                        </div>
                        ` : ''}
                    </div>
                </div>

                ${contrato.objeto ? `
                <div class="details-section">
                    <div class="details-section-title">Objeto do Contrato</div>
                    <div class="details-item">
                        <div class="details-value" style="white-space: pre-wrap;">${contrato.objeto}</div>
                    </div>
                </div>
                ` : ''}

                ${contrato.descricao ? `
                <div class="details-section">
                    <div class="details-section-title">Descrição/Resumo</div>
                    <div class="details-item">
                        <div class="details-value" style="white-space: pre-wrap;">${contrato.descricao}</div>
                    </div>
                </div>
                ` : ''}

                ${contrato.condicoes_pagamento ? `
                <div class="details-section">
                    <div class="details-section-title">Condições de Pagamento</div>
                    <div class="details-item">
                        <div class="details-value" style="white-space: pre-wrap;">${contrato.condicoes_pagamento}</div>
                    </div>
                </div>
                ` : ''}

                <div class="details-section">
                    <div class="details-section-title">Configurações</div>
                    <div class="details-grid">
                        <div class="details-item">
                            <div class="details-label">Renovação Automática</div>
                            <div class="details-value">${contrato.renovacao_automatica ? '✅ Sim' : '❌ Não'}</div>
                        </div>
                        ${contrato.renovacao_automatica ? `
                        <div class="details-item">
                            <div class="details-label">Período de Renovação</div>
                            <div class="details-value">${contrato.periodo_renovacao || 30} dias</div>
                        </div>
                        ` : ''}
                    </div>
                </div>

                ${contrato.clausulas ? `
                <div class="details-section">
                    <div class="details-section-title">Cláusulas Específicas</div>
                    <div class="details-item">
                        <div class="details-value" style="white-space: pre-wrap;">${contrato.clausulas}</div>
                    </div>
                </div>
                ` : ''}

                ${contrato.termos_condicoes ? `
                <div class="details-section">
                    <div class="details-section-title">Termos e Condições</div>
                    <div class="details-item">
                        <div class="details-value" style="white-space: pre-wrap;">${contrato.termos_condicoes}</div>
                    </div>
                </div>
                ` : ''}

                ${contrato.penalidades ? `
                <div class="details-section">
                    <div class="details-section-title">Penalidades</div>
                    <div class="details-item">
                        <div class="details-value" style="white-space: pre-wrap;">${contrato.penalidades}</div>
                    </div>
                </div>
                ` : ''}

                ${contrato.foro ? `
                <div class="details-section">
                    <div class="details-section-title">Foro</div>
                    <div class="details-item">
                        <div class="details-value">${contrato.foro}</div>
                    </div>
                </div>
                ` : ''}

                ${contrato.observacoes ? `
                <div class="details-section">
                    <div class="details-section-title">Observações</div>
                    <div class="details-item">
                        <div class="details-value" style="white-space: pre-wrap;">${contrato.observacoes}</div>
                    </div>
                </div>
                ` : ''}
            `;

            // Configurar botões
            document.getElementById('editContratoFromDetailsBtn').onclick = () => {
                closeContratoDetailsModal();
                editContrato(id);
            };

            document.getElementById('deleteContratoFromDetailsBtn').onclick = () => {
                if (confirm('Tem certeza que deseja excluir este contrato?')) {
                    deleteContrato(id);
                }
            };

            document.getElementById('renovarContratoBtn').onclick = () => {
                renovarContrato(id);
            };

            document.getElementById('gerarPDFContratoBtn').onclick = () => {
                gerarPDFContrato(id);
            };

            // Mostrar/ocultar botão renovar
            if (contrato.status === 'ativo' && !estaVencido) {
                document.getElementById('renovarContratoBtn').style.display = 'inline-block';
            } else {
                document.getElementById('renovarContratoBtn').style.display = 'none';
            }

            const modal = document.getElementById('contratoDetailsModal');
            openModal(modal);
        }

        // Fechar modal de detalhes
        function closeContratoDetailsModal() {
            const modal = document.getElementById('contratoDetailsModal');
            closeModal(modal);
        }

        // Excluir contrato
        async function deleteContrato(id) {
            if (!confirm('Tem certeza que deseja excluir este contrato?')) return;

            try {
                const { error } = await supabase
                    .from('contratos')
                    .delete()
                    .eq('id', id);

                if (error) throw error;
                alert('Contrato excluído com sucesso!');
                closeContratoDetailsModal();
                loadContratos();
            } catch (error) {
                console.error('Erro ao excluir contrato:', error);
                alert('Erro ao excluir contrato: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // Renovar contrato
        async function renovarContrato(id) {
            const contrato = allContratos.find(c => c.id === id);
            if (!contrato) return;

            if (!confirm(`Deseja renovar o contrato ${contrato.numero}?`)) return;

            try {
                const periodoRenovacao = contrato.periodo_renovacao || 30;
                const dataVencimentoAtual = new Date(contrato.data_vencimento);
                const novaDataVencimento = new Date(dataVencimentoAtual);
                novaDataVencimento.setDate(novaDataVencimento.getDate() + periodoRenovacao);

                const { error } = await supabase
                    .from('contratos')
                    .update({
                        status: 'renovado',
                        data_vencimento: novaDataVencimento.toISOString().split('T')[0],
                        data_renovacao: new Date().toISOString()
                    })
                    .eq('id', id);

                if (error) throw error;
                alert('Contrato renovado com sucesso!');
                closeContratoDetailsModal();
                loadContratos();
            } catch (error) {
                console.error('Erro ao renovar contrato:', error);
                alert('Erro ao renovar contrato: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // Gerar PDF do Contrato
        async function gerarPDFContrato(contratoId) {
            try {
                // Verificar se jsPDF está disponível
                if (!window.jspdf) {
                    alert('Biblioteca de PDF não carregada. Por favor, recarregue a página.');
                    return;
                }

                // Buscar dados completos do contrato
                let contrato = allContratos.find(c => c.id === contratoId);
                if (!contrato) {
                    const { data: contratoData, error } = await supabase
                        .from('contratos')
                        .select('*, cliente:clientes(*), projeto:projetos(*), orcamento:orcamentos(*)')
                        .eq('id', contratoId)
                        .single();
                    
                    if (error) throw error;
                    if (!contratoData) {
                        alert('Contrato não encontrado');
                        return;
                    }
                    contrato = contratoData;
                }

                const cliente = contrato.cliente || {};
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                const margin = 20;
                const pageWidth = doc.internal.pageSize.getWidth();
                const pageHeight = doc.internal.pageSize.getHeight();
                let y = margin;

                // Funções auxiliares
                const formatCurrencyPDF = (value) => {
                    if (!value && value !== 0) return 'R$ 0,00';
                    return new Intl.NumberFormat('pt-BR', {
                        style: 'currency',
                        currency: 'BRL'
                    }).format(value);
                };

                const formatDatePDF = (dateStr) => {
                    if (!dateStr) return '-';
                    try {
                        const date = new Date(dateStr);
                        return date.toLocaleDateString('pt-BR');
                    } catch {
                        return dateStr;
                    }
                };

                // ========== CABEÇALHO ==========
                doc.setFillColor(255, 102, 0);
                doc.rect(0, 0, pageWidth, 45, 'F');
                
                doc.setFontSize(20);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 255, 255);
                doc.text('CONTRATO', pageWidth / 2, 20, { align: 'center' });
                
                doc.setFontSize(14);
                doc.setFont(undefined, 'normal');
                doc.text(`Nº ${contrato.numero || 'N/A'}`, pageWidth / 2, 35, { align: 'center' });
                
                y = 55;

                // ========== PARTES CONTRATANTES ==========
                doc.setFillColor(240, 240, 240);
                doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('PARTES CONTRATANTES', margin + 3, y + 4);
                y += 15;

                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);

                // CONTRATANTE (Cliente)
                doc.setFont(undefined, 'bold');
                doc.text('CONTRATANTE:', margin, y);
                y += 6;
                doc.setFont(undefined, 'normal');
                const contratanteNome = cliente.nome || cliente.empresa || 'Não informado';
                doc.text(`${contratanteNome}`, margin + 5, y);
                y += 5;
                if (cliente.cpf_cnpj) {
                    doc.text(`CPF/CNPJ: ${cliente.cpf_cnpj}`, margin + 5, y);
                    y += 5;
                }
                if (cliente.endereco) {
                    let enderecoCompleto = cliente.endereco;
                    if (cliente.cidade) enderecoCompleto += `, ${cliente.cidade}`;
                    if (cliente.estado) enderecoCompleto += ` - ${cliente.estado}`;
                    doc.text(`Endereço: ${enderecoCompleto}`, margin + 5, y);
                    y += 5;
                }
                if (cliente.telefone) {
                    doc.text(`Telefone: ${cliente.telefone}`, margin + 5, y);
                    y += 5;
                }
                if (cliente.email) {
                    doc.text(`E-mail: ${cliente.email}`, margin + 5, y);
                    y += 5;
                }
                y += 3;

                // CONTRATADO (AUTOVIZION)
                doc.setFont(undefined, 'bold');
                doc.text('CONTRATADO:', margin, y);
                y += 6;
                doc.setFont(undefined, 'normal');
                const contratadoNome = contrato.contratado_nome || 'AUTOVIZION COMERCIAL';
                const contratadoCnpj = contrato.contratado_cnpj || 'CNPJ não informado';
                const contratadoEndereco = contrato.contratado_endereco || 'Endereço não informado';
                
                doc.text(`${contratadoNome}`, margin + 5, y);
                y += 5;
                doc.text(`CNPJ: ${contratadoCnpj}`, margin + 5, y);
                y += 5;
                doc.text(`Endereço: ${contratadoEndereco}`, margin + 5, y);
                y += 10;

                // ========== OBJETO DO CONTRATO ==========
                if (y > pageHeight - 60) {
                    doc.addPage();
                    y = margin + 10;
                }

                doc.setFillColor(240, 240, 240);
                doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('OBJETO DO CONTRATO', margin + 3, y + 4);
                y += 15;

                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                const objeto = contrato.objeto || contrato.descricao || 'Não especificado';
                const objetoLines = doc.splitTextToSize(objeto, pageWidth - (margin * 2));
                doc.text(objetoLines, margin, y);
                y += objetoLines.length * 5 + 10;

                // ========== DESCRIÇÃO DETALHADA ==========
                if (contrato.descricao && contrato.descricao !== objeto) {
                    if (y > pageHeight - 60) {
                        doc.addPage();
                        y = margin + 10;
                    }

                    doc.setFillColor(240, 240, 240);
                    doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                    
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('DESCRIÇÃO DETALHADA', margin + 3, y + 4);
                    y += 15;

                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(10);
                    const descricaoLines = doc.splitTextToSize(contrato.descricao, pageWidth - (margin * 2));
                    doc.text(descricaoLines, margin, y);
                    y += descricaoLines.length * 5 + 10;
                }

                // ========== VALOR E CONDIÇÕES ==========
                if (y > pageHeight - 80) {
                    doc.addPage();
                    y = margin + 10;
                }

                doc.setFillColor(240, 240, 240);
                doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('VALOR E CONDIÇÕES DE PAGAMENTO', margin + 3, y + 4);
                y += 15;

                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                
                doc.setFont(undefined, 'bold');
                doc.text('Valor Total:', margin, y);
                doc.setFont(undefined, 'normal');
                doc.text(formatCurrencyPDF(contrato.valor || 0), margin + 40, y);
                y += 8;

                // Tipo de pagamento
                if (contrato.tipo_pagamento === 'recorrente') {
                    doc.setFont(undefined, 'bold');
                    doc.text('Tipo de Pagamento: RECORRENTE', margin, y);
                    y += 6;
                    doc.setFont(undefined, 'normal');
                    
                    const frequenciaMap = {
                        'mensal': 'Mensal',
                        'trimestral': 'Trimestral (3 meses)',
                        'semestral': 'Semestral (6 meses)',
                        'anual': 'Anual (12 meses)'
                    };
                    const frequencia = frequenciaMap[contrato.frequencia_recorrente] || contrato.frequencia_recorrente || 'Mensal';
                    
                    doc.text(`Frequência: ${frequencia}`, margin, y);
                    y += 6;
                    
                    if (contrato.valor_recorrente) {
                        doc.text(`Valor Recorrente: ${formatCurrencyPDF(contrato.valor_recorrente)}`, margin, y);
                        y += 6;
                    }
                    
                    if (contrato.data_inicio_recorrente) {
                        doc.text(`Início da Cobrança: ${formatDatePDF(contrato.data_inicio_recorrente)}`, margin, y);
                        y += 6;
                    }
                    
                    if (contrato.numero_ciclos) {
                        doc.text(`Número de Ciclos: ${contrato.numero_ciclos}`, margin, y);
                        y += 6;
                    } else {
                        doc.text('Número de Ciclos: Ilimitado', margin, y);
                        y += 6;
                    }
                    
                    if (contrato.observacoes_recorrente) {
                        doc.text('Observações sobre Pagamento Recorrente:', margin, y);
                        y += 5;
                        const obsRecorrenteLines = doc.splitTextToSize(contrato.observacoes_recorrente, pageWidth - (margin * 2));
                        doc.text(obsRecorrenteLines, margin + 5, y);
                        y += obsRecorrenteLines.length * 5 + 5;
                    }
                } else {
                    if (contrato.valor_parcelado) {
                        doc.text(`Pagamento Parcelado: ${contrato.numero_parcelas || 1}x de ${formatCurrencyPDF(contrato.valor_parcela || 0)}`, margin, y);
                        y += 6;
                    } else {
                        doc.text('Pagamento: À Vista', margin, y);
                        y += 6;
                    }
                }

                if (contrato.condicoes_pagamento) {
                    doc.text('Condições de Pagamento:', margin, y);
                    y += 5;
                    const condicoesLines = doc.splitTextToSize(contrato.condicoes_pagamento, pageWidth - (margin * 2));
                    doc.text(condicoesLines, margin + 5, y);
                    y += condicoesLines.length * 5 + 5;
                }

                // ========== PRAZO E DATAS ==========
                if (y > pageHeight - 60) {
                    doc.addPage();
                    y = margin + 10;
                }

                doc.setFillColor(240, 240, 240);
                doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('PRAZO E DATAS', margin + 3, y + 4);
                y += 15;

                doc.setFont(undefined, 'normal');
                doc.setFontSize(10);
                doc.text(`Data de Início: ${formatDatePDF(contrato.data_inicio)}`, margin, y);
                y += 6;
                doc.text(`Data de Vencimento: ${formatDatePDF(contrato.data_vencimento)}`, margin, y);
                y += 6;
                if (contrato.prazo_execucao_dias) {
                    doc.text(`Prazo de Execução: ${contrato.prazo_execucao_dias} dias`, margin, y);
                    y += 6;
                }
                if (contrato.data_assinatura) {
                    doc.text(`Data de Assinatura: ${formatDatePDF(contrato.data_assinatura)}`, margin, y);
                    y += 6;
                }
                if (contrato.local_assinatura) {
                    doc.text(`Local de Assinatura: ${contrato.local_assinatura}`, margin, y);
                    y += 6;
                }
                y += 5;

                // ========== CLÁUSULAS ==========
                if (contrato.clausulas) {
                    if (y > pageHeight - 60) {
                        doc.addPage();
                        y = margin + 10;
                    }

                    doc.setFillColor(240, 240, 240);
                    doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                    
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('CLÁUSULAS ESPECÍFICAS', margin + 3, y + 4);
                    y += 15;

                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(9);
                    const clausulasLines = doc.splitTextToSize(contrato.clausulas, pageWidth - (margin * 2));
                    doc.text(clausulasLines, margin, y);
                    y += clausulasLines.length * 4 + 5;
                }

                // ========== TERMOS E CONDIÇÕES ==========
                if (contrato.termos_condicoes) {
                    if (y > pageHeight - 60) {
                        doc.addPage();
                        y = margin + 10;
                    }

                    doc.setFillColor(240, 240, 240);
                    doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                    
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('TERMOS E CONDIÇÕES GERAIS', margin + 3, y + 4);
                    y += 15;

                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(9);
                    const termosLines = doc.splitTextToSize(contrato.termos_condicoes, pageWidth - (margin * 2));
                    doc.text(termosLines, margin, y);
                    y += termosLines.length * 4 + 5;
                }

                // ========== PENALIDADES ==========
                if (contrato.penalidades) {
                    if (y > pageHeight - 60) {
                        doc.addPage();
                        y = margin + 10;
                    }

                    doc.setFillColor(240, 240, 240);
                    doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                    
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.text('PENALIDADES', margin + 3, y + 4);
                    y += 15;

                    doc.setFont(undefined, 'normal');
                    doc.setFontSize(9);
                    const penalidadesLines = doc.splitTextToSize(contrato.penalidades, pageWidth - (margin * 2));
                    doc.text(penalidadesLines, margin, y);
                    y += penalidadesLines.length * 4 + 5;
                }

                // ========== RESPONSABILIDADES ==========
                if (y > pageHeight - 80) {
                    doc.addPage();
                    y = margin + 10;
                }

                doc.setFillColor(240, 240, 240);
                doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('RESPONSABILIDADES DAS PARTES', margin + 3, y + 4);
                y += 15;

                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                const responsabilidades = `CONTRATADA (AUTOVIZION COMERCIAL):
• Prestar os serviços contratados com qualidade, eficiência e profissionalismo
• Cumprir os prazos estabelecidos para execução dos serviços
• Manter sigilo absoluto sobre informações confidenciais do CONTRATANTE
• Fornecer documentação completa dos serviços prestados
• Garantir a qualidade e funcionamento adequado das soluções desenvolvidas
• Prestar suporte técnico conforme acordado

CONTRATANTE:
• Fornecer todas as informações necessárias para execução dos serviços
• Realizar os pagamentos conforme condições estabelecidas
• Colaborar ativamente no processo de desenvolvimento
• Fornecer feedback e aprovações em tempo hábil
• Respeitar os prazos estabelecidos para fornecimento de materiais e informações`;

                const responsabilidadesLines = doc.splitTextToSize(responsabilidades, pageWidth - (margin * 2));
                doc.text(responsabilidadesLines, margin, y);
                y += responsabilidadesLines.length * 4 + 10;

                // ========== GARANTIAS ==========
                if (y > pageHeight - 60) {
                    doc.addPage();
                    y = margin + 10;
                }

                doc.setFillColor(240, 240, 240);
                doc.rect(margin, y - 3, pageWidth - (margin * 2), 10, 'F');
                
                doc.setFontSize(12);
                doc.setFont(undefined, 'bold');
                doc.text('GARANTIAS', margin + 3, y + 4);
                y += 15;

                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                const garantias = `A CONTRATADA garante que:
• Todos os serviços serão executados por profissionais qualificados
• As soluções desenvolvidas estarão em conformidade com as especificações acordadas
• Será fornecida documentação completa e adequada
• Os materiais entregues estarão livres de vírus e malwares
• Será mantido sigilo sobre informações confidenciais
• As soluções desenvolvidas serão originais e não violarão direitos de terceiros

Em caso de não conformidade, a CONTRATADA se compromete a corrigir os problemas identificados sem custo adicional, dentro de prazo razoável.`;

                const garantiasLines = doc.splitTextToSize(garantias, pageWidth - (margin * 2));
                doc.text(garantiasLines, margin, y);
                y += garantiasLines.length * 4 + 10;

                // ========== FORO ==========
                if (contrato.foro) {
                    if (y > pageHeight - 40) {
                        doc.addPage();
                        y = margin + 10;
                    }

                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.text('FORO:', margin, y);
                    doc.setFont(undefined, 'normal');
                    doc.text(contrato.foro, margin + 20, y);
                    y += 10;
                } else {
                    // Foro padrão se não especificado
                    if (y > pageHeight - 40) {
                        doc.addPage();
                        y = margin + 10;
                    }
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'bold');
                    doc.text('FORO:', margin, y);
                    doc.setFont(undefined, 'normal');
                    doc.text('Fica eleito o foro da comarca de [CIDADE], Estado de [ESTADO], para dirimir quaisquer controvérsias oriundas deste contrato.', margin + 20, y);
                    y += 10;
                }

                // ========== ASSINATURAS ==========
                if (y > pageHeight - 50) {
                    doc.addPage();
                    y = margin + 10;
                }

                y += 10;
                doc.setFontSize(10);
                doc.setFont(undefined, 'bold');
                doc.text('ASSINATURAS', pageWidth / 2, y, { align: 'center' });
                y += 15;

                // Linha para assinatura do contratante (CLIENTE) - ESQUERDA
                doc.setFont(undefined, 'normal');
                doc.setFontSize(9);
                const linhaY = y;
                doc.line(margin, linhaY, margin + 80, linhaY);
                // Nome abaixo da linha
                doc.text(contratanteNome, margin + 40, linhaY + 6, { align: 'center' });
                // Label abaixo do nome
                doc.text('CONTRATANTE', margin + 40, linhaY + 14, { align: 'center' });
                
                // Linha para assinatura do contratado (AUTOVIZION) - DIREITA
                doc.line(pageWidth - margin - 80, linhaY, pageWidth - margin, linhaY);
                // Sempre usar AUTOVIZION COMERCIAL como contratado
                const nomeAutovizion = 'AUTOVIZION COMERCIAL';
                // Nome abaixo da linha
                doc.text(nomeAutovizion, pageWidth - margin - 40, linhaY + 6, { align: 'center' });
                // Label abaixo do nome
                doc.text('CONTRATADO', pageWidth - margin - 40, linhaY + 14, { align: 'center' });

                // ========== RODAPÉ ==========
                const contatoY = pageHeight - 8;
                doc.setFontSize(7);
                doc.setTextColor(128, 128, 128);
                doc.setFont(undefined, 'normal');
                doc.text('AUTOVIZION', margin, contatoY);
                doc.text('|', margin + 25, contatoY);
                doc.text('www.autovizon.com.br', margin + 30, contatoY);
                doc.text('|', margin + 70, contatoY);
                doc.text('autovizioncomercial@gmail.com', margin + 75, contatoY);
                doc.text('|', margin + 130, contatoY);
                doc.text('(14) 99683-3385', margin + 135, contatoY);

                // Salvar PDF
                const clienteNome = cliente.nome || cliente.empresa || 'Cliente';
                const fileName = `Contrato_${contrato.numero || contratoId}_${clienteNome.replace(/[^a-zA-Z0-9]/g, '_')}.pdf`;
                doc.save(fileName);

                alert('PDF do contrato gerado com sucesso!');
            } catch (error) {
                console.error('Erro ao gerar PDF do contrato:', error);
                alert('Erro ao gerar PDF: ' + (error.message || 'Erro desconhecido'));
            }
        }

        // Preview PDF (sem salvar)
        async function previewContratoPDF() {
            // Verificar se o formulário está preenchido
            const objeto = document.getElementById('contratoObjeto').value;
            const clienteId = document.getElementById('contratoClienteId').value;
            
            if (!objeto || !clienteId) {
                alert('Por favor, preencha o Objeto do Contrato e selecione um Cliente antes de visualizar o PDF.');
                return;
            }

            // Criar objeto temporário com dados do formulário
            const contratoTemp = {
                id: document.getElementById('contratoId').value || 'temp',
                numero: document.getElementById('contratoNumero').value || 'CTR-0000',
                cliente: {
                    nome: document.getElementById('contratoClienteId').selectedOptions[0]?.text || 'Cliente',
                    cpf_cnpj: '',
                    endereco: '',
                    cidade: '',
                    estado: '',
                    telefone: '',
                    email: ''
                },
                objeto: objeto,
                descricao: document.getElementById('contratoDescricao').value || '',
                valor: parseFloat(document.getElementById('contratoValor').value) || 0,
                valor_parcelado: document.getElementById('contratoValorParcelado').value === 'true',
                numero_parcelas: parseInt(document.getElementById('contratoNumeroParcelas').value) || 1,
                valor_parcela: parseFloat(document.getElementById('contratoValorParcela').value) || null,
                data_inicio: document.getElementById('contratoDataInicio').value,
                data_vencimento: document.getElementById('contratoDataVencimento').value,
                prazo_execucao_dias: parseInt(document.getElementById('contratoPrazoExecucao').value) || null,
                data_assinatura: document.getElementById('contratoDataAssinatura').value || null,
                local_assinatura: document.getElementById('contratoLocalAssinatura').value || null,
                condicoes_pagamento: document.getElementById('contratoCondicoesPagamento').value || '',
                contratado_nome: document.getElementById('contratoContratadoNome').value || 'AUTOVIZION COMERCIAL',
                contratado_cnpj: document.getElementById('contratoContratadoCnpj').value || '',
                contratado_endereco: document.getElementById('contratoContratadoEndereco').value || '',
                clausulas: document.getElementById('contratoClausulas').value || '',
                termos_condicoes: document.getElementById('contratoTermosCondicoes').value || '',
                penalidades: document.getElementById('contratoPenalidades').value || '',
                foro: document.getElementById('contratoForo').value || ''
            };

            // Buscar dados do cliente se selecionado
            if (clienteId) {
                try {
                    const { data: cliente } = await supabase
                        .from('clientes')
                        .select('*')
                        .eq('id', clienteId)
                        .single();
                    
                    if (cliente) {
                        contratoTemp.cliente = cliente;
                    }
                } catch (e) {
                    console.warn('Erro ao buscar cliente:', e);
                }
            }

            // Gerar PDF com dados temporários
            allContratos.push(contratoTemp);
            await gerarPDFContrato(contratoTemp.id);
            allContratos.pop();
        }

        // Verificar autenticação ao carregar
        aplicarConfiguracaoPlataforma();
        
        // Verificar se é acesso público primeiro
        verificarAcessoPublico().then(isPublic => {
            if (!isPublic) {
                // Se não for acesso público, verificar autenticação normal
                checkAuth();
            }
        });
    </script>

    <!-- ========== ASSISTENTE ORION ========== -->
    <div id="orionContainer" class="orion-container">
        <!-- Interface Principal do Orion -->
        <div id="orionInterface" class="orion-interface">
            <!-- Cabeçalho com Status -->
            <div class="orion-header">
                <div class="orion-status">
                    <div class="orion-pulse"></div>
                    <span id="orionStatusText">Pronto</span>
                </div>
                <div style="display: flex; gap: 8px; align-items: center;">
                    <button id="orionToggleBtn" class="orion-toggle-btn" onclick="startOrionListening()" title="Clique para falar">
                        <span id="orionToggleIcon">🎤</span>
                </button>
                    <button class="orion-close-btn" onclick="toggleOrion()" title="Fechar Orion">✕</button>
                </div>
            </div>

            <!-- Visualização de Comando -->
            <div id="orionCommandDisplay" class="orion-command-display">
                <div class="orion-waveform">
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                    <div class="wave-bar"></div>
                </div>
                <div id="orionCommandText" class="orion-command-text">Clique no microfone 🎤 e fale seu comando</div>
                <div style="font-size: 11px; color: rgba(0, 255, 255, 0.6); text-align: center; margin-top: 5px;">
                    Ex: "ir para dashboard" ou "criar novo cliente"
                </div>
            </div>

            <!-- Resposta do Orion -->
            <div id="orionResponse" class="orion-response">
                <div class="orion-avatar">
                    <img src="https://zhzhpctsndrcedukivhk.supabase.co/storage/v1/object/public/logo/ChatGPT%20Image%2017%20de%20jul.%20de%202025,%2012_31_19.png" alt="Orion" class="orion-avatar-img">
                </div>
                <div id="orionResponseText" class="orion-response-text"></div>
            </div>

            <!-- Histórico de Comandos -->
            <div id="orionHistory" class="orion-history"></div>
        </div>

        <!-- Botão Flutuante (quando minimizado) -->
        <button id="orionFloatBtn" class="orion-float-btn" onclick="toggleOrion()" title="Ativar Orion">
            <img src="https://zhzhpctsndrcedukivhk.supabase.co/storage/v1/object/public/logo/ChatGPT%20Image%2017%20de%20jul.%20de%202025,%2012_31_19.png" alt="Orion" class="orion-float-icon">
            <div class="orion-float-pulse"></div>
        </button>
    </div>

    <style>
        /* ========== ESTILOS DO ORION ========== */
        .orion-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 10000;
            font-family: 'Montserrat', sans-serif;
        }

        .orion-interface {
            width: 400px;
            max-height: 600px;
            background: linear-gradient(135deg, rgba(0, 0, 0, 0.95) 0%, rgba(20, 20, 40, 0.98) 100%);
            border: 2px solid rgba(0, 255, 255, 0.3);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 10px 40px rgba(0, 255, 255, 0.2),
                        0 0 60px rgba(0, 255, 255, 0.1),
                        inset 0 0 20px rgba(0, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            display: none;
            flex-direction: column;
            gap: 15px;
            animation: orionSlideIn 0.3s ease-out;
        }

        .orion-interface.active {
            display: flex;
        }

        @keyframes orionSlideIn {
            from {
                opacity: 0;
                transform: translateY(20px) scale(0.9);
            }
            to {
                opacity: 1;
                transform: translateY(0) scale(1);
            }
        }

        .orion-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-bottom: 10px;
            border-bottom: 1px solid rgba(0, 255, 255, 0.2);
        }

        .orion-status {
            display: flex;
            align-items: center;
            gap: 10px;
            color: #00ffff;
            font-size: 14px;
            font-weight: 600;
        }

        .orion-pulse {
            width: 10px;
            height: 10px;
            background: #00ffff;
            border-radius: 50%;
            animation: orionPulse 2s infinite;
            box-shadow: 0 0 10px #00ffff;
        }

        @keyframes orionPulse {
            0%, 100% {
                opacity: 1;
                transform: scale(1);
            }
            50% {
                opacity: 0.5;
                transform: scale(1.2);
            }
        }

        .orion-toggle-btn {
            background: rgba(0, 255, 255, 0.1);
            border: 1px solid rgba(0, 255, 255, 0.3);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 20px;
        }

        .orion-toggle-btn:hover {
            background: rgba(0, 255, 255, 0.2);
            box-shadow: 0 0 15px rgba(0, 255, 255, 0.4);
        }

        .orion-toggle-btn.listening {
            background: rgba(255, 0, 0, 0.2);
            border-color: #ff0000;
            animation: orionListening 1s infinite;
        }

        .orion-close-btn {
            background: rgba(239, 68, 68, 0.2);
            border: 1px solid rgba(239, 68, 68, 0.4);
            border-radius: 50%;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 18px;
            color: #ef4444;
            font-weight: bold;
        }

        .orion-close-btn:hover {
            background: rgba(239, 68, 68, 0.3);
            box-shadow: 0 0 10px rgba(239, 68, 68, 0.5);
            transform: scale(1.1);
        }

        @keyframes orionListening {
            0%, 100% {
                box-shadow: 0 0 10px rgba(255, 0, 0, 0.5);
            }
            50% {
                box-shadow: 0 0 20px rgba(255, 0, 0, 0.8);
            }
        }

        .orion-command-display {
            background: rgba(0, 0, 0, 0.5);
            border: 1px solid rgba(0, 255, 255, 0.2);
            border-radius: 10px;
            padding: 15px;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .orion-waveform {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 4px;
            height: 30px;
            opacity: 0;
            transition: opacity 0.3s;
        }

        .orion-waveform.active {
            opacity: 1;
        }

        .wave-bar {
            width: 4px;
            background: #00ffff;
            border-radius: 2px;
            animation: waveAnimation 1s infinite;
            box-shadow: 0 0 5px #00ffff;
        }

        .wave-bar:nth-child(1) { animation-delay: 0s; height: 10px; }
        .wave-bar:nth-child(2) { animation-delay: 0.1s; height: 20px; }
        .wave-bar:nth-child(3) { animation-delay: 0.2s; height: 30px; }
        .wave-bar:nth-child(4) { animation-delay: 0.3s; height: 20px; }
        .wave-bar:nth-child(5) { animation-delay: 0.4s; height: 10px; }

        @keyframes waveAnimation {
            0%, 100% {
                transform: scaleY(0.3);
                opacity: 0.5;
            }
            50% {
                transform: scaleY(1);
                opacity: 1;
            }
        }

        .orion-command-text {
            color: #00ffff;
            font-size: 14px;
            text-align: center;
            min-height: 20px;
            font-weight: 500;
        }

        .orion-response {
            display: flex;
            align-items: center;
            gap: 15px;
            background: rgba(0, 255, 255, 0.05);
            border: 1px solid rgba(0, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            min-height: 60px;
        }

        .orion-avatar {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.2), rgba(0, 150, 255, 0.2));
            border: 2px solid rgba(0, 255, 255, 0.4);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
            overflow: hidden;
        }

        .orion-avatar-img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 50%;
        }

        .orion-response-text {
            flex: 1;
            color: #ffffff;
            font-size: 13px;
            line-height: 1.5;
        }

        .orion-history {
            max-height: 150px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding: 10px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 8px;
        }

        .orion-history-item {
            padding: 8px 12px;
            background: rgba(0, 255, 255, 0.05);
            border-left: 2px solid rgba(0, 255, 255, 0.3);
            border-radius: 4px;
            font-size: 12px;
            color: rgba(255, 255, 255, 0.7);
        }

        .orion-history-item.command {
            color: #00ffff;
        }

        .orion-history-item.response {
            color: #ffffff;
        }

        /* Botão Flutuante */
        .orion-float-btn {
            width: 70px;
            height: 70px;
            background: linear-gradient(135deg, rgba(0, 255, 255, 0.2), rgba(0, 150, 255, 0.2));
            border: 3px solid rgba(0, 255, 255, 0.5);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            position: relative;
            box-shadow: 0 5px 20px rgba(0, 255, 255, 0.3),
                        0 0 30px rgba(0, 255, 255, 0.2);
            transition: all 0.3s;
            font-size: 30px;
        }

        .orion-float-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 5px 30px rgba(0, 255, 255, 0.5),
                        0 0 40px rgba(0, 255, 255, 0.3);
        }

        .orion-float-pulse {
            position: absolute;
            width: 100%;
            height: 100%;
            border-radius: 50%;
            border: 2px solid rgba(0, 255, 255, 0.5);
            animation: floatPulse 2s infinite;
        }

        @keyframes floatPulse {
            0% {
                transform: scale(1);
                opacity: 1;
            }
            100% {
                transform: scale(1.5);
                opacity: 0;
            }
        }

        .orion-float-icon {
            position: relative;
            z-index: 1;
            width: 50px;
            height: 50px;
            object-fit: cover;
            border-radius: 50%;
        }

        /* Scrollbar personalizada */
        .orion-history::-webkit-scrollbar {
            width: 6px;
        }

        .orion-history::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.3);
            border-radius: 3px;
        }

        .orion-history::-webkit-scrollbar-thumb {
            background: rgba(0, 255, 255, 0.3);
            border-radius: 3px;
        }

        .orion-history::-webkit-scrollbar-thumb:hover {
            background: rgba(0, 255, 255, 0.5);
        }

        /* Responsivo */
        @media (max-width: 768px) {
            .orion-interface {
                width: calc(100vw - 40px);
                max-width: 400px;
            }
        }
    </style>

    <script>
        // ========== ASSISTENTE ORION ==========
        let orionRecognition = null;
        let orionSynthesis = null;
        let orionIsListening = false;
        let orionIsActive = false;
        let orionHistory = [];
        let orionIsStarting = false; // Flag para evitar múltiplas inicializações simultâneas
        let orionRestartTimeout = null; // Timeout para reiniciar

        // Inicializar Orion
        function initOrion() {
            // Verificar suporte a APIs de voz
            if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                orionRecognition = new SpeechRecognition();
                orionRecognition.lang = 'pt-BR';
                orionRecognition.continuous = true; // Modo contínuo - fica ouvindo continuamente
                orionRecognition.interimResults = true; // Mostrar resultados intermediários
                orionRecognition.maxAlternatives = 1;
                
                // Configurações adicionais para melhor detecção
                try {
                    // Tentar configurar gramática se disponível
                    if (orionRecognition.grammars) {
                        orionRecognition.grammars = null; // Usar gramática padrão
                    }
                } catch (e) {
                    console.log('Gramática não disponível:', e);
                }

                orionRecognition.onstart = () => {
                    console.log('✅ Reconhecimento iniciado com sucesso!');
                    orionIsListening = true;
                    orionIsStarting = false; // Resetar flag
                    updateOrionStatus('Ouvindo...', 'listening');
                    
                    const waveform = document.getElementById('orionCommandDisplay')?.querySelector('.orion-waveform');
                    if (waveform) {
                        waveform.classList.add('active');
                    }
                    
                    const commandText = document.getElementById('orionCommandText');
                    if (commandText) {
                        commandText.textContent = '🎤 Ouvindo... Fale seu comando agora!';
                        commandText.style.color = '#00ffff';
                    }
                    
                    // Não falar automaticamente para não interferir com o comando do usuário
                };

                orionRecognition.onresult = (event) => {
                    let finalTranscript = '';
                    let interimTranscript = '';
                    
                    // Processar todos os resultados
                    for (let i = event.resultIndex; i < event.results.length; i++) {
                        const transcript = event.results[i][0].transcript;
                        if (event.results[i].isFinal) {
                            finalTranscript += transcript + ' ';
                        } else {
                            interimTranscript += transcript;
                        }
                    }
                    
                    // Mostrar texto intermediário
                    if (interimTranscript) {
                        const commandText = document.getElementById('orionCommandText');
                        if (commandText) {
                            commandText.textContent = interimTranscript;
                            commandText.style.color = 'rgba(0, 255, 255, 0.7)';
                        }
                    }
                    
                    // Processar comando final
                    if (finalTranscript.trim()) {
                        console.log('✅ Comando final detectado:', finalTranscript.trim());
                        const commandText = document.getElementById('orionCommandText');
                        if (commandText) {
                            commandText.textContent = '🎯 Comando: ' + finalTranscript.trim();
                            commandText.style.color = '#00ff00';
                        }
                        
                        // Processar comando SEM parar o reconhecimento
                        // Isso permite que continue ouvindo para novos comandos
                        processOrionCommand(finalTranscript.trim());
                        
                        // Limpar o texto após processar
                        setTimeout(() => {
                            if (orionIsActive && orionIsListening) {
                                const cmdText = document.getElementById('orionCommandText');
                                if (cmdText) {
                                    cmdText.textContent = '🎤 Ouvindo... Fale seu próximo comando';
                                    cmdText.style.color = '#00ffff';
                                }
                            }
                        }, 2000);
                    }
                };

                orionRecognition.onerror = (event) => {
                    console.error('Erro no reconhecimento de voz:', event.error);
                    
                    // Marcar como não ouvindo imediatamente
                    orionIsListening = false;
                    orionIsStarting = false;
                    
                    let errorMsg = 'Desculpe, não consegui entender. Pode repetir?';
                    let shouldRestart = true;
                    
                    switch(event.error) {
                        case 'no-speech':
                            // "no-speech" não é um erro crítico, apenas significa que não detectou fala
                            console.log('ℹ️ Nenhuma fala detectada (normal) - continuando a escuta...');
                            updateOrionStatus('Ouvindo...', 'listening');
                            
                            // NÃO reiniciar - o modo contínuo deve continuar ouvindo
                            // Apenas atualizar o status visual
                            const cmdText = document.getElementById('orionCommandText');
                            if (cmdText) {
                                cmdText.textContent = '🎤 Ouvindo... Fale seu comando';
                                cmdText.style.color = '#00ffff';
                            }
                            
                            // Manter o reconhecimento ativo
                            orionIsListening = true;
                            shouldRestart = false;
                            break;
                        case 'audio-capture':
                            errorMsg = 'Não consegui acessar o microfone. Verifique as permissões.';
                            updateOrionStatus('Erro', 'error');
                            shouldRestart = false;
                            break;
                        case 'not-allowed':
                            errorMsg = 'Permissão de microfone negada. Por favor, permita o acesso ao microfone.';
                            updateOrionStatus('Erro', 'error');
                            shouldRestart = false;
                            break;
                        case 'network':
                            errorMsg = 'Erro de rede. Verifique sua conexão.';
                            updateOrionStatus('Erro', 'error');
                            break;
                        default:
                            errorMsg = `Erro: ${event.error}. Tente novamente.`;
                            updateOrionStatus('Erro', 'error');
                    }
                    
                    // Só falar se for um erro importante
                    if (event.error !== 'no-speech') {
                        orionSpeak(errorMsg);
                    }
                    
                    // Atualizar visual
                    const waveform = document.getElementById('orionCommandDisplay')?.querySelector('.orion-waveform');
                    if (waveform) {
                        waveform.classList.remove('active');
                    }
                    
                    const commandText = document.getElementById('orionCommandText');
                    if (commandText && event.error === 'no-speech') {
                        commandText.textContent = 'Clique no microfone 🎤 e fale seu comando';
                        commandText.style.color = 'rgba(0, 255, 255, 0.8)';
                    }
                    
                    // Reiniciar apenas se necessário e se ainda estiver ativo
                    if (shouldRestart && orionIsActive) {
                        setTimeout(() => {
                            if (orionIsActive && !orionIsListening && !orionIsStarting) {
                                updateOrionStatus('Pronto', 'ready');
                            }
                        }, 2000);
                    }
                };

                orionRecognition.onend = () => {
                    console.log('🎤 Reconhecimento finalizado - reiniciando automaticamente...');
                    orionIsListening = false;
                    orionIsStarting = false;
                    
                    // Só atualizar status se ainda estiver ativo
                    if (orionIsActive) {
                        // Reiniciar IMEDIATAMENTE se ainda estiver ativo
                        // Isso mantém o reconhecimento sempre ativo quando o Orion está aberto
                        setTimeout(() => {
                            if (orionIsActive && !orionIsListening && !orionIsStarting) {
                                console.log('🔄 Reiniciando reconhecimento automaticamente...');
                                try {
                                    orionRecognition.start();
                                } catch (e) {
                                    console.log('Erro ao reiniciar, tentando novamente...', e);
                                    setTimeout(() => {
                                        if (orionIsActive) {
                                            startOrionListening();
                                        }
                                    }, 500);
                                }
                            }
                        }, 100);
                    } else {
                        // Se não estiver ativo, apenas atualizar status
                        updateOrionStatus('Pronto', 'ready');
                        const waveform = document.getElementById('orionCommandDisplay')?.querySelector('.orion-waveform');
                        if (waveform) {
                            waveform.classList.remove('active');
                        }
                    }
                };
            } else {
                console.warn('Reconhecimento de voz não suportado neste navegador');
            }

            // Verificar suporte a síntese de voz
            if ('speechSynthesis' in window) {
                orionSynthesis = window.speechSynthesis;
                
                // Aguardar vozes carregarem para melhor seleção
                if (orionSynthesis.getVoices().length === 0) {
                    orionSynthesis.onvoiceschanged = () => {
                        console.log('✅ Vozes carregadas:', orionSynthesis.getVoices().length);
                        orionSynthesis.onvoiceschanged = null;
                    };
                }
            }

            // Adicionar histórico inicial
            addOrionHistory('response', 'Olá! Sou o Orion, seu assistente virtual. Clique no microfone para começar!');
            
            // Verificar se há suporte
            if (!orionRecognition) {
                console.warn('⚠️ Reconhecimento de voz não suportado. Use Chrome ou Edge.');
                showOrionResponse('Reconhecimento de voz não suportado. Use Chrome ou Edge para melhor experiência.');
            } else {
                console.log('✅ Orion inicializado com sucesso!');
            }
        }

        // Ativar/Desativar Orion
        function toggleOrion() {
            const interface = document.getElementById('orionInterface');
            const floatBtn = document.getElementById('orionFloatBtn');
            
            // Se estiver ativo, desativar
            if (orionIsActive) {
                // Parar reconhecimento de voz
                if (orionIsListening && orionRecognition) {
                    try {
                        orionRecognition.stop();
                        orionIsListening = false;
                        orionIsStarting = false;
                        console.log('🛑 Reconhecimento parado');
                    } catch (e) {
                        console.log('Erro ao parar reconhecimento:', e);
                        orionIsListening = false;
                        orionIsStarting = false;
                    }
                }
                
                // Parar síntese de voz se estiver falando
                if (orionSynthesis) {
                    try {
                        orionSynthesis.cancel();
                    } catch (e) {
                        console.log('Erro ao cancelar fala:', e);
                    }
                }
                
                // Fechar interface
                interface.classList.remove('active');
                floatBtn.style.display = 'flex';
                orionIsActive = false;
                
                console.log('✅ Orion desativado');
            } else {
                // Se estiver inativo, ativar
                interface.classList.add('active');
                floatBtn.style.display = 'none';
                orionIsActive = true;
                orionSpeak('Orion ativado. Como posso ajudar?');
            }
        }

        // Verificar permissões do microfone - sempre permitir
        async function verificarPermissaoMicrofone() {
            try {
                // Tentar obter permissão, mas não bloquear se falhar
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                stream.getTracks().forEach(track => track.stop()); // Parar o stream imediatamente
                console.log('✅ Permissão de microfone concedida');
                return true;
            } catch (error) {
                console.warn('⚠️ Aviso ao acessar microfone:', error);
                // Não bloquear - sempre permitir tentar
                // Apenas logar o erro, mas continuar
                if (error.name === 'NotAllowedError' || error.name === 'PermissionDeniedError') {
                    console.warn('Permissão negada, mas continuando...');
                    // Não falar para não interromper - apenas continuar
                } else if (error.name === 'NotFoundError' || error.name === 'DevicesNotFoundError') {
                    console.warn('Microfone não encontrado, mas continuando...');
                }
                // Sempre retornar true para não bloquear
                return true;
            }
        }

        // Iniciar escuta
        async function startOrionListening() {
            if (!orionRecognition) {
                console.error('Reconhecimento de voz não disponível');
                orionSpeak('Reconhecimento de voz não está disponível. Por favor, use um navegador compatível como Chrome ou Edge.');
                return;
            }

            // Verificar permissões antes de iniciar
            const temPermissao = await verificarPermissaoMicrofone();
            if (!temPermissao) {
                return;
            }

            // Verificar se já está ouvindo ou iniciando
            if (orionIsListening || orionIsStarting) {
                console.log('✅ Já está ouvindo ou iniciando...');
                if (orionIsListening) {
                    updateOrionStatus('Ouvindo...', 'listening');
                    const commandText = document.getElementById('orionCommandText');
                    if (commandText) {
                        commandText.textContent = '🎤 Ouvindo... Fale agora!';
                        commandText.style.color = '#00ffff';
                    }
                }
                return;
            }

            // Ativar interface se não estiver ativa
            if (!orionIsActive) {
                toggleOrion();
            }

            // Marcar como iniciando para evitar múltiplas tentativas
            orionIsStarting = true;

            // Função para iniciar reconhecimento de forma segura
            const iniciarReconhecimento = () => {
                try {
                    // Verificar novamente antes de iniciar (dupla verificação)
                    if (orionIsListening) {
                        console.log('⚠️ Reconhecimento já está ouvindo, ignorando...');
                        orionIsStarting = false;
                        return;
                    }

                    console.log('🎤 Iniciando reconhecimento de voz...');
                    orionRecognition.start();
                    // orionIsStarting será resetado no evento onstart ou onerror
                    
                    // O estado será atualizado no evento onstart
                    // orionIsStarting será resetado no onstart ou onerror
                    
                } catch (error) {
                    console.error('Erro ao iniciar reconhecimento:', error);
                    orionIsStarting = false;
                    
                    if (error.name === 'InvalidStateError' || 
                        (error.message && error.message.includes('already started'))) {
                        console.log('✅ Reconhecimento já estava ativo');
                        orionIsListening = true;
                        orionIsStarting = false;
                        updateOrionStatus('Ouvindo...', 'listening');
                        
                        const waveform = document.getElementById('orionCommandDisplay')?.querySelector('.orion-waveform');
                        if (waveform) {
                            waveform.classList.add('active');
                        }
                        
                        const commandText = document.getElementById('orionCommandText');
                        if (commandText) {
                            commandText.textContent = '🎤 Ouvindo... Fale agora!';
                            commandText.style.color = '#00ffff';
                        }
                    } else {
                        orionSpeak('Erro ao iniciar o reconhecimento de voz. Verifique as permissões do microfone.');
                        updateOrionStatus('Erro', 'error');
                    }
                }
            };

            // Aguardar um pouco antes de iniciar (dar tempo para estados se atualizarem)
            // Reduzir delay para iniciar mais rápido
            setTimeout(iniciarReconhecimento, 200);
        }

        // Função auxiliar para reiniciar reconhecimento de forma segura (não usada mais - controle manual)
        function reiniciarReconhecimentoSeguro() {
            // Cancelar timeout anterior se existir
            if (orionRestartTimeout) {
                clearTimeout(orionRestartTimeout);
                orionRestartTimeout = null;
            }

            if (!orionIsActive || !orionRecognition || orionIsListening || orionIsStarting) {
                return;
            }

            // Aguardar um pouco para garantir que o estado foi atualizado
            orionRestartTimeout = setTimeout(() => {
                if (orionIsActive && !orionIsListening && !orionIsStarting) {
                    try {
                        console.log('🔄 Reiniciando reconhecimento...');
                        orionIsStarting = true;
                        orionRecognition.start();
                    } catch (error) {
                        orionIsStarting = false;
                        if (error.name === 'InvalidStateError' || 
                            (error.message && error.message.includes('already started'))) {
                            console.log('✅ Reconhecimento já estava ativo');
                            orionIsListening = true;
                            updateOrionStatus('Ouvindo...', 'listening');
                            
                            const waveform = document.getElementById('orionCommandDisplay')?.querySelector('.orion-waveform');
                            if (waveform) {
                                waveform.classList.add('active');
                            }
                        } else {
                            console.error('Erro ao reiniciar:', error);
                        }
                    }
                }
                orionRestartTimeout = null;
            }, 2000);
        }

        // Atualizar status do Orion
        function updateOrionStatus(text, type = 'ready') {
            const statusText = document.getElementById('orionStatusText');
            const toggleBtn = document.getElementById('orionToggleBtn');
            
            statusText.textContent = text;
            toggleBtn.className = 'orion-toggle-btn';
            
            if (type === 'listening') {
                toggleBtn.classList.add('listening');
                toggleBtn.innerHTML = '<span>🔴</span>';
            } else {
                toggleBtn.innerHTML = '<span>🎤</span>';
            }
        }

        // Processar comando de voz
        async function processOrionCommand(command) {
            console.log('🎤 Comando recebido:', command);
            
            const commandText = document.getElementById('orionCommandText');
            commandText.textContent = command;
            addOrionHistory('command', command);

            // Normalizar comando - remover pontuação e normalizar
            let normalizedCommand = command.toLowerCase()
                .replace(/[.,!?;:]/g, '')
                .replace(/\s+/g, ' ')
                .trim();

            console.log('🔍 Comando normalizado:', normalizedCommand);

            // Função auxiliar para verificar múltiplas palavras-chave
            function hasAnyKeywords(text, keywords) {
                return keywords.some(keyword => text.includes(keyword));
            }

            // ========== COMANDO DE ATIVAÇÃO ==========
            if (hasAnyKeywords(normalizedCommand, ['orion ativar', 'orion ativa', 'ativar orion', 'ativa orion', 'abrir orion', 'iniciar orion', 'começar orion'])) {
                if (!orionIsActive) {
                    toggleOrion();
                    orionSpeak('Orion ativado. Como posso ajudar?');
                } else {
                    orionSpeak('Orion já está ativo. Como posso ajudar?');
                }
                return;
            }

            // ========== COMANDO DE DESATIVAÇÃO ==========
            if (hasAnyKeywords(normalizedCommand, ['orion desativar', 'orion desativa', 'desativar orion', 'desativa orion', 'fechar orion', 'sair orion', 'parar orion', 'desligar orion', 'desliga orion'])) {
                // Parar reconhecimento primeiro
                if (orionIsListening && orionRecognition) {
                    try {
                        orionRecognition.stop();
                        orionIsListening = false;
                        orionIsStarting = false;
                    } catch (e) {
                        console.log('Erro ao parar reconhecimento:', e);
                    }
                }
                
                // Parar síntese de voz
                if (orionSynthesis) {
                    try {
                        orionSynthesis.cancel();
                    } catch (e) {
                        console.log('Erro ao cancelar fala:', e);
                    }
                }
                
                // Desativar interface
                const interface = document.getElementById('orionInterface');
                const floatBtn = document.getElementById('orionFloatBtn');
                
                if (interface) {
                    interface.classList.remove('active');
                }
                if (floatBtn) {
                    floatBtn.style.display = 'flex';
                }
                
                orionIsActive = false;
                
                // Falar confirmação antes de desativar completamente
                setTimeout(() => {
                    if (orionSynthesis) {
                        const utterance = new SpeechSynthesisUtterance('Orion desativado. Até logo!');
                        utterance.lang = 'pt-BR';
                        utterance.rate = 0.95;
                        utterance.pitch = 1.1;
                        utterance.volume = 0.9;
                        orionSynthesis.speak(utterance);
                        
                        utterance.onend = () => {
                            console.log('✅ Orion desativado com sucesso');
                        };
                    }
                }, 100);
                
                return;
            }

            // ========== COMANDOS DE NAVEGAÇÃO ==========
            const navKeywords = ['ir para', 'abrir', 'mostrar', 'vai para', 'vou para', 'mostra', 'abre', 'acessar', 'acessa'];
            if (hasAnyKeywords(normalizedCommand, navKeywords)) {
                if (hasAnyKeywords(normalizedCommand, ['dashboard', 'painel', 'início', 'inicio', 'home'])) {
                    navigateToPage('dashboard');
                    orionSpeak('Abrindo dashboard');
                    return;
                } else if (hasAnyKeywords(normalizedCommand, ['cliente', 'clientes'])) {
                    navigateToPage('clientes');
                    orionSpeak('Abrindo página de clientes');
                    return;
                } else if (hasAnyKeywords(normalizedCommand, ['projeto', 'projetos'])) {
                    navigateToPage('projetos');
                    orionSpeak('Abrindo página de projetos');
                    return;
                } else if (hasAnyKeywords(normalizedCommand, ['orçamento', 'orcamento', 'orçamentos', 'orcamentos', 'proposta', 'propostas'])) {
                    navigateToPage('orcamentos');
                    orionSpeak('Abrindo página de orçamentos');
                    return;
                } else if (hasAnyKeywords(normalizedCommand, ['financeiro', 'financeira', 'finanças', 'financas'])) {
                    navigateToPage('financeiro');
                    orionSpeak('Abrindo página financeira');
                    return;
                } else if (hasAnyKeywords(normalizedCommand, ['contrato', 'contratos'])) {
                    navigateToPage('contratos');
                    orionSpeak('Abrindo página de contratos');
                    return;
                } else if (hasAnyKeywords(normalizedCommand, ['ideia', 'ideias', 'análise', 'analise'])) {
                    navigateToPage('ideias');
                    orionSpeak('Abrindo página de ideias');
                    return;
                } else if (hasAnyKeywords(normalizedCommand, ['tarefa', 'tarefas', 'tarefa e hábito', 'tarefas e habitos'])) {
                    navigateToPage('tarefas');
                    orionSpeak('Abrindo página de tarefas e hábitos');
                    return;
                } else if (hasAnyKeywords(normalizedCommand, ['análise', 'analise', 'análises', 'analises', 'insight', 'insights'])) {
                    navigateToPage('analises');
                    orionSpeak('Abrindo análises avançadas');
                    return;
                } else if (hasAnyKeywords(normalizedCommand, ['precificação', 'precificacao', 'preço', 'preco'])) {
                    navigateToPage('precificacao');
                    orionSpeak('Abrindo página de precificação');
                    return;
                }
            }

            // ========== COMANDOS DE CRIAÇÃO ==========
            const createKeywords = ['criar', 'novo', 'adicionar', 'adiciona', 'cria', 'cadastrar', 'cadastra', 'inserir', 'insere'];
            if (hasAnyKeywords(normalizedCommand, createKeywords)) {
                if (hasAnyKeywords(normalizedCommand, ['cliente', 'clientes'])) {
                    if (typeof openClienteModal === 'function') {
                        openClienteModal();
                        orionSpeak('Abrindo formulário para criar novo cliente');
                    } else {
                        orionSpeak('Função não disponível no momento');
                    }
                    return;
                } else if (hasAnyKeywords(normalizedCommand, ['projeto', 'projetos'])) {
                    if (typeof openProjetoModal === 'function') {
                        openProjetoModal();
                        orionSpeak('Abrindo formulário para criar novo projeto');
                    } else {
                        orionSpeak('Função não disponível no momento');
                    }
                    return;
                } else if (hasAnyKeywords(normalizedCommand, ['orçamento', 'orcamento', 'orçamentos', 'orcamentos', 'proposta'])) {
                    if (typeof openOrcamentoModal === 'function') {
                        openOrcamentoModal();
                        orionSpeak('Abrindo formulário para criar novo orçamento');
                    } else {
                        orionSpeak('Função não disponível no momento');
                    }
                    return;
                } else if (hasAnyKeywords(normalizedCommand, ['receita', 'receitas'])) {
                    if (typeof openReceitaModal === 'function') {
                        openReceitaModal();
                        orionSpeak('Abrindo formulário para criar nova receita');
                    } else {
                        orionSpeak('Função não disponível no momento');
                    }
                    return;
                } else if (hasAnyKeywords(normalizedCommand, ['despesa', 'despesas', 'gasto', 'gastos'])) {
                    if (typeof openDespesaModal === 'function') {
                        openDespesaModal();
                        orionSpeak('Abrindo formulário para criar nova despesa');
                    } else {
                        orionSpeak('Função não disponível no momento');
                    }
                    return;
                } else if (hasAnyKeywords(normalizedCommand, ['ideia', 'ideias'])) {
                    if (typeof openIdeiaModal === 'function') {
                        openIdeiaModal();
                        orionSpeak('Abrindo formulário para criar nova ideia');
                    } else {
                        orionSpeak('Função não disponível no momento');
                    }
                    return;
                } else if (hasAnyKeywords(normalizedCommand, ['tarefa', 'tarefas'])) {
                    if (typeof openTarefaModal === 'function') {
                        openTarefaModal();
                        orionSpeak('Abrindo formulário para criar nova tarefa');
                    } else {
                        orionSpeak('Função não disponível no momento');
                    }
                    return;
                } else if (hasAnyKeywords(normalizedCommand, ['habito', 'hábito', 'habitos', 'hábitos'])) {
                    if (typeof openHabitoModal === 'function') {
                        openHabitoModal();
                        orionSpeak('Abrindo formulário para criar novo hábito');
                    } else {
                        orionSpeak('Função não disponível no momento');
                    }
                    return;
                }
            }

            // ========== COMANDOS DE CONSULTA ==========
            const queryKeywords = ['quantos', 'quantas', 'mostrar', 'mostra', 'listar', 'lista', 'ver', 'veja', 'exibir', 'exibe'];
            if (hasAnyKeywords(normalizedCommand, queryKeywords)) {
                if (hasAnyKeywords(normalizedCommand, ['cliente', 'clientes'])) {
                    const count = (typeof allClientes !== 'undefined' && allClientes) ? allClientes.length : 0;
                    const response = `Você tem ${count} ${count === 1 ? 'cliente' : 'clientes'} cadastrado${count === 1 ? '' : 's'}`;
                    orionSpeak(response);
                    showOrionResponse(response);
                    return;
                } else if (hasAnyKeywords(normalizedCommand, ['projeto', 'projetos'])) {
                    const count = (typeof allProjetos !== 'undefined' && allProjetos) ? allProjetos.length : 0;
                    const response = `Você tem ${count} ${count === 1 ? 'projeto' : 'projetos'} cadastrado${count === 1 ? '' : 's'}`;
                    orionSpeak(response);
                    showOrionResponse(response);
                    return;
                } else if (hasAnyKeywords(normalizedCommand, ['orçamento', 'orcamento', 'orçamentos', 'orcamentos'])) {
                    const count = (typeof allOrcamentos !== 'undefined' && allOrcamentos) ? allOrcamentos.length : 0;
                    const response = `Você tem ${count} ${count === 1 ? 'orçamento' : 'orçamentos'} cadastrado${count === 1 ? '' : 's'}`;
                    orionSpeak(response);
                    showOrionResponse(response);
                    return;
                }
            }

            // ========== COMANDOS DE STATUS FINANCEIRO ==========
            const financeKeywords = ['faturamento', 'receita', 'ganho', 'ganhos', 'fatura', 'faturou', 'recebeu'];
            if (hasAnyKeywords(normalizedCommand, financeKeywords)) {
                try {
                    const hoje = new Date();
                    const mesAtual = hoje.getMonth();
                    const anoAtual = hoje.getFullYear();
                    
                    const { data: receitas } = await supabase
                        .from('receitas')
                        .select('valor, data_vencimento, status')
                        .eq('status', 'recebido');
                    
                    if (receitas) {
                        const dataInicio = new Date(anoAtual, mesAtual, 1);
                        const dataFim = new Date(anoAtual, mesAtual + 1, 0);
                        const receitasMes = receitas.filter(r => {
                            if (!r.data_vencimento) return false;
                            const dataVenc = new Date(r.data_vencimento);
                            return dataVenc >= dataInicio && dataVenc <= dataFim;
                        });
                        
                        const total = receitasMes.reduce((sum, r) => sum + (r.valor || 0), 0);
                        const formatted = formatCurrency(total);
                        orionSpeak(`O faturamento deste mês é de ${formatted}`);
                        showOrionResponse(`Faturamento do mês: ${formatted}`);
                    } else {
                        orionSpeak('Não encontrei receitas para este mês');
                    }
                } catch (e) {
                    console.error('Erro ao buscar faturamento:', e);
                    orionSpeak('Não consegui buscar o faturamento no momento');
                }
                return;
            }

            // ========== COMANDOS DE TAREFAS ==========
            if (hasAnyKeywords(normalizedCommand, ['quantas tarefas', 'quantas tarefa', 'listar tarefas', 'mostrar tarefas'])) {
                const count = (typeof allTarefas !== 'undefined' && allTarefas) ? allTarefas.length : 0;
                const pendentes = allTarefas ? allTarefas.filter(t => t.status === 'pendente').length : 0;
                const response = `Você tem ${count} tarefa${count === 1 ? '' : 's'}, sendo ${pendentes} pendente${pendentes === 1 ? '' : 's'}`;
                orionSpeak(response);
                showOrionResponse(response);
                return;
            }

            // ========== COMANDOS DE HÁBITOS ==========
            if (hasAnyKeywords(normalizedCommand, ['quantos habitos', 'quantos hábitos', 'listar habitos', 'mostrar habitos'])) {
                const count = (typeof allHabitos !== 'undefined' && allHabitos) ? allHabitos.length : 0;
                const response = `Você tem ${count} hábito${count === 1 ? '' : 's'} cadastrado${count === 1 ? '' : 's'}`;
                orionSpeak(response);
                showOrionResponse(response);
                return;
            }

            // ========== COMANDOS DE PRECIFICAÇÃO ==========
            if (hasAnyKeywords(normalizedCommand, ['precificação', 'precificacao', 'preço', 'preco', 'preços', 'precos', 'tabela de preços'])) {
                navigateToPage('precificacao');
                orionSpeak('Abrindo página de precificação');
                return;
            }
            
            if (hasAnyKeywords(normalizedCommand, ['criar serviço', 'novo serviço', 'adicionar serviço', 'cadastrar serviço'])) {
                if (typeof openPrecificacaoModal === 'function') {
                    openPrecificacaoModal();
                    orionSpeak('Abrindo formulário para criar novo serviço');
                } else {
                    orionSpeak('Função não disponível no momento');
                }
                return;
            }

            // ========== COMANDOS DE TEMPO E DATA ==========
            if (hasAnyKeywords(normalizedCommand, ['que horas são', 'que horas sao', 'horas', 'hora', 'que dia é hoje', 'que dia e hoje', 'data de hoje'])) {
                const now = new Date();
                const horas = now.getHours().toString().padStart(2, '0');
                const minutos = now.getMinutes().toString().padStart(2, '0');
                const dia = now.getDate();
                const mes = now.toLocaleDateString('pt-BR', { month: 'long' });
                const ano = now.getFullYear();
                
                if (normalizedCommand.includes('hora')) {
                    const response = `São ${horas} horas e ${minutos} minutos`;
                    orionSpeak(response);
                    showOrionResponse(response);
                } else {
                    const response = `Hoje é dia ${dia} de ${mes} de ${ano}`;
                    orionSpeak(response);
                    showOrionResponse(response);
                }
                return;
            }

            // ========== COMANDOS DE BUSCA ==========
            if (hasAnyKeywords(normalizedCommand, ['buscar', 'busca', 'procurar', 'procura', 'pesquisar', 'pesquisa'])) {
                if (hasAnyKeywords(normalizedCommand, ['cliente', 'clientes'])) {
                    navigateToPage('clientes');
                    orionSpeak('Abri a página de clientes. Use a barra de busca para encontrar o cliente');
                    return;
                } else if (hasAnyKeywords(normalizedCommand, ['projeto', 'projetos'])) {
                    navigateToPage('projetos');
                    orionSpeak('Abri a página de projetos. Use a barra de busca para encontrar o projeto');
                    return;
                }
            }

            // ========== COMANDOS DE RELATÓRIO ==========
            if (hasAnyKeywords(normalizedCommand, ['relatório', 'relatorio', 'relatórios', 'relatorios', 'resumo', 'estatísticas', 'estatisticas'])) {
                navigateToPage('analises');
                orionSpeak('Abrindo análises avançadas com relatórios e estatísticas');
                return;
            }

            // ========== COMANDOS DE FINANCEIRO ==========
            if (hasAnyKeywords(normalizedCommand, ['saldo', 'faturamento', 'receitas', 'despesas', 'lucro', 'prejuízo', 'prejuizo'])) {
                navigateToPage('financeiro');
                orionSpeak('Abrindo página financeira');
                return;
            }

            // ========== COMANDOS DE CONTRATOS ==========
            if (hasAnyKeywords(normalizedCommand, ['contrato', 'contratos', 'novo contrato', 'criar contrato'])) {
                if (normalizedCommand.includes('criar') || normalizedCommand.includes('novo')) {
                    if (typeof openContratoModal === 'function') {
                        openContratoModal();
                        orionSpeak('Abrindo formulário para criar novo contrato');
                    } else {
                        orionSpeak('Função não disponível no momento');
                    }
                } else {
                    navigateToPage('contratos');
                    orionSpeak('Abrindo página de contratos');
                }
                return;
            }

            // ========== COMANDOS DE PLATAFORMAS ==========
            if (hasAnyKeywords(normalizedCommand, ['plataforma', 'plataformas', 'assinatura', 'assinaturas'])) {
                navigateToPage('plataformas');
                orionSpeak('Abrindo página de plataformas');
                return;
            }

            // ========== COMANDOS DE TEMPLATES ==========
            if (hasAnyKeywords(normalizedCommand, ['template', 'templates', 'mensagem', 'mensagens'])) {
                navigateToPage('templates');
                orionSpeak('Abrindo página de templates de mensagens');
                return;
            }

            // ========== COMANDOS DE STATUS ==========
            if (hasAnyKeywords(normalizedCommand, ['status', 'situação', 'situacao', 'como está', 'como esta'])) {
                let statusInfo = [];
                
                if (typeof allClientes !== 'undefined' && allClientes) {
                    statusInfo.push(`${allClientes.length} cliente${allClientes.length !== 1 ? 's' : ''}`);
                }
                if (typeof allProjetos !== 'undefined' && allProjetos) {
                    const ativos = allProjetos.filter(p => p.status === 'em_andamento').length;
                    statusInfo.push(`${ativos} projeto${ativos !== 1 ? 's' : ''} ativo${ativos !== 1 ? 's' : ''}`);
                }
                if (typeof allTarefas !== 'undefined' && allTarefas) {
                    const pendentes = allTarefas.filter(t => t.status === 'pendente').length;
                    statusInfo.push(`${pendentes} tarefa${pendentes !== 1 ? 's' : ''} pendente${pendentes !== 1 ? 's' : ''}`);
                }
                
                const response = statusInfo.length > 0 
                    ? `Status atual: ${statusInfo.join(', ')}`
                    : 'Não há informações disponíveis no momento';
                
                orionSpeak(response);
                showOrionResponse(response);
                return;
            }

            // ========== COMANDOS DE AJUDA ==========
            const helpKeywords = ['ajuda', 'comandos', 'o que você pode fazer', 'o que voce pode fazer', 'help', 'ajudar', 'instruções', 'instrucoes', 'o que posso fazer', 'quais comandos'];
            if (hasAnyKeywords(normalizedCommand, helpKeywords)) {
                const helpText = `Posso ajudar você com várias tarefas: navegar pelas páginas dizendo "ir para dashboard" ou "abrir clientes", criar registros como "criar novo cliente" ou "criar nova tarefa", consultar informações como "quantos projetos eu tenho" ou "que horas são", gerenciar tarefas e hábitos, ver relatórios e muito mais. Tente dizer qualquer comando naturalmente!`;
                orionSpeak(helpText);
                showOrionResponse(helpText);
                return;
            }

            // ========== COMANDO NÃO RECONHECIDO ==========
            console.log('❌ Comando não reconhecido:', normalizedCommand);
            const errorMsg = 'Desculpe, não entendi esse comando. Tente dizer "ajuda" para ver os comandos disponíveis';
            orionSpeak(errorMsg);
            showOrionResponse('Comando não reconhecido. Diga "ajuda" para ver os comandos disponíveis.');
        }

        // Falar texto com voz masculina melhorada e sem travadas
        function orionSpeak(text) {
            if (orionSynthesis) {
                // Parar qualquer fala anterior completamente
                orionSynthesis.cancel();
                
                // Aguardar um pouco para garantir que a fala anterior foi cancelada
                setTimeout(() => {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = 'pt-BR';
                    
                    // Configurações otimizadas para voz masculina natural e fluida
                    utterance.rate = 0.92; // Velocidade confortável para evitar travadas
                    utterance.pitch = 0.95; // Tom mais grave (masculino)
                    utterance.volume = 0.95; // Volume alto mas confortável
                    
                    // Buscar a melhor voz masculina disponível
                    const voices = orionSynthesis.getVoices();
                    
                    if (voices.length === 0) {
                        console.warn('⚠️ Nenhuma voz disponível ainda, tentando novamente...');
                        // Tentar novamente após um pequeno delay
                        setTimeout(() => {
                            const retryVoices = orionSynthesis.getVoices();
                            if (retryVoices.length > 0) {
                                selectAndSpeak(utterance, retryVoices, text);
                            } else {
                                // Fallback: falar sem voz específica
                                orionSynthesis.speak(utterance);
                                showOrionResponse(text);
                            }
                        }, 200);
                        return;
                    }
                    
                    selectAndSpeak(utterance, voices, text);
                }, 50); // Pequeno delay para evitar travadas
            }
        }

        // Função auxiliar para selecionar voz masculina e falar
        function selectAndSpeak(utterance, voices, text) {
            let selectedVoice = null;
            
            // 1. Prioridade máxima: Vozes Masculinas Neural/Premium/Natural
            selectedVoice = voices.find(v => 
                v.lang.includes('pt-BR') && 
                (v.name.toLowerCase().includes('neural') || 
                 v.name.toLowerCase().includes('premium') || 
                 v.name.toLowerCase().includes('natural') ||
                 v.name.toLowerCase().includes('enhanced')) &&
                (v.name.toLowerCase().includes('male') || 
                 v.name.toLowerCase().includes('masculina') ||
                 v.name.toLowerCase().includes('daniel') ||
                 v.name.toLowerCase().includes('felipe') ||
                 !v.name.toLowerCase().includes('female') &&
                 !v.name.toLowerCase().includes('feminina') &&
                 !v.name.toLowerCase().includes('maria') &&
                 !v.name.toLowerCase().includes('gabriela'))
            );
            
            // 2. Vozes masculinas brasileiras explícitas
            if (!selectedVoice) {
                selectedVoice = voices.find(v => 
                    v.lang.includes('pt-BR') && 
                    (v.name.toLowerCase().includes('male') || 
                     v.name.toLowerCase().includes('masculina') ||
                     v.name.toLowerCase().includes('daniel') ||
                     v.name.toLowerCase().includes('felipe') ||
                     v.name.toLowerCase().includes('thomas'))
                );
            }
            
            // 3. Vozes brasileiras que não são femininas (assumir masculinas)
            if (!selectedVoice) {
                selectedVoice = voices.find(v => 
                    v.lang.includes('pt-BR') && 
                    !v.name.toLowerCase().includes('female') && 
                    !v.name.toLowerCase().includes('feminina') && 
                    !v.name.toLowerCase().includes('maria') && 
                    !v.name.toLowerCase().includes('gabriela') &&
                    !v.name.toLowerCase().includes('francisca') &&
                    !v.name.toLowerCase().includes('lucia') &&
                    !v.name.toLowerCase().includes('heloisa') &&
                    !v.name.toLowerCase().includes('zira')
                );
            }
            
            // 4. Qualquer voz brasileira (exceto as mais antigas/robóticas)
            if (!selectedVoice) {
                selectedVoice = voices.find(v => 
                    v.lang.includes('pt-BR') && 
                    !v.name.toLowerCase().includes('zira') &&
                    !v.name.toLowerCase().includes('heloisa')
                );
            }
            
            // 5. Qualquer voz brasileira
            if (!selectedVoice) {
                selectedVoice = voices.find(v => v.lang.includes('pt-BR'));
            }
            
            // 6. Voz portuguesa como fallback
            if (!selectedVoice) {
                selectedVoice = voices.find(v => 
                    v.lang.includes('pt') && 
                    !v.name.toLowerCase().includes('female') &&
                    !v.name.toLowerCase().includes('feminina')
                );
            }
            
            // 7. Qualquer voz disponível
            if (!selectedVoice && voices.length > 0) {
                selectedVoice = voices[0];
            }
            
            if (selectedVoice) {
                utterance.voice = selectedVoice;
                console.log('🎤 Usando voz masculina:', selectedVoice.name, selectedVoice.lang);
            } else {
                console.warn('⚠️ Nenhuma voz masculina adequada encontrada');
            }
            
            // Eventos para melhor controle e evitar travadas
            utterance.onstart = () => {
                console.log('🔊 Iniciando fala...');
            };
            
            utterance.onend = () => {
                console.log('✅ Fala concluída');
            };
            
            utterance.onerror = (event) => {
                console.error('❌ Erro na fala:', event.error);
            };
            
            // Falar com pequeno delay para garantir fluidez e evitar travadas
            setTimeout(() => {
                try {
                    orionSynthesis.speak(utterance);
                    showOrionResponse(text);
                } catch (error) {
                    console.error('Erro ao falar:', error);
                    showOrionResponse(text);
                }
            }, 20);
        }

        // Mostrar resposta visual
        function showOrionResponse(text) {
            const responseText = document.getElementById('orionResponseText');
            responseText.textContent = text;
            addOrionHistory('response', text);
        }

        // Adicionar ao histórico
        function addOrionHistory(type, text) {
            const history = document.getElementById('orionHistory');
            const item = document.createElement('div');
            item.className = `orion-history-item ${type}`;
            item.textContent = text;
            history.insertBefore(item, history.firstChild);
            
            // Limitar histórico a 10 itens
            while (history.children.length > 10) {
                history.removeChild(history.lastChild);
            }
        }

        // Navegar para página
        function navigateToPage(page) {
            const menuItem = document.querySelector(`[data-page="${page}"]`);
            if (menuItem) {
                menuItem.click();
            }
        }

        // Inicializar quando a página carregar
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initOrion);
        } else {
            initOrion();
        }

        // Carregar vozes quando disponíveis
        if ('speechSynthesis' in window) {
            speechSynthesis.onvoiceschanged = () => {
                // Vozes carregadas
            };
        }

        // Atalho de teclado: Ctrl + O para ativar Orion
        document.addEventListener('keydown', (e) => {
            if (e.ctrlKey && e.key === 'o') {
                e.preventDefault();
                if (!orionIsActive) {
                    toggleOrion();
                    setTimeout(() => startOrionListening(), 500);
                } else {
                    startOrionListening();
                }
            }
        });

        // Expor função globalmente
        window.startOrionListening = startOrionListening;
        window.toggleOrion = toggleOrion;
        window.reiniciarReconhecimentoSeguro = reiniciarReconhecimentoSeguro;
    </script>

    <!-- ========== PÁGINAS: TAREFAS & HÁBITOS E ANÁLISES ========== -->
    
    <!-- Página Tarefas & Hábitos -->
    <div id="tarefasContent" class="page-content" style="display: none;">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 24px;">
            <div>
                <h1 class="page-title">✅ Tarefas & Hábitos</h1>
                <p class="page-subtitle">Gerencie suas tarefas e desenvolva hábitos produtivos</p>
            </div>
            <div style="display: flex; gap: 8px;">
                <button class="btn btn-primary" onclick="openTarefaModal()">+ Nova Tarefa</button>
                <button class="btn btn-secondary" onclick="openHabitoModal()">+ Novo Hábito</button>
            </div>
        </div>

        <!-- Tabs -->
        <div class="section-card">
            <div style="display: flex; gap: 8px; margin-bottom: 24px; border-bottom: 1px solid rgba(255, 255, 255, 0.1);">
                <button class="btn btn-secondary" id="tabTarefas" onclick="switchTarefasTab('tarefas')" style="border-radius: 8px 8px 0 0; margin-bottom: -1px; border-bottom: 2px solid var(--primary);">
                    ✅ Tarefas
                </button>
                <button class="btn btn-secondary" id="tabHabitos" onclick="switchTarefasTab('habitos')" style="border-radius: 8px 8px 0 0; margin-bottom: -1px;">
                    🔄 Hábitos
                </button>
            </div>

            <!-- Aba Tarefas -->
            <div id="tarefasTab" class="tarefas-tab">
                <div class="search-bar">
                    <input type="text" id="tarefaSearch" class="search-input" placeholder="Buscar tarefas..." onkeyup="filterTarefas()">
                    <select id="tarefaStatusFilter" class="form-input" style="width: 200px;" onchange="filterTarefas()">
                        <option value="">Todas</option>
                        <option value="pendente">Pendente</option>
                        <option value="em_andamento">Em Andamento</option>
                        <option value="concluida">Concluída</option>
                        <option value="cancelada">Cancelada</option>
                    </select>
                    <select id="tarefaPrioridadeFilter" class="form-input" style="width: 200px;" onchange="filterTarefas()">
                        <option value="">Todas as prioridades</option>
                        <option value="baixa">Baixa</option>
                        <option value="media">Média</option>
                        <option value="alta">Alta</option>
                        <option value="urgente">Urgente</option>
                    </select>
                </div>

                <div class="table-container">
                    <div id="tarefasLoading" class="loading active">
                        <div class="spinner"></div>
                        <p>Carregando tarefas...</p>
                    </div>
                    <div id="tarefasList" style="display: none;">
                        <!-- Tarefas serão inseridas aqui -->
                    </div>
                    <div id="tarefasEmpty" class="empty-state" style="display: none;">
                        Nenhuma tarefa encontrada. Crie sua primeira tarefa!
                    </div>
                </div>
            </div>

            <!-- Aba Hábitos -->
            <div id="habitosTab" class="tarefas-tab" style="display: none;">
                <div class="search-bar">
                    <input type="text" id="habitoSearch" class="search-input" placeholder="Buscar hábitos..." onkeyup="filterHabitos()">
                    <select id="habitoStatusFilter" class="form-input" style="width: 200px;" onchange="filterHabitos()">
                        <option value="">Todos</option>
                        <option value="ativo">Ativo</option>
                        <option value="pausado">Pausado</option>
                        <option value="concluido">Concluído</option>
                    </select>
                </div>

                <div id="habitosGrid" class="habitos-grid" style="display: none;">
                    <!-- Hábitos serão inseridos aqui -->
                </div>
                <div id="habitosEmpty" class="empty-state" style="display: none;">
                    Nenhum hábito encontrado. Crie seu primeiro hábito!
                </div>
            </div>
        </div>
    </div>

    <!-- Página Análises Avançadas -->
    <div id="analisesContent" class="page-content" style="display: none;">
        <div style="margin-bottom: 24px;">
            <h1 class="page-title">📊 Análises Avançadas & Insights</h1>
            <p class="page-subtitle">Insights inteligentes sobre seu negócio</p>
        </div>

        <!-- Cards de Insights -->
        <div class="cards-grid" style="margin-bottom: 24px;">
            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Taxa de Conversão</div>
                        <div class="card-value" id="taxaConversao">0%</div>
                    </div>
                    <div class="card-icon">🎯</div>
                </div>
                <div class="card-footer" id="insightConversao">Calculando...</div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Ticket Médio</div>
                        <div class="card-value" id="ticketMedio">R$ 0,00</div>
                    </div>
                    <div class="card-icon">💵</div>
                </div>
                <div class="card-footer" id="insightTicket">Por cliente</div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Crescimento Mensal</div>
                        <div class="card-value" id="crescimentoMensal">0%</div>
                    </div>
                    <div class="card-icon">📈</div>
                </div>
                <div class="card-footer" id="insightCrescimento">vs mês anterior</div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div>
                        <div class="card-title">Tempo Médio Projeto</div>
                        <div class="card-value" id="tempoMedioProjeto">0 dias</div>
                    </div>
                    <div class="card-icon">⏱️</div>
                </div>
                <div class="card-footer" id="insightTempo">Tempo de execução</div>
            </div>
        </div>

        <!-- Gráficos Avançados -->
        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 24px; margin-bottom: 24px;">
            <div class="section-card">
                <h2 class="section-title">📊 Funil de Vendas</h2>
                <canvas id="graficoFunil" style="max-height: 300px;"></canvas>
            </div>

            <div class="section-card">
                <h2 class="section-title">💰 Receitas por Categoria</h2>
                <canvas id="graficoReceitasCategoria" style="max-height: 300px;"></canvas>
            </div>
        </div>

        <!-- Insights Inteligentes -->
        <div class="section-card">
            <h2 class="section-title">💡 Insights Inteligentes</h2>
            <div id="insightsList" style="margin-top: 16px;">
                <div class="empty-state">Carregando insights...</div>
            </div>
        </div>
    </div>

    <!-- Modais Tarefas e Hábitos -->
    <div id="tarefaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="tarefaModalTitle">Nova Tarefa</h2>
                <button class="btn-close" onclick="closeTarefaModal()">&times;</button>
            </div>
            <form id="tarefaForm">
                <input type="hidden" id="tarefaId">
                
                <div class="form-group">
                    <label class="form-label">Título da Tarefa *</label>
                    <input type="text" id="tarefaTitulo" class="form-input" placeholder="Ex: Reunião com cliente X" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Descrição</label>
                    <textarea id="tarefaDescricao" class="form-input" rows="3" placeholder="Detalhes da tarefa..."></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Prioridade *</label>
                        <select id="tarefaPrioridade" class="form-input" required>
                            <option value="baixa">Baixa</option>
                            <option value="media" selected>Média</option>
                            <option value="alta">Alta</option>
                            <option value="urgente">Urgente</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status *</label>
                        <select id="tarefaStatus" class="form-input" required>
                            <option value="pendente" selected>Pendente</option>
                            <option value="em_andamento">Em Andamento</option>
                            <option value="concluida">Concluída</option>
                            <option value="cancelada">Cancelada</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Data de Vencimento</label>
                        <input type="date" id="tarefaDataVencimento" class="form-input">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Vincular a Projeto (opcional)</label>
                        <select id="tarefaProjetoId" class="form-input">
                            <option value="">Nenhum</option>
                        </select>
                    </div>
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeTarefaModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <div id="habitoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="habitoModalTitle">Novo Hábito</h2>
                <button class="btn-close" onclick="closeHabitoModal()">&times;</button>
            </div>
            <form id="habitoForm">
                <input type="hidden" id="habitoId">
                
                <div class="form-group">
                    <label class="form-label">Nome do Hábito *</label>
                    <input type="text" id="habitoNome" class="form-input" placeholder="Ex: Exercitar-se, Ler, Meditar" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Descrição</label>
                    <textarea id="habitoDescricao" class="form-input" rows="2" placeholder="Por que este hábito é importante?"></textarea>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Frequência *</label>
                        <select id="habitoFrequencia" class="form-input" required>
                            <option value="diario" selected>Diário</option>
                            <option value="semanal">Semanal</option>
                            <option value="mensal">Mensal</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Meta (vezes por período)</label>
                        <input type="number" id="habitoMeta" class="form-input" min="1" value="1">
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Data de Início</label>
                    <input type="date" id="habitoDataInicio" class="form-input" value="">
                </div>

                <div class="modal-actions">
                    <button type="button" class="btn btn-secondary" onclick="closeHabitoModal()">Cancelar</button>
                    <button type="submit" class="btn btn-primary">Salvar</button>
                </div>
            </form>
        </div>
    </div>

    <style>
        /* Estilos para Tarefas e Hábitos */
        .habitos-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 16px;
        }

        .habito-card {
            background: var(--secondary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            transition: all 0.3s;
        }

        .habito-card:hover {
            border-color: var(--primary);
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(255, 102, 0, 0.2);
        }

        .habito-header {
            display: flex;
            justify-content: space-between;
            align-items: start;
            margin-bottom: 12px;
        }

        .habito-nome {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 4px;
        }

        .habito-streak {
            background: rgba(255, 102, 0, 0.2);
            color: var(--primary);
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .habito-progress {
            margin-top: 12px;
        }

        .habito-progress-bar {
            height: 8px;
            background: var(--tertiary);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .habito-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary), #ff8533);
            transition: width 0.3s;
        }

        .habito-stats {
            display: flex;
            justify-content: space-between;
            font-size: 12px;
            color: var(--text-gray);
        }

        .tarefa-item {
            background: var(--secondary);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            display: flex;
            align-items: start;
            gap: 12px;
            transition: all 0.3s;
        }

        .tarefa-item:hover {
            border-color: var(--primary);
            transform: translateX(4px);
        }

        .tarefa-checkbox {
            width: 24px;
            height: 24px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .tarefa-checkbox.checked {
            background: var(--success);
            border-color: var(--success);
        }

        .tarefa-content {
            flex: 1;
        }

        .tarefa-titulo {
            font-size: 16px;
            font-weight: 600;
            color: var(--text);
            margin-bottom: 4px;
        }

        .tarefa-titulo.concluida {
            text-decoration: line-through;
            opacity: 0.6;
        }

        .tarefa-descricao {
            font-size: 13px;
            color: var(--text-gray);
            margin-bottom: 8px;
        }

        .tarefa-meta {
            display: flex;
            gap: 12px;
            font-size: 12px;
            color: var(--text-gray);
        }

        .tarefa-prioridade {
            padding: 2px 8px;
            border-radius: 4px;
            font-size: 11px;
            font-weight: 600;
        }

        .prioridade-urgente { background: rgba(239, 68, 68, 0.2); color: var(--danger); }
        .prioridade-alta { background: rgba(251, 191, 36, 0.2); color: var(--warning); }
        .prioridade-media { background: rgba(59, 130, 246, 0.2); color: #3b82f6; }
        .prioridade-baixa { background: rgba(156, 163, 175, 0.2); color: #9ca3af; }
    </style>

    <script>
        // ========== SISTEMA DE TAREFAS ==========
        let allTarefas = [];
        let filteredTarefas = [];

        async function loadTarefas() {
            const loading = document.getElementById('tarefasLoading');
            const list = document.getElementById('tarefasList');
            const empty = document.getElementById('tarefasEmpty');
            
            if (loading) loading.classList.add('active');
            if (list) list.style.display = 'none';
            if (empty) empty.style.display = 'none';

            try {
                // Usar tabela temporária ou localStorage
                const stored = localStorage.getItem('tarefas');
                if (stored) {
                    allTarefas = JSON.parse(stored);
                } else {
                    allTarefas = [];
                }
                
                filteredTarefas = [...allTarefas];
                renderTarefas();
            } catch (error) {
                console.error('Erro ao carregar tarefas:', error);
                allTarefas = [];
                filteredTarefas = [];
            } finally {
                if (loading) loading.classList.remove('active');
            }
        }

        function renderTarefas() {
            const list = document.getElementById('tarefasList');
            const empty = document.getElementById('tarefasEmpty');
            
            if (!list) return;

            if (filteredTarefas.length === 0) {
                list.style.display = 'none';
                if (empty) empty.style.display = 'block';
                return;
            }

            list.style.display = 'block';
            if (empty) empty.style.display = 'none';

            list.innerHTML = filteredTarefas.map(tarefa => {
                const isConcluida = tarefa.status === 'concluida';
                const prioridadeClass = `prioridade-${tarefa.prioridade || 'media'}`;
                const prioridadeLabel = {
                    'urgente': 'Urgente',
                    'alta': 'Alta',
                    'media': 'Média',
                    'baixa': 'Baixa'
                }[tarefa.prioridade || 'media'];

                return `
                    <div class="tarefa-item">
                        <div class="tarefa-checkbox ${isConcluida ? 'checked' : ''}" onclick="toggleTarefa('${tarefa.id}')">
                            ${isConcluida ? '✓' : ''}
                        </div>
                        <div class="tarefa-content">
                            <div class="tarefa-titulo ${isConcluida ? 'concluida' : ''}">${tarefa.titulo || 'Sem título'}</div>
                            ${tarefa.descricao ? `<div class="tarefa-descricao">${tarefa.descricao}</div>` : ''}
                            <div class="tarefa-meta">
                                <span class="tarefa-prioridade ${prioridadeClass}">${prioridadeLabel}</span>
                                ${tarefa.data_vencimento ? `<span>📅 ${formatDate(tarefa.data_vencimento)}</span>` : ''}
                                <button class="btn-action" onclick="editTarefa('${tarefa.id}')" style="margin-left: auto;">Editar</button>
                                <button class="btn-action delete" onclick="deleteTarefa('${tarefa.id}')">Excluir</button>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function filterTarefas() {
            const search = (document.getElementById('tarefaSearch')?.value || '').toLowerCase();
            const statusFilter = document.getElementById('tarefaStatusFilter')?.value || '';
            const prioridadeFilter = document.getElementById('tarefaPrioridadeFilter')?.value || '';

            filteredTarefas = allTarefas.filter(tarefa => {
                const matchSearch = !search || 
                    (tarefa.titulo && tarefa.titulo.toLowerCase().includes(search)) ||
                    (tarefa.descricao && tarefa.descricao.toLowerCase().includes(search));
                const matchStatus = !statusFilter || tarefa.status === statusFilter;
                const matchPrioridade = !prioridadeFilter || tarefa.prioridade === prioridadeFilter;
                
                return matchSearch && matchStatus && matchPrioridade;
            });

            renderTarefas();
        }

        function openTarefaModal() {
            document.getElementById('tarefaModalTitle').textContent = 'Nova Tarefa';
            document.getElementById('tarefaForm').reset();
            document.getElementById('tarefaId').value = '';
            openModal(document.getElementById('tarefaModal'));
        }

        function closeTarefaModal() {
            closeModal(document.getElementById('tarefaModal'));
        }

        function editTarefa(id) {
            const tarefa = allTarefas.find(t => t.id === id);
            if (!tarefa) return;

            document.getElementById('tarefaModalTitle').textContent = 'Editar Tarefa';
            document.getElementById('tarefaId').value = tarefa.id;
            document.getElementById('tarefaTitulo').value = tarefa.titulo || '';
            document.getElementById('tarefaDescricao').value = tarefa.descricao || '';
            document.getElementById('tarefaPrioridade').value = tarefa.prioridade || 'media';
            document.getElementById('tarefaStatus').value = tarefa.status || 'pendente';
            document.getElementById('tarefaDataVencimento').value = tarefa.data_vencimento || '';
            document.getElementById('tarefaProjetoId').value = tarefa.projeto_id || '';
            
            openModal(document.getElementById('tarefaModal'));
        }

        function toggleTarefa(id) {
            const tarefa = allTarefas.find(t => t.id === id);
            if (!tarefa) return;

            tarefa.status = tarefa.status === 'concluida' ? 'pendente' : 'concluida';
            if (tarefa.status === 'concluida') {
                tarefa.data_conclusao = new Date().toISOString().split('T')[0];
            }
            
            saveTarefas();
            renderTarefas();
        }

        function deleteTarefa(id) {
            if (!confirm('Tem certeza que deseja excluir esta tarefa?')) return;
            
            allTarefas = allTarefas.filter(t => t.id !== id);
            saveTarefas();
            loadTarefas();
        }

        function saveTarefas() {
            localStorage.setItem('tarefas', JSON.stringify(allTarefas));
        }

        document.getElementById('tarefaForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const id = document.getElementById('tarefaId').value;
            const tarefaData = {
                titulo: document.getElementById('tarefaTitulo').value.trim(),
                descricao: document.getElementById('tarefaDescricao').value.trim() || null,
                prioridade: document.getElementById('tarefaPrioridade').value,
                status: document.getElementById('tarefaStatus').value,
                data_vencimento: document.getElementById('tarefaDataVencimento').value || null,
                projeto_id: document.getElementById('tarefaProjetoId').value || null,
                created_at: new Date().toISOString()
            };

            if (id) {
                const index = allTarefas.findIndex(t => t.id === id);
                if (index !== -1) {
                    allTarefas[index] = { ...allTarefas[index], ...tarefaData };
                }
            } else {
                tarefaData.id = 'tarefa_' + Date.now();
                allTarefas.push(tarefaData);
            }

            saveTarefas();
            closeTarefaModal();
            loadTarefas();
            alert('Tarefa salva com sucesso!');
        });

        function switchTarefasTab(tab) {
            document.getElementById('tarefasTab').style.display = tab === 'tarefas' ? 'block' : 'none';
            document.getElementById('habitosTab').style.display = tab === 'habitos' ? 'block' : 'none';
            
            document.getElementById('tabTarefas').style.borderBottom = tab === 'tarefas' ? '2px solid var(--primary)' : 'none';
            document.getElementById('tabHabitos').style.borderBottom = tab === 'habitos' ? '2px solid var(--primary)' : 'none';
        }

        // ========== SISTEMA DE HÁBITOS ==========
        let allHabitos = [];
        let filteredHabitos = [];

        async function loadHabitos() {
            try {
                const stored = localStorage.getItem('habitos');
                if (stored) {
                    allHabitos = JSON.parse(stored);
                } else {
                    allHabitos = [];
                }
                
                filteredHabitos = [...allHabitos];
                renderHabitos();
            } catch (error) {
                console.error('Erro ao carregar hábitos:', error);
                allHabitos = [];
                filteredHabitos = [];
            }
        }

        function renderHabitos() {
            const grid = document.getElementById('habitosGrid');
            const empty = document.getElementById('habitosEmpty');
            
            if (!grid) return;

            if (filteredHabitos.length === 0) {
                grid.style.display = 'none';
                if (empty) empty.style.display = 'block';
                return;
            }

            grid.style.display = 'grid';
            if (empty) empty.style.display = 'none';

            grid.innerHTML = filteredHabitos.map(habito => {
                const hoje = new Date().toISOString().split('T')[0];
                const registrosHoje = (habito.registros || []).filter(r => r === hoje).length;
                const meta = habito.meta || 1;
                const progresso = Math.min((registrosHoje / meta) * 100, 100);
                const streak = calcularStreak(habito);

                return `
                    <div class="habito-card">
                        <div class="habito-header">
                            <div>
                                <div class="habito-nome">${habito.nome || 'Hábito'}</div>
                                <div style="font-size: 12px; color: var(--text-gray);">${habito.descricao || ''}</div>
                            </div>
                            <div class="habito-streak">🔥 ${streak}</div>
                        </div>
                        <div class="habito-progress">
                            <div class="habito-progress-bar">
                                <div class="habito-progress-fill" style="width: ${progresso}%"></div>
                            </div>
                            <div class="habito-stats">
                                <span>${registrosHoje}/${meta} hoje</span>
                                <button class="btn btn-sm btn-primary" onclick="registrarHabito('${habito.id}')">+ Registrar</button>
                            </div>
                        </div>
                        <div style="margin-top: 12px; display: flex; gap: 8px;">
                            <button class="btn-action" onclick="editHabito('${habito.id}')">Editar</button>
                            <button class="btn-action delete" onclick="deleteHabito('${habito.id}')">Excluir</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function calcularStreak(habito) {
            if (!habito.registros || habito.registros.length === 0) return 0;
            
            const registros = [...habito.registros].sort().reverse();
            let streak = 0;
            let dataEsperada = new Date();
            dataEsperada.setHours(0, 0, 0, 0);
            
            for (const registro of registros) {
                const dataRegistro = new Date(registro);
                dataRegistro.setHours(0, 0, 0, 0);
                
                if (dataRegistro.getTime() === dataEsperada.getTime()) {
                    streak++;
                    dataEsperada.setDate(dataEsperada.getDate() - 1);
                } else if (dataRegistro < dataEsperada) {
                    break;
                }
            }
            
            return streak;
        }

        function registrarHabito(id) {
            const habito = allHabitos.find(h => h.id === id);
            if (!habito) return;

            const hoje = new Date().toISOString().split('T')[0];
            if (!habito.registros) habito.registros = [];
            
            if (!habito.registros.includes(hoje)) {
                habito.registros.push(hoje);
                saveHabitos();
                renderHabitos();
                alert('Hábito registrado com sucesso! 🔥');
            } else {
                alert('Hábito já registrado hoje!');
            }
        }

        function filterHabitos() {
            const search = (document.getElementById('habitoSearch')?.value || '').toLowerCase();
            const statusFilter = document.getElementById('habitoStatusFilter')?.value || '';

            filteredHabitos = allHabitos.filter(habito => {
                const matchSearch = !search || 
                    (habito.nome && habito.nome.toLowerCase().includes(search)) ||
                    (habito.descricao && habito.descricao.toLowerCase().includes(search));
                const matchStatus = !statusFilter || habito.status === statusFilter;
                
                return matchSearch && matchStatus;
            });

            renderHabitos();
        }

        function openHabitoModal() {
            document.getElementById('habitoModalTitle').textContent = 'Novo Hábito';
            document.getElementById('habitoForm').reset();
            document.getElementById('habitoId').value = '';
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('habitoDataInicio').value = hoje;
            openModal(document.getElementById('habitoModal'));
        }

        function closeHabitoModal() {
            closeModal(document.getElementById('habitoModal'));
        }

        function editHabito(id) {
            const habito = allHabitos.find(h => h.id === id);
            if (!habito) return;

            document.getElementById('habitoModalTitle').textContent = 'Editar Hábito';
            document.getElementById('habitoId').value = habito.id;
            document.getElementById('habitoNome').value = habito.nome || '';
            document.getElementById('habitoDescricao').value = habito.descricao || '';
            document.getElementById('habitoFrequencia').value = habito.frequencia || 'diario';
            document.getElementById('habitoMeta').value = habito.meta || 1;
            document.getElementById('habitoDataInicio').value = habito.data_inicio || '';
            
            openModal(document.getElementById('habitoModal'));
        }

        function deleteHabito(id) {
            if (!confirm('Tem certeza que deseja excluir este hábito?')) return;
            
            allHabitos = allHabitos.filter(h => h.id !== id);
            saveHabitos();
            loadHabitos();
        }

        function saveHabitos() {
            localStorage.setItem('habitos', JSON.stringify(allHabitos));
        }

        document.getElementById('habitoForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const id = document.getElementById('habitoId').value;
            const habitoData = {
                nome: document.getElementById('habitoNome').value.trim(),
                descricao: document.getElementById('habitoDescricao').value.trim() || null,
                frequencia: document.getElementById('habitoFrequencia').value,
                meta: parseInt(document.getElementById('habitoMeta').value) || 1,
                data_inicio: document.getElementById('habitoDataInicio').value || new Date().toISOString().split('T')[0],
                status: 'ativo',
                registros: []
            };

            if (id) {
                const index = allHabitos.findIndex(h => h.id === id);
                if (index !== -1) {
                    allHabitos[index] = { ...allHabitos[index], ...habitoData, registros: allHabitos[index].registros || [] };
                }
            } else {
                habitoData.id = 'habito_' + Date.now();
                allHabitos.push(habitoData);
            }

            saveHabitos();
            closeHabitoModal();
            loadHabitos();
            alert('Hábito salvo com sucesso!');
        });

        // ========== ANÁLISES AVANÇADAS ==========
        async function loadAnalisesAvancadas() {
            await calcularInsights();
            await criarGraficoFunil();
            await criarGraficoReceitasCategoria();
            await gerarInsightsInteligentes();
        }

        async function calcularInsights() {
            try {
                // Taxa de Conversão
                const { data: orcamentos } = await supabase.from('orcamentos').select('status');
                const total = orcamentos?.length || 0;
                const aprovados = orcamentos?.filter(o => o.status === 'aprovado').length || 0;
                const taxa = total > 0 ? ((aprovados / total) * 100).toFixed(1) : 0;
                document.getElementById('taxaConversao').textContent = taxa + '%';
                document.getElementById('insightConversao').textContent = `${aprovados} de ${total} orçamentos aprovados`;

                // Ticket Médio
                const { data: receitas } = await supabase.from('receitas').select('valor, cliente_id').eq('status', 'recebido');
                if (receitas && receitas.length > 0) {
                    const clientesUnicos = new Set(receitas.map(r => r.cliente_id).filter(Boolean));
                    const totalReceitas = receitas.reduce((sum, r) => sum + (r.valor || 0), 0);
                    const ticketMedio = clientesUnicos.size > 0 ? totalReceitas / clientesUnicos.size : 0;
                    document.getElementById('ticketMedio').textContent = formatCurrency(ticketMedio);
                }

                // Crescimento Mensal
                const hoje = new Date();
                const mesAtual = hoje.getMonth();
                const mesAnterior = mesAtual === 0 ? 11 : mesAtual - 1;
                const anoAtual = hoje.getFullYear();
                const anoAnterior = mesAtual === 0 ? anoAtual - 1 : anoAtual;

                const { data: receitasAll } = await supabase.from('receitas').select('valor, data_vencimento, status').eq('status', 'recebido');
                
                let receitasMesAtual = 0;
                let receitasMesAnterior = 0;

                if (receitasAll) {
                    receitasMesAtual = receitasAll.filter(r => {
                        if (!r.data_vencimento) return false;
                        const data = new Date(r.data_vencimento);
                        return data.getMonth() === mesAtual && data.getFullYear() === anoAtual;
                    }).reduce((sum, r) => sum + (r.valor || 0), 0);

                    receitasMesAnterior = receitasAll.filter(r => {
                        if (!r.data_vencimento) return false;
                        const data = new Date(r.data_vencimento);
                        return data.getMonth() === mesAnterior && data.getFullYear() === anoAnterior;
                    }).reduce((sum, r) => sum + (r.valor || 0), 0);
                }

                const crescimento = receitasMesAnterior > 0 
                    ? (((receitasMesAtual - receitasMesAnterior) / receitasMesAnterior) * 100).toFixed(1)
                    : receitasMesAtual > 0 ? '100' : '0';
                
                document.getElementById('crescimentoMensal').textContent = (crescimento > 0 ? '+' : '') + crescimento + '%';
                document.getElementById('insightCrescimento').textContent = 
                    crescimento > 0 ? 'Crescimento positivo!' : crescimento < 0 ? 'Atenção: queda detectada' : 'Sem variação';

                // Tempo Médio de Projeto
                const { data: projetos } = await supabase.from('projetos').select('data_inicio, data_conclusao').eq('status', 'concluido');
                if (projetos && projetos.length > 0) {
                    const tempos = projetos
                        .filter(p => p.data_inicio && p.data_conclusao)
                        .map(p => {
                            const inicio = new Date(p.data_inicio);
                            const fim = new Date(p.data_conclusao);
                            return Math.ceil((fim - inicio) / (1000 * 60 * 60 * 24));
                        });
                    
                    if (tempos.length > 0) {
                        const tempoMedio = Math.round(tempos.reduce((a, b) => a + b, 0) / tempos.length);
                        document.getElementById('tempoMedioProjeto').textContent = tempoMedio + ' dias';
                    }
                }
            } catch (error) {
                console.error('Erro ao calcular insights:', error);
            }
        }

        async function criarGraficoFunil() {
            const ctx = document.getElementById('graficoFunil');
            if (!ctx) return;

            try {
                const { data: orcamentos } = await supabase.from('orcamentos').select('status');
                
                const funil = {
                    'rascunho': 0,
                    'enviado': 0,
                    'aprovado': 0,
                    'rejeitado': 0
                };

                orcamentos?.forEach(o => {
                    if (funil[o.status] !== undefined) {
                        funil[o.status]++;
                    }
                });

                if (window.graficoFunil) {
                    window.graficoFunil.destroy();
                }

                window.graficoFunil = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: ['Rascunho', 'Enviado', 'Aprovado', 'Rejeitado'],
                        datasets: [{
                            label: 'Orçamentos',
                            data: [funil.rascunho, funil.enviado, funil.aprovado, funil.rejeitado],
                            backgroundColor: [
                                'rgba(156, 163, 175, 0.6)',
                                'rgba(59, 130, 246, 0.6)',
                                'rgba(16, 185, 129, 0.6)',
                                'rgba(239, 68, 68, 0.6)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            y: { beginAtZero: true, ticks: { color: '#AFAFAF' } },
                            x: { ticks: { color: '#AFAFAF' } }
                        }
                    }
                });
            } catch (error) {
                console.error('Erro ao criar gráfico funil:', error);
            }
        }

        async function criarGraficoReceitasCategoria() {
            const ctx = document.getElementById('graficoReceitasCategoria');
            if (!ctx) return;

            try {
                const { data: receitas } = await supabase.from('receitas').select('valor, cliente_id').eq('status', 'recebido');
                
                // Agrupar por cliente (simulando categorias)
                const categorias = {};
                receitas?.forEach(r => {
                    const categoria = r.cliente_id ? 'Clientes' : 'Outros';
                    categorias[categoria] = (categorias[categoria] || 0) + (r.valor || 0);
                });

                if (window.graficoReceitasCategoria) {
                    window.graficoReceitasCategoria.destroy();
                }

                window.graficoReceitasCategoria = new Chart(ctx, {
                    type: 'doughnut',
                    data: {
                        labels: Object.keys(categorias),
                        datasets: [{
                            data: Object.values(categorias),
                            backgroundColor: [
                                'rgba(255, 102, 0, 0.6)',
                                'rgba(16, 185, 129, 0.6)',
                                'rgba(59, 130, 246, 0.6)',
                                'rgba(251, 191, 36, 0.6)'
                            ]
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: { position: 'bottom', labels: { color: '#fff' } }
                        }
                    }
                });
            } catch (error) {
                console.error('Erro ao criar gráfico receitas:', error);
            }
        }

        async function gerarInsightsInteligentes() {
            const container = document.getElementById('insightsList');
            if (!container) return;

            const insights = [];

            try {
                // Insight 1: Orçamentos sem resposta
                const { data: orcamentosEnviados } = await supabase
                    .from('orcamentos')
                    .select('*')
                    .eq('status', 'enviado');
                
                if (orcamentosEnviados && orcamentosEnviados.length > 0) {
                    insights.push({
                        tipo: 'warning',
                        titulo: 'Orçamentos Pendentes',
                        mensagem: `Você tem ${orcamentosEnviados.length} orçamento(s) aguardando resposta. Considere fazer um follow-up.`,
                        acao: 'Ver Orçamentos'
                    });
                }

                // Insight 2: Receitas vencidas
                const hoje = new Date();
                const { data: receitasVencidas } = await supabase
                    .from('receitas')
                    .select('valor')
                    .eq('status', 'atrasado');
                
                if (receitasVencidas && receitasVencidas.length > 0) {
                    const totalVencido = receitasVencidas.reduce((sum, r) => sum + (r.valor || 0), 0);
                    insights.push({
                        tipo: 'danger',
                        titulo: 'Receitas Vencidas',
                        mensagem: `Você tem R$ ${formatCurrency(totalVencido)} em receitas vencidas. Ação necessária!`,
                        acao: 'Ver Financeiro'
                    });
                }

                // Insight 3: Projetos atrasados
                const { data: projetosAtrasados } = await supabase
                    .from('projetos')
                    .select('nome, data_conclusao')
                    .eq('status', 'em_andamento');
                
                if (projetosAtrasados) {
                    const atrasados = projetosAtrasados.filter(p => {
                        if (!p.data_conclusao) return false;
                        return new Date(p.data_conclusao) < hoje;
                    });
                    
                    if (atrasados.length > 0) {
                        insights.push({
                            tipo: 'warning',
                            titulo: 'Projetos Atrasados',
                            mensagem: `${atrasados.length} projeto(s) estão com prazo vencido. Revise os prazos.`,
                            acao: 'Ver Projetos'
                        });
                    }
                }

                // Insight 4: Performance positiva
                const { data: receitasMes } = await supabase
                    .from('receitas')
                    .select('valor')
                    .eq('status', 'recebido');
                
                if (receitasMes && receitasMes.length > 5) {
                    insights.push({
                        tipo: 'success',
                        titulo: 'Bom Desempenho!',
                        mensagem: `Você já recebeu ${receitasMes.length} pagamentos este mês. Continue assim!`,
                        acao: 'Ver Dashboard'
                    });
                }

            } catch (error) {
                console.error('Erro ao gerar insights:', error);
            }

            if (insights.length === 0) {
                container.innerHTML = '<div class="empty-state">Nenhum insight disponível no momento.</div>';
                return;
            }

            container.innerHTML = insights.map(insight => {
                const tipoClass = {
                    'success': 'badge-success',
                    'warning': 'badge-warning',
                    'danger': 'badge-danger',
                    'info': 'badge-enviado'
                }[insight.tipo] || 'badge-enviado';

                return `
                    <div style="background: var(--secondary); border-left: 4px solid var(--${insight.tipo === 'success' ? 'success' : insight.tipo === 'danger' ? 'danger' : 'warning'}); border-radius: 8px; padding: 16px; margin-bottom: 12px;">
                        <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 8px;">
                            <h3 style="font-size: 16px; font-weight: 600; color: var(--text); margin: 0;">${insight.titulo}</h3>
                            <span class="badge ${tipoClass}">${insight.tipo}</span>
                        </div>
                        <p style="color: var(--text-gray); margin: 0 0 12px 0; line-height: 1.5;">${insight.mensagem}</p>
                        <button class="btn btn-sm btn-primary" onclick="navigateToPage('${insight.acao.toLowerCase().replace('ver ', '').replace(' ', '')}')">${insight.acao}</button>
                    </div>
                `;
            }).join('');
        }

        // ========== SISTEMA DE PRECIFICAÇÃO ==========
        let allPrecificacao = [];
        let filteredPrecificacao = [];

        async function loadPrecificacao() {
            const loading = document.getElementById('precificacaoLoading');
            const table = document.getElementById('precificacaoTable');
            const empty = document.getElementById('precificacaoEmpty');
            
            if (loading) loading.classList.add('active');
            if (table) table.style.display = 'none';
            if (empty) empty.style.display = 'none';

            try {
                // Buscar do Supabase
                const { data, error } = await supabase
                    .from('precificacao')
                    .select('*')
                    .order('created_at', { ascending: false });

                if (error) throw error;

                allPrecificacao = data || [];
                filteredPrecificacao = [...allPrecificacao];
                renderPrecificacao();
            } catch (error) {
                console.error('Erro ao carregar precificação:', error);
                // Fallback para localStorage se Supabase falhar
                try {
                    const stored = localStorage.getItem('precificacao');
                    if (stored) {
                        allPrecificacao = JSON.parse(stored);
                        filteredPrecificacao = [...allPrecificacao];
                        renderPrecificacao();
                    } else {
                        allPrecificacao = [];
                        filteredPrecificacao = [];
                    }
                } catch (e) {
                    allPrecificacao = [];
                    filteredPrecificacao = [];
                }
            } finally {
                if (loading) loading.classList.remove('active');
            }
        }

        function renderPrecificacao() {
            const table = document.getElementById('precificacaoTable');
            const empty = document.getElementById('precificacaoEmpty');
            const tbody = document.getElementById('precificacaoTableBody');
            
            if (!table || !tbody) return;

            if (filteredPrecificacao.length === 0) {
                table.style.display = 'none';
                if (empty) empty.style.display = 'block';
                return;
            }

            table.style.display = 'table';
            if (empty) empty.style.display = 'none';

            tbody.innerHTML = filteredPrecificacao.map(item => {
                const tipoLabel = {
                    'hora': 'Por Hora',
                    'projeto': 'Por Projeto',
                    'valor': 'Por Valor',
                    'custo': 'Custo + Margem'
                }[item.tipo] || item.tipo;

                const categoriaLabel = {
                    'desenvolvimento': 'Desenvolvimento',
                    'design': 'Design',
                    'marketing': 'Marketing',
                    'consultoria': 'Consultoria',
                    'suporte': 'Suporte',
                    'outro': 'Outro'
                }[item.categoria] || item.categoria;

                return `
                    <tr>
                        <td><strong>${item.nome || '-'}</strong></td>
                        <td>${categoriaLabel}</td>
                        <td>${tipoLabel}</td>
                        <td>${formatCurrency(item.preco_base || 0)}</td>
                        <td>${item.preco_minimo ? formatCurrency(item.preco_minimo) : '-'}</td>
                        <td>${item.preco_maximo ? formatCurrency(item.preco_maximo) : '-'}</td>
                        <td>${item.margem || 0}%</td>
                        <td>
                            <span class="badge ${item.ativo ? 'badge-ativo' : 'badge-inativo'}">
                                ${item.ativo ? 'Ativo' : 'Inativo'}
                            </span>
                        </td>
                        <td>
                            <button type="button" class="btn-action" onclick="event.stopPropagation(); event.preventDefault(); editPrecificacao('${item.id}')">Editar</button>
                            <button type="button" class="btn-action delete" onclick="event.stopPropagation(); event.preventDefault(); deletePrecificacao('${item.id}')">Excluir</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function filterPrecificacao() {
            const search = (document.getElementById('precificacaoSearch')?.value || '').toLowerCase();
            const categoriaFilter = document.getElementById('precificacaoCategoriaFilter')?.value || '';
            const tipoFilter = document.getElementById('precificacaoTipoFilter')?.value || '';

            filteredPrecificacao = allPrecificacao.filter(item => {
                const matchSearch = !search || 
                    (item.nome && item.nome.toLowerCase().includes(search)) ||
                    (item.descricao && item.descricao.toLowerCase().includes(search));
                const matchCategoria = !categoriaFilter || item.categoria === categoriaFilter;
                const matchTipo = !tipoFilter || item.tipo === tipoFilter;
                
                return matchSearch && matchCategoria && matchTipo;
            });

            renderPrecificacao();
        }

        function openPrecificacaoModal() {
            document.getElementById('precificacaoModalTitle').textContent = 'Novo Serviço';
            document.getElementById('precificacaoForm').reset();
            document.getElementById('precificacaoId').value = '';
            document.getElementById('precificacaoMargem').value = '50';
            atualizarCamposPrecificacao();
            openModal(document.getElementById('precificacaoModal'));
        }

        function closePrecificacaoModal() {
            closeModal(document.getElementById('precificacaoModal'));
        }

        function editPrecificacao(id) {
            // Prevenir qualquer propagação de evento
            if (event) {
                event.stopPropagation();
                event.preventDefault();
            }
            
            const item = allPrecificacao.find(p => p.id === id);
            if (!item) {
                console.error('Item não encontrado:', id);
                return;
            }

            // Fechar qualquer modal aberto primeiro
            const modal = document.getElementById('precificacaoModal');
            if (!modal) {
                console.error('Modal não encontrado');
                return;
            }

            // Preencher campos
            document.getElementById('precificacaoModalTitle').textContent = 'Editar Serviço';
            document.getElementById('precificacaoId').value = item.id;
            document.getElementById('precificacaoNome').value = item.nome || '';
            document.getElementById('precificacaoCategoria').value = item.categoria || '';
            document.getElementById('precificacaoTipo').value = item.tipo || '';
            document.getElementById('precificacaoPrecoBase').value = item.preco_base || '';
            document.getElementById('precificacaoPrecoMinimo').value = item.preco_minimo || '';
            document.getElementById('precificacaoPrecoMaximo').value = item.preco_maximo || '';
            document.getElementById('precificacaoMargem').value = item.margem || 50;
            document.getElementById('precificacaoDescricao').value = item.descricao || '';
            document.getElementById('precificacaoObservacoes').value = item.observacoes || '';
            document.getElementById('precificacaoAtivo').checked = item.ativo !== false;
            
            atualizarCamposPrecificacao();
            
            // Aguardar um pouco antes de abrir o modal para garantir que tudo está pronto
            setTimeout(() => {
                openModal(modal);
            }, 100);
        }

        async function deletePrecificacao(id) {
            if (!confirm('Tem certeza que deseja excluir este serviço?')) return;
            
            try {
                // Tentar deletar do Supabase
                const { error } = await supabase
                    .from('precificacao')
                    .delete()
                    .eq('id', id);

                if (error) throw error;

                allPrecificacao = allPrecificacao.filter(p => p.id !== id);
                filteredPrecificacao = filteredPrecificacao.filter(p => p.id !== id);
                renderPrecificacao();
                alert('Serviço excluído com sucesso!');
            } catch (error) {
                console.error('Erro ao excluir precificação:', error);
                // Fallback para localStorage
                allPrecificacao = allPrecificacao.filter(p => p.id !== id);
                savePrecificacaoLocal();
                loadPrecificacao();
                alert('Serviço excluído com sucesso! (salvo localmente)');
            }
        }

        function savePrecificacaoLocal() {
            localStorage.setItem('precificacao', JSON.stringify(allPrecificacao));
        }

        function atualizarCamposPrecificacao() {
            const tipo = document.getElementById('precificacaoTipo').value;
            const label1 = document.getElementById('precificacaoLabel1');
            const help1 = document.getElementById('precificacaoHelp1');
            const campoExtra = document.getElementById('precificacaoCampoExtra');
            const labelExtra = document.getElementById('precificacaoLabelExtra');

            if (tipo === 'hora') {
                label1.textContent = 'Valor por Hora (R$)';
                if (help1) help1.textContent = 'Ex: R$ 100,00/hora';
                campoExtra.style.display = 'none';
            } else if (tipo === 'projeto') {
                label1.textContent = 'Preço do Projeto (R$)';
                if (help1) help1.textContent = 'Valor fixo para o projeto completo';
                campoExtra.style.display = 'none';
            } else if (tipo === 'valor') {
                label1.textContent = 'Valor Base (R$)';
                if (help1) help1.textContent = 'Valor baseado no benefício gerado';
                campoExtra.style.display = 'none';
            } else if (tipo === 'custo') {
                label1.textContent = 'Custo Total (R$)';
                if (help1) help1.textContent = 'Soma de todos os custos do projeto';
                campoExtra.style.display = 'block';
                labelExtra.textContent = 'Custos Indiretos (R$)';
            } else {
                campoExtra.style.display = 'none';
            }
        }

        document.getElementById('precificacaoForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const id = document.getElementById('precificacaoId').value;
            const itemData = {
                nome: document.getElementById('precificacaoNome').value.trim(),
                categoria: document.getElementById('precificacaoCategoria').value,
                tipo: document.getElementById('precificacaoTipo').value,
                preco_base: parseFloat(document.getElementById('precificacaoPrecoBase').value) || 0,
                preco_minimo: parseFloat(document.getElementById('precificacaoPrecoMinimo').value) || null,
                preco_maximo: parseFloat(document.getElementById('precificacaoPrecoMaximo').value) || null,
                margem: parseFloat(document.getElementById('precificacaoMargem').value) || 0,
                descricao: document.getElementById('precificacaoDescricao').value.trim() || null,
                observacoes: document.getElementById('precificacaoObservacoes').value.trim() || null,
                ativo: document.getElementById('precificacaoAtivo').checked
            };

            try {
                if (id) {
                    // Atualizar no Supabase
                    const { error } = await supabase
                        .from('precificacao')
                        .update(itemData)
                        .eq('id', id);

                    if (error) throw error;
                    alert('Serviço atualizado com sucesso!');
                } else {
                    // Criar no Supabase
                    const { data, error } = await supabase
                        .from('precificacao')
                        .insert([itemData])
                        .select()
                        .single();

                    if (error) throw error;
                    alert('Serviço criado com sucesso!');
                }

                closePrecificacaoModal();
                loadPrecificacao();
            } catch (error) {
                console.error('Erro ao salvar precificação:', error);
                // Fallback para localStorage
                if (id) {
                    const index = allPrecificacao.findIndex(p => p.id === id);
                    if (index !== -1) {
                        allPrecificacao[index] = { ...allPrecificacao[index], ...itemData };
                    }
                } else {
                    itemData.id = 'prec_' + Date.now();
                    itemData.created_at = new Date().toISOString();
                    allPrecificacao.push(itemData);
                }
                savePrecificacaoLocal();
                closePrecificacaoModal();
                loadPrecificacao();
                alert('Serviço salvo com sucesso! (salvo localmente)');
            }
        });

        // Calculadora de Preços
        function atualizarCalculadora() {
            const metodo = document.getElementById('calcMetodo').value;
            const campo1 = document.getElementById('calcCampo1');
            const campo2 = document.getElementById('calcCampo2');
            const label1 = document.getElementById('calcLabel1');
            const label2 = document.getElementById('calcLabel2');

            if (metodo === 'hora') {
                label1.textContent = 'Valor por Hora (R$)';
                label2.textContent = 'Horas Estimadas';
                campo2.style.display = 'block';
            } else if (metodo === 'projeto') {
                label1.textContent = 'Preço Base (R$)';
                label2.textContent = 'Margem de Segurança (%)';
                campo2.style.display = 'block';
            } else if (metodo === 'valor') {
                label1.textContent = 'Valor Agregado (R$)';
                label2.textContent = 'Percentual de Captura (%)';
                campo2.style.display = 'block';
            } else if (metodo === 'custo') {
                label1.textContent = 'Custos Diretos (R$)';
                label2.textContent = 'Custos Indiretos (R$)';
                campo2.style.display = 'block';
            }

            calcularPreco();
        }

        function calcularPreco() {
            const metodo = document.getElementById('calcMetodo').value;
            const valor1 = parseFloat(document.getElementById('calcValor1').value) || 0;
            const valor2 = parseFloat(document.getElementById('calcValor2').value) || 0;
            const resultado = document.getElementById('calcResultado');
            const detalhes = document.getElementById('calcDetalhes');

            let preco = 0;
            let detalhesTexto = '';

            if (metodo === 'hora') {
                preco = valor1 * valor2;
                const margem = preco * 0.25; // 25% de margem
                preco = preco + margem;
                detalhesTexto = `${valor2}h × R$ ${valor1.toFixed(2)}/h + 25% margem`;
            } else if (metodo === 'projeto') {
                const margem = valor1 * (valor2 / 100);
                preco = valor1 + margem;
                detalhesTexto = `R$ ${valor1.toFixed(2)} + ${valor2}% margem`;
            } else if (metodo === 'valor') {
                preco = valor1 * (valor2 / 100);
                detalhesTexto = `${valor2}% de R$ ${valor1.toFixed(2)}`;
            } else if (metodo === 'custo') {
                const custoTotal = valor1 + valor2;
                const margem = custoTotal * 0.5; // 50% de margem
                preco = custoTotal + margem;
                detalhesTexto = `(R$ ${valor1.toFixed(2)} + R$ ${valor2.toFixed(2)}) + 50% margem`;
            }

            resultado.textContent = formatCurrency(preco);
            detalhes.textContent = detalhesTexto;
        }

        // Expor funções globalmente
        window.loadTarefas = loadTarefas;
        window.loadHabitos = loadHabitos;
        window.loadAnalisesAvancadas = loadAnalisesAvancadas;
        window.loadPrecificacao = loadPrecificacao;
        window.openPrecificacaoModal = openPrecificacaoModal;
        window.closePrecificacaoModal = closePrecificacaoModal;
        window.editPrecificacao = editPrecificacao;
        window.deletePrecificacao = deletePrecificacao;
        window.filterPrecificacao = filterPrecificacao;
        window.atualizarCalculadora = atualizarCalculadora;
        window.calcularPreco = calcularPreco;
        window.atualizarCamposPrecificacao = atualizarCamposPrecificacao;
    </script>
</body>
</html>
